#!/usr/bin/make -f
# -*- makefile -*-
# debian/rules for fis-gtm

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

VISTAINSTANCEDIR=debian/usr/share/vista-foia
GTM_INSTALL_DIR=/usr/lib/fis-gtm/V6.0-003_x86_64
VISTA_GLOBALS_DIR=$(VISTAINSTANCEDIR)/g
VISTA_ROUTINES_DIR=$(VISTAINSTANCEDIR)/r
VISTA_OBJECTS_DIR=$(VISTAINSTANCEDIR)/o
VISTA_GTM_DATABASE=$(VISTAINSTANCEDIR)/g/database
VISTA_GTM_ROUTINES="$(VISTAINSTANCEDIR)/o\($(VISTAINSTANCEDIR)/r\) $(GTM_INSTALL_DIR)/libgtmutil.so"

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
-DCMAKE_INSTALL_PREFIX:PATH=/usr \
-DGTM_INSTALL_DIR=$(GTM_INSTALL_DIR) \
-DVISTA_GLOBALS_DIR:PATH=$(VISTA_GLOBALS_DIR) \
-DVISTA_ROUTINE_DIR:PATH=$(VISTA_ROUTINES_DIR)

override_dh_auto_install:
	mkdir -p $(VISTAINSTANCEDIR)
	mkdir -p $(VISTA_ROUTINES_DIR)
	mkdir -p $(VISTA_OBJECTS_DIR)
	mkdir -p $(VISTA_GLOBALS_DIR)
	mkdir -p $(VISTAINSTANCEDIR)/inet
	mkdir -p $(VISTAINSTANCEDIR)/inet/Logs
	gtmgbldir=$(VISTA_GTM_DATABASE) && gtmroutines="$(VISTA_GTM_ROUTINES)" && gtm_dist=$(GTM_INSTALL_DIR) && echo "change -s DEFAULT -f=$(VISTAINSTANCEDIR)/g/database" | $(GTM_INSTALL_DIR)/mumps -r GDE
	gtmgbldir=$(VISTA_GTM_DATABASE) && gtmroutines="$(VISTA_GTM_ROUTINES)" && gtm_dist=$(GTM_INSTALL_DIR) && $(GTM_INSTALL_DIR)/mupip create
	gtmgbldir=$(VISTA_GTM_DATABASE) && gtmroutines="$(VISTA_GTM_ROUTINES)" && gtm_dist=$(GTM_INSTALL_DIR) && $(GTM_INSTALL_DIR)/dse change -f -key_max=1023 -rec=4096


get-orig-source:
	wget -O../OSEHRA-VistA-M-897bff2a.orig.tar.gz https://github.com/OSEHRA/VistA-M/tarball/897bff2a
	wget -O../vista-foia_0.20140106.orig.tar.gz   https://github.com/OSEHRA/VistA/tarball/fdc8ff2b

describe-current-version:
	git describe --tags upstream | sed 's,^release-,,;s,-,+,;s,-,~,;'

