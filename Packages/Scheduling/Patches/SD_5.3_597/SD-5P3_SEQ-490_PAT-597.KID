Released SD*5.3*597 SEQ #490
Extracted from mail message
**KIDS**:SD*5.3*597^

**INSTALL NAME**
SD*5.3*597
"BLD",9110,0)
SD*5.3*597^SCHEDULING^0^3120525^y
"BLD",9110,1,0)
^^7^7^3120525^
"BLD",9110,1,1,0)
1. When cancelling an appointment within the Appointment Management Module
"BLD",9110,1,2,0)
   [SDAM APPT MGT] option, if another user cancels the same appointment 
"BLD",9110,1,3,0)
   at the same time an undefined error occurs.   
"BLD",9110,1,4,0)
 
"BLD",9110,1,5,0)
2. If an appointment is cancelled "by clinic" within the Appointment 
"BLD",9110,1,6,0)
   Management Module [SDAM APPT MGT] option, the Appointment Management 
"BLD",9110,1,7,0)
   Module reverts to patient view instead of clinic view.
"BLD",9110,4,0)
^9.64PA^^
"BLD",9110,6.3)
3
"BLD",9110,"KRN",0)
^9.67PA^779.2^20
"BLD",9110,"KRN",.4,0)
.4
"BLD",9110,"KRN",.401,0)
.401
"BLD",9110,"KRN",.402,0)
.402
"BLD",9110,"KRN",.403,0)
.403
"BLD",9110,"KRN",.5,0)
.5
"BLD",9110,"KRN",.84,0)
.84
"BLD",9110,"KRN",3.6,0)
3.6
"BLD",9110,"KRN",3.8,0)
3.8
"BLD",9110,"KRN",9.2,0)
9.2
"BLD",9110,"KRN",9.8,0)
9.8
"BLD",9110,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9110,"KRN",9.8,"NM",1,0)
SDAMC^^0^B14510209
"BLD",9110,"KRN",9.8,"NM",2,0)
SDCNP1^^0^B33156446
"BLD",9110,"KRN",9.8,"NM","B","SDAMC",1)

"BLD",9110,"KRN",9.8,"NM","B","SDCNP1",2)

"BLD",9110,"KRN",19,0)
19
"BLD",9110,"KRN",19.1,0)
19.1
"BLD",9110,"KRN",101,0)
101
"BLD",9110,"KRN",409.61,0)
409.61
"BLD",9110,"KRN",771,0)
771
"BLD",9110,"KRN",779.2,0)
779.2
"BLD",9110,"KRN",870,0)
870
"BLD",9110,"KRN",8989.51,0)
8989.51
"BLD",9110,"KRN",8989.52,0)
8989.52
"BLD",9110,"KRN",8994,0)
8994
"BLD",9110,"KRN","B",.4,.4)

"BLD",9110,"KRN","B",.401,.401)

"BLD",9110,"KRN","B",.402,.402)

"BLD",9110,"KRN","B",.403,.403)

"BLD",9110,"KRN","B",.5,.5)

"BLD",9110,"KRN","B",.84,.84)

"BLD",9110,"KRN","B",3.6,3.6)

"BLD",9110,"KRN","B",3.8,3.8)

"BLD",9110,"KRN","B",9.2,9.2)

"BLD",9110,"KRN","B",9.8,9.8)

"BLD",9110,"KRN","B",19,19)

"BLD",9110,"KRN","B",19.1,19.1)

"BLD",9110,"KRN","B",101,101)

"BLD",9110,"KRN","B",409.61,409.61)

"BLD",9110,"KRN","B",771,771)

"BLD",9110,"KRN","B",779.2,779.2)

"BLD",9110,"KRN","B",870,870)

"BLD",9110,"KRN","B",8989.51,8989.51)

"BLD",9110,"KRN","B",8989.52,8989.52)

"BLD",9110,"KRN","B",8994,8994)

"BLD",9110,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",9110,"QUES",0)
^9.62^^
"BLD",9110,"REQB",0)
^9.611^1^1
"BLD",9110,"REQB",1,0)
SD*5.3*554^2
"BLD",9110,"REQB","B","SD*5.3*554",1)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813
"PKG",16,22,1,"PAH",1,0)
597^3120525
"PKG",16,22,1,"PAH",1,1,0)
^^7^7^3120525
"PKG",16,22,1,"PAH",1,1,1,0)
1. When cancelling an appointment within the Appointment Management Module
"PKG",16,22,1,"PAH",1,1,2,0)
   [SDAM APPT MGT] option, if another user cancels the same appointment 
"PKG",16,22,1,"PAH",1,1,3,0)
   at the same time an undefined error occurs.   
"PKG",16,22,1,"PAH",1,1,4,0)
 
"PKG",16,22,1,"PAH",1,1,5,0)
2. If an appointment is cancelled "by clinic" within the Appointment 
"PKG",16,22,1,"PAH",1,1,6,0)
   Management Module [SDAM APPT MGT] option, the Appointment Management 
"PKG",16,22,1,"PAH",1,1,7,0)
   Module reverts to patient view instead of clinic view.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","SDAMC")
0^1^B14510209^B16744986
"RTN","SDAMC",1,0)
SDAMC ;ALB/MJK - Cancel Appt Action ; 8/31/05 3:02pm  ; 12/26/08 12:26pm  ; 5/25/12 12:40pm
"RTN","SDAMC",2,0)
 ;;5.3;Scheduling;**20,28,32,46,263,414,444,478,538,554,597**;Aug 13, 1993;Build 3
"RTN","SDAMC",3,0)
 ;
"RTN","SDAMC",4,0)
EN ; -- protocol SDAM APPT CANCEL entry pt
"RTN","SDAMC",5,0)
 ; input:  VALMY := array entries
"RTN","SDAMC",6,0)
 ;
"RTN","SDAMC",7,0)
 N SDI,SDAT,VALMY,SDAMCIDT,CNT,L,SDWH,SDCP,SDREM,SDSCR,SDMSG,SCLHOLD
"RTN","SDAMC",8,0)
 K ^UTILITY($J)
"RTN","SDAMC",9,0)
 ;
"RTN","SDAMC",10,0)
 ;
"RTN","SDAMC",11,0)
 I '$D(DFN),$G(SDFN),($G(SDAMTYP)="P") S DFN=SDFN
"RTN","SDAMC",12,0)
 ;
"RTN","SDAMC",13,0)
 S VALMBCK=""
"RTN","SDAMC",14,0)
 D SEL^VALM2,CHK G ENQ:'$O(VALMY(0))
"RTN","SDAMC",15,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAMC",16,0)
 S SDWH=$$WHO,SDCP=$S(SDWH="C":0,1:1) G ENQ:SDWH=-1
"RTN","SDAMC",17,0)
 S SDSCR=$$RSN(SDWH) G ENQ:SDSCR=-1
"RTN","SDAMC",18,0)
 S (TMPD,SDREM)=$$REM G ENQ:SDREM=-1 ;SD/478
"RTN","SDAMC",19,0)
 S (SDI,CNT,L)=0
"RTN","SDAMC",20,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) W !,^TMP("SDAM",$J,+SDAT,0) D CAN($P(SDAT,U,2),$P(SDAT,U,3),.CNT,.L,SDWH,SDCP,SDSCR,SDREM)
"RTN","SDAMC",21,0)
 I SDAMTYP="P" D BLD^SDAM1
"RTN","SDAMC",22,0)
 I SDAMTYP="C" D BLD^SDAM3
"RTN","SDAMC",23,0)
ENQ Q
"RTN","SDAMC",24,0)
 ;
"RTN","SDAMC",25,0)
CAN(DFN,SDT,CNT,L,SDWH,SDCP,SDSCR,SDREM) ;
"RTN","SDAMC",26,0)
 N A1,NDT S NDT=SDT
"RTN","SDAMC",27,0)
 I $P($G(^DPT(DFN,"S",NDT,0)),U,2)["C" W !!,"Appointment already cancelled" H 2 Q
"RTN","SDAMC",28,0)
 I $D(^DPT(DFN,"S",NDT,0)) S SD0=^(0) I $P(SD0,"^",2)'["C" S SC=+SD0,L=L\1+1,APL="" D FLEN^SDCNP1A S ^UTILITY($J,"SDCNP",L)=NDT_"^"_SC_"^"_COV_"^"_APL_"^^"_APL_"^^^^^^"_SDSP D CHKSO^SDCNP0 ;SD/478
"RTN","SDAMC",29,0)
 ;SD*5.3*414 next line added to set hold variable SCLHOLD for clinic ptr
"RTN","SDAMC",30,0)
 S APP=1,A1=L\1 S SCLHOLD=$P(^UTILITY($J,"SDCNP",A1),U,2) D BEGD^SDCNP0
"RTN","SDAMC",31,0)
 D MES,NOPE W ! S (CNT,L)=0 K ^UTILITY($J,"SDCNP")
"RTN","SDAMC",32,0)
 Q
"RTN","SDAMC",33,0)
CANQ(SDFN,SDCLN) ; SD*5.3*554 - Passes in SDFN, SDCLN
"RTN","SDAMC",34,0)
 ;Wait List Message
"RTN","SDAMC",35,0)
 ;
"RTN","SDAMC",36,0)
 I SDFN=""!(SDCLN="") Q  ;Checks to make sure that SDFN and SDCLN are set to a non null value - PATCH SD*5.3*597
"RTN","SDAMC",37,0)
 N SDOMES S SDOMES="" I $D(^SDWL(409.3,"SC",SDCLN)) D
"RTN","SDAMC",38,0)
 .N SDWL S SDWL="" F  S SDWL=$O(^SDWL(409.3,"SC",SDCLN,SDWL)) Q:SDWL=""  D  Q:SDOMES
"RTN","SDAMC",39,0)
 ..I $P(^SDWL(409.3,SDWL,0),U,17)="O" I $P(^SDWL(409.3,SDWL,0),U)=$G(SDFN) D  S SDOMES=1
"RTN","SDAMC",40,0)
 ...W !,?1,"There are Wait List entries waiting for an Appointment for this patient in ",!?1,$P(^SC(SDCLN,0),U,1)," Clinic.",!
"RTN","SDAMC",41,0)
 W ! S DIR(0)="E" D ^DIR W !
"RTN","SDAMC",42,0)
 K SCLHOLD,SC,COV,APP,SDCLN
"RTN","SDAMC",43,0)
 Q
"RTN","SDAMC",44,0)
MES ; -- set error message
"RTN","SDAMC",45,0)
 S SDMSG="W !,""Enter appt. numbers separated by commas and/or a range separated"",!,""by dashes (ie 2,4,6-9)"" H 2"
"RTN","SDAMC",46,0)
 Q
"RTN","SDAMC",47,0)
 ;
"RTN","SDAMC",48,0)
WHO() ;
"RTN","SDAMC",49,0)
 W ! S DIR(0)="SOA^PC:PATIENT;C:CLINIC",DIR("A")="Appointments cancelled by (P)atient or (C)linic: ",DIR("B")="Patient"
"RTN","SDAMC",50,0)
 D ^DIR K DIR
"RTN","SDAMC",51,0)
 Q $S(Y=""!(Y="^"):-1,1:Y)
"RTN","SDAMC",52,0)
 ;
"RTN","SDAMC",53,0)
RSN(SDWH) ;
"RTN","SDAMC",54,0)
RSN1 W ! S DIC="^SD(409.2,",DIC(0)="AEMQ",DIC("S")="I '$P(^(0),U,4),"""_$E(SDWH)_"B""[$P(^(0),U,2)" D ^DIC K DIC
"RTN","SDAMC",55,0)
 I X["^" G RSNQ
"RTN","SDAMC",56,0)
 I Y<0 W *7 G RSN1
"RTN","SDAMC",57,0)
RSNQ Q +Y
"RTN","SDAMC",58,0)
 ;
"RTN","SDAMC",59,0)
REM() ;
"RTN","SDAMC",60,0)
 W ! S DIR(0)="2.98,17" D ^DIR K DIR
"RTN","SDAMC",61,0)
 I $E(X)="^" S Y=-1
"RTN","SDAMC",62,0)
 Q Y
"RTN","SDAMC",63,0)
 ;
"RTN","SDAMC",64,0)
NOPE ;
"RTN","SDAMC",65,0)
 N SDEND,SDPAUSE
"RTN","SDAMC",66,0)
 S:'CNT SDPAUSE=1
"RTN","SDAMC",67,0)
 D NOPE^SDCNP1
"RTN","SDAMC",68,0)
 D:$G(SDPAUSE) PAUSE^VALM1
"RTN","SDAMC",69,0)
 Q
"RTN","SDAMC",70,0)
 ;
"RTN","SDAMC",71,0)
CHK ; -- check if status of appt permits cancelling
"RTN","SDAMC",72,0)
 N SDI S SDI=0
"RTN","SDAMC",73,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) I '$D(^SD(409.63,"ACAN",1,+$$STATUS^SDAM1($P(SDAT,U,2),$P(SDAT,U,3),+$G(^DPT(+$P(SDAT,U,2),"S",+$P(SDAT,U,3),0)),$G(^(0))))) D
"RTN","SDAMC",74,0)
 .W !,^TMP("SDAM",$J,+SDAT,0),!!,*7,"You cannot cancel this appointment."
"RTN","SDAMC",75,0)
 .K VALMY(SDI) D PAUSE^VALM1
"RTN","SDAMC",76,0)
 Q
"RTN","SDCNP1")
0^2^B33156446^B33998963
"RTN","SDCNP1",1,0)
SDCNP1 ;ALB/LDB - CANCEL APPOINTMENT (cont.) ; 5/25/12 11:42am
"RTN","SDCNP1",2,0)
 ;;5.3;Scheduling;**398,467,478,554,597**;Aug 13, 1993;Build 3
"RTN","SDCNP1",3,0)
 ;
"RTN","SDCNP1",4,0)
 ;SD/467 - EWL Open Matched Entry with rebook
"RTN","SDCNP1",5,0)
NOPE W !,*7,$S(CNT:CNT_" Appointment"_$S(CNT>1:"s",1:"")_" cancelled",1:"NOTHING CANCELLED")
"RTN","SDCNP1",6,0)
 N SDCLNK S SDCLNK=$G(SC) ; Hold value of SC for EWL Notification call
"RTN","SDCNP1",7,0)
 S SDCNT=CNT,SDA=1,SDCNT1=0 I CNT,$S('$D(^DPT(DFN,.35)):1,'$P(^(.35),U):1,1:0) S (SDA,X8)=0 D ASK G:X8="^" END
"RTN","SDCNP1",8,0)
 ;no rebooking to take place; open EWL entries only if applicable
"RTN","SDCNP1",9,0)
 I $D(DFN)>0 D EWL(DFN) ;SD/467
"RTN","SDCNP1",10,0)
 I SDA,SDCNT W !,*7,"NO AUTO-REBOOKING --Patient has died."
"RTN","SDCNP1",11,0)
 I 'SDA,SDCNT S A=DFN D LOOP1^SDCNP1A,LET,CANQ^SDAMC(DFN,$G(SDCLNK)) K SDCLNK
"RTN","SDCNP1",12,0)
 ;Calls subroutine CANQ to display wait list message if applicable. - PATCH SD*5.3*597
"RTN","SDCNP1",13,0)
END K:'$D(DIROUT) DFN D END^SDCNP Q:$D(DIROUT)  G RD^SDCNP
"RTN","SDCNP1",14,0)
ASK S (SDCTR,SDCTRL)=0,%=2 W !!,"DO YOU WISH TO REBOOK ANY APPOINTMENT(S) THAT YOU HAVE CANCELLED" D YN^DICN S ALS=% D:'% REASK G:'% ASK I %-1 S CNT=0 S:%<0 X8="^" D  Q
"RTN","SDCNP1",15,0)
 .W !,"OK"
"RTN","SDCNP1",16,0)
 W !!,"PLEASE NOTE THAT YOU MUST ENTER A DEVICE TO AUTO-REBOOK",!
"RTN","SDCNP1",17,0)
ZIS S %ZIS("A")="DEVICE TO OUTPUT REBOOKED APPT(S). :",%ZIS="QN" D ^%ZIS I POP S X8="^" Q
"RTN","SDCNP1",18,0)
 S L=0 F  S L=$O(^UTILITY($J,"SDCNP",L)) Q:'L  I $P(^(L),U,4)="*** JUST CANCELLED ***" S ^UTILITY($J,"SDCNP1",DFN,$P(^(L),"^",2),$P(^(L),"^"))=^(L)
"RTN","SDCNP1",19,0)
 D SDLST
"RTN","SDCNP1",20,0)
LST S B=0 F  S B=$O(^UTILITY($J,"SDCNP2",DFN,B)) Q:'B  W !!,$J($S(B\1=B:"("_$J(B,2)_") ",1:""),5) S AT=$S($P(^(B),"^",2)'?.N:1,1:0),Y=$P($P(^(B),"^"),".") D DT^SDM0 S X=$P(^(B),"^") X ^DD("FUNC",2,1) W " ",$J(X,8) S Z1(B)="" D MORE Q:SDCTRL
"RTN","SDCNP1",21,0)
 D WH
"RTN","SDCNP1",22,0)
 I B>0 G:SDCTRL&(A8']"") NOPE1 G:SDCTRL DEL
"RTN","SDCNP1",23,0)
 Q
"RTN","SDCNP1",24,0)
SDLST S L1=0 S Z5=0 F  S Z5=$O(^UTILITY($J,"SDCNP1",DFN,Z5)) Q:'Z5  F Z6=0:0 S Z7=Z6,Z6=$O(^UTILITY($J,"SDCNP1",DFN,Z5,Z6)) I Z6="" S L1=L1+1,^UTILITY($J,"SDCNP2",DFN,L1)=Z7_"^"_Z5_"^"_$P(^(Z7),"^",3,6) Q
"RTN","SDCNP1",25,0)
 Q
"RTN","SDCNP1",26,0)
MORE S SDCTR=SDCTR+2 I AT W ?41,$P(^UTILITY($J,"SDCNP2",B),"^",2) G OVR
"RTN","SDCNP1",27,0)
 S S5=^UTILITY($J,"SDCNP2",DFN,B) W " (",$P(S5,"^",6)," MINUTES)  ",$S($D(^SC($P(S5,"^",2),0)):$P(^(0),"^",1),1:"DELETED CLINIC"),$P(S5,"^",3) S M1=$P(^SC($P(S5,"^",2),"SDP"),"^",4) W !,?41,"Max days for rebooking= ",M1
"RTN","SDCNP1",28,0)
OVR I SDCTR>20,$O(^UTILITY($J,"SDCNP2",B))>0 S (SDCTRL,SDCTR)=0 W *7 D WH W:'SDCTRL @IOF
"RTN","SDCNP1",29,0)
 Q
"RTN","SDCNP1",30,0)
WH W !!,"SELECT APPOINTMENT(S) TO BE REBOOKED" W:B>0 " OR HIT RETURN TO CONTINUE DISPLAY" R ": ",A8:DTIME I '$T!(A8="^") S SDCTRL=1,A8="",X8="^" Q
"RTN","SDCNP1",31,0)
 I A8["?" X SDMSG G WH
"RTN","SDCNP1",32,0)
DEL S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  D MTCH
"RTN","SDCNP1",33,0)
 I SDERR G LST
"RTN","SDCNP1",34,0)
DEL1 S SDERR=0 F J=1:1 S SDDH=$P(A8,",",J) Q:SDDH']""  S SDDI=$P(SDDH,"-"),SDDM=$P(SDDH,"-",2) D CKK^SDCNP1A Q:SDERR  D CKK2^SDCNP1A Q:SDERR  F Z9=SDDI:1:$S(SDDM:SDDM,1:SDDI) D:SDDI REBK I 'SDDI S SDERR=1 Q
"RTN","SDCNP1",35,0)
 G:SDERR LST Q:A8["^"!(A8="")  S SDERR=0 D ^SDCNP1A Q:X8="^"
"RTN","SDCNP1",36,0)
 D:MAX QUE
"RTN","SDCNP1",37,0)
 D NOPE1
"RTN","SDCNP1",38,0)
 Q 
"RTN","SDCNP1",39,0)
LET ;
"RTN","SDCNP1",40,0)
 S %=2 W !!,"DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT(S)" D YN^DICN S ANS="Y" D:'% REASK G:'% LET Q:(%-1)
"RTN","SDCNP1",41,0)
 I $$BADADR^DGUTL3(+DFN) D  Q  ;display, don't print BAI list
"RTN","SDCNP1",42,0)
 . W *7,!,"** THIS PATIENT HAS BEEN FLAGGED WITH A BAD ADDRESS INDICATOR, NO LETTER"
"RTN","SDCNP1",43,0)
 . W !,"WILL BE PRINTED."
"RTN","SDCNP1",44,0)
 . S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1",45,0)
QUE2 ;S DGPGM="SDLET^SDCNP1A",DGVAR="SDCL#^DUZ^DFN^DT^A^SDWH" D ZIS^DGUTQ D:POP CLOSE^DGUTQ Q:POP  D SDLET^SDCNP1A Q
"RTN","SDCNP1",46,0)
 S %ZIS="MQ" K IO("Q") D ^%ZIS Q:POP  ;SD/478
"RTN","SDCNP1",47,0)
 I $D(IO("Q")) D  D:IO'=IO(0) NOTELTR D ^%ZISC W @IOF Q  ;SD/478
"RTN","SDCNP1",48,0)
 .S ZTRTN="SDLET^SDCNP1A" F ZTS="SDCL(","DUZ","DFN","DT","A","SDWH","AUTO(" S ZTSAVE(ZTS)=""  ;SD/478
"RTN","SDCNP1",49,0)
 .K ZTS D ^%ZTLOAD  ;SD/478
"RTN","SDCNP1",50,0)
 D:IO'=IO(0) NOTELTR D SDLET^SDCNP1A,^%ZISC W @IOF  ;SD/478
"RTN","SDCNP1",51,0)
 Q  ;SD/478
"RTN","SDCNP1",52,0)
NOTELTR I ANS["Y",ALS=1 S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT AUTO REBOOK letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT AUTO REBOOK LETTER PRINTED.
"RTN","SDCNP1",53,0)
 I ANS["Y" S:$D(CNDIE) @(CNDIE_CNDA_",1,CNINDX,0)")="CANCEL APPOINTMENT letter printed." K CNDIE,CNDA,CNINDX ;SD/478 CANCEL APPT LETTER IS PRINTED.
"RTN","SDCNP1",54,0)
 Q
"RTN","SDCNP1",55,0)
QUE I IO'=IO(0) S DGPGM="^SDCNP2",DGVAR="SDCL#^NDATE^A^GDATE^DT^DUZ",IOP=IO,X="NOW" D Q1^DGUTQ Q
"RTN","SDCNP1",56,0)
 U IO I IO=IO(0),$E(IOST,1,2)="C-" S SDIO=1 D ^SDCNP2 Q
"RTN","SDCNP1",57,0)
NOPE1 W @IOF,!,*7,$S(SDCNT1:SDCNT1_" Appointment"_$S(SDCNT1>1:"s",1:"")_" rebooked",1:"NOTHING REBOOKED") Q
"RTN","SDCNP1",58,0)
REBK K ^UTILITY($J,"SDCNP") S ^UTILITY($J,"SDCNP2","REBK",DFN,Z9)=^UTILITY($J,"SDCNP2",DFN,Z9)
"RTN","SDCNP1",59,0)
 Q
"RTN","SDCNP1",60,0)
 F A9=SDDI,SDDM Q:'SDDM&(SDDI-A9)  I '$D(Z1(A9)) S SDERR=1 W !,*7,"There is no appointment number ",A9
"RTN","SDCNP1",61,0)
 Q
"RTN","SDCNP1",62,0)
REASK W !,"ANSWER (Y)ES OR (N)O" Q
"RTN","SDCNP1",63,0)
CLRK S $P(^DPT(DFN,"S",S,0),"^",19)=$P(SDNODE,"^",7),$P(^DPT(DFN,"S",S,0),"^",18)=$P(SDNODE,"^",6) Q
"RTN","SDCNP1",64,0)
MTCH Q:SDDH?1N.N!(SDDH?1.N1"-".N)  S SDERR=1 X SDMSG
"RTN","SDCNP1",65,0)
 Q
"RTN","SDCNP1",66,0)
EWL(DFN) ;
"RTN","SDCNP1",67,0)
 I '$D(^UTILITY($J,"SDCNP1")) I '$D(^UTILITY($J,"SDCNP")) Q
"RTN","SDCNP1",68,0)
 ;call to EWL to open and optionally close EWL entry with rebooked appointment
"RTN","SDCNP1",69,0)
 N SDFRB,SDT,SC,SDREB K ^TMP("SDWLREB",$J),^TMP($J,"SDWPL"),^TMP($J,"APPT")
"RTN","SDCNP1",70,0)
 I $D(^UTILITY($J,"SDCNP1")) S SDFRB="^UTILITY($J,""SDCNP1"")"  D REB I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB Q
"RTN","SDCNP1",71,0)
 E  S SDFRB="^UTILITY($J,""SDCNP"")" D CAN I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB
"RTN","SDCNP1",72,0)
 Q
"RTN","SDCNP1",73,0)
REB I $D(^UTILITY($J,"SDCNP1")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP1"  S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",74,0)
 .;N NN F NN=1:1 Q:'$D(^UTILITY($J,"SDCNP","REBK",DFN,NN))  I $P($G(^UTILITY($J,"SDCNP2","REBK",DFN,NN)),U)=SDT S SDREB=1 Q
"RTN","SDCNP1",75,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",76,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",77,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",78,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",79,0)
 Q
"RTN","SDCNP1",80,0)
CAN I $D(^UTILITY($J,"SDCNP")) F  S SDFRB=$Q(@SDFRB) Q:SDFRB'["SDCNP"  I @SDFRB["CANCELLED" S SDT=$P(@SDFRB,U),SC=$P(@SDFRB,U,2),SDREB=0 D
"RTN","SDCNP1",81,0)
 .N RBFLG,SDTRB D REBOOK^SDWLREB(DFN,SDT,SC,.RBFLG,.SDTRB)
"RTN","SDCNP1",82,0)
 .I $E(RBFLG,1,2)'="CC" Q  ;not canceled by clinic
"RTN","SDCNP1",83,0)
 .I RBFLG="CCR" S SDREB=1 D DISREB^SDWLREB(DFN,SDTRB,SC)
"RTN","SDCNP1",84,0)
 .D OPENEWL^SDWLREB(DFN,SDT,SC,SDREB) K ^TMP($J,"APPT"),^TMP($J,"SDWLPL")
"RTN","SDCNP1",85,0)
 Q
"VER")
8.0^22.0
"BLD",9110,6)
^490
**END**
**END**
