Released RG*1*60 SEQ #59
Extracted from mail message
**KIDS**:RG*1.0*60^

**INSTALL NAME**
RG*1.0*60
"BLD",2974,0)
RG*1.0*60^CLINICAL INFO RESOURCE NETWORK^0^3130529^y
"BLD",2974,1,0)
^^3^3^3130416^
"BLD",2974,1,1,0)
MASTER VETERAN INDEX VISTA ISSUES - ITERATION 10
"BLD",2974,1,2,0)
Refer to patch RG*1*60 in the FORUM Patch Module for a complete
"BLD",2974,1,3,0)
description.
"BLD",2974,4,0)
^9.64PA^^
"BLD",2974,6.3)
2
"BLD",2974,"ABPKG")
n
"BLD",2974,"KRN",0)
^9.67PA^779.2^20
"BLD",2974,"KRN",.4,0)
.4
"BLD",2974,"KRN",.401,0)
.401
"BLD",2974,"KRN",.402,0)
.402
"BLD",2974,"KRN",.403,0)
.403
"BLD",2974,"KRN",.5,0)
.5
"BLD",2974,"KRN",.84,0)
.84
"BLD",2974,"KRN",3.6,0)
3.6
"BLD",2974,"KRN",3.8,0)
3.8
"BLD",2974,"KRN",9.2,0)
9.2
"BLD",2974,"KRN",9.8,0)
9.8
"BLD",2974,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",2974,"KRN",9.8,"NM",1,0)
RGRPDAT^^0^B53927428
"BLD",2974,"KRN",9.8,"NM",2,0)
RGADTP^^0^B83590843
"BLD",2974,"KRN",9.8,"NM",3,0)
RGMTAUD^^0^B34306275
"BLD",2974,"KRN",9.8,"NM",4,0)
RGMTAUDP^^0^B84209421
"BLD",2974,"KRN",9.8,"NM","B","RGADTP",2)

"BLD",2974,"KRN",9.8,"NM","B","RGMTAUD",3)

"BLD",2974,"KRN",9.8,"NM","B","RGMTAUDP",4)

"BLD",2974,"KRN",9.8,"NM","B","RGRPDAT",1)

"BLD",2974,"KRN",19,0)
19
"BLD",2974,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",2974,"KRN",19,"NM",1,0)
RG NATIONAL ICN STATISTICS^^1^
"BLD",2974,"KRN",19,"NM","B","RG NATIONAL ICN STATISTICS",1)

"BLD",2974,"KRN",19.1,0)
19.1
"BLD",2974,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",2974,"KRN",101,0)
101
"BLD",2974,"KRN",409.61,0)
409.61
"BLD",2974,"KRN",771,0)
771
"BLD",2974,"KRN",779.2,0)
779.2
"BLD",2974,"KRN",870,0)
870
"BLD",2974,"KRN",8989.51,0)
8989.51
"BLD",2974,"KRN",8989.52,0)
8989.52
"BLD",2974,"KRN",8994,0)
8994
"BLD",2974,"KRN","B",.4,.4)

"BLD",2974,"KRN","B",.401,.401)

"BLD",2974,"KRN","B",.402,.402)

"BLD",2974,"KRN","B",.403,.403)

"BLD",2974,"KRN","B",.5,.5)

"BLD",2974,"KRN","B",.84,.84)

"BLD",2974,"KRN","B",3.6,3.6)

"BLD",2974,"KRN","B",3.8,3.8)

"BLD",2974,"KRN","B",9.2,9.2)

"BLD",2974,"KRN","B",9.8,9.8)

"BLD",2974,"KRN","B",19,19)

"BLD",2974,"KRN","B",19.1,19.1)

"BLD",2974,"KRN","B",101,101)

"BLD",2974,"KRN","B",409.61,409.61)

"BLD",2974,"KRN","B",771,771)

"BLD",2974,"KRN","B",779.2,779.2)

"BLD",2974,"KRN","B",870,870)

"BLD",2974,"KRN","B",8989.51,8989.51)

"BLD",2974,"KRN","B",8989.52,8989.52)

"BLD",2974,"KRN","B",8994,8994)

"BLD",2974,"QDEF")
^^^^^^^^^^YES
"BLD",2974,"QUES",0)
^9.62^^
"BLD",2974,"REQB",0)
^9.611^5^4
"BLD",2974,"REQB",1,0)
RG*1.0*55^2
"BLD",2974,"REQB",2,0)
RG*1.0*59^2
"BLD",2974,"REQB",4,0)
RG*1.0*46^2
"BLD",2974,"REQB",5,0)
DG*5.3*863^2
"BLD",2974,"REQB","B","DG*5.3*863",5)

"BLD",2974,"REQB","B","RG*1.0*46",4)

"BLD",2974,"REQB","B","RG*1.0*55",1)

"BLD",2974,"REQB","B","RG*1.0*59",2)

"KRN",19,7546,-1)
1^1
"KRN",19,7546,0)
RG NATIONAL ICN STATISTICS
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^1^1
"PKG",272,20,1,0)
2^^RGDRM03
"PKG",272,20,1,1)

"PKG",272,20,"B",2,1)

"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
60^3130529
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3130529
"PKG",272,22,1,"PAH",1,1,1,0)
MASTER VETERAN INDEX VISTA ISSUES - ITERATION 10
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*60 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","RGADTP")
0^2^B83590843^B82380142
"RTN","RGADTP",1,0)
RGADTP ;BIR/DLR-ADT PROCESSOR TO RETRIGGER A08 or A04 MESSAGES WITH AL/AL (COMMIT/APPLICATION) ACKNOWLEDGEMENTS ; 3/19/2013  10:29 AM
"RTN","RGADTP",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**26,27,20,34,35,40,45,44,47,59,60**;30 Apr 99;Build 2
"RTN","RGADTP",3,0)
 ;
"RTN","RGADTP",4,0)
 ;Reference to BLDEVN^VAFCQRY and BLDPID^VAFCQRY supported by IA #3630
"RTN","RGADTP",5,0)
 ;Reference to EN1^VAFHLZEL is supported by IA #752
"RTN","RGADTP",6,0)
 ;Reference to Patient file (#2) PREFERRED FACILITY (#27.02) is supported by IA #1850
"RTN","RGADTP",7,0)
 ;Reference to $$PV2, $$PHARA, $$LABE, $$RADE ^VAFCSB is supported by IA #4921
"RTN","RGADTP",8,0)
 ;
"RTN","RGADTP",9,0)
INIT ;
"RTN","RGADTP",10,0)
 N RGER,RGSITE,ARRAY,MSH,RGLOCAL,RGEVNT,REP,DIC,DR,DIE,DA,DLAYGO
"RTN","RGADTP",11,0)
 S RGER=""
"RTN","RGADTP",12,0)
 D IN
"RTN","RGADTP",13,0)
 D PROCIN
"RTN","RGADTP",14,0)
 D GENACK
"RTN","RGADTP",15,0)
 Q
"RTN","RGADTP",16,0)
PROC ;processing entry point
"RTN","RGADTP",17,0)
 N HLA,RGADT,PV1,DIC,ARRAY,RGEVNT,RGLOCAL,REP,ICN,RGSITE
"RTN","RGADTP",18,0)
 S RGEVNT=HL("ETN")
"RTN","RGADTP",19,0)
 I $G(HL("MID"))'="" S RGADT=HL("MID")
"RTN","RGADTP",20,0)
 I $G(HL("MID"))="" S RGADT=999
"RTN","RGADTP",21,0)
 D IN
"RTN","RGADTP",22,0)
 S ICN=$G(ARRAY("ICN"))
"RTN","RGADTP",23,0)
 I +$G(ICN)<1 Q  ;quit if no ICN
"RTN","RGADTP",24,0)
 I $E($G(ICN),1,3)=$P($$SITE^VASITE,"^",3) Q  ;quit if ICN is a local
"RTN","RGADTP",25,0)
 S ZTSAVE("DFN")="",ZTSAVE("RGEVNT")="",ZTSAVE("HLA(""HLS"",")="",ZTRTN="SEND^RGADTPC",ZTDESC="Sending HL7 Patient Update...",ZTIO="RG QUEUE",ZTDTH=$H D ^%ZTLOAD
"RTN","RGADTP",26,0)
 K ZTSAVE,ZTRTN,ZTDESC,ZTIO,ZTDTH
"RTN","RGADTP",27,0)
 Q
"RTN","RGADTP",28,0)
IN ;Process in the ADT A04/A08 (routing logic)
"RTN","RGADTP",29,0)
 N RGI,MSG,RG,SG,DFN,EVN,SITE,RGC,RGJ,DIC,PV1,PID,COMP,ENT,EN,THLA,LAB,RAD,PHARM,TMP
"RTN","RGADTP",30,0)
 S ENT=1,REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1)
"RTN","RGADTP",31,0)
 ;set local flag to indicate the processing of an outbound for reformatting
"RTN","RGADTP",32,0)
 I $P($G(HL("SAF")),COMP)=$P($$SITE^VASITE,"^",3) S RGLOCAL=1
"RTN","RGADTP",33,0)
 I $P($G(HL("SAF")),COMP)'=$P($$SITE^VASITE,"^",3) S RGLOCAL=0
"RTN","RGADTP",34,0)
 S RGC=$E($G(HL("ECH")),1)
"RTN","RGADTP",35,0)
 F RGI=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE,SG=$E(HLNODE,1,3) D
"RTN","RGADTP",36,0)
 .S RGJ=0 F  S RGJ=$O(HLNODE(RGJ)) Q:'RGJ  S MSG(RGJ)=HLNODE(RGJ)
"RTN","RGADTP",37,0)
 .D:SG?2A1(1A,1N) PICK
"RTN","RGADTP",38,0)
 ;if message MSH sending facility matches the PID assigning authority update
"RTN","RGADTP",39,0)
 S ENT=0,EN=1 F  S ENT=$O(THLA("HLS",ENT)) Q:ENT=""  D
"RTN","RGADTP",40,0)
 .S HLA("HLS",EN)=THLA("HLS",ENT),EN=EN+1
"RTN","RGADTP",41,0)
 .I $E($G(THLA("HLS",ENT)),1,3)="PID"!($E($G(THLA("HLS",ENT)),1,3)="ZEL") D
"RTN","RGADTP",42,0)
 ..;**47 handle if ZEL is over 245 as well
"RTN","RGADTP",43,0)
 ..I $O(THLA("HLS",ENT,""))'="" D
"RTN","RGADTP",44,0)
 ...S CNT="" F  S CNT=$O(THLA("HLS",ENT,CNT)) Q:CNT=""  S HLA("HLS",EN-1,CNT)=THLA("HLS",ENT,CNT)
"RTN","RGADTP",45,0)
 .I $E($G(THLA("HLS",ENT)),1,3)="PV1" I RGLOCAL S TMP=$$PV2B I TMP'="" S HLA("HLS",EN)=$$PV2B,EN=EN+1  ;**47
"RTN","RGADTP",46,0)
 .I $E($G(THLA("HLS",ENT)),1,3)="ZPD" I RGLOCAL D
"RTN","RGADTP",47,0)
 ..S RAD=$$RADE I RAD'="" S HLA("HLS",EN)=RAD,EN=EN+1
"RTN","RGADTP",48,0)
 ..S LAB=$$LABE I LAB'="" S HLA("HLS",EN)=LAB,EN=EN+1
"RTN","RGADTP",49,0)
 ..S PHARM=$$PHARA I PHARM'="" S HLA("HLS",EN)=PHARM,EN=EN+1
"RTN","RGADTP",50,0)
 ..S OLD=$$OLD I OLD'="" S HLA("HLS",EN)=OLD,EN=EN+1 ;**59,MVI_914: Pass OLDER RECORD in OBX if flagged as such
"RTN","RGADTP",51,0)
QUIT Q
"RTN","RGADTP",52,0)
ROUTE ;
"RTN","RGADTP",53,0)
 N RGERR
"RTN","RGADTP",54,0)
 I $G(RGEVNT)="" S RGEVNT=$G(HL("ETN"))
"RTN","RGADTP",55,0)
 N MPI S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGADTP",56,0)
 .I $P($G(MPI),U)'=-1 S HLL("LINKS",1)="RG ADT-"_HL("ETN")_" 2.4 CLIENT^"_MPI
"RTN","RGADTP",57,0)
 .I $P($G(MPI),U)=-1 D
"RTN","RGADTP",58,0)
 ..N RGLOG,RGMTXT D START^RGHLLOG(HLMTIEN,"","") S RGMTXT="for DFN#"_$G(DFN)
"RTN","RGADTP",59,0)
 ..D EXC^RGHLLOG(224,"No MPI link identified"_RGMTXT,$G(DFN)) S RGERR=1
"RTN","RGADTP",60,0)
 ;**60 MVI_1837(rjh): to catch undefined dfn
"RTN","RGADTP",61,0)
 ;I $G(RGERR)'=1 S ^XTMP("RG"_HL("ETN")_"%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"RG"_HL("ETN")_" msg to MPI for DFN "_DFN S ^XTMP("RG"_HL("ETN")_"%"_DFN,"MPI",0)="A"
"RTN","RGADTP",62,0)
 I $G(RGERR)'=1,$D(^DPT(+$G(DFN),0)) D
"RTN","RGADTP",63,0)
 .S ^XTMP("RG"_HL("ETN")_"%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"RG"_HL("ETN")_" msg to MPI for DFN "_DFN
"RTN","RGADTP",64,0)
 .S ^XTMP("RG"_HL("ETN")_"%"_DFN,"MPI",0)="A"
"RTN","RGADTP",65,0)
 Q
"RTN","RGADTP",66,0)
RESP ;
"RTN","RGADTP",67,0)
 N RGER,RGSITE,ARRAY,MSH,RGLOCAL,RGEVNT,RGI,MSG,RG,SG,DFN,EVN,SITE,RGC,RGJ,DIC,PV1,PID
"RTN","RGADTP",68,0)
 D IN
"RTN","RGADTP",69,0)
 Q
"RTN","RGADTP",70,0)
PICK ;check routine for segment entry point
"RTN","RGADTP",71,0)
 I $T(@SG)]"" D @SG
"RTN","RGADTP",72,0)
 I $T(@SG)="" Q
"RTN","RGADTP",73,0)
 Q
"RTN","RGADTP",74,0)
MSA ;process the MSA segment
"RTN","RGADTP",75,0)
 N ARRAY,CNT,DFN,EXIT,HLCOMP,RGAA,RGERR,RGEVNT,RGMSG,RETURN,RGX,RGY,RGCODE
"RTN","RGADTP",76,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",77,0)
 S RGAA=MSG,EXIT=0,RGCODE=$P(RGAA,HL("FS"),2),RGMSG=$P(RGAA,HL("FS"),3),RGERR=$P(RGAA,HL("FS"),4),RGMSG=$$MSG^HLCSUTL(RGMSG,"RETURN(1)") K RGMSG
"RTN","RGADTP",78,0)
 S CNT=1,RGX=0 F  S RGX=$O(RETURN(1,RGX)) Q:'RGX!(EXIT=1)  D
"RTN","RGADTP",79,0)
 .I RETURN(1,RGX)'="" D
"RTN","RGADTP",80,0)
 ..I $D(RGMSG) S RGMSG(CNT)=RETURN(1,RGX),CNT=CNT+1
"RTN","RGADTP",81,0)
 ..I '$D(RGMSG) S RGMSG=RETURN(1,RGX),RGY=RGX
"RTN","RGADTP",82,0)
 .I RETURN(1,RGX)="" D  S CNT=1 K RGMSG
"RTN","RGADTP",83,0)
 ..I $E(RETURN(1,RGY),1,3)="MSH" D MSH
"RTN","RGADTP",84,0)
 ..I $E(RETURN(1,RGY),1,3)="PID" D PIDP^RGADTP1(.RGMSG,.ARRAY,.HL) S EXIT=1
"RTN","RGADTP",85,0)
 S DFN=$G(ARRAY("DFN"))
"RTN","RGADTP",86,0)
 ;**45 Log Exception ONLY if AR is returned in MSA segment
"RTN","RGADTP",87,0)
 I RGCODE="AR" D
"RTN","RGADTP",88,0)
 .D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGADTP",89,0)
 .D EXC^RGHLLOG(234,RGERR,DFN) ;**44
"RTN","RGADTP",90,0)
 .D STOP^RGHLLOG(0)
"RTN","RGADTP",91,0)
 K:$G(DFN)>0 ^XTMP("MPIF OLD RECORDS",DFN) ;**59,MVI_914: Delete the old record designation
"RTN","RGADTP",92,0)
 I $D(^XTMP("RG"_HL("ETN")_"%"_DFN,0)) K ^XTMP("RG"_HL("ETN")_"%"_DFN)
"RTN","RGADTP",93,0)
 Q
"RTN","RGADTP",94,0)
MSH ;
"RTN","RGADTP",95,0)
 S MSH=1
"RTN","RGADTP",96,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",97,0)
 I 'RGLOCAL S RGC=$E(HL("ECH"),1)
"RTN","RGADTP",98,0)
 S RGSITE=$P($P(MSG,HL("FS"),4),RGC),RGEVNT=$P($P(MSG,HL("FS"),9),RGC,2)
"RTN","RGADTP",99,0)
 Q
"RTN","RGADTP",100,0)
PV2 ;processor of PV2 segment ;**47
"RTN","RGADTP",101,0)
 Q
"RTN","RGADTP",102,0)
PV2B() ;builder of PV2 segment ;**47
"RTN","RGADTP",103,0)
 N RET S RET=""
"RTN","RGADTP",104,0)
 I 'RGLOCAL Q RET
"RTN","RGADTP",105,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") Q:'$T RET
"RTN","RGADTP",106,0)
 ;**45 VAFCSB coming in with DG*5.3*707
"RTN","RGADTP",107,0)
 Q $$PV2^VAFCSB
"RTN","RGADTP",108,0)
PHARA() ;build obx to show active prescriptions
"RTN","RGADTP",109,0)
 N RET S RET=""
"RTN","RGADTP",110,0)
 I 'RGLOCAL Q RET
"RTN","RGADTP",111,0)
 I '$$PATCH^XPDUTL("PSS*1.0*101") Q RET
"RTN","RGADTP",112,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") Q:'$T RET
"RTN","RGADTP",113,0)
 ;**45 VAFCSB coming in with DG*5.3*707
"RTN","RGADTP",114,0)
 Q $$PHARA^VAFCSB
"RTN","RGADTP",115,0)
LABE() ;BUILD OBX FOR LAST LAB TEST DATE
"RTN","RGADTP",116,0)
 N RET S RET=""
"RTN","RGADTP",117,0)
 I 'RGLOCAL Q RET
"RTN","RGADTP",118,0)
 I '$$PATCH^XPDUTL("LR*5.2*295") Q RET
"RTN","RGADTP",119,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") Q:'$T RET
"RTN","RGADTP",120,0)
 ;**45 VAFCSB coming in with DG*5.3*707
"RTN","RGADTP",121,0)
 Q $$LABE^VAFCSB
"RTN","RGADTP",122,0)
RADE() ;BUILD OBX FOR LAST RADIOLOGY TEST DATE
"RTN","RGADTP",123,0)
 N RET S RET=""
"RTN","RGADTP",124,0)
 I 'RGLOCAL Q RET
"RTN","RGADTP",125,0)
 I '$$PATCH^XPDUTL("RA*5.0*76") Q RET
"RTN","RGADTP",126,0)
 N X S X="VAFCSB" X ^%ZOSF("TEST") Q:'$T RET
"RTN","RGADTP",127,0)
 ;**45 VAFCSB coming in with DG*5.3*707
"RTN","RGADTP",128,0)
 Q $$RADE^VAFCSB
"RTN","RGADTP",129,0)
EVN ;;
"RTN","RGADTP",130,0)
 N CNT,ERR S EVN=RGI
"RTN","RGADTP",131,0)
 I RGLOCAL S (EVN(1),THLA("HLS",ENT))=MSG,ENT=ENT+1
"RTN","RGADTP",132,0)
 I 'RGLOCAL D
"RTN","RGADTP",133,0)
 .S ARRAY("EVR")=$P(MSG,HL("FS"),2),ARRAY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","RGADTP",134,0)
 .S ARRAY("EVNAME")=$$FMNAME^XLFNAME($P(MSG,HL("FS"),2),"",$E(HL("ECH"),1)),ARRAY("SENDING SITE")=$P(MSG,HL("FS"),8)
"RTN","RGADTP",135,0)
 Q
"RTN","RGADTP",136,0)
EVNP ;
"RTN","RGADTP",137,0)
 N EVNX
"RTN","RGADTP",138,0)
 I $G(DFN)'="" D BLDEVN^VAFCQRY(DFN,"1,2,4,5,6,7",.EVN,.HL,$G(HL("ETN")),.ERR) S CNT=0,EVNX=0 F  S EVNX=$O(EVN(EVNX)) Q:'EVNX  D
"RTN","RGADTP",139,0)
 .I CNT>0 S THLA("HLS",EVN,CNT)=EVN(EVNX),CNT=CNT+1
"RTN","RGADTP",140,0)
 .I CNT'>0 S THLA("HLS",EVN)=EVN(EVNX),CNT=CNT+1
"RTN","RGADTP",141,0)
 Q
"RTN","RGADTP",142,0)
PID ;;
"RTN","RGADTP",143,0)
 N CNT,PIDX
"RTN","RGADTP",144,0)
 I RGLOCAL D
"RTN","RGADTP",145,0)
 .N HLCOMP S HLCOMP=$E(HL("ECH"),1),THLA("HLS",ENT)=MSG,DFN=$P($P(MSG,HL("FS"),4),HLCOMP) ;**45 REMOVED +
"RTN","RGADTP",146,0)
 .D EVNP
"RTN","RGADTP",147,0)
 .D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL)
"RTN","RGADTP",148,0)
 .;get ICN value in the PID segment
"RTN","RGADTP",149,0)
 .S ARRAY("ICN")=+$P($P(PID(1),HL("FS"),4),HLCOMP)
"RTN","RGADTP",150,0)
 .S CNT=0,PIDX=0 F  S PIDX=$O(PID(PIDX)) Q:'PIDX  D
"RTN","RGADTP",151,0)
 ..I CNT>0 S THLA("HLS",ENT,CNT)=PID(PIDX),CNT=CNT+1
"RTN","RGADTP",152,0)
 ..I CNT'>0 S THLA("HLS",ENT)=PID(PIDX),CNT=CNT+1
"RTN","RGADTP",153,0)
 .S ENT=ENT+1
"RTN","RGADTP",154,0)
 I 'RGLOCAL D PIDP^RGADTP1(.MSG,.ARRAY,.HL)
"RTN","RGADTP",155,0)
 Q
"RTN","RGADTP",156,0)
PD1 ;SET PD1 SEQ 3 TO BE PREFERRED FACILITY INSTEAD OF CMOR PATCH **45
"RTN","RGADTP",157,0)
 N PD1
"RTN","RGADTP",158,0)
 I RGLOCAL D
"RTN","RGADTP",159,0)
 .;S PD1=$$PD1^VAFCSB
"RTN","RGADTP",160,0)
 .;I PD1'="" S THLA("HLS",ENT)=PD1,ENT=ENT+1
"RTN","RGADTP",161,0)
 I 'RGLOCAL S (ARRAY(991.03),ARRAY("CMOR"))=$P($P(MSG,HL("FS"),4),RGC) ;PUTTING BACK TO DO NEED FOR PATCH 40 ON MPI SIDE
"RTN","RGADTP",162,0)
 ;- NO LONGER DEALING WITH CMOR
"RTN","RGADTP",163,0)
 Q
"RTN","RGADTP",164,0)
PV1 ;;
"RTN","RGADTP",165,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",166,0)
 Q
"RTN","RGADTP",167,0)
OBX ;;
"RTN","RGADTP",168,0)
 N COMP,SSNV S COMP=$E(HL("ECH"),1)
"RTN","RGADTP",169,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",170,0)
 I 'RGLOCAL D:$$FREE^RGRSPARS($P($P(MSG,HL("FS"),4),RGC,2))="SECURITY LEVEL"
"RTN","RGADTP",171,0)
 .S ARRAY("SENSITIVITY")=$$SENSTIVE^RGRSPARS($P(MSG,HL("FS"),6),COMP),ARRAY("SENSITIVITY DATE")=$$FREE^RGRSPARS($$FMDATE^HLFNC($P(MSG,HL("FS"),15)))
"RTN","RGADTP",172,0)
 .S ARRAY("SENSITIVITY USER")=$$FREE^RGRSPARS($P($P(MSG,HL("FS"),17),RGC,2))_","_$$FREE^RGRSPARS($P($P(MSG,HL("FS"),17),RGC,3))
"RTN","RGADTP",173,0)
 ;**45 Get SSN VERIFICATION STATUS out of OBX if message is from the MPI
"RTN","RGADTP",174,0)
 ;I 'RGLOCAL,$P(HL("SFN"),COMP)="200M" I $P($P(MSG,HL("FS"),4),RGC)="SSN VERIFICATION STATUS" S SSNV=$P($P(MSG,HL("FS"),6),RGC,2),ARRAY(.0907)=$S(SSNV="VERIFIED":4,SSNV="INVALID":2,1:"@")
"RTN","RGADTP",175,0)
 ;**47 use SSN Verification status code and not words since they have changed since this code was first written
"RTN","RGADTP",176,0)
 ;only update values to valid or invalid other statuses aren't stored in VistA
"RTN","RGADTP",177,0)
 I 'RGLOCAL,$P(HL("SFN"),COMP)="200M" I $P($P(MSG,HL("FS"),4),RGC)="SSN VERIFICATION STATUS" S SSNV=$P($P(MSG,HL("FS"),6),RGC,1),ARRAY(.0907)=$S(SSNV=4:4,SSNV=2:2,1:"@")
"RTN","RGADTP",178,0)
 Q
"RTN","RGADTP",179,0)
ZPD ;;
"RTN","RGADTP",180,0)
 I RGLOCAL S THLA("HLS",ENT)=$$EN1^VAFHLZPD(DFN,"1,17,21,34"),ENT=ENT+1 ;**45 to build new ZPD
"RTN","RGADTP",181,0)
 I 'RGLOCAL S ARRAY(.0906)=$P(MSG,HL("FS"),35) I ARRAY(.0906)=HL("Q") S ARRAY(.0906)="@" ;**45 Pull out pseudo ssn reason
"RTN","RGADTP",182,0)
 Q
"RTN","RGADTP",183,0)
ZSP ;;
"RTN","RGADTP",184,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",185,0)
 I 'RGLOCAL S ARRAY(.301)=$$YESNO^RGRSPARS($P(MSG,HL("FS"),3)),ARRAY(.302)=$$FREE^RGRSPARS($P(MSG,HL("FS"),4)),ARRAY(.323)=$$POS^RGRSPARS($P(MSG,HL("FS"),5))
"RTN","RGADTP",186,0)
 Q
"RTN","RGADTP",187,0)
ZEL ;;
"RTN","RGADTP",188,0)
 I RGLOCAL D
"RTN","RGADTP",189,0)
 .;**40 to rebuild ZEL segment
"RTN","RGADTP",190,0)
 .I '$D(DFN) S THLA("HLS",ENT)=MSG,ENT=ENT+1 Q  ;don't know DFN pass back original ZEL segment
"RTN","RGADTP",191,0)
 .N VAFZEL D EN1^VAFHLZEL(DFN,"1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22",2,.VAFZEL) ;build a complete ZEL segment
"RTN","RGADTP",192,0)
 .;need to take into account may be more than 1 array entry and that each entry could go over 245 so there would be another subscript
"RTN","RGADTP",193,0)
 .N CNT,ZELX S (CNT,ZELX)=0 F  S ZELX=$O(VAFZEL(ZELX)) Q:'ZELX  D
"RTN","RGADTP",194,0)
 ..I CNT>0 S THLA("HLS",ENT,CNT)=VAFZEL(ZELX),CNT=CNT+1
"RTN","RGADTP",195,0)
 ..I CNT'>0 S THLA("HLS",ENT)=VAFZEL(ZELX),ENT=ENT+1
"RTN","RGADTP",196,0)
 I 'RGLOCAL D
"RTN","RGADTP",197,0)
 . S ARRAY(.361)=$$ELIG^RGRSPARS($P(MSG,HL("FS"),3)),ARRAY(.3612)=$$FREE^RGRSPARS($P(MSG,HL("FS"),12))
"RTN","RGADTP",198,0)
 . S ARRAY(.3615)=$$FREE^RGRSPARS($P(MSG,HL("FS"),14)),ARRAY(391)=$$TYPE^RGRSPARS($P(MSG,HL("FS"),10)),ARRAY(1901)=$$VETERAN^RGRSPARS($P(MSG,HL("FS"),9))
"RTN","RGADTP",199,0)
 Q
"RTN","RGADTP",200,0)
ZCT ;;
"RTN","RGADTP",201,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",202,0)
 I 'RGLOCAL S ARRAY(.211)=$$FREE^RGRSPARS($P(MSG,HL("FS"),4)),ARRAY(.219)=$$FREE^RGRSPARS($P(MSG,HL("FS"),7))
"RTN","RGADTP",203,0)
 Q
"RTN","RGADTP",204,0)
ZEM ;;
"RTN","RGADTP",205,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",206,0)
 I 'RGLOCAL S ARRAY(.31115)=$$EMP^RGRSPARS($P(MSG,HL("FS"),4))
"RTN","RGADTP",207,0)
 Q
"RTN","RGADTP",208,0)
ZFF ;;
"RTN","RGADTP",209,0)
 I RGLOCAL S THLA("HLS",ENT)=MSG,ENT=ENT+1
"RTN","RGADTP",210,0)
 I 'RGLOCAL S ARRAY("FLD")=$P(MSG,HL("FS"),3)
"RTN","RGADTP",211,0)
 Q
"RTN","RGADTP",212,0)
PROCIN ;
"RTN","RGADTP",213,0)
 D PROCIN^RGADTP2(.ARRAY,.RGLOCAL,.RGER,.DFN,.HL)
"RTN","RGADTP",214,0)
 Q
"RTN","RGADTP",215,0)
GENACK ;
"RTN","RGADTP",216,0)
 N RGCNT,IEN,RG
"RTN","RGADTP",217,0)
 I $G(ARRAY("DFN"))'>0 S RGER="-1^Unknown ICN#"_$G(ARRAY("ICN"))_" and SSN#"_$G(ARRAY(.09))
"RTN","RGADTP",218,0)
 S RGCNT=1,HLA("HLA",RGCNT)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(RGER)<0:$P(RGER,"^",2,3),1:""),RGCNT=RGCNT+1
"RTN","RGADTP",219,0)
 S RGSITE=$$LKUP^XUAF4(RGSITE)
"RTN","RGADTP",220,0)
 D LINK^HLUTIL3(RGSITE,.RG) S IEN=$O(RG(0)) S HLL("LINKS",1)="^"_RG(IEN)
"RTN","RGADTP",221,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.HLRESLTA,"",.HL)
"RTN","RGADTP",222,0)
 K HLA
"RTN","RGADTP",223,0)
 Q
"RTN","RGADTP",224,0)
RSP ;
"RTN","RGADTP",225,0)
 Q
"RTN","RGADTP",226,0)
OLD() ; Return OBX segment to flag a record as "old"
"RTN","RGADTP",227,0)
 ;**59,MVI_914: New subroutine
"RTN","RGADTP",228,0)
 Q $S($D(^XTMP("MPIF OLD RECORDS",DFN))#2:"OBX"_HL("FS")_HL("FS")_"CE"_HL("FS")_"OLDER RECORD"_HL("FS")_HL("FS")_"Y",1:"")
"RTN","RGMTAUD")
0^3^B34306275^B20411525
"RTN","RGMTAUD",1,0)
RGMTAUD ;BIR/CML-MPI/PD AUDIT FILE PRINT FOR A SPECIFIED PATIENT ;20 May 2013  2:06 PM
"RTN","RGMTAUD",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**3,19,20,30,60**;30 Apr 99;Build 2
"RTN","RGMTAUD",3,0)
 ;Reference to ^DIA(2 and data derived from the AUDIT file (#1.1)
"RTN","RGMTAUD",4,0)
 ;is supported by IA #2097 and #2602.
"RTN","RGMTAUD",5,0)
 ;Reference to ^ORD(101 supported by IA #2596
"RTN","RGMTAUD",6,0)
 ;
"RTN","RGMTAUD",7,0)
 ;**60 MVI_1901 (cml) made extensive changes to accommodate the audit data for multiple subfields within the PATIENT file.
"RTN","RGMTAUD",8,0)
 ;
"RTN","RGMTAUD",9,0)
 S QFLG=1
"RTN","RGMTAUD",10,0)
BEGIN ;
"RTN","RGMTAUD",11,0)
 W !!,"This option prints information from the AUDIT file (#1.1) for a"
"RTN","RGMTAUD",12,0)
 W !,"selected patient and date range."
"RTN","RGMTAUD",13,0)
 W !!,"For the PATIENT file (#2) entry selected, the report prints the"
"RTN","RGMTAUD",14,0)
 W !,"patient name and DFN, date/time the field was edited, the user who"
"RTN","RGMTAUD",15,0)
 W !,"made the change, the field edited, the old value, and the new value."
"RTN","RGMTAUD",16,0)
 W !,"The option or protocol (if available) will also be displayed."
"RTN","RGMTAUD",17,0)
 ;
"RTN","RGMTAUD",18,0)
ASK1 ;Ask for PATIENT
"RTN","RGMTAUD",19,0)
 W !
"RTN","RGMTAUD",20,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: " D ^DIC K DIC G:Y<0 QUIT S RGDFN=+Y
"RTN","RGMTAUD",21,0)
 ;
"RTN","RGMTAUD",22,0)
DSP ;Display if audit data is available - **60 MVI_1901 (cml) new subroutine added to pick up audit data for multiple subfields
"RTN","RGMTAUD",23,0)
 S (GOT,EARLY,EARLYM)=0,EARLYDT=""
"RTN","RGMTAUD",24,0)
 S PTNM=$P(^DPT(RGDFN,0),"^")
"RTN","RGMTAUD",25,0)
 ;check top level audits
"RTN","RGMTAUD",26,0)
 S IEN=0 F  S IEN=$O(^DIA(2,"B",RGDFN,IEN)) Q:'IEN  D
"RTN","RGMTAUD",27,0)
 .I $D(^DIA(2,IEN,0)) S EDITDT=$P(^(0),"^",2),GOT=1 S:EARLY=0 EARLY=EDITDT S:EDITDT<EARLY EARLY=EDITDT
"RTN","RGMTAUD",28,0)
 ;check multiple level
"RTN","RGMTAUD",29,0)
 S DFNMULT=RGDFN_",0" F  S DFNMULT=$O(^DIA(2,"B",DFNMULT)) Q:DFNMULT=""  Q:$P(DFNMULT,",")'=RGDFN  I $D(^DIA(2,"B",DFNMULT)) D
"RTN","RGMTAUD",30,0)
 .S IEN=0 F  S IEN=$O(^DIA(2,"B",DFNMULT,IEN)) Q:'IEN  I $D(^DIA(2,IEN,0)) S EDITDT=$P(^(0),"^",2),GOT=1 S:EARLYM=0 EARLYM=EDITDT S:EDITDT<EARLYM EARLYM=EDITDT
"RTN","RGMTAUD",31,0)
 ;
"RTN","RGMTAUD",32,0)
 I 'GOT W !!,"There is no audit data available for any date for ",PTNM,"." G ASK1
"RTN","RGMTAUD",33,0)
 I EARLYM=0,EARLY>0 S EARLYDT=EARLY
"RTN","RGMTAUD",34,0)
 I EARLY=0,EARLYM>0 S EARLYDT=EARLYM
"RTN","RGMTAUD",35,0)
 I EARLY>0,EARLYM>EARLY S EARLYDT=EARLY
"RTN","RGMTAUD",36,0)
 I EARLYM>0,EARLY>EARLYM S EARLYDT=EARLYM
"RTN","RGMTAUD",37,0)
 W !!,"The earliest audit data is "_$$FMTE^XLFDT(EARLYDT)_"."
"RTN","RGMTAUD",38,0)
 ;
"RTN","RGMTAUD",39,0)
ASK2 ;Ask for Date Range
"RTN","RGMTAUD",40,0)
 I '$D(RGDFN)&($D(DFN)) S RGDFN=DFN
"RTN","RGMTAUD",41,0)
 W !!,"Enter date range for data to be included in report."
"RTN","RGMTAUD",42,0)
 K DIR,DIRUT,DTOUT,DUOUT S DIR(0)="DAO^:DT:EPX",DIR("A")="Beginning Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT
"RTN","RGMTAUD",43,0)
 S RGBDT=Y,DIR(0)="DAO^"_RGBDT_":DT:EPX",DIR("A")="Ending Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT S RGEDT=Y
"RTN","RGMTAUD",44,0)
 ;
"RTN","RGMTAUD",45,0)
DEV W !!,"The right margin for this report is 80.",!!
"RTN","RGMTAUD",46,0)
 S ZTSAVE("RGBDT")="",ZTSAVE("RGEDT")="",ZTSAVE("RGDFN")=""
"RTN","RGMTAUD",47,0)
 D EN^XUTMDEVQ("START^RGMTAUD","MPI/PD - Print AUDIT File Data for a Specific Patient",.ZTSAVE) I 'POP Q
"RTN","RGMTAUD",48,0)
 W !,"NO DEVICE SELECTED OR REPORT PRINTED!!"
"RTN","RGMTAUD",49,0)
 G QUIT
"RTN","RGMTAUD",50,0)
 ;
"RTN","RGMTAUD",51,0)
START ;
"RTN","RGMTAUD",52,0)
 K ^TMP("RGMTAUD",$J) S U="^"
"RTN","RGMTAUD",53,0)
 ;
"RTN","RGMTAUD",54,0)
LOOP ;Loop on "B" xref of the AUDIT file
"RTN","RGMTAUD",55,0)
 S STOP=RGEDT+1
"RTN","RGMTAUD",56,0)
 S IEN=0 F  S IEN=$O(^DIA(2,"B",RGDFN,IEN)) Q:'IEN  D
"RTN","RGMTAUD",57,0)
 .I $D(^DIA(2,IEN,0)) S EDITDT=$P(^(0),U,2) I EDITDT>RGBDT,EDITDT<STOP D
"RTN","RGMTAUD",58,0)
 ..S ^TMP("RGMTAUD",$J,EDITDT,IEN)=""
"RTN","RGMTAUD",59,0)
 ;
"RTN","RGMTAUD",60,0)
 ;find any audit data for audited fields that are multiples  - **60 MVI_1901 (cml)
"RTN","RGMTAUD",61,0)
 S DFNMULT=RGDFN_",0" F  S DFNMULT=$O(^DIA(2,"B",DFNMULT)) Q:DFNMULT=""  Q:$P(DFNMULT,",")'=RGDFN  I $D(^DIA(2,"B",DFNMULT)) D
"RTN","RGMTAUD",62,0)
 .S IEN=0 F  S IEN=$O(^DIA(2,"B",DFNMULT,IEN)) Q:'IEN  D
"RTN","RGMTAUD",63,0)
 ..I $D(^DIA(2,IEN,0)) S EDITDT=$P(^(0),"^",2) I EDITDT>RGBDT,EDITDT<STOP S ^TMP("RGMTAUD",$J,EDITDT,IEN)=""
"RTN","RGMTAUD",64,0)
 ; **60 MVI_1901 (cml) changes stop here
"RTN","RGMTAUD",65,0)
 ;
"RTN","RGMTAUD",66,0)
PRT ;Print report
"RTN","RGMTAUD",67,0)
 S (PG,QFLG)=0,U="^",$P(LN,"-",81)="",SITE=$P($$SITE^VASITE(),U,2)
"RTN","RGMTAUD",68,0)
 S PRGBDT=$$FMTE^XLFDT(RGBDT),PRGEDT=$$FMTE^XLFDT(RGEDT)
"RTN","RGMTAUD",69,0)
 D NOW^%DTC S HDT=$$FMTE^XLFDT($E(%,1,12))
"RTN","RGMTAUD",70,0)
 D HDR
"RTN","RGMTAUD",71,0)
 I '$O(^TMP("RGMTAUD",$J,0)) W !!,"No audit data found in this date range for this patient." G QUIT
"RTN","RGMTAUD",72,0)
 S EDITDT=0 F  S EDITDT=$O(^TMP("RGMTAUD",$J,EDITDT)) Q:QFLG  Q:'EDITDT  D
"RTN","RGMTAUD",73,0)
 .S IEN=0 F  S IEN=$O(^TMP("RGMTAUD",$J,EDITDT,IEN)) Q:QFLG  Q:'IEN  D
"RTN","RGMTAUD",74,0)
 ..S PRTDT=$$FMTE^XLFDT($E(EDITDT,1,12))
"RTN","RGMTAUD",75,0)
 ..S IEN0=^DIA(2,IEN,0)
"RTN","RGMTAUD",76,0)
 .. ;**60 MVI_1901 (cml) modified to pick up audit data for multiple subfields and check for bad DD references
"RTN","RGMTAUD",77,0)
 ..S FILE=2,FIELD=$P(IEN0,"^",3) I FIELD["," S FILE=+$P($G(^DD(2,$P(FIELD,","),0)),"^",2) Q:'FILE  S FIELD=$P(FIELD,",",2)
"RTN","RGMTAUD",78,0)
 ..K RGARR D FIELD^DID(FILE,FIELD,"","LABEL","RGARR")
"RTN","RGMTAUD",79,0)
 ..S FLD=$G(RGARR("LABEL")) Q:FLD=""
"RTN","RGMTAUD",80,0)
 .. ; **60 MVI_1901 (cml) changes stop here
"RTN","RGMTAUD",81,0)
 ..S USER=$P(IEN0,U,4)
"RTN","RGMTAUD",82,0)
 ..I 'USER S USER="UNKNOWN"
"RTN","RGMTAUD",83,0)
 ..I USER'="UNKNOWN" S DIC="^VA(200,",DIC(0)="MZO",X="`"_USER D ^DIC S USER=$P(Y,"^",2)
"RTN","RGMTAUD",84,0)
 ..S OLD=$G(^DIA(2,IEN,2)) I OLD']"" S OLD="<no previous value>"
"RTN","RGMTAUD",85,0)
 ..S NEW=$G(^DIA(2,IEN,3)) I NEW']"" S NEW="<no current value>"
"RTN","RGMTAUD",86,0)
 ..K OPTDA1,OPTDA2,RGOPTN,OPTNM I $G(^DIA(2,IEN,4.1)) D
"RTN","RGMTAUD",87,0)
 ...S OPTDA1=+$P(^DIA(2,IEN,4.1),"^")
"RTN","RGMTAUD",88,0)
 ...I OPTDA1 S DIC=19,DR=".01",DA=OPTDA1,DIQ(0)="EI",DIQ="RGOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S RGOPTN=$G(RGOPTN(19,OPTDA1,.01,"E"))
"RTN","RGMTAUD",89,0)
 ...S OPTDA2=$P(^DIA(2,IEN,4.1),"^",2)
"RTN","RGMTAUD",90,0)
 ...I $P(OPTDA2,";",2)="ORD(101," S DIC=101,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="RGOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(RGOPTN(101,+OPTDA2,.01,"E")) Q
"RTN","RGMTAUD",91,0)
 ...I +OPTDA2 S DIC=19,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="RGOPTN" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(RGOPTN(19,+OPTDA2,.01,"E")) Q
"RTN","RGMTAUD",92,0)
 ..D:$Y+4>IOSL HDR Q:QFLG  W !!,PRTDT,?20,FLD,?51,USER,!?20,OLD," / ",NEW
"RTN","RGMTAUD",93,0)
 ..I $G(RGOPTN)'="" W !?3,RGOPTN ;**20
"RTN","RGMTAUD",94,0)
 ..I $G(OPTNM)'="" W:$G(RGOPTN)="" !?3 W "/",$G(OPTNM) ;**20
"RTN","RGMTAUD",95,0)
 ;
"RTN","RGMTAUD",96,0)
QUIT ;
"RTN","RGMTAUD",97,0)
 I $E(IOST,1,2)="C-"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGMTAUD",98,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTAUD",99,0)
 K ^TMP("RGMTAUD",$J)
"RTN","RGMTAUD",100,0)
 K %,%I,DFN,RGDFN,EDITDT,FLD,HDT,IEN,IEN0,JJ,LN,NEW,OLD,OPTDA1,OPTDA2,RGOPTN,OPTNM,PG,PRGBDT,PRGEDT,PRTDT
"RTN","RGMTAUD",101,0)
 K DFNMULT,EARLY,EARLYDT,EARLYM,FIELD,FILE,GOT,PTNM,QQ,SUB   ;**60 MVI_1901 (cml)
"RTN","RGMTAUD",102,0)
 K QFLG,RGARR,RGBDT,RGEDT,SITE,SS,STOP,USER,X,Y,ZTSK
"RTN","RGMTAUD",103,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","RGMTAUD",104,0)
 ;
"RTN","RGMTAUD",105,0)
HDR ;HEADER
"RTN","RGMTAUD",106,0)
 I $E(IOST,1,2)="C-" S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTAUD",107,0)
 I $E(IOST,1,2)="C-",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","RGMTAUD",108,0)
 S PG=PG+1 W:$Y!($E(IOST,1,2)="C-") @IOF
"RTN","RGMTAUD",109,0)
 W !,"PATIENT AUDIT LIST at ",SITE," on ",HDT,?72,"Page: ",PG
"RTN","RGMTAUD",110,0)
 W !,"Patient: ",$P(^DPT(RGDFN,0),U)," (DFN #",RGDFN,")"
"RTN","RGMTAUD",111,0)
 W !,"Date Range: ",PRGBDT," to ",PRGEDT
"RTN","RGMTAUD",112,0)
 W !!,"Date/Time Edited",?20,"Field Edited",?51,"Edited By"
"RTN","RGMTAUD",113,0)
 W !?20,"Old Value / New Value",!?3,"Option/Protocol",!,LN
"RTN","RGMTAUD",114,0)
 Q
"RTN","RGMTAUDP")
0^4^B84209421^B59483224
"RTN","RGMTAUDP",1,0)
RGMTAUDP ;BIR/CML,PTD-MPI/PD AUDIT File Print of Patient Data ;20 May 2013  12:13 PM
"RTN","RGMTAUDP",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**19,30,46,60**;30 Apr 99;Build 2
"RTN","RGMTAUDP",3,0)
 ;Reference to ^DD(2 supported by IA #2695.
"RTN","RGMTAUDP",4,0)
 ;Reference to ^DIA(2 and data derived from the AUDIT file (#1.1)
"RTN","RGMTAUDP",5,0)
 ;supported by IA #2097 and #2602.
"RTN","RGMTAUDP",6,0)
 ;Reference to ^ORD(101 supported by IA #2596
"RTN","RGMTAUDP",7,0)
 ;**60 MVI_1901 (cml) made extensive changes to accommodate the audit data for multiple subfields within the PATIENT file.
"RTN","RGMTAUDP",8,0)
 ;
"RTN","RGMTAUDP",9,0)
BEGIN ;
"RTN","RGMTAUDP",10,0)
 S QFLG=1
"RTN","RGMTAUDP",11,0)
 W @IOF
"RTN","RGMTAUDP",12,0)
 W !,"This option prints a customized report of information stored in the AUDIT"
"RTN","RGMTAUDP",13,0)
 W !,"file (#1.1) for fields being audited in the PATIENT file (#2).  For a"
"RTN","RGMTAUDP",14,0)
 W !,"specified date range, you can view all audited fields or selected fields."
"RTN","RGMTAUDP",15,0)
 W !,"You can also opt to print only edits that were done by a specific user."
"RTN","RGMTAUDP",16,0)
 W !!,"- If selected fields are viewed, you can choose to see data for all or"
"RTN","RGMTAUDP",17,0)
 W !,"  selected patients."
"RTN","RGMTAUDP",18,0)
 W !,"- If ALL audited fields are viewed, you must choose patients to examine."
"RTN","RGMTAUDP",19,0)
 ;
"RTN","RGMTAUDP",20,0)
ASKFLD ;Ask for Data Fields
"RTN","RGMTAUDP",21,0)
 I '$O(^DD(2,"AUDIT",0)) W !!,"No fields are currently being audited in the PATIENT file (#2)." G QUIT
"RTN","RGMTAUDP",22,0)
 W !
"RTN","RGMTAUDP",23,0)
 K DIR S DIR(0)="SAM^A:ALL;S:SELECTED;"
"RTN","RGMTAUDP",24,0)
 S DIR("A")="Do you want to see (A)LL or (S)ELECTED audited fields? "
"RTN","RGMTAUDP",25,0)
 S DIR("B")="A"
"RTN","RGMTAUDP",26,0)
 S DIR("?",1)="Enter:"
"RTN","RGMTAUDP",27,0)
 S DIR("?",2)=" ""A"" to see ALL audited fields in the PATIENT file (#2)."
"RTN","RGMTAUDP",28,0)
 S DIR("?")=" ""S"" to select specific audited fields."
"RTN","RGMTAUDP",29,0)
 D ^DIR G:$D(DIRUT) QUIT S ANS1=Y
"RTN","RGMTAUDP",30,0)
 ;
"RTN","RGMTAUDP",31,0)
FLDLOOP ;
"RTN","RGMTAUDP",32,0)
 W ! K FLD
"RTN","RGMTAUDP",33,0)
 ;stuff all fields
"RTN","RGMTAUDP",34,0)
 I ANS1="A" D  G ASKPAT
"RTN","RGMTAUDP",35,0)
 .S FLD=0 F  S FLD=$O(^DD(2,"AUDIT",FLD)) Q:'FLD  S FLD(2,FLD)=""   ;**60 MVI_1901 (cml)
"RTN","RGMTAUDP",36,0)
 .S FILE=2 F  S FILE=$O(^DD(FILE)) Q:FILE>2.999  S FLD=0 F  S FLD=$O(^DD(FILE,"AUDIT",FLD)) Q:'FLD  S FLD(FILE,FLD)=""   ;**60 MVI_1901 (cml)
"RTN","RGMTAUDP",37,0)
 ;
"RTN","RGMTAUDP",38,0)
 ;ask for specific fields
"RTN","RGMTAUDP",39,0)
 S RGERR=0 D FLDLIST
"RTN","RGMTAUDP",40,0)
 ; **60 MVI_1901 (cml)changes start here
"RTN","RGMTAUDP",41,0)
 K DIR W !
"RTN","RGMTAUDP",42,0)
 S DIR(0)="NAO^1:"_MAX_":0^K:'$D(FLDCNT(X)) X S RGERR=1" S DIR("A")="Select list number 1-"_MAX_":  "
"RTN","RGMTAUDP",43,0)
 S DIR("?")="^D FLDLIST^RGMTAUDP"
"RTN","RGMTAUDP",44,0)
 F QQ=0:0 S RGERR=0 D ^DIR Q:$D(DIRUT)  S SEL(+Y)=""
"RTN","RGMTAUDP",45,0)
 S CNT=0 F  S CNT=$O(SEL(CNT)) Q:'CNT  S FILE=$O(FLDCNT(CNT,0)),FLDLP=$O(FLDCNT(CNT,FILE,0)),FLD(FILE,FLDLP)=""
"RTN","RGMTAUDP",46,0)
 ; **60 MVI_1901 (cml) changes stop here
"RTN","RGMTAUDP",47,0)
 ;
"RTN","RGMTAUDP",48,0)
ASKPAT ;Ask for Patient
"RTN","RGMTAUDP",49,0)
 I '$O(FLD(0))!($D(DUOUT)) S QFLG=1 G QUIT
"RTN","RGMTAUDP",50,0)
 I ANS1="A" S ANS2="S" G PATLOOP
"RTN","RGMTAUDP",51,0)
 K DIR S DIR(0)="SAM^A:ALL;S:SELECTED;"
"RTN","RGMTAUDP",52,0)
 S DIR("A")="Do you want to see audited data for (A)LL or (S)ELECTED patients? "
"RTN","RGMTAUDP",53,0)
 S DIR("B")="S"
"RTN","RGMTAUDP",54,0)
 S DIR("?",1)="Enter:"
"RTN","RGMTAUDP",55,0)
 S DIR("?",2)=" ""A"" to see audited fields for ALL patients."
"RTN","RGMTAUDP",56,0)
 S DIR("?")=" ""S"" to select specific patients(s)."
"RTN","RGMTAUDP",57,0)
 W ! D ^DIR G:$D(DIRUT) QUIT S ANS2=Y
"RTN","RGMTAUDP",58,0)
PATLOOP ;
"RTN","RGMTAUDP",59,0)
 W ! K PAT
"RTN","RGMTAUDP",60,0)
 I ANS2="A" S PAT("ALL")="" G ASKDT
"RTN","RGMTAUDP",61,0)
 ;ask for specific patient(s)
"RTN","RGMTAUDP",62,0)
 F QQ=0:0 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: " D ^DIC K DIC Q:Y<0  S RGDFN=+Y D
"RTN","RGMTAUDP",63,0)
 .I '$O(^DIA(2,"B",RGDFN,0)) W $C(7),!?5,"This patient has no audit data available for any date." Q
"RTN","RGMTAUDP",64,0)
 .S PAT(RGDFN)=""
"RTN","RGMTAUDP",65,0)
 ;
"RTN","RGMTAUDP",66,0)
ASKDT ;Ask for Date Range
"RTN","RGMTAUDP",67,0)
 I '$D(PAT)!($D(DUOUT)) S QFLG=1 G QUIT
"RTN","RGMTAUDP",68,0)
 W !!,"Enter date range for data to be included in report."
"RTN","RGMTAUDP",69,0)
 K DIR,DIRUT,DTOUT,DUOUT S DIR(0)="DAO^:DT:EPX",DIR("A")="Beginning Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT
"RTN","RGMTAUDP",70,0)
 S RGBDT=Y,DIR(0)="DAO^"_RGBDT_":DT:EPX",DIR("A")="Ending Date:  " D ^DIR K DIR G:$D(DIRUT) QUIT S RGEDT=Y
"RTN","RGMTAUDP",71,0)
 ;
"RTN","RGMTAUDP",72,0)
ASKUSER ;Ask if data is wanted only a specific user
"RTN","RGMTAUDP",73,0)
 K USERSCRN
"RTN","RGMTAUDP",74,0)
 W ! S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to find only the edits made by a specific user"
"RTN","RGMTAUDP",75,0)
 D ^DIR K DIR I +Y'=1 G DEV
"RTN","RGMTAUDP",76,0)
 ;
"RTN","RGMTAUDP",77,0)
 S DIC="^VA(200,",DIC(0)="QEAM",DIC("A")="Select USER: "
"RTN","RGMTAUDP",78,0)
 D ^DIC K DIC G:+Y<0 QUIT S USERSCRN=+Y
"RTN","RGMTAUDP",79,0)
 ;
"RTN","RGMTAUDP",80,0)
DEV W !!,"The right margin for this report is 80.",!!
"RTN","RGMTAUDP",81,0)
 I ANS2="A" S IOP="Q" W "Because you selected ALL patients, you MUST queue this report.",!!
"RTN","RGMTAUDP",82,0)
 S ZTSAVE("RGBDT")="",ZTSAVE("RGEDT")="",ZTSAVE("ANS2")="",ZTSAVE("FLD(")="",ZTSAVE("PAT(")="",%ZIS("B")=""
"RTN","RGMTAUDP",83,0)
 S ZTSAVE("USERSCRN")=""
"RTN","RGMTAUDP",84,0)
 D EN^XUTMDEVQ("START^RGMTAUDP","MPI/PD - Print AUDIT File Data from the PATIENT file",.ZTSAVE,.%ZIS) I 'POP Q
"RTN","RGMTAUDP",85,0)
 W !,"NO DEVICE SELECTED OR REPORT PRINTED!!"
"RTN","RGMTAUDP",86,0)
 S QFLG=1 G QUIT
"RTN","RGMTAUDP",87,0)
 ;
"RTN","RGMTAUDP",88,0)
START ;
"RTN","RGMTAUDP",89,0)
 K ^TMP("RGMTAUDP",$J),^TMP("RGMTAUDP2",$J) S U="^"
"RTN","RGMTAUDP",90,0)
 S STOP=RGEDT+1
"RTN","RGMTAUDP",91,0)
 I ANS2="A" D
"RTN","RGMTAUDP",92,0)
 .S CNT=0
"RTN","RGMTAUDP",93,0)
 .S RGDFN=0 F  S RGDFN=$O(^DIA(2,"B",RGDFN)) Q:'RGDFN  S CNT=CNT+1 S:'(CNT#10000) ^TMP("RGMTAUDP",$J,"@@@@","CUR DFN")=RGDFN D LOOP
"RTN","RGMTAUDP",94,0)
 I ANS2="S" D
"RTN","RGMTAUDP",95,0)
 .S RGDFN=0 F  S RGDFN=$O(PAT(RGDFN)) Q:'RGDFN  D LOOP
"RTN","RGMTAUDP",96,0)
 G PRT
"RTN","RGMTAUDP",97,0)
 ;
"RTN","RGMTAUDP",98,0)
LOOP ;Loop on "B" xref of the AUDIT file
"RTN","RGMTAUDP",99,0)
 Q:'$D(^DPT(RGDFN,0))
"RTN","RGMTAUDP",100,0)
 I ANS2="S" D
"RTN","RGMTAUDP",101,0)
 . S PATNM=$P(^DPT(RGDFN,0),U)_U_RGDFN
"RTN","RGMTAUDP",102,0)
 S IEN=0 F  S IEN=$O(^DIA(2,"B",RGDFN,IEN)) Q:'IEN  D
"RTN","RGMTAUDP",103,0)
 .I $D(^DIA(2,IEN,0)) S IEN0=(^(0)),EDITDT=$P(IEN0,U,2) I EDITDT>RGBDT,EDITDT<STOP D
"RTN","RGMTAUDP",104,0)
 ..S FLD=$P(IEN0,U,3) I $D(FLD(2,FLD)) D
"RTN","RGMTAUDP",105,0)
 ...S USER=$P(IEN0,U,4)
"RTN","RGMTAUDP",106,0)
 ...I $D(USERSCRN) I USER'=USERSCRN Q
"RTN","RGMTAUDP",107,0)
 ...S ^TMP("RGMTAUDP",$J,PATNM,EDITDT,IEN)=""
"RTN","RGMTAUDP",108,0)
 ;
"RTN","RGMTAUDP",109,0)
 ;add new FOR loop to find any audit data for audited fields that are multiples  - **60 MVI_1901 (cml)
"RTN","RGMTAUDP",110,0)
 S DFNMULT=RGDFN_",0" F  S DFNMULT=$O(^DIA(2,"B",DFNMULT)) Q:DFNMULT=""  Q:$P(DFNMULT,",")'=RGDFN  I $D(^DIA(2,"B",DFNMULT)) S IEN=0 F  S IEN=$O(^DIA(2,"B",DFNMULT,IEN)) Q:'IEN  D
"RTN","RGMTAUDP",111,0)
 .I $D(^DIA(2,IEN,0)) S IEN0=(^(0)),EDITDT=$P(^(0),U,2) I EDITDT>RGBDT,EDITDT<STOP D
"RTN","RGMTAUDP",112,0)
 ..S FLD=$P(IEN0,U,3),PC1=$P(FLD,","),PC2=$P(FLD,",",2),FILE=+$P($G(^DD(2,PC1,0)),"^",2) I FILE,$D(FLD(FILE,PC2)) D
"RTN","RGMTAUDP",113,0)
 ...S USER=$P(IEN0,U,4)
"RTN","RGMTAUDP",114,0)
 ...I $D(USERSCRN) I USER'=USERSCRN Q
"RTN","RGMTAUDP",115,0)
 ...S PATNM=$P(^DPT(RGDFN,0),U)_U_RGDFN,^TMP("RGMTAUDP",$J,PATNM,EDITDT,IEN)=""
"RTN","RGMTAUDP",116,0)
 ;
"RTN","RGMTAUDP",117,0)
 I ANS2="S" D
"RTN","RGMTAUDP",118,0)
 . I '$D(^TMP("RGMTAUDP",$J,PATNM)) S ^TMP("RGMTAUDP2",$J,"NO AUDIT",PATNM)=" has no audit data available for selected parameters."
"RTN","RGMTAUDP",119,0)
 Q
"RTN","RGMTAUDP",120,0)
 ;
"RTN","RGMTAUDP",121,0)
PRT ;Print report
"RTN","RGMTAUDP",122,0)
 S (PG,QFLG)=0,U="^",$P(LN,"-",81)="",SITE=$P($$SITE^VASITE(),U,2)
"RTN","RGMTAUDP",123,0)
 S PRGBDT=$$FMTE^XLFDT(RGBDT),PRGEDT=$$FMTE^XLFDT(RGEDT)
"RTN","RGMTAUDP",124,0)
 D NOW^%DTC S HDT=$$FMTE^XLFDT($E(%,1,12))
"RTN","RGMTAUDP",125,0)
 D HDR
"RTN","RGMTAUDP",126,0)
 I '$D(^TMP("RGMTAUDP",$J)) W !!,"No audit data found in this date range for specified parameters." G QUIT
"RTN","RGMTAUDP",127,0)
 S PATNM="@@@@" F  S PATNM=$O(^TMP("RGMTAUDP",$J,PATNM)) Q:PATNM=""  Q:QFLG  D
"RTN","RGMTAUDP",128,0)
 .D:$Y+4>IOSL HDR Q:QFLG
"RTN","RGMTAUDP",129,0)
 .W !!,"==> ",$P(PATNM,U),"  (DFN #",$P(PATNM,U,2),")"
"RTN","RGMTAUDP",130,0)
 .S EDITDT=0 F  S EDITDT=$O(^TMP("RGMTAUDP",$J,PATNM,EDITDT)) Q:QFLG  Q:'EDITDT  D
"RTN","RGMTAUDP",131,0)
 ..S IEN=0 F  S IEN=$O(^TMP("RGMTAUDP",$J,PATNM,EDITDT,IEN)) Q:QFLG  Q:'IEN  D
"RTN","RGMTAUDP",132,0)
 ...S PRTDT=$$FMTE^XLFDT($E(EDITDT,1,12))
"RTN","RGMTAUDP",133,0)
 ...S IEN0=^DIA(2,IEN,0)
"RTN","RGMTAUDP",134,0)
 ... ;**60 MVI_1901 (cml) modified to pick up audit data for multiple subfields and check for bad DD references
"RTN","RGMTAUDP",135,0)
 ...S FILE=2,FIELD=$P(IEN0,"^",3) I FIELD["," S FILE=+$P($G(^DD(2,$P(FIELD,","),0)),"^",2) Q:FILE=""  S FIELD=$P(FIELD,",",2)
"RTN","RGMTAUDP",136,0)
 ...K RGARR D FIELD^DID(FILE,FIELD,"","LABEL","RGARR")
"RTN","RGMTAUDP",137,0)
 ...S FLD=$G(RGARR("LABEL")) Q:FLD=""
"RTN","RGMTAUDP",138,0)
 ... ; **60 MVI_1901 (cml) changes stop here
"RTN","RGMTAUDP",139,0)
 ...S USER=$P(IEN0,U,4)
"RTN","RGMTAUDP",140,0)
 ...I 'USER S USER="UNKNOWN"
"RTN","RGMTAUDP",141,0)
 ...I USER'="UNKNOWN" S DIC="^VA(200,",DIC(0)="MZO",X="`"_USER D ^DIC S USER=$P(Y,"^",2)
"RTN","RGMTAUDP",142,0)
 ...S OLD=$G(^DIA(2,IEN,2)) I OLD']"" S OLD="<no previous value>"
"RTN","RGMTAUDP",143,0)
 ...S NEW=$G(^DIA(2,IEN,3)) I NEW']"" S NEW="<no current value>"
"RTN","RGMTAUDP",144,0)
 ...K OPTDA1,OPTDA2,OPTION,OPTNM I $G(^DIA(2,IEN,4.1)) D
"RTN","RGMTAUDP",145,0)
 ....S OPTDA1=+$P(^DIA(2,IEN,4.1),"^")
"RTN","RGMTAUDP",146,0)
 ....I OPTDA1 S DIC=19,DR=".01",DA=OPTDA1,DIQ(0)="EI",DIQ="OPTION" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTION=$G(OPTION(19,OPTDA1,.01,"E"))
"RTN","RGMTAUDP",147,0)
 ....S OPTDA2=$P(^DIA(2,IEN,4.1),"^",2)
"RTN","RGMTAUDP",148,0)
 ....I $P(OPTDA2,";",2)="ORD(101," S DIC=101,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="OPTION" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(OPTION(101,+OPTDA2,.01,"E")) Q
"RTN","RGMTAUDP",149,0)
 ....I +OPTDA2 S DIC=19,DR=".01",DA=+OPTDA2,DIQ(0)="EI",DIQ="OPTION" D EN^DIQ1 K DIC,DR,DA,DIQ S OPTNM=$G(OPTION(19,+OPTDA2,.01,"E")) Q
"RTN","RGMTAUDP",150,0)
 ...D:$Y+5>IOSL HDR Q:QFLG  W !!,PRTDT,?20,FLD,?51,USER,!?20,OLD," / ",NEW
"RTN","RGMTAUDP",151,0)
 ...I $G(OPTION)'="" W !?3,OPTION I $G(OPTNM)'="" W "/",OPTNM
"RTN","RGMTAUDP",152,0)
 I $D(^TMP("RGMTAUDP2",$J,"NO AUDIT")) D
"RTN","RGMTAUDP",153,0)
 . S PATNM="@@@@",RGNAUD="" F  S PATNM=$O(^TMP("RGMTAUDP2",$J,"NO AUDIT",PATNM)) Q:PATNM=""  D
"RTN","RGMTAUDP",154,0)
 .. Q:QFLG
"RTN","RGMTAUDP",155,0)
 .. S RGNAUD=$P(^TMP("RGMTAUDP2",$J,"NO AUDIT",PATNM),U)
"RTN","RGMTAUDP",156,0)
 .. W !!,"==> ",$P(PATNM,U),"  (DFN #",$P(PATNM,U,2),")"_RGNAUD
"RTN","RGMTAUDP",157,0)
 ;
"RTN","RGMTAUDP",158,0)
QUIT ;
"RTN","RGMTAUDP",159,0)
 I $E(IOST,1,2)="C-"&('QFLG) S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGMTAUDP",160,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTAUDP",161,0)
 K ^TMP("RGMTAUDP",$J),^TMP("RGMTAUDP2",$J)
"RTN","RGMTAUDP",162,0)
 K %,%I,ANS1,ANS2,CNT,RGDFN,DIR,DIRUT,DTOUT,DUOUT,EDITDT,FLD,FLDLP,FLDNM,HDR,DFNMULT,FIELD,FILE,SUB,MAX,PC1,PC2,SEL   ;**60 MVI_1901 (cml)
"RTN","RGMTAUDP",163,0)
 K HDT,IEN,IEN0,JJ,LN,NEW,OLD,OPTDA1,OPTDA2,OPTION,OPTNM,PAT,PATNM,PG,PRGBDT,PRGEDT,PRTDT,QFLG,QQ,RGARR,RGBDT,RGNAUD
"RTN","RGMTAUDP",164,0)
 K RGEDT,RGERR,SITE,SS,STOP,USER,X,Y,ZTSK
"RTN","RGMTAUDP",165,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","RGMTAUDP",166,0)
 ;
"RTN","RGMTAUDP",167,0)
HDR ;HEADER
"RTN","RGMTAUDP",168,0)
 I $E(IOST,1,2)="C-" S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTAUDP",169,0)
 I $E(IOST,1,2)="C-",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","RGMTAUDP",170,0)
 S PG=PG+1 W:$Y!($E(IOST,1,2)="C-") @IOF
"RTN","RGMTAUDP",171,0)
 W !,"PATIENT AUDIT LIST at ",SITE," on ",HDT,?72,"Page: ",PG
"RTN","RGMTAUDP",172,0)
 W !,"Date Range: ",PRGBDT," to ",PRGEDT
"RTN","RGMTAUDP",173,0)
 W !!,"Date/Time Edited",?20,"Field Edited",?51,"Edited By",!?20,"Old Value / New Value"
"RTN","RGMTAUDP",174,0)
 W !?3,"Option/Protocol",!,LN
"RTN","RGMTAUDP",175,0)
 Q
"RTN","RGMTAUDP",176,0)
 ;
"RTN","RGMTAUDP",177,0)
FLDLIST ;Help for Field # List
"RTN","RGMTAUDP",178,0)
 K RG N DIR S QFLG=0 I RGERR W $C(7)," ??"
"RTN","RGMTAUDP",179,0)
 S HDR="Select a LIST NUMBER from the audited field(s) in the PATIENT file:"
"RTN","RGMTAUDP",180,0)
 W @IOF,HDR,!
"RTN","RGMTAUDP",181,0)
 ;
"RTN","RGMTAUDP",182,0)
 ; **60 MVI_1901 (cml)changes start here
"RTN","RGMTAUDP",183,0)
 K FLD,FLDCNT
"RTN","RGMTAUDP",184,0)
 S FLD=0 F  S FLD=$O(^DD(2,"AUDIT",FLD)) Q:'FLD  S FLD(2,FLD)=""
"RTN","RGMTAUDP",185,0)
 S FILE=2 F  S FILE=$O(^DD(FILE)) Q:FILE>2.999  Q:'FILE  S FLD=0 F  S FLD=$O(^DD(FILE,"AUDIT",FLD)) Q:'FLD  S FLD(FILE,FLD)=""
"RTN","RGMTAUDP",186,0)
 I '$D(FLD) W !!,"No fields are currently being audited in the Patient file." Q
"RTN","RGMTAUDP",187,0)
 ; set up counter array
"RTN","RGMTAUDP",188,0)
 S (CNT,FILE)=0 F  S FILE=$O(FLD(FILE)) Q:'FILE  S FLDLP=0 F  S FLDLP=$O(FLD(FILE,FLDLP))  Q:'FLDLP  S CNT=CNT+1,FLDCNT(CNT,FILE,FLDLP)=""
"RTN","RGMTAUDP",189,0)
 K FLD S MAX=CNT
"RTN","RGMTAUDP",190,0)
 ;
"RTN","RGMTAUDP",191,0)
 S CNT=0 F  S CNT=$O(FLDCNT(CNT)) Q:'CNT  S FILE=0 F  S FILE=$O(FLDCNT(CNT,FILE)) Q:'FILE  S FLDLP=0 F  S FLDLP=$O(FLDCNT(CNT,FILE,FLDLP)) Q:'FLDLP  Q:QFLG  D
"RTN","RGMTAUDP",192,0)
 . ; **60 MVI_1901 (cml) changes stop here
"RTN","RGMTAUDP",193,0)
 .I $Y+6>IOSL D  Q:QFLG
"RTN","RGMTAUDP",194,0)
 ..S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","RGMTAUDP",195,0)
 ..E  W @IOF,HDR,!
"RTN","RGMTAUDP",196,0)
 .K RGARR D FIELD^DID(FILE,FLDLP,"","LABEL","RGARR")
"RTN","RGMTAUDP",197,0)
 .S FLDNM=$G(RGARR("LABEL")) Q:FLDNM=""
"RTN","RGMTAUDP",198,0)
 .W !,CNT,".   ",FILE,",",FLDLP,?17,FLDNM   ;**60 MVI_1901 (cml)
"RTN","RGMTAUDP",199,0)
 Q
"RTN","RGRPDAT")
0^1^B53927428^B52556448
"RTN","RGRPDAT",1,0)
RGRPDAT ;BAY/ALS-ROUTINE TO CALL REMOTE PDAT ;09/14/01
"RTN","RGRPDAT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**23,27,31,55,60**;30 Apr 99;Build 2
"RTN","RGRPDAT",3,0)
 ;Reference to ^DGCN(391.91 supported by IA #2911
"RTN","RGRPDAT",4,0)
 ;Reference to EN1^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",5,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",6,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","RGRPDAT",7,0)
 ;Reference to VAFC REMOTE PDAT supported by IA #3496
"RTN","RGRPDAT",8,0)
ASK ;Ask For Patient
"RTN","RGRPDAT",9,0)
 K DIRUT
"RTN","RGRPDAT",10,0)
 W !!,"Patient lookup can be done by Patient Name, SSN or by ICN.",!
"RTN","RGRPDAT",11,0)
 S DFN="",ICN=""
"RTN","RGRPDAT",12,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: ",D="SSN^AICN^B^BS^BS5"
"RTN","RGRPDAT",13,0)
 D MIX^DIC1 K DIC,D
"RTN","RGRPDAT",14,0)
 I Y<0 S REXIT=1 G QUIT
"RTN","RGRPDAT",15,0)
 S DFN=+Y
"RTN","RGRPDAT",16,0)
 S ICN=+$$GETICN^MPIF001(DFN) I ICN<1 W !,"There is no Integration Control Number assigned to this patient,",!,"no treating facilities to query." G ASK
"RTN","RGRPDAT",17,0)
 Q
"RTN","RGRPDAT",18,0)
SEND ;
"RTN","RGRPDAT",19,0)
 N TFL,X,Y,SNTDT,MPIDIR
"RTN","RGRPDAT",20,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",21,0)
 I $D(^XTMP("RGPDAT"_ICN,0)) S SNTDT=$$FMTE^XLFDT($P(^XTMP("RGPDAT"_ICN,0),"^",2)) W !,"Query last sent for this ICN on "_SNTDT,!
"RTN","RGRPDAT",22,0)
 I $P($G(TFL(0)),"^",1)=1 D
"RTN","RGRPDAT",23,0)
 . D SELTF Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",24,0)
 . W !,"Remote patient data queries will be sent to: "
"RTN","RGRPDAT",25,0)
 . S CNT=0,X=0 F  S X=$O(TFARR(X)) Q:'X  S CNT=CNT+1
"RTN","RGRPDAT",26,0)
 . I CNT>22 D D2
"RTN","RGRPDAT",27,0)
 . I CNT<23 D D1
"RTN","RGRPDAT",28,0)
 . W ! K DIR S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do you want to continue" D ^DIR S MPIDIR=+Y K DIR
"RTN","RGRPDAT",29,0)
 . I MPIDIR=1 S X=0 F  S X=$O(TFL(X)) Q:'X  D
"RTN","RGRPDAT",30,0)
 .. W !?3,"Sending Remote Query to: ",X,"  ",$P(TFL(X),"^")
"RTN","RGRPDAT",31,0)
 .. I $D(^XTMP("RGPDAT"_ICN,X)) K ^XTMP("RGPDAT"_ICN,X)
"RTN","RGRPDAT",32,0)
 .. D REQ(ICN,.TFL,X)
"RTN","RGRPDAT",33,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query will be sent."
"RTN","RGRPDAT",34,0)
 K ICNARR,X,Y,CNT,TFARR,TFL
"RTN","RGRPDAT",35,0)
 Q
"RTN","RGRPDAT",36,0)
SEND2 ;
"RTN","RGRPDAT",37,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",38,0)
 W !!,"This option sends a remote query to selected treating"
"RTN","RGRPDAT",39,0)
 W !,"facility site(s) for MPI/PD data for a patient."
"RTN","RGRPDAT",40,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",41,0)
 . D ASK
"RTN","RGRPDAT",42,0)
 . I $D(Y) D SEND
"RTN","RGRPDAT",43,0)
 K ICN,DFN
"RTN","RGRPDAT",44,0)
 Q
"RTN","RGRPDAT",45,0)
CHKSTAT ;check on the status for a given ICN or SSN
"RTN","RGRPDAT",46,0)
 N TFL,L,Y,ICNARR,STATUS,SL
"RTN","RGRPDAT",47,0)
 W !!,"Checking the status of remote patient data query.",!
"RTN","RGRPDAT",48,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",49,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",50,0)
 N FULLICN S FULLICN=$$GETICN^MPIF001(DFN) W !!,"-> For ICN "_$S(+FULLICN>0:FULLICN,1:"") ;**60 - MVI_2389 (ptd)
"RTN","RGRPDAT",51,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",52,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",53,0)
 D SELTF
"RTN","RGRPDAT",54,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",55,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",56,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",57,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",58,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",59,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",60,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",61,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",62,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",63,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")"
"RTN","RGRPDAT",64,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query sent for this patient."
"RTN","RGRPDAT",65,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","RGRPDAT",66,0)
 Q
"RTN","RGRPDAT",67,0)
CHKSTAT2 ;
"RTN","RGRPDAT",68,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",69,0)
 W !!,"This option checks the status of an existing remote patient data query."
"RTN","RGRPDAT",70,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",71,0)
 . D ASK
"RTN","RGRPDAT",72,0)
 . I $D(Y) D CHKSTAT
"RTN","RGRPDAT",73,0)
 K ICN,DFN
"RTN","RGRPDAT",74,0)
 Q
"RTN","RGRPDAT",75,0)
DISP    ;display returned PDAT queries
"RTN","RGRPDAT",76,0)
 W !!,"Display data returned from remote patient data queries."
"RTN","RGRPDAT",77,0)
 W !,"(Be sure HISTORY is enabled to capture data!)",!
"RTN","RGRPDAT",78,0)
 N TFL,L,Y,ICNARR,STATUS
"RTN","RGRPDAT",79,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",80,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",81,0)
 N FULLICN S FULLICN=$$GETICN^MPIF001(DFN) W !!,"-> For ICN "_$S(+FULLICN>0:FULLICN,1:"") ;**60 - MVI_2389 (ptd)
"RTN","RGRPDAT",82,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",83,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",84,0)
 D SELTF
"RTN","RGRPDAT",85,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",86,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",87,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",88,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",89,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",90,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",91,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",92,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",93,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",94,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")",!
"RTN","RGRPDAT",95,0)
 . D DISPLAY(ICN,$P(TFL(SL),"^",2))
"RTN","RGRPDAT",96,0)
 I '$D(TFL(0)) W !?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query exists for this patient."
"RTN","RGRPDAT",97,0)
 K ICNARR,L,SL,TFARR,TFL,STATUS,RESULT,RETURN
"RTN","RGRPDAT",98,0)
 Q
"RTN","RGRPDAT",99,0)
DISP2 ;
"RTN","RGRPDAT",100,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",101,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",102,0)
 . D ASK
"RTN","RGRPDAT",103,0)
 . I $D(Y) D DISP
"RTN","RGRPDAT",104,0)
 K ICN,DFN
"RTN","RGRPDAT",105,0)
 Q
"RTN","RGRPDAT",106,0)
DISPLAY(ICN,LOC) ;display a remote pdat report
"RTN","RGRPDAT",107,0)
 N STATUS,RETURN,RESULT,RET,R
"RTN","RGRPDAT",108,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) W !?15," - No patient data query exists for this record."
"RTN","RGRPDAT",109,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^") D
"RTN","RGRPDAT",110,0)
 . D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","RGRPDAT",111,0)
 .. D RTNDATA^XWBDRPC(.RET,RETURN(0))
"RTN","RGRPDAT",112,0)
 .. I $D(RET(0)) I RET(0)<0 W !!,"No data returned due to: "_$P(RET(0),"^",2) Q  ;**31
"RTN","RGRPDAT",113,0)
 .. I $G(RET)'="",$D(@RET) S GLO=RET F  S GLO=$Q(@GLO) Q:$QS(GLO,1)'=$J  S TXT=@GLO W !,TXT I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",114,0)
 .. S R="" F  S R=$O(RET(R)) Q:R=""  W !,RET(R) I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",115,0)
 Q
"RTN","RGRPDAT",116,0)
GETTFL(ICN,TFL) ;Check for existing Treating Facilities
"RTN","RGRPDAT",117,0)
 N LOC,HOME
"RTN","RGRPDAT",118,0)
 S HOME=$$SITE^VASITE()
"RTN","RGRPDAT",119,0)
 S TF=0 F  S TF=$O(^DGCN(391.91,"APAT",DFN,TF)) Q:'TF  D
"RTN","RGRPDAT",120,0)
 . S LOC=$$NNT^XUAF4(TF)
"RTN","RGRPDAT",121,0)
 . I $P(LOC,"^",2)'=$E($P(HOME,"^",3),1,3)&($P(LOC,"^",3)'="OTHER") D
"RTN","RGRPDAT",122,0)
 .. S TFL($P(LOC,"^",2))=LOC
"RTN","RGRPDAT",123,0)
 .. S LOC=$P(LOC,"^",2)
"RTN","RGRPDAT",124,0)
 .. D MONITOR(ICN,LOC,.RESULT)
"RTN","RGRPDAT",125,0)
 .. S $P(TFL(LOC),"^",3)=$P(RESULT(0),"^",2)
"RTN","RGRPDAT",126,0)
 I $O(TFL(0)) S TFL(0)=1
"RTN","RGRPDAT",127,0)
 K TF
"RTN","RGRPDAT",128,0)
 Q
"RTN","RGRPDAT",129,0)
SELTF ;Allow the user to select treating facilites from a list
"RTN","RGRPDAT",130,0)
 K TFARR,TFARR1
"RTN","RGRPDAT",131,0)
 S I=0 F  S I=$O(TFL(I)) Q:'I  D
"RTN","RGRPDAT",132,0)
 . S TFARR1($P(TFL(I),"^",1))=$P(TFL(I),"^",2)_"^"_$P(TFL(I),"^",1)
"RTN","RGRPDAT",133,0)
 S I="",CNT=0 F  S I=$O(TFARR1(I)) Q:I=""  D
"RTN","RGRPDAT",134,0)
 . S CNT=CNT+1 S TFARR(CNT)=TFARR1(I)
"RTN","RGRPDAT",135,0)
 I CNT=1 S Y=1 Q
"RTN","RGRPDAT",136,0)
 K DIR,Y
"RTN","RGRPDAT",137,0)
 S CNT=CNT+1,TFARR(CNT)="ALL"
"RTN","RGRPDAT",138,0)
 S DIR(0)="LA^1:"_CNT
"RTN","RGRPDAT",139,0)
 S DIR("A")="Select site(s) 1-"_(CNT-1)_" or "_CNT_" for all: "
"RTN","RGRPDAT",140,0)
 W !,"Select one or more of the following: "
"RTN","RGRPDAT",141,0)
 I CNT>22 D D2
"RTN","RGRPDAT",142,0)
 I CNT<23 D D1
"RTN","RGRPDAT",143,0)
 D ^DIR K DIR
"RTN","RGRPDAT",144,0)
 I Y<1 K TFARR,TFARR1,L,I,A,CNT Q
"RTN","RGRPDAT",145,0)
 S Y=","_Y
"RTN","RGRPDAT",146,0)
 I Y[(","_CNT_",") K TFARR(CNT),TFARR1,CNT,I Q
"RTN","RGRPDAT",147,0)
 S I=0,A="" F  S I=$O(TFARR(I)) Q:'I  I Y'[(","_I_",") S A=$P(TFARR(I),"^",1) K TFL(A) K TFARR(I)
"RTN","RGRPDAT",148,0)
 K L,I,A,TFARR(CNT),CNT,TFARR1
"RTN","RGRPDAT",149,0)
 Q
"RTN","RGRPDAT",150,0)
MONITOR(ICN,LOC,RESULT) ;
"RTN","RGRPDAT",151,0)
 N STATUS,RETURN
"RTN","RGRPDAT",152,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",153,0)
 I '$D(^XTMP("RGPDAT"_ICN,LOC,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",154,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^",1) D RPCCHK^XWB2HL7(.RESULT,RETURN(0))
"RTN","RGRPDAT",155,0)
 Q
"RTN","RGRPDAT",156,0)
REQ(ICN,TFL,LOC)        ;request a remote pdat report
"RTN","RGRPDAT",157,0)
 ;LOC - STATION# OF THE INSTITUTION file entry
"RTN","RGRPDAT",158,0)
 I +LOC>0 D EN1^XWB2HL7(.RETURN,LOC,"VAFC REMOTE PDAT",1,ICN,"")
"RTN","RGRPDAT",159,0)
 S ^XTMP("RGPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","RGRPDAT",160,0)
 S ^XTMP("RGPDAT"_ICN,LOC,0)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","RGRPDAT",161,0)
 Q
"RTN","RGRPDAT",162,0)
SENS ;Check for patient sensitivity
"RTN","RGRPDAT",163,0)
 N RESULT
"RTN","RGRPDAT",164,0)
 D PTSEC^DGSEC4(.RESULT,DFN,0,"RPC - VAFC REMOTE PDAT^Remote Patient Data Query")
"RTN","RGRPDAT",165,0)
 I RESULT(1)>0 D
"RTN","RGRPDAT",166,0)
 . I '$D(^XUSEC("DG SENSITIVITY",DUZ)) D
"RTN","RGRPDAT",167,0)
 . W !!,"PATIENT MARKED SENSITIVE."
"RTN","RGRPDAT",168,0)
 . W !,"You do not have proper security to view this record."
"RTN","RGRPDAT",169,0)
 Q
"RTN","RGRPDAT",170,0)
D1 ;
"RTN","RGRPDAT",171,0)
 S C1=1,I=0 F  S I=$O(TFARR(I)) Q:'I  D
"RTN","RGRPDAT",172,0)
 . W !,C1_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2) S C1=C1+1
"RTN","RGRPDAT",173,0)
 K C1,I
"RTN","RGRPDAT",174,0)
 Q
"RTN","RGRPDAT",175,0)
D2 ;
"RTN","RGRPDAT",176,0)
 S I2=23 F I=1:1:22 D
"RTN","RGRPDAT",177,0)
 . W !,I_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2)
"RTN","RGRPDAT",178,0)
 . I $D(TFARR(I2)) W ?41,I2_". ",?44,"("_$P(TFARR(I2),"^",1)_") "_$P(TFARR(I2),"^",2) S I2=I2+1
"RTN","RGRPDAT",179,0)
 K I,I2
"RTN","RGRPDAT",180,0)
 Q
"RTN","RGRPDAT",181,0)
QUIT ;
"RTN","RGRPDAT",182,0)
 K Y
"RTN","RGRPDAT",183,0)
 Q
"VER")
8.0^22.0
"BLD",2974,6)
^59
**END**
**END**
