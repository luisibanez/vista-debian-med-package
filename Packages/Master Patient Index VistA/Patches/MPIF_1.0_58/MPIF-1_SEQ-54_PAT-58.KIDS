EMERGENCY Released MPIF*1*58 SEQ #54
Extracted from mail message
**KIDS**:MPIF*1.0*58^

**INSTALL NAME**
MPIF*1.0*58
"BLD",3003,0)
MPIF*1.0*58^MASTER PATIENT INDEX VISTA^0^3130807^y
"BLD",3003,1,0)
^^3^3^3130731^
"BLD",3003,1,1,0)
PATIENT RECORD FLAG SUPPORT
"BLD",3003,1,2,0)
Refer to patch MPIF*1*58 in the FORUM Patch Module for a complete
"BLD",3003,1,3,0)
description.
"BLD",3003,4,0)
^9.64PA^^
"BLD",3003,6.3)
2
"BLD",3003,"ABPKG")
n
"BLD",3003,"KRN",0)
^9.67PA^779.2^20
"BLD",3003,"KRN",.4,0)
.4
"BLD",3003,"KRN",.401,0)
.401
"BLD",3003,"KRN",.402,0)
.402
"BLD",3003,"KRN",.403,0)
.403
"BLD",3003,"KRN",.5,0)
.5
"BLD",3003,"KRN",.84,0)
.84
"BLD",3003,"KRN",3.6,0)
3.6
"BLD",3003,"KRN",3.8,0)
3.8
"BLD",3003,"KRN",9.2,0)
9.2
"BLD",3003,"KRN",9.8,0)
9.8
"BLD",3003,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",3003,"KRN",9.8,"NM",1,0)
MPIFBT3^^0^B16478020
"BLD",3003,"KRN",9.8,"NM","B","MPIFBT3",1)

"BLD",3003,"KRN",19,0)
19
"BLD",3003,"KRN",19.1,0)
19.1
"BLD",3003,"KRN",101,0)
101
"BLD",3003,"KRN",409.61,0)
409.61
"BLD",3003,"KRN",771,0)
771
"BLD",3003,"KRN",779.2,0)
779.2
"BLD",3003,"KRN",870,0)
870
"BLD",3003,"KRN",8989.51,0)
8989.51
"BLD",3003,"KRN",8989.52,0)
8989.52
"BLD",3003,"KRN",8994,0)
8994
"BLD",3003,"KRN","B",.4,.4)

"BLD",3003,"KRN","B",.401,.401)

"BLD",3003,"KRN","B",.402,.402)

"BLD",3003,"KRN","B",.403,.403)

"BLD",3003,"KRN","B",.5,.5)

"BLD",3003,"KRN","B",.84,.84)

"BLD",3003,"KRN","B",3.6,3.6)

"BLD",3003,"KRN","B",3.8,3.8)

"BLD",3003,"KRN","B",9.2,9.2)

"BLD",3003,"KRN","B",9.8,9.8)

"BLD",3003,"KRN","B",19,19)

"BLD",3003,"KRN","B",19.1,19.1)

"BLD",3003,"KRN","B",101,101)

"BLD",3003,"KRN","B",409.61,409.61)

"BLD",3003,"KRN","B",771,771)

"BLD",3003,"KRN","B",779.2,779.2)

"BLD",3003,"KRN","B",870,870)

"BLD",3003,"KRN","B",8989.51,8989.51)

"BLD",3003,"KRN","B",8989.52,8989.52)

"BLD",3003,"KRN","B",8994,8994)

"BLD",3003,"QDEF")
^^^^^^^^^^YES
"BLD",3003,"QUES",0)
^9.62^^
"BLD",3003,"REQB",0)
^9.611^2^2
"BLD",3003,"REQB",1,0)
DG*5.3*864^2
"BLD",3003,"REQB",2,0)
MPIF*1.0*52^2
"BLD",3003,"REQB","B","DG*5.3*864",1)

"BLD",3003,"REQB","B","MPIF*1.0*52",2)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
58^3130807
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3130807
"PKG",282,22,1,"PAH",1,1,1,0)
PATIENT RECORD FLAG SUPPORT
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*58 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","MPIFBT3")
0^1^B16478020^B15393291
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0;MASTER PATIENT INDEX VISTA;**1,3,10,17,21,24,28,31,33,35,43,52,58**;30 Apr 99;Build 2
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;  EN1^DGPFMPI - #6002
"RTN","MPIFBT3",10,0)
 ;
"RTN","MPIFBT3",11,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",12,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",13,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",14,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",15,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",16,0)
 Q
"RTN","MPIFBT3",17,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",18,0)
 N MPIY,IEN,MPICMOR,MPICOMP S DGSENFLG=""
"RTN","MPIFBT3",19,0)
 S MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFBT3",20,0)
 D RDT^MPIFSA3(.CNTR,.HL,.ACK4)
"RTN","MPIFBT3",21,0)
 D FINDHM(PATID,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",22,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",23,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF,RESLT
"RTN","MPIFBT3",24,0)
 S MPINUM=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",25,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",26,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",27,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",28,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",29,0)
 .N DFN2 S DFN2=$O(^DPT("AICN",MPINUM,""))
"RTN","MPIFBT3",30,0)
 .D TWODFNS^MPIF002(DFN2,PATID,MPINUM)
"RTN","MPIFBT3",31,0)
 .;**52 need to trigger A28 add as if not found
"RTN","MPIFBT3",32,0)
 .S MPIFRPC=1 D A28^MPIFQ3(PATID) K MPIFRPC
"RTN","MPIFBT3",33,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",34,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",35,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",36,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",37,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",38,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",39,0)
 S MPIIPPF=""
"RTN","MPIFBT3",40,0)
 S MPIPPF=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",41,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",42,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",43,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",44,0)
 I $D(^TMP("MPIFVQQ",$J,CNTR,"TF")) D
"RTN","MPIFBT3",45,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN
"RTN","MPIFBT3",46,0)
 . S MPINTFI=0,MPINTF="",TFIEN="",TFSTRG=""
"RTN","MPIFBT3",47,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFBT3",48,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)
"RTN","MPIFBT3",49,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,MPICOMP,1))
"RTN","MPIFBT3",50,0)
 .. Q:'TFIEN
"RTN","MPIFBT3",51,0)
 .. S TFSTRG=TFIEN_"^"_$$FMDATE^HLFNC($P(MPINTF,MPICOMP,2))_"^"_$P(MPINTF,MPICOMP,3)
"RTN","MPIFBT3",52,0)
 .. D FILE^VAFCTFU(PATID,TFSTRG,1)
"RTN","MPIFBT3",53,0)
 . ;**58 MVI 2593 To trigger the Patient Record Flag process as in DGREG and DG10
"RTN","MPIFBT3",54,0)
 . N PRF S PRF=$$EN1^DGPFMPI(PATID)
"RTN","MPIFBT3",55,0)
 S RESLT=$$A24^MPIFA24B(PATID)
"RTN","MPIFBT3",56,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_PATID,PATID)
"RTN","MPIFBT3",57,0)
 K RESLT N RESLT
"RTN","MPIFBT3",58,0)
 S RESLT=$$A31^MPIFA31B(PATID)
"RTN","MPIFBT3",59,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A31 for DFN= "_PATID,PATID)
"RTN","MPIFBT3",60,0)
 K ^TMP("MPIFVQQ",$J)
"RTN","MPIFBT3",61,0)
 Q
"RTN","MPIFBT3",62,0)
FINDHM(PATID,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",63,0)
 N DIC,X,Y,NM,YTMP,MPIN,EXACT
"RTN","MPIFBT3",64,0)
 Q:'$D(^TMP("MPIFVQQ",$J,CNTR,"DATA"))
"RTN","MPIFBT3",65,0)
 ;added I to DIC(0) allow processing of sensitive patients when DUZ=0
"RTN","MPIFBT3",66,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",67,0)
 S YTMP=Y
"RTN","MPIFBT3",68,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",69,0)
 Q:YTMP=-1
"RTN","MPIFBT3",70,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",71,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",72,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",73,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",74,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",75,0)
 ;**43 ONLY EXACT MATCHES BEING RETURNED NO LONGER MAKE THESE CHECKES IN VISTA
"RTN","MPIFBT3",76,0)
 ;Q:$P(Y(0),"^",9)["P"&($P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)="")
"RTN","MPIFBT3",77,0)
 ;I $P(Y(0),"^",9)'=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3) D
"RTN","MPIFBT3",78,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",79,0)
 ;.D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",80,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",81,0)
 ;Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",82,0)
 ;D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",83,0)
 ;S MPIN=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",2)_","_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",7)
"RTN","MPIFBT3",84,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",85,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)
"RTN","MPIFBT3",86,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)
"RTN","MPIFBT3",87,0)
 ;D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",88,0)
 ; check if Last and First Match--yes-- then check if middle name vs initial
"RTN","MPIFBT3",89,0)
 ;I $P(NM,",")=$P(MPIN,",")&($P($P(MPIN,",",2)," ")=$P($P(NM,",",2)," ")) D
"RTN","MPIFBT3",90,0)
 ;.N MPIMID,NMMN S MPIMID=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",91,0)
 ;.S NMMN=$P($P(NM,",",2)," ",2)
"RTN","MPIFBT3",92,0)
 ;.I $L(NMMN)>1&($L(MPIMID)=1),($E(NMMN,1)=MPIMID) S EXACT=1
"RTN","MPIFBT3",93,0)
 ;.I $L(MPIMID)>1&($L(NMMN)=1),($E(MPIMID,1)=NMMN) S EXACT=1
"RTN","MPIFBT3",94,0)
 ;I NM'=MPIN,'$D(EXACT) D
"RTN","MPIFBT3",95,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",96,0)
 ;.D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",97,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",98,0)
 ;check to see if SEX on MPI and local site match - no exception
"RTN","MPIFBT3",99,0)
 ;I $P($G(^DPT(PATID,0)),"^",2)'=$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",11) D
"RTN","MPIFBT3",100,0)
 ;.S ^XTMP($J,"MPIF","MSHERR")="SEX MISMATCH"
"RTN","MPIFBT3",101,0)
 ;.D EXC^RGHLLOG(209,"PT on MPI "_MPIN_" has gender as "_$P($G(^TMP("MPIFVQQ",$J,CNTR,"DATA")),"^",10)_" While the Patient DFN= "_PATID_" has "_$P($G(^DPT(PATID,0)),"^",2)_" msg # "_MPIMSG_" about line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",102,0)
 ;.N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",103,0)
 ;
"RTN","MPIFBT3",104,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",105,0)
 ;N MPIDTH,VISTDTH K %DT
"RTN","MPIFBT3",106,0)
 ;I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9)'="" S X=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9) D ^%DT S MPIDTH=Y
"RTN","MPIFBT3",107,0)
 ;I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",108,0)
 ;I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",109,0)
 ;.N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",110,0)
 ;.D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",111,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",112,0)
 ;I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",113,0)
 ;.N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",114,0)
 ;.D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",115,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",116,0)
 ;I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",117,0)
 ;.N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",118,0)
 ;.D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",119,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",120,0)
 Q
"VER")
8.0^22.0
"BLD",3003,6)
^54
**END**
**END**
