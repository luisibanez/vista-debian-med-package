Released DVBA*2.7*184 SEQ #162
Extracted from mail message
**KIDS**:DVBA*2.7*184^

**INSTALL NAME**
DVBA*2.7*184
"BLD",8535,0)
DVBA*2.7*184^AUTOMATED MED INFO EXCHANGE^0^3130422^y
"BLD",8535,1,0)
^^1^1^3130115^^
"BLD",8535,1,1,0)
See full patch description on Forum for more information.
"BLD",8535,4,0)
^9.64PA^396.3^1
"BLD",8535,4,396.3,0)
396.3
"BLD",8535,4,396.3,2,0)
^9.641^396.3^1
"BLD",8535,4,396.3,2,396.3,0)
2507 REQUEST  (File-top level)
"BLD",8535,4,396.3,2,396.3,1,0)
^9.6411^9^1
"BLD",8535,4,396.3,2,396.3,1,9,0)
PRIORITY OF EXAM
"BLD",8535,4,396.3,222)
y^y^p^^^^n^^n
"BLD",8535,4,396.3,224)

"BLD",8535,4,"APDD",396.3,396.3)

"BLD",8535,4,"APDD",396.3,396.3,9)

"BLD",8535,4,"B",396.3,396.3)

"BLD",8535,6.3)
10
"BLD",8535,"ABPKG")
n
"BLD",8535,"INID")
^n
"BLD",8535,"INIT")
POST^DVBA184P
"BLD",8535,"KRN",0)
^9.67PA^779.2^20
"BLD",8535,"KRN",.4,0)
.4
"BLD",8535,"KRN",.401,0)
.401
"BLD",8535,"KRN",.402,0)
.402
"BLD",8535,"KRN",.403,0)
.403
"BLD",8535,"KRN",.5,0)
.5
"BLD",8535,"KRN",.84,0)
.84
"BLD",8535,"KRN",3.6,0)
3.6
"BLD",8535,"KRN",3.8,0)
3.8
"BLD",8535,"KRN",9.2,0)
9.2
"BLD",8535,"KRN",9.8,0)
9.8
"BLD",8535,"KRN",9.8,"NM",0)
^9.68A^22^22
"BLD",8535,"KRN",9.8,"NM",1,0)
DVBCADEX^^0^B8221294
"BLD",8535,"KRN",9.8,"NM",2,0)
DVBCBULL^^0^B19523211
"BLD",8535,"KRN",9.8,"NM",3,0)
DVBCBUL1^^0^B10399602
"BLD",8535,"KRN",9.8,"NM",4,0)
DVBCCNCL^^0^B27121636
"BLD",8535,"KRN",9.8,"NM",5,0)
DVBCXFRE^^0^B25183514
"BLD",8535,"KRN",9.8,"NM",6,0)
DVBA184P^^0^B18867566
"BLD",8535,"KRN",9.8,"NM",7,0)
DVBAB2^^0^B31951617
"BLD",8535,"KRN",9.8,"NM",8,0)
DVBAB3^^0^B9998262
"BLD",8535,"KRN",9.8,"NM",9,0)
DVBAB82^^0^B116645006
"BLD",8535,"KRN",9.8,"NM",10,0)
DVBCAMIS^^0^B14811175
"BLD",8535,"KRN",9.8,"NM",11,0)
DVBCAMI1^^0^B11567744
"BLD",8535,"KRN",9.8,"NM",12,0)
DVBCAMI2^^0^B37457231
"BLD",8535,"KRN",9.8,"NM",13,0)
DVBCAMI3^^0^B5656228
"BLD",8535,"KRN",9.8,"NM",14,0)
DVBCAMRO^^0^B10848195
"BLD",8535,"KRN",9.8,"NM",15,0)
DVBCAMR1^^0^B5142050
"BLD",8535,"KRN",9.8,"NM",16,0)
DVBCAMR2^^0^B35907185
"BLD",8535,"KRN",9.8,"NM",17,0)
DVBCHS1^^0^B5171006
"BLD",8535,"KRN",9.8,"NM",18,0)
DVBCIRPT^^0^B48144132
"BLD",8535,"KRN",9.8,"NM",19,0)
DVBCIRP1^^0^B47449535
"BLD",8535,"KRN",9.8,"NM",20,0)
DVBCIUTL^^0^B37112339
"BLD",8535,"KRN",9.8,"NM",21,0)
DVBAVRX1^^0^B93466397
"BLD",8535,"KRN",9.8,"NM",22,0)
DVBCUTIL^^0^B46287055
"BLD",8535,"KRN",9.8,"NM","B","DVBA184P",6)

"BLD",8535,"KRN",9.8,"NM","B","DVBAB2",7)

"BLD",8535,"KRN",9.8,"NM","B","DVBAB3",8)

"BLD",8535,"KRN",9.8,"NM","B","DVBAB82",9)

"BLD",8535,"KRN",9.8,"NM","B","DVBAVRX1",21)

"BLD",8535,"KRN",9.8,"NM","B","DVBCADEX",1)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMI1",11)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMI2",12)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMI3",13)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMIS",10)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMR1",15)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMR2",16)

"BLD",8535,"KRN",9.8,"NM","B","DVBCAMRO",14)

"BLD",8535,"KRN",9.8,"NM","B","DVBCBUL1",3)

"BLD",8535,"KRN",9.8,"NM","B","DVBCBULL",2)

"BLD",8535,"KRN",9.8,"NM","B","DVBCCNCL",4)

"BLD",8535,"KRN",9.8,"NM","B","DVBCHS1",17)

"BLD",8535,"KRN",9.8,"NM","B","DVBCIRP1",19)

"BLD",8535,"KRN",9.8,"NM","B","DVBCIRPT",18)

"BLD",8535,"KRN",9.8,"NM","B","DVBCIUTL",20)

"BLD",8535,"KRN",9.8,"NM","B","DVBCUTIL",22)

"BLD",8535,"KRN",9.8,"NM","B","DVBCXFRE",5)

"BLD",8535,"KRN",19,0)
19
"BLD",8535,"KRN",19.1,0)
19.1
"BLD",8535,"KRN",19.1,"NM",0)
^9.68A^1^1
"BLD",8535,"KRN",19.1,"NM",1,0)
DVBA VVA HOSPITAL ROLE^^0
"BLD",8535,"KRN",19.1,"NM","B","DVBA VVA HOSPITAL ROLE",1)

"BLD",8535,"KRN",101,0)
101
"BLD",8535,"KRN",409.61,0)
409.61
"BLD",8535,"KRN",771,0)
771
"BLD",8535,"KRN",779.2,0)
779.2
"BLD",8535,"KRN",870,0)
870
"BLD",8535,"KRN",8989.51,0)
8989.51
"BLD",8535,"KRN",8989.52,0)
8989.52
"BLD",8535,"KRN",8994,0)
8994
"BLD",8535,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",8535,"KRN",8994,"NM",1,0)
DVBAB AMIS REPORT^^0
"BLD",8535,"KRN",8994,"NM","B","DVBAB AMIS REPORT",1)

"BLD",8535,"KRN","B",.4,.4)

"BLD",8535,"KRN","B",.401,.401)

"BLD",8535,"KRN","B",.402,.402)

"BLD",8535,"KRN","B",.403,.403)

"BLD",8535,"KRN","B",.5,.5)

"BLD",8535,"KRN","B",.84,.84)

"BLD",8535,"KRN","B",3.6,3.6)

"BLD",8535,"KRN","B",3.8,3.8)

"BLD",8535,"KRN","B",9.2,9.2)

"BLD",8535,"KRN","B",9.8,9.8)

"BLD",8535,"KRN","B",19,19)

"BLD",8535,"KRN","B",19.1,19.1)

"BLD",8535,"KRN","B",101,101)

"BLD",8535,"KRN","B",409.61,409.61)

"BLD",8535,"KRN","B",771,771)

"BLD",8535,"KRN","B",779.2,779.2)

"BLD",8535,"KRN","B",870,870)

"BLD",8535,"KRN","B",8989.51,8989.51)

"BLD",8535,"KRN","B",8989.52,8989.52)

"BLD",8535,"KRN","B",8994,8994)

"BLD",8535,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8535,"QUES",0)
^9.62^^
"BLD",8535,"REQB",0)
^9.611^4^4
"BLD",8535,"REQB",1,0)
DVBA*2.7*181^2
"BLD",8535,"REQB",2,0)
DVBA*2.7*10^2
"BLD",8535,"REQB",3,0)
DVBA*2.7*102^2
"BLD",8535,"REQB",4,0)
DVBA*2.7*149^2
"BLD",8535,"REQB","B","DVBA*2.7*10",2)

"BLD",8535,"REQB","B","DVBA*2.7*102",3)

"BLD",8535,"REQB","B","DVBA*2.7*149",4)

"BLD",8535,"REQB","B","DVBA*2.7*181",1)

"FIA",396.3)
2507 REQUEST
"FIA",396.3,0)
^DVB(396.3,
"FIA",396.3,0,0)
396.3IP
"FIA",396.3,0,1)
y^y^p^^^^n^^n
"FIA",396.3,0,10)

"FIA",396.3,0,11)

"FIA",396.3,0,"RLRO")

"FIA",396.3,0,"VR")
2.7^DVBA
"FIA",396.3,396.3)
1
"FIA",396.3,396.3,9)

"INIT")
POST^DVBA184P
"KRN",19.1,600,-1)
0^1
"KRN",19.1,600,0)
DVBA VVA HOSPITAL ROLE^VIRTUAL VA HOSPITAL ROLE
"KRN",19.1,600,1,0)
^19.11^3^3^3121120^^^^
"KRN",19.1,600,1,1,0)
Assignment of this security key permits CAPRI Virtual VA users to access 
"KRN",19.1,600,1,2,0)
all documents marked as Restricted with the exception of documents marked
"KRN",19.1,600,1,3,0)
with a Restricted Reason of Principle Guardianship Folder (PGF).
"KRN",8994,747,-1)
0^1
"KRN",8994,747,0)
DVBAB AMIS REPORT^STRT^DVBAB3^2^R^0^^0
"KRN",8994,747,1,0)
^8994.01^1^1^3121217^^^^
"KRN",8994,747,1,1,0)
Returns an AMIS report for specified search criteria.
"KRN",8994,747,2,0)
^8994.02A^6^6
"KRN",8994,747,2,1,0)
BDATE^1^^1^1
"KRN",8994,747,2,1,1,0)
^^2^2^3101019^
"KRN",8994,747,2,1,1,1,0)
Beginning date in a date range to use for retrieving results for the 
"KRN",8994,747,2,1,1,2,0)
report.
"KRN",8994,747,2,2,0)
EDATE^1^^1^2
"KRN",8994,747,2,2,1,0)
^^1^1^3101019^
"KRN",8994,747,2,2,1,1,0)
Ending date in a date range to use for retrieving results for the report.
"KRN",8994,747,2,3,0)
RONUM^1^^0^3
"KRN",8994,747,2,3,1,0)
^^12^12^3101019^
"KRN",8994,747,2,3,1,1,0)
This is an optional parameter that has 2 optional pieces: 
"KRN",8994,747,2,3,1,2,0)
     REGIONAL OFFICE^DIVISION
"KRN",8994,747,2,3,1,3,0)
If this parameter is defined, then the report logic will filter the 
"KRN",8994,747,2,3,1,4,0)
results by the Regional Office number passed and/or Division.
"KRN",8994,747,2,3,1,5,0)
 
"KRN",8994,747,2,3,1,6,0)
Regional Office should always be included in the 1st '^' delimited piece 
"KRN",8994,747,2,3,1,7,0)
and the Division should always be included in the 2nd '^' delimited piece 
"KRN",8994,747,2,3,1,8,0)
if values are to be passed.
"KRN",8994,747,2,3,1,9,0)
 
"KRN",8994,747,2,3,1,10,0)
If the 1st '^' delimited piece is undefined, null or 0 then results for 
"KRN",8994,747,2,3,1,11,0)
all Regional Offices (RO) will be returned. If Division is undefined, 
"KRN",8994,747,2,3,1,12,0)
null or 0, then results for all Divisions will be returned.
"KRN",8994,747,2,4,0)
SBULL^1^^1^4
"KRN",8994,747,2,4,1,0)
^^2^2^3101019^
"KRN",8994,747,2,4,1,1,0)
A Y/N value which indicates whether a bulletin should be generated when 
"KRN",8994,747,2,4,1,2,0)
the processing has completed.
"KRN",8994,747,2,5,0)
DUZ^1^^1^5
"KRN",8994,747,2,5,1,0)
^^2^2^3101019^
"KRN",8994,747,2,5,1,1,0)
Identifies the individual in the NEW PERSON File (#200) who should 
"KRN",8994,747,2,5,1,2,0)
recieve the bulletin generated.
"KRN",8994,747,2,6,0)
DVBAPRTY^1^4^1^6
"KRN",8994,747,2,6,1,0)
^^5^5^3121217^
"KRN",8994,747,2,6,1,1,0)
Priority of Exam code which inidicates which priorities to filter on.
"KRN",8994,747,2,6,1,2,0)
   AO   : Agent Orange
"KRN",8994,747,2,6,1,3,0)
   BDD  : Benefits Delivery at Discharge and Quick Start
"KRN",8994,747,2,6,1,4,0)
   IDES : Integrated Disability Evaluation System
"KRN",8994,747,2,6,1,5,0)
   ALL  : All Others (Original Report with all codes except those above)
"KRN",8994,747,2,"B","BDATE",1)

"KRN",8994,747,2,"B","DUZ",5)

"KRN",8994,747,2,"B","DVBAPRTY",6)

"KRN",8994,747,2,"B","EDATE",2)

"KRN",8994,747,2,"B","RONUM",3)

"KRN",8994,747,2,"B","SBULL",4)

"KRN",8994,747,2,"PARAMSEQ",1,1)

"KRN",8994,747,2,"PARAMSEQ",2,2)

"KRN",8994,747,2,"PARAMSEQ",3,3)

"KRN",8994,747,2,"PARAMSEQ",4,4)

"KRN",8994,747,2,"PARAMSEQ",5,5)

"KRN",8994,747,2,"PARAMSEQ",6,6)

"MBREQ")
0
"ORD",3,19.1)
19.1;3;;;KEY^XPDTA1;KEYF1^XPDIA1;KEYE1^XPDIA1;KEYF2^XPDIA1;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"PKG",223,-1)
1^1
"PKG",223,0)
AUTOMATED MED INFO EXCHANGE^DVBA^The entire AMIE package 7131/2507.
"PKG",223,20,0)
^9.402P^^
"PKG",223,22,0)
^9.49I^1^1
"PKG",223,22,1,0)
2.7^2950410^3010328
"PKG",223,22,1,"PAH",1,0)
184^3130422
"PKG",223,22,1,"PAH",1,1,0)
^^1^1^3130422
"PKG",223,22,1,"PAH",1,1,1,0)
See full patch description on Forum for more information.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
22
"RTN","DVBA184P")
0^6^B18867566^n/a
"RTN","DVBA184P",1,0)
DVBA184P ;ALB/GAK - PATCH DVBA*2.7*184 POST-INSTALL ;11/26/2012
"RTN","DVBA184P",2,0)
 ;;2.7;AMIE;**184**;Apr 10, 1995;Build 10
"RTN","DVBA184P",3,0)
 ;
"RTN","DVBA184P",4,0)
 Q  ;NO DIRECT ENTRY
"RTN","DVBA184P",5,0)
 ;
"RTN","DVBA184P",6,0)
ENV ;Main entry point for Environment check point.
"RTN","DVBA184P",7,0)
 ;
"RTN","DVBA184P",8,0)
 Q
"RTN","DVBA184P",9,0)
 ;
"RTN","DVBA184P",10,0)
 ;
"RTN","DVBA184P",11,0)
PRE ;Main entry point for Pre-init items.
"RTN","DVBA184P",12,0)
 ;
"RTN","DVBA184P",13,0)
 Q
"RTN","DVBA184P",14,0)
 ;
"RTN","DVBA184P",15,0)
 ;
"RTN","DVBA184P",16,0)
POST ;Main entry point for Post-init items.
"RTN","DVBA184P",17,0)
 ;
"RTN","DVBA184P",18,0)
 D POST1  ;Convert to IDES codes (#396.3, #9) and X-Ref
"RTN","DVBA184P",19,0)
 ;
"RTN","DVBA184P",20,0)
 Q
"RTN","DVBA184P",21,0)
 ;
"RTN","DVBA184P",22,0)
 ;
"RTN","DVBA184P",23,0)
POST1 ;Set up TaskMan to convert Priority Of Exam codes DCS and DFD to IDES in the background
"RTN","DVBA184P",24,0)
 N ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK
"RTN","DVBA184P",25,0)
 S ZTRTN="SETIDES^DVBA184P"
"RTN","DVBA184P",26,0)
 S ZTDESC="Convert Priority Of Exam codes DCS and DFD to IDES for DVBA*2.7*184"
"RTN","DVBA184P",27,0)
 ;Queue Task to start in 60 seconds
"RTN","DVBA184P",28,0)
 S ZTDTH=$$SCH^XLFDT("60S",$$NOW^XLFDT)
"RTN","DVBA184P",29,0)
 S ZTIO=""
"RTN","DVBA184P",30,0)
 D ^%ZTLOAD
"RTN","DVBA184P",31,0)
 D BMES^XPDUTL("*****")
"RTN","DVBA184P",32,0)
 D
"RTN","DVBA184P",33,0)
 . I $D(ZTSK)[0 D  Q
"RTN","DVBA184P",34,0)
 . .D MES^XPDUTL("TaskMan run to convert Priority Of Exam codes DCS and DFD to IDES was not started.")
"RTN","DVBA184P",35,0)
 . .D MES^XPDUTL("Re-run Post Install routine POST1^DVBA179P.")
"RTN","DVBA184P",36,0)
 . D MES^XPDUTL("Task "_ZTSK_" started to populate new Date field.")
"RTN","DVBA184P",37,0)
 . I $D(ZTSK("D")) D
"RTN","DVBA184P",38,0)
 . . D MES^XPDUTL("Task will start at "_$$HTE^XLFDT(ZTSK("D")))
"RTN","DVBA184P",39,0)
 D MES^XPDUTL("*****")
"RTN","DVBA184P",40,0)
 ;
"RTN","DVBA184P",41,0)
 Q
"RTN","DVBA184P",42,0)
 ;
"RTN","DVBA184P",43,0)
 ;
"RTN","DVBA184P",44,0)
SETIDES ;Convert Priority Of Exam codes DCS and DFD to IDES
"RTN","DVBA184P",45,0)
 ;
"RTN","DVBA184P",46,0)
 D MES^XPDUTL("Converting file 396.3 field 9 priority of exam codes DCS and DFD to IDES.")
"RTN","DVBA184P",47,0)
 D MES^XPDUTL("Updating cross-reference 'ADP2' of file 396.3 to reflect conversion to IDES priority of exam code.")
"RTN","DVBA184P",48,0)
 N DVBAFDA,DVBSTART,DVBMESS,DVBQUIT
"RTN","DVBA184P",49,0)
 N POE,XIEN,XERR,DVBCTR,DVBECTR
"RTN","DVBA184P",50,0)
 S DVBSTART=$$NOW^XLFDT()
"RTN","DVBA184P",51,0)
 S DVBCTR=0,DVBECTR=0,DVBQUIT=0
"RTN","DVBA184P",52,0)
 S XIEN=0
"RTN","DVBA184P",53,0)
 F  S XIEN=$O(^DVB(396.3,XIEN)) Q:XIEN=""!('XIEN)!(DVBQUIT=1)  D
"RTN","DVBA184P",54,0)
 . Q:'$D(^DVB(396.3,XIEN,0))
"RTN","DVBA184P",55,0)
 . S POE=$$GET1^DIQ(396.3,XIEN_",",9,"I","","XERR")
"RTN","DVBA184P",56,0)
 . I POE="DCS"!(POE="DFD") D
"RTN","DVBA184P",57,0)
 .. K DVBAFDA,XERR
"RTN","DVBA184P",58,0)
 .. S DVBAFDA(396.3,XIEN_",",9)="IDES"
"RTN","DVBA184P",59,0)
 .. D FILE^DIE("","DVBAFDA","XERR")
"RTN","DVBA184P",60,0)
 .. I $G(XERR)'="" D MES^XPDUTL("POST INSTALL ERROR: FILE 396.3 IEN: "_XIEN_" HAS ISSUE: "_XERR) S DVBECTR=DVBECTR+1 Q
"RTN","DVBA184P",61,0)
 .. D MES^XPDUTL("Converted FILE 396.3 IEN: "_XIEN_" POE: "_POE_" to IDES")
"RTN","DVBA184P",62,0)
 .. S DVBCTR=DVBCTR+1
"RTN","DVBA184P",63,0)
 . ;
"RTN","DVBA184P",64,0)
 . I $$S^%ZTLOAD D  Q  ;check for task stop request
"RTN","DVBA184P",65,0)
 .. S DVBMESS=2
"RTN","DVBA184P",66,0)
 .. S DVBMESS(1)="Patch DVBA*2.7*184 Converting Priority Of Exam Task Stopped by User"
"RTN","DVBA184P",67,0)
 .. S DVBMESS(2)="Re-run Post Install routine POST2^DVBA179P."
"RTN","DVBA184P",68,0)
 .. S (ZTSTOP,DVBQUIT)=1
"RTN","DVBA184P",69,0)
 ;
"RTN","DVBA184P",70,0)
 I DVBCTR=0 D MES^XPDUTL("I DID NOT FIND ANY PRIORITY OF EXAM CODES OF DCS OR DFD TO CONVERT")
"RTN","DVBA184P",71,0)
 D MES^XPDUTL("FILE 396.3 conversion to IDES count: "_DVBCTR)
"RTN","DVBA184P",72,0)
 D MES^XPDUTL("FILE 396.3 conversion to IDES error count: "_DVBECTR)
"RTN","DVBA184P",73,0)
 ;
"RTN","DVBA184P",74,0)
 D NOTIFY(DVBSTART,DVBCTR,DVBECTR,.DVBMESS)
"RTN","DVBA184P",75,0)
 ;
"RTN","DVBA184P",76,0)
 Q
"RTN","DVBA184P",77,0)
 ;
"RTN","DVBA184P",78,0)
 ;
"RTN","DVBA184P",79,0)
NOTIFY(DVBSTIME,DVBCTR,DVBECTR,DVBMESS) ;send job msg
"RTN","DVBA184P",80,0)
 ;
"RTN","DVBA184P",81,0)
 ;  Input
"RTN","DVBA184P",82,0)
 ;
"RTN","DVBA184P",83,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY,XMZ
"RTN","DVBA184P",84,0)
 N DVBSITE,DVBETIME,DVBTEXT,DVBI,SUBCTR
"RTN","DVBA184P",85,0)
 S DVBSITE=$$SITE^VASITE
"RTN","DVBA184P",86,0)
 S DVBETIME=$$NOW^XLFDT
"RTN","DVBA184P",87,0)
 S XMDUZ="Convert Priority Of Exam codes DCS and DFD to IDES"
"RTN","DVBA184P",88,0)
 S XMSUB="Patch DVBA*2.7*184"
"RTN","DVBA184P",89,0)
 S XMTEXT="DVBTEXT("
"RTN","DVBA184P",90,0)
 S XMY(DUZ)=""
"RTN","DVBA184P",91,0)
 S DVBTEXT(1)=""
"RTN","DVBA184P",92,0)
 S DVBTEXT(2)="          Facility Name:  "_$P(DVBSITE,U,2)
"RTN","DVBA184P",93,0)
 S DVBTEXT(3)="         Station Number:  "_$P(DVBSITE,U,3)
"RTN","DVBA184P",94,0)
 S DVBTEXT(4)=""
"RTN","DVBA184P",95,0)
 S DVBTEXT(5)="  Date/Time job started:  "_$$FMTE^XLFDT(DVBSTIME)
"RTN","DVBA184P",96,0)
 S DVBTEXT(6)="  Date/Time job stopped:  "_$$FMTE^XLFDT(DVBETIME)
"RTN","DVBA184P",97,0)
 S DVBTEXT(7)=""
"RTN","DVBA184P",98,0)
 I $G(DVBMESS) D
"RTN","DVBA184P",99,0)
 . F DVBI=1:1:DVBMESS D
"RTN","DVBA184P",100,0)
 .. S SUBCTR=7_"."_DVBI
"RTN","DVBA184P",101,0)
 .. S DVBTEXT(SUBCTR)="*** "_$E($G(DVBMESS(DVBI)),1,70)
"RTN","DVBA184P",102,0)
 I '$G(DVBMESS) D
"RTN","DVBA184P",103,0)
 . S DVBTEXT(8)="PRIORITY OF EXAM (#9) Field Conversion Complete"
"RTN","DVBA184P",104,0)
 . S DVBTEXT(9)="Total 2507 REQUEST (#396.3) Records Updated: "_DVBCTR
"RTN","DVBA184P",105,0)
 D ^XMD
"RTN","DVBA184P",106,0)
 ;
"RTN","DVBA184P",107,0)
 Q
"RTN","DVBAB2")
0^7^B31951617^B32023164
"RTN","DVBAB2",1,0)
DVBAB2 ;ALB/KLB - CAPRI RO AMIS REPORT CONT. ;05/01/00
"RTN","DVBAB2",2,0)
 ;;2.7;AMIE;**35,42,149,184**;Apr 10, 1995;Build 10
"RTN","DVBAB2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBAB2",4,0)
 ;
"RTN","DVBAB2",5,0)
DAY30 ;exam completion
"RTN","DVBAB2",6,0)
 N DVBADTS,DVBAPPTS,DVBACNT,DVBADTM,DVBANDE,X,X1,X2
"RTN","DVBAB2",7,0)
 K ^TMP("DVBC",$J),^TMP($J,"SDAMA301")
"RTN","DVBAB2",8,0)
 ;DES Type exams required to be completed in 45 days, all others 30
"RTN","DVBAB2",9,0)
 S DVBADTS=$S(((";IDES;")[(";"_DVBAPREXM_";")):45,1:30)
"RTN","DVBAB2",10,0)
 ;setup call to scheduling API
"RTN","DVBAB2",11,0)
 S DVBAPPTS(1)=DTRPT_";"_EDATE,DVBAPPTS(4)=PNAM,DVBAPPTS(3)="R;I;NT"
"RTN","DVBAB2",12,0)
 S DVBAPPTS("SORT")="P",DVBAPPTS("FLDS")="10"
"RTN","DVBAB2",13,0)
 S DVBACNT=$$SDAPI^SDAMA301(.DVBAPPTS)
"RTN","DVBAB2",14,0)
 I (DVBACNT'>0) K ^TMP($J,"SDAMA301") Q
"RTN","DVBAB2",15,0)
 S DVBADTM=""
"RTN","DVBAB2",16,0)
 F  S DVBADTM=$O(^TMP($J,"SDAMA301",PNAM,DVBADTM)) Q:('+DVBADTM)  D
"RTN","DVBAB2",17,0)
 .S ^TMP("DVBC",$J,9999999-DVBADTM,DVBADTM)=""
"RTN","DVBAB2",18,0)
 S DVBANDE=$O(^TMP("DVBC",$J,0)),DVBADTM=$O(^TMP("DVBC",$J,DVBANDE,0))
"RTN","DVBAB2",19,0)
 D:(DVBADTM]"")
"RTN","DVBAB2",20,0)
 .S X2=DVBADTM,X1=$S(DTSCHEDC]"":DTSCHEDC,1:DVBCNOW)
"RTN","DVBAB2",21,0)
 .D ^%DTC  ;calculate date diff
"RTN","DVBAB2",22,0)
 .S:(X>DVBADTS) TOT(DVBAPREXM,"30DAYEX")=TOT(DVBAPREXM,"30DAYEX")+1
"RTN","DVBAB2",23,0)
 K ^TMP($J,"SDAMA301")
"RTN","DVBAB2",24,0)
 Q
"RTN","DVBAB2",25,0)
 ;
"RTN","DVBAB2",26,0)
PENDCNT I X'<0&(X'>90) S TOT(DVBAPREXM,"P90")=TOT(DVBAPREXM,"P90")+1
"RTN","DVBAB2",27,0)
 I X>90&(X'>120) S TOT(DVBAPREXM,"P121")=TOT(DVBAPREXM,"P121")+1
"RTN","DVBAB2",28,0)
 I X>120&(X'>150) S TOT(DVBAPREXM,"P151")=TOT(DVBAPREXM,"P151")+1
"RTN","DVBAB2",29,0)
 I X>150&(X'>180) S TOT(DVBAPREXM,"P181")=TOT(DVBAPREXM,"P181")+1
"RTN","DVBAB2",30,0)
 I X>180&(X'>365) S TOT(DVBAPREXM,"P365")=TOT(DVBAPREXM,"P365")+1
"RTN","DVBAB2",31,0)
 I X>365 S TOT(DVBAPREXM,"P366")=TOT(DVBAPREXM,"P366")+1
"RTN","DVBAB2",32,0)
 Q
"RTN","DVBAB2",33,0)
 ;
"RTN","DVBAB2",34,0)
SET ;
"RTN","DVBAB2",35,0)
 N DVBAPREXM
"RTN","DVBAB2",36,0)
 S DTA=^DVB(396.3,REQDA,0),DTREQ=$P(DTA,U,2),XRONUM=$P(DTA,U,3),XRONUM=$S($D(^DIC(4,+XRONUM,99)):$P(^(99),U,1),1:0) Q:XRONUM'=RONUM&(RONUM'="ALL")
"RTN","DVBAB2",37,0)
 ; Next 2 lines check for specific division  SPH/ALB - 9/3/02
"RTN","DVBAB2",38,0)
 I DVBDIV'="" I '$D(^DVB(396.3,REQDA,1)) Q
"RTN","DVBAB2",39,0)
 I DVBDIV'="" I $P(^DVB(396.3,REQDA,1),"^",4)'=DVBDIV Q
"RTN","DVBAB2",40,0)
 K XRONUM S DTRPT=$P(DTA,U,5),DTSCHEDC=$P(DTA,U,6),DTRQCMP=$P(DTA,U,7),DTTRANS=$P(DTA,U,12),DTREL=$P(DTA,U,14),RQSTAT=$P(DTA,U,18),DTCAN=$P(DTA,U,19),PRIO=$P(DTA,U,10) K DTA
"RTN","DVBAB2",41,0)
 I DTRPT="",DTCAN]"" S DTRPT=DTCAN
"RTN","DVBAB2",42,0)
 Q:DTRPT=""  ;requests never printed
"RTN","DVBAB2",43,0)
 ;check for Parent Request (retrieve current/parent Priority of Exam)
"RTN","DVBAB2",44,0)
 S DVBAPREXM=$$CHKREQ^DVBCIRP1(REQDA)
"RTN","DVBAB2",45,0)
 ;original report run (Exclude new priorities)
"RTN","DVBAB2",46,0)
 Q:((DVBAEXMP']"")&((";BDD;QS;IDES;AO;")[(";"_DVBAPREXM_";")))
"RTN","DVBAB2",47,0)
 ;report for specific priority
"RTN","DVBAB2",48,0)
 Q:((DVBAEXMP]"")&(DVBAEXMP'[(";"_DVBAPREXM_";")))
"RTN","DVBAB2",49,0)
 S:(DVBAEXMP']"") DVBAPREXM="ALL"  ;identifier for totals
"RTN","DVBAB2",50,0)
 I DTREL'<BDATE,DTREL'>EDATE D DAY30
"RTN","DVBAB2",51,0)
 I DTRPT'<BDATE,DTRPT'>EDATE S TOT(DVBAPREXM,"SENT")=TOT(DVBAPREXM,"SENT")+1
"RTN","DVBAB2",52,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,RQSTAT'["X" S X1=$S(DTSCHEDC]"":DTSCHEDC,1:DVBCNOW),X2=DTRPT D ^%DTC I X>3 S TOT(DVBAPREXM,"3DAYSCH")=TOT(DVBAPREXM,"3DAYSCH")+1
"RTN","DVBAB2",53,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT="C"!(RQSTAT="R") S:PRIO'="E" DVBCPCTM=$$PROCDAY^DVBCUTL2(REQDA) S:PRIO="E" DVBCPCTM=$$INSFTME^DVBCUTA1(REQDA) S TOT(DVBAPREXM,"DAYS")=TOT(DVBAPREXM,"DAYS")+DVBCPCTM K DVBCPCTM
"RTN","DVBAB2",54,0)
 I DTRPT'>EDATE,"^P^S^T"[RQSTAT S TOT(DVBAPREXM,"PENDADJ")=TOT(DVBAPREXM,"PENDADJ")+1,X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBAB2",55,0)
 I DTRPT'>EDATE,"^C^CT^R^RX^X^"[RQSTAT,(+DTREL>EDATE)!(+DTCAN>EDATE) S TOT(DVBAPREXM,"PENDADJ")=TOT(DVBAPREXM,"PENDADJ")+1,X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBAB2",56,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT["C"!(RQSTAT="R") S TOT(DVBAPREXM,"COMPLETED")=TOT(DVBAPREXM,"COMPLETED")+1
"RTN","DVBAB2",57,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,PRIO="E" S TOT(DVBAPREXM,"INSUFF")=TOT(DVBAPREXM,"INSUFF")+1
"RTN","DVBAB2",58,0)
 I DTCAN'<BDATE&(DTCAN'>EDATE),RQSTAT="X"!(RQSTAT="RX") S TOT(DVBAPREXM,"INCOMPLETE")=TOT(DVBAPREXM,"INCOMPLETE")+1
"RTN","DVBAB2",59,0)
 K DTRPT Q
"RTN","DVBAB2",60,0)
 ;
"RTN","DVBAB2",61,0)
GO ;
"RTN","DVBAB2",62,0)
 N DVBAEXMP,DVBAP,DVBAPREXM,DVBATOT,DVBALNE
"RTN","DVBAB2",63,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":";BDD;QS;",($G(DVBAPRTY)["IDES"):";IDES;",($G(DVBAPRTY)["AO"):";AO;",1:"")
"RTN","DVBAB2",64,0)
 S DVBABCNT=0,DVBALNE="" K ^TMP($J)
"RTN","DVBAB2",65,0)
 S %DT="TS",X="NOW" D ^%DT S DVBCNOW=Y
"RTN","DVBAB2",66,0)
 S PNAM="" F JJ=0:0 S PNAM=$O(^DVB(396.3,"B",PNAM)) Q:PNAM=""  F REQDA=0:0 S REQDA=$O(^DVB(396.3,"B",PNAM,REQDA)) Q:REQDA=""  D SET
"RTN","DVBAB2",67,0)
 ;
"RTN","DVBAB2",68,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBAB2",69,0)
 M DVBATOT=TOT  ;save totals for all priorities into new array
"RTN","DVBAB2",70,0)
 F DVBAP=1:1:$L(DVBAEXMP,",") D
"RTN","DVBAB2",71,0)
 .S DVBAPREXM=$P(DVBAEXMP,",",DVBAP)
"RTN","DVBAB2",72,0)
 .;re-create TOT array for each priority of exam
"RTN","DVBAB2",73,0)
 .D CRTOT^DVBCAMR2(DVBAPREXM,.DVBATOT,.TOT)
"RTN","DVBAB2",74,0)
 .S TOT("AVGDAYS")=0
"RTN","DVBAB2",75,0)
 .I TOT("COMPLETED")>0 S TOT("AVGDAYS")=TOT("DAYS")/TOT("COMPLETED"),TOT("AVGDAYS")=$J(TOT("AVGDAYS"),5,1)
"RTN","DVBAB2",76,0)
 .D BULLTXT^DVBCAMR1(DVBAPREXM)
"RTN","DVBAB2",77,0)
 .F JI=0:0 S JI=$O(^TMP($J,JI)) Q:JI=""  S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=^TMP($J,JI,0)
"RTN","DVBAB2",78,0)
 .S:'$D(XMY) SBULL="N" I SBULL="Y" D SEND
"RTN","DVBAB2",79,0)
 .D:(DVBAP'=$L(DVBAEXMP,","))  ;another report to run
"RTN","DVBAB2",80,0)
 ..;insert line breaks / horizontal line break
"RTN","DVBAB2",81,0)
 ..S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=""
"RTN","DVBAB2",82,0)
 ..F JI=1:1:70 S $P(DVBALNE,"-",JI)="-"
"RTN","DVBAB2",83,0)
 ..S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=DVBALNE
"RTN","DVBAB2",84,0)
 ..S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=""
"RTN","DVBAB2",85,0)
 ;
"RTN","DVBAB2",86,0)
EXIT K BDATE,%DT,DVBABCNT,C,DTCAN,DTREL,DTREQ,DTRQCMP,DTSCHEDC,DTTRANS
"RTN","DVBAB2",87,0)
 K DVBCNOW,DVBCPCTM,EDATE,FA,FB,JI,JJ,L,PNAM,PRIO,REQDA,RONUM,RQSTAT
"RTN","DVBAB2",88,0)
 K SBULL,TOT,X,X1,X2,XMDUZ,XMMG,XMY,Y,YY
"RTN","DVBAB2",89,0)
 Q
"RTN","DVBAB2",90,0)
 ;
"RTN","DVBAB2",91,0)
BULL S XMDUZ=$P(^VA(200,DUZ,0),U),XMMG=$S($D(^VA(200,DUZ,0)):$P(^(0),U,1),1:""),XMY(DUZ)=""
"RTN","DVBAB2",92,0)
 Q
"RTN","DVBAB2",93,0)
 ;
"RTN","DVBAB2",94,0)
SEND ;send 2507 AMIS report in bulletin
"RTN","DVBAB2",95,0)
 N DVBAXMY M DVBAXMY=XMY
"RTN","DVBAB2",96,0)
 S XMSUB="RO AMIS 290 Report "_$S((($G(DVBAPREXM)]"")&($G(DVBAPREXM)'="ALL")):"("_$G(DVBAPREXM)_" Exam Priority) ",1:"")_"-  "
"RTN","DVBAB2",97,0)
 S Y=BDATE X ^DD("DD") S XMSUB=XMSUB_Y S Y=EDATE X ^DD("DD") S XMSUB=XMSUB_" to "_Y,XMTEXT="^TMP($J,"
"RTN","DVBAB2",98,0)
 D ^XMD K XMTEXT,XMSUB,^TMP($J)
"RTN","DVBAB2",99,0)
 S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=""
"RTN","DVBAB2",100,0)
 S DVBABCNT=DVBABCNT+1,MSG(DVBABCNT)=">>> Mail message transmitted. <<<"
"RTN","DVBAB2",101,0)
 M XMY=DVBAXMY  ;restore address list for subsequent bulletins
"RTN","DVBAB2",102,0)
 Q
"RTN","DVBAB2",103,0)
 ;
"RTN","DVBAB3")
0^8^B9998262^B10129611
"RTN","DVBAB3",1,0)
DVBAB3 ;ALB/KLB - CAPRI Amis Report ;05/01/00
"RTN","DVBAB3",2,0)
 ;;2.7;AMIE;**35,42,149,184**;Apr 10, 1995;Build 10
"RTN","DVBAB3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBAB3",4,0)
 ;
"RTN","DVBAB3",5,0)
 ;Input:  MSG    - Array with report contents/error message 
"RTN","DVBAB3",6,0)
 ;                 (By Ref)
"RTN","DVBAB3",7,0)
 ;        BDATE  - Beginning date in a date range to use
"RTN","DVBAB3",8,0)
 ;                 for retrieving results for the report.
"RTN","DVBAB3",9,0)
 ;        EDATE  - Ending date in a date range to use for
"RTN","DVBAB3",10,0)
 ;                 retrieving results for the report.
"RTN","DVBAB3",11,0)
 ;        RONUMB - Regional Office number '^' Division to 
"RTN","DVBAB3",12,0)
 ;                 filter result set on (Both Optional)
"RTN","DVBAB3",13,0)
 ;        SBULL  - A Y/N value indicating whether a bulletin
"RTN","DVBAB3",14,0)
 ;                 (Report Contents) will be generated when 
"RTN","DVBAB3",15,0)
 ;                 processing completes.
"RTN","DVBAB3",16,0)
 ;        DUZ    - IEN of the individual in File #200 to send
"RTN","DVBAB3",17,0)
 ;                 bulletin to.
"RTN","DVBAB3",18,0)
 ;      DVBAPRTY - Priority of Exam code that indicates which
"RTN","DVBAB3",19,0)
 ;                 priorities to filter on.
"RTN","DVBAB3",20,0)
 ;                    AO  - Agent Orange (A0)
"RTN","DVBAB3",21,0)
 ;                    BDD - Benefits Delivery at Discharge (BDD)
"RTN","DVBAB3",22,0)
 ;                          Quick Start (QS)
"RTN","DVBAB3",23,0)
 ;                    IDES - Integrated Disability Evaluation System (IDES)
"RTN","DVBAB3",24,0)
 ;                    ALL - All others (Excludes AO,BDD,IDES,QS)
"RTN","DVBAB3",25,0)
STRT(MSG,BDATE,EDATE,RONUMB,SBULL,DUZ,DVBAPRTY) ;
"RTN","DVBAB3",26,0)
 S BDATE=BDATE+".0000"
"RTN","DVBAB3",27,0)
 S EDATE=EDATE+".2359"
"RTN","DVBAB3",28,0)
 S DVBDIV=$P($G(RONUMB),"^",2)
"RTN","DVBAB3",29,0)
 S RONUMB=$P($G(RONUMB),"^",1)
"RTN","DVBAB3",30,0)
 S CNT=0
"RTN","DVBAB3",31,0)
 K ^TMP($J)
"RTN","DVBAB3",32,0)
 S RONUM=0
"RTN","DVBAB3",33,0)
SETUP S UPDATE="N",PREVMO=$P(^DVB(396.1,1,0),U,11)
"RTN","DVBAB3",34,0)
 I '$D(DT) S DT=$$DT^XLFDT
"RTN","DVBAB3",35,0)
 S DVBCDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBAB3",36,0)
INITCNTR ;initialize counter arrays
"RTN","DVBAB3",37,0)
 N DVBAEXMP,DVBAP
"RTN","DVBAB3",38,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBAB3",39,0)
 F JI="3DAYSCH","30DAYEX","PENDADJ" D
"RTN","DVBAB3",40,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBAB3",41,0)
 F JI="INSUFF","SENT","INCOMPLETE","DAYS","COMPLETED" D
"RTN","DVBAB3",42,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBAB3",43,0)
 F JI="P90","P121","P151","P181","P365","P366" D
"RTN","DVBAB3",44,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBAB3",45,0)
 S ^TMP($J,CNT)="REGIONAL OFFICE 2507 AMIS REPORT",CNT=CNT+1
"RTN","DVBAB3",46,0)
 ;
"RTN","DVBAB3",47,0)
EN ;
"RTN","DVBAB3",48,0)
 N DVBAERR
"RTN","DVBAB3",49,0)
 S ^TMP($J,CNT)="",CNT=CNT+1,^TMP($J,CNT)="",CNT=CNT+1,^TMP($J,CNT)="",CNT=CNT+1
"RTN","DVBAB3",50,0)
 S:'$D(EDATE) MSG(1)="Please enter a ending date"
"RTN","DVBAB3",51,0)
 G:'$D(EDATE) EXIT
"RTN","DVBAB3",52,0)
 S:'$D(BDATE) MSG(1)="Please enter a starting date"
"RTN","DVBAB3",53,0)
 G:'$D(BDATE) EXIT
"RTN","DVBAB3",54,0)
 S BDATE1=BDATE-.1,EDATE1=EDATE+.5
"RTN","DVBAB3",55,0)
 S:EDATE<BDATE MSG(1)="Beginning date must be before ending date"
"RTN","DVBAB3",56,0)
 G:EDATE<BDATE EXIT
"RTN","DVBAB3",57,0)
 I (RONUMB]"") D  G:DVBAERR EXIT
"RTN","DVBAB3",58,0)
 .S DVBAERR=0
"RTN","DVBAB3",59,0)
 .S RONUM=$O(^DIC(4,"B",RONUMB,RONUM))
"RTN","DVBAB3",60,0)
 .I RONUM="" S MSG(1)="Invalid Regional Office number",DVBAERR=1 Q
"RTN","DVBAB3",61,0)
 .S:'$D(^DIC(4,RONUM,99)) MSG(1)="Invalid Regional Office number",DVBAERR=1
"RTN","DVBAB3",62,0)
 .Q:'$D(^DIC(4,RONUM,99))
"RTN","DVBAB3",63,0)
 .S RONUM=$S($D(^DIC(4,RONUM,99)):$P(^(99),U,1),1:"000")
"RTN","DVBAB3",64,0)
 .S RONAME=RONUMB
"RTN","DVBAB3",65,0)
 D:(RONUMB']"")
"RTN","DVBAB3",66,0)
 .S (RONUM,RONAME)="ALL"
"RTN","DVBAB3",67,0)
 ;validate Priority of Exam (Null Allowed and will default to ALL)
"RTN","DVBAB3",68,0)
 I ((";AO;BDD;IDES;ALL;;")'[(";"_$G(DVBAPRTY)_";")) D  G EXIT
"RTN","DVBAB3",69,0)
 .S MSG(1)="Invalid Priority of Exam Code"
"RTN","DVBAB3",70,0)
 S:'$D(SBULL) MSG(1)="You need to say if you want a Bulletin or not"
"RTN","DVBAB3",71,0)
 G:'$D(SBULL) EXIT
"RTN","DVBAB3",72,0)
 I SBULL="Y" D BULL^DVBAB2
"RTN","DVBAB3",73,0)
 ;
"RTN","DVBAB3",74,0)
 D GO^DVBAB2
"RTN","DVBAB3",75,0)
EXIT K BDATE,BDATE1,DVBCDT,EDATE,CNT,EDATE1,JI,PREVMO,RONAME,RONUM,RONUMB,SBULL,TOT,UPDATE,X,Y,^TMP($J)
"RTN","DVBAB3",76,0)
 Q
"RTN","DVBAB3",77,0)
INIT(Y) ;
"RTN","DVBAB3",78,0)
 ; INITS MAILMAN VARIABLES
"RTN","DVBAB3",79,0)
 D INIT^XMVVITAE
"RTN","DVBAB3",80,0)
 S Y=XMV("NETNAME")_"^"
"RTN","DVBAB3",81,0)
 Q
"RTN","DVBAB82")
0^9^B116645006^B116645006
"RTN","DVBAB82",1,0)
DVBAB82 ;ALB/DJS - CAPRI DVBA REPORTS ; 01/24/12
"RTN","DVBAB82",2,0)
 ;;2.7;AMIE;**42,90,100,119,156,149,179,181,184**;Apr 10, 1995;Build 10
"RTN","DVBAB82",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBAB82",4,0)
 Q
"RTN","DVBAB82",5,0)
 ;
"RTN","DVBAB82",6,0)
START(MSG,RPID,PARM) ; CALLED BY REMOTE PROCEDURE DVBAB REPORTS
"RTN","DVBAB82",7,0)
 ;Parameters
"RTN","DVBAB82",8,0)
 ;=============
"RTN","DVBAB82",9,0)
 ; MSG  : Output - ^TMP("DVBA",$J)
"RTN","DVBAB82",10,0)
 ; RPID : Report Identification Number
"RTN","DVBAB82",11,0)
 ; PARM : Input parameters separated by "^"
"RTN","DVBAB82",12,0)
 ;
"RTN","DVBAB82",13,0)
 N DVBHFS,DVBERR,DVBGUI,I,DVBADLMTD
"RTN","DVBAB82",14,0)
 K ^TMP("DVBA",$J)
"RTN","DVBAB82",15,0)
 S DVBGUI=1,(DVBERR,DVBADLMTD)=0,DVBHFS=$$HFS(),RPID=$G(RPID)
"RTN","DVBAB82",16,0)
 I RPID<1!(RPID>15) S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Report ID" G END
"RTN","DVBAB82",17,0)
 D HFSOPEN("DVBRP",DVBHFS,"W") I DVBERR G END
"RTN","DVBAB82",18,0)
 I RPID=1 D CRMS G END
"RTN","DVBAB82",19,0)
 I RPID=3 D CPRNT G END
"RTN","DVBAB82",20,0)
 I RPID=11 D CNHRP G END  ;FNCNH Print Roster
"RTN","DVBAB82",21,0)
 D CHECK I DVBERR G END  ;reports below require parameters
"RTN","DVBAB82",22,0)
 I RPID=2 D CRRR G END
"RTN","DVBAB82",23,0)
 I RPID=4 D CRPON G END
"RTN","DVBAB82",24,0)
 I RPID=5 D CIRPT G END
"RTN","DVBAB82",25,0)
 I RPID=6 D DSRP G END
"RTN","DVBAB82",26,0)
 I RPID=7 D SDPP G END
"RTN","DVBAB82",27,0)
 I RPID=8 D SPRPT G END
"RTN","DVBAB82",28,0)
 I RPID=9 D VIEW G END
"RTN","DVBAB82",29,0)
 I RPID=10 D CNHDEOC G END  ;FBCNH Display Episode Of Care
"RTN","DVBAB82",30,0)
 I RPID=12 D CNHRAD G END  ;FNCNH Report of Admissions/Discharges
"RTN","DVBAB82",31,0)
 I RPID=13 D CNHSE90D G END  ;FNCNH Stays in Excess of 90 Days
"RTN","DVBAB82",32,0)
 I RPID=14 D REQSTAT G END  ;REQUEST STATUS BY DATE RANGE
"RTN","DVBAB82",33,0)
 I RPID=15 D DVBA8861 G END  ;FORM 28-8861 STATUS REPORT
"RTN","DVBAB82",34,0)
 ;
"RTN","DVBAB82",35,0)
END D HFSCLOSE("DVBRP",DVBHFS)
"RTN","DVBAB82",36,0)
 I ($G(DVBADLMTD)&('+DVBERR)) D  Q  ;Create delimited output if no errors
"RTN","DVBAB82",37,0)
 .D DLMTRPT^DVBAB82D(RPID)
"RTN","DVBAB82",38,0)
 .S MSG=$NA(^TMP("DVBADLMTD",$J))
"RTN","DVBAB82",39,0)
 ;Replace "##FFFF##" with Form Feeds - code needed for LINUX environments
"RTN","DVBAB82",40,0)
 S I=0 F  S I=$O(^TMP("DVBA",$J,1,I)) Q:'I  D
"RTN","DVBAB82",41,0)
 .S:^TMP("DVBA",$J,1,I)["##FFFF##" ^TMP("DVBA",$J,1,I)=$P(^TMP("DVBA",$J,1,I),"##FFFF##")_$C(13,12)_$P(^TMP("DVBA",$J,1,I),"##FFFF##",2)
"RTN","DVBAB82",42,0)
 .S ^TMP("DVBA",$J,1,I)=^TMP("DVBA",$J,1,I)_$C(13)
"RTN","DVBAB82",43,0)
 .S:^TMP("DVBA",$J,1,I)["$END" ^TMP("DVBA",$J,1,I)=""
"RTN","DVBAB82",44,0)
 S MSG=$NA(^TMP("DVBA",$J))
"RTN","DVBAB82",45,0)
 Q
"RTN","DVBAB82",46,0)
CHECK ; VALIDATE INPUT PARAMETERS
"RTN","DVBAB82",47,0)
 I $G(PARM)="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Input Parameters"
"RTN","DVBAB82",48,0)
 Q
"RTN","DVBAB82",49,0)
 ;
"RTN","DVBAB82",50,0)
SDPP ; Report # 7 - Full (Patient Profile MAS) Report
"RTN","DVBAB82",51,0)
 ;Parameters
"RTN","DVBAB82",52,0)
 ;=============
"RTN","DVBAB82",53,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",54,0)
 ; SDR : R/Range or A/All
"RTN","DVBAB82",55,0)
 ; SDBD : Begining date
"RTN","DVBAB82",56,0)
 ; SDED : Ending date
"RTN","DVBAB82",57,0)
 ; SDP : Print the profile? 1 OR 0
"RTN","DVBAB82",58,0)
 ; SDTYP(2) : Print appointments? 1 OR 0
"RTN","DVBAB82",59,0)
 ; SDTYP(1) : Print add/edits? 1 or 0
"RTN","DVBAB82",60,0)
 ; SDTYP(4) : Print enrollments? 1 or 0
"RTN","DVBAB82",61,0)
 ; SDTYP(3) : Print dispositions? 1 OR 0
"RTN","DVBAB82",62,0)
 ; SDTYP(7) : Print team information? 1 OR 0
"RTN","DVBAB82",63,0)
 ; SDTYP(5) : Print means test? 1 OR 0
"RTN","DVBAB82",64,0)
 ;
"RTN","DVBAB82",65,0)
 N SDTYP,SDBD,SDED,SDACT,SDPRINT,SDYES,SDRANGE,SDBEG,SDEN
"RTN","DVBAB82",66,0)
 S ^XTMP("JAP",$J,$$NOW^XLFDT(),"SDPP")=PARM
"RTN","DVBAB82",67,0)
 S DFN=$P(PARM,"^",1),SDR=$P(PARM,"^",2),SDBD=$P(PARM,"^",3),SDED=$P(PARM,"^",4)
"RTN","DVBAB82",68,0)
 S SDP=$P(PARM,"^",5),SDTYP(2)=$P(PARM,"^",6),SDTYP(1)=$P(PARM,"^",7)
"RTN","DVBAB82",69,0)
 S SDTYP(4)=$P(PARM,"^",8),SDTYP(3)=$P(PARM,"^",9),SDTYP(7)=$P(PARM,"^",10),SDTYP(5)=$P(PARM,"^",11)
"RTN","DVBAB82",70,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",71,0)
 S SDACT="",(SDYES,SDRANGE,SDPRINT)=0
"RTN","DVBAB82",72,0)
 I SDR="R" S SDRANGE=1
"RTN","DVBAB82",73,0)
 I SDP=1 S SDYES=1,SDPRINT=1
"RTN","DVBAB82",74,0)
 I 'SDRANGE S (SDBD,SDBEG)=2800101,(SDED,SDEND)=$$ENDDT(),SDHDR=1
"RTN","DVBAB82",75,0)
 D ENS^%ZISS
"RTN","DVBAB82",76,0)
 S SDPRINT=1
"RTN","DVBAB82",77,0)
 S:(SDTYP(2)=1) SDTYP(2)=""  ;appointments
"RTN","DVBAB82",78,0)
 K:(SDTYP(2)=0) SDTYP(2)
"RTN","DVBAB82",79,0)
 S:(SDTYP(1)=1) SDTYP(1)=""  ;add/edits
"RTN","DVBAB82",80,0)
 K:(SDTYP(1)=0) SDTYP(1)
"RTN","DVBAB82",81,0)
 I (SDTYP(4)=1) S SDTYP(4)="",SDACT=0  ;enrollments
"RTN","DVBAB82",82,0)
 K:(SDTYP(4)=0) SDTYP(4)
"RTN","DVBAB82",83,0)
 S:(SDTYP(3)=1) SDTYP(3)=""  ;dispositions
"RTN","DVBAB82",84,0)
 K:(SDTYP(3)=0) SDTYP(3)
"RTN","DVBAB82",85,0)
 S:(SDTYP(5)=1) SDTYP(5)=""  ;means test
"RTN","DVBAB82",86,0)
 K:(SDTYP(5)=0) SDTYP(5)
"RTN","DVBAB82",87,0)
 I SDTYP(7)=1 D  ;team information
"RTN","DVBAB82",88,0)
 . S SDTYP(7)="",GBL="^TMP(""SDPP"","_$J_")"
"RTN","DVBAB82",89,0)
 K:(SDTYP(7)=0) SDTYP(7)
"RTN","DVBAB82",90,0)
 D PRINT^SDPPRT
"RTN","DVBAB82",91,0)
 S VALMBCK="R"
"RTN","DVBAB82",92,0)
 Q
"RTN","DVBAB82",93,0)
ENDDT() ;Calculate end date for "all" date
"RTN","DVBAB82",94,0)
 N DVBAPPTS,DVBX
"RTN","DVBAB82",95,0)
 S DVBAPPTS(1)=2800101,DVBAPPTS(4)=DFN,DVBAPPTS("SORT")="P"
"RTN","DVBAB82",96,0)
 S DVBAPPTS("FLDS")=1,DVBAPPTS("MAX")=-1
"RTN","DVBAB82",97,0)
 S DVBX=$S(($$SDAPI^SDAMA301(.DVBAPPTS)>0):$O(^TMP($J,"SDAMA301",DFN,0)),1:DT_.24)
"RTN","DVBAB82",98,0)
 K ^TMP($J,"SDAMA301")
"RTN","DVBAB82",99,0)
 Q DVBX
"RTN","DVBAB82",100,0)
 ;
"RTN","DVBAB82",101,0)
VIEW ; Report # 9 - View Registration Data Report
"RTN","DVBAB82",102,0)
 ; Parameters
"RTN","DVBAB82",103,0)
 ; ==========
"RTN","DVBAB82",104,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",105,0)
 ;
"RTN","DVBAB82",106,0)
 U IO
"RTN","DVBAB82",107,0)
 S DFN=$P(PARM,"^",1)
"RTN","DVBAB82",108,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",109,0)
 D EN1^DGRP
"RTN","DVBAB82",110,0)
 Q
"RTN","DVBAB82",111,0)
 ;
"RTN","DVBAB82",112,0)
DSRP ; Report # 6 - Reprint a Notice of Discharge Report
"RTN","DVBAB82",113,0)
 ; Parameters
"RTN","DVBAB82",114,0)
 ; % : 1=Report on all veterans for a given day (BDATE required)
"RTN","DVBAB82",115,0)
 ;   : 0=Report on a single Veteran (DFN required)
"RTN","DVBAB82",116,0)
 ; BDATE : Original Processing Date - $H/FileMan
"RTN","DVBAB82",117,0)
 ; DFN  : Patient Identification Number
"RTN","DVBAB82",118,0)
 ;
"RTN","DVBAB82",119,0)
 N %,BDATE,DFN,DFNIEN
"RTN","DVBAB82",120,0)
 S %=$P(PARM,"^",1),BDATE=$P(PARM,"^",2),DFN=$P(PARM,"^",3),DFNIEN=""
"RTN","DVBAB82",121,0)
 I BDATE="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Date"  Q
"RTN","DVBAB82",122,0)
 D DUZ2^DVBAUTIL
"RTN","DVBAB82",123,0)
 U IO
"RTN","DVBAB82",124,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",125,0)
 I %=1 D  Q
"RTN","DVBAB82",126,0)
 . S HD="SINGLE NOTICE OF DISCHARGE REPRINTING"
"RTN","DVBAB82",127,0)
 . D NOPARM^DVBAUTL2
"RTN","DVBAB82",128,0)
 . I $D(DVBAQUIT) D KILL^DVBAUTIL Q  ;CAUTION: Short-circuit
"RTN","DVBAB82",129,0)
 . S DTAR=^DVB(396.1,1,0),FDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBAB82",130,0)
 . S HEAD="NOTICE OF DISCHARGE",HEAD1="FOR "_$P(DTAR,U,1)_" ON "_FDT(0)
"RTN","DVBAB82",131,0)
 . I $D(^DVB(396.2,"B",DFN)) D
"RTN","DVBAB82",132,0)
 . . S DFNIEN=$O(^DVB(396.2,"B",DFN,DFNIEN)),ADM=$P(^DVB(396.2,DFNIEN,0),U,3)
"RTN","DVBAB82",133,0)
 . . I $D(^DGPM(+ADM,0)),$P(^(0),U,17)]"" S DCHPTR=$P(^DGPM(+ADM,0),U,17),DISCH=$S($P(^DGPM(DCHPTR,0),U,1)]"":$P(^(0),U,1),1:"") W ?($X+5),"Discharge date: ",$$FMTE^XLFDT(DISCH,"5DZ")
"RTN","DVBAB82",134,0)
 . . I $P(^DVB(396.2,DFNIEN,0),U,7)'=DVBAD2 W *7,!!,"This does not belong to your RO.",!! H 3 Q
"RTN","DVBAB82",135,0)
 . . I DFNIEN>0 S XDA=DFNIEN,DA=$P(^DVB(396.2,DFNIEN,0),U,1),ADMDT=$P(^DVB(396.2,DFNIEN,0),U,2),MB=$P(^(0),U,3)
"RTN","DVBAB82",136,0)
 . . D REPRINT^DVBADSNT
"RTN","DVBAB82",137,0)
 D DEQUE^DVBADSRP
"RTN","DVBAB82",138,0)
 Q
"RTN","DVBAB82",139,0)
 ;
"RTN","DVBAB82",140,0)
SPRPT ; Report # 8 - OP(Operation Report)
"RTN","DVBAB82",141,0)
 ;Parameters
"RTN","DVBAB82",142,0)
 ;=============
"RTN","DVBAB82",143,0)
 ; DFN : Patient Identification Number
"RTN","DVBAB82",144,0)
 ; SRTN : Select Operation
"RTN","DVBAB82",145,0)
 ;
"RTN","DVBAB82",146,0)
 N DFN,SRTN,MAGTMPR2,SRSITE
"RTN","DVBAB82",147,0)
 I $O(^SRO(133,1))'="B" S SRSITE=1
"RTN","DVBAB82",148,0)
 S DFN=$P(PARM,"^",1),SRTN=$P(PARM,"^",2),MAGTMPR2=1
"RTN","DVBAB82",149,0)
 D VAL Q:DVBERR
"RTN","DVBAB82",150,0)
 D ^SROPRPT
"RTN","DVBAB82",151,0)
 Q
"RTN","DVBAB82",152,0)
 ;
"RTN","DVBAB82",153,0)
CRPON ; Report # - 4 Reprint C&P Final Report
"RTN","DVBAB82",154,0)
 ;Parameters
"RTN","DVBAB82",155,0)
 ;=============
"RTN","DVBAB82",156,0)
 ; RTYPE : Select Reprint Option (D)ate or (V)eteran
"RTN","DVBAB82",157,0)
 ; RUNDATE : ORIGINAL PROCESSING date
"RTN","DVBAB82",158,0)
 ; ANS : Reprinted by the RO or MAS
"RTN","DVBAB82",159,0)
 ; % : LAB 1 OR 0
"RTN","DVBAB82",160,0)
 ; DA(1) : Patient IEN for lab results
"RTN","DVBAB82",161,0)
 ; DFN  : Patient Identification Number
"RTN","DVBAB82",162,0)
 ;
"RTN","DVBAB82",163,0)
 U IO
"RTN","DVBAB82",164,0)
 N ONE
"RTN","DVBAB82",165,0)
 S RTYPE=$P(PARM,"^",1),RUNDATE=$P(PARM,"^",2),ANS=$P(PARM,"^",3),%=$P(PARM,"^",4),DA(1)=$P(PARM,"^",5),DFN=$P(PARM,"^",6),DA=DA(1)
"RTN","DVBAB82",166,0)
 I RTYPE="V" D VAL Q:DVBERR
"RTN","DVBAB82",167,0)
 S XDD=^DD("DD"),$P(ULINE,"_",70)="_",ONE="N",Y=DT
"RTN","DVBAB82",168,0)
 X XDD S HD="Reprint C & P Exams",SUPER=0
"RTN","DVBAB82",169,0)
 I $D(^XUSEC("DVBA C SUPERVISOR",DUZ)) S SUPER=1
"RTN","DVBAB82",170,0)
 S DVBCDT(0)=Y,PGHD="Compensation and Pension Exam Report",LOC=DUZ(2),PG=0,DVBCSITE=$S($D(^DVB(396.1,1,0)):$P(^(0),U,1),1:"Not specified")
"RTN","DVBAB82",171,0)
 I "^D^V^"'[RTYPE S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",172,0)
 I ANS="R" K AUTO
"RTN","DVBAB82",173,0)
 I ANS="M" S AUTO=1
"RTN","DVBAB82",174,0)
 I "^M^R^"'[ANS S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",175,0)
 I RTYPE="D" D GO^DVBCRPRT Q
"RTN","DVBAB82",176,0)
 I RTYPE="V" D
"RTN","DVBAB82",177,0)
 . S ONE="Y",RO=$P(^DVB(396.3,DA,0),U,3)
"RTN","DVBAB82",178,0)
 . I RO'=DUZ(2)&('$D(AUTO))&(SUPER=0) W !!,*7,"Those results do not belong to your office.",!! Q
"RTN","DVBAB82",179,0)
 . I RO=DUZ(2)&('$D(AUTO))&("RC"'[($P(^DVB(396.3,DA,0),U,18))) W *7,!!,"This request has not been released to the Regional Office yet.",!! Q
"RTN","DVBAB82",180,0)
 . S PRTDATE=$P(^DVB(396.3,DA,0),U,16) I PRTDATE="" W *7,!!,"This has never been printed.",!! I SUPER=0 S OUT=1 Q
"RTN","DVBAB82",181,0)
 . I %=1 D REN2^DVBCLABR Q
"RTN","DVBAB82",182,0)
 . ;D OV^DVBCRPON
"RTN","DVBAB82",183,0)
 . K DVBAON2 D SETLAB^DVBCPRNT,VARS^DVBCUTIL,STEP2^DVBCRPRT
"RTN","DVBAB82",184,0)
 Q
"RTN","DVBAB82",185,0)
 ;
"RTN","DVBAB82",186,0)
CIRPT ; Report # 5 - Insufficient Exam Report
"RTN","DVBAB82",187,0)
 ;Parameters
"RTN","DVBAB82",188,0)
 ;=============
"RTN","DVBAB82",189,0)
 ; RPTTYPE : D/Detailed or S/Summary
"RTN","DVBAB82",190,0)
 ; BEGDT : Beginning date $H/FileMan
"RTN","DVBAB82",191,0)
 ; ENDDT : Ending date $H/FileMan
"RTN","DVBAB82",192,0)
 ; RESANS : Insufficient Reason
"RTN","DVBAB82",193,0)
 ; DVBAPRTY : Priority of Exam Code
"RTN","DVBAB82",194,0)
 ;    AO  : Agent Orange
"RTN","DVBAB82",195,0)
 ;    BDD : Benefits Delivery at Discharge / Quick Start
"RTN","DVBAB82",196,0)
 ;   IDES : Integrated Disability Evaluation System
"RTN","DVBAB82",197,0)
 ;    ALL : All Others (Original Report w/ all codes except the above)
"RTN","DVBAB82",198,0)
 ;
"RTN","DVBAB82",199,0)
 N DVBAPRTY,RPTTYPE,BEGDT,ENDDT,RESANS
"RTN","DVBAB82",200,0)
 U IO
"RTN","DVBAB82",201,0)
 S RPTTYPE=$P(PARM,"^",1),BEGDT=$P(PARM,"^",2),ENDDT=$P(PARM,"^",3),RESANS=$P(PARM,"^",4)
"RTN","DVBAB82",202,0)
 S DVBAPRTY=$P(PARM,"^",5)
"RTN","DVBAB82",203,0)
 S ENDDT=ENDDT_".2359"
"RTN","DVBAB82",204,0)
 I RPTTYPE="S" D SUM^DVBCIRPT Q
"RTN","DVBAB82",205,0)
 I RPTTYPE="D" D
"RTN","DVBAB82",206,0)
 . D INREAS
"RTN","DVBAB82",207,0)
 . Q:($D(^TMP("DVBA",$J,1)))  ;invalid reason sent
"RTN","DVBAB82",208,0)
 . D EXMTPE,DETAIL^DVBCIRP1
"RTN","DVBAB82",209,0)
 Q
"RTN","DVBAB82",210,0)
 ;
"RTN","DVBAB82",211,0)
EXMTPE ;exam types (retrieve all for filter)
"RTN","DVBAB82",212,0)
 N DVBAXIFN
"RTN","DVBAB82",213,0)
 F DVBAXIFN=0:0 S DVBAXIFN=$O(^DVB(396.6,DVBAXIFN)) Q:+DVBAXIFN=0  DO
"RTN","DVBAB82",214,0)
 . S ^TMP($J,"XMTYPE",DVBAXIFN)=""
"RTN","DVBAB82",215,0)
 Q
"RTN","DVBAB82",216,0)
INREAS ;insufficient reason (validate specific or retrieve all)
"RTN","DVBAB82",217,0)
 N DVBAXIFN
"RTN","DVBAB82",218,0)
 D:(RESANS="")  ;use all insufficient reasons
"RTN","DVBAB82",219,0)
 .F DVBAXIFN=0:0 S DVBAXIFN=$O(^DVB(396.94,DVBAXIFN)) Q:+DVBAXIFN=0  DO
"RTN","DVBAB82",220,0)
 .. S DVBAARY("REASON",DVBAXIFN)=""
"RTN","DVBAB82",221,0)
 D:(RESANS'="")  ;use specific insufficient reason
"RTN","DVBAB82",222,0)
 .I ('$D(^DVB(396.94,+RESANS))) D  ;validate IEN
"RTN","DVBAB82",223,0)
 ..S DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid Insufficient Reason IEN"
"RTN","DVBAB82",224,0)
 .E  S DVBAARY("REASON",+RESANS)=""
"RTN","DVBAB82",225,0)
 Q
"RTN","DVBAB82",226,0)
 ;
"RTN","DVBAB82",227,0)
CRMS ; Report # 1 - Regional Office 21- day Certificate Printing Report.
"RTN","DVBAB82",228,0)
 ; No Parameters
"RTN","DVBAB82",229,0)
 ;
"RTN","DVBAB82",230,0)
 U IO
"RTN","DVBAB82",231,0)
 D ^DVBACRMS
"RTN","DVBAB82",232,0)
 Q
"RTN","DVBAB82",233,0)
 ;
"RTN","DVBAB82",234,0)
CRRR ; Report # 2 - Reprint a 21 - day Certificate for the RO
"RTN","DVBAB82",235,0)
 ;Parameters
"RTN","DVBAB82",236,0)
 ;=============
"RTN","DVBAB82",237,0)
 ; DVBSEL : Select one of the following:
"RTN","DVBAB82",238,0)
 ;       N         Patient Name
"RTN","DVBAB82",239,0)
 ;       D         ORIGINAL PROCESSING DATE
"RTN","DVBAB82",240,0)
 ; SDATE : ORIGINAL PROCESSING date - $H/FileMan
"RTN","DVBAB82",241,0)
 ; XDA : Patient IEN
"RTN","DVBAB82",242,0)
 ;
"RTN","DVBAB82",243,0)
 U IO
"RTN","DVBAB82",244,0)
 S DVBSEL=$P(PARM,"^",1),SDATE=$P(PARM,"^",2),XDA=$P(PARM,"^",3)
"RTN","DVBAB82",245,0)
 I "^D^N^"'[DVBSEL S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Data Type" Q
"RTN","DVBAB82",246,0)
 I DVBSEL="D" D  I DVBERR Q
"RTN","DVBAB82",247,0)
 . I SDATE="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Date" Q
"RTN","DVBAB82",248,0)
 . S %DT="X" S X=SDATE D ^%DT I Y<0 D  Q
"RTN","DVBAB82",249,0)
 . . S DVBERR=1,^TMP("DVBA",$J,1)="0^Incorrect Date Format"
"RTN","DVBAB82",250,0)
 I DVBSEL="N" D  I DVBERR Q
"RTN","DVBAB82",251,0)
 . I XDA="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Patient IEN" Q
"RTN","DVBAB82",252,0)
 . S DIC=2,DIC(0)="NZX",X=XDA D ^DIC I Y<0 D  I DVBERR Q
"RTN","DVBAB82",253,0)
 . . S DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid Patient Name."
"RTN","DVBAB82",254,0)
 . S DFN=XDA
"RTN","DVBAB82",255,0)
 D INIT^DVBACRRR I 'CONT Q
"RTN","DVBAB82",256,0)
 D HDR^DVBACRRR,DATA^DVBACRRR
"RTN","DVBAB82",257,0)
 Q
"RTN","DVBAB82",258,0)
 ;
"RTN","DVBAB82",259,0)
CPRNT ; Report # 3 - Print C&P Final Report (manual) Report
"RTN","DVBAB82",260,0)
 ; No Parameters
"RTN","DVBAB82",261,0)
 ;
"RTN","DVBAB82",262,0)
 S XDD=^DD("DD"),$P(ULINE,"_",70)="_",Y=DT
"RTN","DVBAB82",263,0)
 X XDD S DVBCDT(0)=Y,PGHD="Compensation and Pension Exam Report",DVBCSITE=$S($D(^DVB(396.1,1,0)):$P(^(0),U,1),1:"Not Specified")
"RTN","DVBAB82",264,0)
 D GO^DVBCPRNT
"RTN","DVBAB82",265,0)
 Q
"RTN","DVBAB82",266,0)
VAL ; VALIDATE PATIENT
"RTN","DVBAB82",267,0)
 I $G(DFN)="" S DVBERR=1,^TMP("DVBA",$J,1)="0^Undefined Patient IEN" G END
"RTN","DVBAB82",268,0)
 S DIC=2,DIC(0)="NZX",X=DFN D ^DIC
"RTN","DVBAB82",269,0)
 I Y<0 S DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid Patient Name." G END
"RTN","DVBAB82",270,0)
 Q
"RTN","DVBAB82",271,0)
 ;
"RTN","DVBAB82",272,0)
VALDATE(DVBADTE) ;Validate Date
"RTN","DVBAB82",273,0)
 ;dates must be valid internal FileMan format
"RTN","DVBAB82",274,0)
 N X,Y,%DT
"RTN","DVBAB82",275,0)
 S %DT="X",X=DVBADTE D ^%DT
"RTN","DVBAB82",276,0)
 S:(Y=-1) DVBERR=1,^TMP("DVBA",$J,1)="0^Invalid FileMan formatted date."
"RTN","DVBAB82",277,0)
 Q
"RTN","DVBAB82",278,0)
 ;
"RTN","DVBAB82",279,0)
CNHDEOC ; Report #10 - FBCNH Display Episode of Care
"RTN","DVBAB82",280,0)
 ; Parameters
"RTN","DVBAB82",281,0)
 ; ==========
"RTN","DVBAB82",282,0)
 ;   DFN : IEN in PATIENT (#2) file
"RTN","DVBAB82",283,0)
 ;   IFN : IEN in FEE CNH ACTIVITY (#162.3) file
"RTN","DVBAB82",284,0)
 ;
"RTN","DVBAB82",285,0)
 U IO
"RTN","DVBAB82",286,0)
 N DFN,IFN
"RTN","DVBAB82",287,0)
 S DFN=$P(PARM,U,1),IFN=$P(PARM,U,2)
"RTN","DVBAB82",288,0)
 D ^FBNHDEC  ;DBIA#: 5566
"RTN","DVBAB82",289,0)
 Q
"RTN","DVBAB82",290,0)
 ;
"RTN","DVBAB82",291,0)
CNHRP ; Report #11 - FBCNH Roster Print
"RTN","DVBAB82",292,0)
 ; Parameters
"RTN","DVBAB82",293,0)
 ; ==========
"RTN","DVBAB82",294,0)
 ;   DVBADLMTD : 0 (Standard) or 1 (Delimited)
"RTN","DVBAB82",295,0)
 ; 
"RTN","DVBAB82",296,0)
 U IO
"RTN","DVBAB82",297,0)
 S DVBADLMTD=+$P($G(PARM),U)
"RTN","DVBAB82",298,0)
 D START^FBNHROS  ;DBIA#: 5566
"RTN","DVBAB82",299,0)
 Q
"RTN","DVBAB82",300,0)
 ;
"RTN","DVBAB82",301,0)
CNHRAD ; Report #12 - FBCNH Report of Admissions/Discharges
"RTN","DVBAB82",302,0)
 ; Parameters
"RTN","DVBAB82",303,0)
 ; ==========
"RTN","DVBAB82",304,0)
 ;   BEGDATE   : Start date in FM format
"RTN","DVBAB82",305,0)
 ;   ENDDATE   : End date in FM format
"RTN","DVBAB82",306,0)
 ;   DVBADLMTD : 0 (Standard) or 1 (Delimited)
"RTN","DVBAB82",307,0)
 ;
"RTN","DVBAB82",308,0)
 U IO
"RTN","DVBAB82",309,0)
 N BEGDATE,ENDDATE
"RTN","DVBAB82",310,0)
 S BEGDATE=$P(PARM,U,1),ENDDATE=$P(PARM,U,2)
"RTN","DVBAB82",311,0)
 S DVBADLMTD=+$P(PARM,U,3)
"RTN","DVBAB82",312,0)
 D VALDATE(BEGDATE),VALDATE(ENDDATE)
"RTN","DVBAB82",313,0)
 D:('+DVBERR) START^FBNHAMIE  ;DBIA#: 5566
"RTN","DVBAB82",314,0)
 Q
"RTN","DVBAB82",315,0)
 ;
"RTN","DVBAB82",316,0)
CNHSE90D ; Report #13 - FBCNH Stays in Excess of 90 Days
"RTN","DVBAB82",317,0)
 ; Parameters
"RTN","DVBAB82",318,0)
 ; ==========
"RTN","DVBAB82",319,0)
 ;   FBDT      : Effective date in FM format
"RTN","DVBAB82",320,0)
 ;   DVBADLMTD : 0 (Standard) or 1 (Delimited)
"RTN","DVBAB82",321,0)
 ;
"RTN","DVBAB82",322,0)
 U IO
"RTN","DVBAB82",323,0)
 N FBDT
"RTN","DVBAB82",324,0)
 S FBDT=$P(PARM,U,1),DVBADLMTD=+$P(PARM,U,2)
"RTN","DVBAB82",325,0)
 D VALDATE(FBDT)
"RTN","DVBAB82",326,0)
 D:('+DVBERR) START^FBNHAMI2  ;DBIA#: 5566
"RTN","DVBAB82",327,0)
 Q
"RTN","DVBAB82",328,0)
 ;
"RTN","DVBAB82",329,0)
HFS() ; -- get hfs file name
"RTN","DVBAB82",330,0)
 N H
"RTN","DVBAB82",331,0)
 S H=$H
"RTN","DVBAB82",332,0)
 Q "DVBA_"_$J_"_"_$P(H,",")_"_"_$P(H,",",2)_".DAT"
"RTN","DVBAB82",333,0)
 ;
"RTN","DVBAB82",334,0)
HFSOPEN(HANDLE,DVBHFS,DVBMODE) ; Open File
"RTN","DVBAB82",335,0)
 S DVBDIRY=$$GET^XPAR("DIV","DVB HFS SCRATCH")
"RTN","DVBAB82",336,0)
 ;I DVBDIRY="" S ECERR=1 D  Q
"RTN","DVBAB82",337,0)
 ;. S ^TMP("DVBA",$J,1)="0^A scratch directory for reports doesn't exist"
"RTN","DVBAB82",338,0)
 D OPEN^%ZISH(HANDLE,,DVBHFS,$G(DVBMODE,"W")) D:POP  Q:POP
"RTN","DVBAB82",339,0)
 .S DVBERR=1,^TMP("DVBA",$J,1)="0^Unable to open file "
"RTN","DVBAB82",340,0)
 S IOF="$$IOF^DVBAB82"   ;resets screen position and adds page break flag - added to deal with Linux environments.
"RTN","DVBAB82",341,0)
 Q
"RTN","DVBAB82",342,0)
 ;
"RTN","DVBAB82",343,0)
HFSCLOSE(HANDLE,DVBHFS) ;Close HFS and unload data
"RTN","DVBAB82",344,0)
 N DVBDEL,X,%ZIS
"RTN","DVBAB82",345,0)
 D CLOSE^%ZISH(HANDLE)
"RTN","DVBAB82",346,0)
 S ROOT=$NA(^TMP("DVBA",$J,1)),DVBDEL(DVBHFS)=""
"RTN","DVBAB82",347,0)
 K:('+DVBERR) @ROOT
"RTN","DVBAB82",348,0)
 S X=$$FTG^%ZISH(,DVBHFS,$NA(@ROOT@(1)),4)
"RTN","DVBAB82",349,0)
 S X=$$DEL^%ZISH(,$NA(DVBDEL))
"RTN","DVBAB82",350,0)
 Q
"RTN","DVBAB82",351,0)
 ;
"RTN","DVBAB82",352,0)
IOF() ;used to reset position and insert page break flag when @IOF is executed.
"RTN","DVBAB82",353,0)
 S $X=0,$Y=0
"RTN","DVBAB82",354,0)
 Q "##FFFF##"_$C(13,10)
"RTN","DVBAB82",355,0)
 ;
"RTN","DVBAB82",356,0)
REQSTAT ; Report #14 - Request Status by Date Range
"RTN","DVBAB82",357,0)
 ; Parameters
"RTN","DVBAB82",358,0)
 ; ==========
"RTN","DVBAB82",359,0)
 ; BEGDAT        : Start date in FM format
"RTN","DVBAB82",360,0)
 ; ENDDAT        : End date in FM format
"RTN","DVBAB82",361,0)
 ; REQSTAT       : Request Status filter
"RTN","DVBAB82",362,0)
 ; ISDELIM       : 0 (Standard format); 1 (Delimited format)
"RTN","DVBAB82",363,0)
 ; ISNODT        : 0 (Use date range); 1 (Ignore date range)
"RTN","DVBAB82",364,0)
 U IO
"RTN","DVBAB82",365,0)
 N BEGDAT,ENDDAT,REQSTAT
"RTN","DVBAB82",366,0)
 S BEGDAT=$P(PARM,U,1),ENDDAT=$P(PARM,U,2)
"RTN","DVBAB82",367,0)
 S REQSTAT=$P(PARM,U,3),ISDELIM=$P(PARM,U,4),ISNODT=$P(PARM,U,5)
"RTN","DVBAB82",368,0)
 D VALDATE(BEGDAT),VALDATE(ENDDAT)
"RTN","DVBAB82",369,0)
 D:('+DVBERR) REQSTAT^DVBARSBD(BEGDAT,ENDDAT,REQSTAT,ISDELIM,ISNODT)
"RTN","DVBAB82",370,0)
 Q
"RTN","DVBAB82",371,0)
 ;
"RTN","DVBAB82",372,0)
DVBA8861 ; Report #15 - Form 28-8861 Status Report
"RTN","DVBAB82",373,0)
 ; Parameters
"RTN","DVBAB82",374,0)
 ; ==========
"RTN","DVBAB82",375,0)
 ; BEGDAT  -  Start date in FM format
"RTN","DVBAB82",376,0)
 ; ENDDAT  -  End date in FM format
"RTN","DVBAB82",377,0)
 ; ROSTAT  -  Regional Office filter
"RTN","DVBAB82",378,0)
 ; REQSTAT -  Request Status filter
"RTN","DVBAB82",379,0)
 ; DELIMTER - 0 (Standard format); 1 (Delimited format)
"RTN","DVBAB82",380,0)
 ;
"RTN","DVBAB82",381,0)
 U IO
"RTN","DVBAB82",382,0)
 N BEGDAT,ENDDAT,REQSTAT
"RTN","DVBAB82",383,0)
 S BEGDAT=$P(PARM,U,1),ENDDAT=$P(PARM,U,2)
"RTN","DVBAB82",384,0)
 S ROSTAT=$P(PARM,U,3),REQSTAT=$P(PARM,U,4),DELIMTER=$P(PARM,U,5)
"RTN","DVBAB82",385,0)
 D VALDATE(BEGDAT),VALDATE(ENDDAT)
"RTN","DVBAB82",386,0)
 D:('+DVBERR) STATRPT^DVBA8861(BEGDAT,ENDDAT,ROSTAT,REQSTAT,DELIMTER)
"RTN","DVBAB82",387,0)
 Q
"RTN","DVBAVRX1")
0^21^B93466397^B93077870
"RTN","DVBAVRX1",1,0)
DVBAVRX1 ;ALB/GAK - CAPRI BACKGROUND JOB2 AND RPC ENTRY POINT FOR VOCREHAB ;06/21/2012 12:00pm
"RTN","DVBAVRX1",2,0)
 ;;2.7;AMIE;**181,184**;Apr 10, 1995;Build 10
"RTN","DVBAVRX1",3,0)
 ;
"RTN","DVBAVRX1",4,0)
 Q  ;NO DIRECT ENTRY
"RTN","DVBAVRX1",5,0)
 ;
"RTN","DVBAVRX1",6,0)
 ; RUN FROM TASK MANAGER (BACKGROUND BATCH JOB)
"RTN","DVBAVRX1",7,0)
 ; BACKGROUND JOB SHOULD BE RUN ON SAME DAY AS DATA ENTRY AT THE END OF THE BUSINESS DAY
"RTN","DVBAVRX1",8,0)
 ; CALL INDIVIDUAL TAGS FROM RPC (MAILMAN NOTIFY - REALTIME)
"RTN","DVBAVRX1",9,0)
 ;
"RTN","DVBAVRX1",10,0)
 ;FOR BUILD:
"RTN","DVBAVRX1",11,0)
 ;   MAILMAN GROUP -> "DVBA VR VOCREHAB PERSONNEL"
"RTN","DVBAVRX1",12,0)
 ;   OPTION FILE OPTION -> "DVBA VR BACKGROUND"
"RTN","DVBAVRX1",13,0)
 ;   RPC -> NEW REQUEST
"RTN","DVBAVRX1",14,0)
 ;   RPC -> CANCELLED REQUEST
"RTN","DVBAVRX1",15,0)
 ;   RPC -> COMPLETED REQUEST
"RTN","DVBAVRX1",16,0)
 ;   RPC -> PENDING REQUEST
"RTN","DVBAVRX1",17,0)
 ;
"RTN","DVBAVRX1",18,0)
EN ; TASKMAN ENTER POINT FOR BACKGROUND JOB
"RTN","DVBAVRX1",19,0)
 ;
"RTN","DVBAVRX1",20,0)
 D JOB1^DVBAVRX2   ; For "N"ew status based on the INDEX - age entries and alert users of un-linked requests.  
"RTN","DVBAVRX1",21,0)
 D JOB2   ; LOOK AT STATUS OF FILE 123 --> 100.01 AND WORK MAIL NOTIFICATIONS
"RTN","DVBAVRX1",22,0)
 ;
"RTN","DVBAVRX1",23,0)
 Q
"RTN","DVBAVRX1",24,0)
 ;
"RTN","DVBAVRX1",25,0)
JOB2 ;JOB 2 WILL LOOK AT STATUS OF CONSULTS LINKED TO 8861
"RTN","DVBAVRX1",26,0)
 ;   WHEN ALL CONSULTS AS CANCELLED - FORM 8861 WILL BE CANCELLED
"RTN","DVBAVRX1",27,0)
 ;   WHEN A CONSULT IS COMPLETED AND IS THE ONLY CONSULT LINKED TO THE FORM - FORM 8861 WILL BE COMPLETED
"RTN","DVBAVRX1",28,0)
 ;   WHEN A CONSULT IS COMPLETED AND ALL OTHER CONSULTS ARE COMPLETE OR CANCLLED - FORM 8861 WILL BE COMPLETED
"RTN","DVBAVRX1",29,0)
 ;
"RTN","DVBAVRX1",30,0)
 N %H,DAT,X,J
"RTN","DVBAVRX1",31,0)
 N DVBADAT,DVBAIEN,DVBAIENX
"RTN","DVBAVRX1",32,0)
 N DVBACARY   ;CONSULTS ARRAY
"RTN","DVBAVRX1",33,0)
 N DVBACERR   ;CONSULTS GETS ERROR ARRAY
"RTN","DVBAVRX1",34,0)
 N DVBAIENT   ;IEN OF FORM 8831 CONTAINED IN THE CONSULTS ARRAY (TOP)
"RTN","DVBAVRX1",35,0)
 N DVBAMLTN   ;SEQUENCE NUMBER OF FORM 8861 MULTI CONTAINED IN THE CONSULTS ARRAY (MULTI SEQUENTIAL NUMBER)
"RTN","DVBAVRX1",36,0)
 N DVBATMP1   ;TEMP ARRAY 1 - CONSULTS MULTI
"RTN","DVBAVRX1",37,0)
 N DVBARCST   ;CONSULT/REQUEST STATUS --> 100.01,.001
"RTN","DVBAVRX1",38,0)
 N DVBAVRST   ;VOCREHAB STATUS OF MULTI (396.914,.02)
"RTN","DVBAVRX1",39,0)
 N DVBARKEY   ;REVERSE THE IEN KEYS AGAIN
"RTN","DVBAVRX1",40,0)
 N DVBACC     ;ARRAY FOR CANCELLED / COMPLETE LOGIC
"RTN","DVBAVRX1",41,0)
 N DVBAFDA    ;UPDATE API ARRAY
"RTN","DVBAVRX1",42,0)
 N DVBATD     ;TODAY'S DATE
"RTN","DVBAVRX1",43,0)
 N DVBACAN,DVBACOM
"RTN","DVBAVRX1",44,0)
 ;
"RTN","DVBAVRX1",45,0)
 S DVBADAT="" F  S DVBADAT=$O(^DVB(396.9,"ARSDT","P",DVBADAT)) Q:DVBADAT=""  D
"RTN","DVBAVRX1",46,0)
 . S DVBAIEN="" F  S DVBAIEN=$O(^DVB(396.9,"ARSDT","P",DVBADAT,DVBAIEN)) Q:DVBAIEN=""  D
"RTN","DVBAVRX1",47,0)
 .. ;GET CONSULT INFO AND BUILD CONSULT ARRAY
"RTN","DVBAVRX1",48,0)
 .. K DVBATMP1
"RTN","DVBAVRX1",49,0)
 .. K DVBACARY
"RTN","DVBAVRX1",50,0)
 .. D GETS^DIQ(396.9,DVBAIEN,"14*","IE","DVBACARY","DVBACERR")
"RTN","DVBAVRX1",51,0)
 .. S J="" F  S J=$O(DVBACARY(396.914,J)) Q:J=""  D
"RTN","DVBAVRX1",52,0)
 ... S DVBAIENT=$P(J,",",2)   ;SHOULD ALWAYS BE THE SAME AS IEN
"RTN","DVBAVRX1",53,0)
 ... S DVBAMLTN=$P(J,",",1)
"RTN","DVBAVRX1",54,0)
 ... ;BUILD TEMP ARRAY OF MULTI
"RTN","DVBAVRX1",55,0)
 ... S DVBATMP1(DVBAIENT,DVBAMLTN,.01,"I")=$G(DVBACARY(396.914,J,.01,"I"))
"RTN","DVBAVRX1",56,0)
 ... S DVBATMP1(DVBAIENT,DVBAMLTN,.02,"I")=$G(DVBACARY(396.914,J,.02,"I"))
"RTN","DVBAVRX1",57,0)
 .. ;WORK TEMP ARRAY
"RTN","DVBAVRX1",58,0)
 .. ;$P1 = VALUE FORM FORM ARRAY ^ $P2 = VALUE FROM CONSULTS -> STATUS #123; field 8 (internal value)
"RTN","DVBAVRX1",59,0)
 .. S DVBAIENT=""
"RTN","DVBAVRX1",60,0)
 .. K DVBACC
"RTN","DVBAVRX1",61,0)
 .. F  S DVBAIENT=$O(DVBATMP1(DVBAIENT)) Q:DVBAIENT=""  D
"RTN","DVBAVRX1",62,0)
 ... S DVBAMLTN=""
"RTN","DVBAVRX1",63,0)
 ... F  S DVBAMLTN=$O(DVBATMP1(DVBAIENT,DVBAMLTN)) Q:DVBAMLTN=""  D
"RTN","DVBAVRX1",64,0)
 .... S DVBARKEY=DVBAMLTN_","_DVBAIENT
"RTN","DVBAVRX1",65,0)
 .... S DVBAVRST=$$GET1^DIQ(396.914,DVBARKEY,.02,"I")
"RTN","DVBAVRX1",66,0)
 .... ;ICR #4110 
"RTN","DVBAVRX1",67,0)
 .... S DVBAIENX=DVBATMP1(DVBAIENT,DVBAMLTN,.01,"I")
"RTN","DVBAVRX1",68,0)
 .... S DVBARCST=$$GET1^DIQ(123,DVBAIENX,8,"I")   ;IEN OF THE 123 FILE VR IS POINTING TO
"RTN","DVBAVRX1",69,0)
 .... ;
"RTN","DVBAVRX1",70,0)
 .... I DVBARCST=1 S DVBACC(DVBARCST)=""
"RTN","DVBAVRX1",71,0)
 .... I DVBARCST=2 S DVBACC(DVBARCST)=""
"RTN","DVBAVRX1",72,0)
 .... I DVBARCST'=1&(DVBARCST'=2) S DVBACC(0)=""
"RTN","DVBAVRX1",73,0)
 .... ;
"RTN","DVBAVRX1",74,0)
 .... I DVBARCST'=DVBAVRST D   ;UPDATE VOCREHAB LAST STATUS
"RTN","DVBAVRX1",75,0)
 ..... K DVBAFDA
"RTN","DVBAVRX1",76,0)
 ..... S DVBAFDA(1,396.914,DVBARKEY_",",.02)=DVBARCST
"RTN","DVBAVRX1",77,0)
 ..... ;IRC #875 - points to 100.01
"RTN","DVBAVRX1",78,0)
 ..... D UPDATE^DIE("","DVBAFDA(1)","","DVBAUERR")
"RTN","DVBAVRX1",79,0)
 ..... I $D(DVBAUERR) Q
"RTN","DVBAVRX1",80,0)
 ... S DVBACOM=0 ;COMPLETED SWITCH
"RTN","DVBAVRX1",81,0)
 ... S DVBACAN=0 ;CANCELLED SWITCH
"RTN","DVBAVRX1",82,0)
 ... D   ;multi logic, should it ever be needed
"RTN","DVBAVRX1",83,0)
 .... I $D(DVBACC(0)) Q
"RTN","DVBAVRX1",84,0)
 .... I $D(DVBACC(1))&($D(DVBACC(2))) S DVBACOM=1 Q
"RTN","DVBAVRX1",85,0)
 .... I $D(DVBACC(1)) S DVBACAN=1 Q
"RTN","DVBAVRX1",86,0)
 .... I $D(DVBACC(2)) S DVBACOM=1 Q
"RTN","DVBAVRX1",87,0)
 ... I DVBACAN=1 D
"RTN","DVBAVRX1",88,0)
 .... K DVBAFDA,DVBAUERR
"RTN","DVBAVRX1",89,0)
 .... S DVBAFDA(1,396.9,DVBAIENT_",",13)="X"
"RTN","DVBAVRX1",90,0)
 .... K %H,DAT,X
"RTN","DVBAVRX1",91,0)
 .... S (%H,DAT)=+$H D YMD^%DTC   ;CONVERT $H TO FILEMAN DATE
"RTN","DVBAVRX1",92,0)
 .... S DVBAFDA(1,396.9,DVBAIENT_",",15)=X
"RTN","DVBAVRX1",93,0)
 .... S DVBAFDA(1,396.9,DVBAIENT_",",16)="OTH"
"RTN","DVBAVRX1",94,0)
 .... D UPDATE^DIE("","DVBAFDA(1)","","DVBAUERR")
"RTN","DVBAVRX1",95,0)
 .... I $D(DVBAUERR) Q
"RTN","DVBAVRX1",96,0)
 .... D RPCIN(DVBAIEN,"CAN")
"RTN","DVBAVRX1",97,0)
 ... I DVBACOM=1 D
"RTN","DVBAVRX1",98,0)
 .... K DVBAFDA,DVBAUERR
"RTN","DVBAVRX1",99,0)
 .... S DVBAFDA(1,396.9,DVBAIENT_",",13)="C"
"RTN","DVBAVRX1",100,0)
 .... K %H,DAT,X
"RTN","DVBAVRX1",101,0)
 .... S (%H,DAT)=+$H D YMD^%DTC   ;CONVERT $H TO FILEMAN DATE
"RTN","DVBAVRX1",102,0)
 .... S DVBAFDA(1,396.9,DVBAIENT_",",2)=X
"RTN","DVBAVRX1",103,0)
 .... D UPDATE^DIE("","DVBAFDA(1)","","DVBAUERR")
"RTN","DVBAVRX1",104,0)
 .... I $D(DVBAUERR) Q
"RTN","DVBAVRX1",105,0)
 .... D RPCIN(DVBAIEN,"COM")
"RTN","DVBAVRX1",106,0)
 ;
"RTN","DVBAVRX1",107,0)
 Q
"RTN","DVBAVRX1",108,0)
 ;
"RTN","DVBAVRX1",109,0)
RPCIN(DVBAFIEN,DVBATYPE) ;ENTER (IN) POINT FOR RPC CALLS
"RTN","DVBAVRX1",110,0)
 ;
"RTN","DVBAVRX1",111,0)
 ;Parameters Passed In
"RTN","DVBAVRX1",112,0)
 ;DVBAFIEN   The IEN of the 8861 Form
"RTN","DVBAVRX1",113,0)
 ;DVBATYPE   The type of the mailman message to be sent
"RTN","DVBAVRX1",114,0)
 ;           'NEW'
"RTN","DVBAVRX1",115,0)
 ;           'PENDING'
"RTN","DVBAVRX1",116,0)
 ;           'CANCELLED'
"RTN","DVBAVRX1",117,0)
 ;
"RTN","DVBAVRX1",118,0)
 N XMDUZ,DVBADUZ
"RTN","DVBAVRX1",119,0)
 ;
"RTN","DVBAVRX1",120,0)
 I '$D(DUZ) Q
"RTN","DVBAVRX1",121,0)
 ;
"RTN","DVBAVRX1",122,0)
 S XMDUZ=$P(^VA(200,DUZ,0),"^",1)_" CAPRI"
"RTN","DVBAVRX1",123,0)
 S DVBADUZ=DUZ
"RTN","DVBAVRX1",124,0)
 ;
"RTN","DVBAVRX1",125,0)
 I DVBATYPE="NEW" D NFY(DVBAFIEN,"NEW") Q
"RTN","DVBAVRX1",126,0)
 I DVBATYPE="PND" D NFY(DVBAFIEN,"PND") Q
"RTN","DVBAVRX1",127,0)
 I DVBATYPE="COM" D NFY(DVBAFIEN,"COM") Q
"RTN","DVBAVRX1",128,0)
 I DVBATYPE="CAN" D NFY(DVBAFIEN,"CAN") Q
"RTN","DVBAVRX1",129,0)
 ;
"RTN","DVBAVRX1",130,0)
 Q
"RTN","DVBAVRX1",131,0)
 ;
"RTN","DVBAVRX1",132,0)
NFY(DVBAFIEN,DVBATYPE) ;SETUP MAILMAN MESSAGE BASED ON REQUEST FORM IEN
"RTN","DVBAVRX1",133,0)
 ;D GETS^DIQ TO POPULATE REQUEST INFO
"RTN","DVBAVRX1",134,0)
 ;
"RTN","DVBAVRX1",135,0)
 N Y,%H,%
"RTN","DVBAVRX1",136,0)
 N XMSUB,XMTEXT,XMY,XMDUN,XMZ,XMMG
"RTN","DVBAVRX1",137,0)
 N DVBAFARY,DVBAFERR,DVBASTT,DVBAVRRA,DVBAGERR
"RTN","DVBAVRX1",138,0)
 N DVBAPOC,DVBARDAT,DVBAPDFN,DVBAPNAM,DVBARSTT,DVBASNTL,DVBAXIEN
"RTN","DVBAVRX1",139,0)
 N DVBAMMT,DVBAEMA
"RTN","DVBAVRX1",140,0)
 N DVBANXLN,DVBAXXEN
"RTN","DVBAVRX1",141,0)
 N C,D,D0,DA,DI,DIC,DIE,DILOCKTM,DISYS,DQ,DR,X
"RTN","DVBAVRX1",142,0)
 ;
"RTN","DVBAVRX1",143,0)
 N DUZ
"RTN","DVBAVRX1",144,0)
 S DUZ=.5   ;POSTMASTER
"RTN","DVBAVRX1",145,0)
 ;SINCE MAILMAN DOES NOT ALLOW MESSAGES TO BE SENT FROM USERS WITHOUT ACCESS CODES OR MAILBOXES
"RTN","DVBAVRX1",146,0)
 ;WHICH CAPRI REMOTE USER DO NOT HAVE, WE HAVE TO NEW DUZ AND CHANGE XMDUZ TO THE NAME OF THE USER
"RTN","DVBAVRX1",147,0)
 ;AS A STRING SO THE PROCESS IS STILL LINKED TO THE USER SENDING/TRIGGERING THE MESSAGE
"RTN","DVBAVRX1",148,0)
 ;
"RTN","DVBAVRX1",149,0)
 D GETS^DIQ(396.9,DVBAFIEN,"*","IE","DVBAFARY","DVBAFERR")
"RTN","DVBAVRX1",150,0)
 I $D(DVBAFERR) Q
"RTN","DVBAVRX1",151,0)
 ;
"RTN","DVBAVRX1",152,0)
 S DVBAPOC=$G(DVBAFARY(396.9,DVBAFIEN_",",11,"I"))
"RTN","DVBAVRX1",153,0)
 S DVBARDAT=$G(DVBAFARY(396.9,DVBAFIEN_",",.01,"E"))
"RTN","DVBAVRX1",154,0)
 S DVBAPDFN=$G(DVBAFARY(396.9,DVBAFIEN_",",4,"I"))
"RTN","DVBAVRX1",155,0)
 S DVBARSTT=$G(DVBAFARY(396.9,DVBAFIEN_",",13,"E"))
"RTN","DVBAVRX1",156,0)
 S DVBASNTL=$G(DVBAFARY(396.9,DVBAFIEN_",",1,"E"))
"RTN","DVBAVRX1",157,0)
 ;
"RTN","DVBAVRX1",158,0)
 S %H=$H D YX^%DTC S X=X_% S DVBASTT=$$FMTE^XLFDT(X,"5FPZ")
"RTN","DVBAVRX1",159,0)
 S XMSUB="CAPRI: Chapter 31 Referral for Medical Services New"
"RTN","DVBAVRX1",160,0)
 ;
"RTN","DVBAVRX1",161,0)
 S XMY("G.DVBA VR VOCREHAB PERSONNEL")=""
"RTN","DVBAVRX1",162,0)
 S DVBAEMA="DVBA VR VOCREHAB PERSONNEL"
"RTN","DVBAVRX1",163,0)
 ;
"RTN","DVBAVRX1",164,0)
 I DVBATYPE="NEW" D XNEW
"RTN","DVBAVRX1",165,0)
 I DVBATYPE="PND" D XPND
"RTN","DVBAVRX1",166,0)
 I DVBATYPE="COM" D XCOM
"RTN","DVBAVRX1",167,0)
 I DVBATYPE="CAN" D XCAN
"RTN","DVBAVRX1",168,0)
 ;
"RTN","DVBAVRX1",169,0)
 Q:DVBATYPE="NEW"
"RTN","DVBAVRX1",170,0)
 ;
"RTN","DVBAVRX1",171,0)
 K XMY
"RTN","DVBAVRX1",172,0)
 ;
"RTN","DVBAVRX1",173,0)
 S DVBAXXEN=DVBAFARY(396.9,DVBAFIEN_",",11,"I")
"RTN","DVBAVRX1",174,0)
 S DVBAVRRA=$$GET1^DIQ(200,DVBAXXEN,.151,"","","DVBAGERR")
"RTN","DVBAVRX1",175,0)
 I $D(DVBAGERR) Q
"RTN","DVBAVRX1",176,0)
 S DVBAEMA=DVBAVRRA
"RTN","DVBAVRX1",177,0)
 I DVBAEMA="" Q
"RTN","DVBAVRX1",178,0)
 S XMY(DVBAEMA)=""
"RTN","DVBAVRX1",179,0)
 ;
"RTN","DVBAVRX1",180,0)
 I DVBATYPE="PND" D XPND
"RTN","DVBAVRX1",181,0)
 I DVBATYPE="COM" D XCOM
"RTN","DVBAVRX1",182,0)
 I DVBATYPE="CAN" D XCAN
"RTN","DVBAVRX1",183,0)
 ;
"RTN","DVBAVRX1",184,0)
 Q
"RTN","DVBAVRX1",185,0)
 ;
"RTN","DVBAVRX1",186,0)
XNEW ;
"RTN","DVBAVRX1",187,0)
 ;
"RTN","DVBAVRX1",188,0)
 S XMSUB="CAPRI: Chapter 31 Referral for Medical Services New"
"RTN","DVBAVRX1",189,0)
 S XMTEXT="DVBAMMT("
"RTN","DVBAVRX1",190,0)
 S DVBAMMT(1)="Sent: "_DVBASTT
"RTN","DVBAVRX1",191,0)
 S DVBAMMT(2)="To: "_DVBAEMA
"RTN","DVBAVRX1",192,0)
 S DVBAMMT(3)="Subject: "_XMSUB
"RTN","DVBAVRX1",193,0)
 S DVBAMMT(4)=""
"RTN","DVBAVRX1",194,0)
 S DVBAMMT(5)="The following veteran has a New Chapter 31, FORM 28-8861"
"RTN","DVBAVRX1",195,0)
 S DVBAMMT(6)=""
"RTN","DVBAVRX1",196,0)
 S DVBANXLN=""
"RTN","DVBAVRX1",197,0)
 S DVBANXLN=DVBANXLN_"DFN: `"_DVBAPDFN_$E("            ",1,12-$L(DVBAPDFN))_" "
"RTN","DVBAVRX1",198,0)
 S DVBANXLN=DVBANXLN_"Request Date: "_DVBARDAT
"RTN","DVBAVRX1",199,0)
 S DVBAMMT(7)=DVBANXLN
"RTN","DVBAVRX1",200,0)
 S DVBAMMT(10)=""
"RTN","DVBAVRX1",201,0)
 S DVBAMMT(11)="**NOTE: To view the patient using the DFN, paste the DFN number into the"
"RTN","DVBAVRX1",202,0)
 S DVBAMMT(12)="CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to"
"RTN","DVBAVRX1",203,0)
 S DVBAMMT(13)="include the ' (backward-apostrophe) character."
"RTN","DVBAVRX1",204,0)
 ;
"RTN","DVBAVRX1",205,0)
 D XMZ^XMA2
"RTN","DVBAVRX1",206,0)
 D ^XMD
"RTN","DVBAVRX1",207,0)
 ;
"RTN","DVBAVRX1",208,0)
 Q
"RTN","DVBAVRX1",209,0)
 ;
"RTN","DVBAVRX1",210,0)
XCOM ;
"RTN","DVBAVRX1",211,0)
 ;
"RTN","DVBAVRX1",212,0)
 S XMSUB="CAPRI: Chapter 31 Referral for Medical Services Completed"
"RTN","DVBAVRX1",213,0)
 S XMTEXT="DVBAMMT("
"RTN","DVBAVRX1",214,0)
 S DVBAMMT(1)="Sent: "_DVBASTT
"RTN","DVBAVRX1",215,0)
 S DVBAMMT(2)="To: "_DVBAEMA
"RTN","DVBAVRX1",216,0)
 S DVBAMMT(3)="Subject: "_XMSUB
"RTN","DVBAVRX1",217,0)
 S DVBAMMT(4)=""
"RTN","DVBAVRX1",218,0)
 S DVBAMMT(5)="The following veteran has a Completed Chapter 31, FORM 28-8861"
"RTN","DVBAVRX1",219,0)
 S DVBAMMT(6)=""
"RTN","DVBAVRX1",220,0)
 S DVBANXLN=""
"RTN","DVBAVRX1",221,0)
 S DVBANXLN=DVBANXLN_"DFN: `"_DVBAPDFN_$E("            ",1,12-$L(DVBAPDFN))_" "
"RTN","DVBAVRX1",222,0)
 S DVBANXLN=DVBANXLN_"Request Date: "_DVBARDAT
"RTN","DVBAVRX1",223,0)
 S DVBAMMT(7)=DVBANXLN
"RTN","DVBAVRX1",224,0)
 S DVBAMMT(10)=""
"RTN","DVBAVRX1",225,0)
 S DVBAMMT(11)="**NOTE: To view the patient using the DFN, paste the DFN number into the"
"RTN","DVBAVRX1",226,0)
 S DVBAMMT(12)="CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to"
"RTN","DVBAVRX1",227,0)
 S DVBAMMT(13)="include the ' (backward-apostrophe) character."
"RTN","DVBAVRX1",228,0)
 ;
"RTN","DVBAVRX1",229,0)
 ;CALL FUNCTION TO BUILD A 'TEXT TO DISPLAY' ARRAY OF CONSULTS
"RTN","DVBAVRX1",230,0)
 ;
"RTN","DVBAVRX1",231,0)
 D XMZ^XMA2
"RTN","DVBAVRX1",232,0)
 D ^XMD
"RTN","DVBAVRX1",233,0)
 ;
"RTN","DVBAVRX1",234,0)
 Q
"RTN","DVBAVRX1",235,0)
 ;
"RTN","DVBAVRX1",236,0)
XCAN ;
"RTN","DVBAVRX1",237,0)
 ;
"RTN","DVBAVRX1",238,0)
 S XMSUB="CAPRI: Chapter 31 Referral for Medical Services Cancelled"
"RTN","DVBAVRX1",239,0)
 S XMTEXT="DVBAMMT("
"RTN","DVBAVRX1",240,0)
 S DVBAMMT(1)="Sent: "_DVBASTT
"RTN","DVBAVRX1",241,0)
 S DVBAMMT(2)="To: "_DVBAEMA
"RTN","DVBAVRX1",242,0)
 S DVBAMMT(3)="Subject: "_XMSUB
"RTN","DVBAVRX1",243,0)
 S DVBAMMT(4)=""
"RTN","DVBAVRX1",244,0)
 S DVBAMMT(5)="The following veteran has a Cancelled Chapter 31, FORM 28-8861"
"RTN","DVBAVRX1",245,0)
 S DVBAMMT(6)=""
"RTN","DVBAVRX1",246,0)
 S DVBANXLN=""
"RTN","DVBAVRX1",247,0)
 S DVBANXLN=DVBANXLN_"DFN: `"_DVBAPDFN_$E("            ",1,12-$L(DVBAPDFN))_" "
"RTN","DVBAVRX1",248,0)
 S DVBANXLN=DVBANXLN_"Request Date: "_DVBARDAT
"RTN","DVBAVRX1",249,0)
 S DVBAMMT(7)=DVBANXLN
"RTN","DVBAVRX1",250,0)
 S DVBAMMT(10)=""
"RTN","DVBAVRX1",251,0)
 S DVBAMMT(11)="**NOTE: To view the patient using the DFN, paste the DFN number into the"
"RTN","DVBAVRX1",252,0)
 S DVBAMMT(12)="CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to"
"RTN","DVBAVRX1",253,0)
 S DVBAMMT(13)="include the ' (backward-apostrophe) character."
"RTN","DVBAVRX1",254,0)
 ;CALL FUNCTION TO BUILD A 'TEXT TO DISPLAY' ARRAY OF CONSULTS
"RTN","DVBAVRX1",255,0)
 ;
"RTN","DVBAVRX1",256,0)
 D XMZ^XMA2
"RTN","DVBAVRX1",257,0)
 D ^XMD
"RTN","DVBAVRX1",258,0)
 ;
"RTN","DVBAVRX1",259,0)
 Q
"RTN","DVBAVRX1",260,0)
 ;
"RTN","DVBAVRX1",261,0)
XPND ;
"RTN","DVBAVRX1",262,0)
 ;
"RTN","DVBAVRX1",263,0)
 S XMSUB="CAPRI: Chapter 31 Referral for Medical Services Pending"
"RTN","DVBAVRX1",264,0)
 S XMTEXT="DVBAMMT("
"RTN","DVBAVRX1",265,0)
 S DVBAMMT(1)="Sent: "_DVBASTT
"RTN","DVBAVRX1",266,0)
 S DVBAMMT(2)="To: "_DVBAEMA
"RTN","DVBAVRX1",267,0)
 S DVBAMMT(3)="Subject: "_XMSUB
"RTN","DVBAVRX1",268,0)
 S DVBAMMT(4)=""
"RTN","DVBAVRX1",269,0)
 S DVBAMMT(5)="The following veteran has a Pending Chapter 31, FORM 28-8861"
"RTN","DVBAVRX1",270,0)
 S DVBAMMT(6)=""
"RTN","DVBAVRX1",271,0)
 S DVBANXLN=""
"RTN","DVBAVRX1",272,0)
 S DVBANXLN=DVBANXLN_"DFN: `"_DVBAPDFN_$E("            ",1,12-$L(DVBAPDFN))_" "
"RTN","DVBAVRX1",273,0)
 S DVBANXLN=DVBANXLN_"Request Date: "_DVBARDAT
"RTN","DVBAVRX1",274,0)
 S DVBAMMT(7)=DVBANXLN
"RTN","DVBAVRX1",275,0)
 S DVBAMMT(10)=""
"RTN","DVBAVRX1",276,0)
 S DVBAMMT(11)="**NOTE: To view the patient using the DFN, paste the DFN number into the"
"RTN","DVBAVRX1",277,0)
 S DVBAMMT(12)="CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to"
"RTN","DVBAVRX1",278,0)
 S DVBAMMT(13)="include the ' (backward-apostrophe) character."
"RTN","DVBAVRX1",279,0)
 ;CALL FUNCTION TO BUILD A 'TEXT TO DISPLAY' ARRAY OF CONSULTS
"RTN","DVBAVRX1",280,0)
 ;
"RTN","DVBAVRX1",281,0)
 D XMZ^XMA2
"RTN","DVBAVRX1",282,0)
 D ^XMD
"RTN","DVBAVRX1",283,0)
 ;
"RTN","DVBAVRX1",284,0)
 Q
"RTN","DVBAVRX1",285,0)
 ;
"RTN","DVBAVRX1",286,0)
GEMA(IEN) ;GET #200 NEW PERSON INFO - GET EMAIL ADDRESS
"RTN","DVBAVRX1",287,0)
 N DVBAERR,DVBAEMA
"RTN","DVBAVRX1",288,0)
 ;
"RTN","DVBAVRX1",289,0)
 ; IA# 10060
"RTN","DVBAVRX1",290,0)
 S DVBAEMA=$$GET1^DIQ(200,IEN,".151","I",,"DVBAERR")
"RTN","DVBAVRX1",291,0)
 I '$D(DVBAEMA) Q 0
"RTN","DVBAVRX1",292,0)
 Q DVBAEMA
"RTN","DVBCADEX")
0^1^B8221294^B7428732
"RTN","DVBCADEX",1,0)
DVBCADEX ;ALB/GTS - 557/THM-ADD C&P EXAMS TO REQUESTS, PART 1 ; 6/28/91  9:32 AM
"RTN","DVBCADEX",2,0)
 ;;2.7;AMIE;**184**;Apr 10, 1995;Build 10
"RTN","DVBCADEX",3,0)
 ;
"RTN","DVBCADEX",4,0)
SETUP D HOME^%ZIS S FF=IOF,HD="Add a C & P Exam for",HD1="Veteran Selection",HD2="Exam selection",HD3="2507 Exam Addition"
"RTN","DVBCADEX",5,0)
 ;
"RTN","DVBCADEX",6,0)
EN ; Entry point 
"RTN","DVBCADEX",7,0)
 N DVBCARY,DVBCRDAT,DVBCSITE
"RTN","DVBCADEX",8,0)
 K DVBCLCKD D KILL W @FF,!?(IOM-$L(HD3)\2),HD3,!!?(IOM-$L(HD1)\2),HD1,!!!
"RTN","DVBCADEX",9,0)
 S DIC(0)="AEQM",DIC="^DVB(396.3,",DIC("A")="Select VETERAN NAME: "
"RTN","DVBCADEX",10,0)
 S DIC("W")="D DICW^DVBCUTIL"
"RTN","DVBCADEX",11,0)
 S:$D(DVBAROUS) DIC("S")="I $P(^(0),U,10)'=""E""" ;**DVBAROUS set by menu
"RTN","DVBCADEX",12,0)
 D ^DIC G:X=""!(X=U) EXIT
"RTN","DVBCADEX",13,0)
 S:+Y>0 EXCNT=0,(DA,REQDA)=+Y,DFN=$P(Y,U,2) I +Y<0 W "   ???",*7 H 1 G EN
"RTN","DVBCADEX",14,0)
 S X=^DVB(396.3,REQDA,0),OWNDOM=$P(X,U,22)
"RTN","DVBCADEX",15,0)
 D GETS^DIQ(396.3,REQDA,"1;2","E","DVBCARY")
"RTN","DVBCADEX",16,0)
 S DVBCRDAT=DVBCARY(396.3,REQDA_",",1,"E")
"RTN","DVBCADEX",17,0)
 S DVBCSITE=DVBCARY(396.3,REQDA_",",2,"E")
"RTN","DVBCADEX",18,0)
 I OWNDOM]"" W *7,!!,"This request is a TRANSFER IN and exams cannot be added.",!! H 3 G EN
"RTN","DVBCADEX",19,0)
 S STAT=$P(X,U,18) K NCN
"RTN","DVBCADEX",20,0)
 F DTB="X","RX","T","C","R","CT","NT" I STAT=DTB S NCN=1 Q
"RTN","DVBCADEX",21,0)
 I $D(NCN) W !!,*7,"This request has been ",$S(STAT["X":"cancelled",STAT="T":"transcribed",STAT["C":"completed",STAT="R":"released",STAT="NT":"transferred in",1:"given an incorrect status"),".",!! H 3 G EN
"RTN","DVBCADEX",22,0)
 S DTA=^DPT(DFN,0),PNAM=$P(DTA,U,1),SSN=$P(DTA,U,9),CNUM=$S($D(^DPT(DFN,.31)):$P(^(.31),U,3),1:"Unknown") S:CNUM="" CNUM="Unknown" D HDR,^DVBCEEXM W !!,"Press RETURN     " R ANS:DTIME G:'$T EXIT
"RTN","DVBCADEX",23,0)
 D ^DVBCADE2,KILL G:$D(OUT)!($D(DVBCLCKD)) EXIT
"RTN","DVBCADEX",24,0)
 G EN
"RTN","DVBCADEX",25,0)
 ;
"RTN","DVBCADEX",26,0)
EXIT K DVBCLCKD G KILL^DVBCUTIL
"RTN","DVBCADEX",27,0)
 ;
"RTN","DVBCADEX",28,0)
HDR W @FF,?(IOM-$L(HD)\2),HD,!!,"Veteran name: ",$P(PNAM,",",2,99)," ",$P(PNAM,",",1),?55,"SSN: ",SSN,!?53,"C-NUM: ",CNUM,!
"RTN","DVBCADEX",29,0)
 F LINE=1:1:IOM W "="
"RTN","DVBCADEX",30,0)
 W ! Q
"RTN","DVBCADEX",31,0)
 ;
"RTN","DVBCADEX",32,0)
KILL K CNUM,DFN,DIK,DR,DTA,DXCOD,DXNUM,EDIT,EX,EXMNM,FMT,PNAM,SSN,PCT,SC,REQDA,CTIM,VX,JY,JJ,X,%,^TMP($J),Y,DA,DIC,DIE,ANS,%Y,%,DTOUT,DUOUT,TEMP,DVBCCONT
"RTN","DVBCADEX",33,0)
 K DVBAINDA,DVBCARY,DVBCRDAT,DVBCSITE
"RTN","DVBCADEX",34,0)
 Q
"RTN","DVBCAMI1")
0^11^B11567744^B11579821
"RTN","DVBCAMI1",1,0)
DVBCAMI1 ;ALB/GTS-557/THM-AMIS REPORT/BULLETIN TEXT ; 10/4/91  8:48 AM
"RTN","DVBCAMI1",2,0)
 ;;2.7;AMIE;**17,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMI1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMI1",4,0)
 ;
"RTN","DVBCAMI1",5,0)
 ;Input : DVBACDE - Priority of Exam code to get Totals for
"RTN","DVBCAMI1",6,0)
BULLTXT(DVBACDE) ;
"RTN","DVBCAMI1",7,0)
 N DVBATXT,DVBADTS
"RTN","DVBCAMI1",8,0)
 S TOTRECV=TOT("RECEIVED")+TOT("INSUFF"),TOTRVTN=TOTRECV+TOT("TRANSIN")
"RTN","DVBCAMI1",9,0)
 S DVBATXT=$$PRHD^DVBCIUTL(DVBACDE)
"RTN","DVBCAMI1",10,0)
 S DVBATXT=$S(DVBATXT["Excludes":"Report "_DVBATXT,1:"Report for "_DVBATXT)
"RTN","DVBCAMI1",11,0)
 ;IDES Type exams required to be completed in 45 days, all others 30
"RTN","DVBCAMI1",12,0)
 S DVBADTS=$S(((";IDES;")[(";"_DVBACDE_";")):45,1:30)
"RTN","DVBCAMI1",13,0)
 ;.01,.02 printed only in bulletin (if generated)
"RTN","DVBCAMI1",14,0)
 S ^TMP($J,.01,0)=DVBATXT
"RTN","DVBCAMI1",15,0)
 S ^TMP($J,.02,0)=" "
"RTN","DVBCAMI1",16,0)
 S ^TMP($J,1,0)="Processing date: "_$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBCAMI1",17,0)
 S ^TMP($J,2,0)=" "
"RTN","DVBCAMI1",18,0)
 S ^TMP($J,3,0)="Total pending from previous month: "_PREVMO
"RTN","DVBCAMI1",19,0)
 S ^TMP($J,4,0)=" "
"RTN","DVBCAMI1",20,0)
 S ^TMP($J,5,0)="Requests received for date range: "_TOT("RECEIVED")
"RTN","DVBCAMI1",21,0)
 S ^TMP($J,5.1,0)=" "
"RTN","DVBCAMI1",22,0)
 S ^TMP($J,5.3,0)="Exams returned as insufficient: "_TOT("INSUFF")_"  ("_$S(TOTRECV>0:$J(TOT("INSUFF")/TOTRECV*100,0,0),1:0)_"%)"
"RTN","DVBCAMI1",23,0)
 S ^TMP($J,6,0)="Requests returned complete: "_TOT("COMPLETED")
"RTN","DVBCAMI1",24,0)
 S ^TMP($J,7,0)="Requests returned incomplete: "_TOT("INCOMPLETE")
"RTN","DVBCAMI1",25,0)
 S ^TMP($J,8,0)=" "
"RTN","DVBCAMI1",26,0)
 S ^TMP($J,8.1,0)="Total processing time: "_TOT("DAYS")_$S(TOT("DAYS")=1:" day",1:" days")
"RTN","DVBCAMI1",27,0)
 S ^TMP($J,8.2,0)=" "
"RTN","DVBCAMI1",28,0)
 S ^TMP($J,9,0)="Pending end of month: "_TOT("PENDADJ")
"RTN","DVBCAMI1",29,0)
 S ^TMP($J,10,0)="Average processing time: "_TOT("AVGDAYS")_$S(TOT("AVGDAYS")>1!(TOT("AVGDAYS")<1):" days",1:" day")
"RTN","DVBCAMI1",30,0)
 S ^TMP($J,11,0)=" "
"RTN","DVBCAMI1",31,0)
 S ^TMP($J,12,0)="Greater than 3 days to schedule: "_TOT("3DAYSCH")
"RTN","DVBCAMI1",32,0)
 S ^TMP($J,13,0)="Greater than "_DVBADTS_" days to examine: "_TOT("30DAYEX")
"RTN","DVBCAMI1",33,0)
 S ^TMP($J,14,0)=" "
"RTN","DVBCAMI1",34,0)
 S ^TMP($J,15,0)="Pending, 0-90 days: "_TOT("P90")
"RTN","DVBCAMI1",35,0)
 S ^TMP($J,16,0)="Pending, 91-120 days: "_TOT("P121")
"RTN","DVBCAMI1",36,0)
 S ^TMP($J,17,0)="Pending, 121-150 days: "_TOT("P151")
"RTN","DVBCAMI1",37,0)
 S ^TMP($J,18,0)="Pending, 151-180 days: "_TOT("P181")
"RTN","DVBCAMI1",38,0)
 S ^TMP($J,19,0)="Pending, 181-365 days: "_TOT("P365")
"RTN","DVBCAMI1",39,0)
 S ^TMP($J,20,0)="Pending, 366 or more days: "_TOT("P366")
"RTN","DVBCAMI1",40,0)
 S ^TMP($J,21,0)=" "
"RTN","DVBCAMI1",41,0)
 S ^TMP($J,22,0)="Transfers in from other sites: "_TOT("TRANSIN")_"  ("_$S(TOTRVTN>0:$J(TOT("TRANSIN")/TOTRVTN*100,0,0),1:0)_"%)"
"RTN","DVBCAMI1",42,0)
 S ^TMP($J,23,0)="Transfers returned to other sites: "_TOT("TRNRETTO")
"RTN","DVBCAMI1",43,0)
 S ^TMP($J,24,0)="Transfers pending return to other sites: "_TOT("TRNPNDTO")
"RTN","DVBCAMI1",44,0)
 S ^TMP($J,25,0)=" "
"RTN","DVBCAMI1",45,0)
 S ^TMP($J,26,0)="Transfers out to other sites: "_TOT("TRANSOUT")_"  ("_$S(TOTRVTN>0:$J(TOT("TRANSOUT")/TOTRVTN*100,0,0),1:0)_"%)"
"RTN","DVBCAMI1",46,0)
 S ^TMP($J,27,0)="Transfers returned from other sites: "_TOT("TRNRETFR")
"RTN","DVBCAMI1",47,0)
 S ^TMP($J,28,0)="Transfers pending return from other sites: "_TOT("TRNPNDFR")
"RTN","DVBCAMI1",48,0)
 S ^TMP($J,29,0)=" "
"RTN","DVBCAMI1",49,0)
 S ^TMP($J,32,0)=" ** Transfer figures are for information only **"
"RTN","DVBCAMI1",50,0)
 S ^TMP($J,33,0)="* and should not be used to balance this report *"
"RTN","DVBCAMI1",51,0)
 K DIC,DIE,DR,DA,TOTRECV,TOTRVTN
"RTN","DVBCAMI1",52,0)
 Q
"RTN","DVBCAMI2")
0^12^B37457231^B37534460
"RTN","DVBCAMI2",1,0)
DVBCAMI2 ;ALB/GTS-557/THM-HOSPITAL AMIS 290 ; 7/1/91  9:48 AM
"RTN","DVBCAMI2",2,0)
 ;;2.7;AMIE;**149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMI2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMI2",4,0)
 ;
"RTN","DVBCAMI2",5,0)
 ;** Version Changes
"RTN","DVBCAMI2",6,0)
 ;   2.7 - GTS/Coded to adjust 35 day clock calc  (Enhc 13)
"RTN","DVBCAMI2",7,0)
 ;
"RTN","DVBCAMI2",8,0)
DAY30 ;exam completion
"RTN","DVBCAMI2",9,0)
 N DVBADTS,DVBAPPTS,DVBACNT,DVBADTM,DVBAPT,DVBANDE,X,X1,X2
"RTN","DVBCAMI2",10,0)
 K ^TMP("DVBC",$J),^TMP($J,"SDAMA301")
"RTN","DVBCAMI2",11,0)
 ;DES Type exams required to be completed in 45 days, all others 30
"RTN","DVBCAMI2",12,0)
 S DVBADTS=$S(((";IDES;")[(";"_DVBAPREXM_";")):45,1:30)
"RTN","DVBCAMI2",13,0)
 ;setup call to scheduling API (date inclusive)
"RTN","DVBCAMI2",14,0)
 S DVBAPPTS(1)=DTRPT_";"_EDATE,DVBAPPTS(4)=PNAM,DVBAPPTS(3)="R;I"
"RTN","DVBCAMI2",15,0)
 S DVBAPPTS("SORT")="P",DVBAPPTS("FLDS")="10"
"RTN","DVBCAMI2",16,0)
 S DVBACNT=$$SDAPI^SDAMA301(.DVBAPPTS)
"RTN","DVBCAMI2",17,0)
 I (DVBACNT'>0) K ^TMP($J,"SDAMA301") Q
"RTN","DVBCAMI2",18,0)
 S DVBADTM=""
"RTN","DVBCAMI2",19,0)
 F  S DVBADTM=$O(^TMP($J,"SDAMA301",PNAM,DVBADTM)) Q:('+DVBADTM)  D
"RTN","DVBCAMI2",20,0)
 .S DVBAPT=$G(^TMP($J,"SDAMA301",PNAM,DVBADTM))
"RTN","DVBCAMI2",21,0)
 .Q:(+$P(DVBAPT,"^",10)'=1)  ;quit if not C&P Appointment
"RTN","DVBCAMI2",22,0)
 .S ^TMP("DVBC",$J,9999999-DVBADTM,DVBADTM)=""
"RTN","DVBCAMI2",23,0)
 I ('$D(^TMP("DVBC",$J))) K ^TMP($J,"SDAMA301") Q
"RTN","DVBCAMI2",24,0)
 S DVBANDE=$O(^TMP("DVBC",$J,0)),DVBADTM=$O(^TMP("DVBC",$J,DVBANDE,0))
"RTN","DVBCAMI2",25,0)
 D:(DVBADTM]"")
"RTN","DVBCAMI2",26,0)
 .S X1=DVBADTM,X2=$S(DTRPT]"":DTRPT,1:DVBCNOW)
"RTN","DVBCAMI2",27,0)
 .D ^%DTC  ;calculate date diff
"RTN","DVBCAMI2",28,0)
 .S:(X>DVBADTS) TOT(DVBAPREXM,"30DAYEX")=TOT(DVBAPREXM,"30DAYEX")+1
"RTN","DVBCAMI2",29,0)
 K ^TMP($J,"SDAMA301")
"RTN","DVBCAMI2",30,0)
 Q
"RTN","DVBCAMI2",31,0)
 ;
"RTN","DVBCAMI2",32,0)
GO1 ;  ** TFIND=1 If any exams have not been transferred. **
"RTN","DVBCAMI2",33,0)
 K TFIND F XI=0:0 S XI=$O(^DVB(396.4,"C",REQDA,XI)) Q:XI=""  I $P(^DVB(396.4,XI,0),U,4)'="T" S TFIND=1
"RTN","DVBCAMI2",34,0)
 Q
"RTN","DVBCAMI2",35,0)
 ;if $D(TFIND) at least one exam to be done locally
"RTN","DVBCAMI2",36,0)
 ;
"RTN","DVBCAMI2",37,0)
PENDCNT I X'<0&(X'>90) S TOT(DVBAPREXM,"P90")=TOT(DVBAPREXM,"P90")+1
"RTN","DVBCAMI2",38,0)
 I X>90&(X'>120) S TOT(DVBAPREXM,"P121")=TOT(DVBAPREXM,"P121")+1
"RTN","DVBCAMI2",39,0)
 I X>120&(X'>150) S TOT(DVBAPREXM,"P151")=TOT(DVBAPREXM,"P151")+1
"RTN","DVBCAMI2",40,0)
 I X>150&(X'>180) S TOT(DVBAPREXM,"P181")=TOT(DVBAPREXM,"P181")+1
"RTN","DVBCAMI2",41,0)
 I X>180&(X'>365) S TOT(DVBAPREXM,"P365")=TOT(DVBAPREXM,"P365")+1
"RTN","DVBCAMI2",42,0)
 I X>365 S TOT(DVBAPREXM,"P366")=TOT(DVBAPREXM,"P366")+1
"RTN","DVBCAMI2",43,0)
 Q
"RTN","DVBCAMI2",44,0)
 ;
"RTN","DVBCAMI2",45,0)
SET ;
"RTN","DVBCAMI2",46,0)
 N DVBAPREXM
"RTN","DVBCAMI2",47,0)
 S DTA=^DVB(396.3,REQDA,0),DFN=$P(DTA,U,1),DTREQ=$P(DTA,U,2),DTRPT=$P(DTA,U,5),DTSCHEDC=$P(DTA,U,6),DTRQCMP=$P(DTA,U,7),PRIO=$P(DTA,U,10),DTTRANS=$P(DTA,U,12),OWNDOM=$P(DTA,U,22)
"RTN","DVBCAMI2",48,0)
 S DTREL=$P(DTA,U,14),RQSTAT=$P(DTA,U,18),DTCAN=$P(DTA,U,19) K DTA
"RTN","DVBCAMI2",49,0)
 S DTA=$S($D(^DVB(396.3,REQDA,4)):^(4),1:""),TROUT=$P(DTA,U,1),DTTROUT=$P(DTA,U,3),DTTRIN=$P(DTA,U,4),DTTRET=$P(DTA,U,5)
"RTN","DVBCAMI2",50,0)
 I DTCAN]"",DTCAN<DTRPT,DTRPT]"" S DTRPT=DTCAN ;cancelled last day of month
"RTN","DVBCAMI2",51,0)
 Q:DTRPT=""  ;never reported to MAS
"RTN","DVBCAMI2",52,0)
 ;check for Parent Request (retrieve current/parent Priority of Exam)
"RTN","DVBCAMI2",53,0)
 S DVBAPREXM=$$CHKREQ^DVBCIRP1(REQDA)
"RTN","DVBCAMI2",54,0)
 ;original report run (Exclude new priorities)
"RTN","DVBCAMI2",55,0)
 Q:((DVBAEXMP']"")&((";BDD;QS;IDES;AO;")[(";"_DVBAPREXM_";")))
"RTN","DVBCAMI2",56,0)
 ;report for specific priority
"RTN","DVBCAMI2",57,0)
 Q:((DVBAEXMP]"")&(DVBAEXMP'[(";"_DVBAPREXM_";")))
"RTN","DVBCAMI2",58,0)
 S:(DVBAEXMP']"") DVBAPREXM="ALL"  ;identifier for totals
"RTN","DVBCAMI2",59,0)
 I DTTRIN'<BDATE,DTTRIN'>EDATE S TOT(DVBAPREXM,"TRANSIN")=TOT(DVBAPREXM,"TRANSIN")+1 ;transfers in
"RTN","DVBCAMI2",60,0)
 I RQSTAT="CT",DTREL'<BDATE,DTREL'>EDATE S TOT(DVBAPREXM,"TRNRETTO")=TOT(DVBAPREXM,"TRNRETTO")+1 ;transfers returned to owners
"RTN","DVBCAMI2",61,0)
 I "^N^NT^P^S^T^"[RQSTAT,OWNDOM]"" S TOT(DVBAPREXM,"TRNPNDTO")=TOT(DVBAPREXM,"TRNPNDTO")+1 ;transfers pending return to others
"RTN","DVBCAMI2",62,0)
 Q:DTTRIN]""  ;** A transfer in (not counted further)
"RTN","DVBCAMI2",63,0)
 I DTREL'<BDATE,DTREL'>EDATE D DAY30
"RTN","DVBCAMI2",64,0)
 I DTTROUT'<BDATE,DTTROUT'>EDATE,TROUT="y" S TOT(DVBAPREXM,"TRANSOUT")=TOT(DVBAPREXM,"TRANSOUT")+1 ;transfers to other sites, not returns
"RTN","DVBCAMI2",65,0)
 I TROUT="",DTTRET'<BDATE,DTTRET'>EDATE S TOT(DVBAPREXM,"TRNRETFR")=TOT(DVBAPREXM,"TRNRETFR")+1 ;transfers returned from other sites
"RTN","DVBCAMI2",66,0)
 I TROUT="y",RQSTAT="P" S TOT(DVBAPREXM,"TRNPNDFR")=TOT(DVBAPREXM,"TRNPNDFR")+1 ;transfers pending return from other sites
"RTN","DVBCAMI2",67,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,PRIO'="E" S TOT(DVBAPREXM,"RECEIVED")=TOT(DVBAPREXM,"RECEIVED")+1
"RTN","DVBCAMI2",68,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,PRIO="E" S TOT(DVBAPREXM,"INSUFF")=TOT(DVBAPREXM,"INSUFF")+1
"RTN","DVBCAMI2",69,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,RQSTAT'["X" D GO1 I $D(TFIND) S X1=$S(DTSCHEDC]"":DTSCHEDC,1:DVBCNOW),X2=DTRPT D ^%DTC I X>3 S TOT(DVBAPREXM,"3DAYSCH")=TOT(DVBAPREXM,"3DAYSCH")+1
"RTN","DVBCAMI2",70,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT="C"!(RQSTAT="R") S:PRIO'="E" DVBCPCTM=$$PROCDAY^DVBCUTL2(REQDA) S:PRIO="E" DVBCPCTM=$$INSFTME^DVBCUTA1(REQDA) S TOT(DVBAPREXM,"DAYS")=TOT(DVBAPREXM,"DAYS")+DVBCPCTM K DVBCPCTM
"RTN","DVBCAMI2",71,0)
 I DTRPT'>EDATE,"^N^NT^P^S^T^"[RQSTAT S X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBCAMI2",72,0)
 I DTRPT'>EDATE,"^C^CT^R^RX^X^"[RQSTAT,(+DTREL>EDATE)!(+DTCAN>EDATE) S X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBCAMI2",73,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT="C"!(RQSTAT="R") S TOT(DVBAPREXM,"COMPLETED")=TOT(DVBAPREXM,"COMPLETED")+1
"RTN","DVBCAMI2",74,0)
 I DTCAN'<BDATE,DTCAN'>EDATE,RQSTAT["X" S TOT(DVBAPREXM,"INCOMPLETE")=TOT(DVBAPREXM,"INCOMPLETE")+1
"RTN","DVBCAMI2",75,0)
 K DTRPT Q
"RTN","DVBCAMI2",76,0)
 ;
"RTN","DVBCAMI2",77,0)
GO ;
"RTN","DVBCAMI2",78,0)
 N DVBAEXMP,DVBAP,DVBAPREXM,DVBATOT
"RTN","DVBCAMI2",79,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":";BDD;QS;",($G(DVBAPRTY)["IDES"):";IDES;",($G(DVBAPRTY)["AO"):";AO;",1:"")
"RTN","DVBCAMI2",80,0)
 U IO K ^TMP($J) S PG=0,%DT="TS",X="NOW" D ^%DT S DVBCNOW=Y
"RTN","DVBCAMI2",81,0)
 S PNAM="" F JJ=0:0 S PNAM=$O(^DVB(396.3,"B",PNAM)) Q:PNAM=""  F REQDA=0:0 S REQDA=$O(^DVB(396.3,"B",PNAM,REQDA)) Q:REQDA=""  D SET
"RTN","DVBCAMI2",82,0)
 ;
"RTN","DVBCAMI2",83,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBCAMI2",84,0)
 M DVBATOT=TOT  ;save totals for all priorities into new array
"RTN","DVBCAMI2",85,0)
 F DVBAP=1:1:$L(DVBAEXMP,",") D
"RTN","DVBCAMI2",86,0)
 .S DVBAPREXM=$P(DVBAEXMP,",",DVBAP)
"RTN","DVBCAMI2",87,0)
 .;re-create TOT array for each priority of exam
"RTN","DVBCAMI2",88,0)
 .D CRTOT(DVBAPREXM,.DVBATOT,.TOT)
"RTN","DVBCAMI2",89,0)
 .S:($L(DVBAEXMP,",")>1) PREVMO=PREVMO(DVBAPREXM)
"RTN","DVBCAMI2",90,0)
 .S TOT("AVGDAYS")=0
"RTN","DVBCAMI2",91,0)
 .I TOT("COMPLETED")>0 S TOT("AVGDAYS")=TOT("DAYS")/TOT("COMPLETED"),TOT("AVGDAYS")=$J(TOT("AVGDAYS"),5,1)
"RTN","DVBCAMI2",92,0)
 .S TOT("PENDADJ")=PREVMO+TOT("RECEIVED")+TOT("INSUFF")-TOT("COMPLETED")-TOT("INCOMPLETE")
"RTN","DVBCAMI2",93,0)
 .D BULLTXT^DVBCAMI1(DVBAPREXM) D EN^DVBCAMI3((DVBAP=$L(DVBAEXMP,",")),DVBAPREXM)
"RTN","DVBCAMI2",94,0)
 Q
"RTN","DVBCAMI2",95,0)
 ;
"RTN","DVBCAMI2",96,0)
 ;Input : DVBACDE - Priority of Exam code to get Totals for
"RTN","DVBCAMI2",97,0)
 ;      : DVBATOT - Array holding total values for each specific priority
"RTN","DVBCAMI2",98,0)
 ;                  (By Ref)
"RTN","DVBCAMI2",99,0)
 ;      : TOT     - array to hold totals for requested priority (By Ref)
"RTN","DVBCAMI2",100,0)
 ;Output: TOT array with totals for requested priority
"RTN","DVBCAMI2",101,0)
CRTOT(DVBACDE,DVBATOT,TOT) ;create total array for specific priority exam report
"RTN","DVBCAMI2",102,0)
 N JI K TOT
"RTN","DVBCAMI2",103,0)
 F JI="3DAYSCH","30DAYEX","PENDADJ","TRANSIN","TRNRETTO","TRNPNDTO","TRANSOUT","TRNRETFR","TRNPNDFR","INSUFF" D
"RTN","DVBCAMI2",104,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMI2",105,0)
 F JI="RECEIVED","INCOMPLETE","DAYS","COMPLETED" D
"RTN","DVBCAMI2",106,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMI2",107,0)
 F JI="P90","P121","P151","P181","P365","P366" D
"RTN","DVBCAMI2",108,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMI2",109,0)
 Q
"RTN","DVBCAMI3")
0^13^B5656228^B5656228
"RTN","DVBCAMI3",1,0)
DVBCAMI3 ;ALB/GTS-557/THM-HOSPITAL AMIS 290 PRINTING, BULLETIN SEND ; 7/16/91  8:55 AM
"RTN","DVBCAMI3",2,0)
 ;;2.7;AMIE;**149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMI3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMI3",4,0)
 ;
"RTN","DVBCAMI3",5,0)
 ;Input: DVBALRPT - boolean value indicating if this is the last report
"RTN","DVBCAMI3",6,0)
 ;       DVBACDE  - Priority of Exam code for report
"RTN","DVBCAMI3",7,0)
 ;                   [ALL (Original Report),AO,BDD,QS,IDES]
"RTN","DVBCAMI3",8,0)
EN(DVBALRPT,DVBACDE) ;
"RTN","DVBCAMI3",9,0)
 U IO D HDR F JI=0.9:0 S JI=$O(^TMP($J,JI)) Q:JI=""  W ^(JI,0),! I IOST?1"C-".E,$Y>19 D PAUSE G:$D(OUT) EXIT D HDR
"RTN","DVBCAMI3",10,0)
 D PAUSE I $D(OUT)!(ANS=U) W:SBULL="Y" !!,*7,"Bulletin will NOT be sent!!",*7,! H 2 G EXIT
"RTN","DVBCAMI3",11,0)
 S:'$D(XMY) SBULL="N" I SBULL="Y" D SEND
"RTN","DVBCAMI3",12,0)
 ;
"RTN","DVBCAMI3",13,0)
EXIT ;
"RTN","DVBCAMI3",14,0)
 Q:('DVBALRPT)
"RTN","DVBCAMI3",15,0)
 D ^%ZISC
"RTN","DVBCAMI3",16,0)
 K TFIND,PG,OUT,PREVMO,UPDATE,DTTRET,DTTRIN,DTTROUT,TROUT,XI,XMY
"RTN","DVBCAMI3",17,0)
 D:$D(ZTQUEUED) KILL^%ZTLOAD G KILL^DVBCUTIL
"RTN","DVBCAMI3",18,0)
 ;
"RTN","DVBCAMI3",19,0)
BULL W ! S XMDUZ=DUZ,XMMG=$S($D(^VA(200,DUZ,0)):$P(^(0),U,1),1:"") D DES^XMA21
"RTN","DVBCAMI3",20,0)
 Q
"RTN","DVBCAMI3",21,0)
 ;
"RTN","DVBCAMI3",22,0)
SEND ;send AMIS 290 report in bulletin
"RTN","DVBCAMI3",23,0)
 N DVBAXMY M DVBAXMY=XMY
"RTN","DVBCAMI3",24,0)
 I IOST'?1"P-",'$D(ZTQUEUED) W !!,"Loading AMIS 290 bulletin ..." H 1
"RTN","DVBCAMI3",25,0)
 S XMSUB="AMIS 290 report "_$S((($G(DVBACDE)]"")&($G(DVBACDE)'="ALL")):"("_$G(DVBACDE)_" Exam Priority) ",1:"")_"for "
"RTN","DVBCAMI3",26,0)
 S Y=BDATE1 X ^DD("DD") S XMSUB=XMSUB_Y S Y=EDATE1 X ^DD("DD") S XMSUB=XMSUB_" to "_Y,XMTEXT="^TMP($J,"
"RTN","DVBCAMI3",27,0)
 D ^XMD K XMTEXT,XMSUB K ^TMP($J),^TMP("DVBC",$J)
"RTN","DVBCAMI3",28,0)
 I '$D(ZTQUEUED) W !!,*7,">> Mail message transmitted <<",!! H 2
"RTN","DVBCAMI3",29,0)
 M XMY=DVBAXMY  ;restore address list for subsequent bulletins
"RTN","DVBCAMI3",30,0)
 Q
"RTN","DVBCAMI3",31,0)
 ;
"RTN","DVBCAMI3",32,0)
HDR S PG=PG+1 W:(IOST?1"C-".E) @IOF
"RTN","DVBCAMI3",33,0)
 W "AMIS 290 Report for "_$$SITE^DVBCUTL4,?(IOM-9),"Page: ",PG,!
"RTN","DVBCAMI3",34,0)
 W $$PRHD^DVBCIUTL(DVBACDE),!
"RTN","DVBCAMI3",35,0)
 W "For date range: " S Y=BDATE1 X ^DD("DD") W Y W " to " S Y=EDATE1 X ^DD("DD") W Y,!
"RTN","DVBCAMI3",36,0)
 F LINE=1:1:80 W "-"
"RTN","DVBCAMI3",37,0)
 W !!
"RTN","DVBCAMI3",38,0)
 Q
"RTN","DVBCAMI3",39,0)
 ;
"RTN","DVBCAMI3",40,0)
PAUSE K OUT S ANS="" I IOST?1"C-".E W *7,!!,"Press RETURN to continue or ""^"" to exit  " R ANS:DTIME I '$T!(ANS[U) S OUT=1
"RTN","DVBCAMI3",41,0)
 Q
"RTN","DVBCAMIS")
0^10^B14811175^B15380003
"RTN","DVBCAMIS",1,0)
DVBCAMIS ;ALB/GTS-557/THM-2507 AMIS REPORT ;21 MAY 89@0822 ; 5/23/91  1:30 PM
"RTN","DVBCAMIS",2,0)
 ;;2.7;AMIE;**17,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMIS",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMIS",4,0)
 ;
"RTN","DVBCAMIS",5,0)
SETUP ;
"RTN","DVBCAMIS",6,0)
 N DVBAPRTY,DVBAEXMP,DVBAP
"RTN","DVBCAMIS",7,0)
 S UPDATE="N",HD="AMIS 290 REPORT" I '$D(DT) S X="T" D ^%DT S DT=Y
"RTN","DVBCAMIS",8,0)
 S DVBCDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBCAMIS",9,0)
 D HOME^%ZIS S FF=IOF
"RTN","DVBCAMIS",10,0)
 ;prompt for priority of exam
"RTN","DVBCAMIS",11,0)
 S DVBAPRTY=$$EXMPRTY^DVBCIUTL("Select the Priority of Exam for the AMIS 290 Report")
"RTN","DVBCAMIS",12,0)
 G:('(DVBAPRTY?.A)!(DVBAPRTY']"")) EXIT  ;quit if no priority of exam selected 
"RTN","DVBCAMIS",13,0)
 ;
"RTN","DVBCAMIS",14,0)
INIT ;initialize counter arrays
"RTN","DVBCAMIS",15,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBCAMIS",16,0)
 F JI="3DAYSCH","30DAYEX","PENDADJ","TRANSIN","TRNRETTO","TRNPNDTO","TRANSOUT","TRNRETFR","TRNPNDFR","INSUFF" D
"RTN","DVBCAMIS",17,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMIS",18,0)
 F JI="RECEIVED","INCOMPLETE","DAYS","COMPLETED" D
"RTN","DVBCAMIS",19,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMIS",20,0)
 F JI="P90","P121","P151","P181","P365","P366" D
"RTN","DVBCAMIS",21,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMIS",22,0)
 ;
"RTN","DVBCAMIS",23,0)
EN W @IOF,!?(IOM-$L(HD)\2),HD,!!!
"RTN","DVBCAMIS",24,0)
 S %DT(0)=-DT,%DT="AE",%DT("A")="Enter STARTING DATE: " D ^%DT G:Y<0 EXIT S BDATE1=Y,BDATE=Y-.1
"RTN","DVBCAMIS",25,0)
 S %DT="AE",%DT("A")="    and ENDING DATE: " D ^%DT G:Y<0 EN S EDATE1=Y,EDATE=Y+.5
"RTN","DVBCAMIS",26,0)
 I EDATE1<BDATE1 W *7,!!,"Invalid date sequence - ending date is before starting date.",!! H 3 G EN
"RTN","DVBCAMIS",27,0)
ASK0 ;prompt for previous month pending count
"RTN","DVBCAMIS",28,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT,DVBATXT
"RTN","DVBCAMIS",29,0)
 S DIR(0)="N^0:9999:0"
"RTN","DVBCAMIS",30,0)
 S DIR("?",1)="Enter the totals for the month previous to the one you are processing."
"RTN","DVBCAMIS",31,0)
 S DIR("?")="Must be a number from 0 to 9999."
"RTN","DVBCAMIS",32,0)
 S DIR("T")=DTIME  ;time-out value specified by system
"RTN","DVBCAMIS",33,0)
 W !!
"RTN","DVBCAMIS",34,0)
 ;get previous month pending count for each priority of exam to run
"RTN","DVBCAMIS",35,0)
 F DVBAP=1:1:$L(DVBAEXMP,",") Q:($G(DIRUT)!($G(DIROUT)))  D
"RTN","DVBCAMIS",36,0)
 .S DVBATXT=$$GPTYPE($P(DVBAEXMP,",",DVBAP))
"RTN","DVBCAMIS",37,0)
 .S DIR("A",1)="Please enter the total pending, "_DVBATXT
"RTN","DVBCAMIS",38,0)
 .S DIR("A")=" exam priorities, from the previous month"
"RTN","DVBCAMIS",39,0)
 .D ^DIR
"RTN","DVBCAMIS",40,0)
 .S:$L(DVBAEXMP,",")=1 PREVMO=$G(Y)
"RTN","DVBCAMIS",41,0)
 .S:$L(DVBAEXMP,",")>1 PREVMO($P(DVBAEXMP,",",DVBAP))=$G(Y)
"RTN","DVBCAMIS",42,0)
 G:($G(DIRUT)!($G(DIROUT))) EXIT  ;user timed/exited out
"RTN","DVBCAMIS",43,0)
 ;
"RTN","DVBCAMIS",44,0)
ASK K %DT S SBULL="Y"
"RTN","DVBCAMIS",45,0)
 W !!!,"Do you want to send a bulletin when processing is done"
"RTN","DVBCAMIS",46,0)
 S %=1 D YN^DICN G:$D(DTOUT)!(%<0) EXIT
"RTN","DVBCAMIS",47,0)
 I %=0 W !!,"Enter Y to send a bulletin to selected recipients or N not to send it at all.",!! G ASK
"RTN","DVBCAMIS",48,0)
 I %'=1 S SBULL="N"
"RTN","DVBCAMIS",49,0)
 I SBULL="Y" D BULL^DVBCAMI3
"RTN","DVBCAMIS",50,0)
 W ! S %ZIS="AEQ",%ZIS("A")="Output device: " D ^%ZIS G:POP EXIT
"RTN","DVBCAMIS",51,0)
 I $D(IO("Q")) S ZTRTN="GO^DVBCAMI2",ZTDESC="2507 Amis Report",ZTIO=ION F I="PREVMO*","RO*","BDATE*","TOT*","EDATE*","SBULL","DUZ","DVBCDT(0)","XM*","DVBAPRTY" S ZTSAVE(I)=""
"RTN","DVBCAMIS",52,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued",!! H 1 K ZTSK G EXIT
"RTN","DVBCAMIS",53,0)
 G GO^DVBCAMI2
"RTN","DVBCAMIS",54,0)
 ;
"RTN","DVBCAMIS",55,0)
EXIT K PREVMO,UPDATE G KILL^DVBCUTIL
"RTN","DVBCAMIS",56,0)
 ;
"RTN","DVBCAMIS",57,0)
 ;
"RTN","DVBCAMIS",58,0)
 ;Input : DVBACDE - Code to get description for
"RTN","DVBCAMIS",59,0)
 ;           [BDD,QS,IDES,AO]
"RTN","DVBCAMIS",60,0)
 ;Ouput : Corresponding description for code
"RTN","DVBCAMIS",61,0)
GPTYPE(DVBACDE) ;get exam priority desc
"RTN","DVBCAMIS",62,0)
 N DVBATXT
"RTN","DVBCAMIS",63,0)
 Q:($G(DVBACDE)']"") ""
"RTN","DVBCAMIS",64,0)
 S DVBATXT=$S(DVBACDE="BDD":"'Benefits Delivery at Discharge ("_DVBACDE_")'",1:"")
"RTN","DVBCAMIS",65,0)
 S:(DVBATXT']"") DVBATXT=$S(DVBACDE="QS":"'Quick Start ("_DVBACDE_")'",1:"")
"RTN","DVBCAMIS",66,0)
 S:(DVBATXT']"") DVBATXT=$S(DVBACDE="IDES":"'Integrated Disability Evaluation System ("_DVBACDE_")'",1:"")
"RTN","DVBCAMIS",67,0)
 S:(DVBATXT']"") DVBATXT=$S(DVBACDE="AO":"'Agent Orange ("_DVBACDE_")'",1:"")
"RTN","DVBCAMIS",68,0)
 S:(DVBATXT']"") DVBATXT=$S(DVBACDE="ALL":"excluding BDD,QS,IDES and AO",1:"")
"RTN","DVBCAMIS",69,0)
 Q DVBATXT
"RTN","DVBCAMR1")
0^15^B5142050^B5153937
"RTN","DVBCAMR1",1,0)
DVBCAMR1 ;ALB/GTS-557/THM-REGIONAL OFFICE AMIS REPORT BULLETIN TEXT ; 9/28/91  6:39 AM
"RTN","DVBCAMR1",2,0)
 ;;2.7;AMIE;**149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMR1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMR1",4,0)
 ;
"RTN","DVBCAMR1",5,0)
 ;Input: DVBACDE - Priority of Exam code to get Totals for
"RTN","DVBCAMR1",6,0)
BULLTXT(DVBACDE) ;
"RTN","DVBCAMR1",7,0)
 N DVBATXT,DVBADTS
"RTN","DVBCAMR1",8,0)
 S DVBATXT=$$PRHD^DVBCIUTL(DVBACDE)
"RTN","DVBCAMR1",9,0)
 S DVBATXT=$S(DVBATXT["Excludes":"Report "_DVBATXT,1:"Report for "_DVBATXT)
"RTN","DVBCAMR1",10,0)
 ;DES Type exams required to be completed in 45 days, all others 30
"RTN","DVBCAMR1",11,0)
 S DVBADTS=$S(((";IDES;")[(";"_DVBACDE_";")):45,1:30)
"RTN","DVBCAMR1",12,0)
 ;.01,.02 printed only in bulletin (if generated)
"RTN","DVBCAMR1",13,0)
 S ^TMP($J,.01,0)=DVBATXT
"RTN","DVBCAMR1",14,0)
 S ^TMP($J,.02,0)=" "
"RTN","DVBCAMR1",15,0)
 S ^TMP($J,1,0)="For regional office: "_RONAME_" ("_RONUM_")"
"RTN","DVBCAMR1",16,0)
 S ^TMP($J,2,0)=" "
"RTN","DVBCAMR1",17,0)
 S ^TMP($J,3,0)="Requests sent for date range: "_TOT("SENT")
"RTN","DVBCAMR1",18,0)
 S ^TMP($J,4,0)="Exams received incomplete: "_TOT("INCOMPLETE")
"RTN","DVBCAMR1",19,0)
 S ^TMP($J,5,0)="Exams received complete: "_TOT("COMPLETED")
"RTN","DVBCAMR1",20,0)
 S ^TMP($J,5.3,0)="Exams returned as insufficient: "_TOT("INSUFF")_"  ("_$S(TOT("SENT")>0:$J(TOT("INSUFF")/TOT("SENT")*100,0,0),1:0)_"%)"
"RTN","DVBCAMR1",21,0)
 S ^TMP($J,6,0)="Pending for office "_RONUM_" at end of month: "_TOT("PENDADJ")
"RTN","DVBCAMR1",22,0)
 S ^TMP($J,7,0)="Average processing time: "_TOT("AVGDAYS")_$S(TOT("AVGDAYS")>1!(TOT("AVGDAYS")<1):" days",1:" day")
"RTN","DVBCAMR1",23,0)
 S ^TMP($J,8,0)=" "
"RTN","DVBCAMR1",24,0)
 S ^TMP($J,9,0)="Greater than 3 days to schedule: "_TOT("3DAYSCH")
"RTN","DVBCAMR1",25,0)
 S ^TMP($J,10,0)="Greater than "_DVBADTS_" days to examine: "_TOT("30DAYEX")
"RTN","DVBCAMR1",26,0)
 S ^TMP($J,11,0)=" "
"RTN","DVBCAMR1",27,0)
 S ^TMP($J,12,0)="Pending, 0-90 days: "_TOT("P90")
"RTN","DVBCAMR1",28,0)
 S ^TMP($J,13,0)="Pending, 91-120 days: "_TOT("P121")
"RTN","DVBCAMR1",29,0)
 S ^TMP($J,14,0)="Pending, 121-150 days: "_TOT("P151")
"RTN","DVBCAMR1",30,0)
 S ^TMP($J,15,0)="Pending, 151-180 days: "_TOT("P181")
"RTN","DVBCAMR1",31,0)
 S ^TMP($J,16,0)="Pending, 181-365 days: "_TOT("P365")
"RTN","DVBCAMR1",32,0)
 S ^TMP($J,17,0)="Pending, 366 or more days: "_TOT("P366")
"RTN","DVBCAMR1",33,0)
 Q
"RTN","DVBCAMR2")
0^16^B35907185^B35979419
"RTN","DVBCAMR2",1,0)
DVBCAMR2 ;ALB/GTS-557/THM-REGIONAL OFFICE AMIS 290 REPORT, CALCULATIONS ; 9/28/91  6:43 AM
"RTN","DVBCAMR2",2,0)
 ;;2.7;AMIE;**149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMR2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMR2",4,0)
 ;
"RTN","DVBCAMR2",5,0)
 ;** Version Changes
"RTN","DVBCAMR2",6,0)
 ;   2.7 - GTS/Coded to adjust 35 day clock calc  (Enhc 13)
"RTN","DVBCAMR2",7,0)
 ;
"RTN","DVBCAMR2",8,0)
DAY30 ;exam completion
"RTN","DVBCAMR2",9,0)
 N DVBADTS,DVBAPPTS,DVBACNT,DVBADTM,DVBANDE,X,X1,X2
"RTN","DVBCAMR2",10,0)
 K ^TMP("DVBC",$J),^TMP($J,"SDAMA301")
"RTN","DVBCAMR2",11,0)
 ;DES Type exams required to be completed in 45 days, all others 30
"RTN","DVBCAMR2",12,0)
 S DVBADTS=$S(((";IDES;")[(";"_DVBAPREXM_";")):45,1:30)
"RTN","DVBCAMR2",13,0)
 ;setup call to scheduling API
"RTN","DVBCAMR2",14,0)
 S DVBAPPTS(1)=DTRPT_";"_EDATE,DVBAPPTS(4)=PNAM,DVBAPPTS(3)="R;I;NT"
"RTN","DVBCAMR2",15,0)
 S DVBAPPTS("SORT")="P",DVBAPPTS("FLDS")="10"
"RTN","DVBCAMR2",16,0)
 S DVBACNT=$$SDAPI^SDAMA301(.DVBAPPTS)
"RTN","DVBCAMR2",17,0)
 I (DVBACNT'>0) K ^TMP($J,"SDAMA301") Q
"RTN","DVBCAMR2",18,0)
 S DVBADTM=""
"RTN","DVBCAMR2",19,0)
 F  S DVBADTM=$O(^TMP($J,"SDAMA301",PNAM,DVBADTM)) Q:('+DVBADTM)  D
"RTN","DVBCAMR2",20,0)
 .S ^TMP("DVBC",$J,9999999-DVBADTM,DVBADTM)=""
"RTN","DVBCAMR2",21,0)
 S DVBANDE=$O(^TMP("DVBC",$J,0)),DVBADTM=$O(^TMP("DVBC",$J,DVBANDE,0))
"RTN","DVBCAMR2",22,0)
 D:(DVBADTM]"")
"RTN","DVBCAMR2",23,0)
 .S X2=DVBADTM,X1=$S(DTSCHEDC]"":DTSCHEDC,1:DVBCNOW)
"RTN","DVBCAMR2",24,0)
 .D ^%DTC  ;calculate date diff
"RTN","DVBCAMR2",25,0)
 .S:(X>DVBADTS) TOT(DVBAPREXM,"30DAYEX")=TOT(DVBAPREXM,"30DAYEX")+1
"RTN","DVBCAMR2",26,0)
 K ^TMP($J,"SDAMA301")
"RTN","DVBCAMR2",27,0)
 Q
"RTN","DVBCAMR2",28,0)
 ;
"RTN","DVBCAMR2",29,0)
PENDCNT I X'<0&(X'>90) S TOT(DVBAPREXM,"P90")=TOT(DVBAPREXM,"P90")+1
"RTN","DVBCAMR2",30,0)
 I X>90&(X'>120) S TOT(DVBAPREXM,"P121")=TOT(DVBAPREXM,"P121")+1
"RTN","DVBCAMR2",31,0)
 I X>120&(X'>150) S TOT(DVBAPREXM,"P151")=TOT(DVBAPREXM,"P151")+1
"RTN","DVBCAMR2",32,0)
 I X>150&(X'>180) S TOT(DVBAPREXM,"P181")=TOT(DVBAPREXM,"P181")+1
"RTN","DVBCAMR2",33,0)
 I X>180&(X'>365) S TOT(DVBAPREXM,"P365")=TOT(DVBAPREXM,"P365")+1
"RTN","DVBCAMR2",34,0)
 I X>365 S TOT(DVBAPREXM,"P366")=TOT(DVBAPREXM,"P366")+1
"RTN","DVBCAMR2",35,0)
 Q
"RTN","DVBCAMR2",36,0)
 ;
"RTN","DVBCAMR2",37,0)
SET ;
"RTN","DVBCAMR2",38,0)
 N DVBAPREXM
"RTN","DVBCAMR2",39,0)
 S DTA=^DVB(396.3,REQDA,0),DTREQ=$P(DTA,U,2),XRONUM=$P(DTA,U,3),XRONUM=$S($D(^DIC(4,+XRONUM,99)):$P(^(99),U,1),1:0) Q:XRONUM'=RONUM&(RONUM'="ALL")
"RTN","DVBCAMR2",40,0)
 K XRONUM S DTRPT=$P(DTA,U,5),DTSCHEDC=$P(DTA,U,6),DTRQCMP=$P(DTA,U,7),DTTRANS=$P(DTA,U,12),DTREL=$P(DTA,U,14),RQSTAT=$P(DTA,U,18),DTCAN=$P(DTA,U,19),PRIO=$P(DTA,U,10) K DTA
"RTN","DVBCAMR2",41,0)
 I DTRPT="",DTCAN]"" S DTRPT=DTCAN
"RTN","DVBCAMR2",42,0)
 Q:DTRPT=""  ;requests never printed
"RTN","DVBCAMR2",43,0)
 ;check for Parent Request (retrieve current/parent Priority of Exam)
"RTN","DVBCAMR2",44,0)
 S DVBAPREXM=$$CHKREQ^DVBCIRP1(REQDA)
"RTN","DVBCAMR2",45,0)
 ;original report run (Exclude new priorities)
"RTN","DVBCAMR2",46,0)
 Q:((DVBAEXMP']"")&((";BDD;QS;IDES;AO;")[(";"_DVBAPREXM_";")))
"RTN","DVBCAMR2",47,0)
 ;report for specific priority
"RTN","DVBCAMR2",48,0)
 Q:((DVBAEXMP]"")&(DVBAEXMP'[(";"_DVBAPREXM_";")))
"RTN","DVBCAMR2",49,0)
 S:(DVBAEXMP']"") DVBAPREXM="ALL"  ;identifier for totals
"RTN","DVBCAMR2",50,0)
 I DTREL'<BDATE,DTREL'>EDATE D DAY30
"RTN","DVBCAMR2",51,0)
 I DTRPT'<BDATE,DTRPT'>EDATE S TOT(DVBAPREXM,"SENT")=TOT(DVBAPREXM,"SENT")+1
"RTN","DVBCAMR2",52,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,RQSTAT'["X" S X1=$S(DTSCHEDC]"":DTSCHEDC,1:DVBCNOW),X2=DTRPT D ^%DTC I X>3 S TOT(DVBAPREXM,"3DAYSCH")=TOT(DVBAPREXM,"3DAYSCH")+1
"RTN","DVBCAMR2",53,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT="C"!(RQSTAT="R") S:PRIO'="E" DVBCPCTM=$$PROCDAY^DVBCUTL2(REQDA) S:PRIO="E" DVBCPCTM=$$INSFTME^DVBCUTA1(REQDA) S TOT(DVBAPREXM,"DAYS")=TOT(DVBAPREXM,"DAYS")+DVBCPCTM K DVBCPCTM
"RTN","DVBCAMR2",54,0)
 I DTRPT'>EDATE,"^P^S^T"[RQSTAT S TOT(DVBAPREXM,"PENDADJ")=TOT(DVBAPREXM,"PENDADJ")+1,X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBCAMR2",55,0)
 I DTRPT'>EDATE,"^C^CT^R^RX^X^"[RQSTAT,(+DTREL>EDATE)!(+DTCAN>EDATE) S TOT(DVBAPREXM,"PENDADJ")=TOT(DVBAPREXM,"PENDADJ")+1,X1=EDATE,X2=DTRPT D ^%DTC,PENDCNT
"RTN","DVBCAMR2",56,0)
 I DTREL'<BDATE&(DTREL'>EDATE),RQSTAT["C"!(RQSTAT="R") S TOT(DVBAPREXM,"COMPLETED")=TOT(DVBAPREXM,"COMPLETED")+1
"RTN","DVBCAMR2",57,0)
 I DTRPT'<BDATE,DTRPT'>EDATE,PRIO="E" S TOT(DVBAPREXM,"INSUFF")=TOT(DVBAPREXM,"INSUFF")+1
"RTN","DVBCAMR2",58,0)
 I DTCAN'<BDATE&(DTCAN'>EDATE),RQSTAT="X"!(RQSTAT="RX") S TOT(DVBAPREXM,"INCOMPLETE")=TOT(DVBAPREXM,"INCOMPLETE")+1
"RTN","DVBCAMR2",59,0)
 K DTRPT Q
"RTN","DVBCAMR2",60,0)
 ;
"RTN","DVBCAMR2",61,0)
GO ;
"RTN","DVBCAMR2",62,0)
 N DVBAEXMP,DVBAP,DVBAPREXM,DVBATOT,DVBAOUT,PG
"RTN","DVBCAMR2",63,0)
 S PG=0
"RTN","DVBCAMR2",64,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":";BDD;QS;",($G(DVBAPRTY)["IDES"):";IDES;",($G(DVBAPRTY)["AO"):";AO;",1:"")
"RTN","DVBCAMR2",65,0)
 S %DT="TS",X="NOW" D ^%DT S DVBCNOW=Y K ^TMP($J)
"RTN","DVBCAMR2",66,0)
 S PNAM="" F JJ=0:0 S PNAM=$O(^DVB(396.3,"B",PNAM)) Q:PNAM=""  F REQDA=0:0 S REQDA=$O(^DVB(396.3,"B",PNAM,REQDA)) Q:REQDA=""  D SET
"RTN","DVBCAMR2",67,0)
 ;
"RTN","DVBCAMR2",68,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBCAMR2",69,0)
 M DVBATOT=TOT  ;save totals for all priorities into new array
"RTN","DVBCAMR2",70,0)
 F DVBAP=1:1:$L(DVBAEXMP,",") D
"RTN","DVBCAMR2",71,0)
 .K DVBAOUT S DVBAPREXM=$P(DVBAEXMP,",",DVBAP)
"RTN","DVBCAMR2",72,0)
 .;re-create TOT array for each priority of exam
"RTN","DVBCAMR2",73,0)
 .D CRTOT(DVBAPREXM,.DVBATOT,.TOT)
"RTN","DVBCAMR2",74,0)
 .S TOT("AVGDAYS")=0
"RTN","DVBCAMR2",75,0)
 .I TOT("COMPLETED")>0 S TOT("AVGDAYS")=TOT("DAYS")/TOT("COMPLETED"),TOT("AVGDAYS")=$J(TOT("AVGDAYS"),5,1)
"RTN","DVBCAMR2",76,0)
 .D BULLTXT^DVBCAMR1(DVBAPREXM)
"RTN","DVBCAMR2",77,0)
 .U IO D HDR F JI=0.9:0 S JI=$O(^TMP($J,JI)) Q:JI=""  W ^(JI,0),! I IOST?1"C-".E,$Y>19 D PAUSE G:$D(DVBAOUT) EXIT D HDR
"RTN","DVBCAMR2",78,0)
 .D PAUSE I $D(DVBAOUT) W:SBULL="Y" !!,*7,"Bulletin will NOT be sent!!",*7,! H 2 G EXIT
"RTN","DVBCAMR2",79,0)
 .S:'$D(XMY) SBULL="N" I SBULL="Y" D SEND
"RTN","DVBCAMR2",80,0)
 D ^%ZISC
"RTN","DVBCAMR2",81,0)
 ;
"RTN","DVBCAMR2",82,0)
EXIT ;
"RTN","DVBCAMR2",83,0)
 Q:(DVBAP'=$L(DVBAEXMP,","))  ;another report to run
"RTN","DVBCAMR2",84,0)
 D:$D(ZTQUEUED) KILL^%ZTLOAD K PREVMO,UPDATE,XMY G KILL^DVBCUTIL
"RTN","DVBCAMR2",85,0)
 ;
"RTN","DVBCAMR2",86,0)
BULL W ! S XMDUZ=DUZ,XMMG=$S($D(^VA(200,DUZ,0)):$P(^(0),U,1),1:"") D DES^XMA21
"RTN","DVBCAMR2",87,0)
 Q
"RTN","DVBCAMR2",88,0)
 ;
"RTN","DVBCAMR2",89,0)
SEND ;send 2507 AMIS report in bulletin
"RTN","DVBCAMR2",90,0)
 N DVBAXMY M DVBAXMY=XMY
"RTN","DVBCAMR2",91,0)
 S XMSUB="RO AMIS 290 Report "_$S((($G(DVBAPREXM)]"")&($G(DVBAPREXM)'="ALL")):"("_$G(DVBAPREXM)_" Exam Priority) ",1:"")_"-  "
"RTN","DVBCAMR2",92,0)
 S Y=BDATE1 X ^DD("DD") S XMSUB=XMSUB_Y S Y=EDATE1 X ^DD("DD") S XMSUB=XMSUB_" to "_Y,XMTEXT="^TMP($J,"
"RTN","DVBCAMR2",93,0)
 D ^XMD K XMTEXT,XMSUB K ^TMP($J)
"RTN","DVBCAMR2",94,0)
 I '$D(ZTSK) W !!,*7,">>> Mail message transmitted. <<<",!! H 2
"RTN","DVBCAMR2",95,0)
 M XMY=DVBAXMY  ;restore address list for subsequent bulletins
"RTN","DVBCAMR2",96,0)
 Q
"RTN","DVBCAMR2",97,0)
 ;
"RTN","DVBCAMR2",98,0)
HDR S PG=PG+1 W:(IOST?1"C-".E) @IOF
"RTN","DVBCAMR2",99,0)
 W "Regional Office AMIS 290 Report for C&P Examinations",?(IOM-9),"Page: ",PG,!
"RTN","DVBCAMR2",100,0)
 W $$PRHD^DVBCIUTL(DVBAPREXM),!
"RTN","DVBCAMR2",101,0)
 W "For date range: " S Y=BDATE1 X ^DD("DD") W Y W " to " S Y=EDATE1 X ^DD("DD") W Y,!
"RTN","DVBCAMR2",102,0)
 F LINE=1:1:80 W "-"
"RTN","DVBCAMR2",103,0)
 W !!
"RTN","DVBCAMR2",104,0)
 Q
"RTN","DVBCAMR2",105,0)
 ;
"RTN","DVBCAMR2",106,0)
PAUSE N ANS K DVBAOUT S ANS="" I IOST?1"C-".E W *7,!!,"Press RETURN to continue or ""^"" to exit  " R ANS:DTIME I '$T!(ANS[U) S DVBAOUT=1
"RTN","DVBCAMR2",107,0)
 Q
"RTN","DVBCAMR2",108,0)
 ;
"RTN","DVBCAMR2",109,0)
 ;Input : DVBACDE - Priority of Exam code to get Totals for
"RTN","DVBCAMR2",110,0)
 ;      : DVBATOT - Array holding total values for each specific priority
"RTN","DVBCAMR2",111,0)
 ;                  (By Ref)
"RTN","DVBCAMR2",112,0)
 ;      : TOT     - array to hold totals for requested priority (By Ref)
"RTN","DVBCAMR2",113,0)
 ;Output: TOT array with totals for requested priority
"RTN","DVBCAMR2",114,0)
CRTOT(DVBACDE,DVBATOT,TOT) ;create total array for specific priority exam report
"RTN","DVBCAMR2",115,0)
 N JI K TOT
"RTN","DVBCAMR2",116,0)
 F JI="3DAYSCH","30DAYEX","PENDADJ" D
"RTN","DVBCAMR2",117,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMR2",118,0)
 F JI="INSUFF","SENT","INCOMPLETE","DAYS","COMPLETED" D
"RTN","DVBCAMR2",119,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMR2",120,0)
 F JI="P90","P121","P151","P181","P365","P366" D
"RTN","DVBCAMR2",121,0)
 .S TOT(JI)=$G(DVBATOT(DVBACDE,JI))
"RTN","DVBCAMR2",122,0)
 Q
"RTN","DVBCAMRO")
0^14^B10848195^B10861262
"RTN","DVBCAMRO",1,0)
DVBCAMRO ;ALB ISC/THM-REGIONAL OFFICE 2507 AMIS REPORT ; 9/28/91  6:39 AM
"RTN","DVBCAMRO",2,0)
 ;;2.7;AMIE;**17,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCAMRO",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCAMRO",4,0)
 ;
"RTN","DVBCAMRO",5,0)
SETUP ;
"RTN","DVBCAMRO",6,0)
 N DVBAPRTY,DVBAEXMP,DVBAP,DTOUT,DUOUT
"RTN","DVBCAMRO",7,0)
 S UPDATE="N",PREVMO=$P(^DVB(396.1,1,0),U,11),HD="REGIONAL OFFICE 2507 AMIS REPORT" I '$D(DT) S X="T" D ^%DT S DT=Y
"RTN","DVBCAMRO",8,0)
 S DVBCDT(0)=$$FMTE^XLFDT(DT,"5DZ")
"RTN","DVBCAMRO",9,0)
 D HOME^%ZIS S FF=IOF
"RTN","DVBCAMRO",10,0)
 ;prompt for priority of exam
"RTN","DVBCAMRO",11,0)
 S DVBAPRTY=$$EXMPRTY^DVBCIUTL("Select the Priority of Exam for the 2507 AMIS Report")
"RTN","DVBCAMRO",12,0)
 G:('(DVBAPRTY?.A)!(DVBAPRTY']"")) EXIT  ;quit if no priority of exam selected
"RTN","DVBCAMRO",13,0)
 ;
"RTN","DVBCAMRO",14,0)
INIT ;initialize counter arrays
"RTN","DVBCAMRO",15,0)
 S DVBAEXMP=$S($G(DVBAPRTY)["BDD":"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"ALL")
"RTN","DVBCAMRO",16,0)
 F JI="3DAYSCH","30DAYEX","PENDADJ" D
"RTN","DVBCAMRO",17,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMRO",18,0)
 F JI="INSUFF","SENT","INCOMPLETE","DAYS","COMPLETED" D
"RTN","DVBCAMRO",19,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMRO",20,0)
 F JI="P90","P121","P151","P181","P365","P366" D
"RTN","DVBCAMRO",21,0)
 .F DVBAP=1:1:$L(DVBAEXMP,",") S TOT($P(DVBAEXMP,",",DVBAP),JI)=0
"RTN","DVBCAMRO",22,0)
 ;
"RTN","DVBCAMRO",23,0)
EN W @IOF,!?(IOM-$L(HD)\2),HD,!!!
"RTN","DVBCAMRO",24,0)
 S %DT(0)=-DT,%DT="AE",%DT("A")="Enter STARTING DATE: " D ^%DT G:Y<0 EXIT S BDATE1=Y,BDATE=Y-.1
"RTN","DVBCAMRO",25,0)
 S %DT="AE",%DT("A")="    and ENDING DATE: " D ^%DT G:Y<0 EN S EDATE1=Y,EDATE=Y+.5
"RTN","DVBCAMRO",26,0)
 I EDATE1<BDATE1 W *7,!!,"Invalid date sequence - ending date is before starting date.",!! H 3 G EN
"RTN","DVBCAMRO",27,0)
 W !!,"When selecting regional offices you may enter an individual station name,",!,"station number or nothing if all regional offices should be searched.",!!
"RTN","DVBCAMRO",28,0)
 S DIC("A")="Select REGIONAL OFFICE NUMBER: ",DIC(0)="AEQM",DIC="^DIC(4," D ^DIC G:($D(DTOUT)!($D(DUOUT))) EXIT
"RTN","DVBCAMRO",29,0)
 I +Y>0 S DA=+Y,RONUM=$S($D(^DIC(4,DA,99)):$P(^(99),U,1),1:"000"),RONAME=$P(Y,U,2)
"RTN","DVBCAMRO",30,0)
 I +Y<0 S (RONUM,RONAME)="ALL"
"RTN","DVBCAMRO",31,0)
 ;
"RTN","DVBCAMRO",32,0)
ASK K %DT S SBULL="Y" W !!!,"Want to send a bulletin when processing is done" S %=1 D YN^DICN G:$D(DTOUT)!(%<0) EXIT
"RTN","DVBCAMRO",33,0)
 I $D(%Y) I %Y["?" W !!,"Enter Y to send the bulletin to selected recipients or N not to send it at all.",!! G ASK
"RTN","DVBCAMRO",34,0)
 I %'=1 S SBULL="N"
"RTN","DVBCAMRO",35,0)
 I SBULL="Y" D BULL^DVBCAMR2
"RTN","DVBCAMRO",36,0)
 W ! S %ZIS="AEQ",%ZIS("B")="0;P-OTHER",%ZIS("A")="Output device: " D ^%ZIS G:POP EXIT
"RTN","DVBCAMRO",37,0)
 I $D(IO("Q")) S ZTRTN="GO^DVBCAMR2",ZTDESC="2507 Amis Report",ZTIO=ION F I="UPDATE","RO*","PREVMO","BDATE*","TOT*","EDATE*","SBULL","DUZ","DVBCDT(0)","XM*","DVBAPRTY" S ZTSAVE(I)=""
"RTN","DVBCAMRO",38,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued",!! H 1 K ZTSK G EXIT
"RTN","DVBCAMRO",39,0)
 G GO^DVBCAMR2
"RTN","DVBCAMRO",40,0)
 ;
"RTN","DVBCAMRO",41,0)
EXIT K PREVMO,UPDATE G KILL^DVBCUTIL
"RTN","DVBCBUL1")
0^3^B10399602^B7938885
"RTN","DVBCBUL1",1,0)
DVBCBUL1 ;ALB/GTS - 557/THM-SEND EXAM ADD MESSAGE ; 2/7/91  6:56 AM
"RTN","DVBCBUL1",2,0)
 ;;2.7;AMIE;**42,184**;Apr 10, 1995;Build 10
"RTN","DVBCBUL1",3,0)
 ;
"RTN","DVBCBUL1",4,0)
 K ^TMP("DVBC","BUL1",$J),^TMP("DVBC","CMNT",$J) S DIC="^TMP(""DVBC"",""CMNT"",$J,99,",DWPK=1 W @IOF,!!,"Comments:",!! D EN^DIWE
"RTN","DVBCBUL1",5,0)
 K DWPK I $O(^TMP("DVBC","CMNT",$J,99,0))]"" S ^TMP("DVBC","BUL1",$J,98,0)=" ",^TMP("DVBC","BUL1",$J,97,0)="==========================<  Additional comments  >=========================="
"RTN","DVBCBUL1",6,0)
 F I=0:0 S I=$O(^TMP("DVBC","CMNT",$J,99,I)) Q:I=""  S ^TMP("DVBC","BUL1",$J,(I+99),0)=^TMP("DVBC","CMNT",$J,99,I,0)
"RTN","DVBCBUL1",7,0)
 K ^TMP("DVBC","CMNT",$J) S $P(DOTS,".",45)="."
"RTN","DVBCBUL1",8,0)
 ;
"RTN","DVBCBUL1",9,0)
GO S L=1,^TMP("DVBC","BUL1",$J,L,0)="The following veteran had one or more 2507 exams added:",L=L+1
"RTN","DVBCBUL1",10,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="   ",L=L+1
"RTN","DVBCBUL1",11,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="  DFN: `"_DFN_$E("                    ",1,20-$L(DFN))_"SITE: "_DVBCSITE,L=L+1
"RTN","DVBCBUL1",12,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="  "
"RTN","DVBCBUL1",13,0)
 S Y=$P(^DVB(396.3,REQDA,0),U,2) X ^DD("DD") S ^TMP("DVBC","BUL1",$J,L,0)="  Request date: "_Y,L=L+1
"RTN","DVBCBUL1",14,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="  ",L=L+1
"RTN","DVBCBUL1",15,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="Note:  Scheduling for this request must now be recompleted.",L=L+1
"RTN","DVBCBUL1",16,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="       A new request copy will be printed tomorrow morning.",L=L+1
"RTN","DVBCBUL1",17,0)
 ;
"RTN","DVBCBUL1",18,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="  ",L=L+1
"RTN","DVBCBUL1",19,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="** NOTE: To view the patient using the DFN, paste the DFN number into the    **",L=L+1
"RTN","DVBCBUL1",20,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="** CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to **",L=L+1
"RTN","DVBCBUL1",21,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="** include the ' (backward-apostrophe) character.                            **",L=L+1
"RTN","DVBCBUL1",22,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="  ",L=L+1
"RTN","DVBCBUL1",23,0)
 S ^TMP("DVBC","BUL1",$J,L,0)="** This is an auto-generated email.  Do not respond to this email address.   **",L=L+1
"RTN","DVBCBUL1",24,0)
 ;
"RTN","DVBCBUL1",25,0)
SEND S $P(^DVB(396.3,REQDA,0),U,6)="" ;reset date sched completed
"RTN","DVBCBUL1",26,0)
 S MG=$O(^XMB(3.8,"B","DVBA C EXAM ADDED",0)) I MG="" W !!,*7,"Bulletin not sent.",!,"DVBA C EXAM ADDED mail group not found.",!! H 3 Q
"RTN","DVBCBUL1",27,0)
 F JI=0:0 S JI=$O(^XMB(3.8,MG,1,"B",JI)) Q:JI=""  S XMY(JI)=""
"RTN","DVBCBUL1",28,0)
 S XMY(DUZ)="",XMSUB="Addition of 2507 Exams",XMTEXT="^TMP(""DVBC"",""BUL1"",$J,",XMDUZ=DUZ
"RTN","DVBCBUL1",29,0)
 I '$D(^VA(200,DUZ,.15)) S XMY(XMDUZ)="" G XMD
"RTN","DVBCBUL1",30,0)
 I $D(^VA(200,DUZ,.15))&($P(^VA(200,DUZ,.15),"^",1)="") S XMY(XMDUZ)="" G XMD
"RTN","DVBCBUL1",31,0)
 I $D(^VA(200,DUZ,.15)) S XMY($P(^VA(200,DUZ,.15),"^",1))=""
"RTN","DVBCBUL1",32,0)
XMD D ^XMD K ^TMP("DVBC","BUL1",$J),XMDUZ,DOTS,L,JI,JY,XMY,XMSUB,XMTEXT
"RTN","DVBCBUL1",33,0)
 Q
"RTN","DVBCBULL")
0^2^B19523211^B15506228
"RTN","DVBCBULL",1,0)
DVBCBULL ;ALB/GTS - 557/THM-SEND CANCELLATION BULLETIN ; 6/25/91  11:01 AM
"RTN","DVBCBULL",2,0)
 ;;2.7;AMIE;**42,184**;Apr 10, 1995;Build 10
"RTN","DVBCBULL",3,0)
 ;
"RTN","DVBCBULL",4,0)
 K ^TMP("DVBC","BULL",$J),^TMP("DVBC","CMNT",$J) S DIC="^TMP(""DVBC"",""CMNT"",$J,99,",DWPK=1 W @IOF,!!,"Cancellation comments:",!! D EN^DIWE
"RTN","DVBCBULL",5,0)
 K DWPK I $O(^TMP("DVBC","CMNT",$J,99,0))]"" S ^TMP("DVBC","BULL",$J,98,0)=" ",^TMP("DVBC","BULL",$J,97,0)="==========================<  Additional comments  >=========================="
"RTN","DVBCBULL",6,0)
 F I=0:0 S I=$O(^TMP("DVBC","CMNT",$J,99,I)) Q:I=""  S ^TMP("DVBC","BULL",$J,(I+99),0)=^TMP("DVBC","CMNT",$J,99,I,0)
"RTN","DVBCBULL",7,0)
 K ^TMP("DVBC","CMNT",$J) S $P(DOTS,".",45)="." W !!,"A bulletin will now be sent to the 2507 Cancellation mail group.",!
"RTN","DVBCBULL",8,0)
 ;
"RTN","DVBCBULL",9,0)
GO S L=1,^TMP("DVBC","BULL",$J,L,0)="The following veteran had one or more 2507 exams cancelled:",L=L+1
"RTN","DVBCBULL",10,0)
 S ^TMP("DVBC","BULL",$J,L,0)="   ",L=L+1
"RTN","DVBCBULL",11,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  DFN: `"_DFN_$E("                    ",1,20-$L(DFN))_"SITE: "_DVBCSITE,L=L+1
"RTN","DVBCBULL",12,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  REQUEST DATE: "_DVBCRDAT,L=L+1
"RTN","DVBCBULL",13,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  ",L=L+1
"RTN","DVBCBULL",14,0)
 S ^TMP("DVBC","BULL",$J,L,0)="Exams cancelled                               Reason",L=L+1
"RTN","DVBCBULL",15,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  ",L=L+1
"RTN","DVBCBULL",16,0)
 S EXAM="",RSTAT=$P(^DVB(396.3,REQDA,0),U,18)
"RTN","DVBCBULL",17,0)
 F JI=0:0 S EXAM=$O(CANC(EXAM)) Q:EXAM=""  I $P(CANC(EXAM),U,1)="X"!($P(CANC(EXAM),U,1)="RX") S REAS=+$P(CANC(EXAM),U,2) D EXAMS
"RTN","DVBCBULL",18,0)
 S ^TMP("DVBC","BULL",$J,L,0)=" ",L=L+1,COMP=1,CMPC=0
"RTN","DVBCBULL",19,0)
 ;
"RTN","DVBCBULL",20,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  ",L=L+1
"RTN","DVBCBULL",21,0)
 S ^TMP("DVBC","BULL",$J,L,0)="** NOTE: To view the patient using the DFN, paste the DFN number into the    **",L=L+1
"RTN","DVBCBULL",22,0)
 S ^TMP("DVBC","BULL",$J,L,0)="** CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to **",L=L+1
"RTN","DVBCBULL",23,0)
 S ^TMP("DVBC","BULL",$J,L,0)="** include the ' (backward-apostrophe) character.                            **",L=L+1
"RTN","DVBCBULL",24,0)
 S ^TMP("DVBC","BULL",$J,L,0)="  ",L=L+1
"RTN","DVBCBULL",25,0)
 ;
"RTN","DVBCBULL",26,0)
 K ^TMP("DVBC","CMNT",$J)
"RTN","DVBCBULL",27,0)
 I RSTAT["X" S ^TMP("DVBC","BULL",$J,L,0)=" *** All exams on this request are now CANCELLED. ***",L=L+1,^TMP("DVBC","BULL",$J,L,0)=" ",L=L+1
"RTN","DVBCBULL",28,0)
 S ^TMP("DVBC","BULL",$J,L,0)="** This is an auto-generated email.  Do not respond to this email address.   **",L=L+1
"RTN","DVBCBULL",29,0)
 G SEND
"RTN","DVBCBULL",30,0)
 S ECNT=0
"RTN","DVBCBULL",31,0)
 F JZ=0:0 S JZ=$O(^DVB(396.4,"C",REQDA,JZ)) Q:JZ=""  S STAT=$P(^DVB(396.4,JZ,0),U,4) S:STAT="C" CMPC=1 I STAT'="C"&(STAT'["X") S COMP=0,ECNT=ECNT+1
"RTN","DVBCBULL",32,0)
 ;CMPC=completed exam COMP=open exam
"RTN","DVBCBULL",33,0)
 ;both are toggled, depending on exam status.  Both must be 1 to put release banner on message
"RTN","DVBCBULL",34,0)
 I RSTAT'["X",COMP=0 S ^TMP("DVBC","BULL",$J,L,0)=" *** There "_$S(ECNT=1:"is",1:"are")_" still "_ECNT_" exam"_$S(ECNT=1:"",1:"s")_" open on this request. ***",L=L+1,^TMP("DVBC","BULL",$J,L,0)=" ",L=L+1 G SEND
"RTN","DVBCBULL",35,0)
 I COMP=1&(CMPC=1),RSTAT'["X" S ^TMP("DVBC","BULL",$J,L,0)=" *** This request is now COMPLETE and should be released by MAS ***",L=L+1
"RTN","DVBCBULL",36,0)
 I COMP=1&(CMPC=1),RSTAT'["X" S ^TMP("DVBC","BULL",$J,L,0)=" ",L=L+1 ;spacer
"RTN","DVBCBULL",37,0)
 ;
"RTN","DVBCBULL",38,0)
SEND ;remote sites get bulletins only on total cancellations
"RTN","DVBCBULL",39,0)
 S DIC="^XMB(3.8,",DIC(0)="QM",X="DVBA C 2507 CANCELLATION" D ^DIC S MG=+Y I +Y<0 W !!,*7,"2507 mail group NOT found!  Bulletin not sent.",!! H 3 Q
"RTN","DVBCBULL",40,0)
 F JI=0:0 S JI=$O(^XMB(3.8,MG,1,"B",JI)) Q:JI=""  S XMY(JI)=""
"RTN","DVBCBULL",41,0)
 F JI=0:0 S JI=$O(XMY(JI)) Q:JI=""!(+JI=0)  I '$D(^VA(200,JI,2,+REQRO))&'$D(^VA(200,JI,2,+REQRO))&('$D(^XUSEC("DVBA C SUPERVISOR",JI))) K XMY(JI)
"RTN","DVBCBULL",42,0)
 S:REQSTR="" REQSTR=.5 S XMY(REQSTR)="",XMY(DUZ)="",XMSUB="Cancellation of 2507 Exams",XMTEXT="^TMP(""DVBC"",""BULL"",$J,",XMDUZ=DUZ
"RTN","DVBCBULL",43,0)
 I '$D(^VA(200,DUZ,.15)) S XMY(XMDUZ)="" G XMD
"RTN","DVBCBULL",44,0)
 I $D(^VA(200,DUZ,.15))&($P(^VA(200,DUZ,.15),"^",1)="") S XMY(XMDUZ)="" G XMD
"RTN","DVBCBULL",45,0)
 I $D(^VA(200,DUZ,.15)) S XMY($P(^VA(200,DUZ,.15),"^",1))=""
"RTN","DVBCBULL",46,0)
XMD D ^XMD
"RTN","DVBCBULL",47,0)
 K ^TMP("DVBC","BULL",$J),XMDUZ,DOTS,COMP,CMPC,XEXAM,REASON,L,JI,JY,XMY,XMSUB,XMTEXT,XMDUZ,ECNT
"RTN","DVBCBULL",48,0)
 Q
"RTN","DVBCBULL",49,0)
 ;
"RTN","DVBCBULL",50,0)
EXAMS S REASON=$S($D(^DVB(396.5,+REAS,0)):$P(^(0),U,1),1:"Undetermined")
"RTN","DVBCBULL",51,0)
 S XEXAM=$E(EXAM,1,25),^TMP("DVBC","BULL",$J,L,0)="     "_XEXAM_" "_$E(DOTS,1,35-$L(XEXAM))_" "_REASON S L=L+1
"RTN","DVBCBULL",52,0)
 Q
"RTN","DVBCCNCL")
0^4^B27121636^B25585288
"RTN","DVBCCNCL",1,0)
DVBCCNCL ;ALB/GTS - 557/THM-2507 CANCEL REQUESTS, EXAMS ; 9/23/91  9:25 AM
"RTN","DVBCCNCL",2,0)
 ;;2.7;AMIE;**102,184**;Apr 10, 1995;Build 10
"RTN","DVBCCNCL",3,0)
 ;
"RTN","DVBCCNCL",4,0)
 G EN
"RTN","DVBCCNCL",5,0)
LOOK1 S EXAM=$S($D(^DVB(396.6,$P(^DVB(396.4,JZ,0),U,3),0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCCNCL",6,0)
 S STAT=$P(^DVB(396.4,JZ,0),U,4)
"RTN","DVBCCNCL",7,0)
 S $P(^TMP($J,EXAM),U,1)=STAT_U_JZ S:STAT="C" TCNCL=1 S:STAT="T" TCNCL=2
"RTN","DVBCCNCL",8,0)
 Q
"RTN","DVBCCNCL",9,0)
 ;
"RTN","DVBCCNCL",10,0)
EN ;
"RTN","DVBCCNCL",11,0)
 N DVBCARY,DVBCRDAT,DVBCSITE
"RTN","DVBCCNCL",12,0)
 D HOME^%ZIS S FF=IOF,HD="2507 Exam Veteran Selection",HD2="2507 Test Cancellation"
"RTN","DVBCCNCL",13,0)
 ;
"RTN","DVBCCNCL",14,0)
LOOK D KILL W @FF,!?(IOM-$L(HD)\2),HD,!?(IOM-$L(HD2)\2),HD2,!! S DIC("W")="D DICW^DVBCUTIL" S DIC="^DVB(396.3,",DIC(0)="AEQM",DIC("A")="Select VETERAN: " D ^DIC G:X=""!(X=U) EXIT I +Y<0 W *7,"  ???" G LOOK
"RTN","DVBCCNCL",15,0)
 S DA(1)=+Y,DFN=$P(Y,U,2),STAT=$P(^DVB(396.3,DA(1),0),U,18) D STATCHK G:$D(NCN) LOOK S REQDT=$P(^DVB(396.3,DA(1),0),U,2)
"RTN","DVBCCNCL",16,0)
 D GETS^DIQ(396.3,DA(1),"1;2","E","DVBCARY")
"RTN","DVBCCNCL",17,0)
 S DVBCRDAT=DVBCARY(396.3,DA(1)_",",1,"E")
"RTN","DVBCCNCL",18,0)
 S DVBCSITE=DVBCARY(396.3,DA(1)_",",2,"E")
"RTN","DVBCCNCL",19,0)
 I '$D(^DPT(DFN,0)) W *7,!!,"Zeroth node for ^DPT record missing!",!! H 3 G LOOK
"RTN","DVBCCNCL",20,0)
 S PNAM=$P(^DPT(DFN,0),U,1),SSN=$P(^(0),U,9),CNUM=$S($D(^DPT(DFN,.31)):$P(^(.31),U,3),1:"Unknown") K DICW
"RTN","DVBCCNCL",21,0)
 S REQRO=$P(^DVB(396.3,DA(1),0),U,3),REQSTR=$P(^(0),U,4) ;used to screen bulletins
"RTN","DVBCCNCL",22,0)
 K TCNCL F JZ=0:0 S JZ=$O(^DVB(396.4,"C",DA(1),JZ)) Q:JZ=""  D LOOK1
"RTN","DVBCCNCL",23,0)
 ;
"RTN","DVBCCNCL",24,0)
ASK I $D(TCNCL) W *7,!!,"This request cannot be cancelled entirely because",!," one or more exams have ",$S(TCNCL=2:"been transferred.",1:"been completed.")
"RTN","DVBCCNCL",25,0)
 I  W !!,"However, you may cancel other individual exams.",!!,"Press RETURN " R ANS:60 G:'$T!(ANS="^") EXIT G DATA
"RTN","DVBCCNCL",26,0)
 W !!,"Do you want to cancel the entire exam" S %=2 D YN^DICN G:$D(DTOUT)!(%<0) EXIT G:%=1 ^DVBCCNC1
"RTN","DVBCCNCL",27,0)
 I $D(%Y),%Y["?" W !!,"Enter Y to cancel the ENTIRE exam or N to cancel ONLY selected exams",!! G ASK
"RTN","DVBCCNCL",28,0)
 ;
"RTN","DVBCCNCL",29,0)
DATA K EXMPTR,NCN
"RTN","DVBCCNCL",30,0)
 D HDR^DVBCUTIL
"RTN","DVBCCNCL",31,0)
EXMSEL S REQDA=DA(1),Y=$$EXSRH^DVBCUTL4("Select EXAM TO CANCEL: ","I $D(^DVB(396.4,""ARQ""_REQDA,+Y))") ;*Exam lookup function call
"RTN","DVBCCNCL",32,0)
 K DIC("S"),REQDA
"RTN","DVBCCNCL",33,0)
 G:$D(DTOUT) EXIT I X=""!(X=U)&($D(CANC)) D BULL^DVBCCNC1 G LOOK
"RTN","DVBCCNCL",34,0)
 I $D(X),X=""!(X=U)&('$D(CANC)) G LOOK
"RTN","DVBCCNCL",35,0)
 I Y=-1 W *7,"  ??" G EXMSEL  ;DVBA*2.7*102
"RTN","DVBCCNCL",36,0)
 I ($P(^DVB(396.4,+Y,0),U,4)["X")!($P(^DVB(396.4,+Y,0),U,4)="T") W *7," ??" G EXMSEL
"RTN","DVBCCNCL",37,0)
 S EXMPTR=+Y,EXMNM=$P(^DVB(396.4,+Y,0),U,3)
"RTN","DVBCCNCL",38,0)
 S EXMNM=$S($D(^DVB(396.6,EXMNM,0)):$P(^(0),U,1),1:"Unknown exam")
"RTN","DVBCCNCL",39,0)
 S STAT=$P(^TMP($J,EXMNM),U,1) D STATCHK G:$D(NCN) DATA
"RTN","DVBCCNCL",40,0)
 D CNCLCHK G:NOFND=0 DATA G:$D(OUT) EXIT
"RTN","DVBCCNCL",41,0)
 ;
"RTN","DVBCCNCL",42,0)
 ;  ** If selected an exam, enter Cancellation Reason.
"RTN","DVBCCNCL",43,0)
 S DVBCMSG=" for this "_EXMNM_" exam:",EXMCNC="" D CODE G:$D(OUT) EXIT
"RTN","DVBCCNCL",44,0)
 S DR="52R;.04////"_CCODE_";51////^S X=DUZ;50///NOW",DIE="^DVB(396.4,"
"RTN","DVBCCNCL",45,0)
 S DA=EXMPTR D ^DIE K DR,DIE G:($D(Y))!($D(DTOUT)) EXIT
"RTN","DVBCCNCL",46,0)
 S STAT=$P(^DVB(396.4,DA,0),U,4),REASON=+$P(^DVB(396.4,DA,"CAN"),U,3)
"RTN","DVBCCNCL",47,0)
 G:REASON=0 LOOK S $P(^TMP($J,EXMNM),U,1)=STAT
"RTN","DVBCCNCL",48,0)
 S ^TMP("DVBA",$J,9999999-$P(^DVB(396.4,EXMPTR,"CAN"),U,1))=CCODE
"RTN","DVBCCNCL",49,0)
 S CANC(EXMNM)=STAT_U_REASON D CNCLCHK I $D(OUT) G EXIT
"RTN","DVBCCNCL",50,0)
 K %DT G DATA
"RTN","DVBCCNCL",51,0)
 ;
"RTN","DVBCCNCL",52,0)
EXIT D KILL K CCODE,DVBCMSG,TCNCL,^TMP($J),EXMPTR,J G KILL^DVBCUTIL
"RTN","DVBCCNCL",53,0)
 ;
"RTN","DVBCCNCL",54,0)
KILL K TCNCL,DIC,DA,D0,D1,DFN,X,Y,OLDEXAM,JDR,REQDT,DR,EXMNM,NCN,STAT,%,NOFND,CANC,^TMP($J),%Y,Z,JY,JZ,DA,DIC,DIE,ALLCANC
"RTN","DVBCCNCL",55,0)
 K DVBCARY,DVBCRDAT,DVBCSITE
"RTN","DVBCCNCL",56,0)
 Q
"RTN","DVBCCNCL",57,0)
 ;
"RTN","DVBCCNCL",58,0)
CNCLCHK S NOFND=0,Z=$P(^DVB(396.3,DA(1),0),U,18) Q:Z="X"!(Z="RX")  K Z S I="" F J=0:0 S I=$O(^TMP($J,I)) Q:I=""  I $P(^TMP($J,I),U,1)'="X"&($P(^(I),U,1)'="RX") S NOFND=1
"RTN","DVBCCNCL",59,0)
 Q:NOFND=1  W *7,!!,"Since all exams have been cancelled",!,"the entire request will be CANCELLED.",!! H 3
"RTN","DVBCCNCL",60,0)
 S DVBCMSG=" for this request:" D CODE
"RTN","DVBCCNCL",61,0)
 S DR="17////"_CCODE_";19///NOW;20////^S X=DUZ"
"RTN","DVBCCNCL",62,0)
 S DA=DA(1),DIE="^DVB(396.3," D ^DIE S DA=DA(1) D NOTIFY^DVBCCNC1
"RTN","DVBCCNCL",63,0)
 Q
"RTN","DVBCCNCL",64,0)
 ;
"RTN","DVBCCNCL",65,0)
STATCHK Q:STAT="P"!(STAT="N")!(STAT="NT")!(STAT="S")!(STAT="O")
"RTN","DVBCCNCL",66,0)
 W !!,*7,"This exam or request has been ",$S(STAT="RX":"cancelled by the RO",STAT="X":"cancelled by MAS",STAT="T":"transcribed",STAT="R":"released",STAT="C":"completed",STAT="CT":"completed, transferred out",1:"given an incorrect status"),".",!!
"RTN","DVBCCNCL",67,0)
 S NCN=1 H 2 Q
"RTN","DVBCCNCL",68,0)
 ;NCN=no can do
"RTN","DVBCCNCL",69,0)
 Q
"RTN","DVBCCNCL",70,0)
 ;
"RTN","DVBCCNCL",71,0)
CODE S:'$D(DVBCMSG) DVBCMSG=":" W @IOF,!,"Please enter cancellation code"_DVBCMSG,! K OUT,%
"RTN","DVBCCNCL",72,0)
 S DIR("A")="CANCELLED BY"
"RTN","DVBCCNCL",73,0)
 S:'$D(EXMCNC) DIR(0)="SO^X:MAS CANCELLATION;RX:REGIONAL OFFICE CANCELLATION"
"RTN","DVBCCNCL",74,0)
 S:$D(EXMCNC) DIR(0)="S^X:MAS CANCELLATION;RX:REGIONAL OFFICE CANCELLATION"
"RTN","DVBCCNCL",75,0)
 D ^DIR S CCODE=Y
"RTN","DVBCCNCL",76,0)
 I CCODE=U&('$D(EXMCNC)) W !!,*7,"NO '^' ALLOWED AT THIS PROMPT" D CONTMES^DVBCUTL4 G CODE
"RTN","DVBCCNCL",77,0)
 I $D(DTOUT) D RQCODE^DVBCUTL2 S OUT=1 Q
"RTN","DVBCCNCL",78,0)
 I (X=""&('$D(EXMCNC))) W !,*7,"This is a required response." D CONTMES^DVBCUTL4 G CODE
"RTN","DVBCCNCL",79,0)
CNCBY W !!,*7,"CANCELLED BY ",$S(CCODE="X":"MAS",CCODE="RX":"RO",1:"???"),", OK" S %=2 D YN^DICN I %=2 G CODE
"RTN","DVBCCNCL",80,0)
 I %=-1&('$D(EXMCNC)&('$D(DTOUT))) W !!,*7,"NO '^' ALLOWED AT THIS PROMPT" D CONTMES^DVBCUTL4 G CNCBY
"RTN","DVBCCNCL",81,0)
 K EXMCNC
"RTN","DVBCCNCL",82,0)
 I $D(DTOUT) D BULL^DVBCCNC1 S OUT=1 Q
"RTN","DVBCCNCL",83,0)
 Q
"RTN","DVBCHS1")
0^17^B5171006^B5480980
"RTN","DVBCHS1",1,0)
DVBCHS1 ;ALB/JRP - C & P EXTRACT FOR HEALTH SUMMARY (CONT);11-JAN-95
"RTN","DVBCHS1",2,0)
 ;;2.7;AMIE;**149,184**;Apr 10, 1995;Build 10
"RTN","DVBCHS1",3,0)
OUT0(PTR,ARR) ;SET NODE ZERO OF OUTPUT
"RTN","DVBCHS1",4,0)
 ;INPUT  : PTR - Pointer to 2507 EXAM file (#396.4)
"RTN","DVBCHS1",5,0)
 ;         ARR - Where to place output (full global reference)
"RTN","DVBCHS1",6,0)
 ;OUTPUT : None
"RTN","DVBCHS1",7,0)
 ;         See HSCP() for format of output array
"RTN","DVBCHS1",8,0)
 ;NOTES  : All input is assumed to exist (no error checking)
"RTN","DVBCHS1",9,0)
 ;
"RTN","DVBCHS1",10,0)
 N CODE,FMDATE,TYPE,DOCTOR,PRIORITY
"RTN","DVBCHS1",11,0)
 N INVDATE,NODE,REQPTR,TYPEPTR,TMP
"RTN","DVBCHS1",12,0)
 ;GET ZERO NODE OF 2507 EXAM
"RTN","DVBCHS1",13,0)
 S NODE=$G(^DVB(396.4,PTR,0))
"RTN","DVBCHS1",14,0)
 ;GET INFO OFF OF NODE
"RTN","DVBCHS1",15,0)
 S REQPTR=+$P(NODE,"^",2)
"RTN","DVBCHS1",16,0)
 S TYPEPTR=+$P(NODE,"^",3)
"RTN","DVBCHS1",17,0)
 S FMDATE=+$P(NODE,"^",6)
"RTN","DVBCHS1",18,0)
 S DOCTOR=$P(NODE,"^",7)
"RTN","DVBCHS1",19,0)
 S:(DOCTOR="") DOCTOR="UNKNOWN"
"RTN","DVBCHS1",20,0)
 ;GET PRIORITY FROM ZERO NODE OF 2507 REQUEST
"RTN","DVBCHS1",21,0)
 S NODE=$G(^DVB(396.3,REQPTR,0))
"RTN","DVBCHS1",22,0)
 S TMP=$P(NODE,"^",10)
"RTN","DVBCHS1",23,0)
 ;CONVERT PRIORITY TO EXTERNAL FORMAT
"RTN","DVBCHS1",24,0)
 S PRIORITY="UNKNOWN"
"RTN","DVBCHS1",25,0)
 S:(TMP="T") PRIORITY="TERMINAL"
"RTN","DVBCHS1",26,0)
 S:(TMP="P") PRIORITY="POW"
"RTN","DVBCHS1",27,0)
 S:(TMP="OS") PRIORITY="ORIGINAL SC"
"RTN","DVBCHS1",28,0)
 S:(TMP="ON") PRIORITY="ORIGINAL NSC"
"RTN","DVBCHS1",29,0)
 S:(TMP="I") PRIORITY="INCREASE"
"RTN","DVBCHS1",30,0)
 S:(TMP="R") PRIORITY="REVIEW"
"RTN","DVBCHS1",31,0)
 S:(TMP="OTR") PRIORITY="OTHER"
"RTN","DVBCHS1",32,0)
 S:(TMP="E") PRIORITY="INSUFFICIENT EXAM"
"RTN","DVBCHS1",33,0)
 S:(TMP="AO") PRIORITY="AGENT ORANGE"
"RTN","DVBCHS1",34,0)
 S:(TMP="BDD") PRIORITY="BEN DELIV AT DISCHG"
"RTN","DVBCHS1",35,0)
 S:(TMP="IDES") PRIORITY="IDES"
"RTN","DVBCHS1",36,0)
 S:(TMP="QS") PRIORITY="QUICK START"
"RTN","DVBCHS1",37,0)
 ;CONVERT EXAM TYPE TO EXTERNAL FORMAT
"RTN","DVBCHS1",38,0)
 S TYPE=$P($G(^DVB(396.6,TYPEPTR,0)),"^",1)
"RTN","DVBCHS1",39,0)
 S:('TYPEPTR) TYPE="UNKNOWN"
"RTN","DVBCHS1",40,0)
 ;DETERMINE CODE (BASED ON TRANSFER OUT/IN DATES)
"RTN","DVBCHS1",41,0)
 S NODE=$G(^DVB(396.4,PTR,"TRAN"))
"RTN","DVBCHS1",42,0)
 ;DONE AT LOCAL FACILITY
"RTN","DVBCHS1",43,0)
 S CODE=1
"RTN","DVBCHS1",44,0)
 ;DONE AT REMOTE FACILITY
"RTN","DVBCHS1",45,0)
 S:($P(NODE,"^",1)'="") CODE=2
"RTN","DVBCHS1",46,0)
 ;DONE AT LOCAL FACILITY FOR REMOTE FACILITY
"RTN","DVBCHS1",47,0)
 S:($P(NODE,"^",4)'="") CODE=3
"RTN","DVBCHS1",48,0)
 ;CALCULATE INVERSE EXAM DATE
"RTN","DVBCHS1",49,0)
 S INVDATE=9999999-FMDATE
"RTN","DVBCHS1",50,0)
 ;PUT INFO INTO GLOBAL
"RTN","DVBCHS1",51,0)
 S @ARR@(INVDATE,TYPEPTR,0)=CODE_"^"_FMDATE_"^"_TYPE_"^"_DOCTOR_"^"_PRIORITY
"RTN","DVBCHS1",52,0)
 Q
"RTN","DVBCHS1",53,0)
OUTRES(PTR,ARR) ;SET NODE 'RES' OF OUTPUT
"RTN","DVBCHS1",54,0)
 ;INPUT  : PTR - Pointer to 2507 EXAM file (#396.4)
"RTN","DVBCHS1",55,0)
 ;         ARR - Where to place output (full global reference)
"RTN","DVBCHS1",56,0)
 ;OUTPUT : None
"RTN","DVBCHS1",57,0)
 ;         See HSCP^DVBCHS0() for format of output array
"RTN","DVBCHS1",58,0)
 ;NOTES  : All input is assumed to exist (no error checking)
"RTN","DVBCHS1",59,0)
 ;
"RTN","DVBCHS1",60,0)
 N LINE,LINES,INVDATE,FMDATE,TYPEPTR,NODE
"RTN","DVBCHS1",61,0)
 ;GET EXAM DATE & TYPE
"RTN","DVBCHS1",62,0)
 S NODE=$G(^DVB(396.4,PTR,0))
"RTN","DVBCHS1",63,0)
 S TYPEPTR=+$P(NODE,"^",3)
"RTN","DVBCHS1",64,0)
 S FMDATE=+$P(NODE,"^",6)
"RTN","DVBCHS1",65,0)
 ;CALCULATE INVERSE EXAM DATE
"RTN","DVBCHS1",66,0)
 S INVDATE=9999999-FMDATE
"RTN","DVBCHS1",67,0)
 ;PUT RESULTS INTO GLOBAL
"RTN","DVBCHS1",68,0)
 S LINE=0,LINES=1
"RTN","DVBCHS1",69,0)
 F  S LINE=+$O(^DVB(396.4,PTR,"RES",LINE)) Q:('LINE)  D
"RTN","DVBCHS1",70,0)
 .S @ARR@(INVDATE,TYPEPTR,"RES",LINES)=$G(^DVB(396.4,PTR,"RES",LINE,0))
"RTN","DVBCHS1",71,0)
 .S LINES=LINES+1
"RTN","DVBCHS1",72,0)
 ;PUT NUMBER OF LINES INFO INTO GLOBAL
"RTN","DVBCHS1",73,0)
 S @ARR@(INVDATE,TYPEPTR,"RES",0)=LINES-1
"RTN","DVBCHS1",74,0)
 Q
"RTN","DVBCIRP1")
0^19^B47449535^B46484005
"RTN","DVBCIRP1",1,0)
DVBCIRP1 ;ALB/GTS-AMIE INSUFFICIENT 2507 RPT -CONT 1 ; 11/10/94  1:30 PM
"RTN","DVBCIRP1",2,0)
 ;;2.7;AMIE;**13,19,27,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCIRP1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCIRP1",4,0)
 ;
"RTN","DVBCIRP1",5,0)
 ;** Version Changes
"RTN","DVBCIRP1",6,0)
 ;   2.7 - New routine (Enhc 15)
"RTN","DVBCIRP1",7,0)
 ;
"RTN","DVBCIRP1",8,0)
SUMRPT ;**Output the summary report
"RTN","DVBCIRP1",9,0)
 W:IOST?1"C-".E @IOF
"RTN","DVBCIRP1",10,0)
 D SUMHD
"RTN","DVBCIRP1",11,0)
 ;print request data
"RTN","DVBCIRP1",12,0)
 W !?3,"Total 2507 requests received for date range:",?71,$J(DVBARQCT,5)
"RTN","DVBCIRP1",13,0)
 W !?3,"Total insufficient 2507 requests received for date range:",?71,$J(DVBAINRQ,5)
"RTN","DVBCIRP1",14,0)
 W !?3,"Total insufficient 2507 requests cancelled by RO for date range:",?71,$J(DVBACAN("REQ"),5)
"RTN","DVBCIRP1",15,0)
 I DVBARQCT>0 D
"RTN","DVBCIRP1",16,0)
 .S PERCENT=(DVBAINRQ/DVBARQCT)*100
"RTN","DVBCIRP1",17,0)
 .W !?3,"% of insufficient requests per total requests received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",18,0)
 .S PERCENT=((DVBAINRQ-DVBACAN("REQ"))/DVBARQCT)*100
"RTN","DVBCIRP1",19,0)
 .W !?3,"% of uncancelled insufficient requests per total requests received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",20,0)
 I DVBARQCT'>0 D
"RTN","DVBCIRP1",21,0)
 .S PERCENT=0
"RTN","DVBCIRP1",22,0)
 .W !?3,"% of insufficient requests per total requests received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",23,0)
 .W !?3,"% of uncancelled insufficient requests per total requests received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",24,0)
 ;print exam data
"RTN","DVBCIRP1",25,0)
 W !!?3,"Total 2507 exams received for date range:",?71,$J(DVBAXMCT,5)
"RTN","DVBCIRP1",26,0)
 W !?3,"Total insufficient 2507 exams received for date range:",?71,$J(DVBAINXM,5)
"RTN","DVBCIRP1",27,0)
 W !?3,"Total insufficient 2507 exams cancelled by RO for date range:",?71,$J(DVBACAN("EXM"),5)
"RTN","DVBCIRP1",28,0)
 I DVBAXMCT>0 D
"RTN","DVBCIRP1",29,0)
 .S PERCENT=(DVBAINXM/DVBAXMCT)*100
"RTN","DVBCIRP1",30,0)
 .W !?3,"% of insufficient exams per total exams received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",31,0)
 .S PERCENT=((DVBAINXM-DVBACAN("EXM"))/DVBAXMCT)*100
"RTN","DVBCIRP1",32,0)
 .W !?3,"% of uncancelled insufficient exams per total exams received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",33,0)
 I DVBAXMCT'>0 D
"RTN","DVBCIRP1",34,0)
 .S PERCENT=0
"RTN","DVBCIRP1",35,0)
 .W !?3,"% of insufficient exams per total exams received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",36,0)
 .W !?3,"% of uncancelled insufficient exams per total exams received:",?71,$J(PERCENT,5,1)_"%"
"RTN","DVBCIRP1",37,0)
 ;print insufficient reason data
"RTN","DVBCIRP1",38,0)
 I IOST?1"C-".E DO
"RTN","DVBCIRP1",39,0)
 .K DTOUT,DUOUT
"RTN","DVBCIRP1",40,0)
 .W !!
"RTN","DVBCIRP1",41,0)
 .D PAUSE^DVBCUTL4
"RTN","DVBCIRP1",42,0)
 .I '$D(DTOUT),('$D(DUOUT)) DO
"RTN","DVBCIRP1",43,0)
 ..W @IOF
"RTN","DVBCIRP1",44,0)
 ..D SUMHD
"RTN","DVBCIRP1",45,0)
 I '$D(DTOUT),('$D(DUOUT)) DO
"RTN","DVBCIRP1",46,0)
 .W:IOST'?1"C-".E !!
"RTN","DVBCIRP1",47,0)
 .W !?15,"Summary of insufficient exams per Reason",!
"RTN","DVBCIRP1",48,0)
 .W !?3,"Reason",?53,"Num",?59,"Percent"
"RTN","DVBCIRP1",49,0)
 .N DVBARSLP S DVBARSLP=""
"RTN","DVBCIRP1",50,0)
 .F  S DVBARSLP=$O(DVBAINXM(DVBARSLP)) Q:DVBARSLP=""  DO  ;**Reason tot's
"RTN","DVBCIRP1",51,0)
 ..W:+DVBARSLP>0 !?3,$P(^DVB(396.94,DVBARSLP,0),U,3),?53,DVBAINXM(DVBARSLP)
"RTN","DVBCIRP1",52,0)
 ..I +DVBARSLP'>0,(+DVBAINXM(DVBARSLP)>0) W !?3,"Exams without insufficient reason indicated",?53,DVBAINXM(DVBARSLP)
"RTN","DVBCIRP1",53,0)
 ..W:(+DVBAINXM(DVBARSLP)>0&(DVBAINXM>0)) ?59,($P(((DVBAINXM(DVBARSLP)/DVBAINXM)*100),".",1))_$S($E($P(((DVBAINXM(DVBARSLP)/DVBAINXM)*100),".",2),1,1)'="":"."_$E($P(((DVBAINXM(DVBARSLP)/DVBAINXM)*100),".",2),1,1),1:"")_" %"
"RTN","DVBCIRP1",54,0)
 .I IOST?1"C-".E DO
"RTN","DVBCIRP1",55,0)
 ..D CONTMES^DVBCUTL4
"RTN","DVBCIRP1",56,0)
 Q
"RTN","DVBCIRP1",57,0)
 ;
"RTN","DVBCIRP1",58,0)
SUMHD ;** Output Summary Report heading
"RTN","DVBCIRP1",59,0)
 N STRTDT,LSTDT,DVBATXT,DVBASL
"RTN","DVBCIRP1",60,0)
 W !?15,"Summary Insufficient Exam Report for ",$$SITE^DVBCUTL4(),!
"RTN","DVBCIRP1",61,0)
 S Y=$P(BEGDT,".",1) X ^DD("DD") S STRTDT=Y K Y
"RTN","DVBCIRP1",62,0)
 S Y=$P(ENDDT,".",1) X ^DD("DD") S LSTDT=Y K Y
"RTN","DVBCIRP1",63,0)
 S DVBASL=$L($$SITE^DVBCUTL4)
"RTN","DVBCIRP1",64,0)
 S DVBATXT=$$PRHD^DVBCIUTL(DVBAPRTY)
"RTN","DVBCIRP1",65,0)
 W ?(((67+DVBASL)-$L(DVBATXT))\2),DVBATXT,!
"RTN","DVBCIRP1",66,0)
 W !?16,"For Date Range: "_STRTDT_" to "_LSTDT,!
"RTN","DVBCIRP1",67,0)
 Q
"RTN","DVBCIRP1",68,0)
 ;
"RTN","DVBCIRP1",69,0)
DETAIL ;** Output reason, exam type and exam info
"RTN","DVBCIRP1",70,0)
 N STRTDT,LSTDT,DVBARQST,DVBAEXMP,DVBAP,DVBAPREXM
"RTN","DVBCIRP1",71,0)
 K ^TMP("DVBAEXAMS",$J)
"RTN","DVBCIRP1",72,0)
 S Y=$P(BEGDT,".",1) X ^DD("DD") S STRTDT=Y K Y
"RTN","DVBCIRP1",73,0)
 S Y=$P(ENDDT,".",1) X ^DD("DD") S LSTDT=Y K Y
"RTN","DVBCIRP1",74,0)
 U IO
"RTN","DVBCIRP1",75,0)
 S DVBADTLP=BEGDT
"RTN","DVBCIRP1",76,0)
 S DVBAENDL=ENDDT
"RTN","DVBCIRP1",77,0)
 S DVBAPRTY=$S(($G(DVBAPRTY)["BDD"):";BDD;QS;",($G(DVBAPRTY)["IDES"):";IDES;",($G(DVBAPRTY)["AO"):";AO;",1:"")
"RTN","DVBCIRP1",78,0)
 D:((DVBAPRTY']"")!(DVBAPRTY["AO")!(DVBAPRTY["IDES")) DETHD^DVBCIUTL
"RTN","DVBCIRP1",79,0)
 S RSDA=""
"RTN","DVBCIRP1",80,0)
 S DVBAPG1=""
"RTN","DVBCIRP1",81,0)
 F  S RSDA=$O(DVBAARY("REASON",RSDA)) Q:(RSDA=""!($D(GETOUT)))  DO
"RTN","DVBCIRP1",82,0)
 .K DVBARSPT
"RTN","DVBCIRP1",83,0)
 .S TPDA=""
"RTN","DVBCIRP1",84,0)
 .F  S TPDA=$O(^TMP($J,"XMTYPE",TPDA)) Q:(TPDA=""!($D(GETOUT)))  DO
"RTN","DVBCIRP1",85,0)
 ..K DVBAXMPT
"RTN","DVBCIRP1",86,0)
 ..S XMDA=""
"RTN","DVBCIRP1",87,0)
 ..F  S XMDA=$O(^DVB(396.4,"AIT",RSDA,TPDA,XMDA)) Q:(XMDA=""!($D(GETOUT)))  DO
"RTN","DVBCIRP1",88,0)
 ...S DVBARQST=$G(^DVB(396.3,$P(^DVB(396.4,XMDA,0),U,2),0))
"RTN","DVBCIRP1",89,0)
 ...;retrieve Priority of Exam from Current/Parent(if exists) 2507 Request
"RTN","DVBCIRP1",90,0)
 ...S DVBAPREXM=$$CHKREQ($P(^DVB(396.4,XMDA,0),U,2))
"RTN","DVBCIRP1",91,0)
 ...I $P(DVBARQST,U,5)>DVBADTLP,($P(DVBARQST,U,5)<DVBAENDL) D
"RTN","DVBCIRP1",92,0)
 ....;Current-As Is (All Others, except new priorities)
"RTN","DVBCIRP1",93,0)
 ....D:((DVBAPRTY']"")&((";BDD;QS;IDES;AO;")'[(";"_DVBAPREXM_";"))) EXMOUT^DVBCIUTL
"RTN","DVBCIRP1",94,0)
 ....;Report for Specific Priority of Exam(s)
"RTN","DVBCIRP1",95,0)
 ....D:((DVBAPRTY]"")&(DVBAPRTY[(";"_DVBAPREXM_";")))
"RTN","DVBCIRP1",96,0)
 .....D:(DVBAPREXM="AO")!(DVBAPREXM="IDES") EXMOUT^DVBCIUTL  ;Agent Orange or IDES Single Report
"RTN","DVBCIRP1",97,0)
 .....;BDD,QS require report for each priority code
"RTN","DVBCIRP1",98,0)
 .....;for performance grab all data then print 2 reports
"RTN","DVBCIRP1",99,0)
 .....S:(DVBAPREXM'="AO")&(DVBAPREXM'="IDES") ^TMP("DVBAEXAMS",$J,DVBAPREXM,RSDA,TPDA,XMDA)=""
"RTN","DVBCIRP1",100,0)
 I '$D(GETOUT),(IOST?1"C-".E),((DVBAPRTY']"")!(DVBAPRTY["AO")) D CONTMES^DVBCUTL4
"RTN","DVBCIRP1",101,0)
 D:((DVBAPRTY]"")&(DVBAPRTY'["AO")&(DVBAPRTY'["IDES"))  ;print BDD reports
"RTN","DVBCIRP1",102,0)
 .K DVBAPG1 S DVBAEXMP=DVBAPRTY,RSDA=""
"RTN","DVBCIRP1",103,0)
 .F DVBAP=$P(DVBAEXMP,";",2),$P(DVBAEXMP,";",3)  D
"RTN","DVBCIRP1",104,0)
 ..Q:DVBAP=""
"RTN","DVBCIRP1",105,0)
 ..S DVBAPRTY=DVBAP
"RTN","DVBCIRP1",106,0)
 ..D DETHD^DVBCIUTL S DVBAPG1=""
"RTN","DVBCIRP1",107,0)
 ..F  S RSDA=$O(^TMP("DVBAEXAMS",$J,DVBAP,RSDA)) Q:(('+RSDA)!($D(GETOUT)))  D
"RTN","DVBCIRP1",108,0)
 ...K DVBARSPT S TPDA=""
"RTN","DVBCIRP1",109,0)
 ...F  S TPDA=$O(^TMP("DVBAEXAMS",$J,DVBAP,RSDA,TPDA)) Q:(('+TPDA)!($D(GETOUT)))  D
"RTN","DVBCIRP1",110,0)
 ....K DVBAXMPT S XMDA=""
"RTN","DVBCIRP1",111,0)
 ....F  S XMDA=$O(^TMP("DVBAEXAMS",$J,DVBAP,RSDA,TPDA,XMDA)) Q:(('+XMDA)!($D(GETOUT)))  D EXMOUT^DVBCIUTL
"RTN","DVBCIRP1",112,0)
 ..I '$D(GETOUT),(IOST?1"C-".E) D CONTMES^DVBCUTL4
"RTN","DVBCIRP1",113,0)
 ..K GETOUT W !
"RTN","DVBCIRP1",114,0)
 D ^%ZISC
"RTN","DVBCIRP1",115,0)
 D KVARS ;**KILL the variables used by DETAIL
"RTN","DVBCIRP1",116,0)
 Q
"RTN","DVBCIRP1",117,0)
 ;
"RTN","DVBCIRP1",118,0)
KVARS ;** Final Kill for Detail report
"RTN","DVBCIRP1",119,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","DVBCIRP1",120,0)
 K ^TMP($J),DVBAARY,DVBANAME,DVBASSN,DVBACNUM,RSDA,TPDA,XMDA,DVBADTLP
"RTN","DVBCIRP1",121,0)
 K DVBAENDL,DVBARSPT,DVBAXMPT,REQDA,DFN,DVBAORXM,DVBAXMTP,DVBACMND
"RTN","DVBCIRP1",122,0)
 K DVBAORPV,DVBAORP1,DVBADTWK,DVBADTE,DVBAORDT,DVBANAM1,GETOUT
"RTN","DVBCIRP1",123,0)
 K DVBAARY,DVBAPG1,DVBARQDT,DVBAXDT,DVBAXRS,^TMP("DVBAEXAMS",$J)
"RTN","DVBCIRP1",124,0)
 Q
"RTN","DVBCIRP1",125,0)
 ;
"RTN","DVBCIRP1",126,0)
DETSEL ;** Select the details to report
"RTN","DVBCIRP1",127,0)
 D RSEL^DVBCIUTL
"RTN","DVBCIRP1",128,0)
 I '$D(DVBAARY("REASON")) S DVBAQTSL=""
"RTN","DVBCIRP1",129,0)
 I $D(DVBAQTSL) DO
"RTN","DVBCIRP1",130,0)
 .S DIR("A",1)="You have not selected Insufficient reasons to report."
"RTN","DVBCIRP1",131,0)
 .S DIR("A",2)="This is required to print the Detailed report."
"RTN","DVBCIRP1",132,0)
 .S DIR("A",3)=" "
"RTN","DVBCIRP1",133,0)
 .S DIR(0)="FAO^1:1",DIR("A")="Hit Return to continue." D ^DIR K DIR,X,Y
"RTN","DVBCIRP1",134,0)
 I '$D(DVBAQTSL) DO
"RTN","DVBCIRP1",135,0)
 .D XMSEL^DVBCIUTL
"RTN","DVBCIRP1",136,0)
 .I '$D(^TMP($J,"XMTYPE")) S DVBAQTSL=""
"RTN","DVBCIRP1",137,0)
 .I $D(DVBAQTSL) DO
"RTN","DVBCIRP1",138,0)
 ..S DIR("A",1)="You have not selected Exams to report."
"RTN","DVBCIRP1",139,0)
 ..S DIR("A",2)="This is required to print the Detailed report."
"RTN","DVBCIRP1",140,0)
 ..S DIR("A",3)=" "
"RTN","DVBCIRP1",141,0)
 ..S DIR(0)="FAO^1:1",DIR("A")="Hit Return to continue." D ^DIR K DIR,X,Y
"RTN","DVBCIRP1",142,0)
 ..K DVBAARY("REASON")
"RTN","DVBCIRP1",143,0)
 Q
"RTN","DVBCIRP1",144,0)
 ;
"RTN","DVBCIRP1",145,0)
 ;Input:  IEN of 2507 Request in File #396.3
"RTN","DVBCIRP1",146,0)
 ;Output: Priority of Exam for the Current/Parent 2507 Request
"RTN","DVBCIRP1",147,0)
CHKREQ(DVBARIEN) ;check for parent requests
"RTN","DVBCIRP1",148,0)
 N DVBAPIEN,DVBAPEXM
"RTN","DVBCIRP1",149,0)
 Q:($G(DVBARIEN)']"") ""
"RTN","DVBCIRP1",150,0)
 S DVBAPEXM=$P($G(^DVB(396.3,DVBARIEN,0)),U,10)  ;Priority of Exam
"RTN","DVBCIRP1",151,0)
 S DVBAPIEN=$P($G(^DVB(396.3,DVBARIEN,5)),U)  ;parent IEN if it exists
"RTN","DVBCIRP1",152,0)
 I (DVBAPIEN]"") D  ;Parent 2507 Request
"RTN","DVBCIRP1",153,0)
 .S DVBAPEXM=$P($G(^DVB(396.3,DVBAPIEN,0)),U,10)  ;Priority of Exam
"RTN","DVBCIRP1",154,0)
 Q DVBAPEXM
"RTN","DVBCIRPT")
0^18^B48144132^B47028205
"RTN","DVBCIRPT",1,0)
DVBCIRPT ;ALB/GTS-AMIE C&P INSUFF EXAM TRACKING RPT ; 11/9/94  2:00 PM
"RTN","DVBCIRPT",2,0)
 ;;2.7;AMIE;**13,19,27,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCIRPT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCIRPT",4,0)
 ;
"RTN","DVBCIRPT",5,0)
 ;** Version Changes
"RTN","DVBCIRPT",6,0)
 ;   2.7 - New routine (Enhc 15)
"RTN","DVBCIRPT",7,0)
 ;
"RTN","DVBCIRPT",8,0)
MAIN ;**Select Dte Rng & Rpt Type; call report routine
"RTN","DVBCIRPT",9,0)
 F  Q:$D(DVBAOUT)  DO
"RTN","DVBCIRPT",10,0)
 .D HOME^%ZIS
"RTN","DVBCIRPT",11,0)
 .S TVAR(1,0)="0,0,1,2:2,1^Insufficient 2507 Exam Report"
"RTN","DVBCIRPT",12,0)
 .D WR^DVBAUTL4("TVAR")
"RTN","DVBCIRPT",13,0)
 .K TVAR
"RTN","DVBCIRPT",14,0)
 .S DVBAPRTY=$$EXMPRTY^DVBCIUTL("Select Priority of Exam for the Insufficient Exam Report")  ;priority of exam selection
"RTN","DVBCIRPT",15,0)
 .S RPTTYPE=$S((DVBAPRTY?.A)&(DVBAPRTY]""):$$RPTTYPE^DVBCUTA1(),1:"")
"RTN","DVBCIRPT",16,0)
 .S:((RPTTYPE'="D")&(RPTTYPE'="S")) DVBAOUT=""
"RTN","DVBCIRPT",17,0)
 .W:'$D(DVBAOUT) !!
"RTN","DVBCIRPT",18,0)
 .D:'$D(DVBAOUT) DATE^DVBCUTL4(.BEGDT,.ENDDT)
"RTN","DVBCIRPT",19,0)
 .I $D(ENDDT),(+ENDDT>0) DO
"RTN","DVBCIRPT",20,0)
 ..S ENDDT=ENDDT_".2359"
"RTN","DVBCIRPT",21,0)
 ..I RPTTYPE="S" DO
"RTN","DVBCIRPT",22,0)
 ...D DEVSEL
"RTN","DVBCIRPT",23,0)
 ...I POP D SUMKILL
"RTN","DVBCIRPT",24,0)
 ...I 'POP DO
"RTN","DVBCIRPT",25,0)
 ....I $D(IO("Q")) DO
"RTN","DVBCIRPT",26,0)
 .....N DVBAI
"RTN","DVBCIRPT",27,0)
 .....S ZTRTN="SUM^DVBCIRPT",ZTIO=ION
"RTN","DVBCIRPT",28,0)
 .....S ZTDESC="Summary Insufficient Exam Report"
"RTN","DVBCIRPT",29,0)
 .....F DVBAI="BEGDT","ENDDT","DVBAPRTY" S ZTSAVE(DVBAI)=""
"RTN","DVBCIRPT",30,0)
 .....D ^%ZTLOAD
"RTN","DVBCIRPT",31,0)
 .....N TSK S TSK=$S($D(ZTSK)=0:"C",1:"Y")
"RTN","DVBCIRPT",32,0)
 .....I TSK="Y" W !!,"Summary Report Queued. Task number: ",ZTSK
"RTN","DVBCIRPT",33,0)
 .....K ZTSK D CONTMES^DVBCUTL4
"RTN","DVBCIRPT",34,0)
 .....D SUMKILL
"RTN","DVBCIRPT",35,0)
 ....I '$D(IO("Q")) D SUM
"RTN","DVBCIRPT",36,0)
 ...D ^%ZISC
"RTN","DVBCIRPT",37,0)
 ..I RPTTYPE="D" DO
"RTN","DVBCIRPT",38,0)
 ...D DETSEL^DVBCIRP1 ;**Select the Reasons and Exams to report
"RTN","DVBCIRPT",39,0)
 ...I '$D(DVBAQTSL) DO
"RTN","DVBCIRPT",40,0)
 ....D DEVSEL
"RTN","DVBCIRPT",41,0)
 ....I POP D KVARS^DVBCIRP1
"RTN","DVBCIRPT",42,0)
 ....I 'POP DO
"RTN","DVBCIRPT",43,0)
 .....I $D(IO("Q")) DO
"RTN","DVBCIRPT",44,0)
 ......N DVBAI
"RTN","DVBCIRPT",45,0)
 ......S ZTRTN="DETAIL^DVBCIRP1",ZTIO=ION
"RTN","DVBCIRPT",46,0)
 ......S ZTDESC="Detailed Insufficient Exam Report"
"RTN","DVBCIRPT",47,0)
 ......F DVBAI="BEGDT","ENDDT","DVBAPRTY","DVBAARY(""REASON"",","^TMP($J,""XMTYPE""," S ZTSAVE(DVBAI)=""
"RTN","DVBCIRPT",48,0)
 ......D ^%ZTLOAD
"RTN","DVBCIRPT",49,0)
 ......N TSK S TSK=$S($D(ZTSK)=0:"C",1:"Y")
"RTN","DVBCIRPT",50,0)
 ......I TSK="Y" W !!,"Detail Report Queued. Task number: ",ZTSK
"RTN","DVBCIRPT",51,0)
 ......K ZTSK D CONTMES^DVBCUTL4
"RTN","DVBCIRPT",52,0)
 ......D KVARS^DVBCIRP1
"RTN","DVBCIRPT",53,0)
 .....I '$D(IO("Q")) W:IOST?1"C-".E @IOF D DETAIL^DVBCIRP1
"RTN","DVBCIRPT",54,0)
 ....D ^%ZISC
"RTN","DVBCIRPT",55,0)
 ...K DVBAQTSL
"RTN","DVBCIRPT",56,0)
 ..D CLEANUP
"RTN","DVBCIRPT",57,0)
 D KVARS
"RTN","DVBCIRPT",58,0)
 Q
"RTN","DVBCIRPT",59,0)
 ;
"RTN","DVBCIRPT",60,0)
KVARS ;** Kill the variables used in report
"RTN","DVBCIRPT",61,0)
 K DVBAOUT,ENDDT,BEGDT,DTOUT,DUOUT,RPTTYPE,DVBACAN,DVBASTAT,DVBAPRTY
"RTN","DVBCIRPT",62,0)
 D CLEANUP
"RTN","DVBCIRPT",63,0)
 Q
"RTN","DVBCIRPT",64,0)
 ;
"RTN","DVBCIRPT",65,0)
CLEANUP ;** Kill the variables used by the device handler
"RTN","DVBCIRPT",66,0)
 K %ZIS,POP,%IS,IOP
"RTN","DVBCIRPT",67,0)
 K IOBS,IOHG,IOPAR,IOUPAR,IOXY,POP,%DT,%YY,%XX,ION,IOPAR
"RTN","DVBCIRPT",68,0)
 Q
"RTN","DVBCIRPT",69,0)
 ;
"RTN","DVBCIRPT",70,0)
DEVSEL ;** Select the device to report to
"RTN","DVBCIRPT",71,0)
 S %ZIS="AEQ"
"RTN","DVBCIRPT",72,0)
 S %ZIS("A")="Output device: "
"RTN","DVBCIRPT",73,0)
 D ^%ZIS
"RTN","DVBCIRPT",74,0)
 Q
"RTN","DVBCIRPT",75,0)
 ;
"RTN","DVBCIRPT",76,0)
SUM ;** Set up reason counter array, count all 2507's received
"RTN","DVBCIRPT",77,0)
 N DVBAEXMP,DVBAI,DVBAP,DVBATVAR,DVBAMCDES,DVBAPREXM
"RTN","DVBCIRPT",78,0)
 U IO
"RTN","DVBCIRPT",79,0)
 S (DVBARQCT,DVBAINRQ,DVBAXMCT,DVBAINXM)=0
"RTN","DVBCIRPT",80,0)
 S DVBACAN("REQ")=0,DVBACAN("EXM")=0
"RTN","DVBCIRPT",81,0)
 S DVBAENDL=ENDDT
"RTN","DVBCIRPT",82,0)
 S DVBAEXMP=$S(($G(DVBAPRTY)["BDD"):";BDD;QS;",($G(DVBAPRTY)["IDES"):";IDES;",($G(DVBAPRTY)["AO"):";AO;",1:"")
"RTN","DVBCIRPT",83,0)
 ; S DVBAMCDES=((DVBAEXMP]"")&(DVBAPRTY'="AO"))
"RTN","DVBCIRPT",84,0)
 S NUMRPTS=$L(DVBAEXMP,";")
"RTN","DVBCIRPT",85,0)
 S DVBAMCDES=((DVBAEXMP]"")&(NUMRPTS>3))
"RTN","DVBCIRPT",86,0)
 K ^TMP("DVBATOTALS",$J)  ;for multiple priority reporting
"RTN","DVBCIRPT",87,0)
 ;
"RTN","DVBCIRPT",88,0)
 ;** Initialize reason counter array(s)
"RTN","DVBCIRPT",89,0)
 F DVBARIFN=0:0 S DVBARIFN=$O(^DVB(396.94,DVBARIFN)) Q:+DVBARIFN'>0  DO
"RTN","DVBCIRPT",90,0)
 .D:(DVBAMCDES)
"RTN","DVBCIRPT",91,0)
 ..F DVBAP=$P(DVBAEXMP,";",2),$P(DVBAEXMP,";",3)  D
"RTN","DVBCIRPT",92,0)
 ...Q:DVBAP=""
"RTN","DVBCIRPT",93,0)
 ...S ^TMP("DVBATOTALS",$J,DVBAP,"DVBAINXM",DVBARIFN)=0
"RTN","DVBCIRPT",94,0)
 .S DVBAINXM(DVBARIFN)=0
"RTN","DVBCIRPT",95,0)
 D:(DVBAMCDES)
"RTN","DVBCIRPT",96,0)
 .F DVBAP=$P(DVBAEXMP,";",2),$P(DVBAEXMP,";",3)  D
"RTN","DVBCIRPT",97,0)
 ..Q:DVBAP=""
"RTN","DVBCIRPT",98,0)
 ..S ^TMP("DVBATOTALS",$J,DVBAP,"DVBAINXM","NO REASON")=0
"RTN","DVBCIRPT",99,0)
 S DVBAINXM("NO REASON")=0
"RTN","DVBCIRPT",100,0)
 ;
"RTN","DVBCIRPT",101,0)
 ;** Count the total and insufficient number of exams and 2507 requests
"RTN","DVBCIRPT",102,0)
 ;     For performance, if multiple reports, store totals in single pass of data
"RTN","DVBCIRPT",103,0)
 S DVBADTLP=BEGDT-.0001
"RTN","DVBCIRPT",104,0)
 F  S DVBADTLP=$O(^DVB(396.3,"ADP",DVBADTLP)) Q:(DVBADTLP=""!(DVBADTLP>ENDDT))  DO
"RTN","DVBCIRPT",105,0)
 .S DVBAPRIO=""
"RTN","DVBCIRPT",106,0)
 .F  S DVBAPRIO=$O(^DVB(396.3,"ADP",DVBADTLP,DVBAPRIO)) Q:DVBAPRIO=""  DO
"RTN","DVBCIRPT",107,0)
 ..S DVBADALP=""
"RTN","DVBCIRPT",108,0)
 ..F  S DVBADALP=$O(^DVB(396.3,"ADP",DVBADTLP,DVBAPRIO,DVBADALP)) Q:DVBADALP=""  DO
"RTN","DVBCIRPT",109,0)
 ...;check for Parent Request (retrieve current/parent Priority of Exam)
"RTN","DVBCIRPT",110,0)
 ...S DVBAPREXM=$$CHKREQ^DVBCIRP1(DVBADALP)
"RTN","DVBCIRPT",111,0)
 ...;original report run (Exclude new priorities)
"RTN","DVBCIRPT",112,0)
 ...Q:((DVBAEXMP']"")&((";BDD;QS;IDES;AO;")[(";"_DVBAPREXM_";")))
"RTN","DVBCIRPT",113,0)
 ...;report for specific Priority of Exam
"RTN","DVBCIRPT",114,0)
 ...Q:((DVBAEXMP]"")&(DVBAEXMP'[(";"_DVBAPREXM_";")))
"RTN","DVBCIRPT",115,0)
 ...S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBARQCT")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBARQCT"))+1
"RTN","DVBCIRPT",116,0)
 ...S DVBARQCT=DVBARQCT+1
"RTN","DVBCIRPT",117,0)
 ...K DVBAINSF
"RTN","DVBCIRPT",118,0)
 ...I DVBAPRIO="E" DO
"RTN","DVBCIRPT",119,0)
 ....S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINRQ")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINRQ"))+1
"RTN","DVBCIRPT",120,0)
 ....S DVBAINRQ=DVBAINRQ+1
"RTN","DVBCIRPT",121,0)
 ....I $P(^DVB(396.3,DVBADALP,0),U,18)="RX" D
"RTN","DVBCIRPT",122,0)
 .....S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBACANREQ")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBACANREQ"))+1
"RTN","DVBCIRPT",123,0)
 .....S DVBACAN("REQ")=DVBACAN("REQ")+1
"RTN","DVBCIRPT",124,0)
 ....S DVBAINSF=""
"RTN","DVBCIRPT",125,0)
 ...S DVBAXMDA=""
"RTN","DVBCIRPT",126,0)
 ...F  S DVBAXMDA=$O(^DVB(396.4,"C",DVBADALP,DVBAXMDA)) Q:DVBAXMDA=""  DO
"RTN","DVBCIRPT",127,0)
 ....S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAXMCT")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAXMCT"))+1
"RTN","DVBCIRPT",128,0)
 ....S DVBAXMCT=DVBAXMCT+1
"RTN","DVBCIRPT",129,0)
 ....I $D(DVBAINSF) DO
"RTN","DVBCIRPT",130,0)
 .....S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINXM")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINXM"))+1
"RTN","DVBCIRPT",131,0)
 .....S DVBAINXM=DVBAINXM+1
"RTN","DVBCIRPT",132,0)
 .....S DVBARIFN=$P(^DVB(396.4,DVBAXMDA,0),U,11),DVBASTAT=$P(^(0),U,4)
"RTN","DVBCIRPT",133,0)
 .....S:DVBARIFN="" DVBARIFN="NO REASON"
"RTN","DVBCIRPT",134,0)
 .....S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINXM",DVBARIFN)=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBAINXM",DVBARIFN))+1
"RTN","DVBCIRPT",135,0)
 .....S DVBAINXM(DVBARIFN)=DVBAINXM(DVBARIFN)+1
"RTN","DVBCIRPT",136,0)
 .....I DVBASTAT="RX" D
"RTN","DVBCIRPT",137,0)
 ......S:(DVBAMCDES) ^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBACANEXM")=$G(^TMP("DVBATOTALS",$J,DVBAPREXM,"DVBACANEXM"))+1
"RTN","DVBCIRPT",138,0)
 ......S DVBACAN("EXM")=DVBACAN("EXM")+1
"RTN","DVBCIRPT",139,0)
 ;
"RTN","DVBCIRPT",140,0)
 S DVBAEXMP=$S(($G(DVBAPRTY)["BDD"):"BDD,QS",($G(DVBAPRTY)["IDES"):"IDES",($G(DVBAPRTY)["AO"):"AO",1:"")
"RTN","DVBCIRPT",141,0)
 F DVBAI=1:1:$L(DVBAEXMP,",")  D
"RTN","DVBCIRPT",142,0)
 .S DVBAPRTY=$P(DVBAEXMP,",",DVBAI)  ;priority to report on
"RTN","DVBCIRPT",143,0)
 .D:(DVBAI>1)  ;Form Feed between multiple Reports
"RTN","DVBCIRPT",144,0)
 ..S DVBATVAR(1,0)="0,0,0,0,1^"
"RTN","DVBCIRPT",145,0)
 ..D WR^DVBAUTL4("DVBATVAR")
"RTN","DVBCIRPT",146,0)
 .;
"RTN","DVBCIRPT",147,0)
 .D:(DVBAMCDES)  ;reset var cntrs for specific priority
"RTN","DVBCIRPT",148,0)
 ..S DVBARQCT=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBARQCT"))
"RTN","DVBCIRPT",149,0)
 ..S DVBAINRQ=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBAINRQ"))
"RTN","DVBCIRPT",150,0)
 ..S DVBACAN("REQ")=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBACANREQ"))
"RTN","DVBCIRPT",151,0)
 ..S DVBAXMCT=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBAXMCT"))
"RTN","DVBCIRPT",152,0)
 ..S DVBAINXM=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBAINXM"))
"RTN","DVBCIRPT",153,0)
 ..S DVBAP=0 F  S DVBAP=$O(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBAINXM",DVBAP)) Q:DVBAP=""  D
"RTN","DVBCIRPT",154,0)
 ...S DVBAINXM(DVBAP)=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBAINXM",DVBAP))
"RTN","DVBCIRPT",155,0)
 ..S DVBACAN("EXM")=+$G(^TMP("DVBATOTALS",$J,DVBAPRTY,"DVBACANEXM"))
"RTN","DVBCIRPT",156,0)
 .;
"RTN","DVBCIRPT",157,0)
 .D SUMRPT^DVBCIRP1  ;print SUMMARY report
"RTN","DVBCIRPT",158,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","DVBCIRPT",159,0)
 D SUMKILL
"RTN","DVBCIRPT",160,0)
 D ^%ZISC
"RTN","DVBCIRPT",161,0)
 Q
"RTN","DVBCIRPT",162,0)
 ;
"RTN","DVBCIRPT",163,0)
SUMKILL ;** Kill the variables used in the summary report
"RTN","DVBCIRPT",164,0)
 K DVBADTLP,DVBAENDL,DVBARQCT,DVBAINRQ,DVBAXMCT,DVBAINXM
"RTN","DVBCIRPT",165,0)
 K DVBAPRIO,DVBADALP,DVBAXMDA,DVBAINSF,DVBARIFN
"RTN","DVBCIRPT",166,0)
 K ^TMP("DVBATOTALS",$J)
"RTN","DVBCIRPT",167,0)
 Q
"RTN","DVBCIUTL")
0^20^B37112339^B37860545
"RTN","DVBCIUTL",1,0)
DVBCIUTL ;ALB/GTS-AMIE INSUFFICIENT RPT UTILITY RTN ; 11/14/94  9:15 AM
"RTN","DVBCIUTL",2,0)
 ;;2.7;AMIE;**13,17,19,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCIUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCIUTL",4,0)
 ;
"RTN","DVBCIUTL",5,0)
 ;** Version Changes
"RTN","DVBCIUTL",6,0)
 ;   2.7 - New routine (Enhc 15)
"RTN","DVBCIUTL",7,0)
 ;
"RTN","DVBCIUTL",8,0)
DETHD ;** Detailed Report header
"RTN","DVBCIUTL",9,0)
 N DVBAI,DVBATXT S DVBAI=2
"RTN","DVBCIUTL",10,0)
 S:'$D(DVBAPG1) TVAR(1,0)="0,15,0,1,0^Detailed Insufficient Exam Report"
"RTN","DVBCIUTL",11,0)
 S:$D(DVBAPG1) TVAR(1,0)="0,15,0,1,1^Detailed Insufficient Exam Report"
"RTN","DVBCIUTL",12,0)
 S DVBATXT=$$PRHD(DVBAPRTY)
"RTN","DVBCIUTL",13,0)
 S TVAR(DVBAI,0)="0,"_((63-$L(DVBATXT))\2)_",0,1,0^"_DVBATXT
"RTN","DVBCIUTL",14,0)
 S DVBAI=DVBAI+1
"RTN","DVBCIUTL",15,0)
 S TVAR(DVBAI,0)="0,11,0,2,0^For Date Range: "_STRTDT_" to "_LSTDT
"RTN","DVBCIUTL",16,0)
 D WR^DVBAUTL4("TVAR")
"RTN","DVBCIUTL",17,0)
 K TVAR
"RTN","DVBCIUTL",18,0)
 Q
"RTN","DVBCIUTL",19,0)
 ;
"RTN","DVBCIUTL",20,0)
 ;Input : DVBAPRTY - Priority Exam Code (File #396.3 Fld #9)
"RTN","DVBCIUTL",21,0)
 ;Output: Description for Priority Exam Code
"RTN","DVBCIUTL",22,0)
PRHD(DVBAPRTY) ;priority exam type header info
"RTN","DVBCIUTL",23,0)
 N DVBATXT
"RTN","DVBCIUTL",24,0)
 S DVBATXT=$S((DVBAPRTY["BDD"):"Benefits Delivery at Discharge",1:"X")
"RTN","DVBCIUTL",25,0)
 S:(DVBATXT="X") DVBATXT=$S((DVBAPRTY["QS"):"Quick Start",1:"X")
"RTN","DVBCIUTL",26,0)
 S:(DVBATXT="X") DVBATXT=$S((DVBAPRTY["IDES"):"Integrated Disability Evaluation System",1:"X")
"RTN","DVBCIUTL",27,0)
 S:(DVBATXT="X") DVBATXT=$S((DVBAPRTY["AO"):"Agent Orange",1:"Excludes Exam Priorities: AO,BDD,IDES,QS")
"RTN","DVBCIUTL",28,0)
 S:(DVBATXT'["Excludes") DVBATXT="Priority of Exam: "_DVBATXT
"RTN","DVBCIUTL",29,0)
 Q $G(DVBATXT)
"RTN","DVBCIUTL",30,0)
 ;
"RTN","DVBCIUTL",31,0)
EXMOUT ;** Output exam information for reason/type
"RTN","DVBCIUTL",32,0)
 I $Y>(IOSL-9) DO
"RTN","DVBCIUTL",33,0)
 .I IOST?1"C-".E D TERM^DVBCUTL3
"RTN","DVBCIUTL",34,0)
 .I '$D(GETOUT) DO
"RTN","DVBCIUTL",35,0)
 ..D DETHD
"RTN","DVBCIUTL",36,0)
 ..D RESOUT
"RTN","DVBCIUTL",37,0)
 ..W !
"RTN","DVBCIUTL",38,0)
 ..D TYPEOUT
"RTN","DVBCIUTL",39,0)
 ..S (DVBARSPT,DVBAXMPT)=""
"RTN","DVBCIUTL",40,0)
 I '$D(GETOUT) DO
"RTN","DVBCIUTL",41,0)
 .I '$D(DVBARSPT) DO
"RTN","DVBCIUTL",42,0)
 ..D RESOUT
"RTN","DVBCIUTL",43,0)
 ..S DVBARSPT=""
"RTN","DVBCIUTL",44,0)
 .I '$D(DVBAXMPT) DO
"RTN","DVBCIUTL",45,0)
 ..W !
"RTN","DVBCIUTL",46,0)
 ..D TYPEOUT
"RTN","DVBCIUTL",47,0)
 ..S DVBAXMPT=""
"RTN","DVBCIUTL",48,0)
 .S (DVBARQDT,DVBAXDT,DVBAXRS)=""
"RTN","DVBCIUTL",49,0)
 .S REQDA=$P(^DVB(396.4,XMDA,0),U,2) ;*REQDA of PRIORITY Insuf 2507
"RTN","DVBCIUTL",50,0)
 .I $D(^DVB(396.4,XMDA,"CAN")) D
"RTN","DVBCIUTL",51,0)
 ..S DVBAXDT=$P(^DVB(396.4,XMDA,"CAN"),U,1),DVBAXRS=$P(^("CAN"),U,3)
"RTN","DVBCIUTL",52,0)
 ..I DVBAXDT S DVBAXDT=$$FMTE^XLFDT(DVBAXDT,"5DZ")
"RTN","DVBCIUTL",53,0)
 ..I DVBAXRS S DVBAXRS=$P(^DVB(396.5,DVBAXRS,0),U,1)
"RTN","DVBCIUTL",54,0)
 .I +REQDA>0 DO  ;*Get REQDA of Orig 2507
"RTN","DVBCIUTL",55,0)
 ..S DFN=$P(^DVB(396.3,REQDA,0),U,1),DVBARQDT=$P(^(0),U,2),DVBARQDT=$$FMTE^XLFDT(DVBARQDT,"5DZ")
"RTN","DVBCIUTL",56,0)
 ..I '$D(^DVB(396.3,REQDA,5)) S REQDA=""
"RTN","DVBCIUTL",57,0)
 ..I +REQDA>0,($D(^DVB(396.3,REQDA,5))) S REQDA=$P(^DVB(396.3,REQDA,5),U,1)
"RTN","DVBCIUTL",58,0)
 .S DVBAORXM=""
"RTN","DVBCIUTL",59,0)
 .I +REQDA>0 DO  ;*If link to orig 2507
"RTN","DVBCIUTL",60,0)
 ..S DVBAXMTP=$P(^DVB(396.4,XMDA,0),U,3)
"RTN","DVBCIUTL",61,0)
 ..S DVBACMND="F  S DVBAORXM=$O(^DVB(396.4,""ARQ"_REQDA_""","_DVBAXMTP_",DVBAORXM)) Q:DVBAORXM=""""  Q:$D(^DVB(396.4,""APS"","_DFN_","_DVBAXMTP_",""C"",DVBAORXM))"
"RTN","DVBCIUTL",62,0)
 ..X DVBACMND ;**Return DA of original, insuff exam
"RTN","DVBCIUTL",63,0)
 .S DVBANAME=$P(^DPT(DFN,0),U,1)
"RTN","DVBCIUTL",64,0)
 .S DVBASSN=$P(^DPT(DFN,0),U,9)
"RTN","DVBCIUTL",65,0)
 .S DVBACNUM="" S:$D(^DPT(DFN,.31)) DVBACNUM=$P(^DPT(DFN,.31),U,3)
"RTN","DVBCIUTL",66,0)
 .I DVBAORXM'="",($D(^DVB(396.4,DVBAORXM,0))) S DVBAORDT=$P(^DVB(396.4,DVBAORXM,0),U,6)
"RTN","DVBCIUTL",67,0)
 .I DVBAORXM'="",('$D(^DVB(396.4,DVBAORXM,0))) S (DVBAORDT,DVBADTE)=""
"RTN","DVBCIUTL",68,0)
 .S:DVBAORXM="" (DVBAORDT,DVBADTE)=""
"RTN","DVBCIUTL",69,0)
 .I DVBAORDT'="" DO
"RTN","DVBCIUTL",70,0)
 ..S DVBADTWK=$P(DVBAORDT,".",1)
"RTN","DVBCIUTL",71,0)
 ..S DVBADTE=$$FMTE^XLFDT(DVBADTWK,"5DZ")
"RTN","DVBCIUTL",72,0)
 .S DVBAORPV=$P(^DVB(396.4,XMDA,0),U,12)
"RTN","DVBCIUTL",73,0)
 .S DVBAORP1=$E(DVBAORPV,1,15)
"RTN","DVBCIUTL",74,0)
 .S DVBANAM1=$E(DVBANAME,1,15)
"RTN","DVBCIUTL",75,0)
 .W !,DVBAORP1
"RTN","DVBCIUTL",76,0)
 .W:$L(DVBAORPV)>$L(DVBAORP1) "**" ;**Indicate that Dr.'s Name truncated
"RTN","DVBCIUTL",77,0)
 .W ?20,DVBADTE,?32,DVBANAM1
"RTN","DVBCIUTL",78,0)
 .W:$L(DVBANAME)>$L(DVBANAM1) "**" ;**Indicate that Vet's Name truncated
"RTN","DVBCIUTL",79,0)
 .W ?52,DVBASSN,?66,DVBACNUM
"RTN","DVBCIUTL",80,0)
 .I DVBAXDT]"" D
"RTN","DVBCIUTL",81,0)
 ..W !,"Exam request of "_DVBARQDT_" to correct insufficiency was cancelled on "_DVBAXDT_"."
"RTN","DVBCIUTL",82,0)
 ..W !,"Reason: "_DVBAXRS_"."
"RTN","DVBCIUTL",83,0)
 Q
"RTN","DVBCIUTL",84,0)
 ;
"RTN","DVBCIUTL",85,0)
RESOUT ;** Output the Reason
"RTN","DVBCIUTL",86,0)
 W !!!!!,"Reason: ",$P(^DVB(396.94,$P(^DVB(396.4,XMDA,0),U,11),0),U,3)
"RTN","DVBCIUTL",87,0)
 Q
"RTN","DVBCIUTL",88,0)
 ;
"RTN","DVBCIUTL",89,0)
TYPEOUT ;** Output the Exam
"RTN","DVBCIUTL",90,0)
 W !,"Exam: ",$P(^DVB(396.6,$P(^DVB(396.4,XMDA,0),U,3),0),U,2)
"RTN","DVBCIUTL",91,0)
 W !,"Provider",?20,"Exam Dt",?32,"Patient Name",?52,"SSN",?66,"Claim #"
"RTN","DVBCIUTL",92,0)
 Q
"RTN","DVBCIUTL",93,0)
 ;
"RTN","DVBCIUTL",94,0)
RSEL ;** Select Reasons
"RTN","DVBCIUTL",95,0)
 ;** The selection prompt is defaulted to ALL.  If the user selects
"RTN","DVBCIUTL",96,0)
 ;**  'All', only reasons for exams entered on requests with a
"RTN","DVBCIUTL",97,0)
 ;**  priority of 'Insufficient' will be reported.  Not all reasons.
"RTN","DVBCIUTL",98,0)
 ;
"RTN","DVBCIUTL",99,0)
 W @IOF,!
"RTN","DVBCIUTL",100,0)
 W !,"Insufficient Reason Selection"
"RTN","DVBCIUTL",101,0)
 S DVBCYQ=""
"RTN","DVBCIUTL",102,0)
 N RESANS,DVBAOUT S DVBAOUT="" ;**Pre-read
"RTN","DVBCIUTL",103,0)
 K Y,DTOUT,DUOUT,DVBATSAV
"RTN","DVBCIUTL",104,0)
 F  Q:(DVBAOUT=1!(DVBCYQ=1))  DO
"RTN","DVBCIUTL",105,0)
 .W !!,"  Enter '^' to end Reason Selection"
"RTN","DVBCIUTL",106,0)
 .W !,"  'Return' to select all Insufficient Reasons",!
"RTN","DVBCIUTL",107,0)
 .K DIC,DTOUT,DUOUT,Y
"RTN","DVBCIUTL",108,0)
 .W !,"  Enter Insufficient Reason: ALL//"
"RTN","DVBCIUTL",109,0)
 .R RESANS:DTIME
"RTN","DVBCIUTL",110,0)
 .S:$T DVBATSAV=""
"RTN","DVBCIUTL",111,0)
 .I RESANS=""&($D(DVBATSAV)) S Y=-1 D INREAS^DVBCIUT1
"RTN","DVBCIUTL",112,0)
 .S:('$D(DVBATSAV)!(RESANS["^")) DVBAOUT="1"
"RTN","DVBCIUTL",113,0)
 .I DVBAOUT'=1,('$D(Y)) DO
"RTN","DVBCIUTL",114,0)
 ..I RESANS["?" DO
"RTN","DVBCIUTL",115,0)
 ...N LPDA S LPDA=0
"RTN","DVBCIUTL",116,0)
 ...W !,"CHOOSE FROM:"
"RTN","DVBCIUTL",117,0)
 ...F  S LPDA=$O(^DVB(396.94,LPDA)) Q:+LPDA'>0  DO
"RTN","DVBCIUTL",118,0)
 ....W !,?3,$P(^DVB(396.94,LPDA,0),U,1)
"RTN","DVBCIUTL",119,0)
 ...W !
"RTN","DVBCIUTL",120,0)
 ..I RESANS'["?" DO
"RTN","DVBCIUTL",121,0)
 ...S DIC="^DVB(396.94,"
"RTN","DVBCIUTL",122,0)
 ...S DIC(0)="EMQ"
"RTN","DVBCIUTL",123,0)
 ...S X=RESANS
"RTN","DVBCIUTL",124,0)
 ...D ^DIC
"RTN","DVBCIUTL",125,0)
 ...D:+Y>0 INREAS^DVBCIUT1
"RTN","DVBCIUTL",126,0)
 .I RESANS="",($D(Y)&(+Y=-1)) S DVBCYQ=1
"RTN","DVBCIUTL",127,0)
 K DTOUT,DUOUT,Y,DIC,DVBCYQ,DVBATSAV
"RTN","DVBCIUTL",128,0)
 Q
"RTN","DVBCIUTL",129,0)
 ;
"RTN","DVBCIUTL",130,0)
XMSEL ;** Select Exams
"RTN","DVBCIUTL",131,0)
 ;** The selection prompt is defaulted to ALL.  If the user selects
"RTN","DVBCIUTL",132,0)
 ;**  'All', only exams entered on requests with a priority of 
"RTN","DVBCIUTL",133,0)
 ;**  'Insufficient' will be reported.  Not all exams.
"RTN","DVBCIUTL",134,0)
 ;
"RTN","DVBCIUTL",135,0)
 W @IOF,!
"RTN","DVBCIUTL",136,0)
 W !,"AMIE Exam Selection"
"RTN","DVBCIUTL",137,0)
 S DVBCYQ=""
"RTN","DVBCIUTL",138,0)
 K Y,DTOUT,DUOUT
"RTN","DVBCIUTL",139,0)
 F  Q:($D(DTOUT)!($D(DUOUT)!(DVBCYQ=1)))  DO
"RTN","DVBCIUTL",140,0)
 .W !!,"  Enter '^' to end Exam Selection"
"RTN","DVBCIUTL",141,0)
 .W !,"  'Return' to select all AMIE Exams",!
"RTN","DVBCIUTL",142,0)
 .K DIC,DTOUT,DUOUT
"RTN","DVBCIUTL",143,0)
 .S DIC="^DVB(396.6,"
"RTN","DVBCIUTL",144,0)
 .S DIC(0)="AEMQ"
"RTN","DVBCIUTL",145,0)
 .S DIC("A")="  Enter Exam: ALL//"
"RTN","DVBCIUTL",146,0)
 .;removed screen for inactive exams
"RTN","DVBCIUTL",147,0)
 .D ^DIC
"RTN","DVBCIUTL",148,0)
 .I '$D(DTOUT),('$D(DUOUT)) D EXMTPE^DVBCIUT1
"RTN","DVBCIUTL",149,0)
 .I $D(Y),(+Y=-1) S DVBCYQ=1
"RTN","DVBCIUTL",150,0)
 K DTOUT,DUOUT,Y,DIC,DVBCYQ
"RTN","DVBCIUTL",151,0)
 Q
"RTN","DVBCIUTL",152,0)
 ;
"RTN","DVBCIUTL",153,0)
 ;Input: DVBADIRA - Prompt to display for DIR call
"RTN","DVBCIUTL",154,0)
 ;Ouput: Code selected from set or ^ if user exited selection
"RTN","DVBCIUTL",155,0)
EXMPRTY(DVBADIRA) ;** Select Priority of Exam
"RTN","DVBCIUTL",156,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","DVBCIUTL",157,0)
 S DIR(0)="S^AO:Agent Orange;BDD:Benefits Delivery at Discharge / Quick Start;"
"RTN","DVBCIUTL",158,0)
 S DIR(0)=DIR(0)_"IDES:Integrated Disability Evaluation System;"
"RTN","DVBCIUTL",159,0)
 S DIR(0)=DIR(0)_"ALL:All Others"
"RTN","DVBCIUTL",160,0)
 S DIR("A")=$S($G(DVBADIRA)]"":DVBADIRA,1:"Select Priority of Exam for the Report")
"RTN","DVBCIUTL",161,0)
 S DIR("B")="All Others"
"RTN","DVBCIUTL",162,0)
 S DIR("T")=DTIME  ;time-out value specified by system
"RTN","DVBCIUTL",163,0)
 S DIR("?",1)="Select the priority of exam(s) to report on or ALL for the original report,"
"RTN","DVBCIUTL",164,0)
 S DIR("?")="which excludes the AO, BDD and IDES exam priorities."
"RTN","DVBCIUTL",165,0)
 D ^DIR
"RTN","DVBCIUTL",166,0)
 Q Y
"RTN","DVBCUTIL")
0^22^B46287055^B46886926
"RTN","DVBCUTIL",1,0)
DVBCUTIL ;ALB/GTS-557/THM;C&P UTILITY ROUTINE ; 11/3/2010
"RTN","DVBCUTIL",2,0)
 ;;2.7;AMIE;**17,126,143,149,184**;Apr 10, 1995;Build 10
"RTN","DVBCUTIL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DVBCUTIL",4,0)
 ;
"RTN","DVBCUTIL",5,0)
KILL ;common exit
"RTN","DVBCUTIL",6,0)
 D ^%ZISC I $D(FF),'$D(ZTQUEUED) W @FF,!!
"RTN","DVBCUTIL",7,0)
 K %DT,ADR1,ADR2,ADR3,BDTRQ,BUSPHON,CITY,CNDCT,CNUM,DFN,DIW,DIWF,DIWL,DIWR,DIWT,DN,DOB,DTA,DTRQ,DX,DXCOD,DXNUM,EDTRQ,HOMPHON,I,LINE,MDTRM,NAME,OTHDIS,PCT,PG,PGHD,POP,PRINT,REQN,RO,ROHD,RONAME,RQ,SC,D,DIE,ONE,DVBCNEW,LN,FEXM,PRIO,DTB
"RTN","DVBCUTIL",8,0)
 K SEX,SSN,STATE,TST,X,Y,Z,JI,JII,ZIP,JJ,KJX,D0,D1,DA,DI,DIC,DIPGM,DLAYGO,DQ,DWLW,HD,HD1,HD2,J,ONFILE,CTIM,JJ,C,DIZ,DPTSZ,STAT,JDT,JY,TSTDT,DIYS,EXAM,DR,REQDT,ELIG,INCMP,PRDSV,WARD,ADD1,ADD2,CNTY,PG,OLDDA,DIRUT,DUOUT
"RTN","DVBCUTIL",9,0)
 K DVBCCNT,TNAM,DIR,TEMP,SWITCH,EDTA,RAD,EOD,%T,STATUS,XX,XDD,OLDA,OLDA1
"RTN","DVBCUTIL",10,0)
 K DTTRNSC,ZIP4,DVBAINSF,DTT,TAD1,TAD2,TAD3,TCITY,TST,TZIP,TPHONE
"RTN","DVBCUTIL",11,0)
 K COUNTY,PROVINCE,POSTALCD,COUNTRY
"RTN","DVBCUTIL",12,0)
 G KILL^DVBCUTL2
"RTN","DVBCUTIL",13,0)
 ;
"RTN","DVBCUTIL",14,0)
DICW ;used on ^DIC lookups only
"RTN","DVBCUTIL",15,0)
 W ! S TSTDT=$P(^(0),U,2),RO=$P(^(0),U,3),STAT=$P(^(0),U,18),RONAME=$S($D(^DIC(4,+RO,0)):$P(^(0),U,1),1:"Unknown RO") D DICW1
"RTN","DVBCUTIL",16,0)
 W ! Q
"RTN","DVBCUTIL",17,0)
 ;
"RTN","DVBCUTIL",18,0)
DICW1 F JY=0:0 S JY=$O(^DVB(396.4,"C",+Y,JY)) Q:JY=""  S EXAM=$P(^DVB(396.4,+JY,0),U,3),EXAM=$S($D(^DVB(396.6,EXAM,0)):$P(^(0),U,1),1:"Unknown exam") D DICW2
"RTN","DVBCUTIL",19,0)
 Q
"RTN","DVBCUTIL",20,0)
 ;
"RTN","DVBCUTIL",21,0)
DICW2 W ?3,EXAM," (",$$FMTE^XLFDT(TSTDT,"5DZ")," by ",RONAME,")",!
"RTN","DVBCUTIL",22,0)
 Q
"RTN","DVBCUTIL",23,0)
 ;
"RTN","DVBCUTIL",24,0)
VARS S DTA=^DVB(396.3,DA,0),DFN=$P(DTA,U,1),(NAME,PNAM)=$P(^DPT(DFN,0),U,1),DOB=$P(^(0),U,3),SEX=$P(^(0),U,2),SSN=$P(^(0),U,9),CNUM=$S($D(^DPT(DFN,.31)):$P(^(.31),U,3),1:"Unknown"),DTRQ=$P(DTA,U,2)
"RTN","DVBCUTIL",25,0)
 S RO=$P(DTA,U,3),FEXM=$P(DTA,U,9) S:RO="" RO=0 S RONAME=$S($D(^DIC(4,RO,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCUTIL",26,0)
 S REQN=$P(DTA,U,4),REQN=$S($D(^VA(200,+REQN,0)):$P(^(0),U,1),1:"Unknown"),OTHDIS=$P(DTA,U,11) I $D(^DVB(396.3,DA,1)) S OTHDIS1=$P(^(1),U,9),OTHDIS2=$P(^(1),U,10)
"RTN","DVBCUTIL",27,0)
 S ZPR=$P(DTA,U,10) S PRIO="" D  S:PRIO']"" PRIO="Unknown"
"RTN","DVBCUTIL",28,0)
 . I ZPR="T" S PRIO="Terminal" Q
"RTN","DVBCUTIL",29,0)
 . I ZPR="P" S PRIO="Prisoner of war" Q
"RTN","DVBCUTIL",30,0)
 . I ZPR="OS" S PRIO="Original SC" Q
"RTN","DVBCUTIL",31,0)
 . I ZPR="ON" S PRIO="Original NSC" Q
"RTN","DVBCUTIL",32,0)
 . I ZPR="I" S PRIO="Increase" Q
"RTN","DVBCUTIL",33,0)
 . I ZPR="R" S PRIO="Review" Q
"RTN","DVBCUTIL",34,0)
 . I ZPR="OTR" S PRIO="Other" Q
"RTN","DVBCUTIL",35,0)
 . I ZPR="E" S PRIO="Inadequate exam" Q
"RTN","DVBCUTIL",36,0)
 . I ZPR="AO" S PRIO="Agent Orange" Q
"RTN","DVBCUTIL",37,0)
 . I ZPR="BDD" S PRIO="Ben Deliv at Disch" Q
"RTN","DVBCUTIL",38,0)
 . I ZPR="IDES" S PRIO="IDES" Q
"RTN","DVBCUTIL",39,0)
 . I ZPR="QS" S PRIO="Quick Start"
"RTN","DVBCUTIL",40,0)
 K DVBAINSF S:ZPR="E" DVBAINSF=""
"RTN","DVBCUTIL",41,0)
 S (ADR1,ADR2,ADR3,CITY,STATE,ZIP)=""
"RTN","DVBCUTIL",42,0)
 I $D(^DPT(DFN,.11)) D
"RTN","DVBCUTIL",43,0)
 .S DTA=^DPT(DFN,.11)
"RTN","DVBCUTIL",44,0)
 .S ADR1=$P(DTA,U,1),ADR2=$P(DTA,U,2),ADR3=$P(DTA,U,3),CITY=$P(DTA,U,4)
"RTN","DVBCUTIL",45,0)
 .S ZIP=$P(DTA,U,12) S:ZIP'="" ZIP=$S($L(ZIP)>5:$E(ZIP,1,5)_"-"_$E(ZIP,6,9),1:ZIP) I ZIP="" S ZIP="No Zip"
"RTN","DVBCUTIL",46,0)
 .S CITY=$S(CITY]"":CITY,1:"Unknown") S STATE=$P(DTA,U,5) I STATE]"" S STATE=$S($D(^DIC(5,STATE,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCUTIL",47,0)
 .S COUNTY=$P(DTA,U,7),PROVINCE=$P(DTA,U,8),POSTALCD=$P(DTA,U,9)
"RTN","DVBCUTIL",48,0)
 .S COUNTRY=$P(DTA,U,10)
"RTN","DVBCUTIL",49,0)
 S (HOMPHON,BUSPHON)="Unknown" I $D(^DPT(DFN,.13)) S HOMPHON=$P(^(.13),U,1),BUSPHON=$P(^(.13),U,2)
"RTN","DVBCUTIL",50,0)
 I $D(^DPT(DFN,.121)) D   ;DVBA/126 added
"RTN","DVBCUTIL",51,0)
 .S (DTT,TAD1,TAD2,TAD3,TCITY,TST,TZIP,TPHONE)=""
"RTN","DVBCUTIL",52,0)
 .S DTT=^DPT(DFN,.121)
"RTN","DVBCUTIL",53,0)
 .S TAD1=$P(DTT,U,1),TAD2=$P(DTT,U,2),TAD3=$P(DTT,U,3),TCITY=$P(DTT,U,4)
"RTN","DVBCUTIL",54,0)
 .S TZIP=$P(DTT,U,12) S:TZIP'="" TZIP=$S($L(TZIP)>5:$E(TZIP,1,5)_"-"_$E(TZIP,6,9),1:TZIP) I TZIP="" S TZIP="No Zip"
"RTN","DVBCUTIL",55,0)
 .S TCITY=$S(TCITY]"":TCITY,1:"Unknown") S TST=$P(DTT,U,5) I TST]"" S TST=$S($D(^DIC(5,TST,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCUTIL",56,0)
 .S TPHONE=$P(DTT,U,10) S:TPHONE="" TPHONE="Unknown"
"RTN","DVBCUTIL",57,0)
 S EDTA=$$SVC(DFN,"I"),EOD=$P(EDTA,U),RAD=$P(EDTA,U,2),Y=$S($D(^DVB(396.3,DA,1)):$P(^(1),U,7),1:"") X ^DD("DD") S LREXMDT=Y
"RTN","DVBCUTIL",58,0)
 Q
"RTN","DVBCUTIL",59,0)
 ;
"RTN","DVBCUTIL",60,0)
HDR W @FF,?(IOM-$L(HD2)\2),HD2,!!!?5,"Veteran name: ",PNAM,?45,"SSN: ",SSN,!?40,"C-NUMBER: ",CNUM,!!,"Exams on this request:",!!
"RTN","DVBCUTIL",61,0)
 S JII=""
"RTN","DVBCUTIL",62,0)
 F JIJ=0:0 S JII=$O(^TMP($J,JII)) Q:JII=""  S XST=$P(^TMP($J,JII),U,1) W JII,", ",$S(XST="C":"Completed",XST="RX":"Cancelled by RO",XST="X":"Cancelled by MAS",XST="T":"Transferred",1:"Open"),", " I $X>30 W !
"RTN","DVBCUTIL",63,0)
 Q
"RTN","DVBCUTIL",64,0)
 ;
"RTN","DVBCUTIL",65,0)
ADDR ;
"RTN","DVBCUTIL",66,0)
 N ADD1,ADD2,ADD3,CITY,CNTY,STATE,ZIP,COUNTRY,POSTCODE,PROVINCE
"RTN","DVBCUTIL",67,0)
 N PRDSV,ELIG,INCMP
"RTN","DVBCUTIL",68,0)
 S (ADD1,ADD2,ADD3,CITY,CNTY,STATE,ZIP,COUNTRY,POSTCODE,PROVINCE)=""
"RTN","DVBCUTIL",69,0)
 I $D(^DPT(DFN,.11)) S DTA=^(.11),ADD1=$P(DTA,U,1),ADD2=$P(DTA,U,2),ADD3=$P(DTA,U,3),CITY=$P(DTA,U,4),STATE=$P(DTA,U,5),ZIP=$P(DTA,U,12),CNTY=$P(DTA,U,7),PROVINCE=$P(DTA,U,8),POSTCODE=$P(DTA,U,9),COUNTRY=$P(DTA,U,10)
"RTN","DVBCUTIL",70,0)
 W !!?0,"Address: ",?14,ADD1,!
"RTN","DVBCUTIL",71,0)
 W:ADD2]"" ?14,ADD2,!
"RTN","DVBCUTIL",72,0)
 W:ADD3]"" ?14,ADD3,!
"RTN","DVBCUTIL",73,0)
 ;Functionality for USA Unique Address Output
"RTN","DVBCUTIL",74,0)
 D:$$ISFORGN(COUNTRY)'>0 
"RTN","DVBCUTIL",75,0)
 . S:ZIP'="" ZIP=$S($L(ZIP)>5:$E(ZIP,1,5)_"-"_$E(ZIP,6,9),1:ZIP)
"RTN","DVBCUTIL",76,0)
 . S CNTY=$S($D(^DIC(5,+STATE,1,+CNTY,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCUTIL",77,0)
 . S STATE=$S($D(^DIC(5,+STATE,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBCUTIL",78,0)
 . W ?0,"City:",?14,CITY,"  ",STATE,"  ",ZIP,!?0,"County:",?14,CNTY,!
"RTN","DVBCUTIL",79,0)
 ;Functionality for Foreign Unique Address Output
"RTN","DVBCUTIL",80,0)
 D:$$ISFORGN(COUNTRY)>0
"RTN","DVBCUTIL",81,0)
 . I POSTCODE="" S POSTCODE="Unknown"
"RTN","DVBCUTIL",82,0)
 . I CITY="" S CITY="Unknown"
"RTN","DVBCUTIL",83,0)
 . I PROVINCE="" S PROVINCE="Unknown"
"RTN","DVBCUTIL",84,0)
 . W ?0,"Postal Code:",?14,POSTCODE,!?0,"City:",?14,CITY,!?0,"Province: ",?14,PROVINCE,!
"RTN","DVBCUTIL",85,0)
 W:COUNTRY>0 ?0,"Country:",?14,$$GETCNTRY(+COUNTRY),!
"RTN","DVBCUTIL",86,0)
 W !
"RTN","DVBCUTIL",87,0)
 S PRDSV=$S($D(^DPT(DFN,.32)):$P(^(.32),U,3),1:"") I PRDSV]"" S PRDSV=$P(^DIC(21,PRDSV,0),U,1)
"RTN","DVBCUTIL",88,0)
 W "Period of service: ",PRDSV,!
"RTN","DVBCUTIL",89,0)
 S ELIG="",INCMP=0
"RTN","DVBCUTIL",90,0)
 W ?0,"Eligibility data:" I $D(^DPT(DFN,.36)),$P(^(.36),U,1)]"" S ELIG=$S($D(^DIC(8,+^(.36),0)):$P(^(0),U,6),1:"")
"RTN","DVBCUTIL",91,0)
 I ELIG]"",$D(^DPT(DFN,.361)),^(.361)]"" S ELIG=ELIG_" ("_$S($P(^(.361),U,1)="P":"Pend ver",$P(^(.361),U,1)="R":"Pend re-verif",$P(^(.361),U,1)="V":"Verified",1:"Not verified")_")"
"RTN","DVBCUTIL",92,0)
 I $D(^DPT(DFN,.29)),$P(^(.29),U,1)]"" S INCMP=1
"RTN","DVBCUTIL",93,0)
 I $D(^DPT(DA,.293)),$P(^(.293),U,1)=1 S INCMP=1
"RTN","DVBCUTIL",94,0)
 W ?19,ELIG_$S(ELIG]"":", ",1:"")_$S(INCMP=1:"Incompetent",1:""),!
"RTN","DVBCUTIL",95,0)
 Q
"RTN","DVBCUTIL",96,0)
 ;
"RTN","DVBCUTIL",97,0)
SSNSHRT ;  ** Set SSN in the Format '***********' **
"RTN","DVBCUTIL",98,0)
 K DVBCSSNO
"RTN","DVBCUTIL",99,0)
 S DVBCSSNO=$E(SSN,1,3)_" "_$E(SSN,4,5)_" "_$E(SSN,6,9)
"RTN","DVBCUTIL",100,0)
 Q
"RTN","DVBCUTIL",101,0)
 ;
"RTN","DVBCUTIL",102,0)
SSNOUT ;  ** Set SSN in the Format '*********** (Z6789) **
"RTN","DVBCUTIL",103,0)
 D SSNSHRT
"RTN","DVBCUTIL",104,0)
 S DVBCSSNO=DVBCSSNO_" ("_$E(PNAM)_$E(SSN,6,9)_")"
"RTN","DVBCUTIL",105,0)
 Q
"RTN","DVBCUTIL",106,0)
 ;
"RTN","DVBCUTIL",107,0)
ISFORGN(DVBIEN)  ;  ** Is country entry foreign? **
"RTN","DVBCUTIL",108,0)
 ;  Input:  DVBIEN - IEN of COUNTRY CODE file
"RTN","DVBCUTIL",109,0)
 ;
"RTN","DVBCUTIL",110,0)
 ;  Output:  Return 1 when country is foreign
"RTN","DVBCUTIL",111,0)
 ;           Return 0 when country is not foreign
"RTN","DVBCUTIL",112,0)
 ;           Return -1 on error
"RTN","DVBCUTIL",113,0)
 ;
"RTN","DVBCUTIL",114,0)
 N DVBCNTRY
"RTN","DVBCUTIL",115,0)
 N DVBERR
"RTN","DVBCUTIL",116,0)
 Q:$G(DVBIEN)="" -1
"RTN","DVBCUTIL",117,0)
 S DVBCNTRY=$$GET1^DIQ(779.004,DVBIEN_",",".01","","","DVBERR")
"RTN","DVBCUTIL",118,0)
 Q $S($D(DVBERR):-1,DVBCNTRY="USA":0,1:1)
"RTN","DVBCUTIL",119,0)
 ;
"RTN","DVBCUTIL",120,0)
GETCNTRY(DVBIEN)  ;  ** Get POSTAL NAME for country code **
"RTN","DVBCUTIL",121,0)
 ;  Input:  DVBIEN - IEN of COUNTRY CODE file
"RTN","DVBCUTIL",122,0)
 ;
"RTN","DVBCUTIL",123,0)
 ;  Output:  Return POSTAL NAME field on success or
"RTN","DVBCUTIL",124,0)
 ;           DESCRIPTION field when POSTAL NAME = "<NULL>";
"RTN","DVBCUTIL",125,0)
 ;           Otherwise, return "" on failure.
"RTN","DVBCUTIL",126,0)
 ;
"RTN","DVBCUTIL",127,0)
 N DVBCNTRY
"RTN","DVBCUTIL",128,0)
 N DVBERR
"RTN","DVBCUTIL",129,0)
 N DVBIENS
"RTN","DVBCUTIL",130,0)
 N DVBNAME
"RTN","DVBCUTIL",131,0)
 S DVBNAME=""
"RTN","DVBCUTIL",132,0)
 I $G(DVBIEN)'="" D
"RTN","DVBCUTIL",133,0)
 . S DVBIENS=DVBIEN_","
"RTN","DVBCUTIL",134,0)
 . D GETS^DIQ(779.004,DVBIENS,"1.3;2","E","DVBCNTRY","DVBERR")
"RTN","DVBCUTIL",135,0)
 . I '$D(DVBERR) D
"RTN","DVBCUTIL",136,0)
 . . S DVBNAME=$G(DVBCNTRY(779.004,DVBIENS,1.3,"E"))
"RTN","DVBCUTIL",137,0)
 . . I DVBNAME="<NULL>" S DVBNAME=$$UP^XLFSTR($G(DVBCNTRY(779.004,DVBIENS,2,"E")))
"RTN","DVBCUTIL",138,0)
 Q DVBNAME
"RTN","DVBCUTIL",139,0)
 ;
"RTN","DVBCUTIL",140,0)
SVC(DFN,DVBCIE) ;Retrieve Last Military Service Data Info
"RTN","DVBCUTIL",141,0)
 ; Using supported API SVC^VAPDT, which encapsulates the
"RTN","DVBCUTIL",142,0)
 ; Military Service Episode (MSE) changes due to the
"RTN","DVBCUTIL",143,0)
 ; Enrollment Military Service Data Sharing (MSDS) project 
"RTN","DVBCUTIL",144,0)
 ; (Patch DG*5.3*797)
"RTN","DVBCUTIL",145,0)
 ; INPUT
"RTN","DVBCUTIL",146,0)
 ;    DFN     - Patient (#2) file internal entry  number (Required)
"RTN","DVBCUTIL",147,0)
 ;    DVBCIE  - "I" to return service dates in Fileman format (Default)
"RTN","DVBCUTIL",148,0)
 ;              "E" to return servce dates in external format
"RTN","DVBCUTIL",149,0)
 ; OUTPUT
"RTN","DVBCUTIL",150,0)
 ;    Returns '^' delimitted string
"RTN","DVBCUTIL",151,0)
 ;       1. Last Service Entry Date
"RTN","DVBCUTIL",152,0)
 ;       2. Last Service Seperation Date
"RTN","DVBCUTIL",153,0)
 ;       3. Last Service Branch
"RTN","DVBCUTIL",154,0)
 ;       4. Last Service Discharge Type
"RTN","DVBCUTIL",155,0)
 ; 
"RTN","DVBCUTIL",156,0)
 ;Quit if DFN not greater than zero
"RTN","DVBCUTIL",157,0)
 Q:($G(DFN)'>0) ""
"RTN","DVBCUTIL",158,0)
 ;If DVBCIE not "I" or "E" set to default of "I"
"RTN","DVBCUTIL",159,0)
 S:"^I^E^"'[(U_$G(DVBCIE)_U) DVBCIE="I"
"RTN","DVBCUTIL",160,0)
 N VASV,VAHOW,VAROOT,DVBMSE
"RTN","DVBCUTIL",161,0)
 D SVC^VADPT
"RTN","DVBCUTIL",162,0)
 D:DVBCIE="E"  ;external Last MSE data
"RTN","DVBCUTIL",163,0)
 . S DVBMSE=$P($G(VASV(6,4)),U,2)_"^"_$P($G(VASV(6,5)),U,2)_"^"
"RTN","DVBCUTIL",164,0)
 . S DVBMSE=DVBMSE_$P($G(VASV(6,1)),U,2)_"^"_$P($G(VASV(6,3)),U,2)
"RTN","DVBCUTIL",165,0)
 D:DVBCIE="I"  ;internal Last MSE data
"RTN","DVBCUTIL",166,0)
 . S DVBMSE=$P($G(VASV(6,4)),U)_"^"_$P($G(VASV(6,5)),U)_"^"
"RTN","DVBCUTIL",167,0)
 . S DVBMSE=DVBMSE_$P($G(VASV(6,1)),U)_"^"_$P($G(VASV(6,3)),U)
"RTN","DVBCUTIL",168,0)
 Q DVBMSE
"RTN","DVBCXFRE")
0^5^B25183514^B20965709
"RTN","DVBCXFRE",1,0)
DVBCXFRE ;ALB/GTS - 557/THM-SEND BACK TRANSFERS WHEN RELEASED ; 5/30/91  9:42 AM
"RTN","DVBCXFRE",2,0)
 ;;2.7;AMIE;**10,184**;Apr 10, 1995;Build 10
"RTN","DVBCXFRE",3,0)
 ;
"RTN","DVBCXFRE",4,0)
EN W !!,*7,"This request was transferred in.",!,"Please wait while I return it.",!! H 2
"RTN","DVBCXFRE",5,0)
 ;
"RTN","DVBCXFRE",6,0)
EN1 W @FF,!! S SITE=$P(^DVB(396.3,REQDA,0),U,22),DTTRNSC=$P(^(0),U,12),SITE1=$S($D(^DIC(4.2,+SITE,0)):$P(^(0),U,1),1:""),SITE=$S($P(^(0),U,3)]"":$P(^(0),U,3),1:SITE)
"RTN","DVBCXFRE",7,0)
 I SITE="" W !!,*7,"There is no home domain indicated.",!,"This request was not transferred in.",!! H 3 Q
"RTN","DVBCXFRE",8,0)
 S NREQDA=$S($D(^DVB(396.3,REQDA,1)):$P(^(1),U,8),1:"") I +NREQDA=0 W !!,*7,"The original request indicator is missing!",!,"I have no way to match it back at "_SITE1,!! H 3 Q
"RTN","DVBCXFRE",9,0)
 W !!,"Setting up return mail message ...",!! H 1
"RTN","DVBCXFRE",10,0)
 S L=3,^TMP("DVBCXFR",$J,1,0)="$TRANSFER OUT FROM V"_$$VERSION^XPDUTL("DVBA"),^TMP("DVBCXFR",$J,2,0)="$RQDA "_NREQDA_U_DTTRNSC_U_$P(^DVB(396.3,REQDA,0),U,18)_U_$P(^(0),"^",19) W ".."
"RTN","DVBCXFRE",11,0)
 I $D(ALLROPN) S ^TMP("DVBCXFR",$J,L,0)="$ROPN 1^",L=L+1 W "."
"RTN","DVBCXFRE",12,0)
 F JJ=0:0 S JJ=$O(^DVB(396.4,"C",REQDA,JJ)) Q:JJ=""  S DIE="^DVB(396.4,",DA=JJ,DR="64///N" D ^DIE K DA,DIE,DR D RSLT,RSLT1
"RTN","DVBCXFRE",13,0)
 S ^TMP("DVBCXFR",$J,L,0)="$USER "_$S($D(^VA(200,+DUZ,0)):$P(^(0),U,1),1:"POSTMASTER")_U_SITE_U_SITE1,L=L+1 W "."
"RTN","DVBCXFRE",14,0)
 S ^TMP("DVBCXFR",$J,L,0)="$END ",L=L+1 W "."
"RTN","DVBCXFRE",15,0)
 S ^TMP("DVBCXFR",$J,L,0)="  ",L=L+1 W "."
"RTN","DVBCXFRE",16,0)
 S ^TMP("DVBCXFR",$J,L,0)="  DFN: `"_DFN_$E("                    ",1,20-$L(DFN))_"SITE: "_DVBCSITE,L=L+1 W "."
"RTN","DVBCXFRE",17,0)
 S ^TMP("DVBCXFR",$J,L,0)="  REQUEST DATE: "_DVBCRDAT,L=L+1 W "."
"RTN","DVBCXFRE",18,0)
 ;
"RTN","DVBCXFRE",19,0)
 S ^TMP("DVBCXFR",$J,L,0)="  ",L=L+1 W "."
"RTN","DVBCXFRE",20,0)
 S ^TMP("DVBCXFR",$J,L,0)="** NOTE: To view the patient using the DFN, paste the DFN number into the    **",L=L+1 W "."
"RTN","DVBCXFRE",21,0)
 S ^TMP("DVBCXFR",$J,L,0)="** CAPRI Patient Selector 'Patient ID' field to find the patient. Be sure to **",L=L+1 W "."
"RTN","DVBCXFRE",22,0)
 S ^TMP("DVBCXFR",$J,L,0)="** include the ' (backward-apostrophe) character.                            **",L=L+1 W "."
"RTN","DVBCXFRE",23,0)
 S ^TMP("DVBCXFR",$J,L,0)=" ",L=L+1 W "."
"RTN","DVBCXFRE",24,0)
 S ^TMP("DVBCXFR",$J,L,0)="** This is an auto-generated email.  Do not respond to this email address.   **",L=L+1 W "."
"RTN","DVBCXFRE",25,0)
 ;
"RTN","DVBCXFRE",26,0)
 H 1 W !!,"Message is now ready to send back ...",!! H 2
"RTN","DVBCXFRE",27,0)
 ;
"RTN","DVBCXFRE",28,0)
SEND ;set status now for manual return if auto send fails; skip reopens
"RTN","DVBCXFRE",29,0)
 I '$D(ALLROPN) S DIC(0)="QM",(DIC,DIE)="^DVB(396.3,",DA=REQDA,DR="17////CT" D ^DIE
"RTN","DVBCXFRE",30,0)
 K XMZ S XMY(DUZ)="",XMSUB="Return of Transferred C&P Exams",XMTEXT="^TMP(""DVBCXFR"",$J,",XMY("S.DVBA C PROCESS MAIL MESSAGE@"_SITE1)=SITE D ^XMD
"RTN","DVBCXFRE",31,0)
 I $D(XMZ) W !!,"Transmitted as message # "_XMZ_" from this site to "_SITE1,! H 3
"RTN","DVBCXFRE",32,0)
 I '$D(XMZ) W !!,*7,"Message transmission error!",!,"Request WILL NOT be transferred!",!!,"Press RETURN  " R ANS:DTIME S OUT=1 Q:'$D(MANUAL)  I $D(MANUAL) K MANUAL G KILL^DVBCUTIL
"RTN","DVBCXFRE",33,0)
 K DIC,DIE,DR,DA,LN,^TMP("DVBCXFR",$J),XMZ,ANS,L,JY,XMY,XMSUB,XMTEXT,XMDUZ
"RTN","DVBCXFRE",34,0)
 I $D(MANUAL) K MANUAL G KILL^DVBCUTIL
"RTN","DVBCXFRE",35,0)
 Q
"RTN","DVBCXFRE",36,0)
 ;
"RTN","DVBCXFRE",37,0)
RSLT1 F LN=0:0 S LN=$O(^DVB(396.4,JJ,"RES",LN)) Q:LN=""  S ^TMP("DVBCXFR",$J,L,0)="$RSLT "_^(LN,0),L=L+1 W "."
"RTN","DVBCXFRE",38,0)
 Q
"RTN","DVBCXFRE",39,0)
 ;
"RTN","DVBCXFRE",40,0)
MANUAL S MANUAL=1 D HOME^%ZIS S FF=IOF
"RTN","DVBCXFRE",41,0)
 ;
"RTN","DVBCXFRE",42,0)
MANUAL1 W @FF,!,"Manual Return of C&P Transfers",!!!!
"RTN","DVBCXFRE",43,0)
 K DIC S DIC="^DVB(396.3,",DIC(0)="AEQMZ",DIC("A")="Select VETERAN NAME: " D ^DIC G:X=""!(X=U) EXIT I +Y<0 W *7,"  ???" H 3 G MANUAL1
"RTN","DVBCXFRE",44,0)
 I '$P(^DVB(396.3,+Y,0),U,22) W *7,!!,"This request was not transferred in to this site and",!,"it is not possible to select it for return." K OUT D PAUSE G:$D(OUT) KILL^DVBCUTIL G MANUAL1
"RTN","DVBCXFRE",45,0)
 I $P(^DVB(396.3,+Y,0),U,18)'="CT" W !!,*7,"This request is not in the proper status to manually return it.",!,"The status must be COMPLETED/TRANSFERRED OUT (CT)." K OUT D PAUSE G:$D(OUT) KILL^DVBCUTIL G MANUAL1
"RTN","DVBCXFRE",46,0)
 ;
"RTN","DVBCXFRE",47,0)
ASK S REQDA=+Y W !!!,"Is this the correct request" S %=2 D YN^DICN G:%<0!($D(DTOUT)) EXIT I %=2 G MANUAL1
"RTN","DVBCXFRE",48,0)
 I %=0 W !!,"Enter Y if this is the correct request or N to re-select.",!! H 3 G ASK
"RTN","DVBCXFRE",49,0)
 S DFN=$P(^DVB(396.3,REQDA,0),U,1),SSN=$P(^DPT(DFN,0),U,9)
"RTN","DVBCXFRE",50,0)
 G EN1
"RTN","DVBCXFRE",51,0)
 ;
"RTN","DVBCXFRE",52,0)
EXIT K MANUAL,DIC,X,Y,REQDA,%,%Y,DTTRNSC,J,TSTDT,POP,STAT,RONAME,RO,JY,EXAM,C Q
"RTN","DVBCXFRE",53,0)
 ;
"RTN","DVBCXFRE",54,0)
RSLT S X=^DVB(396.4,JJ,0),WRKSHT=$P(X,U,5),EXSTAT=$P(X,U,4)
"RTN","DVBCXFRE",55,0)
 S CANCNODE=$S($D(^DVB(396.4,JJ,"CAN")):^DVB(396.4,JJ,"CAN"),1:""),CANCREM=$P(CANCNODE,U,3)
"RTN","DVBCXFRE",56,0)
 S CANCBY=$P(CANCNODE,U,2) S:CANCBY]"" CANCBY=.5
"RTN","DVBCXFRE",57,0)
 S CANCDT=$P(CANCNODE,U,1)
"RTN","DVBCXFRE",58,0)
 S EXMDT=$P(X,U,6),EXPHYS=$P(X,U,7),FEXM=$P(X,U,8),EXMPL=$P(X,U,9)
"RTN","DVBCXFRE",59,0)
 S ^TMP("DVBCXFR",$J,L,0)="$EXAM "_$P(^DVB(396.4,JJ,0),U,3)_U_WRKSHT_U_EXSTAT_U_CANCREM_U_CANCBY_U_CANCDT_U_EXMDT_U_EXPHYS_U_FEXM_U_EXMPL,L=L+1
"RTN","DVBCXFRE",60,0)
 K CANCNODE
"RTN","DVBCXFRE",61,0)
 Q
"RTN","DVBCXFRE",62,0)
 ;
"RTN","DVBCXFRE",63,0)
PAUSE W !!,"Press RETURN to continue or ""^"" to exit  " R ANS:DTIME I ANS[U S OUT=1
"RTN","DVBCXFRE",64,0)
 Q
"VER")
8.0^22.0
"^DD",396.3,396.3,9,0)
PRIORITY OF EXAM^RS^T:TERMINAL;P:POW;OS:ORIGINAL SC;ON:ORIGINAL NSC;I:INCREASE;R:REVIEW;OTR:OTHER;E:INSUFFICIENT EXAM;AO:AGENT ORANGE;BDD:BEN DELIV AT DISCHG;QS:QUICK START;IDES:IDES;^0;10^Q
"^DD",396.3,396.3,9,1,0)
^.1
"^DD",396.3,396.3,9,1,1,0)
396.3^ADP2^MUMPS
"^DD",396.3,396.3,9,1,1,1)
S:$P(^DVB(396.3,DA,0),U,5)'="" ^DVB(396.3,"ADP",$P(^(0),U,5),$E(X,1,30),DA)=""
"^DD",396.3,396.3,9,1,1,2)
I $P(^DVB(396.3,DA,0),U,5)'="" K ^DVB(396.3,"ADP",$P(^(0),U,5),$E(X,1,30),DA)
"^DD",396.3,396.3,9,1,1,"%D",0)
^^2^2^2941116^^^^
"^DD",396.3,396.3,9,1,1,"%D",1,0)
The 'ADP' cross reference is used by the 'Summary Insufficient Exam Report'
"^DD",396.3,396.3,9,1,1,"%D",2,0)
as generated by the Insufficient Exam Report option.
"^DD",396.3,396.3,9,1,1,"DT")
2941116
"^DD",396.3,396.3,9,3)
Enter the priority of the exam to be conducted.
"^DD",396.3,396.3,9,21,0)
1^.001^1^1^3130222^^^
"^DD",396.3,396.3,9,21,1,0)
This field contains the status of the 2507 exam to be conducted.
"^DD",396.3,396.3,9,"DT")
3130222
"BLD",8535,6)
^162
**END**
**END**
