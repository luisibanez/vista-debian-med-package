KIDS Distribution saved on Aug 04, 2011@14:08:05
VPR 1.0
**KIDS**:VPR 1.0^

**INSTALL NAME**
VPR 1.0
"BLD",8063,0)
VPR 1.0^VIRTUAL PATIENT RECORD^0^3110804^y
"BLD",8063,4,0)
^9.64PA^^
"BLD",8063,6.3)
12
"BLD",8063,"INIT")
POST^VPRPI
"BLD",8063,"KRN",0)
^9.67PA^779.2^20
"BLD",8063,"KRN",.4,0)
.4
"BLD",8063,"KRN",.401,0)
.401
"BLD",8063,"KRN",.402,0)
.402
"BLD",8063,"KRN",.403,0)
.403
"BLD",8063,"KRN",.5,0)
.5
"BLD",8063,"KRN",.84,0)
.84
"BLD",8063,"KRN",3.6,0)
3.6
"BLD",8063,"KRN",3.8,0)
3.8
"BLD",8063,"KRN",9.2,0)
9.2
"BLD",8063,"KRN",9.8,0)
9.8
"BLD",8063,"KRN",9.8,"NM",0)
^9.68A^24^22
"BLD",8063,"KRN",9.8,"NM",1,0)
VPRD^^0^B24278674
"BLD",8063,"KRN",9.8,"NM",2,0)
VPRDGMPL^^0^B20610705
"BLD",8063,"KRN",9.8,"NM",3,0)
VPRDGMRA^^0^B21412184
"BLD",8063,"KRN",9.8,"NM",4,0)
VPRDGMRC^^0^B10314726
"BLD",8063,"KRN",9.8,"NM",5,0)
VPRDGMV^^0^B39440303
"BLD",8063,"KRN",9.8,"NM",6,0)
VPRDGPF^^0^B5569926
"BLD",8063,"KRN",9.8,"NM",7,0)
VPRDLR^^0^B24712747
"BLD",8063,"KRN",9.8,"NM",8,0)
VPRDLRA^^0^B69605973
"BLD",8063,"KRN",9.8,"NM",9,0)
VPRDLRO^^0^B27350157
"BLD",8063,"KRN",9.8,"NM",10,0)
VPRDPROC^^0^B8662758
"BLD",8063,"KRN",9.8,"NM",11,0)
VPRDPS^^0^B14378656
"BLD",8063,"KRN",9.8,"NM",12,0)
VPRDPSI^^0^B41960179
"BLD",8063,"KRN",9.8,"NM",13,0)
VPRDPSO^^0^B68282901
"BLD",8063,"KRN",9.8,"NM",14,0)
VPRDPT^^0^B65865871
"BLD",8063,"KRN",9.8,"NM",15,0)
VPRDPXIM^^0^B15857859
"BLD",8063,"KRN",9.8,"NM",16,0)
VPRDRA^^0^B39795192
"BLD",8063,"KRN",9.8,"NM",17,0)
VPRDSDAM^^0^B9762566
"BLD",8063,"KRN",9.8,"NM",18,0)
VPRDSR^^0^B29738621
"BLD",8063,"KRN",9.8,"NM",19,0)
VPRDTIU^^0^B61120410
"BLD",8063,"KRN",9.8,"NM",20,0)
VPRDVSIT^^0^B71801802
"BLD",8063,"KRN",9.8,"NM",23,0)
VPRDOR^^0^B9187731
"BLD",8063,"KRN",9.8,"NM",24,0)
VPRDPXHF^^0^B9504608
"BLD",8063,"KRN",9.8,"NM","B","VPRD",1)

"BLD",8063,"KRN",9.8,"NM","B","VPRDGMPL",2)

"BLD",8063,"KRN",9.8,"NM","B","VPRDGMRA",3)

"BLD",8063,"KRN",9.8,"NM","B","VPRDGMRC",4)

"BLD",8063,"KRN",9.8,"NM","B","VPRDGMV",5)

"BLD",8063,"KRN",9.8,"NM","B","VPRDGPF",6)

"BLD",8063,"KRN",9.8,"NM","B","VPRDLR",7)

"BLD",8063,"KRN",9.8,"NM","B","VPRDLRA",8)

"BLD",8063,"KRN",9.8,"NM","B","VPRDLRO",9)

"BLD",8063,"KRN",9.8,"NM","B","VPRDOR",23)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPROC",10)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPS",11)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPSI",12)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPSO",13)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPT",14)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPXHF",24)

"BLD",8063,"KRN",9.8,"NM","B","VPRDPXIM",15)

"BLD",8063,"KRN",9.8,"NM","B","VPRDRA",16)

"BLD",8063,"KRN",9.8,"NM","B","VPRDSDAM",17)

"BLD",8063,"KRN",9.8,"NM","B","VPRDSR",18)

"BLD",8063,"KRN",9.8,"NM","B","VPRDTIU",19)

"BLD",8063,"KRN",9.8,"NM","B","VPRDVSIT",20)

"BLD",8063,"KRN",19,0)
19
"BLD",8063,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",8063,"KRN",19,"NM",1,0)
VPR APPLICATION PROXY^^0
"BLD",8063,"KRN",19,"NM","B","VPR APPLICATION PROXY",1)

"BLD",8063,"KRN",19.1,0)
19.1
"BLD",8063,"KRN",101,0)
101
"BLD",8063,"KRN",409.61,0)
409.61
"BLD",8063,"KRN",771,0)
771
"BLD",8063,"KRN",779.2,0)
779.2
"BLD",8063,"KRN",870,0)
870
"BLD",8063,"KRN",8989.51,0)
8989.51
"BLD",8063,"KRN",8989.52,0)
8989.52
"BLD",8063,"KRN",8994,0)
8994
"BLD",8063,"KRN",8994,"NM",0)
^9.68A^2^2
"BLD",8063,"KRN",8994,"NM",1,0)
VPR GET PATIENT DATA^^0
"BLD",8063,"KRN",8994,"NM",2,0)
VPR DATA VERSION^^0
"BLD",8063,"KRN",8994,"NM","B","VPR DATA VERSION",2)

"BLD",8063,"KRN",8994,"NM","B","VPR GET PATIENT DATA",1)

"BLD",8063,"KRN","B",.4,.4)

"BLD",8063,"KRN","B",.401,.401)

"BLD",8063,"KRN","B",.402,.402)

"BLD",8063,"KRN","B",.403,.403)

"BLD",8063,"KRN","B",.5,.5)

"BLD",8063,"KRN","B",.84,.84)

"BLD",8063,"KRN","B",3.6,3.6)

"BLD",8063,"KRN","B",3.8,3.8)

"BLD",8063,"KRN","B",9.2,9.2)

"BLD",8063,"KRN","B",9.8,9.8)

"BLD",8063,"KRN","B",19,19)

"BLD",8063,"KRN","B",19.1,19.1)

"BLD",8063,"KRN","B",101,101)

"BLD",8063,"KRN","B",409.61,409.61)

"BLD",8063,"KRN","B",771,771)

"BLD",8063,"KRN","B",779.2,779.2)

"BLD",8063,"KRN","B",870,870)

"BLD",8063,"KRN","B",8989.51,8989.51)

"BLD",8063,"KRN","B",8989.52,8989.52)

"BLD",8063,"KRN","B",8994,8994)

"BLD",8063,"QUES",0)
^9.62^^
"BLD",8063,"REQB",0)
^9.611^^
"INIT")
POST^VPRPI
"KRN",19,13999,-1)
0^1
"KRN",19,13999,0)
VPR APPLICATION PROXY^VPR Application Proxy^^B^^^^^^^^VIRTUAL PATIENT RECORD
"KRN",19,13999,1,0)
^19.06^1^1^3110602^^^^
"KRN",19,13999,1,1,0)
This option allows the VPR connector proxy access to the VistA system.
"KRN",19,13999,99.1)
62236,64972
"KRN",19,13999,"RPC",0)
^19.05P^3^2
"KRN",19,13999,"RPC",2,0)
VPR GET PATIENT DATA
"KRN",19,13999,"RPC",3,0)
VPR DATA VERSION
"KRN",19,13999,"U")
VPR APPLICATION PROXY
"KRN",8994,1015,-1)
0^1
"KRN",8994,1015,0)
VPR GET PATIENT DATA^GET^VPRD^4^S^^^1^1^^1
"KRN",8994,1015,1,0)
^8994.01^2^2^3110606^^^^
"KRN",8994,1015,1,1,0)
This RPC retrieves the requested data from VistA, and returns it in
"KRN",8994,1015,1,2,0)
^TMP("VPR",$J,n) as XML.
"KRN",8994,1015,2,0)
^8994.02A^7^7
"KRN",8994,1015,2,1,0)
DFN^1^20^1^1
"KRN",8994,1015,2,1,1,0)
^8994.021^2^2^3100203^^
"KRN",8994,1015,2,1,1,1,0)
Internal entry number from Patient file #2
"KRN",8994,1015,2,1,1,2,0)
[optionally DFN;ICN for remote calls]
"KRN",8994,1015,2,2,0)
TYPE^1^100^0^2
"KRN",8994,1015,2,2,1,0)
^8994.021^4^4^3110606^^^
"KRN",8994,1015,2,2,1,1,0)
The kind(s) of data to return, which may include:
"KRN",8994,1015,2,2,1,2,0)
  demographics;reactions;problems;vitals;labs;meds;
"KRN",8994,1015,2,2,1,3,0)
  immunizations;visits;appointments;documents;
"KRN",8994,1015,2,2,1,4,0)
  procedures;consults
"KRN",8994,1015,2,3,0)
START^1^20^0^3
"KRN",8994,1015,2,3,1,0)
^8994.021^1^1^3100203^^
"KRN",8994,1015,2,3,1,1,0)
The date/time from which to begin searching for data [optional].
"KRN",8994,1015,2,4,0)
STOP^1^20^0^4
"KRN",8994,1015,2,4,1,0)
^8994.021^1^1^3100203^^
"KRN",8994,1015,2,4,1,1,0)
The date/time at which to end searching for data [optional].
"KRN",8994,1015,2,5,0)
MAX^1^7^0^5
"KRN",8994,1015,2,5,1,0)
^8994.021^1^1^3100203^^
"KRN",8994,1015,2,5,1,1,0)
The maximum number of items to return per data type [optional].
"KRN",8994,1015,2,6,0)
ITEM^1^30^0^6
"KRN",8994,1015,2,6,1,0)
^8994.021^2^2^3100329^^^
"KRN",8994,1015,2,6,1,1,0)
The identifier of a single item to return [optional, but TYPE must
"KRN",8994,1015,2,6,1,2,0)
also be defined when used].
"KRN",8994,1015,2,7,0)
FILTER^2^^0^7
"KRN",8994,1015,2,7,1,0)
^8994.021^1^1^3110606^^^^
"KRN",8994,1015,2,7,1,1,0)
List of name-value pairs, further refining the search.
"KRN",8994,1015,2,"B","DFN",1)

"KRN",8994,1015,2,"B","FILTER",7)

"KRN",8994,1015,2,"B","ITEM",6)

"KRN",8994,1015,2,"B","MAX",5)

"KRN",8994,1015,2,"B","START",3)

"KRN",8994,1015,2,"B","STOP",4)

"KRN",8994,1015,2,"B","TYPE",2)

"KRN",8994,1015,2,"PARAMSEQ",1,1)

"KRN",8994,1015,2,"PARAMSEQ",2,2)

"KRN",8994,1015,2,"PARAMSEQ",3,3)

"KRN",8994,1015,2,"PARAMSEQ",4,4)

"KRN",8994,1015,2,"PARAMSEQ",5,5)

"KRN",8994,1015,2,"PARAMSEQ",6,6)

"KRN",8994,1015,2,"PARAMSEQ",7,7)

"KRN",8994,1015,3,0)
^8994.03^1^1^3110606^^^^
"KRN",8994,1015,3,1,0)
Text array formatted as XML
"KRN",8994,1111,-1)
0^2
"KRN",8994,1111,0)
VPR DATA VERSION^VERSION^VPRD^1^S^^^^^^1
"KRN",8994,1111,1,0)
^^2^2^3110613^
"KRN",8994,1111,1,1,0)
This RPC returns the current version of the XML returned by the RPC
"KRN",8994,1111,1,2,0)
'VPR GET PATIENT DATA.'
"KRN",8994,1111,3,0)
^^2^2^3110613^
"KRN",8994,1111,3,1,0)
A string identifying the version of the VPR data extracts and the
"KRN",8994,1111,3,2,0)
resulting XML.
"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",571,-1)
1^1
"PKG",571,0)
VIRTUAL PATIENT RECORD^VPR^Utilities to manage a virtual copy of the patient record
"PKG",571,1,0)
^^3^3^3101130^
"PKG",571,1,1,0)
This application contains utilities to build and manage a copy of the
"PKG",571,1,2,0)
patient's record, including local and remote data.  The authoritative
"PKG",571,1,3,0)
copy of the data will continue to be each local VistA service.
"PKG",571,5)
SLC-ISC
"PKG",571,20,0)
^9.402P^^
"PKG",571,22,0)
^9.49I^1^1
"PKG",571,22,1,0)
1.0^3110804^3110525^1085
"PKG",571,22,1,1,0)
^^2^2^3110525
"PKG",571,22,1,1,1,0)
The Virtual Patient Record (VPR) monitors a VistA system for new data
"PKG",571,22,1,1,2,0)
and activity, and makes that data available to a subscribing client.
"PKG",571,22,1,"PAH",0)
^9.4901^1^1
"PKG",571,22,1,"PAH",1,0)
1^3110721
"PKG",571,22,1,"PAH",1,1,0)
^^2^2^3110721
"PKG",571,22,1,"PAH",1,1,1,0)
The Virtual Patient Record (VPR) monitors a VistA system for new data
"PKG",571,22,1,"PAH",1,1,2,0)
and activity, and makes that data available to a subscribing client.
"PKG",571,22,1,"PAH","B",1,1)

"PKG",571,"VERSION")
1.0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
23
"RTN","VPRD")
0^1^B24278674
"RTN","VPRD",1,0)
VPRD ;SLC/MKB - Serve VistA data as XML via RPC ;8/2/11  15:29
"RTN","VPRD",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRD",4,0)
 ;
"RTN","VPRD",5,0)
 ; External References          DBIA#
"RTN","VPRD",6,0)
 ; -------------------          -----
"RTN","VPRD",7,0)
 ; ^DPT                         10035
"RTN","VPRD",8,0)
 ; ^SC                          10040
"RTN","VPRD",9,0)
 ; DIQ                           2056
"RTN","VPRD",10,0)
 ; MPIF001                       2701
"RTN","VPRD",11,0)
 ; VASITE                       10112
"RTN","VPRD",12,0)
 ; XLFDT                        10103
"RTN","VPRD",13,0)
 ; XLFSTR                       10104
"RTN","VPRD",14,0)
 ; XUAF4                         2171
"RTN","VPRD",15,0)
 ;
"RTN","VPRD",16,0)
GET(VPR,DFN,TYPE,START,STOP,MAX,ID,FILTER) ; -- Return search results as XML in @VPR@(n) 
"RTN","VPRD",17,0)
 ; RPC = VPR GET PATIENT DATA
"RTN","VPRD",18,0)
 N ICN,VPRI,VPRTOTL,VPRTEXT
"RTN","VPRD",19,0)
 S VPR=$NA(^TMP("VPR",$J)) K @VPR
"RTN","VPRD",20,0)
 S VPRTEXT=+$G(FILTER("text")) ;include report/document text?
"RTN","VPRD",21,0)
 ;
"RTN","VPRD",22,0)
 ; parse & validate input parameters
"RTN","VPRD",23,0)
 S ICN=+$P($G(DFN),";",2),DFN=+$G(DFN),ID=$G(ID)
"RTN","VPRD",24,0)
 I DFN<1,ICN S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","VPRD",25,0)
 S TYPE=$$LOW^XLFSTR($G(TYPE)) I TYPE="" S TYPE=$$ALL
"RTN","VPRD",26,0)
 I TYPE'="new",DFN<1!'$D(^DPT(DFN)) D ERR(1,DFN) G GTQ
"RTN","VPRD",27,0)
 S:'$G(START) START=1410102 S:'$G(STOP) STOP=4141015 S:'$G(MAX) MAX=9999
"RTN","VPRD",28,0)
 I START,STOP,STOP<START N X S X=START,START=STOP,STOP=X  ;switch
"RTN","VPRD",29,0)
 I STOP,$L(STOP,".")<2 S STOP=STOP_".24"
"RTN","VPRD",30,0)
 I ID="",$D(FILTER("id")) S ID=FILTER("id")
"RTN","VPRD",31,0)
 ;
"RTN","VPRD",32,0)
 ; extract data
"RTN","VPRD",33,0)
 N VPRTYPE,VPRP,VPRHDR,VPRTAG,VPRTN
"RTN","VPRD",34,0)
 S VPRTYPE=TYPE D ADD("<results version='1.0' timeZone='"_$$TZ^XLFDT_"' >")
"RTN","VPRD",35,0)
 F VPRP=1:1:$L(VPRTYPE,";") S VPRTAG=$P(VPRTYPE,";",VPRP) I $L(VPRTAG) D
"RTN","VPRD",36,0)
 . S VPRTN="EN^"_$$RTN(.VPRTAG) Q:'$L($T(@VPRTN))  ;D ERR(2) Q
"RTN","VPRD",37,0)
 . D ADD("<"_VPRTAG) S VPRHDR=VPRI,VPRTOTL=0
"RTN","VPRD",38,0)
 . D @(VPRTN_"(DFN,START,STOP,MAX,ID)")
"RTN","VPRD",39,0)
 . S @VPR@(VPRHDR)=@VPR@(VPRHDR)_" total='"_+$G(VPRTOTL)_"' >" D ADD("</"_VPRTAG_">")
"RTN","VPRD",40,0)
 D ADD("</results>")
"RTN","VPRD",41,0)
 ;
"RTN","VPRD",42,0)
GTQ ; end
"RTN","VPRD",43,0)
 Q
"RTN","VPRD",44,0)
 ;
"RTN","VPRD",45,0)
RTN(X) ; -- Return name of VPRDxxxx routine for clinical domain X
"RTN","VPRD",46,0)
 ;  X is also enforced as expected group tag name, if passed by ref
"RTN","VPRD",47,0)
 N Y S Y="VPRD",X=$G(X) I X="" Q Y
"RTN","VPRD",48,0)
 I X["accession"    S Y="VPRDLRA",X="accessions"
"RTN","VPRD",49,0)
 I X["allerg"       S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",50,0)
 I X["appointment"  S Y="VPRDSDAM",X="appointments"
"RTN","VPRD",51,0)
 I X["consult"      S Y="VPRDGMRC",X="consults"
"RTN","VPRD",52,0)
 I X["demograph"    S Y="VPRDPT",X="demographics"
"RTN","VPRD",53,0)
 I X["document"     S Y="VPRDTIU",X="documents"
"RTN","VPRD",54,0)
 I X["factor"       S Y="VPRDPXHF",X="healthFactors"
"RTN","VPRD",55,0)
 I X["flag"         S Y="VPRDGPF",X="flags"
"RTN","VPRD",56,0)
 I X["immunization" S Y="VPRDPXIM",X="immunizations"
"RTN","VPRD",57,0)
 I X["lab"          S Y="VPRDLR",X="labs"
"RTN","VPRD",58,0)
 I X["panel"        S Y="VPRDLRO",X="panels"
"RTN","VPRD",59,0)
 I X["med"          S Y="VPRDPS",X="meds"
"RTN","VPRD",60,0)
 I X["rx"           S Y="VPRDPSO",X="meds"
"RTN","VPRD",61,0)
 I X["order"        S Y="VPRDOR",X="orders"
"RTN","VPRD",62,0)
 I X["patient"      S Y="VPRDPT",X="demographics"
"RTN","VPRD",63,0)
 I X["problem"      S Y="VPRDGMPL",X="problems"
"RTN","VPRD",64,0)
 I X["procedure"    S Y="VPRDPROC",X="procedures"
"RTN","VPRD",65,0)
 I X["reaction"     S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",66,0)
 I X["surg"         S Y="VPRDSR",X="surgeries"
"RTN","VPRD",67,0)
 I X["visit"        S Y="VPRDVSIT",X="visits"
"RTN","VPRD",68,0)
 I X["vital"        S Y="VPRDGMV",X="vitals"
"RTN","VPRD",69,0)
 I X["rad"          S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",70,0)
 I X["xray"         S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",71,0)
 I X["new"          S Y="VPRDX",X="patients"
"RTN","VPRD",72,0)
 Q Y
"RTN","VPRD",73,0)
 ;
"RTN","VPRD",74,0)
TAG(X) ; -- return plural name for group tags
"RTN","VPRD",75,0)
 N Y S:X'?1.L X=$$LOW^XLFSTR(X)
"RTN","VPRD",76,0)
 I $E(X,$L(X))="s" S Y=X
"RTN","VPRD",77,0)
 I $E(X,$L(X))="y" S Y=$E(X,1,$L(X)-1)_"ies"
"RTN","VPRD",78,0)
 E  S Y=X_"s"
"RTN","VPRD",79,0)
 Q Y
"RTN","VPRD",80,0)
 ;
"RTN","VPRD",81,0)
ALL() ; -- return string for all types of data
"RTN","VPRD",82,0)
 Q "demographics;reactions;problems;vitals;labs;meds;immunizations;visits;appointments;documents;procedures;consults;flags;factors"
"RTN","VPRD",83,0)
 ;
"RTN","VPRD",84,0)
ERR(X,VAL) ; -- return error message
"RTN","VPRD",85,0)
 N MSG  S MSG="Error"
"RTN","VPRD",86,0)
 I X=1  S MSG="Patient with dfn '"_$G(VAL)_"' not found"
"RTN","VPRD",87,0)
 I X=2  S MSG="Requested domain type '"_$G(VAL)_"' not recognized"
"RTN","VPRD",88,0)
 I X=99 S MSG="Unknown request"
"RTN","VPRD",89,0)
 ;
"RTN","VPRD",90,0)
 D ADD("<error>")
"RTN","VPRD",91,0)
 D ADD("<message>"_MSG_"</message>")
"RTN","VPRD",92,0)
 D ADD("</error>")
"RTN","VPRD",93,0)
 Q
"RTN","VPRD",94,0)
 ;
"RTN","VPRD",95,0)
ESC(X) ; -- escape outgoing XML
"RTN","VPRD",96,0)
 ; Q $ZCONVERT(X,"O","HTML")  ; uncomment for fastest performance on Cache
"RTN","VPRD",97,0)
 ;
"RTN","VPRD",98,0)
 N I,Y,QOT S QOT=""""
"RTN","VPRD",99,0)
 S Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"&amp;"_$P(X,"&",I)
"RTN","VPRD",100,0)
 S X=Y,Y=$P(X,"<") F I=2:1:$L(X,"<") S Y=Y_"&lt;"_$P(X,"<",I)
"RTN","VPRD",101,0)
 S X=Y,Y=$P(X,">") F I=2:1:$L(X,">") S Y=Y_"&gt;"_$P(X,">",I)
"RTN","VPRD",102,0)
 S X=Y,Y=$P(X,"'") F I=2:1:$L(X,"'") S Y=Y_"&apos;"_$P(X,"'",I)
"RTN","VPRD",103,0)
 S X=Y,Y=$P(X,QOT) F I=2:1:$L(X,QOT) S Y=Y_"&quot;"_$P(X,QOT,I)
"RTN","VPRD",104,0)
 Q Y
"RTN","VPRD",105,0)
 ;
"RTN","VPRD",106,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRD",107,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRD",108,0)
 S @VPR@(VPRI)=X
"RTN","VPRD",109,0)
 Q
"RTN","VPRD",110,0)
 ;
"RTN","VPRD",111,0)
STRING(ARRAY) ; -- Return text in ARRAY(n) or ARRAY(n,0) as a string
"RTN","VPRD",112,0)
 N I,X,Y S Y=""
"RTN","VPRD",113,0)
 S I=+$O(ARRAY("")) I I=0 S I=+$O(ARRAY(0))
"RTN","VPRD",114,0)
 S Y=$S($D(ARRAY(I,0)):ARRAY(I,0),1:$G(ARRAY(I)))
"RTN","VPRD",115,0)
 F  S I=$O(ARRAY(I)) Q:I<1  D
"RTN","VPRD",116,0)
 . S X=$S($D(ARRAY(I,0)):ARRAY(I,0),1:ARRAY(I))
"RTN","VPRD",117,0)
 . I $E(X)=" " S Y=Y_$C(13,10)_X Q
"RTN","VPRD",118,0)
 . S Y=Y_$S($E(Y,$L(Y))=" ":"",1:" ")_X
"RTN","VPRD",119,0)
 Q Y
"RTN","VPRD",120,0)
 ;
"RTN","VPRD",121,0)
FAC(X) ; -- return Institution file station# for location X
"RTN","VPRD",122,0)
 N HLOC,FAC,Y0,Y S Y=""
"RTN","VPRD",123,0)
 S HLOC=$G(^SC(+$G(X),0)),FAC=$P(HLOC,U,4)
"RTN","VPRD",124,0)
 ; Get P:4 via Med Ctr Div, if not directly linked
"RTN","VPRD",125,0)
 I 'FAC,$P(HLOC,U,15) S FAC=$$GET1^DIQ(44,+$G(X)_",","3.5:.07","I")
"RTN","VPRD",126,0)
 S Y0=$S(FAC:$$NS^XUAF4(FAC),1:$P($$SITE^VASITE,U,2,3)) ;name^stn#
"RTN","VPRD",127,0)
 S:$L(Y0) Y=$P(Y0,U,2)_U_$P(Y0,U) ;switch to stn#^name
"RTN","VPRD",128,0)
 I $L(Y),'Y S $P(Y,U)=FAC
"RTN","VPRD",129,0)
 Q Y
"RTN","VPRD",130,0)
 ;
"RTN","VPRD",131,0)
VUID(IEN,FILE) ; -- Return VUID for item
"RTN","VPRD",132,0)
 Q $$GET1^DIQ(FILE,IEN_",",99.99)
"RTN","VPRD",133,0)
 ;
"RTN","VPRD",134,0)
VERSION(RET) ; -- Return current version of data extracts
"RTN","VPRD",135,0)
 S RET="1.0"
"RTN","VPRD",136,0)
 Q
"RTN","VPRDGMPL")
0^2^B20610705
"RTN","VPRDGMPL",1,0)
VPRDGMPL ;SLC/MKB -- Problem extract ;8/2/11  15:29
"RTN","VPRDGMPL",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDGMPL",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMPL",4,0)
 ;
"RTN","VPRDGMPL",5,0)
 ; External References          DBIA#
"RTN","VPRDGMPL",6,0)
 ; -------------------          -----
"RTN","VPRDGMPL",7,0)
 ; ^AUPNPROB                     5703
"RTN","VPRDGMPL",8,0)
 ; ^VA(200                      10060
"RTN","VPRDGMPL",9,0)
 ; %DT                          10003
"RTN","VPRDGMPL",10,0)
 ; DIQ                           2056
"RTN","VPRDGMPL",11,0)
 ; GMPLUTL2                      2741
"RTN","VPRDGMPL",12,0)
 ; XUAF4                         2171
"RTN","VPRDGMPL",13,0)
 ;
"RTN","VPRDGMPL",14,0)
 ; ------------ Get problems from VistA ------------
"RTN","VPRDGMPL",15,0)
 ;
"RTN","VPRDGMPL",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's problems
"RTN","VPRDGMPL",17,0)
 N VPRPROB,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDGMPL",18,0)
 ;
"RTN","VPRDGMPL",19,0)
 ; get one problem
"RTN","VPRDGMPL",20,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMPL",21,0)
 ;
"RTN","VPRDGMPL",22,0)
 ; get all patient problems
"RTN","VPRDGMPL",23,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMPL",24,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMPL",25,0)
 D LIST^GMPLUTL2(.VPRPROB,DFN,"") ;all problems
"RTN","VPRDGMPL",26,0)
 S VPRN=0 F  S VPRN=$O(VPRPROB(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDGMPL",27,0)
 . S X=$P(VPRPROB(VPRN),U,5) I X,(X<BEG)!(X>END) Q  ;onset
"RTN","VPRDGMPL",28,0)
 . S X=+VPRPROB(VPRN) K VPRITM ;ien
"RTN","VPRDGMPL",29,0)
 . D EN1(X,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMPL",30,0)
 . S VPRCNT=VPRCNT+1
"RTN","VPRDGMPL",31,0)
 Q
"RTN","VPRDGMPL",32,0)
 ;
"RTN","VPRDGMPL",33,0)
EN1(ID,PROB) ; -- return a problem in PROB("attribute")=value
"RTN","VPRDGMPL",34,0)
 N VPRL,X,I,J K PROB
"RTN","VPRDGMPL",35,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMPL",36,0)
 D DETAIL^GMPLUTL2(ID,.VPRL) Q:'$D(VPRL)  ;doesn't exist
"RTN","VPRDGMPL",37,0)
 S PROB("id")=ID ;,PROB("lexiconID")=+X1 ;SNOMED?
"RTN","VPRDGMPL",38,0)
 S PROB("name")=$G(VPRL("NARRATIVE"))
"RTN","VPRDGMPL",39,0)
 S X=$G(VPRL("MODIFIED")) S:$L(X) PROB("updated")=$$DATE(X)
"RTN","VPRDGMPL",40,0)
 S PROB("icd")=$G(VPRL("DIAGNOSIS"))
"RTN","VPRDGMPL",41,0)
 S X=$G(VPRL("STATUS")) S:$L(X) PROB("status")=$E(X)_U_X
"RTN","VPRDGMPL",42,0)
 S X=$G(VPRL("HISTORY"))  S:$L(X) PROB("history")=$E(X)_U_X
"RTN","VPRDGMPL",43,0)
 S X=$G(VPRL("PRIORITY")) S:$L(X) PROB("acuity")=$E(X)_U_X
"RTN","VPRDGMPL",44,0)
 S X=$G(VPRL("ONSET")) S:$L(X) PROB("onset")=$$DATE(X)
"RTN","VPRDGMPL",45,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.07,"I") S:X PROB("resolved")=X
"RTN","VPRDGMPL",46,0)
 S X=$P($G(VPRL("ENTERED")),U)  S:$L(X) PROB("entered")=$$DATE(X)
"RTN","VPRDGMPL",47,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.02,"I")
"RTN","VPRDGMPL",48,0)
 S:X="P" PROB("unverified")=0,PROB("removed")=0
"RTN","VPRDGMPL",49,0)
 S:X="T" PROB("unverified")=1,PROB("removed")=0
"RTN","VPRDGMPL",50,0)
 S:X="H" PROB("unverified")=0,PROB("removed")=1
"RTN","VPRDGMPL",51,0)
 S X=$G(VPRL("SC")),X=$S(X="YES":1,X="NO":0,1:"")
"RTN","VPRDGMPL",52,0)
 S:$L(X) PROB("sc")=X I $G(VPRL("EXPOSURE")) D   ;ao^rad^pgulf^hnc^mst^cv
"RTN","VPRDGMPL",53,0)
 . S I=0 F  S I=$O(VPRL("EXPOSURE",I)) Q:I<1  D
"RTN","VPRDGMPL",54,0)
 .. S X=$G(VPRL("EXPOSURE",I))
"RTN","VPRDGMPL",55,0)
 .. S PROB("exposure",I)=$$EXP(X)
"RTN","VPRDGMPL",56,0)
 S X=$G(VPRL("PROVIDER")) S:$L(X) PROB("provider")=$$VA200(X)_U_X
"RTN","VPRDGMPL",57,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.06) S:$L(X) PROB("service")=X
"RTN","VPRDGMPL",58,0)
 S X=$G(VPRL("CLINIC")) S:$L(X) PROB("location")=X
"RTN","VPRDGMPL",59,0)
 S X=+$$GET1^DIQ(9000011,ID_",",.06,"I")
"RTN","VPRDGMPL",60,0)
 S:X PROB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDGMPL",61,0)
 I 'X S PROB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMPL",62,0)
CMT ; comments
"RTN","VPRDGMPL",63,0)
 Q:'$G(VPRL("COMMENT"))
"RTN","VPRDGMPL",64,0)
 S I=0 F  S I=$O(VPRL("COMMENT",I)) Q:I<1  D
"RTN","VPRDGMPL",65,0)
 . S X=$G(VPRL("COMMENT",I))
"RTN","VPRDGMPL",66,0)
 . S PROB("comment",I)=$$DATE($P(X,U))_U_$P(X,U,2,3)
"RTN","VPRDGMPL",67,0)
 . ; = date ^ name of author ^ text
"RTN","VPRDGMPL",68,0)
 Q
"RTN","VPRDGMPL",69,0)
 ;
"RTN","VPRDGMPL",70,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMPL",71,0)
 N %DT,Y
"RTN","VPRDGMPL",72,0)
 S %DT="" D ^%DT S:Y<1 Y=X
"RTN","VPRDGMPL",73,0)
 Q Y
"RTN","VPRDGMPL",74,0)
 ;
"RTN","VPRDGMPL",75,0)
VA200(X) ; -- Return ien of New Person X
"RTN","VPRDGMPL",76,0)
 N Y S Y=$S($L($G(X)):+$O(^VA(200,"B",X,0)),1:"")
"RTN","VPRDGMPL",77,0)
 Q Y
"RTN","VPRDGMPL",78,0)
 ;
"RTN","VPRDGMPL",79,0)
EXP(X) ; -- Return code for exposure name X
"RTN","VPRDGMPL",80,0)
 N Y S Y="",X=$E($G(X))
"RTN","VPRDGMPL",81,0)
 I X="A" S Y="AO"  ;agent orange
"RTN","VPRDGMPL",82,0)
 I X="R" S Y="IR"  ;ionizing radiation
"RTN","VPRDGMPL",83,0)
 I X="E" S Y="PG"  ;persian gulf
"RTN","VPRDGMPL",84,0)
 I X="H" S Y="HNC" ;head/neck cancer
"RTN","VPRDGMPL",85,0)
 I X="M" S Y="MST" ;military sexual trauma
"RTN","VPRDGMPL",86,0)
 I X="C" S Y="CV"  ;combat vet
"RTN","VPRDGMPL",87,0)
 I X="S" S Y="SHAD"
"RTN","VPRDGMPL",88,0)
 Q Y
"RTN","VPRDGMPL",89,0)
 ;
"RTN","VPRDGMPL",90,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMPL",91,0)
 ;
"RTN","VPRDGMPL",92,0)
XML(PROB) ; -- Return patient problem as XML in @VPR@(I)
"RTN","VPRDGMPL",93,0)
 N ATT,I,X,Y,P,TAG
"RTN","VPRDGMPL",94,0)
 D ADD("<problem>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMPL",95,0)
 S ATT="" F  S ATT=$O(PROB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMPL",96,0)
 . I ATT="exposure" D  S Y="" Q
"RTN","VPRDGMPL",97,0)
 .. S Y="<exposures>" D ADD(Y)
"RTN","VPRDGMPL",98,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) S:$L(X) Y="<exposure value='"_X_"' />" D ADD(Y)
"RTN","VPRDGMPL",99,0)
 .. D ADD("</exposures>")
"RTN","VPRDGMPL",100,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMPL",101,0)
 .. D ADD("<comments>")
"RTN","VPRDGMPL",102,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) D
"RTN","VPRDGMPL",103,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMPL",104,0)
 ... S:$L($P(X,U,1)) Y=Y_"' entered='"_$P(X,U)
"RTN","VPRDGMPL",105,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMPL",106,0)
 ... S:$L($P(X,U,3)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,3))
"RTN","VPRDGMPL",107,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMPL",108,0)
 .. D ADD("</comments>")
"RTN","VPRDGMPL",109,0)
 . S X=$G(PROB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMPL",110,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMPL",111,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMPL",112,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMPL",113,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMPL",114,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMPL",115,0)
 D ADD("</problem>")
"RTN","VPRDGMPL",116,0)
 Q
"RTN","VPRDGMPL",117,0)
 ;
"RTN","VPRDGMPL",118,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMPL",119,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMPL",120,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMPL",121,0)
 Q
"RTN","VPRDGMRA")
0^3^B21412184
"RTN","VPRDGMRA",1,0)
VPRDGMRA ;SLC/MKB -- Allergy/Reaction extract ;8/2/11  15:29
"RTN","VPRDGMRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDGMRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRA",4,0)
 ;
"RTN","VPRDGMRA",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRA",6,0)
 ; -------------------          -----
"RTN","VPRDGMRA",7,0)
 ; %DT                          10003
"RTN","VPRDGMRA",8,0)
 ; GMRADPT                      10099
"RTN","VPRDGMRA",9,0)
 ; EN1^GMRAOR2                   2422
"RTN","VPRDGMRA",10,0)
 ; PSN50P41                      4531
"RTN","VPRDGMRA",11,0)
 ; PSN50P65                      4543
"RTN","VPRDGMRA",12,0)
 ;
"RTN","VPRDGMRA",13,0)
 ; ------------ Get reactions from VistA ------------
"RTN","VPRDGMRA",14,0)
 ;
"RTN","VPRDGMRA",15,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's allergies/reactions
"RTN","VPRDGMRA",16,0)
 N GMRA,GMRAL,VPRN,VPRITM,VPRCNT
"RTN","VPRDGMRA",17,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRA",18,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMRA",19,0)
 D EN1^GMRADPT
"RTN","VPRDGMRA",20,0)
 ;
"RTN","VPRDGMRA",21,0)
 ; get one reaction
"RTN","VPRDGMRA",22,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMRA",23,0)
 ;
"RTN","VPRDGMRA",24,0)
 ; get all reactions
"RTN","VPRDGMRA",25,0)
 I 'GMRAL S VPRITM("assessment")=$S(GMRAL=0:"nka",1:"not done") D XML(.VPRITM) Q
"RTN","VPRDGMRA",26,0)
 S VPRN=0 F  S VPRN=+$O(GMRAL(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDGMRA",27,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDGMRA",28,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDGMRA",29,0)
 Q
"RTN","VPRDGMRA",30,0)
 ;
"RTN","VPRDGMRA",31,0)
EN1(ID,REAC) ; -- return a reaction in REAC("attribute")=value
"RTN","VPRDGMRA",32,0)
 ;          from EN: expects GMRAL(ID)
"RTN","VPRDGMRA",33,0)
 N VPRY,GMRA,I,J,X,Y,SEV,TXT,SEV K REAC
"RTN","VPRDGMRA",34,0)
 S GMRA=$G(GMRAL(ID)) D EN1^GMRAOR2(ID,"VPRY")
"RTN","VPRDGMRA",35,0)
 S X=$P(VPRY,U,10) I $L(X) S X=$$DATE(X) Q:X<BEG  Q:X>END  S REAC("entered")=X
"RTN","VPRDGMRA",36,0)
 S REAC("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMRA",37,0)
 S REAC("id")=ID,REAC("name")=$P(VPRY,U) I $P(GMRA,U,9) D
"RTN","VPRDGMRA",38,0)
 . S X=$P(GMRA,U,9),Y=+$P(X,"(",2) I 'Y,X["PSDRUG" S Y=50
"RTN","VPRDGMRA",39,0)
 . S REAC("localCode")=X,REAC("vuid")=$$VUID^VPRD(+X,Y)
"RTN","VPRDGMRA",40,0)
 S X=$P(VPRY,U,6) S:$L(X) REAC("mechanism")=X
"RTN","VPRDGMRA",41,0)
 S X=$P(VPRY,U,5),REAC("source")=$E(X)
"RTN","VPRDGMRA",42,0)
 S REAC("type")=$S($L(GMRA):$P(GMRA,U,7),1:$$DFO($P(VPRY,U,7)))_U_$P(VPRY,U,7)
"RTN","VPRDGMRA",43,0)
 I $P(VPRY,U,4)="VERIFIED",$P(VPRY,U,9) S REAC("verified")=$P(VPRY,U,9)
"RTN","VPRDGMRA",44,0)
 S I=0,SEV="" F  S I=$O(VPRY("O",I)) Q:I<1  S X=$P(VPRY("O",I),U,2) S:X]SEV SEV=X ;find highest severity
"RTN","VPRDGMRA",45,0)
 S:$L(SEV) REAC("severity")=SEV
"RTN","VPRDGMRA",46,0)
 ; reactions
"RTN","VPRDGMRA",47,0)
 S I=0 F  S I=$O(GMRAL(ID,"S",I)) Q:I<1  D
"RTN","VPRDGMRA",48,0)
 . S X=$G(GMRAL(ID,"S",I)),Y=+$P(X,";",2)
"RTN","VPRDGMRA",49,0)
 . S REAC("reaction",I)=$P(X,";")_U_$$VUID^VPRD(Y,120.83)
"RTN","VPRDGMRA",50,0)
 ; comments
"RTN","VPRDGMRA",51,0)
 S I=0 F  S I=$O(VPRY("C",I)) Q:I<1  D
"RTN","VPRDGMRA",52,0)
 . S X=$G(VPRY("C",I)) K TXT
"RTN","VPRDGMRA",53,0)
 . S Y=$$VA200($P(X,U,3))_U_$P(X,U)
"RTN","VPRDGMRA",54,0)
 . S Y=Y_U_$S($L($P(X,U,2)):$E($P(X,U,2)),1:"E")
"RTN","VPRDGMRA",55,0)
 . S J=0 F  S J=$O(VPRY("C",I,J)) Q:J<1  S X=$G(VPRY("C",I,J,0)),TXT(J)=X
"RTN","VPRDGMRA",56,0)
 . K X S X=$$STRING^VPRD(.TXT)
"RTN","VPRDGMRA",57,0)
 . S REAC("comment",I)=Y_U_X ;ien^name^date^type^text
"RTN","VPRDGMRA",58,0)
 ; drug info
"RTN","VPRDGMRA",59,0)
 I $D(VPRY("I")) D
"RTN","VPRDGMRA",60,0)
 . N ROOT S ROOT=$$B^PSN50P41
"RTN","VPRDGMRA",61,0)
 . S I=0 F  S I=$O(VPRY("I",I)) Q:I<1  S X=$G(VPRY("I",I)) D
"RTN","VPRDGMRA",62,0)
 .. N IEN S IEN=$O(@ROOT@(X,0))
"RTN","VPRDGMRA",63,0)
 .. S REAC("drugIngredient",I)=X_U_$$VUID^VPRD(IEN,50.416)
"RTN","VPRDGMRA",64,0)
 I $D(VPRY("V")) D
"RTN","VPRDGMRA",65,0)
 . S I=0 F  S I=$O(VPRY("V",I)) Q:I<1  S X=$G(VPRY("V",I)) D
"RTN","VPRDGMRA",66,0)
 .. D C^PSN50P65("",$P(X,U,2),"PSN")
"RTN","VPRDGMRA",67,0)
 .. N IEN S IEN=+$O(^TMP($J,"PSN","C",$P(X,U),0))
"RTN","VPRDGMRA",68,0)
 .. S REAC("drugClass",I)=$P(X,U,2)_U_$$VUID^VPRD(IEN,50.605)
"RTN","VPRDGMRA",69,0)
 I GMRA="" S REAC("removed")=1 ;entered in error
"RTN","VPRDGMRA",70,0)
 Q
"RTN","VPRDGMRA",71,0)
 ;
"RTN","VPRDGMRA",72,0)
VA200(NAME) ; -- Return ien^name from #200
"RTN","VPRDGMRA",73,0)
 N Y S NAME=$G(NAME),Y="^"
"RTN","VPRDGMRA",74,0)
 I $L(NAME) S Y=+$O(^VA(200,"B",NAME,0))_U_NAME
"RTN","VPRDGMRA",75,0)
 Q Y
"RTN","VPRDGMRA",76,0)
 ;
"RTN","VPRDGMRA",77,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMRA",78,0)
 N %DT,Y
"RTN","VPRDGMRA",79,0)
 S %DT="TX" D ^%DT
"RTN","VPRDGMRA",80,0)
 Q Y
"RTN","VPRDGMRA",81,0)
 ;
"RTN","VPRDGMRA",82,0)
DFO(X) ; -- Return 'DFO' string for mechanism name(s)
"RTN","VPRDGMRA",83,0)
 N I,P,Y S Y=""
"RTN","VPRDGMRA",84,0)
 F I=1:1:$L(X,",") S P=$P(X,",",I),Y=Y_$S($E(P)=" ":$E(P,2),1:$E(P))
"RTN","VPRDGMRA",85,0)
 S:Y="" Y=$G(X)
"RTN","VPRDGMRA",86,0)
 Q Y
"RTN","VPRDGMRA",87,0)
 ;
"RTN","VPRDGMRA",88,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRA",89,0)
 ;
"RTN","VPRDGMRA",90,0)
XML(REAC) ; -- Return patient reaction as XML
"RTN","VPRDGMRA",91,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRA",92,0)
 N ATT,X,Y,I,P,NM,TAG
"RTN","VPRDGMRA",93,0)
 D ADD("<allergy>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRA",94,0)
 S ATT="" F  S ATT=$O(REAC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRA",95,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMRA",96,0)
 .. S I=0,Y="<comments>" D ADD(Y)
"RTN","VPRDGMRA",97,0)
 .. F  S I=$O(REAC(ATT,I)) Q:I<1  S X=$G(REAC(ATT,I)) D
"RTN","VPRDGMRA",98,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMRA",99,0)
 ... S:$L($P(X,U,3)) Y=Y_"' entered='"_$P(X,U,3)
"RTN","VPRDGMRA",100,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMRA",101,0)
 ... S:$L($P(X,U,4)) Y=Y_"' commentType='"_$P(X,U,4)
"RTN","VPRDGMRA",102,0)
 ... S:$L($P(X,U,5)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,5))
"RTN","VPRDGMRA",103,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMRA",104,0)
 .. D ADD("</comments>")
"RTN","VPRDGMRA",105,0)
 . I $O(REAC(ATT,0)) D  S Y="" Q
"RTN","VPRDGMRA",106,0)
 .. S NM=ATT_$S($E(ATT,$L(ATT))="s":"es",1:"s") D ADD("<"_NM_">")
"RTN","VPRDGMRA",107,0)
 .. S I=0 F  S I=$O(REAC(ATT,I)) Q:I<1  D
"RTN","VPRDGMRA",108,0)
 ... S X=$G(REAC(ATT,I)),Y="<"_ATT_" "
"RTN","VPRDGMRA",109,0)
 ... F P=1:1 S TAG=$P("name^vuid^severity^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRA",110,0)
 ... S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMRA",111,0)
 .. D ADD("</"_NM_">")
"RTN","VPRDGMRA",112,0)
 . S X=$G(REAC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRA",113,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRA",114,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMRA",115,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMRA",116,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRA",117,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMRA",118,0)
 D ADD("</allergy>")
"RTN","VPRDGMRA",119,0)
 Q
"RTN","VPRDGMRA",120,0)
 ;
"RTN","VPRDGMRA",121,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRA",122,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRA",123,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRA",124,0)
 Q
"RTN","VPRDGMRC")
0^4^B10314726
"RTN","VPRDGMRC",1,0)
VPRDGMRC ;SLC/MKB -- Consult extract ;8/2/11  15:29
"RTN","VPRDGMRC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDGMRC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRC",4,0)
 ;
"RTN","VPRDGMRC",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRC",6,0)
 ; -------------------          -----
"RTN","VPRDGMRC",7,0)
 ; ^TIU(8925.1                   5677
"RTN","VPRDGMRC",8,0)
 ; DIQ                           2056
"RTN","VPRDGMRC",9,0)
 ; GMRCGUIB                      2980
"RTN","VPRDGMRC",10,0)
 ; GMRCSLM1,^TMP("GMRCR",$J)     2740
"RTN","VPRDGMRC",11,0)
 ; TIULQ                         2693
"RTN","VPRDGMRC",12,0)
 ; XUAF4                         2171
"RTN","VPRDGMRC",13,0)
 ;
"RTN","VPRDGMRC",14,0)
 ; ------------ Get consults from VistA ------------
"RTN","VPRDGMRC",15,0)
 ;
"RTN","VPRDGMRC",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's consults
"RTN","VPRDGMRC",17,0)
 N VPRN,VPRX,VPRITM K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRC",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMRC",20,0)
 ;
"RTN","VPRDGMRC",21,0)
 D OER^GMRCSLM1(DFN,"",BEG,END,"")
"RTN","VPRDGMRC",22,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>MAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDGMRC",23,0)
 . I $G(IFN),IFN'=+VPRX Q
"RTN","VPRDGMRC",24,0)
 . K VPRITM D EN1(+VPRX,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMRC",25,0)
 K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",26,0)
 Q
"RTN","VPRDGMRC",27,0)
 ;
"RTN","VPRDGMRC",28,0)
EN1(ID,CONS) ; -- return a consult in CONS("attribute")=value
"RTN","VPRDGMRC",29,0)
 ;     Expects DFN, VPRX=^TMP("GMRCR",$J,"CS",VPRN,0) [from EN]
"RTN","VPRDGMRC",30,0)
 N VPRD,X0,VPRJ,X,VPRTIU,LT,NT
"RTN","VPRDGMRC",31,0)
 S CONS("id")=ID,CONS("requested")=$P(VPRX,U,2)
"RTN","VPRDGMRC",32,0)
 S CONS("status")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDGMRC",33,0)
 S CONS("procedure")=$P(VPRX,U,5),CONS("name")=$P(VPRX,U,7)
"RTN","VPRDGMRC",34,0)
 I $P(VPRX,U,6)="*" S CONS("result")="SIGNIFICANT FINDINGS"
"RTN","VPRDGMRC",35,0)
 S CONS("orderID")=$P(VPRX,U,8),CONS("type")=$P(VPRX,U,9)
"RTN","VPRDGMRC",36,0)
 D DOCLIST^GMRCGUIB(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",37,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDGMRC",38,0)
 . Q:'$D(@(U_$P(X,";",2)_+X_")"))  ;text deleted
"RTN","VPRDGMRC",39,0)
 . D EXTRACT^TIULQ(+X,"VPRTIU",,.01)
"RTN","VPRDGMRC",40,0)
 . S LT=$G(VPRTIU(+X,.01,"E")) ;print name
"RTN","VPRDGMRC",41,0)
 . S NT=$$GET1^DIQ(8925.1,+$G(VPRTIU(+X,.01,"I"))_",",1501)
"RTN","VPRDGMRC",42,0)
 . S CONS("document",VPRJ)=+X_U_LT_U_NT
"RTN","VPRDGMRC",43,0)
 . S:$G(VPRTEXT) CONS("document",VPRJ,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDGMRC",44,0)
 S X=$P(X0,U,21),CONS("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDGMRC",45,0)
 Q
"RTN","VPRDGMRC",46,0)
 ;
"RTN","VPRDGMRC",47,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRC",48,0)
 ;
"RTN","VPRDGMRC",49,0)
XML(CONS) ; -- Return patient consult as XML
"RTN","VPRDGMRC",50,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRC",51,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDGMRC",52,0)
 D ADD("<consult>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRC",53,0)
 S ATT="" F  S ATT=$O(CONS(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRC",54,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDGMRC",55,0)
 . I $O(CONS(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDGMRC",56,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDGMRC",57,0)
 .. S I=0 F  S I=$O(CONS(ATT,I)) Q:I<1  D
"RTN","VPRDGMRC",58,0)
 ... S X=$G(CONS(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDGMRC",59,0)
 ... S X=$G(CONS(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMRC",60,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDGMRC",61,0)
 ... S Y="<content xml:space='preserve'>"_$$ESC^VPRD(X)_"</content>"
"RTN","VPRDGMRC",62,0)
 ... D ADD(Y),ADD("</"_ATT_">")
"RTN","VPRDGMRC",63,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDGMRC",64,0)
 . S X=$G(CONS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRC",65,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRC",66,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDGMRC",67,0)
 D ADD("</consult>")
"RTN","VPRDGMRC",68,0)
 Q
"RTN","VPRDGMRC",69,0)
 ;
"RTN","VPRDGMRC",70,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDGMRC",71,0)
 N STR,P,TAG S STR=""
"RTN","VPRDGMRC",72,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRC",73,0)
 Q STR
"RTN","VPRDGMRC",74,0)
 ;
"RTN","VPRDGMRC",75,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRC",76,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRC",77,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRC",78,0)
 Q
"RTN","VPRDGMV")
0^5^B39440303
"RTN","VPRDGMV",1,0)
VPRDGMV ;SLC/MKB -- Vitals extract ;8/2/11  15:29
"RTN","VPRDGMV",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDGMV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMV",4,0)
 ;
"RTN","VPRDGMV",5,0)
 ; External References          DBIA#
"RTN","VPRDGMV",6,0)
 ; -------------------          -----
"RTN","VPRDGMV",7,0)
 ; ^SC                          10040
"RTN","VPRDGMV",8,0)
 ; ^VA(200                      10060
"RTN","VPRDGMV",9,0)
 ; DILFD                         2055
"RTN","VPRDGMV",10,0)
 ; DIQ                           2056
"RTN","VPRDGMV",11,0)
 ; GMRVUT0,^UTILITY($J,"GMRVD")  1446
"RTN","VPRDGMV",12,0)
 ; GMVGETQL                      5048
"RTN","VPRDGMV",13,0)
 ; GMVGETVT                      5047
"RTN","VPRDGMV",14,0)
 ; GMVRPCM                       5702
"RTN","VPRDGMV",15,0)
 ; GMVUTL                        5046
"RTN","VPRDGMV",16,0)
 ;
"RTN","VPRDGMV",17,0)
 ; ------------ Get vitals from VistA ------------
"RTN","VPRDGMV",18,0)
 ;
"RTN","VPRDGMV",19,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's vitals
"RTN","VPRDGMV",20,0)
 N VPRITM,VPRPARAM,GMRVSTR,IDT,TYPE,VIT,CNT,X0,X,Y,I,N
"RTN","VPRDGMV",21,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMV",22,0)
 ;
"RTN","VPRDGMV",23,0)
 ; get one measurement
"RTN","VPRDGMV",24,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMV",25,0)
 ;
"RTN","VPRDGMV",26,0)
 ; get all measurements
"RTN","VPRDGMV",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMV",28,0)
 S GMRVSTR="BP;T;R;P;HT;WT;CVP;CG;PO2;PN",GMRVSTR(0)=BEG_U_END_U_MAX_"^1"
"RTN","VPRDGMV",29,0)
 K ^UTILITY($J,"GMRVD") D EN1^GMRVUT0
"RTN","VPRDGMV",30,0)
 S (IDT,CNT)=0 F  S IDT=$O(^UTILITY($J,"GMRVD",IDT)) Q:IDT<1  D  Q:CNT'<MAX
"RTN","VPRDGMV",31,0)
 . K VIT S VIT("taken")=9999999-IDT,CNT=CNT+1,N=0
"RTN","VPRDGMV",32,0)
 . S TYPE="" F  S TYPE=$O(^UTILITY($J,"GMRVD",IDT,TYPE)) Q:TYPE=""  D
"RTN","VPRDGMV",33,0)
 .. N NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,QUAL
"RTN","VPRDGMV",34,0)
 .. S IFN=+$O(^UTILITY($J,"GMRVD",IDT,TYPE,0)),X0=$G(^(IFN))
"RTN","VPRDGMV",35,0)
 .. S X=+$P(X0,U,3),NAME=$$FIELD^GMVGETVT(X,1)
"RTN","VPRDGMV",36,0)
 .. S VUID=$$FIELD^GMVGETVT(X,4),RESULT=$P(X0,U,8)
"RTN","VPRDGMV",37,0)
 .. S UNIT=$S(TYPE="T":"F",TYPE="HT":"in",TYPE="WT":"lb",TYPE="CVP":"cmH2O",TYPE="CG":"in",1:"")
"RTN","VPRDGMV",38,0)
 .. S (MRES,MUNT)="" I $L($P(X0,U,13)) D
"RTN","VPRDGMV",39,0)
 ... S X=$S(TYPE="T":"C",TYPE="HT":"cm",TYPE="WT":"kg",TYPE="CG":"cm",1:"")
"RTN","VPRDGMV",40,0)
 ... S MRES=$P(X0,U,13) S:$L(X) MUNT=X
"RTN","VPRDGMV",41,0)
 .. S X=$$RANGE(TYPE),(HIGH,LOW)="" I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",42,0)
 .. S N=N+1,VIT("measurement",N)=IFN_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW
"RTN","VPRDGMV",43,0)
 .. S QUAL=$P(X0,U,17) I $L(QUAL) F I=1:1:$L(QUAL,";") D
"RTN","VPRDGMV",44,0)
 ... S X=$P(QUAL,";",I),Y=$$GETIEN^GMVGETQL(X,1)
"RTN","VPRDGMV",45,0)
 ... I Y S VIT("measurement",N,"qualifier",I)=X_U_$$FIELD^GMVGETQL(Y,3)
"RTN","VPRDGMV",46,0)
 . S VIT("entered")=$P($G(X0),U,4) ;use last one
"RTN","VPRDGMV",47,0)
 . S X=+$P($G(X0),U,5) S:X VIT("location")=$$LOC(X)
"RTN","VPRDGMV",48,0)
 . S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",49,0)
 . D XML(.VIT)
"RTN","VPRDGMV",50,0)
 K ^UTILITY($J,"GMRVD")
"RTN","VPRDGMV",51,0)
 Q
"RTN","VPRDGMV",52,0)
 ;
"RTN","VPRDGMV",53,0)
EN1(ID,VIT) ; -- return a vital/measurement in VIT("attribute")
"RTN","VPRDGMV",54,0)
 K VIT S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMV",55,0)
 N VPRY,X0,DFN,TYPE,X,Y,NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,I
"RTN","VPRDGMV",56,0)
 D GETREC^GMVUTL(.VPRY,ID,1) S X0=$G(VPRY(0))
"RTN","VPRDGMV",57,0)
 S DFN=+$P(X0,U,2) Q:DFN<1
"RTN","VPRDGMV",58,0)
 S TYPE=$$FIELD^GMVGETVT(+$P(X0,U,3),2)
"RTN","VPRDGMV",59,0)
 S X=+$P(X0,U,5),VIT("location")=$$LOC(X)
"RTN","VPRDGMV",60,0)
 S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",61,0)
 S NAME=$$FIELD^GMVGETVT($P(X0,U,3),1),VUID=$$FIELD^GMVGETVT($P(X0,U,3),4)
"RTN","VPRDGMV",62,0)
 S X=$P(X0,U,8),RESULT=X,(UNIT,MRES,MUNT)=""
"RTN","VPRDGMV",63,0)
 I TYPE="T" S UNIT="F",MUNT="C" S MRES=$J(X-32*5/9,0,1)  ; EN1^GMRVUTL
"RTN","VPRDGMV",64,0)
 I TYPE="HT" S UNIT="in",MUNT="cm" S MRES=$J(2.54*X,0,2) ; EN2^GMRVUTL
"RTN","VPRDGMV",65,0)
 I TYPE="WT" S UNIT="lb",MUNT="kg" S MRES=$J(X/2.2,0,2)  ; EN3^GMRVUTL
"RTN","VPRDGMV",66,0)
 I TYPE="CG" S UNIT="in",MUNT="cm" S MRES=$J(2.54*X,0,2)
"RTN","VPRDGMV",67,0)
 I TYPE="CVP" S UNIT="cmH2O"
"RTN","VPRDGMV",68,0)
 S VIT("taken")=+X0,VIT("entered")=+$P(X0,U,4),(HIGH,LOW)=""
"RTN","VPRDGMV",69,0)
 S X=$$RANGE(TYPE) I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",70,0)
 S VIT("measurement",1)=ID_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW
"RTN","VPRDGMV",71,0)
 F I=1:1:$L(VPRY(5),U) S X=$P(VPRY(5),U,I),VIT("measurement",1,"qualifier",I)=$$FIELD^GMVGETQL(X,1)_U_$$FIELD^GMVGETQL(X,3) ;name^VUID
"RTN","VPRDGMV",72,0)
 I $G(VPRY(2)) D  ;entered in error/reasons
"RTN","VPRDGMV",73,0)
 . S X=$P(VPRY(2),U,3)
"RTN","VPRDGMV",74,0)
 . F I=1:1:$L(X,"~") S VIT("removed",I)=$$EXTERNAL^DILFD(120.506,.01,,$P(X,"~",I))
"RTN","VPRDGMV",75,0)
 Q
"RTN","VPRDGMV",76,0)
 ;
"RTN","VPRDGMV",77,0)
USER(X) ; -- Return ien^name for person# X
"RTN","VPRDGMV",78,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",79,0)
 S Y=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:"^")
"RTN","VPRDGMV",80,0)
 Q Y
"RTN","VPRDGMV",81,0)
 ;
"RTN","VPRDGMV",82,0)
LOC(X) ; -- Return ien^name for hospital location X
"RTN","VPRDGMV",83,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",84,0)
 S Y=$S(X:X_U_$P($G(^SC(X,0)),U),1:"^")
"RTN","VPRDGMV",85,0)
 Q Y
"RTN","VPRDGMV",86,0)
 ;
"RTN","VPRDGMV",87,0)
RANGE(TYPE) ; -- return high^low range of values for TYPE
"RTN","VPRDGMV",88,0)
 N Y I '$D(VPRPARAM(TYPE)) D  ;get parameter values
"RTN","VPRDGMV",89,0)
 . N VPRFLDS,VPRI,VPRY,VPRN,VPRX,X
"RTN","VPRDGMV",90,0)
 . S VPRFLDS=$S(TYPE="T":"5.1^5.2",TYPE="P":"5.3^5.4",TYPE="R":"5.5^5.6",TYPE="CVP":"6.1^6.2",TYPE="PO2":6.3,TYPE="BP":"5.7^5.71^5.8^5.81",1:"") Q:VPRFLDS=""
"RTN","VPRDGMV",91,0)
 . F VPRI=1:1:$L(VPRFLDS,U) S VPRN=$P(VPRFLDS,U,VPRI) D RPC^GMVRPCM(.VPRY,"GETHILO",VPRN) S VPRX(VPRN)=$G(@VPRY@(0))
"RTN","VPRDGMV",92,0)
 . I TYPE="T" S VPRPARAM(TYPE)=$G(VPRX(5.1))_U_$G(VPRX(5.2))
"RTN","VPRDGMV",93,0)
 . I TYPE="P" S VPRPARAM(TYPE)=$G(VPRX(5.3))_U_$G(VPRX(5.4))
"RTN","VPRDGMV",94,0)
 . I TYPE="R" S VPRPARAM(TYPE)=$G(VPRX(5.5))_U_$G(VPRX(5.6))
"RTN","VPRDGMV",95,0)
 . I TYPE="CVP" S VPRPARAM(TYPE)=$G(VPRX(6.1))_U_$G(VPRX(6.2))
"RTN","VPRDGMV",96,0)
 . I TYPE="PO2" S VPRPARAM(TYPE)="100^"_$G(VPRX(6.3))
"RTN","VPRDGMV",97,0)
 . I TYPE="BP" S VPRPARAM(TYPE)=$G(VPRX(5.7))_"/"_$G(VPRX(5.71))_U_$G(VPRX(5.8))_"/"_$G(VPRX(5.81))
"RTN","VPRDGMV",98,0)
 S Y=$G(VPRPARAM(TYPE))
"RTN","VPRDGMV",99,0)
 Q Y
"RTN","VPRDGMV",100,0)
 ;
"RTN","VPRDGMV",101,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMV",102,0)
 ;
"RTN","VPRDGMV",103,0)
NAME(X) ; -- Return name of measurement type X for XML element
"RTN","VPRDGMV",104,0)
 N Y S X=$G(X),Y=""
"RTN","VPRDGMV",105,0)
 S Y=$S(X="BP":"bloodPressure",X="T":"temperature",X="R":"respiration",X="P":"pulse",X="HT":"height",X="WT":"weight",X="CVP":"centralVenousPressure",X="CG":"circumferenceGirth",X="PO2":"pulseOximetry",X="PN":"pain",1:"")
"RTN","VPRDGMV",106,0)
 Q Y
"RTN","VPRDGMV",107,0)
 ;
"RTN","VPRDGMV",108,0)
XML(VIT) ; -- Return vital measurement as XML in @VPR@(#)
"RTN","VPRDGMV",109,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDGMV",110,0)
 D ADD("<vital>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMV",111,0)
 S ATT="" F  S ATT=$O(VIT(ATT)) Q:ATT=""  D
"RTN","VPRDGMV",112,0)
 . I ATT="measurement" D  Q
"RTN","VPRDGMV",113,0)
 .. D ADD("<measurements>")
"RTN","VPRDGMV",114,0)
 .. S NAMES="id^vuid^name^value^units^metricValue^metricUnits^high^low^Z"
"RTN","VPRDGMV",115,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  D
"RTN","VPRDGMV",116,0)
 ... S X=$G(VIT(ATT,I)),Y="<"_ATT_" "
"RTN","VPRDGMV",117,0)
 ... F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",118,0)
 ... I '$D(VIT(ATT,I,"qualifier")) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMV",119,0)
 ... S Y=Y_">" D ADD(Y),ADD("<qualifiers>")
"RTN","VPRDGMV",120,0)
 ... S J=0 F  S J=$O(VIT(ATT,I,"qualifier",J)) Q:J<1  D
"RTN","VPRDGMV",121,0)
 .... S Y="<qualifier ",X=$G(VIT(ATT,I,"qualifier",J))
"RTN","VPRDGMV",122,0)
 .... F P=1:1 S TAG=$P("name^vuid^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",123,0)
 .... S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",124,0)
 ... D ADD("</qualifiers>"),ADD("</measurement>")
"RTN","VPRDGMV",125,0)
 .. D ADD("</measurements>")
"RTN","VPRDGMV",126,0)
 . I ATT="removed" D  Q
"RTN","VPRDGMV",127,0)
 .. D ADD("<removed>")
"RTN","VPRDGMV",128,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  S Y="<reason value='"_$G(VIT(ATT,I))_"' />" D ADD(Y)
"RTN","VPRDGMV",129,0)
 .. D ADD("</removed>")
"RTN","VPRDGMV",130,0)
 . S X=$G(VIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMV",131,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDGMV",132,0)
 . I $L(X)>1 D
"RTN","VPRDGMV",133,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMV",134,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",135,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",136,0)
 D ADD("</vital>")
"RTN","VPRDGMV",137,0)
 Q
"RTN","VPRDGMV",138,0)
 ;
"RTN","VPRDGMV",139,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMV",140,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMV",141,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMV",142,0)
 Q
"RTN","VPRDGPF")
0^6^B5569926
"RTN","VPRDGPF",1,0)
VPRDGPF ;SLC/MKB -- Patient Record Flags ;8/2/11  15:29
"RTN","VPRDGPF",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDGPF",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGPF",4,0)
 ;
"RTN","VPRDGPF",5,0)
 ; External References          DBIA#
"RTN","VPRDGPF",6,0)
 ; -------------------          -----
"RTN","VPRDGPF",7,0)
 ; DGPFAPI                       3860
"RTN","VPRDGPF",8,0)
 ; XUAF4                         2171
"RTN","VPRDGPF",9,0)
 ;
"RTN","VPRDGPF",10,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDGPF",11,0)
 ;
"RTN","VPRDGPF",12,0)
EN(DFN,BEG,END,MAX,ID) ; -- find active flags
"RTN","VPRDGPF",13,0)
 ; [BEG,END,MAX not currently used]
"RTN","VPRDGPF",14,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDGPF",15,0)
 N NUM,VPRF,VPRN,X,TEXT,VPRITM
"RTN","VPRDGPF",16,0)
 S NUM=$$GETACT^DGPFAPI(DFN,"VPRF")
"RTN","VPRDGPF",17,0)
 ;
"RTN","VPRDGPF",18,0)
 S VPRN=0 F  S VPRN=$O(VPRF(VPRN)) Q:VPRN<1  D  D:$D(VPRITM) XML(.VPRITM)
"RTN","VPRDGPF",19,0)
 . K VPRITM S X=$G(VPRF(VPRN,"FLAG"))
"RTN","VPRDGPF",20,0)
 . I $G(ID),$P(ID,"~",2)'=$P(X,U) Q
"RTN","VPRDGPF",21,0)
 . S VPRITM("id")=DFN_"~"_$P(X,U),VPRITM("name")=$P(X,U,2)
"RTN","VPRDGPF",22,0)
 . S VPRITM("approvedBy")=$G(VPRF(VPRN,"APPRVBY"))
"RTN","VPRDGPF",23,0)
 . S VPRITM("assigned")=$P($G(VPRF(VPRN,"ASSIGNDT")),U)
"RTN","VPRDGPF",24,0)
 . S VPRITM("reviewDue")=$P($G(VPRF(VPRN,"REVIEWDT")),U)
"RTN","VPRDGPF",25,0)
 . S VPRITM("type")=$P($G(VPRF(VPRN,"FLAGTYPE")),U,2)
"RTN","VPRDGPF",26,0)
 . S VPRITM("category")=$P($G(VPRF(VPRN,"CATEGORY")),U,2)
"RTN","VPRDGPF",27,0)
 . S X=$G(VPRF(VPRN,"ORIGSITE"))
"RTN","VPRDGPF",28,0)
 . S:X VPRITM("origSite")=$$STA^XUAF4(+X)_U_$P(X,U,2)
"RTN","VPRDGPF",29,0)
 . S X=$G(VPRF(VPRN,"OWNER"))
"RTN","VPRDGPF",30,0)
 . S:X VPRITM("ownSite")=$$STA^XUAF4(+X)_U_$P(X,U,2)
"RTN","VPRDGPF",31,0)
 . S X=$G(VPRF(VPRN,"TIULINK")) S:X VPRITM("document")=X
"RTN","VPRDGPF",32,0)
 . M TEXT=VPRF(VPRN,"NARR") S VPRITM("content")=$$STRING^VPRD(.TEXT)
"RTN","VPRDGPF",33,0)
 I $G(ID),'$D(VPRITM) D INACT(ID)
"RTN","VPRDGPF",34,0)
 Q
"RTN","VPRDGPF",35,0)
 ;
"RTN","VPRDGPF",36,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGPF",37,0)
 ;
"RTN","VPRDGPF",38,0)
XML(FLAG) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDGPF",39,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDGPF",40,0)
 N ATT,X,Y,I,ID
"RTN","VPRDGPF",41,0)
 D ADD("<flag>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGPF",42,0)
 S ATT="" F  S ATT=$O(FLAG(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGPF",43,0)
 . S X=$G(FLAG(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGPF",44,0)
 . I ATT="content" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDGPF",45,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGPF",46,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDGPF",47,0)
 D ADD("</flag>")
"RTN","VPRDGPF",48,0)
 Q
"RTN","VPRDGPF",49,0)
 ;
"RTN","VPRDGPF",50,0)
INACT(ID) ; -- inactivated flag
"RTN","VPRDGPF",51,0)
 D ADD("<flag id='"_ID_"' inactivated='1' />")
"RTN","VPRDGPF",52,0)
 Q
"RTN","VPRDGPF",53,0)
 ;
"RTN","VPRDGPF",54,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGPF",55,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGPF",56,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGPF",57,0)
 Q
"RTN","VPRDLR")
0^7^B24712747
"RTN","VPRDLR",1,0)
VPRDLR ;SLC/MKB -- Laboratory extract ;8/2/11  15:29
"RTN","VPRDLR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDLR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLR",4,0)
 ;
"RTN","VPRDLR",5,0)
 ; External References          DBIA#
"RTN","VPRDLR",6,0)
 ; -------------------          -----
"RTN","VPRDLR",7,0)
 ; ^DPT                         10035
"RTN","VPRDLR",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLR",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLR",10,0)
 ; ^LRO(69                       2407
"RTN","VPRDLR",11,0)
 ; ^LR                            525
"RTN","VPRDLR",12,0)
 ; DIC                           2051
"RTN","VPRDLR",13,0)
 ; DIQ                           2056
"RTN","VPRDLR",14,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLR",15,0)
 ; XUAF4                         2171
"RTN","VPRDLR",16,0)
 ;
"RTN","VPRDLR",17,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLR",18,0)
 ;
"RTN","VPRDLR",19,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLR",20,0)
 N VPRSUB,VPRIDT,VPRN,VPRITM,LRDFN,SUB
"RTN","VPRDLR",21,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLR",22,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLR",23,0)
 K ^TMP("LRRR",$J,DFN) S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB="CH"
"RTN","VPRDLR",24,0)
 ;
"RTN","VPRDLR",25,0)
 ; get result(s)
"RTN","VPRDLR",26,0)
 I $L($G(ID)) D  Q:VPRN  ;done
"RTN","VPRDLR",27,0)
 . S VPRSUB=$P(ID,";"),VPRIDT=+$P(ID,";",2),(BEG,END)=9999999-VPRIDT
"RTN","VPRDLR",28,0)
 . S VPRN=$P(ID,";",3) I VPRN D  ;skip loop - single result
"RTN","VPRDLR",29,0)
 .. D RR^LR7OR1(DFN,,BEG,END,VPRSUB)
"RTN","VPRDLR",30,0)
 .. S SUB=$S("CH^MI"[VPRSUB:VPRSUB,1:"AP")_"(.VPRITM)"
"RTN","VPRDLR",31,0)
 .. D @SUB,XML(.VPRITM)
"RTN","VPRDLR",32,0)
 .. K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLR",33,0)
 ;
"RTN","VPRDLR",34,0)
 D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLR",35,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLR",36,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  D
"RTN","VPRDLR",37,0)
 .. S VPRN=0 F  S VPRN=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRN)) Q:VPRN<1  D
"RTN","VPRDLR",38,0)
 ... K VPRITM S SUB=$S("CH^MI"[VPRSUB:VPRSUB,1:"AP")_"(.VPRITM)"
"RTN","VPRDLR",39,0)
 ... D @SUB,XML(.VPRITM)
"RTN","VPRDLR",40,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLR",41,0)
 Q
"RTN","VPRDLR",42,0)
 ;
"RTN","VPRDLR",43,0)
CH(LAB) ; -- return a Chemistry result in LAB("attribute")=value
"RTN","VPRDLR",44,0)
 ;      Expects ^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN),LRDFN
"RTN","VPRDLR",45,0)
 N CDT,LR0,LRI,X0,X,LOINC,ORD,CMMT K LAB
"RTN","VPRDLR",46,0)
 S LAB("id")="CH;"_VPRIDT_";"_VPRN,LAB("type")="CH"
"RTN","VPRDLR",47,0)
 S CDT=9999999-VPRIDT,LAB("collected")=CDT
"RTN","VPRDLR",48,0)
 S LR0=$G(^LR(LRDFN,"CH",VPRIDT,0)),LRI=$G(^(VPRN))
"RTN","VPRDLR",49,0)
 S LAB("status")="completed",LAB("resulted")=$P(LR0,U,3)
"RTN","VPRDLR",50,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLR",51,0)
 S LAB("test")=$P($G(^LAB(60,+X0,0)),U) ;$P(X0,U,10)?
"RTN","VPRDLR",52,0)
 S:$L($P(X0,U,2)) LAB("result")=$P(X0,U,2)
"RTN","VPRDLR",53,0)
 S:$L($P(X0,U,4)) LAB("units")=$P(X0,U,4)
"RTN","VPRDLR",54,0)
 S:$L($P(X0,U,3)) LAB("interpretation")=$P(X0,U,3)
"RTN","VPRDLR",55,0)
 S X=$P(X0,U,5) I $L(X),X["-" S LAB("low")=$P(X,"-"),LAB("high")=$P(X,"-",2)
"RTN","VPRDLR",56,0)
 S LAB("localName")=$S($L($P(X0,U,15)):$P(X0,U,15),1:LAB("test"))
"RTN","VPRDLR",57,0)
 S LAB("groupName")=$P(X0,U,16) ;accession#
"RTN","VPRDLR",58,0)
 S X=+$P(X0,U,19) I X D  ;specimen
"RTN","VPRDLR",59,0)
 . N IENS,VPRY S IENS=X_","
"RTN","VPRDLR",60,0)
 . D GETS^DIQ(61,IENS,".01;2",,"VPRY")
"RTN","VPRDLR",61,0)
 . S LAB("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLR",62,0)
 . S LAB("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLR",63,0)
 S ORD=+$P(X0,U,17) S:ORD LAB("labOrderID")=ORD
"RTN","VPRDLR",64,0)
 S X=$$ORDER(ORD,+X0) S:X LAB("orderID")=X
"RTN","VPRDLR",65,0)
 S X=$P($P(LRI,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLR",66,0)
 I $G(LOINC) S LAB("loinc")=LOINC,LAB("vuid")=$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLR",67,0)
 S X=$P(LR0,U,14)
"RTN","VPRDLR",68,0)
 S:X LAB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLR",69,0)
 I 'X S LAB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLR",70,0)
 I $D(^TMP("LRRR",$J,DFN,"CH",VPRIDT,"N")) M CMMT=^("N") S LAB("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLR",71,0)
 Q
"RTN","VPRDLR",72,0)
 ;
"RTN","VPRDLR",73,0)
ORDER(LABORD,TEST) ; -- return #100 order for Lab order# & Test
"RTN","VPRDLR",74,0)
 N Y,D,S,T S Y=""
"RTN","VPRDLR",75,0)
 S D=$O(^LRO(69,"C",LABORD,0)) I D D
"RTN","VPRDLR",76,0)
 . S S=0 F  S S=$O(^LRO(69,"C",LABORD,D,S)) Q:S<1  D
"RTN","VPRDLR",77,0)
 .. S T=0 F  S T=$O(^LRO(69,D,1,S,2,T)) Q:T<1  I +$G(^(T,0))=TEST S Y=+$P(^(0),U,7)
"RTN","VPRDLR",78,0)
 Q Y
"RTN","VPRDLR",79,0)
 ;
"RTN","VPRDLR",80,0)
MI(LAB) ; -- return a Microbiology result in LAB("attribute")=value
"RTN","VPRDLR",81,0)
 ;    Expects ^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN),LRDFN
"RTN","VPRDLR",82,0)
 N ID,CDT,X0,X,CMMT,LR0 K LAB
"RTN","VPRDLR",83,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)) Q:$L($P(X0,U))'>1
"RTN","VPRDLR",84,0)
 S LAB("id")="MI;"_VPRIDT_"#"_VPRN,LAB("status")="completed"
"RTN","VPRDLR",85,0)
 S LAB("type")="MI",CDT=9999999-VPRIDT,LAB("collected")=CDT
"RTN","VPRDLR",86,0)
 S LR0=$G(^LR(LRDFN,"MI",VPRIDT,0)),LAB("resulted")=$P(LR0,U,3)
"RTN","VPRDLR",87,0)
 S:$L($P(X0,U,2)) LAB("result")=$P(X0,U,2)
"RTN","VPRDLR",88,0)
 S:$L($P(X0,U,4)) LAB("units")=$P(X0,U,4)
"RTN","VPRDLR",89,0)
 S:$L($P(X0,U,3)) LAB("interpretation")=$P(X0,U,3)
"RTN","VPRDLR",90,0)
 S (LAB("test"),LAB("localName"))=$P(X0,U,15)
"RTN","VPRDLR",91,0)
 S X=+$P(X0,U,19) I X D  ;specimen
"RTN","VPRDLR",92,0)
 . N IENS,VPRY S IENS=X_","
"RTN","VPRDLR",93,0)
 . D GETS^DIQ(61,IENS,".01;2",,"VPRY")
"RTN","VPRDLR",94,0)
 . S LAB("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLR",95,0)
 . S LAB("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLR",96,0)
 S X=$P(LR0,U,14)
"RTN","VPRDLR",97,0)
 S:X LAB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLR",98,0)
 I 'X S LAB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLR",99,0)
 I $D(^TMP("LRRR",$J,DFN,"MI",VPRIDT,"N")) M CMMT=^("N") S LAB("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLR",100,0)
 Q
"RTN","VPRDLR",101,0)
 ;
"RTN","VPRDLR",102,0)
AP(LAB) ; -- return a Pathology result in LAB("attribute")=value
"RTN","VPRDLR",103,0)
 K LAB  ;implemented in VPRDLRA
"RTN","VPRDLR",104,0)
 Q
"RTN","VPRDLR",105,0)
 ;
"RTN","VPRDLR",106,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLR",107,0)
 ;
"RTN","VPRDLR",108,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLR",109,0)
 N ATT,X,Y,P,NAMES,TAG
"RTN","VPRDLR",110,0)
 D ADD("<lab>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLR",111,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLR",112,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLR",113,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLR",114,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLR",115,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDLR",116,0)
 .. S Y="<"_ATT_" ",NAMES="code^name^Z"
"RTN","VPRDLR",117,0)
 .. F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLR",118,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDLR",119,0)
 D ADD("</lab>")
"RTN","VPRDLR",120,0)
 Q
"RTN","VPRDLR",121,0)
 ;
"RTN","VPRDLR",122,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLR",123,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLR",124,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLR",125,0)
 Q
"RTN","VPRDLRA")
0^8^B69605973
"RTN","VPRDLRA",1,0)
VPRDLRA ;SLC/MKB -- Laboratory extract by accession ;8/2/11  15:29
"RTN","VPRDLRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDLRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRA",4,0)
 ;
"RTN","VPRDLRA",5,0)
 ; External References          DBIA#
"RTN","VPRDLRA",6,0)
 ; -------------------          -----
"RTN","VPRDLRA",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRA",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRA",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLRA",10,0)
 ; ^LRO(68                       1963
"RTN","VPRDLRA",11,0)
 ; ^LRO(69                       2407
"RTN","VPRDLRA",12,0)
 ; ^LR                            525
"RTN","VPRDLRA",13,0)
 ; ^SC                          10040
"RTN","VPRDLRA",14,0)
 ; ^VA(200                      10060
"RTN","VPRDLRA",15,0)
 ; DIC                           2051
"RTN","VPRDLRA",16,0)
 ; DIQ                           2056
"RTN","VPRDLRA",17,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRA",18,0)
 ; LR7OSUM,^TMP("LRC",$J)        2766
"RTN","VPRDLRA",19,0)
 ; PXAPI                         1894
"RTN","VPRDLRA",20,0)
 ; XUAF4                         2171
"RTN","VPRDLRA",21,0)
 ;
"RTN","VPRDLRA",22,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLRA",23,0)
 ;
"RTN","VPRDLRA",24,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLRA",25,0)
 N VPRSUB,VPRIDT,VPRN,VPRITM,LRDFN,LR0,ORD,X
"RTN","VPRDLRA",26,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",28,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB=""
"RTN","VPRDLRA",29,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRA",30,0)
 ;
"RTN","VPRDLRA",31,0)
 ; get result(s)
"RTN","VPRDLRA",32,0)
 I $L($G(ID)) D  ;reset search parameters
"RTN","VPRDLRA",33,0)
 . S VPRSUB=$P(ID,";"),VPRIDT=+$P(ID,";",2)
"RTN","VPRDLRA",34,0)
 . S:VPRIDT (BEG,END)=9999999-VPRIDT
"RTN","VPRDLRA",35,0)
 ;
"RTN","VPRDLRA",36,0)
 D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLRA",37,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",38,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",39,0)
 .. K VPRITM,CMMT I "CH^MI"'[VPRSUB D AP(.VPRITM),XML(.VPRITM) Q
"RTN","VPRDLRA",40,0)
 .. S VPRITM("type")=VPRSUB,VPRITM("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",41,0)
 .. S VPRITM("collected")=9999999-VPRIDT,VPRITM("status")="completed"
"RTN","VPRDLRA",42,0)
 .. S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRA",43,0)
 .. S VPRITM("resulted")=$P(LR0,U,3),X=+$P(LR0,U,5) I X D
"RTN","VPRDLRA",44,0)
 ... N IENS,VPRY S IENS=X_","
"RTN","VPRDLRA",45,0)
 ... D GETS^DIQ(61,IENS,".01;2;4.1",,"VPRY")
"RTN","VPRDLRA",46,0)
 ... S VPRITM("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRA",47,0)
 ... S VPRITM("sample")=$G(VPRY(61,IENS,4.1)) ;name
"RTN","VPRDLRA",48,0)
 .. S X=$P(LR0,U,6),VPRITM("name")=$$AREA(X),VPRITM("groupName")=X
"RTN","VPRDLRA",49,0)
 .. S X=+$P(LR0,U,14) S:X VPRITM("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRA",50,0)
 .. I 'X S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRA",51,0)
 .. I VPRSUB="MI" D  ;report
"RTN","VPRDLRA",52,0)
 ... S VPRITM("document",1)=VPRSUB_";"_VPRIDT_"^LR MICROBIOLOGY REPORT^LABORATORY NOTE"
"RTN","VPRDLRA",53,0)
 ... S:$G(VPRTEXT) VPRITM("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",54,0)
 .. S VPRN=0 F  S VPRN=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRN)) Q:VPRN<1  D
"RTN","VPRDLRA",55,0)
 ... S X=$S(VPRSUB="MI":$$MI,1:$$CH)
"RTN","VPRDLRA",56,0)
 ... S:$L(X) VPRITM("value",VPRN)=X
"RTN","VPRDLRA",57,0)
 ... S:$G(ORD) VPRITM("labOrderID")=ORD
"RTN","VPRDLRA",58,0)
 .. I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) M CMMT=^("N") S VPRITM("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRA",59,0)
 .. D XML(.VPRITM)
"RTN","VPRDLRA",60,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRA",61,0)
 Q
"RTN","VPRDLRA",62,0)
 ;
"RTN","VPRDLRA",63,0)
CH() ; -- return a Chemistry result as:
"RTN","VPRDLRA",64,0)
 ;   id^test^result^interpretation^units^low^high^loinc^vuid^order
"RTN","VPRDLRA",65,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN),LRDFN
"RTN","VPRDLRA",66,0)
 N X,Y,X0,NODE,CMMT,LOINC
"RTN","VPRDLRA",67,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN)),NODE=$G(^LR(LRDFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLRA",68,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRA",69,0)
 S Y="CH;"_VPRIDT_";"_VPRN_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRA",70,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRA",71,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRA",72,0)
 S:$G(LOINC) $P(Y,U,8,9)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRA",73,0)
 S ORD=+$P(X0,U,17),X=$$ORDER(ORD,+X0) S:X $P(Y,U,10)=X
"RTN","VPRDLRA",74,0)
 Q Y
"RTN","VPRDLRA",75,0)
 ;
"RTN","VPRDLRA",76,0)
MI() ; -- return a Microbiology result as:
"RTN","VPRDLRA",77,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRA",78,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)
"RTN","VPRDLRA",79,0)
 N Y,X0
"RTN","VPRDLRA",80,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)),Y=""
"RTN","VPRDLRA",81,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRN_U_$P(X0,U,1,4)
"RTN","VPRDLRA",82,0)
 Q Y
"RTN","VPRDLRA",83,0)
 ;
"RTN","VPRDLRA",84,0)
AP(LAB) ; -- return a Pathology result in LAB("attribute")=value
"RTN","VPRDLRA",85,0)
 N LR0,X,I,NODE
"RTN","VPRDLRA",86,0)
 S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRA",87,0)
 S LAB("type")=VPRSUB,LAB("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",88,0)
 S LAB("collected")=9999999-VPRIDT,LAB("status")="completed"
"RTN","VPRDLRA",89,0)
 S LAB("resulted")=$P(LR0,U,11),LAB("groupName")=$P(LR0,U,6)
"RTN","VPRDLRA",90,0)
 S X="",I=0 F  S I=$O(^LR(LRDFN,VPRSUB,VPRIDT,.1,I)) Q:I<1  S X=X_$S($L(X):", ",1:"")_$P($G(^(I,0)),U)
"RTN","VPRDLRA",91,0)
 S:$L(X) LAB("specimen")=U_X
"RTN","VPRDLRA",92,0)
 S LAB("facility")=$$FAC^VPRD
"RTN","VPRDLRA",93,0)
 S NODE=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",94,0)
 S I=0 F  S I=$O(@NODE@(I)) Q:I<1  S X=+$P($G(@NODE@(I,0)),U,2) I X D
"RTN","VPRDLRA",95,0)
 . N LT,NT
"RTN","VPRDLRA",96,0)
 . S LT=$$GET1^DIQ(8925,+X_",",.01) Q:$P(LT," ")="Addendum"
"RTN","VPRDLRA",97,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501") S:NT="" NT="LABORATORY NOTE"
"RTN","VPRDLRA",98,0)
 . S LAB("document",I)=+X_U_LT_U_NT
"RTN","VPRDLRA",99,0)
 . S:$G(VPRTEXT) LAB("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDLRA",100,0)
 I '$O(LAB("document",0)) D  ;non-TIU reports
"RTN","VPRDLRA",101,0)
 . S LAB("document",1)=VPRSUB_";"_VPRIDT_"^LR "_$$NAME(VPRSUB)_" REPORT^LABORATORY NOTE"
"RTN","VPRDLRA",102,0)
 . S:$G(VPRTEXT) LAB("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",103,0)
 Q
"RTN","VPRDLRA",104,0)
 ;
"RTN","VPRDLRA",105,0)
ORDER(LABORD,TEST) ; -- return #100 order for Lab order# & Test
"RTN","VPRDLRA",106,0)
 N Y,D,S,T S Y=""
"RTN","VPRDLRA",107,0)
 S D=$O(^LRO(69,"C",LABORD,0)) I D D
"RTN","VPRDLRA",108,0)
 . S S=0 F  S S=$O(^LRO(69,"C",LABORD,D,S)) Q:S<1  D
"RTN","VPRDLRA",109,0)
 .. S T=0 F  S T=$O(^LRO(69,D,1,S,2,T)) Q:T<1  I +$G(^(T,0))=TEST S Y=+$P(^(0),U,7)
"RTN","VPRDLRA",110,0)
 Q Y
"RTN","VPRDLRA",111,0)
 ;
"RTN","VPRDLRA",112,0)
NAME(X) ; -- Return name of subscript X
"RTN","VPRDLRA",113,0)
 I X="AU" Q "AUTOPSY"
"RTN","VPRDLRA",114,0)
 I X="BB" Q "BLOOD BANK"
"RTN","VPRDLRA",115,0)
 I X="CH" Q "CHEM,HEM,TOX,RIA,SER,etc."
"RTN","VPRDLRA",116,0)
 I X="CY" Q "CYTOPATHOLOGY"
"RTN","VPRDLRA",117,0)
 I X="EM" Q "ELECTRON MICROSCOPY"
"RTN","VPRDLRA",118,0)
 I X="MI" Q "MICROBIOLOGY"
"RTN","VPRDLRA",119,0)
 I X="SP" Q "SURGICAL PATHOLOGY"
"RTN","VPRDLRA",120,0)
 Q "ANATOMIC PATHOLOGY"
"RTN","VPRDLRA",121,0)
 ;
"RTN","VPRDLRA",122,0)
AREA(ACCNUM) ; -- Return name of accession area
"RTN","VPRDLRA",123,0)
 N X,Y,VPRA
"RTN","VPRDLRA",124,0)
 S X=$P($G(ACCNUM)," "),Y=""
"RTN","VPRDLRA",125,0)
 I $L(X) D FIND^DIC(68,,.01,"QX",X,,,,,"VPRA")
"RTN","VPRDLRA",126,0)
 S Y=$G(VPRA("DILIST",1,1))
"RTN","VPRDLRA",127,0)
 Q Y
"RTN","VPRDLRA",128,0)
 ;
"RTN","VPRDLRA",129,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDLRA",130,0)
 ;
"RTN","VPRDLRA",131,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's lab reports
"RTN","VPRDLRA",132,0)
 N VPRSUB,VPRIDT,VPRITM,VPRTIU,VPRXID,LRDFN,VPRN,DA
"RTN","VPRDLRA",133,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",134,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",135,0)
 S LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",136,0)
 K ^TMP("LRRR",$J,DFN) D RR^LR7OR1(DFN,,BEG,END,"AP",,,MAX)
"RTN","VPRDLRA",137,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",138,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",139,0)
 .. S VPRTIU=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",140,0)
 .. K VPRITM S VPRXID=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",141,0)
 .. I '$O(@VPRTIU@(0)) D RPT1(DFN,VPRXID,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM) Q
"RTN","VPRDLRA",142,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRTIU@(VPRN)) Q:VPRN<1  D
"RTN","VPRDLRA",143,0)
 ... S DA=+$P($G(@VPRTIU@(VPRN,0)),U,2) Q:DA<1  K VPRITM
"RTN","VPRDLRA",144,0)
 ... D EN1^VPRDTIU(DA,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDLRA",145,0)
 Q
"RTN","VPRDLRA",146,0)
 ;
"RTN","VPRDLRA",147,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDLRA",148,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:'$L(ID)
"RTN","VPRDLRA",149,0)
 N SUB,IDT,LRDFN,LR0,X,LOC
"RTN","VPRDLRA",150,0)
 S SUB=$P(ID,";"),IDT=+$P(ID,";",2),LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",151,0)
 S LR0=$S(SUB="AU":$G(^LR(LRDFN,"AU")),1:$G(^LR(LRDFN,SUB,IDT,0)))
"RTN","VPRDLRA",152,0)
 S RPT("id")=ID,RPT("referenceDateTime")=9999999-IDT
"RTN","VPRDLRA",153,0)
 S RPT("localTitle")="LR "_$$NAME(SUB)_" REPORT"
"RTN","VPRDLRA",154,0)
 S RPT("documentClass")="LR LABORATORY REPORTS"
"RTN","VPRDLRA",155,0)
 S RPT("nationalTitle")="4697105^LABORATORY NOTE"
"RTN","VPRDLRA",156,0)
 S RPT("nationalTitleSubject")="4697104^LABORATORY"
"RTN","VPRDLRA",157,0)
 S RPT("nationalTitleType")="4696120^NOTE"
"RTN","VPRDLRA",158,0)
 S RPT("type")="LR",RPT("status")="COMPLETED"
"RTN","VPRDLRA",159,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDLRA",160,0)
 S X=$P(LR0,U,$S(SUB="AU":5,1:8)),LOC="" S:$L(X) LOC=+$O(^SC("B",X,0))
"RTN","VPRDLRA",161,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDLRA",162,0)
 I LOC D  ;look-up visit
"RTN","VPRDLRA",163,0)
 . N CDT S CDT=9999999-IDT
"RTN","VPRDLRA",164,0)
 . S X=$$GETENC^PXAPI(DFN,CDT,LOC)
"RTN","VPRDLRA",165,0)
 . S:X RPT("encounter")=+X
"RTN","VPRDLRA",166,0)
 S X=+$P(LR0,U,$S(SUB="AU":10,1:2)) ;pathologist
"RTN","VPRDLRA",167,0)
 S:X RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A"
"RTN","VPRDLRA",168,0)
 S X=$S(SUB="AU":$P(LR0,U,15,16),1:$P(LR0,U,11)_U_$P(LR0,U,13)) I X D
"RTN","VPRDLRA",169,0)
 . N Y S Y=$P(X,U,2)
"RTN","VPRDLRA",170,0)
 . S RPT("clinician",2)=Y_U_$P($G(^VA(200,+Y,0)),U)_"^S^"_+X_U_$P($G(^VA(200,+Y,20)),U,2)
"RTN","VPRDLRA",171,0)
 S:$G(VPRTEXT) RPT("content")=$$TEXT(DFN,SUB,IDT)
"RTN","VPRDLRA",172,0)
 Q
"RTN","VPRDLRA",173,0)
 ;
"RTN","VPRDLRA",174,0)
TEXT(DFN,SUB,IDT) ; -- return report text as a string
"RTN","VPRDLRA",175,0)
 N LRDFN,DATE,NAME,VPRS,VPRY,I,X,Y
"RTN","VPRDLRA",176,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",177,0)
 S DATE=9999999-+$G(IDT),NAME=$$NAME(SUB),VPRS(NAME)=""
"RTN","VPRDLRA",178,0)
 D EN^LR7OSUM(.VPRY,DFN,DATE,DATE,,,.VPRS)
"RTN","VPRDLRA",179,0)
 S I=+$G(^TMP("LRH",$J,NAME))+1,Y=$G(^TMP("LRC",$J,I,0)) ;LRH=header: Y=1st line
"RTN","VPRDLRA",180,0)
 F  S I=$O(^TMP("LRC",$J,I)) Q:I<1  S X=$G(^(I,0)) Q:X?1."="  S Y=Y_$C(13,10)_X
"RTN","VPRDLRA",181,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",182,0)
 Q Y
"RTN","VPRDLRA",183,0)
 ;
"RTN","VPRDLRA",184,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRA",185,0)
 ;
"RTN","VPRDLRA",186,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRA",187,0)
 N ATT,X,Y,NAMES
"RTN","VPRDLRA",188,0)
 D ADD("<accession>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRA",189,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRA",190,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRA",191,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRA",192,0)
 .. S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",ATT="value":"id^test^result^interpretation^units^low^high^loinc^vuid^order^Z",1:"code^name^Z")
"RTN","VPRDLRA",193,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRA",194,0)
 ... S X=$G(LAB(ATT,I))
"RTN","VPRDLRA",195,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRA",196,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRA",197,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRA",198,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRA",199,0)
 . I ATT="content" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRA",200,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRA",201,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDLRA",202,0)
 .. S NAMES="code^name^Z"
"RTN","VPRDLRA",203,0)
 .. S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRA",204,0)
 D ADD("</accession>")
"RTN","VPRDLRA",205,0)
 Q
"RTN","VPRDLRA",206,0)
 ;
"RTN","VPRDLRA",207,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRA",208,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRA",209,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRA",210,0)
 Q STR
"RTN","VPRDLRA",211,0)
 ;
"RTN","VPRDLRA",212,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRA",213,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRA",214,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRA",215,0)
 Q
"RTN","VPRDLRO")
0^9^B27350157
"RTN","VPRDLRO",1,0)
VPRDLRO ;SLC/MKB -- Laboratory extract by order/panel ;8/2/11  15:29
"RTN","VPRDLRO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDLRO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRO",4,0)
 ;
"RTN","VPRDLRO",5,0)
 ; External References          DBIA#
"RTN","VPRDLRO",6,0)
 ; -------------------          -----
"RTN","VPRDLRO",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRO",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRO",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLRO",10,0)
 ; ^LRO(69                       2407
"RTN","VPRDLRO",11,0)
 ; ^LR                            525
"RTN","VPRDLRO",12,0)
 ; DIQ                           2056
"RTN","VPRDLRO",13,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRO",14,0)
 ; LR7OU1                        2955
"RTN","VPRDLRO",15,0)
 ; ORX8                          3071
"RTN","VPRDLRO",16,0)
 ; XUAF4                         2171
"RTN","VPRDLRO",17,0)
 ;
"RTN","VPRDLRO",18,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLRO",19,0)
 ;
"RTN","VPRDLRO",20,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLRO",21,0)
 N VPRSUB,VPRIDT,VPRN,VPRLRO,VPRT,VPRITM,CMMT,LRDFN,LR0,X
"RTN","VPRDLRO",22,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRO",23,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRO",24,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB="CH"
"RTN","VPRDLRO",25,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRO",26,0)
 ;
"RTN","VPRDLRO",27,0)
 ; get result(s)
"RTN","VPRDLRO",28,0)
 I $G(ID)  D RR^LR7OR1(DFN,ID)
"RTN","VPRDLRO",29,0)
 I '$G(ID) D  ;no id, or accession format (no lab order)
"RTN","VPRDLRO",30,0)
 . S:$G(ID)'="" VPRSUB=$P(ID,";"),(BEG,END)=9999999-$P(ID,";",2)
"RTN","VPRDLRO",31,0)
 . D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLRO",32,0)
 ;
"RTN","VPRDLRO",33,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRO",34,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRO",35,0)
 .. I "CH^MI"'[VPRSUB Q
"RTN","VPRDLRO",36,0)
 .. D SORT ;group accession by lab orders > VPRLRO(panel,VPRN)=data node
"RTN","VPRDLRO",37,0)
 .. S VPRT="" F  S VPRT=$O(VPRLRO(VPRT)) Q:VPRT=""  D
"RTN","VPRDLRO",38,0)
 ... K VPRITM,CMMT S X=$G(VPRLRO(VPRT))
"RTN","VPRDLRO",39,0)
 ... I $G(ID),$P(ID,";",1,3)'=$P($P(X,U,3),";",1,3) Q  ;single order/specimen
"RTN","VPRDLRO",40,0)
 ... S VPRITM("id")=$P(X,U,3),VPRITM("order")=$P(X,U,1,2)
"RTN","VPRDLRO",41,0)
 ... S VPRITM("type")=VPRSUB,VPRITM("status")="completed"
"RTN","VPRDLRO",42,0)
 ... S VPRITM("collected")=9999999-VPRIDT
"RTN","VPRDLRO",43,0)
 ... S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRO",44,0)
 ... S VPRITM("resulted")=$P(LR0,U,3),X=+$P(LR0,U,5) I X D  ;specimen
"RTN","VPRDLRO",45,0)
 .... N IENS,VPRY S IENS=X_","
"RTN","VPRDLRO",46,0)
 .... D GETS^DIQ(61,IENS,".01:2",,"VPRY")
"RTN","VPRDLRO",47,0)
 .... S VPRITM("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRO",48,0)
 .... S VPRITM("sample")=$$GET1^DIQ(61,X_",",4.1) ;name
"RTN","VPRDLRO",49,0)
 ... S VPRITM("groupName")=$P(LR0,U,6),X=+$P(LR0,U,14)
"RTN","VPRDLRO",50,0)
 ... S:X VPRITM("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRO",51,0)
 ... I 'X S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRO",52,0)
 ... S VPRN=0 F  S VPRN=$O(VPRLRO(VPRT,VPRN)) Q:VPRN<1  D
"RTN","VPRDLRO",53,0)
 .... S X=$G(VPRLRO(VPRT,VPRN))
"RTN","VPRDLRO",54,0)
 .... S:VPRSUB="CH" VPRITM("value",VPRN)=$$CH(X)
"RTN","VPRDLRO",55,0)
 .... S:VPRSUB="MI" VPRITM("value",VPRN)=$$MI(X)
"RTN","VPRDLRO",56,0)
 ... I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) M CMMT=^("N") S VPRITM("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRO",57,0)
 ... D XML(.VPRITM)
"RTN","VPRDLRO",58,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRO",59,0)
 Q
"RTN","VPRDLRO",60,0)
 ;
"RTN","VPRDLRO",61,0)
SORT ; -- return VPRLRO(PANEL) = CPRS order# ^ panel/test name ^ Lab Order string
"RTN","VPRDLRO",62,0)
 ;               VPRLRO(PANEL,VPRN) = result node
"RTN","VPRDLRO",63,0)
 N X0,NUM,ORD,ODT,SN,T,T0,ORIFN,I,VPRY,VPRLRT K VPRLRO
"RTN","VPRDLRO",64,0)
 S VPRN=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,0)),X0=$G(^(VPRN)) ;first
"RTN","VPRDLRO",65,0)
 S NUM=$P(X0,U,16),ORD=$P(X0,U,17),ODT=+$P(9999999-VPRIDT,".")
"RTN","VPRDLRO",66,0)
 ; - build VPRLRT list of result nodes for each test/panel
"RTN","VPRDLRO",67,0)
 I ORD S SN=0 F  S SN=$O(^LRO(69,"C",ORD,ODT,SN)) Q:SN<1  D  Q:$D(VPRLRT)
"RTN","VPRDLRO",68,0)
 . I $G(ID),$P(ID,";",3)'=SN Q
"RTN","VPRDLRO",69,0)
 . S T=0 F  S T=+$O(^LRO(69,ODT,1,SN,2,T)) Q:T<1  D
"RTN","VPRDLRO",70,0)
 .. I $G(ID),$P(ID,";",4),T'=$P(ID,";",4) Q
"RTN","VPRDLRO",71,0)
 .. S T0=$G(^LRO(69,ODT,1,SN,2,T,0))
"RTN","VPRDLRO",72,0)
 .. ; is test/panel part of same accession?
"RTN","VPRDLRO",73,0)
 .. S ORIFN=+$P(T0,U,7)
"RTN","VPRDLRO",74,0)
 .. Q:VPRIDT'=$P($$PKGID^ORX8(ORIFN),";",5)
"RTN","VPRDLRO",75,0)
 .. ; expand panel into unit tests
"RTN","VPRDLRO",76,0)
 .. K VPRY D EXPAND^LR7OU1(+T0,.VPRY)
"RTN","VPRDLRO",77,0)
 .. S I=0 F  S I=$O(VPRY(I)) Q:I<1  S VPRLRT(I,+T0)="" ;VPRLRT(test,panel)=""
"RTN","VPRDLRO",78,0)
 .. S VPRLRO(+T0)=$P(T0,U,7)_U_$P($G(^LAB(60,+T0,0)),U)_U_ORD_";"_ODT_";"_SN_";"_T
"RTN","VPRDLRO",79,0)
 S:'$D(VPRLRO) VPRLRO(0)=$S(VPRSUB="MI":"^MICROBIOLOGY^MI;",1:"^ACCESSION^CH;")_VPRIDT ;no Lab Order
"RTN","VPRDLRO",80,0)
 ; - build VPRLRO(panel#,VPRN) = ^TMP node
"RTN","VPRDLRO",81,0)
 S VPRN=0 F  S VPRN=$O(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN)) Q:VPRN<1  S X0=$G(^(VPRN)) D
"RTN","VPRDLRO",82,0)
 . I '$D(VPRLRT(+X0)) S VPRLRO(0,VPRN)=X0 Q  ;no Lab Order
"RTN","VPRDLRO",83,0)
 . S T=0 F  S T=$O(VPRLRT(+X0,T)) Q:T<1  S VPRLRO(T,VPRN)=X0
"RTN","VPRDLRO",84,0)
 Q
"RTN","VPRDLRO",85,0)
 ;
"RTN","VPRDLRO",86,0)
CH(X0) ; -- return a Chemistry result as:
"RTN","VPRDLRO",87,0)
 ;   id^test^result^interpretation^units^low^high^loinc^vuid
"RTN","VPRDLRO",88,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN),LRDFN
"RTN","VPRDLRO",89,0)
 N X,Y,NODE,LOINC
"RTN","VPRDLRO",90,0)
 S NODE=$G(^LR(LRDFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLRO",91,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRO",92,0)
 S Y="CH;"_VPRIDT_";"_VPRN_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRO",93,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRO",94,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRO",95,0)
 S:$G(LOINC) $P(Y,U,8,9)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRO",96,0)
 Q Y
"RTN","VPRDLRO",97,0)
 ;
"RTN","VPRDLRO",98,0)
MI(X0) ; -- return a Microbiology result as:
"RTN","VPRDLRO",99,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRO",100,0)
 ;   Expects X0=^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)
"RTN","VPRDLRO",101,0)
 N Y S Y=""
"RTN","VPRDLRO",102,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRN_U_$P(X0,U,1,4)
"RTN","VPRDLRO",103,0)
 Q Y
"RTN","VPRDLRO",104,0)
 ;
"RTN","VPRDLRO",105,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRO",106,0)
 ;
"RTN","VPRDLRO",107,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRO",108,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDLRO",109,0)
 D ADD("<panel>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRO",110,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRO",111,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRO",112,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRO",113,0)
 .. I ATT="value" S NAMES="id^test^result^interpretation^units^low^high^loinc^vuid^Z"
"RTN","VPRDLRO",114,0)
 .. E  S NAMES="code^name^Z"
"RTN","VPRDLRO",115,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRO",116,0)
 ... S X=$G(LAB(ATT,I)),Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRO",117,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRO",118,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRO",119,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRO",120,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRO",121,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDLRO",122,0)
 D ADD("</panel>")
"RTN","VPRDLRO",123,0)
 Q
"RTN","VPRDLRO",124,0)
 ;
"RTN","VPRDLRO",125,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRO",126,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRO",127,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRO",128,0)
 Q STR
"RTN","VPRDLRO",129,0)
 ;
"RTN","VPRDLRO",130,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRO",131,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRO",132,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRO",133,0)
 Q
"RTN","VPRDOR")
0^23^B9187731
"RTN","VPRDOR",1,0)
VPRDOR ;SLC/MKB -- Orders extract ;8/2/11  15:29
"RTN","VPRDOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDOR",4,0)
 ;
"RTN","VPRDOR",5,0)
 ; External References          DBIA#
"RTN","VPRDOR",6,0)
 ; -------------------          -----
"RTN","VPRDOR",7,0)
 ; ^SC                          10040
"RTN","VPRDOR",8,0)
 ; ^VA(200)                     10060
"RTN","VPRDOR",9,0)
 ; DIQ                           2056
"RTN","VPRDOR",10,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDOR",11,0)
 ; ORQ12                         5704
"RTN","VPRDOR",12,0)
 ; ORX8                          2467
"RTN","VPRDOR",13,0)
 ; XUAF4                         2171
"RTN","VPRDOR",14,0)
 ;
"RTN","VPRDOR",15,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDOR",16,0)
 ;
"RTN","VPRDOR",17,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's orders
"RTN","VPRDOR",18,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDOR",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDOR",20,0)
 N ORLIST,VPRN,VPRITM,VPRCNT
"RTN","VPRDOR",21,0)
 ;
"RTN","VPRDOR",22,0)
 ; get one order
"RTN","VPRDOR",23,0)
 I $G(IFN) D  Q
"RTN","VPRDOR",24,0)
 . N ORLST S ORLST=0,ORLIST=$H
"RTN","VPRDOR",25,0)
 . D GET^ORQ12(IFN,ORLIST,1) S VPRN=1
"RTN","VPRDOR",26,0)
 . D EN1(VPRN,.VPRITM),XML(.VPRITM)
"RTN","VPRDOR",27,0)
 . K ^TMP("ORGOTIT",$J)
"RTN","VPRDOR",28,0)
 ;
"RTN","VPRDOR",29,0)
 ; get all orders
"RTN","VPRDOR",30,0)
 D EN^ORQ1(DFN_";DPT(",,6,,BEG,END,1) S VPRCNT=0
"RTN","VPRDOR",31,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDOR",32,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDOR",33,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDOR",34,0)
 K ^TMP("ORR",$J)
"RTN","VPRDOR",35,0)
 Q
"RTN","VPRDOR",36,0)
 ;
"RTN","VPRDOR",37,0)
EN1(NUM,ORD) ; -- return an order in ORD("attribute")=value
"RTN","VPRDOR",38,0)
 ;  from EN: expects ^TMP("ORR",$J,ORLIST,VPRN)
"RTN","VPRDOR",39,0)
 N X0,IFN,LOC,VPRT K ORD
"RTN","VPRDOR",40,0)
 S X0=$G(^TMP("ORR",$J,ORLIST,NUM)),IFN=+X0
"RTN","VPRDOR",41,0)
 S ORD("id")=IFN,ORD("name")=$$OI^ORX8(+X0)
"RTN","VPRDOR",42,0)
 S ORD("group")=$P(X0,U,2),ORD("entered")=$P(X0,U,3)
"RTN","VPRDOR",43,0)
 S ORD("start")=$P(X0,U,4),ORD("stop")=$P(X0,U,5)
"RTN","VPRDOR",44,0)
 S ORD("status")=$P(X0,U,7)_U_$P(X0,U,6)_U_$$STS($P(X0,U,7))
"RTN","VPRDOR",45,0)
 M VPRT=^TMP("ORR",$J,ORLIST,VPRN,"TX") S ORD("content")=$$STRING^VPRD(.VPRT)
"RTN","VPRDOR",46,0)
 S X=$$GET1^DIQ(100,IFN_",",1,"I"),ORD("provider")=X_U_$P($G(^VA(200,+X,0)),U)
"RTN","VPRDOR",47,0)
 S X=$$GET1^DIQ(100,IFN_",",6),LOC="" I $L(X) D
"RTN","VPRDOR",48,0)
 . S LOC=+$O(^SC("B",X,0)),ORD("location")=LOC_U_X
"RTN","VPRDOR",49,0)
 S ORD("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDOR",50,0)
 Q
"RTN","VPRDOR",51,0)
 ;
"RTN","VPRDOR",52,0)
STS(X) ; -- return VUID for status abbreviation X
"RTN","VPRDOR",53,0)
 N Y,I,STS
"RTN","VPRDOR",54,0)
 S STS="dc^comp^hold^flag^pend^actv^exp^schd^part^dlay^unr^dc/e^canc^laps^rnew^none"
"RTN","VPRDOR",55,0)
 F I=1:1:16 Q:$P(STS,U,I)=X
"RTN","VPRDOR",56,0)
 S Y=$$VUID^VPRD(I,100.01)
"RTN","VPRDOR",57,0)
 Q Y
"RTN","VPRDOR",58,0)
 ;
"RTN","VPRDOR",59,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDOR",60,0)
 ;
"RTN","VPRDOR",61,0)
XML(ORD) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDOR",62,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDOR",63,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDOR",64,0)
 D ADD("<order>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDOR",65,0)
 S ATT="" F  S ATT=$O(ORD(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDOR",66,0)
 . S X=$G(ORD(ATT)),Y="" Q:'$L(X)
"RTN","VPRDOR",67,0)
 . S NAMES="code^name^vuid^Z"
"RTN","VPRDOR",68,0)
 . I ATT="content" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDOR",69,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDOR",70,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDOR",71,0)
 D ADD("</order>")
"RTN","VPRDOR",72,0)
 Q
"RTN","VPRDOR",73,0)
 ;
"RTN","VPRDOR",74,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDOR",75,0)
 N STR,P,TAG S STR=""
"RTN","VPRDOR",76,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDOR",77,0)
 Q STR
"RTN","VPRDOR",78,0)
 ;
"RTN","VPRDOR",79,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDOR",80,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDOR",81,0)
 S @VPR@(VPRI)=X
"RTN","VPRDOR",82,0)
 Q
"RTN","VPRDPROC")
0^10^B8662758
"RTN","VPRDPROC",1,0)
VPRDPROC ;SLC/MKB -- Procedure extract ;8/2/11  15:29
"RTN","VPRDPROC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPROC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPROC",4,0)
 ;
"RTN","VPRDPROC",5,0)
 ; External References          DBIA#
"RTN","VPRDPROC",6,0)
 ; -------------------          -----
"RTN","VPRDPROC",7,0)
 ; RAO7PC1                       2043
"RTN","VPRDPROC",8,0)
 ; SROESTV                       3533
"RTN","VPRDPROC",9,0)
 ;
"RTN","VPRDPROC",10,0)
 ; ------------ Get procedure(s) from VistA ------------
"RTN","VPRDPROC",11,0)
 ;
"RTN","VPRDPROC",12,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's procedures
"RTN","VPRDPROC",13,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPROC",14,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPROC",15,0)
 ;
"RTN","VPRDPROC",16,0)
 N VPRN,VPRCNT,VPRITM,VPRY
"RTN","VPRDPROC",17,0)
 ;
"RTN","VPRDPROC",18,0)
 ; get one procedure
"RTN","VPRDPROC",19,0)
 I $G(ID) D  D:$D(VPRITM) XML(.VPRITM) Q
"RTN","VPRDPROC",20,0)
 . I ID'["-" D EN1^VPRDSR(ID,.VPRITM) Q
"RTN","VPRDPROC",21,0)
 . S (BEG,END)=9999999.9999=+ID D EN1^RAO7PC1(DFN,BEG,END,"1P")
"RTN","VPRDPROC",22,0)
 . D EN1^VPRDRA(ID,.VPRITM)
"RTN","VPRDPROC",23,0)
 ;
"RTN","VPRDPROC",24,0)
 ; get all surgeries
"RTN","VPRDPROC",25,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDPROC",26,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDPROC",27,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDPROC",28,0)
 . K VPRITM D ONE^VPRDSR(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",29,0)
 . ;Q:$G(VPRITM("status"))'?1"COMP".E
"RTN","VPRDPROC",30,0)
 . D XML(.VPRITM)
"RTN","VPRDPROC",31,0)
 K @VPRY
"RTN","VPRDPROC",32,0)
 ;
"RTN","VPRDPROC",33,0)
 ; get all radiology exams
"RTN","VPRDPROC",34,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDPROC",35,0)
 S VPRCNT=+$G(VPRTOTL),VPRN=""
"RTN","VPRDPROC",36,0)
 F  S VPRN=$O(^TMP($J,"RAE1",DFN,VPRN)) Q:VPRN=""   D  Q:VPRCNT'<MAX  ;I $P($P($G(^(VPRN)),U,6),"~",2)?1"COMP".E
"RTN","VPRDPROC",37,0)
 . K VPRITM D EN1^VPRDRA(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",38,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPROC",39,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDPROC",40,0)
 ;
"RTN","VPRDPROC",41,0)
 ; Consults/ClinProc
"RTN","VPRDPROC",42,0)
 ; V-files [CPT, Exam, Treatment, Patient ED]
"RTN","VPRDPROC",43,0)
 ;
"RTN","VPRDPROC",44,0)
 Q
"RTN","VPRDPROC",45,0)
 ;
"RTN","VPRDPROC",46,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPROC",47,0)
 ;
"RTN","VPRDPROC",48,0)
XML(PROC) ; -- Return procedures as XML
"RTN","VPRDPROC",49,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPROC",50,0)
 D ADD("<procedure>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPROC",51,0)
 S ATT="" F  S ATT=$O(PROC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPROC",52,0)
 . S NAMES=$S(ATT="document"!(ATT="opReport"):"id^localTitle^nationalTitle^status^Z",1:"code^name^Z")
"RTN","VPRDPROC",53,0)
 . I $O(PROC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPROC",54,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPROC",55,0)
 .. S I=0 F  S I=$O(PROC(ATT,I)) Q:I<1  D
"RTN","VPRDPROC",56,0)
 ... S X=$G(PROC(ATT,I))
"RTN","VPRDPROC",57,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDPROC",58,0)
 ... S X=$G(PROC(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDPROC",59,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDPROC",60,0)
 ... S Y="<content xml:space='preserve'>"_$$ESC^VPRD(X)_"</content>"
"RTN","VPRDPROC",61,0)
 ... D ADD(Y),ADD("</"_ATT_">")
"RTN","VPRDPROC",62,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPROC",63,0)
 . S X=$G(PROC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPROC",64,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPROC",65,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPROC",66,0)
 D ADD("</procedure>")
"RTN","VPRDPROC",67,0)
 Q
"RTN","VPRDPROC",68,0)
 ;
"RTN","VPRDPROC",69,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPROC",70,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPROC",71,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPROC",72,0)
 Q STR
"RTN","VPRDPROC",73,0)
 ;
"RTN","VPRDPROC",74,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPROC",75,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPROC",76,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPROC",77,0)
 Q
"RTN","VPRDPS")
0^11^B14378656
"RTN","VPRDPS",1,0)
VPRDPS ;SLC/MKB -- Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPS",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPS",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPS",4,0)
 ;
"RTN","VPRDPS",5,0)
 ; External References          DBIA#
"RTN","VPRDPS",6,0)
 ; -------------------          -----
"RTN","VPRDPS",7,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPS",8,0)
 ; PSS50,^TMP($J                 4483
"RTN","VPRDPS",9,0)
 ;
"RTN","VPRDPS",10,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPS",11,0)
 ;
"RTN","VPRDPS",12,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's meds
"RTN","VPRDPS",13,0)
 N PS0,VPRN,VPRITM,IV K ^TMP("PS",$J)
"RTN","VPRDPS",14,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPS",15,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPS",16,0)
 ;
"RTN","VPRDPS",17,0)
 ; get one med
"RTN","VPRDPS",18,0)
 I $G(ID) D  D:$D(VPRITM)>9 XML(.VPRITM) K ^TMP("PS",$J) Q
"RTN","VPRDPS",19,0)
 . I ID["N" D NVA^VPRDPSO(ID,.VPRITM) Q
"RTN","VPRDPS",20,0)
 . I ID["O",(ID'["P")&(ID'["S") D RX^VPRDPSO(ID,.VPRITM) Q
"RTN","VPRDPS",21,0)
 . D OEL^PSOORRL(DFN,ID)
"RTN","VPRDPS",22,0)
 . I ID["O",(ID["P")!(ID["S") D PEN1^VPRDPSO(ID,.VPRITM) Q
"RTN","VPRDPS",23,0)
 . S IV=$S(ID["V":1,$G(^TMP("PS",$J,"B",0)):1,1:0)
"RTN","VPRDPS",24,0)
 . D @($S(IV:"IV1",1:"IN1")_"^VPRDPSI(ID,.VPRITM)")
"RTN","VPRDPS",25,0)
 ;
"RTN","VPRDPS",26,0)
 ; get all meds
"RTN","VPRDPS",27,0)
 D OCL^PSOORRL(DFN,BEG,END)
"RTN","VPRDPS",28,0)
 S VPRN=0 F  S VPRN=$O(^TMP("PS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D  I $D(VPRITM)>9 D XML(.VPRITM)
"RTN","VPRDPS",29,0)
 . S ID=$P(PS0,U) K VPRITM
"RTN","VPRDPS",30,0)
 . I ID["N" D NVA^VPRDPSO(ID,.VPRITM) Q
"RTN","VPRDPS",31,0)
 . I ID["O" D RX^VPRDPSO(ID,.VPRITM) Q
"RTN","VPRDPS",32,0)
 . S IV=$S(ID["V":1,$G(^TMP("PS",$J,VPRN,"B",0)):1,1:0)
"RTN","VPRDPS",33,0)
 . D @($S(IV:"IV",1:"IN")_"^VPRDPSI(ID,.VPRITM)")
"RTN","VPRDPS",34,0)
 K ^TMP("PS",$J)
"RTN","VPRDPS",35,0)
 Q
"RTN","VPRDPS",36,0)
 ;
"RTN","VPRDPS",37,0)
NDF(DRUG,I) ; -- Set NDF data for dispense DRUG ien
"RTN","VPRDPS",38,0)
 N VUID,X
"RTN","VPRDPS",39,0)
 S DRUG=+$G(DRUG) Q:'DRUG
"RTN","VPRDPS",40,0)
 D NDF^PSS50(DRUG,,,,,"NDF") S I=+$G(I)+1
"RTN","VPRDPS",41,0)
 S MED("product",I)=DRUG_U_$G(^TMP($J,"NDF",DRUG,.01))_"^^D" ;Drug
"RTN","VPRDPS",42,0)
 S X=$G(^TMP($J,"NDF",DRUG,20)) ;VA Generic
"RTN","VPRDPS",43,0)
 S MED("product",I,"G")=X_U_$$VUID^VPRD(+X,50.6)
"RTN","VPRDPS",44,0)
 S X=$G(^TMP($J,"NDF",DRUG,22)) ;VA Product
"RTN","VPRDPS",45,0)
 S MED("product",I,"P")=X_U_$$VUID^VPRD(+X,50.68)
"RTN","VPRDPS",46,0)
 S X=$G(^TMP($J,"NDF",DRUG,25)) ;VA Drug Class
"RTN","VPRDPS",47,0)
 S MED("product",I,"C")=$P(X,U,2,3)_U_$$VUID^VPRD(+X,50.605)
"RTN","VPRDPS",48,0)
 K ^TMP($J,"NDF",DRUG)
"RTN","VPRDPS",49,0)
 Q
"RTN","VPRDPS",50,0)
 ;
"RTN","VPRDPS",51,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPS",52,0)
 ;
"RTN","VPRDPS",53,0)
XML(MED) ; -- Return patient meds as XML
"RTN","VPRDPS",54,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPS",55,0)
 D ADD("<med>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPS",56,0)
 S ATT="" F  S ATT=$O(MED(ATT)) Q:ATT=""  D  I $L(Y) D ADD(Y)
"RTN","VPRDPS",57,0)
 . I $O(MED(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPS",58,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPS",59,0)
 .. S I=0 F  S I=$O(MED(ATT,I)) Q:I<1  D
"RTN","VPRDPS",60,0)
 ... S X=$G(MED(ATT,I)),NAMES=""
"RTN","VPRDPS",61,0)
 ... I ATT="dose" S NAMES="dose^units^unitsPerDose^noun^route^schedule^duration^conjunction^doseStart^doseStop^Z"
"RTN","VPRDPS",62,0)
 ... I ATT="fill" S NAMES="fillDate^fillRouting^releaseDate^fillQuantity^fillDaysSupply^partial^Z"
"RTN","VPRDPS",63,0)
 ... I ATT="product" S NAMES="code^name^vuid^role^concentration^Z"
"RTN","VPRDPS",64,0)
 ... S Y="<"_ATT_" "_$$LOOP_$S(ATT'="product":"/>",1:">") D ADD(Y)
"RTN","VPRDPS",65,0)
 ... Q:ATT'="product"
"RTN","VPRDPS",66,0)
 ... S X=$G(MED(ATT,I,"C")) I $L(X) S Y="<class "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",67,0)
 ... S X=$G(MED(ATT,I,"G")) I $L(X) S Y="<vaGeneric "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",68,0)
 ... S X=$G(MED(ATT,I,"P")) I $L(X) S Y="<vaProduct "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",69,0)
 ... D ADD("</product>")
"RTN","VPRDPS",70,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPS",71,0)
 . S X=$G(MED(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPS",72,0)
 . I ATT="sig"!(ATT?1"ptIn"1.A) S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDPS",73,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPS",74,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPS",75,0)
 D ADD("</med>")
"RTN","VPRDPS",76,0)
 Q
"RTN","VPRDPS",77,0)
 ;
"RTN","VPRDPS",78,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPS",79,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPS",80,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPS",81,0)
 Q STR
"RTN","VPRDPS",82,0)
 ;
"RTN","VPRDPS",83,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPS",84,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPS",85,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPS",86,0)
 Q
"RTN","VPRDPSI")
0^12^B41960179
"RTN","VPRDPSI",1,0)
VPRDPSI ;SLC/MKB -- Inpatient Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPSI",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPSI",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSI",4,0)
 ;
"RTN","VPRDPSI",5,0)
 ; External References          DBIA#
"RTN","VPRDPSI",6,0)
 ; -------------------          -----
"RTN","VPRDPSI",7,0)
 ; ^SC                          10040
"RTN","VPRDPSI",8,0)
 ; DIQ                           2056
"RTN","VPRDPSI",9,0)
 ; ORX8                          2467
"RTN","VPRDPSI",10,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPSI",11,0)
 ; PSS50P7                       4662
"RTN","VPRDPSI",12,0)
 ; XLFSTR                       10104
"RTN","VPRDPSI",13,0)
 ;
"RTN","VPRDPSI",14,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPSI",15,0)
 ;
"RTN","VPRDPSI",16,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's UD/IV meds
"RTN","VPRDPSI",17,0)
 N PS0,VPRN,VPRITM,IV K ^TMP("PS",$J)
"RTN","VPRDPSI",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPSI",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPSI",20,0)
 ;
"RTN","VPRDPSI",21,0)
 ; get one med
"RTN","VPRDPSI",22,0)
 I $G(ID) D  Q
"RTN","VPRDPSI",23,0)
 . Q:ID["N"  Q:ID["O"  ;inpatient only
"RTN","VPRDPSI",24,0)
 . D OEL^PSOORRL(DFN,ID)
"RTN","VPRDPSI",25,0)
 . S IV=$S(ID["V":1,$G(^TMP("PS",$J,"B",0)):1,1:0)
"RTN","VPRDPSI",26,0)
 . D @($S(IV:"IV1",1:"IN1")_"(ID,.VPRITM)")
"RTN","VPRDPSI",27,0)
 . I $D(VPRITM)>9 D XML^VPRDPS(.VPRITM)
"RTN","VPRDPSI",28,0)
 . K ^TMP("PS",$J)
"RTN","VPRDPSI",29,0)
 ;
"RTN","VPRDPSI",30,0)
 ; get all meds
"RTN","VPRDPSI",31,0)
 D OCL^PSOORRL(DFN,BEG,END)
"RTN","VPRDPSI",32,0)
 S VPRN=0 F  S VPRN=$O(^TMP("PS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D
"RTN","VPRDPSI",33,0)
 . S ID=$P(PS0,U) K VPRITM
"RTN","VPRDPSI",34,0)
 . Q:ID["N"  Q:ID["O"  ;inpatient only
"RTN","VPRDPSI",35,0)
 . S IV=$S(ID["V":1,$G(^TMP("PS",$J,VPRN,"B",0)):1,1:0)
"RTN","VPRDPSI",36,0)
 . D @($S(IV:"IV",1:"IN")_"(ID,.VPRITM)")
"RTN","VPRDPSI",37,0)
 . I $D(VPRITM)>9 D XML^VPRDPS(.VPRITM)
"RTN","VPRDPSI",38,0)
 K ^TMP("PS",$J)
"RTN","VPRDPSI",39,0)
 Q
"RTN","VPRDPSI",40,0)
 ;
"RTN","VPRDPSI",41,0)
IN(ID,MED) ; -- return a medication in MED("attribute")=value
"RTN","VPRDPSI",42,0)
 ; [expects PS0,OCL^PSOORRL data]
"RTN","VPRDPSI",43,0)
 N X,PS,ORDER,DOSE,UNTS,RTE,SCH,OI,PSOI,LOC K MED
"RTN","VPRDPSI",44,0)
 M PS=^TMP("PS",$J,VPRN)
"RTN","VPRDPSI",45,0)
 S MED("id")=ID,MED("vaType")="I"
"RTN","VPRDPSI",46,0)
 S X=$P(PS0,U,15) S:X MED("start")=X
"RTN","VPRDPSI",47,0)
 S X=$P(PS0,U,4) S:X MED("stop")=X
"RTN","VPRDPSI",48,0)
 S MED("name")=$P(PS0,U,2),X=$P(PS0,U,9),MED("vaStatus")=X,X=$E(X,1,3)
"RTN","VPRDPSI",49,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="REN"):"historical",X="REI":"active",1:$$LOW^XLFSTR($P(PS0,U,9)))
"RTN","VPRDPSI",50,0)
 S DOSE=$P(PS0,U,6) S:DOSE="" DOSE=$G(PS("SIG",1,0))
"RTN","VPRDPSI",51,0)
 S RTE=$G(PS("MDR",1,0)),SCH=$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",52,0)
 S MED("dose",1)=DOSE_"^^^^"_RTE_U_SCH
"RTN","VPRDPSI",53,0)
 S MED("sig")="Give: "_DOSE_" "_RTE_" "_SCH I $G(PS("SIO",0)) D
"RTN","VPRDPSI",54,0)
 . N SIO M SIO=PS("SIO")
"RTN","VPRDPSI",55,0)
 . S MED("sig")=MED("sig")_$C(13,10)_$$STRING^VPRD(.SIO)
"RTN","VPRDPSI",56,0)
 I $D(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",57,0)
 I $G(PS("CLINIC",0)) S MED("IMO")=1
"RTN","VPRDPSI",58,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",59,0)
 S ORDER=+$P(PS0,U,8) D:ORDER ORD
"RTN","VPRDPSI",60,0)
 Q
"RTN","VPRDPSI",61,0)
 ;
"RTN","VPRDPSI",62,0)
IN1(ID,MED) ; -- return a medication in MED("attribute")=value
"RTN","VPRDPSI",63,0)
 ; [expects OEL^PSOORRL data]
"RTN","VPRDPSI",64,0)
 N X,PS,PS0,ORDER,DOSE,UNTS,RTE,SCH,OI,PSOI,DRUG,LOC K MED
"RTN","VPRDPSI",65,0)
 M PS=^TMP("PS",$J) S PS0=PS(0)
"RTN","VPRDPSI",66,0)
 S MED("id")=ID,MED("vaType")="I"
"RTN","VPRDPSI",67,0)
 S X=$P(PS0,U,5) S:X MED("start")=X
"RTN","VPRDPSI",68,0)
 S X=$P(PS0,U,3) S:X MED("stop")=X
"RTN","VPRDPSI",69,0)
 S MED("name")=$P(PS0,U),X=$P(PS0,U,6),MED("vaStatus")=X,X=$E(X,1,3)
"RTN","VPRDPSI",70,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="REN"):"historical",X="REI":"active",1:$$LOW^XLFSTR($P(PS0,U,9)))
"RTN","VPRDPSI",71,0)
 S DOSE=$P(PS0,U,9) S:DOSE="" DOSE=$G(PS("SIG",1,0))
"RTN","VPRDPSI",72,0)
 S RTE=$G(PS("MDR",1,0)),SCH=$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",73,0)
 S MED("dose",1)=DOSE_"^^^^"_RTE_U_SCH
"RTN","VPRDPSI",74,0)
 S MED("sig")="Give: "_DOSE_" "_RTE_" "_SCH I $G(PS("SIO",0)) D
"RTN","VPRDPSI",75,0)
 . N SIO M SIO=PS("SIO")
"RTN","VPRDPSI",76,0)
 . S MED("sig")=MED("sig")_$C(13,10)_$$STRING^VPRD(.SIO)
"RTN","VPRDPSI",77,0)
 I $D(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",78,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",79,0)
 S ORDER=+$P(PS0,U,11) D:ORDER ORD
"RTN","VPRDPSI",80,0)
 I $P($G(^SC(+$G(LOC),0)),U,25) S MED("IMO")=1
"RTN","VPRDPSI",81,0)
 Q
"RTN","VPRDPSI",82,0)
 ;
"RTN","VPRDPSI",83,0)
ORD ; get rest of inpatient data from ORDER
"RTN","VPRDPSI",84,0)
 S OI=$$OI^ORX8(ORDER),PSOI=+$P(OI,U,3)
"RTN","VPRDPSI",85,0)
 S MED("name")=$P(OI,U,2) I PSOI D
"RTN","VPRDPSI",86,0)
 . D ZERO^PSS50P7(PSOI,,,"OI")
"RTN","VPRDPSI",87,0)
 . S MED("form")=$P($G(^TMP($J,"OI",PSOI,.02)),U,2)
"RTN","VPRDPSI",88,0)
 S X=$$VALUE^ORX8(ORDER,"DOSE"),DOSE=DOSE_"^^^"
"RTN","VPRDPSI",89,0)
 S DRUG="" I X'="",X["&" D
"RTN","VPRDPSI",90,0)
 . S DRUG=+$P(X,"&",6)
"RTN","VPRDPSI",91,0)
 . S DOSE=$TR($P(X,"&",1,4),"&","^")
"RTN","VPRDPSI",92,0)
 . S $P(MED("dose",1),U,1,4)=DOSE
"RTN","VPRDPSI",93,0)
 S:'DRUG DRUG=+$$VALUE^ORX8(ORDER,"DRUG")
"RTN","VPRDPSI",94,0)
 D:DRUG NDF^VPRDPS(DRUG)
"RTN","VPRDPSI",95,0)
 K ^TMP($J,"OI")
"RTN","VPRDPSI",96,0)
ORDLOC ; enter here for just order# and location
"RTN","VPRDPSI",97,0)
 S MED("orderID")=ORDER
"RTN","VPRDPSI",98,0)
 S LOC=+$$GET1^DIQ(100,ORDER_",",6,"I") I LOC D
"RTN","VPRDPSI",99,0)
 . S MED("location")=LOC_U_$P($G(^SC(LOC,0)),U)
"RTN","VPRDPSI",100,0)
 . S MED("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPSI",101,0)
 Q
"RTN","VPRDPSI",102,0)
 ;
"RTN","VPRDPSI",103,0)
IV(ID,MED) ; -- return an infusion in MED("attribute")=value
"RTN","VPRDPSI",104,0)
 ; [expects PS0,OCL^PSOORRL data]
"RTN","VPRDPSI",105,0)
 N PS,X,ORDER,LOC K MED
"RTN","VPRDPSI",106,0)
 M PS=^TMP("PS",$J,VPRN)
"RTN","VPRDPSI",107,0)
 S MED("id")=ID,MED("vaType")="V",MED("name")=$P(PS0,U,2)
"RTN","VPRDPSI",108,0)
 S X=$P(PS0,U,15) S:X MED("start")=X
"RTN","VPRDPSI",109,0)
 S X=$P(PS0,U,4) S:X MED("stop")=X
"RTN","VPRDPSI",110,0)
 S MED("vaStatus")=$P(PS0,U,9),X=$E($P(PS0,U,9),1,3)
"RTN","VPRDPSI",111,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="PUR"):"historical",X="HOL":"hold",1:"active")
"RTN","VPRDPSI",112,0)
 S MED("dose",1)="^^^^"_$G(PS("MDR",1,0))_U_$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",113,0)
 S MED("rate")=$P(PS0,U,3) D IVP
"RTN","VPRDPSI",114,0)
 S X=$G(PS("IVLIM",0)) S:$L(X) MED("ivLimit")=$$IVLIM(X)
"RTN","VPRDPSI",115,0)
 I $G(PS("CLINIC",0)) S MED("IMO")=1
"RTN","VPRDPSI",116,0)
 I $G(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",117,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",118,0)
 S ORDER=+$P(PS0,U,8) D:ORDER ORDLOC
"RTN","VPRDPSI",119,0)
 Q
"RTN","VPRDPSI",120,0)
 ;
"RTN","VPRDPSI",121,0)
IV1(ID,MED) ; -- return an infusion in MED("attribute")=value
"RTN","VPRDPSI",122,0)
 ; [expects OEL^PSOORRL data]
"RTN","VPRDPSI",123,0)
 N PS,PS0,X,ORDER,LOC K MED
"RTN","VPRDPSI",124,0)
 M PS=^TMP("PS",$J) S PS0=PS(0)
"RTN","VPRDPSI",125,0)
 S MED("id")=ID,MED("vaType")="V",MED("name")=$P(PS0,U)
"RTN","VPRDPSI",126,0)
 S X=$P(PS0,U,5) S:X MED("start")=X
"RTN","VPRDPSI",127,0)
 S X=$P(PS0,U,3) S:X MED("stop")=X
"RTN","VPRDPSI",128,0)
 S MED("vaStatus")=$P(PS0,U,6),X=$E($P(PS0,U,6),1,3)
"RTN","VPRDPSI",129,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="PUR"):"historical",X="HOL":"hold",1:"active")
"RTN","VPRDPSI",130,0)
 S MED("dose",1)="^^^^"_$G(PS("MDR",1,0))_U_$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",131,0)
 S MED("rate")=$P(PS0,U,2) D IVP
"RTN","VPRDPSI",132,0)
 S X=$G(PS("IVLIM",0)) S:$L(X) MED("ivLimit")=$$IVLIM(X)
"RTN","VPRDPSI",133,0)
 I $G(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",134,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",135,0)
 S ORDER=+$P(PS0,U,11) D:ORDER ORDLOC
"RTN","VPRDPSI",136,0)
 I $P($G(^SC(+$G(LOC),0)),U,25) S MED("IMO")=1
"RTN","VPRDPSI",137,0)
 Q
"RTN","VPRDPSI",138,0)
 ;
"RTN","VPRDPSI",139,0)
IVP ; -- add IV products for ID,DFN
"RTN","VPRDPSI",140,0)
 N I,N,FILE,IENS,VPR,LIST,IEN,DRUG,STR
"RTN","VPRDPSI",141,0)
 S FILE=$S(ID["P":53.157,1:55.02),N=0
"RTN","VPRDPSI",142,0)
 S IENS=","_+ID_","_$S(ID["P":"",1:DFN_",")
"RTN","VPRDPSI",143,0)
 F I=1:1 K VPR D GETS^DIQ(FILE,I_IENS,"*","IE","VPR") Q:'$D(VPR)  D
"RTN","VPRDPSI",144,0)
 . K LIST M LIST=VPR(FILE,I_IENS)
"RTN","VPRDPSI",145,0)
 . S IEN=LIST(.01,"I"),DRUG=$$GET1^DIQ(52.6,IEN_",",1,"I")
"RTN","VPRDPSI",146,0)
 . D:DRUG NDF^VPRDPS(DRUG,.N) S:'DRUG N=N+1
"RTN","VPRDPSI",147,0)
 . S STR=$S(FILE=53.157:LIST(1,"E"),1:LIST(.02,"E"))
"RTN","VPRDPSI",148,0)
 . S MED("product",N)=IEN_U_LIST(.01,"E")_"^^A^"_STR
"RTN","VPRDPSI",149,0)
 S FILE=$S(ID["P":53.158,1:55.11)
"RTN","VPRDPSI",150,0)
 F I=1:1 K VPR D GETS^DIQ(FILE,I_IENS,"*","IE","VPR") Q:'$D(VPR)  D
"RTN","VPRDPSI",151,0)
 . K LIST M LIST=VPR(FILE,I_IENS)
"RTN","VPRDPSI",152,0)
 . S IEN=LIST(.01,"I"),DRUG=$$GET1^DIQ(52.7,IEN_",",1,"I")
"RTN","VPRDPSI",153,0)
 . D:DRUG NDF^VPRDPS(DRUG,.N) S:'DRUG N=N+1
"RTN","VPRDPSI",154,0)
 . S MED("product",N)=IEN_U_LIST(.01,"E")_"^^B^"_LIST(1,"E")
"RTN","VPRDPSI",155,0)
 Q
"RTN","VPRDPSI",156,0)
 ;
"RTN","VPRDPSI",157,0)
IVLIM(X) ; -- Return expanded version of IV Limit X
"RTN","VPRDPSI",158,0)
 I '$L($G(X)) Q ""
"RTN","VPRDPSI",159,0)
 N Y,VAL,UNT,I
"RTN","VPRDPSI",160,0)
 S Y="",X=$$UP^XLFSTR(X)
"RTN","VPRDPSI",161,0)
 I X?1"DOSES".E S X="A"_$P(X,"DOSES",2)
"RTN","VPRDPSI",162,0)
 S UNT=$E(X),VAL=0 F I=2:1:$L(X) I $E(X,I) S VAL=$E(X,I,$L(X)) Q
"RTN","VPRDPSI",163,0)
 I UNT="A" S Y=+VAL_$S(+VAL>1:" doses",1:" dose")
"RTN","VPRDPSI",164,0)
 I UNT="D" S Y=+VAL_$S(+VAL>1:" days",1:" day")
"RTN","VPRDPSI",165,0)
 I UNT="H" S Y=+VAL_$S(+VAL>1:" hours",1:" hour")
"RTN","VPRDPSI",166,0)
 I UNT="C" S Y=+VAL_" CC"
"RTN","VPRDPSI",167,0)
 I UNT="M" S Y=+VAL_" ml"
"RTN","VPRDPSI",168,0)
 I UNT="L" S Y=+VAL_" L"
"RTN","VPRDPSI",169,0)
 Q Y
"RTN","VPRDPSO")
0^13^B68282901
"RTN","VPRDPSO",1,0)
VPRDPSO ;SLC/MKB -- Outpatient Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPSO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPSO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSO",4,0)
 ;
"RTN","VPRDPSO",5,0)
 ; External References          DBIA#
"RTN","VPRDPSO",6,0)
 ; -------------------          -----
"RTN","VPRDPSO",7,0)
 ; ^SC                          10040
"RTN","VPRDPSO",8,0)
 ; ^VA(200)                     10060
"RTN","VPRDPSO",9,0)
 ; DIQ                           2056
"RTN","VPRDPSO",10,0)
 ; ORX8                          2467
"RTN","VPRDPSO",11,0)
 ; PSO5241                       4821
"RTN","VPRDPSO",12,0)
 ; PSOORDER,^TMP("PSOR",$J)      1878
"RTN","VPRDPSO",13,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPSO",14,0)
 ; PSS50P7                       4662
"RTN","VPRDPSO",15,0)
 ; PSS51P2                       4548
"RTN","VPRDPSO",16,0)
 ; XLFDT                        10103
"RTN","VPRDPSO",17,0)
 ; XLFSTR                       10104
"RTN","VPRDPSO",18,0)
 ;
"RTN","VPRDPSO",19,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPSO",20,0)
 ;
"RTN","VPRDPSO",21,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's meds
"RTN","VPRDPSO",22,0)
 N PS0,VPRN,VPRITM K ^TMP("PS",$J)
"RTN","VPRDPSO",23,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPSO",24,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPSO",25,0)
 ;
"RTN","VPRDPSO",26,0)
 ; get one med
"RTN","VPRDPSO",27,0)
 I $G(ID) D  D:$D(VPRITM)>9 XML^VPRDPS(.VPRITM) Q
"RTN","VPRDPSO",28,0)
 . Q:ID["I"
"RTN","VPRDPSO",29,0)
 . I ID["N" D NVA(ID,.VPRITM) Q
"RTN","VPRDPSO",30,0)
 . I ID'["P",ID'["S" D RX(ID,.VPRITM) Q
"RTN","VPRDPSO",31,0)
 . D OEL^PSOORRL(DFN,ID),PEN1(ID,.VPRITM)
"RTN","VPRDPSO",32,0)
 . K ^TMP("PS",$J)
"RTN","VPRDPSO",33,0)
 ;
"RTN","VPRDPSO",34,0)
 ; get all meds
"RTN","VPRDPSO",35,0)
 D OCL^PSOORRL(DFN,BEG,END)
"RTN","VPRDPSO",36,0)
 S VPRN=0 F  S VPRN=$O(^TMP("PS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D  I $D(VPRITM)>9 D XML^VPRDPS(.VPRITM)
"RTN","VPRDPSO",37,0)
 . S ID=$P(PS0,U) K VPRITM Q:ID["I"
"RTN","VPRDPSO",38,0)
 . I ID["N" D NVA(ID,.VPRITM) Q
"RTN","VPRDPSO",39,0)
 . I ID["O" D RX(ID,.VPRITM) Q
"RTN","VPRDPSO",40,0)
 K ^TMP("PS",$J)
"RTN","VPRDPSO",41,0)
 Q
"RTN","VPRDPSO",42,0)
 ;
"RTN","VPRDPSO",43,0)
RX(ID,MED) ; -- return a prescription in MED("attribute")=value
"RTN","VPRDPSO",44,0)
 I ID["P"!(ID["S") G PEND ;pending order
"RTN","VPRDPSO",45,0)
 N RX0,RX1,DRUG,PSOI,X,I,START,STOP,ORIFN,FILL,RFD,PRV K MED
"RTN","VPRDPSO",46,0)
 N VPR ;PSOORDER set/killed VPR
"RTN","VPRDPSO",47,0)
 K ^TMP("PSOR",$J) D EN^PSOORDER(DFN,+ID)
"RTN","VPRDPSO",48,0)
 S RX0=$G(^TMP("PSOR",$J,+ID,0)),RX1=$G(^(1)),DRUG=$G(^("DRUG",0))
"RTN","VPRDPSO",49,0)
 S MED("id")=ID,MED("vaType")="O",MED("type")="Prescription"
"RTN","VPRDPSO",50,0)
 S ORIFN=+$P(RX1,U,8) S:ORIFN MED("orderID")=ORIFN
"RTN","VPRDPSO",51,0)
 S PSOI=$G(^TMP("PSOR",$J,+ID,"DRUGOI",0)) I PSOI D
"RTN","VPRDPSO",52,0)
 . S MED("name")=$P(PSOI,";",2)
"RTN","VPRDPSO",53,0)
 . D ZERO^PSS50P7(+PSOI,,,"OI")
"RTN","VPRDPSO",54,0)
 . S MED("form")=$P($G(^TMP($J,"OI",+PSOI,.02)),U,2)
"RTN","VPRDPSO",55,0)
 D:DRUG NDF^VPRDPS(+DRUG) ;add NDF data
"RTN","VPRDPSO",56,0)
 S START=$P(RX0,U) S:START MED("start")=START
"RTN","VPRDPSO",57,0)
 S STOP=$P(RX0,U,12) S:STOP MED("stop")=STOP ;_".2359"?
"RTN","VPRDPSO",58,0)
 S X=$$GET1^DIQ(52,+ID_",",26,"I") S:X MED("expires")=X
"RTN","VPRDPSO",59,0)
 S X=$P(RX0,U,17) S:X MED("ordered")=X
"RTN","VPRDPSO",60,0)
 S MED("vaStatus")=$$UP^XLFSTR($P($P(RX0,U,4),";",2)),X=$P($P(RX0,U,4),";")
"RTN","VPRDPSO",61,0)
 S MED("status")=$S(X="H":"hold",X="DC":"not active",X="D"!(X="E"):"historical",1:"active")
"RTN","VPRDPSO",62,0)
 S MED("quantity")=$P(RX0,U,6),MED("daysSupply")=$P(RX0,U,7)
"RTN","VPRDPSO",63,0)
 S MED("fillsAllowed")=$P(RX0,U,8),MED("fillsRemaining")=$P(RX0,U,9)
"RTN","VPRDPSO",64,0)
 S MED("routing")=$P($P(RX1,U,6),";"),MED("prescription")=$P(RX0,U,5)
"RTN","VPRDPSO",65,0)
 S MED("lastFilled")=$P(RX0,U,3) K FILL
"RTN","VPRDPSO",66,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"REF",I)) Q:I<1  S X=$G(^(I,0)),FILL(+X)=X
"RTN","VPRDPSO",67,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"RPAR",I)) Q:I<1  S X=$G(^(I,0)),$P(X,U,14)=1,FILL(+X)=X
"RTN","VPRDPSO",68,0)
 S (I,RFD,PRV)=0 F  S RFD=$O(FILL(RFD)) Q:RFD<1  S X=$G(FILL(RFD)) D  ;sort 1st
"RTN","VPRDPSO",69,0)
 . N MW,REL S I=I+1
"RTN","VPRDPSO",70,0)
 . S MW=$P($P(X,U,10),";"),REL=$P($P(X,U,8),".")
"RTN","VPRDPSO",71,0)
 . S MED("fill",I)=$P(RFD,".")_U_MW_U_REL_U_$P(X,U,4,5)_$S($P(X,U,14):"^1",1:"")
"RTN","VPRDPSO",72,0)
 . S:$P(X,U,2) PRV=$P(X,U,2) ;save last provider
"RTN","VPRDPSO",73,0)
 . ; fill comments?
"RTN","VPRDPSO",74,0)
 S X=$S($P(RX0,U,11):$P(RX0,U,11),$P(RX0,U,10):$P(RX0,U,10),1:0)
"RTN","VPRDPSO",75,0)
 S:X MED("fillCost")=X
"RTN","VPRDPSO",76,0)
 S X=$G(^TMP("PSOR",$J,+ID,"SIG",1,0)),I=1
"RTN","VPRDPSO",77,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"SIG",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",78,0)
 S MED("sig")=X
"RTN","VPRDPSO",79,0)
 S X=$G(^TMP("PSOR",$J,+ID,"PI",1,0)),I=1
"RTN","VPRDPSO",80,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"PI",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",81,0)
 S:$L(X) MED("ptInstructions")=X
"RTN","VPRDPSO",82,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"MI",I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPSO",83,0)
 . N UD,NOUN,DOSE,UNIT,RTE,SCH,DUR,CONJ,END
"RTN","VPRDPSO",84,0)
 . S UD=$P(X,U,2),NOUN=$P(X,U,4)
"RTN","VPRDPSO",85,0)
 . S DOSE=$P(X,U),UNIT=$P($P(X,U,3),";",2)
"RTN","VPRDPSO",86,0)
 . S RTE=+$P(X,U,7) D ALL^PSS51P2(RTE,,,,"MR")
"RTN","VPRDPSO",87,0)
 . S RTE=$G(^TMP($J,"MR",RTE,1))
"RTN","VPRDPSO",88,0)
 . S DUR=$P(X,U,5),CONJ=$P(X,U,6),SCH=$P(X,U,8)
"RTN","VPRDPSO",89,0)
 . S END=$S(DUR:$$STOP(START,DUR),1:STOP)
"RTN","VPRDPSO",90,0)
 . S MED("dose",I)=DOSE_U_UNIT_U_UD_U_NOUN_U_RTE_U_SCH_U_DUR_U_CONJ_U_START_U_STOP
"RTN","VPRDPSO",91,0)
 . I $E(CONJ)="T",DUR S START=END
"RTN","VPRDPSO",92,0)
 S:RX1 X=$TR($P(RX1,U),";","^"),MED("orderingProvider")=X,MED("currentProvider")=X
"RTN","VPRDPSO",93,0)
 S:$G(PRV) MED("currentProvider")=$TR(PRV,";","^")
"RTN","VPRDPSO",94,0)
 S:$P(RX1,U,9) MED("pharmacist")=$TR($P(RX1,U,9),";","^")
"RTN","VPRDPSO",95,0)
 S:$P(RX1,U,4) MED("location")=$TR($P(RX1,U,4),";","^")
"RTN","VPRDPSO",96,0)
 S MED("facility")=$$FAC^VPRD(+$P(RX1,U,4))
"RTN","VPRDPSO",97,0)
 K ^TMP("PSOR",$J),^TMP($J,"MR"),^TMP($J,"NDF"),^TMP($J,"OI")
"RTN","VPRDPSO",98,0)
 Q
"RTN","VPRDPSO",99,0)
 ;
"RTN","VPRDPSO",100,0)
PEND ; -- pending prescription
"RTN","VPRDPSO",101,0)
 ; [expects PS0,OCL^PSOORRL data]
"RTN","VPRDPSO",102,0)
 N I,X,VPRX,VPR K MED
"RTN","VPRDPSO",103,0)
 S MED("id")=ID,MED("vaType")="O",MED("type")="Prescription"
"RTN","VPRDPSO",104,0)
 S MED("vaStatus")=$P(PS0,U,9),MED("status")="not active"
"RTN","VPRDPSO",105,0)
 S X=+$P(PS0,U,8) S:X MED("orderID")=X
"RTN","VPRDPSO",106,0)
 S X=+$P(PS0,U,12) S:X MED("quantity")=X
"RTN","VPRDPSO",107,0)
 D GETS^DIQ(52.41,+ID_",","101;13;19;15;5;1.1","I","VPRX")
"RTN","VPRDPSO",108,0)
 S X=VPRX(52.41,+ID_",",101,"I") S:X MED("daysSupply")=X
"RTN","VPRDPSO",109,0)
 S X=VPRX(52.41,+ID_",",13,"I") S:X MED("fillsAllowed")=X
"RTN","VPRDPSO",110,0)
 S X=VPRX(52.41,+ID_",",19,"I") S:$L(X) MED("routing")=X
"RTN","VPRDPSO",111,0)
 S X=VPRX(52.41,+ID_",",15,"I") S:X MED("ordered")=X
"RTN","VPRDPSO",112,0)
 S X=VPRX(52.41,+ID_",",5,"I") S:X MED("orderingProvider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPSO",113,0)
 S X=VPRX(52.41,+ID_",",1.1,"I") S:X MED("location")=X_U_$P($G(^SC(X,0)),U)
"RTN","VPRDPSO",114,0)
 S MED("facility")=$$FAC^VPRD(X)
"RTN","VPRDPSO",115,0)
 S X=$G(^TMP("PS",$J,VPRN,"SIG",1,0)),I=1
"RTN","VPRDPSO",116,0)
 F  S I=$O(^TMP("PS",$J,VPRN,"SIG",I)) Q:I<1  S X=X_$C(13,10)_$G(^(I,0))
"RTN","VPRDPSO",117,0)
 S MED("sig")=X
"RTN","VPRDPSO",118,0)
 D PEN^PSO5241(DFN,"VPRX",+ID)
"RTN","VPRDPSO",119,0)
 S X=$G(^TMP($J,"VPRX",DFN,+ID,8)) I X D  ;Pharmacy OI
"RTN","VPRDPSO",120,0)
 . S MED("name")=$P(X,U,2)_" "_$P(X,U,4),MED("form")=$P(X,U,4)
"RTN","VPRDPSO",121,0)
 S X=$G(^TMP($J,"VPRX",DFN,+ID,11)) D:X NDF^VPRDPS(+X) ;Dispense Drug
"RTN","VPRDPSO",122,0)
 D PDOSE K ^TMP($J,"VPRX")
"RTN","VPRDPSO",123,0)
 Q
"RTN","VPRDPSO",124,0)
 ;
"RTN","VPRDPSO",125,0)
PEN1(ID,MED) ; -- return a pending Rx in MED("attribute")=value
"RTN","VPRDPSO",126,0)
 ; [expects OEL^PSOORRL data]
"RTN","VPRDPSO",127,0)
 N PS,PS0,I,X,VPRX,VPR K MED
"RTN","VPRDPSO",128,0)
 M PS=^TMP("PS",$J) S PS0=PS(0)
"RTN","VPRDPSO",129,0)
 S MED("id")=ID,MED("vaType")="O",MED("type")="Prescription"
"RTN","VPRDPSO",130,0)
 S MED("vaStatus")=$P(PS0,U,6),MED("status")="not active"
"RTN","VPRDPSO",131,0)
 S X=+$P(PS0,U,11) S:X MED("orderID")=X
"RTN","VPRDPSO",132,0)
 S X=+$P(PS0,U,8) S:X MED("quantity")=X
"RTN","VPRDPSO",133,0)
 S X=+$P(PS0,U,4) S:X MED("fillsAllowed")=X
"RTN","VPRDPSO",134,0)
 S X=+$P(PS0,U,5) S:X MED("ordered")=X
"RTN","VPRDPSO",135,0)
 S X=$G(PS("DD",1,0)) D:X NDF^VPRDPS(+X) ;Dispense Drug
"RTN","VPRDPSO",136,0)
 D GETS^DIQ(52.41,+ID_",","101;19;5;1.1","I","VPRX")
"RTN","VPRDPSO",137,0)
 S X=VPRX(52.41,+ID_",",101,"I") S:X MED("daysSupply")=X
"RTN","VPRDPSO",138,0)
 S X=VPRX(52.41,+ID_",",19,"I") S:$L(X) MED("routing")=X
"RTN","VPRDPSO",139,0)
 S X=VPRX(52.41,+ID_",",5,"I") S:X MED("orderingProvider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPSO",140,0)
 S X=VPRX(52.41,+ID_",",1.1,"I") S:X MED("location")=X_U_$P($G(^SC(X,0)),U)
"RTN","VPRDPSO",141,0)
 S MED("facility")=$$FAC^VPRD(X)
"RTN","VPRDPSO",142,0)
 S X=$G(PS("SIG",1,0)),I=1
"RTN","VPRDPSO",143,0)
 F  S I=$O(PS("SIG",I)) Q:I<1  S X=X_$C(13,10)_$G(PS("SIG",I,0))
"RTN","VPRDPSO",144,0)
 S MED("sig")=X
"RTN","VPRDPSO",145,0)
 D PEN^PSO5241(DFN,"VPRX",+ID)
"RTN","VPRDPSO",146,0)
 S X=$G(^TMP($J,"VPRX",DFN,+ID,8)) I X D  ;Pharmacy OI
"RTN","VPRDPSO",147,0)
 . S MED("name")=$P(X,U,2)_" "_$P(X,U,4),MED("form")=$P(X,U,4)
"RTN","VPRDPSO",148,0)
 D PDOSE K ^TMP($J,"VPRX")
"RTN","VPRDPSO",149,0)
 Q
"RTN","VPRDPSO",150,0)
 ;
"RTN","VPRDPSO",151,0)
PDOSE ; Pending file doses
"RTN","VPRDPSO",152,0)
 N QT,UNIT,UD,NOUN,DOSE,RTE,SCH,DUR,CONJ,BEG,END
"RTN","VPRDPSO",153,0)
 F I=1:1 K VPRX D GETS^DIQ(52.413,I_","_+ID_",","*",,"VPRX") Q:'$D(VPRX)  D
"RTN","VPRDPSO",154,0)
 . K QT M QT=VPRX(52.413,I_","_+ID_",")
"RTN","VPRDPSO",155,0)
 . S (UNIT,UD,NOUN)="",(DOSE,X)=QT(.01) I X["&" D
"RTN","VPRDPSO",156,0)
 .. S DOSE=$P(X,"&"),UNIT=$P(X,"&",2)
"RTN","VPRDPSO",157,0)
 .. S UD=$P(X,"&",3),NOUN=$P(X,"&",4)
"RTN","VPRDPSO",158,0)
 . S SCH=QT(1),DUR=QT(2),CONJ=QT(6),BEG=QT(3),END=QT(4)
"RTN","VPRDPSO",159,0)
 . S RTE=$$GET1^DIQ(52.413,I_","_+ID_",","10:1")
"RTN","VPRDPSO",160,0)
 . S MED("dose",I)=DOSE_U_UNIT_U_UD_U_NOUN_U_RTE_U_SCH_U_DUR_U_CONJ_U_BEG_U_END
"RTN","VPRDPSO",161,0)
 Q
"RTN","VPRDPSO",162,0)
 ;
"RTN","VPRDPSO",163,0)
STOP(BEG,X) ; -- Return date after adding X to BEG
"RTN","VPRDPSO",164,0)
 N D,H,M,S,UNT,Y
"RTN","VPRDPSO",165,0)
 S Y=BEG,(D,H,M,S)=0,UNT=$P(X," ",2),X=+X
"RTN","VPRDPSO",166,0)
 S:UNT?1"MON".E D=30*X
"RTN","VPRDPSO",167,0)
 S:UNT?1"WEE".E D=7*X
"RTN","VPRDPSO",168,0)
 S:UNT?1"DAY".E D=X
"RTN","VPRDPSO",169,0)
 S:UNT?1"HOU".E H=X
"RTN","VPRDPSO",170,0)
 S:UNT?1"MIN".E M=X
"RTN","VPRDPSO",171,0)
 S:UNT?1"SEC".E S=X
"RTN","VPRDPSO",172,0)
 S Y=$$FMADD^XLFDT(BEG,D,H,M,S)
"RTN","VPRDPSO",173,0)
 Q Y
"RTN","VPRDPSO",174,0)
 ;
"RTN","VPRDPSO",175,0)
NVA(ID,MED) ; -- return a non-VA med in MED("attribute")=value
"RTN","VPRDPSO",176,0)
 N NVA,VPRX,ORIFN,DOSE,X,VPR K MED
"RTN","VPRDPSO",177,0)
 D GETS^DIQ(55.05,+ID_","_DFN_",",".01:8;11:13","IE","VPRX")
"RTN","VPRDPSO",178,0)
 M NVA=VPRX(55.05,+ID_","_DFN_",") K VPRX
"RTN","VPRDPSO",179,0)
 S MED("id")=ID,MED("type")="OTC",MED("vaType")="N"
"RTN","VPRDPSO",180,0)
 S ORIFN=+NVA(7,"I") S:ORIFN MED("orderID")=ORIFN
"RTN","VPRDPSO",181,0)
 I NVA(.01,"I") D  ;orderable item
"RTN","VPRDPSO",182,0)
 . N FORM
"RTN","VPRDPSO",183,0)
 . S X=NVA(.01,"I") D ZERO^PSS50P7(+X,,,"PSOI")
"RTN","VPRDPSO",184,0)
 . S FORM=$P($G(^TMP($J,"PSOI",+X,.02)),U,2),MED("form")=FORM
"RTN","VPRDPSO",185,0)
 . S MED("name")=NVA(.01,"E")_" "_FORM
"RTN","VPRDPSO",186,0)
 S X=NVA(1,"I") D:X NDF^VPRDPS(+X) ;dispense drug
"RTN","VPRDPSO",187,0)
 S MED("sig")=NVA(2,"E")_" BY "_NVA(3,"E")_" "_NVA(4,"E")
"RTN","VPRDPSO",188,0)
 S X=NVA(2,"I"),NVA(2,"I")=+X_U_$P(X,+X,2) ;amt^unit
"RTN","VPRDPSO",189,0)
 S DOSE=NVA(2,"I")_"^^" I ORIFN D  ;reformat from order
"RTN","VPRDPSO",190,0)
 . S X=$$VALUE^ORX8(ORIFN,"ROUTE") S:X NVA(3,"E")=$$GET1^DIQ(51.2,+X_",",1)
"RTN","VPRDPSO",191,0)
 . S X=$$VALUE^ORX8(ORIFN,"SCHEDULE") S:$L(X) NVA(4,"E")=X
"RTN","VPRDPSO",192,0)
 . S X=$$VALUE^ORX8(ORIFN,"DOSE"),DOSE=$TR($P(X,"&",1,4),"&","^")
"RTN","VPRDPSO",193,0)
 S MED("dose",1)=DOSE_U_NVA(3,"E")_U_NVA(4,"E")
"RTN","VPRDPSO",194,0)
 S:NVA(8,"I") MED("start")=NVA(8,"I")
"RTN","VPRDPSO",195,0)
 S:NVA(6,"I") MED("stop")=NVA(6,"I")
"RTN","VPRDPSO",196,0)
 S:NVA(11,"I") MED("ordered")=NVA(11,"I")
"RTN","VPRDPSO",197,0)
 S MED("status")=$S($G(NVA(5,"E")):"not active",1:"active")
"RTN","VPRDPSO",198,0)
 S:NVA(12,"I") MED("orderingProvider")=NVA(12,"I")_U_NVA(12,"E")
"RTN","VPRDPSO",199,0)
 S:NVA(13,"I") MED("location")=NVA(13,"I")_U_NVA(13,"E")
"RTN","VPRDPSO",200,0)
 S MED("facility")=$$FAC^VPRD(NVA(13,"I"))
"RTN","VPRDPSO",201,0)
 K ^TMP($J,"PSOI"),^TMP($J,"NDF")
"RTN","VPRDPSO",202,0)
 Q
"RTN","VPRDPSO",203,0)
 ;
"RTN","VPRDPSO",204,0)
ACTIVE(X) ; -- return 1 or 0, if X is an active status
"RTN","VPRDPSO",205,0)
 N Y S Y=1
"RTN","VPRDPSO",206,0)
 I X="PURGE" S Y=0
"RTN","VPRDPSO",207,0)
 I X="DELETED" S Y=0
"RTN","VPRDPSO",208,0)
 I X="EXPIRED" S Y=0 ;keep, to renew?
"RTN","VPRDPSO",209,0)
 I $P(X," ")="DISCONTINUED" S Y=0
"RTN","VPRDPSO",210,0)
 Q Y
"RTN","VPRDPT")
0^14^B65865871
"RTN","VPRDPT",1,0)
VPRDPT ;SLC/MKB -- Patient demographics extract ;8/2/11  15:29
"RTN","VPRDPT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPT",4,0)
 ;
"RTN","VPRDPT",5,0)
 ; External References          DBIA#
"RTN","VPRDPT",6,0)
 ; -------------------          -----
"RTN","VPRDPT",7,0)
 ; ^DGSL(38.1                     767
"RTN","VPRDPT",8,0)
 ; ^DIC(31                        733
"RTN","VPRDPT",9,0)
 ; ^DIC(42                  723,10039
"RTN","VPRDPT",10,0)
 ; ^DPT               3581,5597,10035
"RTN","VPRDPT",11,0)
 ; DGCV                          4156
"RTN","VPRDPT",12,0)
 ; DGMSTAPI                      2716
"RTN","VPRDPT",13,0)
 ; DGNTAPI                       3457
"RTN","VPRDPT",14,0)
 ; DGPFAPI                       3860
"RTN","VPRDPT",15,0)
 ; DGRPDB                        4807
"RTN","VPRDPT",16,0)
 ; DILFD                         2055
"RTN","VPRDPT",17,0)
 ; DIQ                           2056
"RTN","VPRDPT",18,0)
 ; MPIF001                       2701
"RTN","VPRDPT",19,0)
 ; SDUTL3                        1252
"RTN","VPRDPT",20,0)
 ; VADPT                        10061
"RTN","VPRDPT",21,0)
 ; VAFCTFU1                      2990
"RTN","VPRDPT",22,0)
 ; VASITE                       10112
"RTN","VPRDPT",23,0)
 ; XUAF4                         2171
"RTN","VPRDPT",24,0)
 ;
"RTN","VPRDPT",25,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPT",26,0)
 ;
"RTN","VPRDPT",27,0)
EN(DFN,BEG,END,MAX,ID) ; -- find current patient demographics
"RTN","VPRDPT",28,0)
 ; [BEG,END,MAX,ID not currently used]
"RTN","VPRDPT",29,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPT",30,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDPT",31,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC
"RTN","VPRDPT",32,0)
 I $D(PAT)>9 D XML(.PAT)
"RTN","VPRDPT",33,0)
 Q
"RTN","VPRDPT",34,0)
 ;
"RTN","VPRDPT",35,0)
DEM ;-demographic data
"RTN","VPRDPT",36,0)
 N VADM,VA,VAERR,X
"RTN","VPRDPT",37,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDPT",38,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDPT",39,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDPT",40,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("id")=DFN
"RTN","VPRDPT",41,0)
 S:$D(VA("BID")) PAT("bid")=$E(X)_VA("BID")
"RTN","VPRDPT",42,0)
 S PAT("dob")=+$P($P(VADM(3),U),".")
"RTN","VPRDPT",43,0)
 S PAT("gender")=$P(VADM(5),U)
"RTN","VPRDPT",44,0)
 S PAT("lrdfn")=+$G(^DPT(DFN,"LR"))
"RTN","VPRDPT",45,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=X
"RTN","VPRDPT",46,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=X
"RTN","VPRDPT",47,0)
 S X=+VADM(9) S:X PAT("religion")=X
"RTN","VPRDPT",48,0)
 S X=$P(VADM(10),U,2) S:$L(X) PAT("maritalStatus")=$E(X)
"RTN","VPRDPT",49,0)
 I VADM(11) D
"RTN","VPRDPT",50,0)
 . N I S I=0
"RTN","VPRDPT",51,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicity",X)=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDPT",52,0)
 I VADM(12) D
"RTN","VPRDPT",53,0)
 . N I S I=0
"RTN","VPRDPT",54,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("race",X)=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDPT",55,0)
 Q
"RTN","VPRDPT",56,0)
SVC ;-service data
"RTN","VPRDPT",57,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDPT",58,0)
 D 7^VADPT
"RTN","VPRDPT",59,0)
 S PAT("veteran")=VAEL(4)
"RTN","VPRDPT",60,0)
 S PAT("sc")=+VAEL(3) S:VAEL(3) PAT("scPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDPT",61,0)
 ;
"RTN","VPRDPT",62,0)
 ; exposures
"RTN","VPRDPT",63,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDPT",64,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDPT",65,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDPT",66,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDPT",67,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDPT",68,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDPT",69,0)
 S PAT("exposures")=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDPT",70,0)
 ;
"RTN","VPRDPT",71,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDPT",72,0)
 N VPRDIS,DIS,NM,DX
"RTN","VPRDPT",73,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDPT",74,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDPT",75,0)
 . S DIS=VPRDIS(I)
"RTN","VPRDPT",76,0)
 . S NM=$$GET1^DIQ(31,+DIS_",",.01),DX=$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDPT",77,0)
 . S PAT("disability",+DX)=NM_U_$P(DIS,U,2,3) ;name^%^sc
"RTN","VPRDPT",78,0)
 Q
"RTN","VPRDPT",79,0)
PRF ;-patient record flags
"RTN","VPRDPT",80,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDPT",81,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDPT",82,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDPT",83,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDPT",84,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDPT",85,0)
 . S PAT("flag",I)=NAME_U_$$STRING^VPRD(.TEXT)
"RTN","VPRDPT",86,0)
 Q
"RTN","VPRDPT",87,0)
ATC ;-address & telecom
"RTN","VPRDPT",88,0)
 N VAPA,I,X
"RTN","VPRDPT",89,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDPT",90,0)
 S X="" F I=1:1:4 S X=X_VAPA(I)_U
"RTN","VPRDPT",91,0)
 S X=X_$P(VAPA(5),U,2)_U_$P(VAPA(11),U,2)
"RTN","VPRDPT",92,0)
 S PAT("address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",93,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDPT",94,0)
 S PAT("telecom")=X ;home^cell^work phones
"RTN","VPRDPT",95,0)
 Q
"RTN","VPRDPT",96,0)
SUPP ;-support contacts
"RTN","VPRDPT",97,0)
 N VAOA,A,I,X,TYPE
"RTN","VPRDPT",98,0)
 F A="",1 K VAOA D
"RTN","VPRDPT",99,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDPT",100,0)
 . S TYPE=$S(A=1:"ECON",1:"NOK")
"RTN","VPRDPT",101,0)
 . S PAT("support",TYPE)=VAOA(9)_U_VAOA(10) ;name^relationship
"RTN","VPRDPT",102,0)
 . S X="" F I=1:1:4 S X=X_VAOA(I)_U
"RTN","VPRDPT",103,0)
 . S X=X_$P(VAOA(5),U,2)_U_$P(VAOA(11),U,2)
"RTN","VPRDPT",104,0)
 . S PAT("support",TYPE,"address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",105,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDPT",106,0)
 . S PAT("support",TYPE,"telecom")=X ;home^cell^work phones
"RTN","VPRDPT",107,0)
 Q
"RTN","VPRDPT",108,0)
ALIAS ;-other names used
"RTN","VPRDPT",109,0)
 N I,X
"RTN","VPRDPT",110,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPT",111,0)
 . S PAT("alias",I)=$P(X,U)
"RTN","VPRDPT",112,0)
 Q
"RTN","VPRDPT",113,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDPT",114,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDPT",115,0)
 N P,N,I,Y S P=""
"RTN","VPRDPT",116,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDPT",117,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDPT",118,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDPT",119,0)
 Q Y
"RTN","VPRDPT",120,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDPT",121,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPT",122,0)
 N VPRY,HOME,I,X,IEN
"RTN","VPRDPT",123,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDPT",124,0)
 I $P($G(VPRY(1)),U)<0 D  Q  ;not setup
"RTN","VPRDPT",125,0)
 . S X=$$SITE^VASITE,PAT("facility",+X)=$P(X,U,3)_U_$P(X,U,2)
"RTN","VPRDPT",126,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDPT",127,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDPT",128,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDPT",129,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDPT",130,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDPT",131,0)
 . S PAT("facility",IEN)=$P(X,U,1,3) ;stn# ^ name ^ last date
"RTN","VPRDPT",132,0)
 . I IEN=HOME S $P(PAT("facility",IEN),U,4)=1
"RTN","VPRDPT",133,0)
 Q
"RTN","VPRDPT",134,0)
 ;
"RTN","VPRDPT",135,0)
INPT ;-current inpt status data
"RTN","VPRDPT",136,0)
 N ADM,X
"RTN","VPRDPT",137,0)
 S ADM=+$G(^DPT(DFN,.105)) I ADM D
"RTN","VPRDPT",138,0)
 . N VAIN,VAERR,HLOC,SVC
"RTN","VPRDPT",139,0)
 . D INP^VADPT S PAT("admitted")=ADM_U_+VAIN(7)
"RTN","VPRDPT",140,0)
 . S PAT("ward")=VAIN(4),PAT("roomBed")=VAIN(5)
"RTN","VPRDPT",141,0)
 . S HLOC=+$G(^DIC(42,+VAIN(4),44)),SVC=$P($G(^(0)),U,3)
"RTN","VPRDPT",142,0)
 . S PAT("location")=HLOC_U_$P(VAIN(4),U,2)
"RTN","VPRDPT",143,0)
 . S:$L(SVC) PAT("locSvc")=SVC_U_$$EXTERNAL^DILFD(42,.03,,SVC)
"RTN","VPRDPT",144,0)
 . S PAT("specialty")=VAIN(3)
"RTN","VPRDPT",145,0)
 . S PAT("attending")=VAIN(11)
"RTN","VPRDPT",146,0)
 . S X=$$FAC^VPRD(HLOC),PAT("site")=X
"RTN","VPRDPT",147,0)
 S PAT("inpatient")=$S(ADM:"true",1:"false")
"RTN","VPRDPT",148,0)
 S X=$$OUTPTPR^SDUTL3(DFN) S:X PAT("pcProvider")=X
"RTN","VPRDPT",149,0)
 S X=$$OUTPTTM^SDUTL3(DFN) S:X PAT("pcTeam")=X
"RTN","VPRDPT",150,0)
 Q
"RTN","VPRDPT",151,0)
 ;
"RTN","VPRDPT",152,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPT",153,0)
 ;
"RTN","VPRDPT",154,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPT",155,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPT",156,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPT",157,0)
 D ADD("<patient>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPT",158,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",159,0)
 . I ATT="exposures" D:X["1"  S Y="" Q
"RTN","VPRDPT",160,0)
 .. S I=0,Y="<exposures>" D ADD(Y)
"RTN","VPRDPT",161,0)
 .. F ID="AO","IR","PG","HNC","MST","CV" S I=I+1 I $P(X,U,I) S Y="<exposure value='"_ID_"' />" D ADD(Y)
"RTN","VPRDPT",162,0)
 .. D ADD("</exposures>")
"RTN","VPRDPT",163,0)
 . I $L($O(ITEM(ATT,""))) D  Q  ;multiples
"RTN","VPRDPT",164,0)
 .. S ID=$S($E(ATT,$L(ATT))="s":ATT_"es",$E(ATT,$L(ATT))="y":$E(ATT,1,$L(ATT)-1)_"ies",1:ATT_"s")
"RTN","VPRDPT",165,0)
 .. D ADD("<"_ID_">")
"RTN","VPRDPT",166,0)
 .. S I="" F  S I=$O(ITEM(ATT,I)) Q:I=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",167,0)
 ... S X=ITEM(ATT,I),Y="<"_ATT_" "
"RTN","VPRDPT",168,0)
 ... I ATT="support" D  S Y="" Q
"RTN","VPRDPT",169,0)
 .... S Y=Y_"contactType='"_I_"' name='"_$$ESC^VPRD($P(X,U))_$S($L($P(X,U,2)):"' relationship='"_$$ESC^VPRD($P(X,U,2)),1:"")_"' >" D ADD(Y)
"RTN","VPRDPT",170,0)
 .... S X=$G(ITEM(ATT,I,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",171,0)
 .... S X=$G(ITEM(ATT,I,"telecom")) I $L(X) D PHONE(X)
"RTN","VPRDPT",172,0)
 .... D ADD("</support>")
"RTN","VPRDPT",173,0)
 ... I ATT="alias" S Y=Y_"fullName='"_$$ESC^VPRD(X)_$S(X[",":"' familyName='"_$$ESC^VPRD($P(X,","))_"' givenNames='"_$$ESC^VPRD($P(X,",",2,99)),1:"")_"' />" Q
"RTN","VPRDPT",174,0)
 ... I ATT="flag" S Y=Y_"name='"_$$ESC^VPRD($P(X,U))_"' text='"_$$ESC^VPRD($P(X,U,2))_"' />" Q
"RTN","VPRDPT",175,0)
 ... I ATT="facility" S Y=Y_"code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_$S($P(X,U,3):"' latestDate='"_$P($P(X,U,3),"."),1:"")_$S($P(X,U,4):"' homeSite='1",1:"")_"' />" Q
"RTN","VPRDPT",176,0)
 ... I ATT="disability" S Y=Y_"vaCode='"_I_"' printName='"_$$ESC^VPRD($P(X,U))_$S($P(X,U,3):"' sc='"_$P(X,U,3)_"' scPercent='"_$P(X,U,2),1:"")_"' />" Q
"RTN","VPRDPT",177,0)
 ... S Y=Y_"value='"_$$ESC^VPRD(ITEM(ATT,I))_"' />"
"RTN","VPRDPT",178,0)
 .. D ADD("</"_ID_">") S Y=""
"RTN","VPRDPT",179,0)
 . S X=$G(ITEM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPT",180,0)
 . I ATT="address" D ADDR(X) S Y="" Q
"RTN","VPRDPT",181,0)
 . I ATT="telecom" D PHONE(X) S Y="" Q
"RTN","VPRDPT",182,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPT",183,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPT",184,0)
 D ADD("</patient>")
"RTN","VPRDPT",185,0)
 Q
"RTN","VPRDPT",186,0)
 ;
"RTN","VPRDPT",187,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDPT",188,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDPT",189,0)
 S Y="<address"
"RTN","VPRDPT",190,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDPT",191,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDPT",192,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDPT",193,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDPT",194,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDPT",195,0)
 Q
"RTN","VPRDPT",196,0)
 ;
"RTN","VPRDPT",197,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDPT",198,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDPT",199,0)
 D ADD("<telecomList>")
"RTN","VPRDPT",200,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDPT",201,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDPT",202,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDPT",203,0)
 D ADD("</telecomList>")
"RTN","VPRDPT",204,0)
 Q
"RTN","VPRDPT",205,0)
 ;
"RTN","VPRDPT",206,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPT",207,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPT",208,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPT",209,0)
 Q
"RTN","VPRDPXHF")
0^24^B9504608
"RTN","VPRDPXHF",1,0)
VPRDPXHF ;SLC/MKB -- PCE Health Factors ;8/2/11  15:29
"RTN","VPRDPXHF",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPXHF",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXHF",4,0)
 ;
"RTN","VPRDPXHF",5,0)
 ; External References          DBIA#
"RTN","VPRDPXHF",6,0)
 ; -------------------          -----
"RTN","VPRDPXHF",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPXHF",8,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXHF",9,0)
 ; DILFD                         2055
"RTN","VPRDPXHF",10,0)
 ; DIQ                           2056
"RTN","VPRDPXHF",11,0)
 ; PXPXRM                        4250
"RTN","VPRDPXHF",12,0)
 ; XUAF4                         2171
"RTN","VPRDPXHF",13,0)
 ;
"RTN","VPRDPXHF",14,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPXHF",15,0)
 ;
"RTN","VPRDPXHF",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's health factors
"RTN","VPRDPXHF",17,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXHF",18,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPXHF",19,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXHF",20,0)
 ;
"RTN","VPRDPXHF",21,0)
 ; get one health factor
"RTN","VPRDPXHF",22,0)
 I $G(IFN) D  Q
"RTN","VPRDPXHF",23,0)
 . N HF,DATE K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",24,0)
 . S HF=0 F  S HF=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF)) Q:HF<1  D  Q:$D(VPRITM)
"RTN","VPRDPXHF",25,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXHF",26,0)
 ... S VPRIDT=9999999-DATE,^TMP("VPRHF",$J,VPRIDT,IFN)=HF_U_DATE
"RTN","VPRDPXHF",27,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXHF",28,0)
 ;
"RTN","VPRDPXHF",29,0)
 ; get all health factors
"RTN","VPRDPXHF",30,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXHF",31,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRHF",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXHF",32,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRHF",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXHF",33,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXHF",34,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXHF",35,0)
 K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",36,0)
 Q
"RTN","VPRDPXHF",37,0)
 ;
"RTN","VPRDPXHF",38,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRHF",$J,9999999-DATE,DA)=HF^DATE in range
"RTN","VPRDPXHF",39,0)
 ;  from ^PXRMINDX(9000010.23,"PI",DFN,HF,DATE,DA)
"RTN","VPRDPXHF",40,0)
 N HF,DATE,DA,IDT K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",41,0)
 S HF=0 F  S HF=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF)) Q:HF<1  D
"RTN","VPRDPXHF",42,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE)) Q:DATE<1  D
"RTN","VPRDPXHF",43,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXHF",44,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE,DA)) Q:DA<1  S ^TMP("VPRHF",$J,IDT,DA)=HF_U_DATE
"RTN","VPRDPXHF",45,0)
 Q
"RTN","VPRDPXHF",46,0)
 ;
"RTN","VPRDPXHF",47,0)
EN1(IEN,HF) ; -- return a health factor in HF("attribute")=value
"RTN","VPRDPXHF",48,0)
 ;  from EN: expects ^TMP("VPRHF",$J,VPRIDT,IEN)=HF^DATE
"RTN","VPRDPXHF",49,0)
 N VPRF,TMP,VISIT,X0,FAC,LOC,IENS,VPRH K HF
"RTN","VPRDPXHF",50,0)
 D VHF^PXPXRM(IEN,.VPRF)
"RTN","VPRDPXHF",51,0)
 S HF("id")=IEN,HF("severity")=$G(VPRF("VALUE"))
"RTN","VPRDPXHF",52,0)
 S TMP=$G(^TMP("VPRHF",$J,VPRIDT,IEN)),HF("recorded")=$P(TMP,U,2)
"RTN","VPRDPXHF",53,0)
 S HF("name")=$$EXTERNAL^DILFD(9000010.23,.01,,+TMP)
"RTN","VPRDPXHF",54,0)
 S HF("comment")=$G(VPRF("COMMENTS"))
"RTN","VPRDPXHF",55,0)
 S VISIT=$G(VPRF("VISIT")),HF("encounter")=VISIT
"RTN","VPRDPXHF",56,0)
 S X0=$G(^AUPNVSIT(+VISIT,0))
"RTN","VPRDPXHF",57,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXHF",58,0)
 S:FAC HF("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXHF",59,0)
 S:'FAC HF("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXHF",60,0)
 ;#9999999.64 additional data:
"RTN","VPRDPXHF",61,0)
 ;S IENS=+TMP_"," D GETS^DIQ(9999999.64,IENS,"*",,"VPRH")
"RTN","VPRDPXHF",62,0)
 ;S HF("gender")=$E(VPRH(9999999.64,IENS,.05))
"RTN","VPRDPXHF",63,0)
 ;S HF("lowerAge")=VPRH(9999999.64,IENS,.06)
"RTN","VPRDPXHF",64,0)
 ;S HF("upperAge")=VPRH(9999999.64,IENS,.07)
"RTN","VPRDPXHF",65,0)
 Q
"RTN","VPRDPXHF",66,0)
 ;
"RTN","VPRDPXHF",67,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXHF",68,0)
 ;
"RTN","VPRDPXHF",69,0)
XML(HF) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPXHF",70,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPXHF",71,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPXHF",72,0)
 D ADD("<factor>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXHF",73,0)
 S ATT="" F  S ATT=$O(HF(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXHF",74,0)
 . S X=$G(HF(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXHF",75,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXHF",76,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPXHF",77,0)
 D ADD("</factor>")
"RTN","VPRDPXHF",78,0)
 Q
"RTN","VPRDPXHF",79,0)
 ;
"RTN","VPRDPXHF",80,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXHF",81,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXHF",82,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXHF",83,0)
 Q
"RTN","VPRDPXIM")
0^15^B15857859
"RTN","VPRDPXIM",1,0)
VPRDPXIM ;SLC/MKB -- Immunizations extract ;8/2/11  15:29
"RTN","VPRDPXIM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDPXIM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXIM",4,0)
 ;
"RTN","VPRDPXIM",5,0)
 ; External References          DBIA#
"RTN","VPRDPXIM",6,0)
 ; -------------------          -----
"RTN","VPRDPXIM",7,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXIM",8,0)
 ; ^SC                          10040
"RTN","VPRDPXIM",9,0)
 ; ^VA(200                      10060
"RTN","VPRDPXIM",10,0)
 ; DILFD                         2055
"RTN","VPRDPXIM",11,0)
 ; DIQ                           2056
"RTN","VPRDPXIM",12,0)
 ; PXAPI                         1894
"RTN","VPRDPXIM",13,0)
 ; PXPXRM                        4250
"RTN","VPRDPXIM",14,0)
 ; XUAF4                         2171
"RTN","VPRDPXIM",15,0)
 ; 
"RTN","VPRDPXIM",16,0)
 ; ------------ Get immunizations from VistA ------------
"RTN","VPRDPXIM",17,0)
 ;
"RTN","VPRDPXIM",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's immunizations
"RTN","VPRDPXIM",19,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXIM",20,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDPXIM",21,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXIM",22,0)
 ;
"RTN","VPRDPXIM",23,0)
 ; get one immunization
"RTN","VPRDPXIM",24,0)
 I $G(IFN) D  Q
"RTN","VPRDPXIM",25,0)
 . N IMZ,DATE K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",26,0)
 . S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D  Q:$D(VPRITM)
"RTN","VPRDPXIM",27,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXIM",28,0)
 ... S VPRIDT=9999999-DATE,VPRN=IFN
"RTN","VPRDPXIM",29,0)
 ... S ^TMP("VPRIMM",$J,VPRIDT,IFN)=IMZ_U_DATE ;SORT node
"RTN","VPRDPXIM",30,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXIM",31,0)
 . K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",32,0)
 ;
"RTN","VPRDPXIM",33,0)
 ; get all immunizations
"RTN","VPRDPXIM",34,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXIM",35,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRIMM",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",36,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRIMM",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXIM",37,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXIM",38,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXIM",39,0)
 K ^TMP("VPRIMM",$J),^TMP("PXKENC",$J)
"RTN","VPRDPXIM",40,0)
 Q
"RTN","VPRDPXIM",41,0)
 ;
"RTN","VPRDPXIM",42,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRIMM",$J,9999999-DATE,DA)=IMM^DATE in range
"RTN","VPRDPXIM",43,0)
 ;  from ^PXRMINDX(9000010.11,"PI",DFN,IMM,DATE,DA)
"RTN","VPRDPXIM",44,0)
 N IMZ,DATE,DA,IDT K ^TMP("VPRIMM",$J)
"RTN","VPRDPXIM",45,0)
 S IMZ=0 F  S IMZ=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ)) Q:IMZ<1  D
"RTN","VPRDPXIM",46,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE)) Q:DATE<1  D
"RTN","VPRDPXIM",47,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXIM",48,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.11,"PI",+$G(DFN),IMZ,DATE,DA)) Q:DA<1  S ^TMP("VPRIMM",$J,IDT,DA)=IMZ_U_DATE
"RTN","VPRDPXIM",49,0)
 Q
"RTN","VPRDPXIM",50,0)
 ;
"RTN","VPRDPXIM",51,0)
EN1(IEN,IMM) ; -- return an immunization in IMM("attribute")=value
"RTN","VPRDPXIM",52,0)
 ; Expects ^TMP("VPRIMM",$J,VPRIDT,VPRN)=IMM^DATE from EN/SORT
"RTN","VPRDPXIM",53,0)
 N TMP,VPRM,VISIT,X0,FAC,LOC,X12,X,I K IMM
"RTN","VPRDPXIM",54,0)
 S TMP=$G(^TMP("VPRIMM",$J,VPRIDT,VPRN))
"RTN","VPRDPXIM",55,0)
 S IMM("id")=IEN,IMM("administered")=+$P(TMP,U,2)
"RTN","VPRDPXIM",56,0)
 S IMM("name")=$$EXTERNAL^DILFD(9000010.11,.01,,+TMP)
"RTN","VPRDPXIM",57,0)
 D VIMM^PXPXRM(IEN,.VPRM)
"RTN","VPRDPXIM",58,0)
 S X=$G(VPRM("SERIES")),IMM("series")=$$EXTERNAL^DILFD(9000010.11,.04,,X)
"RTN","VPRDPXIM",59,0)
 S X=$G(VPRM("REACTION")),IMM("reaction")=$$EXTERNAL^DILFD(9000010.11,.06,,X)
"RTN","VPRDPXIM",60,0)
 S IMM("contraindicated")=+$G(VPRM("CONTRAINDICATED"))
"RTN","VPRDPXIM",61,0)
 S IMM("comment")=$G(VPRM("COMMENTS"))
"RTN","VPRDPXIM",62,0)
 S VISIT=+$G(VPRM("VISIT")),IMM("encounter")=VISIT
"RTN","VPRDPXIM",63,0)
 I '$D(^TMP("PXKENC",$J,VISIT)) D ENCEVENT^PXAPI(VISIT,1)
"RTN","VPRDPXIM",64,0)
 S X0=$G(^TMP("PXKENC",$J,VISIT,"VST",VISIT,0))
"RTN","VPRDPXIM",65,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXIM",66,0)
 S:FAC IMM("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXIM",67,0)
 S:'FAC IMM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXIM",68,0)
 S IMM("location")=$P($G(^SC(LOC,0)),U)
"RTN","VPRDPXIM",69,0)
 S X12=$G(^TMP("PXKENC",$J,VISIT,"IMM",IEN,12))
"RTN","VPRDPXIM",70,0)
 S X=$P(X12,U,4) S:'X X=$P(X12,U,2)
"RTN","VPRDPXIM",71,0)
 I 'X S I=0 F  S I=$O(^TMP("PXKENC",$J,VISIT,"PRV",I)) Q:I<1  I $P($G(^(I,0)),U,4)="P" S X=+^(0) Q
"RTN","VPRDPXIM",72,0)
 S:X IMM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPXIM",73,0)
 ; CPT mapping
"RTN","VPRDPXIM",74,0)
 S X=+$$FIND1^DIC(811.1,,"QX",IEN_";AUTTIMM(","B") I X>0 D
"RTN","VPRDPXIM",75,0)
 . S Y=$$GET1^DIQ(811.1,X_",",.02,"I") Q:Y<1
"RTN","VPRDPXIM",76,0)
 . N CPT S CPT=$G(@(U_$P(Y,";",2)_+Y_",0)"))
"RTN","VPRDPXIM",77,0)
 . S IMM("cpt")=$P(CPT,U,1,2)
"RTN","VPRDPXIM",78,0)
 Q
"RTN","VPRDPXIM",79,0)
 ;
"RTN","VPRDPXIM",80,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXIM",81,0)
 ;
"RTN","VPRDPXIM",82,0)
XML(IMM) ; -- Return immunizations as XML
"RTN","VPRDPXIM",83,0)
 N ATT,X,Y,I,P,NAMES,TAG
"RTN","VPRDPXIM",84,0)
 D ADD("<immunization>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXIM",85,0)
 S ATT="" F  S ATT=$O(IMM(ATT)) Q:ATT=""  D
"RTN","VPRDPXIM",86,0)
 . S X=$G(IMM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXIM",87,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDPXIM",88,0)
 . I $L(X)>1 D
"RTN","VPRDPXIM",89,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDPXIM",90,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPXIM",91,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDPXIM",92,0)
 D ADD("</immunization>")
"RTN","VPRDPXIM",93,0)
 Q
"RTN","VPRDPXIM",94,0)
 ;
"RTN","VPRDPXIM",95,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPXIM",96,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXIM",97,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXIM",98,0)
 Q
"RTN","VPRDRA")
0^16^B39795192
"RTN","VPRDRA",1,0)
VPRDRA ;SLC/MKB -- Radiology extract ;8/2/11  15:29
"RTN","VPRDRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDRA",4,0)
 ;
"RTN","VPRDRA",5,0)
 ; External References          DBIA#
"RTN","VPRDRA",6,0)
 ; -------------------          -----
"RTN","VPRDRA",7,0)
 ; ^RADPT                        2480
"RTN","VPRDRA",8,0)
 ; ^RARPT                        5605
"RTN","VPRDRA",9,0)
 ; ^SC(                         10040
"RTN","VPRDRA",10,0)
 ; ^VA(200                      10060
"RTN","VPRDRA",11,0)
 ; DIQ                           2056
"RTN","VPRDRA",12,0)
 ; ICPTCOD                       1995
"RTN","VPRDRA",13,0)
 ; RAO7PC1                  2043,2265
"RTN","VPRDRA",14,0)
 ; RAO7PC3                       2877
"RTN","VPRDRA",15,0)
 ;
"RTN","VPRDRA",16,0)
 ; ------------ Get exam(s) from VistA ------------
"RTN","VPRDRA",17,0)
 ;
"RTN","VPRDRA",18,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's radiology exams
"RTN","VPRDRA",19,0)
 N VPRITM,VPRXID
"RTN","VPRDRA",20,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",21,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",22,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",23,0)
 ;
"RTN","VPRDRA",24,0)
 ; get exam(s)
"RTN","VPRDRA",25,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDRA",26,0)
 ;
"RTN","VPRDRA",27,0)
 ; get all exams
"RTN","VPRDRA",28,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",29,0)
 . K VPRITM D EN1(VPRXID,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDRA",30,0)
 . D XML(.VPRITM)
"RTN","VPRDRA",31,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDRA",32,0)
 Q
"RTN","VPRDRA",33,0)
 ;
"RTN","VPRDRA",34,0)
EN1(ID,EXAM) ; -- return an exam in EXAM("attribute")=value
"RTN","VPRDRA",35,0)
 ;   Expects ^TMP($J,"RAE1",DFN,ID) from EN1^RAO7PC1
"RTN","VPRDRA",36,0)
 N X0,SET,PROC,DATE,LOC,X,Y,IENS K EXAM
"RTN","VPRDRA",37,0)
 S X0=$G(^TMP($J,"RAE1",DFN,ID)),SET=$G(^(ID,"CPRS")),PROC=$P(X0,U)
"RTN","VPRDRA",38,0)
 S EXAM("id")=ID,EXAM("name")=PROC,EXAM("case")=$P(X0,U,2)
"RTN","VPRDRA",39,0)
 S DATE=9999999.9999-+ID,EXAM("dateTime")=DATE
"RTN","VPRDRA",40,0)
 I $P(X0,U,5) D  ;report exists
"RTN","VPRDRA",41,0)
 . N NM S NM=$S(+SET=2:$P(SET,U,2),1:PROC)     ;2 = shared report
"RTN","VPRDRA",42,0)
 . S EXAM("document",1)=ID_U_NM_"^^"_$P(X0,U,3) ;id^localTitle^^status
"RTN","VPRDRA",43,0)
 . S:$G(VPRTEXT) EXAM("document",1,"content")=$$TEXT(DFN,ID)
"RTN","VPRDRA",44,0)
 S:$L($P(X0,U,6)) EXAM("status")=$P($P(X0,U,6),"~",2)
"RTN","VPRDRA",45,0)
 S X=$P(X0,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",46,0)
 . S LOC=+$O(^SC("B",X,0)),EXAM("location")=LOC_U_X
"RTN","VPRDRA",47,0)
 S EXAM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",48,0)
 I $L($P(X0,U,8)) S X=$TR($P(X0,U,8),"~","^"),EXAM("imagingType")=X
"RTN","VPRDRA",49,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",50,0)
 S X=$P(X0,U,10) I X D
"RTN","VPRDRA",51,0)
 . S EXAM("type")=$$CPT(X)
"RTN","VPRDRA",52,0)
 . I $D(^TMP($J,"RAE1",DFN,ID,"CMOD")) M EXAM("modifier")=^("CMOD")
"RTN","VPRDRA",53,0)
 I $P(X0,U,11) S EXAM("order")=+$P(X0,U,11)_U_$S($L(SET):$P(SET,U,2),1:PROC)
"RTN","VPRDRA",54,0)
 S EXAM("hasImages")=$S($P(X0,U,12)="Y":1,1:0)
"RTN","VPRDRA",55,0)
 I $P(X0,U,4)="Y"!($P(X0,U,9)="Y") S EXAM("interpretation")="ABNORMAL"
"RTN","VPRDRA",56,0)
 S EXAM("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",57,0)
 S ID=DFN_U_$TR(ID,"-","^") D EN3^RAO7PC1(ID) D  ;get additional values
"RTN","VPRDRA",58,0)
 . S X=+$G(^TMP($J,"RAE2",DFN,+$P(ID,U,3),PROC,"P"))
"RTN","VPRDRA",59,0)
 . I X S EXAM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDRA",60,0)
 S EXAM("category")="RA"
"RTN","VPRDRA",61,0)
 Q
"RTN","VPRDRA",62,0)
 ;
"RTN","VPRDRA",63,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDRA",64,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDRA",65,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDRA",66,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDRA",67,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDRA",68,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDRA",69,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDRA",70,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDRA",71,0)
 . S $P(Y,U,2)=X
"RTN","VPRDRA",72,0)
 Q Y
"RTN","VPRDRA",73,0)
 ;
"RTN","VPRDRA",74,0)
TEXT(PAT,ID) ; -- Return report as a text string
"RTN","VPRDRA",75,0)
 S PAT=+$G(PAT),ID=$G(ID) I PAT<1!(ID<1) Q ""
"RTN","VPRDRA",76,0)
 N DFN,EXAM,CASE,PROC,I,X,Y
"RTN","VPRDRA",77,0)
 S EXAM=PAT_U_$TR(ID,"-","^") D EN3^RAO7PC3(EXAM)
"RTN","VPRDRA",78,0)
 S CASE=$O(^TMP($J,"RAE3",PAT,0)),PROC=$O(^(CASE,""))
"RTN","VPRDRA",79,0)
 S I=$O(^TMP($J,"RAE3",PAT,CASE,PROC,0)),Y=$G(^(I))
"RTN","VPRDRA",80,0)
 F  S I=$O(^TMP($J,"RAE3",PAT,CASE,PROC,I)) Q:I<1  S X=^(I),Y=Y_$C(13,10)_X
"RTN","VPRDRA",81,0)
 Q Y
"RTN","VPRDRA",82,0)
 ;
"RTN","VPRDRA",83,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDRA",84,0)
 ;
"RTN","VPRDRA",85,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's radiology reports
"RTN","VPRDRA",86,0)
 N VPRITM,VPRXID,STS,PSET
"RTN","VPRDRA",87,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",88,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",89,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",90,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",91,0)
 . S STS=$P($G(^TMP($J,"RAE1",DFN,VPRXID)),U,3),PSET=$G(^(VPRXID,"CPRS"))
"RTN","VPRDRA",92,0)
 . Q:STS="No Report"!(STS="Deleted")  ;!(STS["Draft") ??
"RTN","VPRDRA",93,0)
 . I +PSET=2,$G(PSET(+VPRXID,$P(PSET,U,2))) Q  ;already have report
"RTN","VPRDRA",94,0)
 . K VPRITM D RPT1(DFN,VPRXID,.VPRITM) D:$D(VPRITM) XML^VPRDTIU(.VPRITM)
"RTN","VPRDRA",95,0)
 . I +PSET=2 S PSET(+VPRXID,$P(PSET,U,2))=$P(VPRXID,"-",2) ;parent
"RTN","VPRDRA",96,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDRA",97,0)
 Q
"RTN","VPRDRA",98,0)
 ;
"RTN","VPRDRA",99,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDRA",100,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:ID<1
"RTN","VPRDRA",101,0)
 N EXAM,CASE,PROC,RAE3,RAE1,I,X,Y,IENS,LOC
"RTN","VPRDRA",102,0)
 S EXAM=DFN_U_$TR(ID,"-","^") D
"RTN","VPRDRA",103,0)
 . N DFN D EN3^RAO7PC3(EXAM) ;report
"RTN","VPRDRA",104,0)
 . D EN3^RAO7PC1(EXAM)       ;add'l values
"RTN","VPRDRA",105,0)
 S CASE=$O(^TMP($J,"RAE3",DFN,0)),PROC=$O(^(CASE,"")),RAE3=$G(^(PROC))
"RTN","VPRDRA",106,0)
 S RAE1=$G(^TMP($J,"RAE1",DFN,ID))
"RTN","VPRDRA",107,0)
 I $G(VPRTEXT) D
"RTN","VPRDRA",108,0)
 . S I=$O(^TMP($J,"RAE3",DFN,CASE,PROC,0)),Y=$G(^(I))
"RTN","VPRDRA",109,0)
 . F  S I=$O(^TMP($J,"RAE3",DFN,CASE,PROC,I)) Q:I<1  S X=^(I),Y=Y_$C(13,10)_X
"RTN","VPRDRA",110,0)
 . S RPT("content")=Y
"RTN","VPRDRA",111,0)
 S RPT("id")=ID,RPT("status")=$P(RAE3,U)
"RTN","VPRDRA",112,0)
 S X=9999999.9999-(+ID),RPT("referenceDateTime")=X
"RTN","VPRDRA",113,0)
 S X=+$G(^TMP($J,"RAE2",DFN,CASE,PROC,"P"))
"RTN","VPRDRA",114,0)
 I X S RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A"
"RTN","VPRDRA",115,0)
 S X=$G(^TMP($J,"RAE2",DFN,CASE,PROC,"V")) I X D
"RTN","VPRDRA",116,0)
 . N Y S Y=$$GET1^DIQ(74,+$P(RAE1,U,5)_",",7,"I")
"RTN","VPRDRA",117,0)
 . S RPT("clinician",2)=+X_U_$P($G(^VA(200,+X,0)),U)_"^S^"_Y_U_$P(X,U,2)
"RTN","VPRDRA",118,0)
 I $D(^TMP($J,"RAE3",DFN,"PRINT_SET")) S PROC=$G(^("ORD")) ;use parent, if printset
"RTN","VPRDRA",119,0)
 S RPT("localTitle")=PROC,RPT("type")="RA"
"RTN","VPRDRA",120,0)
 S RPT("nationalTitle")="4695068^RADIOLOGY REPORT"
"RTN","VPRDRA",121,0)
 S RPT("nationalTitleSubject")="4693357^RADIOLOGY"
"RTN","VPRDRA",122,0)
 S RPT("nationalTitleType")="4696123^REPORT"
"RTN","VPRDRA",123,0)
 S X=$P(RAE1,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",124,0)
 . S LOC=+$O(^SC("B",X,0)) ;,EXAM("location")=LOC_U_X
"RTN","VPRDRA",125,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",126,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",127,0)
 S RPT("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",128,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDRA",129,0)
 K ^TMP($J,"RAE3",DFN),^TMP($J,"RAE2",DFN)
"RTN","VPRDRA",130,0)
 Q
"RTN","VPRDRA",131,0)
 ;
"RTN","VPRDRA",132,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDRA",133,0)
 ;
"RTN","VPRDRA",134,0)
XML(EXAM) ; -- Return exams as XML
"RTN","VPRDRA",135,0)
 N ATT,X,Y,NAMES
"RTN","VPRDRA",136,0)
 D ADD("<radiology>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDRA",137,0)
 S ATT="" F  S ATT=$O(EXAM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDRA",138,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^status^Z",1:"code^name^Z")
"RTN","VPRDRA",139,0)
 . I $O(EXAM(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDRA",140,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDRA",141,0)
 .. S I=0 F  S I=$O(EXAM(ATT,I)) Q:I<1  D
"RTN","VPRDRA",142,0)
 ... S X=$G(EXAM(ATT,I))
"RTN","VPRDRA",143,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDRA",144,0)
 ... S X=$G(EXAM(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDRA",145,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDRA",146,0)
 ... S Y="<content xml:space='preserve'>"_$$ESC^VPRD(X)_"</content>"
"RTN","VPRDRA",147,0)
 ... D ADD(Y),ADD("</"_ATT_">")
"RTN","VPRDRA",148,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDRA",149,0)
 . S X=$G(EXAM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDRA",150,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDRA",151,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDRA",152,0)
 D ADD("</radiology>")
"RTN","VPRDRA",153,0)
 Q
"RTN","VPRDRA",154,0)
 ;
"RTN","VPRDRA",155,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDRA",156,0)
 N STR,P,TAG S STR=""
"RTN","VPRDRA",157,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDRA",158,0)
 Q STR
"RTN","VPRDRA",159,0)
 ;
"RTN","VPRDRA",160,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDRA",161,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDRA",162,0)
 S @VPR@(VPRI)=X
"RTN","VPRDRA",163,0)
 Q
"RTN","VPRDSDAM")
0^17^B9762566
"RTN","VPRDSDAM",1,0)
VPRDSDAM ;SLC/MKB -- Appointment extract ;8/2/11  15:29
"RTN","VPRDSDAM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDSDAM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSDAM",4,0)
 ;
"RTN","VPRDSDAM",5,0)
 ; External References          DBIA#
"RTN","VPRDSDAM",6,0)
 ; -------------------          -----
"RTN","VPRDSDAM",7,0)
 ; DIQ                           2056
"RTN","VPRDSDAM",8,0)
 ; SDAMA301                      4433
"RTN","VPRDSDAM",9,0)
 ; VADPT                        10061
"RTN","VPRDSDAM",10,0)
 ;
"RTN","VPRDSDAM",11,0)
 ; ------------ Get appointment(s) from VistA ------------
"RTN","VPRDSDAM",12,0)
 ;
"RTN","VPRDSDAM",13,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's [future] appointments
"RTN","VPRDSDAM",14,0)
 N VPRX,VPRNUM,VPRDT,VPRCNT,VPRITM,X
"RTN","VPRDSDAM",15,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSDAM",16,0)
 S BEG=$G(BEG,DT),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSDAM",17,0)
 S VPRX(1)=BEG_";"_END,VPRX(4)=DFN,VPRX("FLDS")="1;2;3;10",VPRX("SORT")="P"
"RTN","VPRDSDAM",18,0)
 ;
"RTN","VPRDSDAM",19,0)
 ; get one appt
"RTN","VPRDSDAM",20,0)
 I $L($G(ID)) D  Q
"RTN","VPRDSDAM",21,0)
 . S (BEG,END)=$P(ID,";",2),VPRX(1)=BEG_";"_END,VPRX(2)=$P(ID,";",3)
"RTN","VPRDSDAM",22,0)
 . S VPRNUM=$$SDAPI^SDAMA301(.VPRX) Q:VPRNUM<1
"RTN","VPRDSDAM",23,0)
 . D EN1(BEG,.VPRITM),XML(.VPRITM)
"RTN","VPRDSDAM",24,0)
 . K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",25,0)
 ;
"RTN","VPRDSDAM",26,0)
 ; get all [future] appointments
"RTN","VPRDSDAM",27,0)
 S VPRX(3)="R;I;NS;NSR;NT" ;no cancelled appt's
"RTN","VPRDSDAM",28,0)
 S VPRNUM=$$SDAPI^SDAMA301(.VPRX),(VPRDT,VPRCNT)=0
"RTN","VPRDSDAM",29,0)
 F  S VPRDT=$O(^TMP($J,"SDAMA301",DFN,VPRDT)) Q:VPRDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDSDAM",30,0)
 . S X=$P($G(^TMP($J,"SDAMA301",DFN,VPRDT)),U,3)
"RTN","VPRDSDAM",31,0)
 . I VPRDT<DT,$P(X,";")'["NS" Q   ;no prior kept appt's
"RTN","VPRDSDAM",32,0)
 . K VPRITM D EN1(VPRDT,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDSDAM",33,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDSDAM",34,0)
 K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",35,0)
 Q
"RTN","VPRDSDAM",36,0)
 ;
"RTN","VPRDSDAM",37,0)
EN1(DATE,APPT) ; -- return an appointment in APPT("attribute")=value
"RTN","VPRDSDAM",38,0)
 ;  Expects ^TMP($J,"SDAMA301",DFN,DATE)
"RTN","VPRDSDAM",39,0)
 N X,HLOC,STS,CLS,SV,CSC,CSN K APPT
"RTN","VPRDSDAM",40,0)
 S X=$G(^TMP($J,"SDAMA301",DFN,DATE))
"RTN","VPRDSDAM",41,0)
 S DATE=+$G(DATE),HLOC=$P(X,U,2),STS=$P(X,U,3),CLS=$S($E(STS)="I":"I",1:"O")
"RTN","VPRDSDAM",42,0)
 S APPT("id")="A;"_DATE_";"_+HLOC,APPT("dateTime")=DATE I HLOC D
"RTN","VPRDSDAM",43,0)
 . S APPT("location")=$P(HLOC,";",2)
"RTN","VPRDSDAM",44,0)
 . S CSC=$$GET1^DIQ(44,+HLOC_",",8,"I")
"RTN","VPRDSDAM",45,0)
 . S CSN=$$GET1^DIQ(44,+HLOC_",",8,"E")
"RTN","VPRDSDAM",46,0)
 . S APPT("clinicStop")=CSC_"^"_CSN
"RTN","VPRDSDAM",47,0)
 . ;S APPT("type")=U_$P(HLOC,";",2)_" APPOINTMENT"
"RTN","VPRDSDAM",48,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDSDAM",49,0)
 . I SV S APPT("service")=$$SERV(SV)
"RTN","VPRDSDAM",50,0)
 S APPT("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDSDAM",51,0)
 S APPT("type")=$TR($P(X,U,10),";","^")
"RTN","VPRDSDAM",52,0)
 S APPT("patientClass")=$S(CLS="I":"IMP",1:"AMB")
"RTN","VPRDSDAM",53,0)
 S APPT("serviceCategory")=$S(CLS="I":"I^INPATIENT VISIT",1:"A^AMBULATORY")
"RTN","VPRDSDAM",54,0)
 S APPT("apptStatus")=$P(STS,";",2)
"RTN","VPRDSDAM",55,0)
 S APPT("visitString")=+HLOC_";"_DATE_";A"
"RTN","VPRDSDAM",56,0)
 Q
"RTN","VPRDSDAM",57,0)
 ;
"RTN","VPRDSDAM",58,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDSDAM",59,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDSDAM",60,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDSDAM",61,0)
 Q Y
"RTN","VPRDSDAM",62,0)
 ;
"RTN","VPRDSDAM",63,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSDAM",64,0)
 ;
"RTN","VPRDSDAM",65,0)
XML(APPT) ; -- Return appointment as XML
"RTN","VPRDSDAM",66,0)
 N ATT,X,Y,NAMES
"RTN","VPRDSDAM",67,0)
 D ADD("<appointment>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSDAM",68,0)
 S ATT="" F  S ATT=$O(APPT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSDAM",69,0)
 . S X=$G(APPT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSDAM",70,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSDAM",71,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSDAM",72,0)
 D ADD("</appointment>")
"RTN","VPRDSDAM",73,0)
 Q
"RTN","VPRDSDAM",74,0)
 ;
"RTN","VPRDSDAM",75,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSDAM",76,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSDAM",77,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSDAM",78,0)
 Q STR
"RTN","VPRDSDAM",79,0)
 ;
"RTN","VPRDSDAM",80,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSDAM",81,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSDAM",82,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSDAM",83,0)
 Q
"RTN","VPRDSR")
0^18^B29738621
"RTN","VPRDSR",1,0)
VPRDSR ;SLC/MKB -- Surgical Procedures ;8/2/11  15:29
"RTN","VPRDSR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDSR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSR",4,0)
 ;
"RTN","VPRDSR",5,0)
 ; External References          DBIA#
"RTN","VPRDSR",6,0)
 ; -------------------          -----
"RTN","VPRDSR",7,0)
 ; ^SRF(130                      5675
"RTN","VPRDSR",8,0)
 ; ^SRO(136                      4872
"RTN","VPRDSR",9,0)
 ; DIQ                           2056
"RTN","VPRDSR",10,0)
 ; ICPTCOD                       1995
"RTN","VPRDSR",11,0)
 ; ICPTMOD                       1996
"RTN","VPRDSR",12,0)
 ; SROESTV                       3533
"RTN","VPRDSR",13,0)
 ; TIUSRVR1                      2944
"RTN","VPRDSR",14,0)
 ;
"RTN","VPRDSR",15,0)
 ; ------------ Get surgery(ies) from VistA ------------
"RTN","VPRDSR",16,0)
 ;
"RTN","VPRDSR",17,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's surgeries
"RTN","VPRDSR",18,0)
 N VPRN,VPRCNT,VPRITM,VPRY
"RTN","VPRDSR",19,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSR",20,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSR",21,0)
 ;
"RTN","VPRDSR",22,0)
 ; get one surgery
"RTN","VPRDSR",23,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDSR",24,0)
 ;
"RTN","VPRDSR",25,0)
 ; get all surgeries
"RTN","VPRDSR",26,0)
 Q:'$L($T(LIST^SROESTV))
"RTN","VPRDSR",27,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",28,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDSR",29,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDSR",30,0)
 . K VPRITM D ONE(VPRN,.VPRITM)
"RTN","VPRDSR",31,0)
 . I $D(VPRITM) D XML(.VPRITM)
"RTN","VPRDSR",32,0)
 K @VPRY
"RTN","VPRDSR",33,0)
 Q
"RTN","VPRDSR",34,0)
 ;
"RTN","VPRDSR",35,0)
ONE(NUM,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",36,0)
 ;  Expects DFN, @VPRY@(NUM) from LIST^SROESTV
"RTN","VPRDSR",37,0)
 N IEN,VPRX,X,Y,I,VPRMOD,VPROTH
"RTN","VPRDSR",38,0)
 S VPRX=$G(@VPRY@(NUM))
"RTN","VPRDSR",39,0)
 S IEN=+$P(VPRX,U) Q:IEN<1  K SURG
"RTN","VPRDSR",40,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",41,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",42,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",43,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")
"RTN","VPRDSR",44,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",45,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",46,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",47,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",48,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",49,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",50,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",51,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",52,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",53,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",54,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",55,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",56,0)
 S I=0 F  S I=$O(@VPRY@(NUM,I)) Q:I<1  S X=$G(@VPRY@(NUM,I)) I X D
"RTN","VPRDSR",57,0)
 . N LT,NT S LT=$P(X,U,2) Q:$P(LT," ")="Addendum"
"RTN","VPRDSR",58,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501")
"RTN","VPRDSR",59,0)
 . S SURG("document",I)=+X_U_LT_U_NT
"RTN","VPRDSR",60,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",61,0)
 . I LT["OPERATION REPORT"!(LT["PROCEDURE REPORT") S SURG("opReport")=+X_U_LT_U_NT
"RTN","VPRDSR",62,0)
 S SURG("category")="SR"
"RTN","VPRDSR",63,0)
 Q
"RTN","VPRDSR",64,0)
 ;
"RTN","VPRDSR",65,0)
EN1(IEN,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",66,0)
 N VPRX,VPRY,X,Y,I,VPRMOD,VPROTH,SHOWADD
"RTN","VPRDSR",67,0)
 S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",68,0)
 D ONE^SROESTV("VPRY",IEN) S VPRX=$G(VPRY(IEN)) Q:VPRX=""
"RTN","VPRDSR",69,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",70,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",71,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",72,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")
"RTN","VPRDSR",73,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",74,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",75,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",76,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",77,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",78,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",79,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",80,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",81,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",82,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",83,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",84,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",85,0)
 S I=0 F  S I=$O(VPRY(IEN,I)) Q:I<1  S X=$G(VPRY(IEN,I)) I X D
"RTN","VPRDSR",86,0)
 . N LT,NT S LT=$P(X,U,2) Q:$P(LT," ")="Addendum"
"RTN","VPRDSR",87,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501")
"RTN","VPRDSR",88,0)
 . S SURG("document",I)=+X_U_LT_U_NT
"RTN","VPRDSR",89,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",90,0)
 . I LT["OPERATION REPORT"!(LT["PROCEDURE REPORT") S SURG("opReport")=+X_U_LT_U_NT
"RTN","VPRDSR",91,0)
 S SURG("category")="SR"
"RTN","VPRDSR",92,0)
 Q
"RTN","VPRDSR",93,0)
 ;
"RTN","VPRDSR",94,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDSR",95,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDSR",96,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDSR",97,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDSR",98,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDSR",99,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDSR",100,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDSR",101,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDSR",102,0)
 . S $P(Y,U,2)=X
"RTN","VPRDSR",103,0)
 Q Y
"RTN","VPRDSR",104,0)
 ;
"RTN","VPRDSR",105,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSR",106,0)
 ;
"RTN","VPRDSR",107,0)
XML(SURG) ; -- Return surgery as XML
"RTN","VPRDSR",108,0)
 N ATT,X,Y,NAMES
"RTN","VPRDSR",109,0)
 D ADD("<surgery>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSR",110,0)
 S ATT="" F  S ATT=$O(SURG(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSR",111,0)
 . I $O(SURG(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDSR",112,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDSR",113,0)
 .. S I=0 F  S I=$O(SURG(ATT,I)) Q:I<1  D
"RTN","VPRDSR",114,0)
 ... S X=$G(SURG(ATT,I)),NAMES=""
"RTN","VPRDSR",115,0)
 ... S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDSR",116,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDSR",117,0)
 ... S X=$G(SURG(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDSR",118,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDSR",119,0)
 ... S Y="<content xml:space='preserve'>"_$$ESC^VPRD(X)_"</content>"
"RTN","VPRDSR",120,0)
 ... D ADD(Y),ADD("</"_ATT_">")
"RTN","VPRDSR",121,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDSR",122,0)
 . S X=$G(SURG(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSR",123,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSR",124,0)
 . S NAMES=$S(ATT="opReport":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDSR",125,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSR",126,0)
 D ADD("</surgery>")
"RTN","VPRDSR",127,0)
 Q
"RTN","VPRDSR",128,0)
 ;
"RTN","VPRDSR",129,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSR",130,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSR",131,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSR",132,0)
 Q STR
"RTN","VPRDSR",133,0)
 ;
"RTN","VPRDSR",134,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSR",135,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSR",136,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSR",137,0)
 Q
"RTN","VPRDSR",138,0)
 ;
"RTN","VPRDSR",139,0)
RPT(VPRY,ID) ; -- Return report in VPRY(n)
"RTN","VPRDSR",140,0)
 S ID=+$G(ID) Q:ID<1
"RTN","VPRDSR",141,0)
 D TGET^TIUSRVR1(.VPRY,ID)
"RTN","VPRDSR",142,0)
 Q
"RTN","VPRDTIU")
0^19^B61120410
"RTN","VPRDTIU",1,0)
VPRDTIU ;SLC/MKB -- TIU extract ;8/2/11  15:29
"RTN","VPRDTIU",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDTIU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTIU",4,0)
 ;
"RTN","VPRDTIU",5,0)
 ; External References          DBIA#
"RTN","VPRDTIU",6,0)
 ; -------------------          -----
"RTN","VPRDTIU",7,0)
 ; ^SC(                         10040
"RTN","VPRDTIU",8,0)
 ; ^TIU(8925.1              2321,5677
"RTN","VPRDTIU",9,0)
 ; ^TIU(8926.1                   5678
"RTN","VPRDTIU",10,0)
 ; ^VA(200                      10060
"RTN","VPRDTIU",11,0)
 ; DIQ                           2056
"RTN","VPRDTIU",12,0)
 ; TIUCNSLT                      5546
"RTN","VPRDTIU",13,0)
 ; TIUCP                         3568
"RTN","VPRDTIU",14,0)
 ; TIULQ                         2693
"RTN","VPRDTIU",15,0)
 ; TIULX                         3058
"RTN","VPRDTIU",16,0)
 ; TIUSROI                       5676
"RTN","VPRDTIU",17,0)
 ; TIUSRVLO                 2834,2865
"RTN","VPRDTIU",18,0)
 ; TIUSRVR1                      2944
"RTN","VPRDTIU",19,0)
 ;
"RTN","VPRDTIU",20,0)
 ; ------------ Get documents from VistA ------------
"RTN","VPRDTIU",21,0)
 ;
"RTN","VPRDTIU",22,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's documents
"RTN","VPRDTIU",23,0)
 N VPRITM,VPRN,VPRX,VPRY,VPRCNT
"RTN","VPRDTIU",24,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDTIU",25,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDTIU",26,0)
 ;
"RTN","VPRDTIU",27,0)
 ; get one document
"RTN","VPRDTIU",28,0)
 I $L($G(ID)),ID[";" D RPT1^VPRDLRA(DFN,ID,.VPRITM),XML(.VPRITM) Q  ;Lab
"RTN","VPRDTIU",29,0)
 I $G(ID),ID["-" D  Q  ;Radiology
"RTN","VPRDTIU",30,0)
 . S (BEG,END)=9999999.9999-+ID D EN1^RAO7PC1(DFN,BEG,END,"99P")
"RTN","VPRDTIU",31,0)
 . D RPT1^VPRDRA(DFN,ID,.VPRITM),XML(.VPRITM)
"RTN","VPRDTIU",32,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDTIU",33,0)
 I $G(ID) D  Q
"RTN","VPRDTIU",34,0)
 . N SHOWADD S SHOWADD=1
"RTN","VPRDTIU",35,0)
 . S VPRX=ID_U_$$RESOLVE^TIUSRVLO(ID)
"RTN","VPRDTIU",36,0)
 . D EN1(ID,.VPRITM),XML(.VPRITM)
"RTN","VPRDTIU",37,0)
 ;
"RTN","VPRDTIU",38,0)
 ; get all documents
"RTN","VPRDTIU",39,0)
 N CLASS,SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,VPRC,CLS
"RTN","VPRDTIU",40,0)
 D SETUP S VPRCNT=0 ;search criteria
"RTN","VPRDTIU",41,0)
 I CLASS="RA" D RPTS^VPRDRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",42,0)
 I CLASS="LR" D RPTS^VPRDLRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",43,0)
 F VPRC=1:1:$L(CLASS,U) S CLS=$P(CLASS,U,VPRC) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",44,0)
 . D CONTEXT^TIUSRVLO(.VPRY,CLS,1,DFN,BEG,END,,,,1)
"RTN","VPRDTIU",45,0)
 . S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",46,0)
 .. S VPRX=$G(@VPRY@(VPRN)),IFN=+VPRX
"RTN","VPRDTIU",47,0)
 .. Q:($P(VPRX,U,3)<BEG)!($P(VPRX,U,3)>END)  Q:'$$MATCH(IFN)
"RTN","VPRDTIU",48,0)
 .. K VPRITM D EN1(IFN,.VPRITM)
"RTN","VPRDTIU",49,0)
 .. I $D(VPRITM) D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDTIU",50,0)
 Q
"RTN","VPRDTIU",51,0)
 ;
"RTN","VPRDTIU",52,0)
EN1(IEN,DOC) ; -- return a document in DOC("attribute")=value
"RTN","VPRDTIU",53,0)
 ;  Expects DFN, VPRX=IEN^$$RESOLVE^TIUSRVLO(IEN)
"RTN","VPRDTIU",54,0)
 N X,NAME,VPRTIU,ES,I K DOC
"RTN","VPRDTIU",55,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDTIU",56,0)
 Q:"UNKNOWN"[$P($G(VPRX),U,2)  ;null or invalid
"RTN","VPRDTIU",57,0)
 S NAME=$P(VPRX,U,2) I $P(VPRX,U,14),$P(NAME," ")="Addendum" Q
"RTN","VPRDTIU",58,0)
 S DOC("id")=IEN,DOC("localTitle")=NAME
"RTN","VPRDTIU",59,0)
 D EXTRACT^TIULQ(IEN,"VPRTIU",,".01:.04;1501:1508")
"RTN","VPRDTIU",60,0)
 S X=$$GET1^DIQ(8925,IEN_",",".01:1501","I") I X D
"RTN","VPRDTIU",61,0)
 . N IENS,TIU,Y,FNUM
"RTN","VPRDTIU",62,0)
 . S IENS=X_"," D GETS^DIQ(8926.1,IENS,"*","IE","TIU")
"RTN","VPRDTIU",63,0)
 . S DOC("nationalTitle")=$G(TIU(8926.1,IENS,99.99,"E"))_U_$G(TIU(8926.1,IENS,.01,"E"))
"RTN","VPRDTIU",64,0)
 . F I=".04^Subject^2",".05^Role^3",".06^Setting^4",".07^Service^5",".08^Type^6" D
"RTN","VPRDTIU",65,0)
 .. S Y=+$G(TIU(8926.1,IENS,+I,"I")) Q:Y'>0
"RTN","VPRDTIU",66,0)
 .. S FNUM="8926."_+$P(I,U,3)
"RTN","VPRDTIU",67,0)
 .. S DOC("nationalTitle"_$P(I,U,2))=$$VUID^VPRD(Y,FNUM)_U_$G(TIU(8926.1,IENS,+I,"E"))
"RTN","VPRDTIU",68,0)
 S:$G(FILTER("loinc")) DOC("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDTIU",69,0)
 S X=$G(VPRTIU(IEN,.04,"E")) S:$L(X) DOC("documentClass")=X
"RTN","VPRDTIU",70,0)
 S X=$G(VPRTIU(IEN,.04,"I")),DOC("type")=$$DTYP(+X)
"RTN","VPRDTIU",71,0)
 S DOC("referenceDateTime")=$P(VPRX,U,3)
"RTN","VPRDTIU",72,0)
 S X=$P(VPRX,U,6) D  ;S:$L(X) DOC("location")=X
"RTN","VPRDTIU",73,0)
 . N LOC S LOC=$S($L(X):+$O(^SC("B",X,0)),1:0)
"RTN","VPRDTIU",74,0)
 . S DOC("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDTIU",75,0)
 S X=$P(VPRX,U,7) S:$L(X) DOC("status")=X
"RTN","VPRDTIU",76,0)
 S:$L($P(VPRX,U,12)) DOC("subject")=$P(VPRX,U,12)
"RTN","VPRDTIU",77,0)
 ; X=$S($P(VPRX,U,13)[">":"C",$P(VPRX,U,13)["<":"I",1:"") ;componentType
"RTN","VPRDTIU",78,0)
 S DOC("encounter")=$G(VPRTIU(IEN,.03,"I"))
"RTN","VPRDTIU",79,0)
 S:$G(VPRTEXT) DOC("content")=$$TEXT(IEN)
"RTN","VPRDTIU",80,0)
 ; providers &/or signatures
"RTN","VPRDTIU",81,0)
 S X=$P(VPRX,U,5),I=0 S:X I=I+1,DOC("clinician",I)=+X_U_$P(X,";",3)_"^A" ;author
"RTN","VPRDTIU",82,0)
 M ES=VPRTIU(IEN) I ES(1501,"I") D
"RTN","VPRDTIU",83,0)
 . S I=I+1
"RTN","VPRDTIU",84,0)
 . S DOC("clinician",I)=ES(1502,"I")_U_ES(1502,"E")_"^S^"_ES(1501,"I")_U_$$SIG(ES(1502,"I"))
"RTN","VPRDTIU",85,0)
 I ES(1507,"I") D  ; cosigner
"RTN","VPRDTIU",86,0)
 . S I=I+1
"RTN","VPRDTIU",87,0)
 . S DOC("clinician",I)=ES(1508,"I")_U_ES(1508,"E")_"^C^"_ES(1507,"I")_U_$$SIG(ES(1508,"I"))
"RTN","VPRDTIU",88,0)
 Q
"RTN","VPRDTIU",89,0)
 ;
"RTN","VPRDTIU",90,0)
DTYP(DA) ; -- Return a code for document type #8925.1 DA
"RTN","VPRDTIU",91,0)
 N X
"RTN","VPRDTIU",92,0)
 D ISCNSLT^TIUCNSLT(.X,DA) I X Q "CR"  ;consult result
"RTN","VPRDTIU",93,0)
 I $$ISA^TIULX(DA,25) Q "CW"           ;CWAD note/Allergy
"RTN","VPRDTIU",94,0)
 I $$ISA^TIULX(DA,27) Q "CW"           ;CWAD note/Advance Directive
"RTN","VPRDTIU",95,0)
 I $$ISA^TIULX(DA,30) Q "CW"           ;CWAD note/Crisis Note
"RTN","VPRDTIU",96,0)
 I $$ISA^TIULX(DA,31) Q "CW"           ;CWAD note/Clinical Warning
"RTN","VPRDTIU",97,0)
 I $$ISA^TIULX(DA,3) Q "PN"            ;progress note
"RTN","VPRDTIU",98,0)
 ;
"RTN","VPRDTIU",99,0)
 I $$ISA^TIULX(DA,244) Q "DS"          ;discharge summary
"RTN","VPRDTIU",100,0)
 D ISCP^TIUCP(.X,DA) I X Q "CP"        ;clinical procedure
"RTN","VPRDTIU",101,0)
 D ISSURG^TIUSROI(.X,DA) I X Q "SR"    ;surgery
"RTN","VPRDTIU",102,0)
 I $$ISA^TIULX(DA,$$LR) Q "LR"         ;laboratory
"RTN","VPRDTIU",103,0)
 Q ""
"RTN","VPRDTIU",104,0)
 ;
"RTN","VPRDTIU",105,0)
LR() ; -- Return ien of Lab class
"RTN","VPRDTIU",106,0)
 N Y S Y=+$O(^TIU(8925.1,"B","LR LABORATORY REPORTS",0))
"RTN","VPRDTIU",107,0)
 I Y>0,$S($P($G(^TIU(8925.1,Y,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S Y=0
"RTN","VPRDTIU",108,0)
 Q Y
"RTN","VPRDTIU",109,0)
 ;
"RTN","VPRDTIU",110,0)
SIG(X) ; -- Return Signature Block Name_Title
"RTN","VPRDTIU",111,0)
 N X20,Y S X20=$G(^VA(200,+$G(X),20))
"RTN","VPRDTIU",112,0)
 S Y=$P(X20,U,2)_" "_$P(X20,U,3)
"RTN","VPRDTIU",113,0)
 Q Y
"RTN","VPRDTIU",114,0)
 ;
"RTN","VPRDTIU",115,0)
RPT(VPRY,IFN) ; -- Return text of document in @VPRY@(n)
"RTN","VPRDTIU",116,0)
 D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",117,0)
 Q
"RTN","VPRDTIU",118,0)
 ;
"RTN","VPRDTIU",119,0)
TEXT(IFN) ; -- Return document IFN as a text string
"RTN","VPRDTIU",120,0)
 N I,Y,VPRY S IFN=+$G(IFN),Y=""
"RTN","VPRDTIU",121,0)
 I IFN D
"RTN","VPRDTIU",122,0)
 . D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",123,0)
 . S I=0 F  S I=$O(@VPRY@(I)) Q:I<1  S Y=Y_$S($L(Y):$C(13,10),1:"")_@VPRY@(I)
"RTN","VPRDTIU",124,0)
 Q Y
"RTN","VPRDTIU",125,0)
 ;
"RTN","VPRDTIU",126,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDTIU",127,0)
 ;
"RTN","VPRDTIU",128,0)
XML(DOC) ; -- Return patient documents as XML
"RTN","VPRDTIU",129,0)
 N ATT,X,Y,NAMES,TYPE
"RTN","VPRDTIU",130,0)
 D ADD("<document>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDTIU",131,0)
 S ATT="" F  S ATT=$O(DOC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDTIU",132,0)
 . I $O(DOC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDTIU",133,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDTIU",134,0)
 .. S I=0 F  S I=$O(DOC(ATT,I)) Q:I<1  D
"RTN","VPRDTIU",135,0)
 ... S X=$G(DOC(ATT,I)),NAMES=""
"RTN","VPRDTIU",136,0)
 ... I ATT="clinician" S NAMES="code^name^role^dateTime^signature^Z"
"RTN","VPRDTIU",137,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDTIU",138,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDTIU",139,0)
 . S X=$G(DOC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDTIU",140,0)
 . I ATT="content" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDTIU",141,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDTIU",142,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDTIU",143,0)
 D ADD("</document>")
"RTN","VPRDTIU",144,0)
 Q
"RTN","VPRDTIU",145,0)
 ;
"RTN","VPRDTIU",146,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDTIU",147,0)
 N STR,P,TAG S STR=""
"RTN","VPRDTIU",148,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDTIU",149,0)
 Q STR
"RTN","VPRDTIU",150,0)
 ;
"RTN","VPRDTIU",151,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDTIU",152,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDTIU",153,0)
 S @VPR@(VPRI)=X
"RTN","VPRDTIU",154,0)
 Q
"RTN","VPRDTIU",155,0)
 ;
"RTN","VPRDTIU",156,0)
 ; ------------ Get/apply search criteria ------------
"RTN","VPRDTIU",157,0)
 ;
"RTN","VPRDTIU",158,0)
SETUP ; -- convert FILTER("attribute") = value to TIU criteria
"RTN","VPRDTIU",159,0)
 ; Expects either: FILTER("loinc") = LOINC
"RTN","VPRDTIU",160,0)
 ;             or: FILTER("type")  = code (see $$DTYP)
"RTN","VPRDTIU",161,0)
 ; Returns CLASS,[SUBCLASS,TITLE,SERVICE,SUBJECT]
"RTN","VPRDTIU",162,0)
 ;
"RTN","VPRDTIU",163,0)
 N LOINC,TYPE,CP
"RTN","VPRDTIU",164,0)
 S LOINC=+$G(FILTER("loinc")),TYPE=$$UP^XLFSTR($G(FILTER("type")))
"RTN","VPRDTIU",165,0)
 S CLASS="3^244",(SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ)=""
"RTN","VPRDTIU",166,0)
 ;
"RTN","VPRDTIU",167,0)
 ; progress notes
"RTN","VPRDTIU",168,0)
 I TYPE="PN" S CLASS=3 Q
"RTN","VPRDTIU",169,0)
 I TYPE="CR"!(LOINC=11488) S CLASS=3,SUBCLASS=+$$CLASS^TIUCNSLT Q
"RTN","VPRDTIU",170,0)
 ; LOINC=26442 S CLASS=3,SUBJECT="^114^" Q          ;OB/GYN
"RTN","VPRDTIU",171,0)
 I LOINC=34117 S CLASS=3,SERVICE="^88^" Q           ;H&P
"RTN","VPRDTIU",172,0)
 I TYPE="CW" S CLASS=3,SUBCLASS="25^27^30^31" Q     ;CWAD
"RTN","VPRDTIU",173,0)
 I TYPE="AD" S CLASS=3,SUBCLASS=27 Q                ;Adv Directive
"RTN","VPRDTIU",174,0)
 ;
"RTN","VPRDTIU",175,0)
 ; discharge summaries
"RTN","VPRDTIU",176,0)
 I TYPE="DS"!(LOINC=18842) S CLASS=244 Q
"RTN","VPRDTIU",177,0)
 ;
"RTN","VPRDTIU",178,0)
 ; procedures
"RTN","VPRDTIU",179,0)
 I TYPE="SR"!(LOINC=29752) S CLASS=+$$CLASS^TIUSROI("SURGICAL REPORTS") Q
"RTN","VPRDTIU",180,0)
 D CPCLASS^TIUCP(.CP)
"RTN","VPRDTIU",181,0)
 I TYPE="CP" S CLASS=CP Q                           ;CLINICAL PROCEDURES
"RTN","VPRDTIU",182,0)
 I LOINC=26441 D  Q                                 ;CARDIOLOGY
"RTN","VPRDTIU",183,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",184,0)
 . S SUBJECT="^18^142^174^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",185,0)
 I LOINC=27896 D  Q                                 ;PULMONARY
"RTN","VPRDTIU",186,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",187,0)
 . S SUBJECT="^23^142^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",188,0)
 I LOINC=27895 D  Q                                 ;GASTROENTEROLOGY
"RTN","VPRDTIU",189,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",190,0)
 . S SUBJECT="^20^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",191,0)
 I LOINC=27897 D  Q                                 ;NEUROLOGY
"RTN","VPRDTIU",192,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",193,0)
 . S SUBJECT="^44^45^52^111^112^143^146^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",194,0)
 I LOINC=28619 D  Q                                 ;OPHTH/OPTOMETRY
"RTN","VPRDTIU",195,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",196,0)
 . S SUBJECT="^13^14^103^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",197,0)
 I LOINC=28634 D  Q                                 ;MISC/ALL OTHERS
"RTN","VPRDTIU",198,0)
 . S CLASS=CP_"^3",SERVICE="^75^76^115^"
"RTN","VPRDTIU",199,0)
 . S NOTSUBJ="^18^142^174^23^142^20^44^45^52^111^112^143^146^13^14^103^"
"RTN","VPRDTIU",200,0)
 I LOINC=28570 D  Q                                 ;UNSPECIFIED/ALL
"RTN","VPRDTIU",201,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",202,0)
 . S SERVICE="^75^76^115^"
"RTN","VPRDTIU",203,0)
 ;
"RTN","VPRDTIU",204,0)
 ; pathology/lab
"RTN","VPRDTIU",205,0)
 I TYPE="LR"!(LOINC=27898) S CLASS="LR" Q
"RTN","VPRDTIU",206,0)
 ;
"RTN","VPRDTIU",207,0)
 ; radiology
"RTN","VPRDTIU",208,0)
 I TYPE="RA"!(LOINC=18726) S CLASS="RA" Q
"RTN","VPRDTIU",209,0)
 ;
"RTN","VPRDTIU",210,0)
 ; unknown
"RTN","VPRDTIU",211,0)
 I $L(TYPE)!LOINC S CLASS=0
"RTN","VPRDTIU",212,0)
 Q
"RTN","VPRDTIU",213,0)
 ;
"RTN","VPRDTIU",214,0)
MATCH(DA) ; -- Return 1 or 0, if document DA matches search criteria
"RTN","VPRDTIU",215,0)
 N Y,LOCAL,NATL,X0,OK S Y=0
"RTN","VPRDTIU",216,0)
 S LOCAL=$$GET1^DIQ(8925,DA_",",.01,"I") ;local Title 8925.1 ien
"RTN","VPRDTIU",217,0)
 I $L(SUBCLASS) D  G:'OK MQ
"RTN","VPRDTIU",218,0)
 . N I,X S OK=0
"RTN","VPRDTIU",219,0)
 . F I=1:1:$L(SUBCLASS,"^") S X=$P(SUBCLASS,U,I) I $$ISA^TIULX(LOCAL,SUBCLASS) S OK=1 Q
"RTN","VPRDTIU",220,0)
 S NATL=+$$GET1^DIQ(8925.1,LOCAL_",",1501,"I") ;Natl Title 8926.1 ien
"RTN","VPRDTIU",221,0)
 I $L(TITLE) G:TITLE'[(U_+NATL_U) MQ
"RTN","VPRDTIU",222,0)
 S X0=$G(^TIU(8926.1,NATL,0))
"RTN","VPRDTIU",223,0)
 I $L(SERVICE) G:SERVICE'[(U_+$P(X0,U,7)_U) MQ
"RTN","VPRDTIU",224,0)
 I $L(SUBJECT) G:SUBJECT'[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",225,0)
 I $L(NOTSUBJ) G:NOTSUBJ[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",226,0)
 S Y=1
"RTN","VPRDTIU",227,0)
MQ Q Y
"RTN","VPRDVSIT")
0^20^B71801802
"RTN","VPRDVSIT",1,0)
VPRDVSIT ;SLC/MKB -- Visit/Encounter extract ;8/2/11  15:29
"RTN","VPRDVSIT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRDVSIT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDVSIT",4,0)
 ;
"RTN","VPRDVSIT",5,0)
 ; External References          DBIA#
"RTN","VPRDVSIT",6,0)
 ; -------------------          -----
"RTN","VPRDVSIT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDVSIT",8,0)
 ; ^DIC(40.7                      557
"RTN","VPRDVSIT",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDVSIT",10,0)
 ; ^DIC(45.7                     1154
"RTN","VPRDVSIT",11,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDVSIT",12,0)
 ; ^SC                          10040
"RTN","VPRDVSIT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDVSIT",14,0)
 ; DIC                           2051
"RTN","VPRDVSIT",15,0)
 ; DILFD                         2055
"RTN","VPRDVSIT",16,0)
 ; DIQ                           2056
"RTN","VPRDVSIT",17,0)
 ; ICDCODE                       3990
"RTN","VPRDVSIT",18,0)
 ; ICPTCOD                       1995
"RTN","VPRDVSIT",19,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDVSIT",20,0)
 ; SDOE                          2546
"RTN","VPRDVSIT",21,0)
 ; VADPT                        10061
"RTN","VPRDVSIT",22,0)
 ; XUAF4                         2171
"RTN","VPRDVSIT",23,0)
 ;
"RTN","VPRDVSIT",24,0)
 ; ------------ Get encounter(s) from VistA ------------
"RTN","VPRDVSIT",25,0)
 ;
"RTN","VPRDVSIT",26,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments
"RTN","VPRDVSIT",27,0)
 N VPRCNT,VPRITM,VPRDT,VPRLOC,VPRDA
"RTN","VPRDVSIT",28,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",30,0)
 ;
"RTN","VPRDVSIT",31,0)
 ; get one visit
"RTN","VPRDVSIT",32,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDVSIT",33,0)
 ;
"RTN","VPRDVSIT",34,0)
 ; -- get all visits
"RTN","VPRDVSIT",35,0)
 I END,END'["." S END=END_".24" ;assume end of day
"RTN","VPRDVSIT",36,0)
 S VPRCNT=0
"RTN","VPRDVSIT",37,0)
 ;F  S IDX=$Q(@IDX,-1) Q:DFN'=$P(IDX,",",2)  Q:$P(IDX,",",3)<BEG  I $P(IDX,",",5)["P" D
"RTN","VPRDVSIT",38,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<BEG  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",39,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDVSIT",40,0)
 .. S VPRDA=0 F  S VPRDA=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",VPRDA)) Q:VPRDA<1  D
"RTN","VPRDVSIT",41,0)
 ... K VPRITM D EN1(VPRDA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",42,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",43,0)
 Q
"RTN","VPRDVSIT",44,0)
 ;
"RTN","VPRDVSIT",45,0)
ENAA(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments [AA]
"RTN","VPRDVSIT",46,0)
 N IDT,DA,VPRCNT,VPRITM
"RTN","VPRDVSIT",47,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",48,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",49,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q  ;one visit
"RTN","VPRDVSIT",50,0)
 D IDT S VPRCNT=0
"RTN","VPRDVSIT",51,0)
 S IDT=BEG F  S IDT=$O(^AUPNVSIT("AA",DFN,IDT)) Q:IDT<1!(IDT>END)  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",52,0)
 . S DA=0 F  S DA=$O(^AUPNVSIT("AA",DFN,IDT,DA)) Q:DA<1  D
"RTN","VPRDVSIT",53,0)
 .. K VPRITM D EN1(DA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",54,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",55,0)
 Q
"RTN","VPRDVSIT",56,0)
IDT ; -- invert BEG and END dates for visit format:
"RTN","VPRDVSIT",57,0)
 ;  IDT=(9999999-$P(VDT,"."))_"."_$P(VDT,".",2)
"RTN","VPRDVSIT",58,0)
 N X S X=BEG
"RTN","VPRDVSIT",59,0)
 S BEG=(9999999-$P(END,"."))
"RTN","VPRDVSIT",60,0)
 S END=(9999999-$P(X,"."))_".2359"
"RTN","VPRDVSIT",61,0)
 Q
"RTN","VPRDVSIT",62,0)
 ;
"RTN","VPRDVSIT",63,0)
EN1(IEN,VST) ; -- return a visit in VST("attribute")=value
"RTN","VPRDVSIT",64,0)
 N X0,X15,X,FAC,LOC,CATG,INPT,DA
"RTN","VPRDVSIT",65,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",66,0)
 D ENCEVENT^PXAPI(IEN)
"RTN","VPRDVSIT",67,0)
 S X0=$G(^TMP("PXKENC",$J,IEN,"VST",IEN,0)),X15=$G(^(150))
"RTN","VPRDVSIT",68,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,7)="E"  ;want primary, not historical
"RTN","VPRDVSIT",69,0)
 I $P(X0,U,7)="H" D ADM(IEN,+X0,.VST) Q
"RTN","VPRDVSIT",70,0)
 S VST("id")=IEN,VST("dateTime")=+X0
"RTN","VPRDVSIT",71,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDVSIT",72,0)
 S:FAC VST("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDVSIT",73,0)
 S:'FAC VST("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDVSIT",74,0)
 S VST("serviceCategory")=CATG_U_$$CATG(CATG)
"RTN","VPRDVSIT",75,0)
 S VST("visitString")=LOC_";"_+X0_";"_CATG
"RTN","VPRDVSIT",76,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDVSIT",77,0)
 S X=$$CPT(IEN) S:X VST("type")=$P($$CPT^ICPTCOD(X),U,2,3)
"RTN","VPRDVSIT",78,0)
 I 'X S VST("type")=U_$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG(CATG))
"RTN","VPRDVSIT",79,0)
 S VST("patientClass")=$S(INPT:"IMP",1:"AMB")
"RTN","VPRDVSIT",80,0)
 S X=$P(X0,U,8) S:X VST("stopCode")=$$AMIS(X) I LOC D
"RTN","VPRDVSIT",81,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDVSIT",82,0)
 . I 'X S VST("stopCode")=$$AMIS($P(L0,U,7))
"RTN","VPRDVSIT",83,0)
 . S VST("location")=$P(L0,U),VST("service")=$$SERV($P(L0,U,20))
"RTN","VPRDVSIT",84,0)
 . S X=$P(L0,U,18) S:X VST("creditStopCode")=$$AMIS(X)
"RTN","VPRDVSIT",85,0)
 S VST("reason")=$$POV(IEN)
"RTN","VPRDVSIT",86,0)
 ; provider(s)
"RTN","VPRDVSIT",87,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",88,0)
 . S VST("provider",DA)=+X0_U_$P($G(^VA(200,+X0,0)),U)_$S($P(X0,U,4)="P":"^P^1",1:"^S^")
"RTN","VPRDVSIT",89,0)
 ; note(s)
"RTN","VPRDVSIT",90,0)
 D TIU(IEN)
"RTN","VPRDVSIT",91,0)
 K ^TMP("PXKENC",$J,IEN)
"RTN","VPRDVSIT",92,0)
 Q
"RTN","VPRDVSIT",93,0)
 ;
"RTN","VPRDVSIT",94,0)
TIU(VISIT) ; -- add notes to VST("document")
"RTN","VPRDVSIT",95,0)
 N X,Y,I,VPRX,LT,NT,DA,CNT
"RTN","VPRDVSIT",96,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",,,"VPRX")
"RTN","VPRDVSIT",97,0)
 S Y="",(I,CNT)=0
"RTN","VPRDVSIT",98,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDVSIT",99,0)
 . S LT=$G(VPRX("DILIST","ID",I,.01)) Q:$P(LT," ")="Addendum"
"RTN","VPRDVSIT",100,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDVSIT",101,0)
 . S NT=$$GET1^DIQ(8925,+DA_",",".01:1501")
"RTN","VPRDVSIT",102,0)
 . S CNT=CNT+1,VST("document",CNT)=DA_U_LT_U_NT
"RTN","VPRDVSIT",103,0)
 . S:$G(VPRTEXT) VST("document",CNT,"content")=$$TEXT^VPRDTIU(DA)
"RTN","VPRDVSIT",104,0)
 Q
"RTN","VPRDVSIT",105,0)
 ;
"RTN","VPRDVSIT",106,0)
POV(VISIT) ; -- return the primary Purpose of Visit as ICD^ProviderNarrative
"RTN","VPRDVSIT",107,0)
 N DA,Y,X,X0,ICD S Y=""
"RTN","VPRDVSIT",108,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) I $P(X0,U,12)="P" D  Q:$L(Y)
"RTN","VPRDVSIT",109,0)
 . S X=+$P(X0,U,4),ICD=$$ICD(+X0)
"RTN","VPRDVSIT",110,0)
 . S Y=ICD_U_$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDVSIT",111,0)
 Q Y
"RTN","VPRDVSIT",112,0)
 ;
"RTN","VPRDVSIT",113,0)
ICD(IEN) ; -- return code^description for ICD code, or "^" if error
"RTN","VPRDVSIT",114,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDVSIT",115,0)
 S X0=$$ICDDX^ICDCODE(IEN) I X0<0 Q "^"
"RTN","VPRDVSIT",116,0)
 S Y=$P(X0,U,2)_U_$P(X0,U,4)       ;ICD Code^Dx name
"RTN","VPRDVSIT",117,0)
 S N=$$ICDD^ICDCODE($P(Y,U),"VPRX") ;ICD Description
"RTN","VPRDVSIT",118,0)
 I N>0,$L($G(VPRX(1))) S $P(Y,U,2)=VPRX(1)
"RTN","VPRDVSIT",119,0)
 Q Y
"RTN","VPRDVSIT",120,0)
 ;
"RTN","VPRDVSIT",121,0)
CPT(VISIT) ; -- Return CPT code of encounter type
"RTN","VPRDVSIT",122,0)
 N DA,Y,X,X0 S Y=""
"RTN","VPRDVSIT",123,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D  Q:$L(Y)
"RTN","VPRDVSIT",124,0)
 . S X=$P(X0,U) I X?1"992"2N S Y=X Q
"RTN","VPRDVSIT",125,0)
 Q Y
"RTN","VPRDVSIT",126,0)
 ;
"RTN","VPRDVSIT",127,0)
AMIS(X) ; -- return the AMIS code^name of Credit Stop X
"RTN","VPRDVSIT",128,0)
 N Y,X0 S Y=""
"RTN","VPRDVSIT",129,0)
 S X0=$G(^DIC(40.7,+$G(X),0)) S:$L(X0) Y=$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDVSIT",130,0)
 Q Y
"RTN","VPRDVSIT",131,0)
 ;
"RTN","VPRDVSIT",132,0)
CATG(X) ; -- Return name of visit Service Category code X
"RTN","VPRDVSIT",133,0)
 N Y S Y=""
"RTN","VPRDVSIT",134,0)
 I X="A" S Y="AMBULATORY"
"RTN","VPRDVSIT",135,0)
 I X="H" S Y="HOSPITALIZATION"
"RTN","VPRDVSIT",136,0)
 I X="I" S Y="IN HOSPITAL"
"RTN","VPRDVSIT",137,0)
 I X="C" S Y="CHART REVIEW"
"RTN","VPRDVSIT",138,0)
 I X="T" S Y="TELECOMMUNICATIONS"
"RTN","VPRDVSIT",139,0)
 I X="N" S Y="NOT FOUND"
"RTN","VPRDVSIT",140,0)
 I X="S" S Y="DAY SURGERY"
"RTN","VPRDVSIT",141,0)
 I X="O" S Y="OBSERVATION"
"RTN","VPRDVSIT",142,0)
 I X="E" S Y="EVENT (HISTORICAL)"
"RTN","VPRDVSIT",143,0)
 I X="R" S Y="NURSING HOME"
"RTN","VPRDVSIT",144,0)
 I X="D" S Y="DAILY HOSPITALIZATION DATA"
"RTN","VPRDVSIT",145,0)
 I X="X" S Y="ANCILLARY PACKAGE DAILY DATA"
"RTN","VPRDVSIT",146,0)
 Q Y
"RTN","VPRDVSIT",147,0)
 ;
"RTN","VPRDVSIT",148,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDVSIT",149,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDVSIT",150,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDVSIT",151,0)
 Q Y
"RTN","VPRDVSIT",152,0)
 ;
"RTN","VPRDVSIT",153,0)
ADM(IEN,DATE,ADM) ; -- return an admission in ADM("attribute")=value
"RTN","VPRDVSIT",154,0)
 N VAIP,VAERR,HLOC,ICD,I K ADM
"RTN","VPRDVSIT",155,0)
 S IEN=+$G(IEN),DATE=+$G(DATE) Q:IEN<1  Q:DATE<1  ;invalid
"RTN","VPRDVSIT",156,0)
 S VAIP("D")=DATE D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDVSIT",157,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP"
"RTN","VPRDVSIT",158,0)
 ; ADM("admitType")=$P($G(VAIP(4)),U,2)
"RTN","VPRDVSIT",159,0)
 S DATE=+$G(VAIP(3)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",160,0)
 S:$G(VAIP(7)) I=I+1,ADM("provider",I)=VAIP(7)_"^P^1" ;primary
"RTN","VPRDVSIT",161,0)
 S:$G(VAIP(18)) I=I+1,ADM("provider",I)=VAIP(18)_"^A" ;attending
"RTN","VPRDVSIT",162,0)
 S ADM("specialty")=$P($G(VAIP(8)),U,2)
"RTN","VPRDVSIT",163,0)
 S X=$$SERV(+$G(VAIP(8))),ADM("service")=X
"RTN","VPRDVSIT",164,0)
 S X=$$POV(IEN) S:X ADM("reason")=X_U_$G(VAIP(9)) I 'X D
"RTN","VPRDVSIT",165,0)
 . ;S X=$$GET1^DIQ(45,+VAIP(12)_",",79,"I") ;PTF>ICD ien
"RTN","VPRDVSIT",166,0)
 . S X=$S(VAIP(12):$$PTF(DFN,VAIP(12)),1:"")
"RTN","VPRDVSIT",167,0)
 . I 'X S ADM("reason")=U_U_$G(VAIP(9)) Q  ;Dx text
"RTN","VPRDVSIT",168,0)
 . S ICD=$$ICD(X),ADM("reason")=ICD_U_$G(VAIP(9))
"RTN","VPRDVSIT",169,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(5)),44))
"RTN","VPRDVSIT",170,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",171,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDVSIT",172,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",173,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",174,0)
 I $G(VAIP(17)) D
"RTN","VPRDVSIT",175,0)
 . S ADM("departureDateTime")=+$G(VAIP(17,1))
"RTN","VPRDVSIT",176,0)
 . ; ADM("disposition")=$G(VAIP(17,3)) ;Discharge Mvt Type
"RTN","VPRDVSIT",177,0)
 S ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",178,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",179,0)
 Q
"RTN","VPRDVSIT",180,0)
 ;
"RTN","VPRDVSIT",181,0)
PTF(DFN,PTF) ; -- look up ICD code for a PTF record
"RTN","VPRDVSIT",182,0)
 N Y,ICD,DATE,IEN S Y=""
"RTN","VPRDVSIT",183,0)
 S ICD=0 F  S ICD=$O(^PXRMINDX(45,"ICD9","PNI",DFN,"DXLS",ICD)) Q:ICD<1  D  Q:Y
"RTN","VPRDVSIT",184,0)
 . S DATE=$O(^PXRMINDX(45,"ICD9","PNI",DFN,"DXLS",ICD,0)),IEN=$O(^(DATE,""))
"RTN","VPRDVSIT",185,0)
 . I +IEN=PTF S Y=ICD Q
"RTN","VPRDVSIT",186,0)
 Q Y
"RTN","VPRDVSIT",187,0)
 ;
"RTN","VPRDVSIT",188,0)
ENC(IEN,ENC) ; -- return an encounter in ENC("attribute")=value
"RTN","VPRDVSIT",189,0)
 N X0,DATE,HLOC,TYPE,STS,X,Y K ENC
"RTN","VPRDVSIT",190,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",191,0)
 S ENC("id")="E"_IEN,X0=$$GETOE^SDOE(IEN) ;^SCE(IEN,0) node
"RTN","VPRDVSIT",192,0)
 S DATE=+X0,ENC("dateTime")=DATE
"RTN","VPRDVSIT",193,0)
 S HLOC=+$P(X0,U,4) I HLOC D
"RTN","VPRDVSIT",194,0)
 . S HLOC=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",195,0)
 . S ENC("location")=$P(HLOC,U,2)
"RTN","VPRDVSIT",196,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDVSIT",197,0)
 . I X S ENC("service")=$$SERV(X)
"RTN","VPRDVSIT",198,0)
 S ENC("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDVSIT",199,0)
 S STS=$$EXTERNAL^DILFD(409.68,.12,,$P(X0,U,12))
"RTN","VPRDVSIT",200,0)
 S X=$S(STS?1"INP".E:"IMP",1:"AMB"),ENC("patientClass")=X,TYPE=$E(X)
"RTN","VPRDVSIT",201,0)
 S ENC("type")=U_$S(HLOC:$P(HLOC,U,2)_" VISIT",1:$$CATG(TYPE))
"RTN","VPRDVSIT",202,0)
 S ENC("serviceCategory")=TYPE_U_$$CATG(TYPE)
"RTN","VPRDVSIT",203,0)
 S ENC("visitString")=+HLOC_";"_DATE_";"_TYPE
"RTN","VPRDVSIT",204,0)
 Q
"RTN","VPRDVSIT",205,0)
 ;
"RTN","VPRDVSIT",206,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDVSIT",207,0)
 ;
"RTN","VPRDVSIT",208,0)
XML(VISIT) ; -- Return patient visit as XML
"RTN","VPRDVSIT",209,0)
 N ATT,X,Y,NAMES
"RTN","VPRDVSIT",210,0)
 D ADD("<visit>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDVSIT",211,0)
 S ATT="" F  S ATT=$O(VISIT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDVSIT",212,0)
 . I $O(VISIT(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDVSIT",213,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDVSIT",214,0)
 .. S I=0 F  S I=$O(VISIT(ATT,I)) Q:I<1  D
"RTN","VPRDVSIT",215,0)
 ... S X=$G(VISIT(ATT,I)),NAMES=""
"RTN","VPRDVSIT",216,0)
 ... I ATT="document" S NAMES="id^localTitle^nationalTitle^Z"
"RTN","VPRDVSIT",217,0)
 ... I ATT="provider" S NAMES="code^name^role^primary^Z"
"RTN","VPRDVSIT",218,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDVSIT",219,0)
 ... S X=$G(VISIT(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDVSIT",220,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDVSIT",221,0)
 ... S Y="<content xml:space='preserve'>"_$$ESC^VPRD(X)_"</content>"
"RTN","VPRDVSIT",222,0)
 ... D ADD(Y),ADD("</"_ATT_">")
"RTN","VPRDVSIT",223,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDVSIT",224,0)
 . S X=$G(VISIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDVSIT",225,0)
 . S NAMES="code^name^"_$S(ATT="reason":"narrative^",1:"")_"Z"
"RTN","VPRDVSIT",226,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDVSIT",227,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDVSIT",228,0)
 D ADD("</visit>")
"RTN","VPRDVSIT",229,0)
 Q
"RTN","VPRDVSIT",230,0)
 ;
"RTN","VPRDVSIT",231,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDVSIT",232,0)
 N STR,P,TAG S STR=""
"RTN","VPRDVSIT",233,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDVSIT",234,0)
 Q STR
"RTN","VPRDVSIT",235,0)
 ;
"RTN","VPRDVSIT",236,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDVSIT",237,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDVSIT",238,0)
 S @VPR@(VPRI)=X
"RTN","VPRDVSIT",239,0)
 Q
"RTN","VPRPI")
0^^B300624
"RTN","VPRPI",1,0)
VPRPI ;SLC/AGP -- VPR package post install
"RTN","VPRPI",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;;Sep 01, 2011;Build 12
"RTN","VPRPI",3,0)
 ;
"RTN","VPRPI",4,0)
POST ;
"RTN","VPRPI",5,0)
 ; Create proxy user
"RTN","VPRPI",6,0)
 Q:$O(^VA(200,"B","VPR,APPLICATION PROXY",0))
"RTN","VPRPI",7,0)
 N X
"RTN","VPRPI",8,0)
 S X=$$CREATE^XUSAP("VPR,APPLICATION PROXY","","VPR APPLICATION PROXY")
"RTN","VPRPI",9,0)
 Q
"VER")
8.0^22.0
**END**
**END**
