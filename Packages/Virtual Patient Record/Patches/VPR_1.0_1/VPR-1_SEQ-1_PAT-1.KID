Released VPR*1*1 SEQ #1
Extracted from mail message
**KIDS**:VPR*1.0*1^

**INSTALL NAME**
VPR*1.0*1
"BLD",8062,0)
VPR*1.0*1^VIRTUAL PATIENT RECORD^0^3120522^y
"BLD",8062,1,0)
^^2^2^3120301^^
"BLD",8062,1,1,0)
The Virtual Patient Record (VPR) provides a data extract RPC to return
"BLD",8062,1,2,0)
data as requested from the local VistA system.
"BLD",8062,4,0)
^9.64PA^^0
"BLD",8062,6.3)
38
"BLD",8062,"ABPKG")
n
"BLD",8062,"INI")

"BLD",8062,"INIT")

"BLD",8062,"KRN",0)
^9.67PA^8989.52^19
"BLD",8062,"KRN",.4,0)
.4
"BLD",8062,"KRN",.401,0)
.401
"BLD",8062,"KRN",.402,0)
.402
"BLD",8062,"KRN",.403,0)
.403
"BLD",8062,"KRN",.5,0)
.5
"BLD",8062,"KRN",.84,0)
.84
"BLD",8062,"KRN",3.6,0)
3.6
"BLD",8062,"KRN",3.8,0)
3.8
"BLD",8062,"KRN",9.2,0)
9.2
"BLD",8062,"KRN",9.8,0)
9.8
"BLD",8062,"KRN",9.8,"NM",0)
^9.68A^27^25
"BLD",8062,"KRN",9.8,"NM",1,0)
VPRDGMV^^0^B41671211
"BLD",8062,"KRN",9.8,"NM",2,0)
VPRDIB^^0^B12692505
"BLD",8062,"KRN",9.8,"NM",3,0)
VPRDMC^^0^B58328454
"BLD",8062,"KRN",9.8,"NM",4,0)
VPRDMDC^^0^B44678829
"BLD",8062,"KRN",9.8,"NM",5,0)
VPRDOR^^0^B13221791
"BLD",8062,"KRN",9.8,"NM",6,0)
VPRDPROC^^0^B10570617
"BLD",8062,"KRN",9.8,"NM",7,0)
VPRDPS^^0^B18817165
"BLD",8062,"KRN",9.8,"NM",8,0)
VPRDPSI^^0^B41207623
"BLD",8062,"KRN",9.8,"NM",9,0)
VPRDPSO^^0^B15569449
"BLD",8062,"KRN",9.8,"NM",10,0)
VPRDPSOR^^0^B39128356
"BLD",8062,"KRN",9.8,"NM",11,0)
VPRDPT^^0^B70553505
"BLD",8062,"KRN",9.8,"NM",12,0)
VPRDPXHF^^0^B10068928
"BLD",8062,"KRN",9.8,"NM",13,0)
VPRDSDAM^^0^B20114385
"BLD",8062,"KRN",9.8,"NM",14,0)
VPRDTIU^^0^B80235055
"BLD",8062,"KRN",9.8,"NM",15,0)
VPRDVSIT^^0^B89381077
"BLD",8062,"KRN",9.8,"NM",16,0)
VPRD^^0^B28899728
"BLD",8062,"KRN",9.8,"NM",18,0)
VPRDPXAM^^0^B9620825
"BLD",8062,"KRN",9.8,"NM",19,0)
VPRDPXED^^0^B9831355
"BLD",8062,"KRN",9.8,"NM",21,0)
VPRDPXSK^^0^B9706647
"BLD",8062,"KRN",9.8,"NM",22,0)
VPRDGMRA^^0^B22392321
"BLD",8062,"KRN",9.8,"NM",23,0)
VPRDGMRC^^0^B10880986
"BLD",8062,"KRN",9.8,"NM",24,0)
VPRDLRA^^0^B76300469
"BLD",8062,"KRN",9.8,"NM",25,0)
VPRDRA^^0^B41770325
"BLD",8062,"KRN",9.8,"NM",26,0)
VPRDSR^^0^B30371946
"BLD",8062,"KRN",9.8,"NM",27,0)
VPRDGMPL^^0^B27790775
"BLD",8062,"KRN",9.8,"NM","B","VPRD",16)

"BLD",8062,"KRN",9.8,"NM","B","VPRDGMPL",27)

"BLD",8062,"KRN",9.8,"NM","B","VPRDGMRA",22)

"BLD",8062,"KRN",9.8,"NM","B","VPRDGMRC",23)

"BLD",8062,"KRN",9.8,"NM","B","VPRDGMV",1)

"BLD",8062,"KRN",9.8,"NM","B","VPRDIB",2)

"BLD",8062,"KRN",9.8,"NM","B","VPRDLRA",24)

"BLD",8062,"KRN",9.8,"NM","B","VPRDMC",3)

"BLD",8062,"KRN",9.8,"NM","B","VPRDMDC",4)

"BLD",8062,"KRN",9.8,"NM","B","VPRDOR",5)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPROC",6)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPS",7)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPSI",8)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPSO",9)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPSOR",10)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPT",11)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPXAM",18)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPXED",19)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPXHF",12)

"BLD",8062,"KRN",9.8,"NM","B","VPRDPXSK",21)

"BLD",8062,"KRN",9.8,"NM","B","VPRDRA",25)

"BLD",8062,"KRN",9.8,"NM","B","VPRDSDAM",13)

"BLD",8062,"KRN",9.8,"NM","B","VPRDSR",26)

"BLD",8062,"KRN",9.8,"NM","B","VPRDTIU",14)

"BLD",8062,"KRN",9.8,"NM","B","VPRDVSIT",15)

"BLD",8062,"KRN",19,0)
19
"BLD",8062,"KRN",19,"NM",0)
^9.68A^^0
"BLD",8062,"KRN",19.1,0)
19.1
"BLD",8062,"KRN",101,0)
101
"BLD",8062,"KRN",101,"NM",0)
^9.68A^^0
"BLD",8062,"KRN",409.61,0)
409.61
"BLD",8062,"KRN",771,0)
771
"BLD",8062,"KRN",870,0)
870
"BLD",8062,"KRN",8989.51,0)
8989.51
"BLD",8062,"KRN",8989.51,"NM",0)
^9.68A^^0
"BLD",8062,"KRN",8989.52,0)
8989.52
"BLD",8062,"KRN",8994,0)
8994
"BLD",8062,"KRN",8994,"NM",0)
^9.68A^^0
"BLD",8062,"KRN","B",.4,.4)

"BLD",8062,"KRN","B",.401,.401)

"BLD",8062,"KRN","B",.402,.402)

"BLD",8062,"KRN","B",.403,.403)

"BLD",8062,"KRN","B",.5,.5)

"BLD",8062,"KRN","B",.84,.84)

"BLD",8062,"KRN","B",3.6,3.6)

"BLD",8062,"KRN","B",3.8,3.8)

"BLD",8062,"KRN","B",9.2,9.2)

"BLD",8062,"KRN","B",9.8,9.8)

"BLD",8062,"KRN","B",19,19)

"BLD",8062,"KRN","B",19.1,19.1)

"BLD",8062,"KRN","B",101,101)

"BLD",8062,"KRN","B",409.61,409.61)

"BLD",8062,"KRN","B",771,771)

"BLD",8062,"KRN","B",870,870)

"BLD",8062,"KRN","B",8989.51,8989.51)

"BLD",8062,"KRN","B",8989.52,8989.52)

"BLD",8062,"KRN","B",8994,8994)

"BLD",8062,"QUES",0)
^9.62^^
"BLD",8062,"REQB",0)
^9.611^2^1
"BLD",8062,"REQB",2,0)
VIRTUAL PATIENT RECORD 1.0^2
"BLD",8062,"REQB","B","VIRTUAL PATIENT RECORD 1.0",2)

"MBREQ")
0
"PKG",571,-1)
1^1
"PKG",571,0)
VIRTUAL PATIENT RECORD^VPR^Utilities to manage a virtual copy of the patient record
"PKG",571,20,0)
^9.402P^^
"PKG",571,22,0)
^9.49I^1^1
"PKG",571,22,1,0)
1.0^3110804^3110525^1085
"PKG",571,22,1,"PAH",1,0)
1^3120522^1135
"PKG",571,22,1,"PAH",1,1,0)
^^2^2^3120522
"PKG",571,22,1,"PAH",1,1,1,0)
The Virtual Patient Record (VPR) provides a data extract RPC to return
"PKG",571,22,1,"PAH",1,1,2,0)
data as requested from the local VistA system.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
25
"RTN","VPRD")
0^16^B28899728^B24278674
"RTN","VPRD",1,0)
VPRD ;SLC/MKB -- Serve VistA data as XML via RPC ;8/2/11  15:29
"RTN","VPRD",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRD",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRD",4,0)
 ;
"RTN","VPRD",5,0)
 ; External References          DBIA#
"RTN","VPRD",6,0)
 ; -------------------          -----
"RTN","VPRD",7,0)
 ; ^DPT                         10035
"RTN","VPRD",8,0)
 ; ^SC                          10040
"RTN","VPRD",9,0)
 ; DIQ                           2056
"RTN","VPRD",10,0)
 ; MPIF001                       2701
"RTN","VPRD",11,0)
 ; VASITE                       10112
"RTN","VPRD",12,0)
 ; XLFDT                        10103
"RTN","VPRD",13,0)
 ; XLFSTR                       10104
"RTN","VPRD",14,0)
 ; XUAF4                         2171
"RTN","VPRD",15,0)
 ;
"RTN","VPRD",16,0)
GET(VPR,DFN,TYPE,START,STOP,MAX,ID,FILTER) ; -- Return search results as XML in @VPR@(n) 
"RTN","VPRD",17,0)
 ; RPC = VPR GET PATIENT DATA
"RTN","VPRD",18,0)
 N ICN,VPRI,VPRTOTL,VPRTEXT
"RTN","VPRD",19,0)
 S VPR=$NA(^TMP("VPR",$J)) K @VPR
"RTN","VPRD",20,0)
 S VPRTEXT=+$G(FILTER("text")) ;include report/document text?
"RTN","VPRD",21,0)
 ;
"RTN","VPRD",22,0)
 ; parse & validate input parameters
"RTN","VPRD",23,0)
 S ICN=+$P($G(DFN),";",2),DFN=+$G(DFN),ID=$G(ID)
"RTN","VPRD",24,0)
 I DFN<1,ICN S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","VPRD",25,0)
 S TYPE=$$LOW^XLFSTR($G(TYPE)) I TYPE="" S TYPE=$$ALL
"RTN","VPRD",26,0)
 I TYPE'="new",DFN<1!'$D(^DPT(DFN)) D ERR(1,DFN) G GTQ
"RTN","VPRD",27,0)
 S:'$G(START) START=1410102 S:'$G(STOP) STOP=4141015 S:'$G(MAX) MAX=9999
"RTN","VPRD",28,0)
 I START,STOP,STOP<START N X S X=START,START=STOP,STOP=X  ;switch
"RTN","VPRD",29,0)
 I STOP,$L(STOP,".")<2 S STOP=STOP_".24"
"RTN","VPRD",30,0)
 I ID="",$D(FILTER("id")) S ID=FILTER("id")
"RTN","VPRD",31,0)
 ;
"RTN","VPRD",32,0)
 ; extract data
"RTN","VPRD",33,0)
 N VPRTYPE,VPRP,VPRHDR,VPRTAG,VPRTN
"RTN","VPRD",34,0)
 S VPRTYPE=TYPE D ADD("<results version='1.1' timeZone='"_$$TZ^XLFDT_"' >")
"RTN","VPRD",35,0)
 F VPRP=1:1:$L(VPRTYPE,";") S VPRTAG=$P(VPRTYPE,";",VPRP) I $L(VPRTAG) D
"RTN","VPRD",36,0)
 . S VPRTN="EN^"_$$RTN(.VPRTAG) Q:'$L($T(@VPRTN))  ;D ERR(2) Q
"RTN","VPRD",37,0)
 . D ADD("<"_VPRTAG) S VPRHDR=VPRI,VPRTOTL=0
"RTN","VPRD",38,0)
 . D @(VPRTN_"(DFN,START,STOP,MAX,ID)")
"RTN","VPRD",39,0)
 . S @VPR@(VPRHDR)=@VPR@(VPRHDR)_" total='"_+$G(VPRTOTL)_"' >" D ADD("</"_VPRTAG_">")
"RTN","VPRD",40,0)
 D ADD("</results>")
"RTN","VPRD",41,0)
 ;
"RTN","VPRD",42,0)
GTQ ; end
"RTN","VPRD",43,0)
 Q
"RTN","VPRD",44,0)
 ;
"RTN","VPRD",45,0)
RTN(X) ; -- Return name of VPRDxxxx routine for clinical domain X
"RTN","VPRD",46,0)
 ;  X is also enforced as expected group tag name, if passed by ref
"RTN","VPRD",47,0)
 N Y S Y="VPRD",X=$G(X) I X="" Q Y
"RTN","VPRD",48,0)
 I X["accession"    S Y="VPRDLRA",X="accessions"
"RTN","VPRD",49,0)
 I X["allerg"       S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",50,0)
 I X["appointment"  S Y="VPRDSDAM",X="appointments"
"RTN","VPRD",51,0)
 I X["clinicalProc" S Y="VPRDMC",X="clinicalProcedures"
"RTN","VPRD",52,0)
 I X["consult"      S Y="VPRDGMRC",X="consults"
"RTN","VPRD",53,0)
 I X["demograph"    S Y="VPRDPT",X="demographics"
"RTN","VPRD",54,0)
 I X["document"     S Y="VPRDTIU",X="documents"
"RTN","VPRD",55,0)
 I X["factor"       S Y="VPRDPXHF",X="healthFactors"
"RTN","VPRD",56,0)
 I X["flag"         S Y="VPRDGPF",X="flags"
"RTN","VPRD",57,0)
 I X["immunization" S Y="VPRDPXIM",X="immunizations"
"RTN","VPRD",58,0)
 I X["skin"         S Y="VPRDPXSK",X="skinTests"
"RTN","VPRD",59,0)
 I X?1"exam".E      S Y="VPRDPXAM",X="exams"
"RTN","VPRD",60,0)
 I X["educat"       S Y="VPRDPXED",X="educationTopics"
"RTN","VPRD",61,0)
 I X["insur"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",62,0)
 I X["polic"        S Y="VPRDIB",X="insurancePolicies"
"RTN","VPRD",63,0)
 I X["lab"          S Y="VPRDLR",X="labs"
"RTN","VPRD",64,0)
 I X["panel"        S Y="VPRDLRO",X="panels"
"RTN","VPRD",65,0)
 I X["med"          S Y="VPRDPS",X="meds"
"RTN","VPRD",66,0)
 I X["pharm"        S Y="VPRDPSOR",X="meds"
"RTN","VPRD",67,0)
 I X["observ"       S Y="VPRDMDC",X="observations"
"RTN","VPRD",68,0)
 I X["order"        S Y="VPRDOR",X="orders"
"RTN","VPRD",69,0)
 I X["patient"      S Y="VPRDPT",X="demographics"
"RTN","VPRD",70,0)
 I X["problem"      S Y="VPRDGMPL",X="problems"
"RTN","VPRD",71,0)
 I X["procedure"    S Y="VPRDPROC",X="procedures"
"RTN","VPRD",72,0)
 I X["reaction"     S Y="VPRDGMRA",X="reactions"
"RTN","VPRD",73,0)
 I X["surg"         S Y="VPRDSR",X="surgeries"
"RTN","VPRD",74,0)
 I X["visit"        S Y="VPRDVSIT",X="visits"
"RTN","VPRD",75,0)
 I X["vital"        S Y="VPRDGMV",X="vitals"
"RTN","VPRD",76,0)
 I X["rad"          S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",77,0)
 I X["xray"         S Y="VPRDRA",X="radiologyExams"
"RTN","VPRD",78,0)
 I X["new"          S Y="VPRDX",X="patients"
"RTN","VPRD",79,0)
 Q Y
"RTN","VPRD",80,0)
 ;
"RTN","VPRD",81,0)
TAG(X) ; -- return plural name for group tags
"RTN","VPRD",82,0)
 N Y S:X'?1.L X=$$LOW^XLFSTR(X)
"RTN","VPRD",83,0)
 I $E(X,$L(X))="s" S Y=X
"RTN","VPRD",84,0)
 I $E(X,$L(X))="y" S Y=$E(X,1,$L(X)-1)_"ies"
"RTN","VPRD",85,0)
 E  S Y=X_"s"
"RTN","VPRD",86,0)
 Q Y
"RTN","VPRD",87,0)
 ;
"RTN","VPRD",88,0)
ALL() ; -- return string for all types of data
"RTN","VPRD",89,0)
 Q "demographics;reactions;problems;vitals;labs;meds;immunizations;observation;visits;appointments;documents;procedures;consults;flags;factors;skinTests;exams;education;insurance"
"RTN","VPRD",90,0)
 ;
"RTN","VPRD",91,0)
ERR(X,VAL) ; -- return error message
"RTN","VPRD",92,0)
 N MSG  S MSG="Error"
"RTN","VPRD",93,0)
 I X=1  S MSG="Patient with dfn '"_$G(VAL)_"' not found"
"RTN","VPRD",94,0)
 I X=2  S MSG="Requested domain type '"_$G(VAL)_"' not recognized"
"RTN","VPRD",95,0)
 I X=99 S MSG="Unknown request"
"RTN","VPRD",96,0)
 ;
"RTN","VPRD",97,0)
 D ADD("<error>")
"RTN","VPRD",98,0)
 D ADD("<message>"_MSG_"</message>")
"RTN","VPRD",99,0)
 D ADD("</error>")
"RTN","VPRD",100,0)
 Q
"RTN","VPRD",101,0)
 ;
"RTN","VPRD",102,0)
ESC(X) ; -- escape outgoing XML
"RTN","VPRD",103,0)
 ; Q $ZCONVERT(X,"O","HTML")  ; uncomment for fastest performance on Cache
"RTN","VPRD",104,0)
 ;
"RTN","VPRD",105,0)
 N I,Y,QOT S QOT=""""
"RTN","VPRD",106,0)
 S Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"&amp;"_$P(X,"&",I)
"RTN","VPRD",107,0)
 S X=Y,Y=$P(X,"<") F I=2:1:$L(X,"<") S Y=Y_"&lt;"_$P(X,"<",I)
"RTN","VPRD",108,0)
 S X=Y,Y=$P(X,">") F I=2:1:$L(X,">") S Y=Y_"&gt;"_$P(X,">",I)
"RTN","VPRD",109,0)
 S X=Y,Y=$P(X,"'") F I=2:1:$L(X,"'") S Y=Y_"&apos;"_$P(X,"'",I)
"RTN","VPRD",110,0)
 S X=Y,Y=$P(X,QOT) F I=2:1:$L(X,QOT) S Y=Y_"&quot;"_$P(X,QOT,I)
"RTN","VPRD",111,0)
 Q Y
"RTN","VPRD",112,0)
 ;
"RTN","VPRD",113,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRD",114,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRD",115,0)
 S @VPR@(VPRI)=X
"RTN","VPRD",116,0)
 Q
"RTN","VPRD",117,0)
 ;
"RTN","VPRD",118,0)
STRING(ARRAY) ; -- Return text in ARRAY(n) or ARRAY(n,0) as a string
"RTN","VPRD",119,0)
 N I,X,Y S Y=""
"RTN","VPRD",120,0)
 S I=+$O(ARRAY("")) I I=0 S I=+$O(ARRAY(0))
"RTN","VPRD",121,0)
 S Y=$S($D(ARRAY(I,0)):ARRAY(I,0),1:$G(ARRAY(I)))
"RTN","VPRD",122,0)
 F  S I=$O(ARRAY(I)) Q:I<1  D
"RTN","VPRD",123,0)
 . S X=$S($D(ARRAY(I,0)):ARRAY(I,0),1:ARRAY(I))
"RTN","VPRD",124,0)
 . I $E(X)=" " S Y=Y_$C(13,10)_X Q
"RTN","VPRD",125,0)
 . S Y=Y_$S($E(Y,$L(Y))=" ":"",1:" ")_X
"RTN","VPRD",126,0)
 Q Y
"RTN","VPRD",127,0)
 ;
"RTN","VPRD",128,0)
FAC(X) ; -- return Institution file station# for location X
"RTN","VPRD",129,0)
 N HLOC,FAC,Y0,Y S Y=""
"RTN","VPRD",130,0)
 S HLOC=$G(^SC(+$G(X),0)),FAC=$P(HLOC,U,4)
"RTN","VPRD",131,0)
 ; Get P:4 via Med Ctr Div, if not directly linked
"RTN","VPRD",132,0)
 I 'FAC,$P(HLOC,U,15) S FAC=$$GET1^DIQ(44,+$G(X)_",","3.5:.07","I")
"RTN","VPRD",133,0)
 S Y0=$S(FAC:$$NS^XUAF4(FAC),1:$P($$SITE^VASITE,U,2,3)) ;name^stn#
"RTN","VPRD",134,0)
 S:$L(Y0) Y=$P(Y0,U,2)_U_$P(Y0,U) ;switch to stn#^name
"RTN","VPRD",135,0)
 I $L(Y),'Y S $P(Y,U)=FAC
"RTN","VPRD",136,0)
 Q Y
"RTN","VPRD",137,0)
 ;
"RTN","VPRD",138,0)
VUID(IEN,FILE) ; -- Return VUID for item
"RTN","VPRD",139,0)
 Q $$GET1^DIQ(FILE,IEN_",",99.99)
"RTN","VPRD",140,0)
 ;
"RTN","VPRD",141,0)
VERSION(RET) ; -- Return current version of data extracts
"RTN","VPRD",142,0)
 S RET="1.01"
"RTN","VPRD",143,0)
 Q
"RTN","VPRDGMPL")
0^27^B27790775^B20610705
"RTN","VPRDGMPL",1,0)
VPRDGMPL ;SLC/MKB -- Problem extract ;8/2/11  15:29
"RTN","VPRDGMPL",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDGMPL",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMPL",4,0)
 ;
"RTN","VPRDGMPL",5,0)
 ; External References          DBIA#
"RTN","VPRDGMPL",6,0)
 ; -------------------          -----
"RTN","VPRDGMPL",7,0)
 ; ^AUPNPROB                     5703
"RTN","VPRDGMPL",8,0)
 ; ^DPT                         10035
"RTN","VPRDGMPL",9,0)
 ; ^VA(200                      10060
"RTN","VPRDGMPL",10,0)
 ; ^WV(790.05                    5772
"RTN","VPRDGMPL",11,0)
 ; %DT                          10003
"RTN","VPRDGMPL",12,0)
 ; DIQ                           2056
"RTN","VPRDGMPL",13,0)
 ; GMPLUTL2                      2741
"RTN","VPRDGMPL",14,0)
 ; SDUTL3                        1252
"RTN","VPRDGMPL",15,0)
 ; XLFDT                        10103
"RTN","VPRDGMPL",16,0)
 ; XUAF4                         2171
"RTN","VPRDGMPL",17,0)
 ;
"RTN","VPRDGMPL",18,0)
 ; ------------ Get problems from VistA ------------
"RTN","VPRDGMPL",19,0)
 ;
"RTN","VPRDGMPL",20,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's problems
"RTN","VPRDGMPL",21,0)
 N VPRSTS,VPRPROB,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDGMPL",22,0)
 ;
"RTN","VPRDGMPL",23,0)
 ; get one problem
"RTN","VPRDGMPL",24,0)
 I $G(IFN)="WV" D WV(.VPRITM,1),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDGMPL",25,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMPL",26,0)
 ;
"RTN","VPRDGMPL",27,0)
 ; get all patient problems
"RTN","VPRDGMPL",28,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMPL",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMPL",30,0)
 S VPRSTS=$G(FILTER("status")) ;default = all problems
"RTN","VPRDGMPL",31,0)
 D LIST^GMPLUTL2(.VPRPROB,DFN,VPRSTS)
"RTN","VPRDGMPL",32,0)
 S VPRN=0 F  S VPRN=$O(VPRPROB(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDGMPL",33,0)
 . S X=$P(VPRPROB(VPRN),U,5) I X,(X<BEG)!(X>END) Q  ;onset
"RTN","VPRDGMPL",34,0)
 . S X=+VPRPROB(VPRN) K VPRITM ;ien
"RTN","VPRDGMPL",35,0)
 . D EN1(X,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMPL",36,0)
 . S VPRCNT=VPRCNT+1
"RTN","VPRDGMPL",37,0)
 I $P($G(^DPT(DFN,0)),U,2)="F" D WV(.VPRITM),XML(.VPRITM):$D(VPRITM)
"RTN","VPRDGMPL",38,0)
 Q
"RTN","VPRDGMPL",39,0)
 ;
"RTN","VPRDGMPL",40,0)
EN1(ID,PROB) ; -- return a problem in PROB("attribute")=value
"RTN","VPRDGMPL",41,0)
 N VPRL,X,I,J K PROB
"RTN","VPRDGMPL",42,0)
 S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMPL",43,0)
 D DETAIL^GMPLUTL2(ID,.VPRL) Q:'$D(VPRL)  ;doesn't exist
"RTN","VPRDGMPL",44,0)
 S PROB("id")=ID ;,PROB("lexiconID")=+X1 ;SNOMED?
"RTN","VPRDGMPL",45,0)
 S PROB("name")=$G(VPRL("NARRATIVE"))
"RTN","VPRDGMPL",46,0)
 S X=$G(VPRL("MODIFIED")) S:$L(X) PROB("updated")=$$DATE(X)
"RTN","VPRDGMPL",47,0)
 S PROB("icd")=$G(VPRL("DIAGNOSIS"))
"RTN","VPRDGMPL",48,0)
 S X=$G(VPRL("STATUS")) S:$L(X) PROB("status")=$E(X)_U_X
"RTN","VPRDGMPL",49,0)
 S X=$G(VPRL("HISTORY"))  S:$L(X) PROB("history")=$E(X)_U_X
"RTN","VPRDGMPL",50,0)
 S X=$G(VPRL("PRIORITY")) S:$L(X) PROB("acuity")=$E(X)_U_X
"RTN","VPRDGMPL",51,0)
 S X=$G(VPRL("ONSET")) S:$L(X) PROB("onset")=$$DATE(X)
"RTN","VPRDGMPL",52,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.07,"I") S:X PROB("resolved")=X
"RTN","VPRDGMPL",53,0)
 S X=$P($G(VPRL("ENTERED")),U)  S:$L(X) PROB("entered")=$$DATE(X)
"RTN","VPRDGMPL",54,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.02,"I")
"RTN","VPRDGMPL",55,0)
 S:X="P" PROB("unverified")=0,PROB("removed")=0
"RTN","VPRDGMPL",56,0)
 S:X="T" PROB("unverified")=1,PROB("removed")=0
"RTN","VPRDGMPL",57,0)
 S:X="H" PROB("unverified")=0,PROB("removed")=1
"RTN","VPRDGMPL",58,0)
 S X=$G(VPRL("SC")),X=$S(X="YES":1,X="NO":0,1:"")
"RTN","VPRDGMPL",59,0)
 S:$L(X) PROB("sc")=X I $G(VPRL("EXPOSURE")) D   ;ao^rad^pgulf^hnc^mst^cv
"RTN","VPRDGMPL",60,0)
 . S I=0 F  S I=$O(VPRL("EXPOSURE",I)) Q:I<1  D
"RTN","VPRDGMPL",61,0)
 .. S X=$G(VPRL("EXPOSURE",I))
"RTN","VPRDGMPL",62,0)
 .. S PROB("exposure",I)=$$EXP(X)
"RTN","VPRDGMPL",63,0)
 S X=$G(VPRL("PROVIDER")) S:$L(X) PROB("provider")=$$GET1^DIQ(9000011,ID_",",1.05,"I")_U_X
"RTN","VPRDGMPL",64,0)
 S X=$$GET1^DIQ(9000011,ID_",",1.06) S:$L(X) PROB("service")=X
"RTN","VPRDGMPL",65,0)
 S X=$G(VPRL("CLINIC")) S:$L(X) PROB("location")=X
"RTN","VPRDGMPL",66,0)
 S X=+$$GET1^DIQ(9000011,ID_",",.06,"I")
"RTN","VPRDGMPL",67,0)
 S:X PROB("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDGMPL",68,0)
 I 'X S PROB("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMPL",69,0)
CMT ; comments
"RTN","VPRDGMPL",70,0)
 Q:'$G(VPRL("COMMENT"))
"RTN","VPRDGMPL",71,0)
 S I=0 F  S I=$O(VPRL("COMMENT",I)) Q:I<1  D
"RTN","VPRDGMPL",72,0)
 . S X=$G(VPRL("COMMENT",I))
"RTN","VPRDGMPL",73,0)
 . S PROB("comment",I)=$$DATE($P(X,U))_U_$P(X,U,2,3)
"RTN","VPRDGMPL",74,0)
 . ; = date ^ name of author ^ text
"RTN","VPRDGMPL",75,0)
 Q
"RTN","VPRDGMPL",76,0)
 ;
"RTN","VPRDGMPL",77,0)
WV(PROB,UPD) ; -- return a pregnancy log entry in PROB("attribute")=value
"RTN","VPRDGMPL",78,0)
 N I,X0,Y K PROB
"RTN","VPRDGMPL",79,0)
 S I=$O(^WV(790.05,"C",DFN,""),-1) Q:'I    ;last entry
"RTN","VPRDGMPL",80,0)
 S X0=$G(^WV(790.05,I,0)),Y=0
"RTN","VPRDGMPL",81,0)
 ; status=YES, future due date (allow past 14 days)
"RTN","VPRDGMPL",82,0)
 I $P(X0,U,3),$P(X0,U,4)'<$$FMADD^XLFDT(DT,-14) S Y=1
"RTN","VPRDGMPL",83,0)
 I 'Y,'$G(UPD) Q
"RTN","VPRDGMPL",84,0)
 ; continue if pregnant, or update requested
"RTN","VPRDGMPL",85,0)
 S PROB("id")="WV",PROB("entered")=+X0
"RTN","VPRDGMPL",86,0)
 S PROB("name")="Pregnancy",PROB("icd")="V22.2"
"RTN","VPRDGMPL",87,0)
 ; PROB("problemType")=64572001            ;HITSP/Condition
"RTN","VPRDGMPL",88,0)
 S PROB("status")=$S(Y:"A^ACTIVE",1:"I^INACTIVE")
"RTN","VPRDGMPL",89,0)
 S PROB("resolved")=$P(X0,U,4)             ;due date
"RTN","VPRDGMPL",90,0)
 S PROB("provider")=$$OUTPTPR^SDUTL3(DFN)  ;primary care
"RTN","VPRDGMPL",91,0)
 S PROB("facility")=$$FAC^VPRD
"RTN","VPRDGMPL",92,0)
 Q
"RTN","VPRDGMPL",93,0)
 ;
"RTN","VPRDGMPL",94,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMPL",95,0)
 N %DT,Y
"RTN","VPRDGMPL",96,0)
 S %DT="" D ^%DT S:Y<1 Y=X
"RTN","VPRDGMPL",97,0)
 Q Y
"RTN","VPRDGMPL",98,0)
 ;
"RTN","VPRDGMPL",99,0)
VA200(X) ; -- Return ien of New Person X
"RTN","VPRDGMPL",100,0)
 N Y S Y=$S($L($G(X)):+$O(^VA(200,"B",X,0)),1:"")
"RTN","VPRDGMPL",101,0)
 Q Y
"RTN","VPRDGMPL",102,0)
 ;
"RTN","VPRDGMPL",103,0)
EXP(X) ; -- Return code for exposure name X
"RTN","VPRDGMPL",104,0)
 N Y S Y="",X=$E($G(X))
"RTN","VPRDGMPL",105,0)
 I X="A" S Y="AO"  ;agent orange
"RTN","VPRDGMPL",106,0)
 I X="R" S Y="IR"  ;ionizing radiation
"RTN","VPRDGMPL",107,0)
 I X="E" S Y="PG"  ;persian gulf
"RTN","VPRDGMPL",108,0)
 I X="H" S Y="HNC" ;head/neck cancer
"RTN","VPRDGMPL",109,0)
 I X="M" S Y="MST" ;military sexual trauma
"RTN","VPRDGMPL",110,0)
 I X="C" S Y="CV"  ;combat vet
"RTN","VPRDGMPL",111,0)
 I X="S" S Y="SHAD"
"RTN","VPRDGMPL",112,0)
 Q Y
"RTN","VPRDGMPL",113,0)
 ;
"RTN","VPRDGMPL",114,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMPL",115,0)
 ;
"RTN","VPRDGMPL",116,0)
XML(PROB) ; -- Return patient problem as XML in @VPR@(I)
"RTN","VPRDGMPL",117,0)
 N ATT,I,X,Y,P,TAG
"RTN","VPRDGMPL",118,0)
 D ADD("<problem>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMPL",119,0)
 S ATT="" F  S ATT=$O(PROB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMPL",120,0)
 . I ATT="exposure" D  S Y="" Q
"RTN","VPRDGMPL",121,0)
 .. S Y="<exposures>" D ADD(Y)
"RTN","VPRDGMPL",122,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) S:$L(X) Y="<exposure value='"_X_"' />" D ADD(Y)
"RTN","VPRDGMPL",123,0)
 .. D ADD("</exposures>")
"RTN","VPRDGMPL",124,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMPL",125,0)
 .. D ADD("<comments>")
"RTN","VPRDGMPL",126,0)
 .. S I=0 F  S I=$O(PROB(ATT,I)) Q:I<1  S X=$G(PROB(ATT,I)) D
"RTN","VPRDGMPL",127,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMPL",128,0)
 ... S:$L($P(X,U,1)) Y=Y_"' entered='"_$P(X,U)
"RTN","VPRDGMPL",129,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMPL",130,0)
 ... S:$L($P(X,U,3)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,3))
"RTN","VPRDGMPL",131,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMPL",132,0)
 .. D ADD("</comments>")
"RTN","VPRDGMPL",133,0)
 . S X=$G(PROB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMPL",134,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMPL",135,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMPL",136,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMPL",137,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMPL",138,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMPL",139,0)
 D ADD("</problem>")
"RTN","VPRDGMPL",140,0)
 Q
"RTN","VPRDGMPL",141,0)
 ;
"RTN","VPRDGMPL",142,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMPL",143,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMPL",144,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMPL",145,0)
 Q
"RTN","VPRDGMRA")
0^22^B22392321^B21412184
"RTN","VPRDGMRA",1,0)
VPRDGMRA ;SLC/MKB -- Allergy/Reaction extract ;8/2/11  15:29
"RTN","VPRDGMRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDGMRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRA",4,0)
 ;
"RTN","VPRDGMRA",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRA",6,0)
 ; -------------------          -----
"RTN","VPRDGMRA",7,0)
 ; ^VA(200                      10060
"RTN","VPRDGMRA",8,0)
 ; %DT                          10003
"RTN","VPRDGMRA",9,0)
 ; GMRADPT                      10099
"RTN","VPRDGMRA",10,0)
 ; EN1^GMRAOR2                   2422
"RTN","VPRDGMRA",11,0)
 ; PSN50P41                      4531
"RTN","VPRDGMRA",12,0)
 ; PSN50P65                      4543
"RTN","VPRDGMRA",13,0)
 ;
"RTN","VPRDGMRA",14,0)
 ; ------------ Get reactions from VistA ------------
"RTN","VPRDGMRA",15,0)
 ;
"RTN","VPRDGMRA",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's allergies/reactions
"RTN","VPRDGMRA",17,0)
 N GMRA,GMRAL,VPRN,VPRITM,VPRCNT
"RTN","VPRDGMRA",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRA",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDGMRA",20,0)
 D EN1^GMRADPT
"RTN","VPRDGMRA",21,0)
 ;
"RTN","VPRDGMRA",22,0)
 ; get one reaction
"RTN","VPRDGMRA",23,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMRA",24,0)
 ;
"RTN","VPRDGMRA",25,0)
 ; get all reactions
"RTN","VPRDGMRA",26,0)
 I 'GMRAL D  Q
"RTN","VPRDGMRA",27,0)
 . S VPRITM("assessment")=$S(GMRAL=0:"nka",1:"not done")
"RTN","VPRDGMRA",28,0)
 . S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMRA",29,0)
 . D XML(.VPRITM)
"RTN","VPRDGMRA",30,0)
 S VPRN=0 F  S VPRN=+$O(GMRAL(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDGMRA",31,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDGMRA",32,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDGMRA",33,0)
 Q
"RTN","VPRDGMRA",34,0)
 ;
"RTN","VPRDGMRA",35,0)
EN1(ID,REAC) ; -- return a reaction in REAC("attribute")=value
"RTN","VPRDGMRA",36,0)
 ;          from EN: expects GMRAL(ID)
"RTN","VPRDGMRA",37,0)
 N VPRY,GMRA,I,J,X,Y,SEV,TXT,SEV K REAC
"RTN","VPRDGMRA",38,0)
 S GMRA=$G(GMRAL(ID)) D EN1^GMRAOR2(ID,"VPRY")
"RTN","VPRDGMRA",39,0)
 S X=$P(VPRY,U,10) I $L(X) S X=$$DATE(X) Q:X<BEG  Q:X>END  S REAC("entered")=X
"RTN","VPRDGMRA",40,0)
 S REAC("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDGMRA",41,0)
 S REAC("id")=ID,REAC("name")=$P(VPRY,U) I $P(GMRA,U,9) D
"RTN","VPRDGMRA",42,0)
 . S X=$P(GMRA,U,9),Y=+$P(X,"(",2) I 'Y,X["PSDRUG" S Y=50
"RTN","VPRDGMRA",43,0)
 . S REAC("localCode")=X,REAC("vuid")=$$VUID^VPRD(+X,Y)
"RTN","VPRDGMRA",44,0)
 S X=$P(VPRY,U,6) S:$L(X) REAC("mechanism")=X
"RTN","VPRDGMRA",45,0)
 S X=$P(VPRY,U,5),REAC("source")=$E(X)
"RTN","VPRDGMRA",46,0)
 S REAC("type")=$S($L(GMRA):$P(GMRA,U,7),1:$$DFO($P(VPRY,U,7)))_U_$P(VPRY,U,7)
"RTN","VPRDGMRA",47,0)
 I $P(VPRY,U,4)="VERIFIED",$P(VPRY,U,9) S REAC("verified")=$P(VPRY,U,9)
"RTN","VPRDGMRA",48,0)
 S I=0,SEV="" F  S I=$O(VPRY("O",I)) Q:I<1  S X=$P(VPRY("O",I),U,2) S:X]SEV SEV=X ;find highest severity
"RTN","VPRDGMRA",49,0)
 S:$L(SEV) REAC("severity")=SEV
"RTN","VPRDGMRA",50,0)
 ; reactions
"RTN","VPRDGMRA",51,0)
 S I=0 F  S I=$O(GMRAL(ID,"S",I)) Q:I<1  D
"RTN","VPRDGMRA",52,0)
 . S X=$G(GMRAL(ID,"S",I)),Y=+$P(X,";",2)
"RTN","VPRDGMRA",53,0)
 . S REAC("reaction",I)=$P(X,";")_U_$$VUID^VPRD(Y,120.83)
"RTN","VPRDGMRA",54,0)
 ; comments
"RTN","VPRDGMRA",55,0)
 S I=0 F  S I=$O(VPRY("C",I)) Q:I<1  D
"RTN","VPRDGMRA",56,0)
 . S X=$G(VPRY("C",I)) K TXT
"RTN","VPRDGMRA",57,0)
 . S Y=$$VA200($P(X,U,3))_U_$P(X,U)
"RTN","VPRDGMRA",58,0)
 . S Y=Y_U_$S($L($P(X,U,2)):$E($P(X,U,2)),1:"E")
"RTN","VPRDGMRA",59,0)
 . S J=0 F  S J=$O(VPRY("C",I,J)) Q:J<1  S X=$G(VPRY("C",I,J,0)),TXT(J)=X
"RTN","VPRDGMRA",60,0)
 . K X S X=$$STRING^VPRD(.TXT)
"RTN","VPRDGMRA",61,0)
 . S REAC("comment",I)=Y_U_X ;ien^name^date^type^text
"RTN","VPRDGMRA",62,0)
 ; drug info
"RTN","VPRDGMRA",63,0)
 I $D(VPRY("I")) D
"RTN","VPRDGMRA",64,0)
 . N ROOT S ROOT=$$B^PSN50P41
"RTN","VPRDGMRA",65,0)
 . S I=0 F  S I=$O(VPRY("I",I)) Q:I<1  S X=$G(VPRY("I",I)) D
"RTN","VPRDGMRA",66,0)
 .. N IEN S IEN=$O(@ROOT@(X,0))
"RTN","VPRDGMRA",67,0)
 .. S REAC("drugIngredient",I)=X_U_$$VUID^VPRD(IEN,50.416)
"RTN","VPRDGMRA",68,0)
 I $D(VPRY("V")) D
"RTN","VPRDGMRA",69,0)
 . S I=0 F  S I=$O(VPRY("V",I)) Q:I<1  S X=$G(VPRY("V",I)) D
"RTN","VPRDGMRA",70,0)
 .. D C^PSN50P65("",$P(X,U,2),"PSN")
"RTN","VPRDGMRA",71,0)
 .. N IEN S IEN=+$O(^TMP($J,"PSN","C",$P(X,U),0))
"RTN","VPRDGMRA",72,0)
 .. S REAC("drugClass",I)=$P(X,U,2)_U_$$VUID^VPRD(IEN,50.605)
"RTN","VPRDGMRA",73,0)
 I GMRA="" S REAC("removed")=1 ;entered in error
"RTN","VPRDGMRA",74,0)
 Q
"RTN","VPRDGMRA",75,0)
 ;
"RTN","VPRDGMRA",76,0)
VA200(NAME) ; -- Return ien^name from #200
"RTN","VPRDGMRA",77,0)
 N Y S NAME=$G(NAME),Y="^"
"RTN","VPRDGMRA",78,0)
 I $L(NAME) S Y=+$O(^VA(200,"B",NAME,0))_U_NAME
"RTN","VPRDGMRA",79,0)
 Q Y
"RTN","VPRDGMRA",80,0)
 ;
"RTN","VPRDGMRA",81,0)
DATE(X) ; -- Return internal form of date X
"RTN","VPRDGMRA",82,0)
 N %DT,Y
"RTN","VPRDGMRA",83,0)
 S %DT="TX" D ^%DT
"RTN","VPRDGMRA",84,0)
 Q Y
"RTN","VPRDGMRA",85,0)
 ;
"RTN","VPRDGMRA",86,0)
DFO(X) ; -- Return 'DFO' string for mechanism name(s)
"RTN","VPRDGMRA",87,0)
 N I,P,Y S Y=""
"RTN","VPRDGMRA",88,0)
 F I=1:1:$L(X,",") S P=$P(X,",",I),Y=Y_$S($E(P)=" ":$E(P,2),1:$E(P))
"RTN","VPRDGMRA",89,0)
 S:Y="" Y=$G(X)
"RTN","VPRDGMRA",90,0)
 Q Y
"RTN","VPRDGMRA",91,0)
 ;
"RTN","VPRDGMRA",92,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRA",93,0)
 ;
"RTN","VPRDGMRA",94,0)
XML(REAC) ; -- Return patient reaction as XML
"RTN","VPRDGMRA",95,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRA",96,0)
 N ATT,X,Y,I,P,NM,TAG
"RTN","VPRDGMRA",97,0)
 D ADD("<allergy>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRA",98,0)
 S ATT="" F  S ATT=$O(REAC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRA",99,0)
 . I ATT="comment" D  S Y="" Q
"RTN","VPRDGMRA",100,0)
 .. S I=0,Y="<comments>" D ADD(Y)
"RTN","VPRDGMRA",101,0)
 .. F  S I=$O(REAC(ATT,I)) Q:I<1  S X=$G(REAC(ATT,I)) D
"RTN","VPRDGMRA",102,0)
 ... S Y="<comment id='"_I
"RTN","VPRDGMRA",103,0)
 ... S:$L($P(X,U,3)) Y=Y_"' entered='"_$P(X,U,3)
"RTN","VPRDGMRA",104,0)
 ... S:$L($P(X,U,2)) Y=Y_"' enteredBy='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDGMRA",105,0)
 ... S:$L($P(X,U,4)) Y=Y_"' commentType='"_$P(X,U,4)
"RTN","VPRDGMRA",106,0)
 ... S:$L($P(X,U,5)) Y=Y_"' commentText='"_$$ESC^VPRD($P(X,U,5))
"RTN","VPRDGMRA",107,0)
 ... S Y=Y_"' />" D ADD(Y)
"RTN","VPRDGMRA",108,0)
 .. D ADD("</comments>")
"RTN","VPRDGMRA",109,0)
 . I $O(REAC(ATT,0)) D  S Y="" Q
"RTN","VPRDGMRA",110,0)
 .. S NM=ATT_$S($E(ATT,$L(ATT))="s":"es",1:"s") D ADD("<"_NM_">")
"RTN","VPRDGMRA",111,0)
 .. S I=0 F  S I=$O(REAC(ATT,I)) Q:I<1  D
"RTN","VPRDGMRA",112,0)
 ... S X=$G(REAC(ATT,I)),Y="<"_ATT_" "
"RTN","VPRDGMRA",113,0)
 ... F P=1:1 S TAG=$P("name^vuid^severity^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRA",114,0)
 ... S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMRA",115,0)
 .. D ADD("</"_NM_">")
"RTN","VPRDGMRA",116,0)
 . S X=$G(REAC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRA",117,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRA",118,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDGMRA",119,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMRA",120,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRA",121,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMRA",122,0)
 D ADD("</allergy>")
"RTN","VPRDGMRA",123,0)
 Q
"RTN","VPRDGMRA",124,0)
 ;
"RTN","VPRDGMRA",125,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRA",126,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRA",127,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRA",128,0)
 Q
"RTN","VPRDGMRC")
0^23^B10880986^B10314726
"RTN","VPRDGMRC",1,0)
VPRDGMRC ;SLC/MKB -- Consult extract ;8/2/11  15:29
"RTN","VPRDGMRC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDGMRC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMRC",4,0)
 ;
"RTN","VPRDGMRC",5,0)
 ; External References          DBIA#
"RTN","VPRDGMRC",6,0)
 ; -------------------          -----
"RTN","VPRDGMRC",7,0)
 ; ^TIU(8925.1                   5677
"RTN","VPRDGMRC",8,0)
 ; DIQ                           2056
"RTN","VPRDGMRC",9,0)
 ; GMRCGUIB                      2980
"RTN","VPRDGMRC",10,0)
 ; GMRCSLM1,^TMP("GMRCR",$J)     2740
"RTN","VPRDGMRC",11,0)
 ; TIULQ                         2693
"RTN","VPRDGMRC",12,0)
 ; XUAF4                         2171
"RTN","VPRDGMRC",13,0)
 ;
"RTN","VPRDGMRC",14,0)
 ; ------------ Get consults from VistA ------------
"RTN","VPRDGMRC",15,0)
 ;
"RTN","VPRDGMRC",16,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's consults
"RTN","VPRDGMRC",17,0)
 N VPRN,VPRX,VPRITM K ^TMP("GMRCR",$J,"CS")
"RTN","VPRDGMRC",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMRC",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMRC",20,0)
 ;
"RTN","VPRDGMRC",21,0)
 D OER^GMRCSLM1(DFN,"",BEG,END,"")
"RTN","VPRDGMRC",22,0)
 S VPRN=0 F  S VPRN=$O(^TMP("GMRCR",$J,"CS",VPRN)) Q:VPRN<1!(VPRN>MAX)  S VPRX=$G(^(VPRN,0)) Q:$E(VPRX)="<"  D
"RTN","VPRDGMRC",23,0)
 . I $G(IFN),IFN'=+VPRX Q
"RTN","VPRDGMRC",24,0)
 . K VPRITM D EN1(+VPRX,.VPRITM),XML(.VPRITM)
"RTN","VPRDGMRC",25,0)
 K ^TMP("GMRCR",$J,"CS"),^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",26,0)
 Q
"RTN","VPRDGMRC",27,0)
 ;
"RTN","VPRDGMRC",28,0)
EN1(ID,CONS) ; -- return a consult in CONS("attribute")=value
"RTN","VPRDGMRC",29,0)
 ;     Expects DFN, VPRX=^TMP("GMRCR",$J,"CS",VPRN,0) [from EN]
"RTN","VPRDGMRC",30,0)
 N VPRD,X0,VPRJ,X,VPRTIU,LT,NT
"RTN","VPRDGMRC",31,0)
 K CONS,^TMP("VPRTEXT",$J)
"RTN","VPRDGMRC",32,0)
 S CONS("id")=ID,CONS("requested")=$P(VPRX,U,2)
"RTN","VPRDGMRC",33,0)
 S CONS("status")=$P(VPRX,U,3),CONS("service")=$P(VPRX,U,4)
"RTN","VPRDGMRC",34,0)
 S CONS("procedure")=$P(VPRX,U,5),CONS("name")=$P(VPRX,U,7)
"RTN","VPRDGMRC",35,0)
 I $P(VPRX,U,6)="*" S CONS("result")="SIGNIFICANT FINDINGS"
"RTN","VPRDGMRC",36,0)
 S CONS("orderID")=$P(VPRX,U,8),CONS("type")=$P(VPRX,U,9)
"RTN","VPRDGMRC",37,0)
 D DOCLIST^GMRCGUIB(.VPRD,ID) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDGMRC",38,0)
 S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=$G(VPRD(50,VPRJ)) D
"RTN","VPRDGMRC",39,0)
 . Q:'$D(@(U_$P(X,";",2)_+X_")"))  ;text deleted
"RTN","VPRDGMRC",40,0)
 . D EXTRACT^TIULQ(+X,"VPRTIU",,.01)
"RTN","VPRDGMRC",41,0)
 . S LT=$G(VPRTIU(+X,.01,"E")) ;print name
"RTN","VPRDGMRC",42,0)
 . S NT=$$GET1^DIQ(8925.1,+$G(VPRTIU(+X,.01,"I"))_",",1501)
"RTN","VPRDGMRC",43,0)
 . S CONS("document",VPRJ)=+X_U_LT_U_NT
"RTN","VPRDGMRC",44,0)
 . S:$G(VPRTEXT) CONS("document",VPRJ,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDGMRC",45,0)
 S X=$P(X0,U,21),CONS("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDGMRC",46,0)
 Q
"RTN","VPRDGMRC",47,0)
 ;
"RTN","VPRDGMRC",48,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMRC",49,0)
 ;
"RTN","VPRDGMRC",50,0)
XML(CONS) ; -- Return patient consult as XML
"RTN","VPRDGMRC",51,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDGMRC",52,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDGMRC",53,0)
 D ADD("<consult>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMRC",54,0)
 S ATT="" F  S ATT=$O(CONS(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDGMRC",55,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDGMRC",56,0)
 . I $O(CONS(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDGMRC",57,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDGMRC",58,0)
 .. S I=0 F  S I=$O(CONS(ATT,I)) Q:I<1  D
"RTN","VPRDGMRC",59,0)
 ... S X=$G(CONS(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDGMRC",60,0)
 ... S X=$G(CONS(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMRC",61,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDGMRC",62,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDGMRC",63,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDGMRC",64,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDGMRC",65,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDGMRC",66,0)
 . S X=$G(CONS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMRC",67,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDGMRC",68,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDGMRC",69,0)
 D ADD("</consult>")
"RTN","VPRDGMRC",70,0)
 Q
"RTN","VPRDGMRC",71,0)
 ;
"RTN","VPRDGMRC",72,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDGMRC",73,0)
 N STR,P,TAG S STR=""
"RTN","VPRDGMRC",74,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMRC",75,0)
 Q STR
"RTN","VPRDGMRC",76,0)
 ;
"RTN","VPRDGMRC",77,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMRC",78,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMRC",79,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMRC",80,0)
 Q
"RTN","VPRDGMV")
0^1^B41671211^B39440303
"RTN","VPRDGMV",1,0)
VPRDGMV ;SLC/MKB -- Vitals extract ;8/2/11  15:29
"RTN","VPRDGMV",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDGMV",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDGMV",4,0)
 ;
"RTN","VPRDGMV",5,0)
 ; External References          DBIA#
"RTN","VPRDGMV",6,0)
 ; -------------------          -----
"RTN","VPRDGMV",7,0)
 ; ^SC                          10040
"RTN","VPRDGMV",8,0)
 ; ^VA(200                      10060
"RTN","VPRDGMV",9,0)
 ; DILFD                         2055
"RTN","VPRDGMV",10,0)
 ; GMRVUT0,^UTILITY($J,"GMRVD")  1446
"RTN","VPRDGMV",11,0)
 ; GMVGETQL                      5048
"RTN","VPRDGMV",12,0)
 ; GMVGETVT                      5047
"RTN","VPRDGMV",13,0)
 ; GMVRPCM                       5702
"RTN","VPRDGMV",14,0)
 ; GMVUTL                        5046
"RTN","VPRDGMV",15,0)
 ;
"RTN","VPRDGMV",16,0)
 ; ------------ Get vitals from VistA ------------
"RTN","VPRDGMV",17,0)
 ;
"RTN","VPRDGMV",18,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find patient's vitals
"RTN","VPRDGMV",19,0)
 N VPRITM,VPRPARAM,GMRVSTR,IDT,TYPE,VIT,CNT,X0,X,Y,I,N
"RTN","VPRDGMV",20,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDGMV",21,0)
 ;
"RTN","VPRDGMV",22,0)
 ; get one measurement
"RTN","VPRDGMV",23,0)
 I $G(IFN),IFN?7N1"."1.6N S (BEG,END)=IFN K IFN
"RTN","VPRDGMV",24,0)
 I $G(IFN) D EN1(IFN,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDGMV",25,0)
 ;
"RTN","VPRDGMV",26,0)
 ; get all measurements
"RTN","VPRDGMV",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDGMV",28,0)
 S GMRVSTR="BP;T;R;P;HT;WT;CVP;CG;PO2;PN",GMRVSTR(0)=BEG_U_END_U_MAX_"^1"
"RTN","VPRDGMV",29,0)
 K ^UTILITY($J,"GMRVD") D EN1^GMRVUT0
"RTN","VPRDGMV",30,0)
 S (IDT,CNT)=0 F  S IDT=$O(^UTILITY($J,"GMRVD",IDT)) Q:IDT<1  D  Q:CNT'<MAX
"RTN","VPRDGMV",31,0)
 . K VIT S VIT("taken")=9999999-IDT,CNT=CNT+1,N=0
"RTN","VPRDGMV",32,0)
 . S TYPE="" F  S TYPE=$O(^UTILITY($J,"GMRVD",IDT,TYPE)) Q:TYPE=""  D
"RTN","VPRDGMV",33,0)
 .. N NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,QUAL
"RTN","VPRDGMV",34,0)
 .. S IFN=+$O(^UTILITY($J,"GMRVD",IDT,TYPE,0)),X0=$G(^(IFN))
"RTN","VPRDGMV",35,0)
 .. S X=+$P(X0,U,3),NAME=$$FIELD^GMVGETVT(X,1)
"RTN","VPRDGMV",36,0)
 .. S VUID=$$FIELD^GMVGETVT(X,4),RESULT=$P(X0,U,8),UNIT=$$UNIT(TYPE)
"RTN","VPRDGMV",37,0)
 .. S (MRES,MUNT)="" I $L($P(X0,U,13)) D
"RTN","VPRDGMV",38,0)
 ... S X=$S(TYPE="T":"C",TYPE="HT":"cm",TYPE="WT":"kg",TYPE="CG":"cm",1:"")
"RTN","VPRDGMV",39,0)
 ... S MRES=$P(X0,U,13) S:$L(X) MUNT=X
"RTN","VPRDGMV",40,0)
 .. S X=$$RANGE(TYPE),(HIGH,LOW)="" I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",41,0)
 .. S N=N+1,VIT("measurement",N)=IFN_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW
"RTN","VPRDGMV",42,0)
 .. S QUAL=$P(X0,U,17) I $L(QUAL) F I=1:1:$L(QUAL,";") D
"RTN","VPRDGMV",43,0)
 ... S X=$P(QUAL,";",I),Y=$$GETIEN^GMVGETQL(X,1)
"RTN","VPRDGMV",44,0)
 ... I Y S VIT("measurement",N,"qualifier",I)=X_U_$$FIELD^GMVGETQL(Y,3)
"RTN","VPRDGMV",45,0)
 . S VIT("entered")=$P($G(X0),U,4) ;use last one
"RTN","VPRDGMV",46,0)
 . S X=+$P($G(X0),U,5) S:X VIT("location")=$$LOC(X)
"RTN","VPRDGMV",47,0)
 . S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",48,0)
 . D XML(.VIT)
"RTN","VPRDGMV",49,0)
 K ^UTILITY($J,"GMRVD")
"RTN","VPRDGMV",50,0)
 Q
"RTN","VPRDGMV",51,0)
 ;
"RTN","VPRDGMV",52,0)
EN1(ID,VIT) ; -- return a vital/measurement in VIT("attribute")
"RTN","VPRDGMV",53,0)
 K VIT S ID=+$G(ID) Q:ID<1  ;invalid ien
"RTN","VPRDGMV",54,0)
 N VPRY,X0,DFN,TYPE,X,Y,NAME,VUID,RESULT,UNIT,MRES,MUNT,HIGH,LOW,I
"RTN","VPRDGMV",55,0)
 D GETREC^GMVUTL(.VPRY,ID,1) S X0=$G(VPRY(0))
"RTN","VPRDGMV",56,0)
 S DFN=+$P(X0,U,2) Q:DFN<1
"RTN","VPRDGMV",57,0)
 S TYPE=$$FIELD^GMVGETVT(+$P(X0,U,3),2)
"RTN","VPRDGMV",58,0)
 S X=+$P(X0,U,5),VIT("location")=$$LOC(X)
"RTN","VPRDGMV",59,0)
 S VIT("facility")=$$FAC^VPRD(X)
"RTN","VPRDGMV",60,0)
 S NAME=$$FIELD^GMVGETVT($P(X0,U,3),1),VUID=$$FIELD^GMVGETVT($P(X0,U,3),4)
"RTN","VPRDGMV",61,0)
 S X=$P(X0,U,8),RESULT=X,UNIT=$$UNIT(TYPE),(MRES,MUNT)=""
"RTN","VPRDGMV",62,0)
 I TYPE="T"  S MUNT="C",MRES=$J(X-32*5/9,0,1) ;EN1^GMRVUTL
"RTN","VPRDGMV",63,0)
 I TYPE="HT" S MUNT="cm",MRES=$J(2.54*X,0,2)  ;EN2^GMRVUTL
"RTN","VPRDGMV",64,0)
 I TYPE="WT" S MUNT="kg",MRES=$J(X/2.2,0,2)   ;EN3^GMRVUTL
"RTN","VPRDGMV",65,0)
 I TYPE="CG" S MUNT="cm",MRES=$J(2.54*X,0,2)
"RTN","VPRDGMV",66,0)
 S VIT("taken")=+X0,VIT("entered")=+$P(X0,U,4),(HIGH,LOW)=""
"RTN","VPRDGMV",67,0)
 S X=$$RANGE(TYPE) I $L(X) S HIGH=$P(X,U),LOW=$P(X,U,2)
"RTN","VPRDGMV",68,0)
 S VIT("measurement",1)=ID_U_VUID_U_NAME_U_RESULT_U_UNIT_U_MRES_U_MUNT_U_HIGH_U_LOW
"RTN","VPRDGMV",69,0)
 F I=1:1:$L(VPRY(5),U) S X=$P(VPRY(5),U,I),VIT("measurement",1,"qualifier",I)=$$FIELD^GMVGETQL(X,1)_U_$$FIELD^GMVGETQL(X,3) ;name^VUID
"RTN","VPRDGMV",70,0)
 I $G(VPRY(2)) D  ;entered in error/reasons
"RTN","VPRDGMV",71,0)
 . S X=$P(VPRY(2),U,3)
"RTN","VPRDGMV",72,0)
 . F I=1:1:$L(X,"~") S VIT("removed",I)=$$EXTERNAL^DILFD(120.506,.01,,$P(X,"~",I))
"RTN","VPRDGMV",73,0)
 Q
"RTN","VPRDGMV",74,0)
 ;
"RTN","VPRDGMV",75,0)
UNIT(X) ; -- Return unit for vital type X
"RTN","VPRDGMV",76,0)
 N Y S Y=""
"RTN","VPRDGMV",77,0)
 I TYPE="BP"  S Y="mm[Hg]"
"RTN","VPRDGMV",78,0)
 I TYPE="T"   S Y="F"
"RTN","VPRDGMV",79,0)
 I TYPE="R"   S Y="/min"
"RTN","VPRDGMV",80,0)
 I TYPE="P"   S Y="/min"
"RTN","VPRDGMV",81,0)
 I TYPE="HT"  S Y="in"
"RTN","VPRDGMV",82,0)
 I TYPE="WT"  S Y="lb"
"RTN","VPRDGMV",83,0)
 I TYPE="CVP" S Y="cmH2O"
"RTN","VPRDGMV",84,0)
 I TYPE="CG"  S Y="in"
"RTN","VPRDGMV",85,0)
 I TYPE="PO2" S Y="%"
"RTN","VPRDGMV",86,0)
 Q Y
"RTN","VPRDGMV",87,0)
 ;
"RTN","VPRDGMV",88,0)
USER(X) ; -- Return ien^name for person# X
"RTN","VPRDGMV",89,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",90,0)
 S Y=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:"^")
"RTN","VPRDGMV",91,0)
 Q Y
"RTN","VPRDGMV",92,0)
 ;
"RTN","VPRDGMV",93,0)
LOC(X) ; -- Return ien^name for hospital location X
"RTN","VPRDGMV",94,0)
 N Y S X=+$G(X)
"RTN","VPRDGMV",95,0)
 S Y=$S(X:X_U_$P($G(^SC(X,0)),U),1:"^")
"RTN","VPRDGMV",96,0)
 Q Y
"RTN","VPRDGMV",97,0)
 ;
"RTN","VPRDGMV",98,0)
RANGE(TYPE) ; -- return high^low range of values for TYPE
"RTN","VPRDGMV",99,0)
 N Y I '$D(VPRPARAM(TYPE)) D  ;get parameter values
"RTN","VPRDGMV",100,0)
 . N VPRFLDS,VPRI,VPRY,VPRN,VPRX,X
"RTN","VPRDGMV",101,0)
 . S VPRFLDS=$S(TYPE="T":"5.1^5.2",TYPE="P":"5.3^5.4",TYPE="R":"5.5^5.6",TYPE="CVP":"6.1^6.2",TYPE="PO2":6.3,TYPE="BP":"5.7^5.71^5.8^5.81",1:"") Q:VPRFLDS=""
"RTN","VPRDGMV",102,0)
 . F VPRI=1:1:$L(VPRFLDS,U) S VPRN=$P(VPRFLDS,U,VPRI) D RPC^GMVRPCM(.VPRY,"GETHILO",VPRN) S VPRX(VPRN)=$G(@VPRY@(0))
"RTN","VPRDGMV",103,0)
 . I TYPE="T" S VPRPARAM(TYPE)=$G(VPRX(5.1))_U_$G(VPRX(5.2))
"RTN","VPRDGMV",104,0)
 . I TYPE="P" S VPRPARAM(TYPE)=$G(VPRX(5.3))_U_$G(VPRX(5.4))
"RTN","VPRDGMV",105,0)
 . I TYPE="R" S VPRPARAM(TYPE)=$G(VPRX(5.5))_U_$G(VPRX(5.6))
"RTN","VPRDGMV",106,0)
 . I TYPE="CVP" S VPRPARAM(TYPE)=$G(VPRX(6.1))_U_$G(VPRX(6.2))
"RTN","VPRDGMV",107,0)
 . I TYPE="PO2" S VPRPARAM(TYPE)="100^"_$G(VPRX(6.3))
"RTN","VPRDGMV",108,0)
 . I TYPE="BP" S VPRPARAM(TYPE)=$G(VPRX(5.7))_"/"_$G(VPRX(5.71))_U_$G(VPRX(5.8))_"/"_$G(VPRX(5.81))
"RTN","VPRDGMV",109,0)
 S Y=$G(VPRPARAM(TYPE))
"RTN","VPRDGMV",110,0)
 Q Y
"RTN","VPRDGMV",111,0)
 ;
"RTN","VPRDGMV",112,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDGMV",113,0)
 ;
"RTN","VPRDGMV",114,0)
NAME(X) ; -- Return name of measurement type X for XML element
"RTN","VPRDGMV",115,0)
 N Y S X=$G(X),Y=""
"RTN","VPRDGMV",116,0)
 S Y=$S(X="BP":"bloodPressure",X="T":"temperature",X="R":"respiration",X="P":"pulse",X="HT":"height",X="WT":"weight",X="CVP":"centralVenousPressure",X="CG":"circumferenceGirth",X="PO2":"pulseOximetry",X="PN":"pain",1:"")
"RTN","VPRDGMV",117,0)
 Q Y
"RTN","VPRDGMV",118,0)
 ;
"RTN","VPRDGMV",119,0)
XML(VIT) ; -- Return vital measurement as XML in @VPR@(#)
"RTN","VPRDGMV",120,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDGMV",121,0)
 D ADD("<vital>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDGMV",122,0)
 S ATT="" F  S ATT=$O(VIT(ATT)) Q:ATT=""  D
"RTN","VPRDGMV",123,0)
 . I ATT="measurement" D  Q
"RTN","VPRDGMV",124,0)
 .. D ADD("<measurements>")
"RTN","VPRDGMV",125,0)
 .. S NAMES="id^vuid^name^value^units^metricValue^metricUnits^high^low^Z"
"RTN","VPRDGMV",126,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  D
"RTN","VPRDGMV",127,0)
 ... S X=$G(VIT(ATT,I)),Y="<"_ATT_" "
"RTN","VPRDGMV",128,0)
 ... F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",129,0)
 ... I '$D(VIT(ATT,I,"qualifier")) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDGMV",130,0)
 ... S Y=Y_">" D ADD(Y),ADD("<qualifiers>")
"RTN","VPRDGMV",131,0)
 ... S J=0 F  S J=$O(VIT(ATT,I,"qualifier",J)) Q:J<1  D
"RTN","VPRDGMV",132,0)
 .... S Y="<qualifier ",X=$G(VIT(ATT,I,"qualifier",J))
"RTN","VPRDGMV",133,0)
 .... F P=1:1 S TAG=$P("name^vuid^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",134,0)
 .... S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",135,0)
 ... D ADD("</qualifiers>"),ADD("</measurement>")
"RTN","VPRDGMV",136,0)
 .. D ADD("</measurements>")
"RTN","VPRDGMV",137,0)
 . I ATT="removed" D  Q
"RTN","VPRDGMV",138,0)
 .. D ADD("<removed>")
"RTN","VPRDGMV",139,0)
 .. S I=0 F  S I=$O(VIT(ATT,I)) Q:I<1  S Y="<reason value='"_$G(VIT(ATT,I))_"' />" D ADD(Y)
"RTN","VPRDGMV",140,0)
 .. D ADD("</removed>")
"RTN","VPRDGMV",141,0)
 . S X=$G(VIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDGMV",142,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDGMV",143,0)
 . I $L(X)>1 D
"RTN","VPRDGMV",144,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDGMV",145,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDGMV",146,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDGMV",147,0)
 D ADD("</vital>")
"RTN","VPRDGMV",148,0)
 Q
"RTN","VPRDGMV",149,0)
 ;
"RTN","VPRDGMV",150,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDGMV",151,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDGMV",152,0)
 S @VPR@(VPRI)=X
"RTN","VPRDGMV",153,0)
 Q
"RTN","VPRDIB")
0^2^B12692505^n/a
"RTN","VPRDIB",1,0)
VPRDIB ;SLC/MKB -- Integrated Billing (insurance) ;3/14/12  09:01
"RTN","VPRDIB",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01,2011;Build 38
"RTN","VPRDIB",3,0)
 ;
"RTN","VPRDIB",4,0)
 ; External References          DBIA#
"RTN","VPRDIB",5,0)
 ; -------------------          -----
"RTN","VPRDIB",6,0)
 ;   IBBAPI                      4419
"RTN","VPRDIB",7,0)
 ;
"RTN","VPRDIB",8,0)
 ;
"RTN","VPRDIB",9,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDIB",10,0)
 ;
"RTN","VPRDIB",11,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's insurance data
"RTN","VPRDIB",12,0)
 N X,I,VPRX,VPRITM,VPRCNT,VPRINS
"RTN","VPRDIB",13,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDIB",14,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDIB",15,0)
 ;
"RTN","VPRDIB",16,0)
 ; get one policy
"RTN","VPRDIB",17,0)
 ;I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDIB",18,0)
 ;
"RTN","VPRDIB",19,0)
 ; get all policies
"RTN","VPRDIB",20,0)
 S X=$$INSUR^IBBAPI(DFN,,,.VPRX,"*") Q:X<1
"RTN","VPRDIB",21,0)
 S (I,VPRCNT)=0 F  S I=$O(VPRX("IBBAPI","INSUR",I)) Q:I<1  D  Q:VPRCNT'<MAX
"RTN","VPRDIB",22,0)
 . M VPRINS=VPRX("IBBAPI","INSUR",I) K VPRITM
"RTN","VPRDIB",23,0)
 . I $G(ID),DFN'=+ID!(+VPRINS(1)'=$P(ID,";",2))!(+VPRINS(8)'=$P(ID,";",3)) Q
"RTN","VPRDIB",24,0)
 . S VPRITM("id")=DFN_";"_+VPRINS(1)_";"_+VPRINS(8) ; = DFN;COMPANY;POLICY
"RTN","VPRDIB",25,0)
 . S VPRITM("company")=VPRINS(1),X=VPRINS(2)
"RTN","VPRDIB",26,0)
 . F J=23,24,3,4,5 S X=X_U_VPRINS(J)
"RTN","VPRDIB",27,0)
 . S VPRITM("company","address")=X
"RTN","VPRDIB",28,0)
 . S X=VPRINS(6) S:$L(X) VPRITM("company","telecom")=$$FORMAT(X)
"RTN","VPRDIB",29,0)
 . S VPRITM("effectiveDate")=VPRINS(10)
"RTN","VPRDIB",30,0)
 . S VPRITM("expirationDate")=VPRINS(11)
"RTN","VPRDIB",31,0)
 . S VPRITM("groupName")=$P(VPRINS(8),U,2)
"RTN","VPRDIB",32,0)
 . S VPRITM("groupNumber")=VPRINS(18)
"RTN","VPRDIB",33,0)
 . S X=VPRINS(21),VPRITM("insuranceType")=X
"RTN","VPRDIB",34,0)
 . ; VPRITM("insuranceType")=$$GET^XPAR(355.1,+X_",",.03) ;Maj Catg
"RTN","VPRDIB",35,0)
 . S VPRITM("relationship")=$P(VPRINS(19),U,2)
"RTN","VPRDIB",36,0)
 . S VPRITM("subscriber")=VPRINS(14)_U_VPRINS(13)
"RTN","VPRDIB",37,0)
 . ; VPRITM("subscriber","address")
"RTN","VPRDIB",38,0)
 . ; VPRITM("subscriber","telecom")
"RTN","VPRDIB",39,0)
 . ; VPRITM("memberID")
"RTN","VPRDIB",40,0)
 . S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDIB",41,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDIB",42,0)
 Q
"RTN","VPRDIB",43,0)
 ;
"RTN","VPRDIB",44,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDIB",45,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDIB",46,0)
 N P,N,I,Y S P=""
"RTN","VPRDIB",47,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDIB",48,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDIB",49,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDIB",50,0)
 Q Y
"RTN","VPRDIB",51,0)
 ;
"RTN","VPRDIB",52,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDIB",53,0)
 ;
"RTN","VPRDIB",54,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDIB",55,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDIB",56,0)
 N ATT,X,Y,I,SUB
"RTN","VPRDIB",57,0)
 D ADD("<insurancePolicy>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDIB",58,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDIB",59,0)
 . S X=$G(ITEM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDIB",60,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)
"RTN","VPRDIB",61,0)
 . I $L(X,"^")>1 S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))
"RTN","VPRDIB",62,0)
 . S SUB=$O(ITEM(ATT,"")) I SUB="" S Y=Y_"' />" Q
"RTN","VPRDIB",63,0)
 . S Y=Y_"' >" D ADD(Y) S X=$G(ITEM(ATT,SUB))
"RTN","VPRDIB",64,0)
 . I SUB="address" D ADDR(X)
"RTN","VPRDIB",65,0)
 . I SUB="telecom" D PHONE(X)
"RTN","VPRDIB",66,0)
 . S Y="</"_ATT_">"
"RTN","VPRDIB",67,0)
 D ADD("</insurancePolicy>")
"RTN","VPRDIB",68,0)
 Q
"RTN","VPRDIB",69,0)
 ;
"RTN","VPRDIB",70,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDIB",71,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDIB",72,0)
 S Y="<address"
"RTN","VPRDIB",73,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDIB",74,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDIB",75,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDIB",76,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDIB",77,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDIB",78,0)
 Q
"RTN","VPRDIB",79,0)
 ;
"RTN","VPRDIB",80,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDIB",81,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDIB",82,0)
 D ADD("<telecomList>")
"RTN","VPRDIB",83,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDIB",84,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDIB",85,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDIB",86,0)
 D ADD("</telecomList>")
"RTN","VPRDIB",87,0)
 Q
"RTN","VPRDIB",88,0)
 ;
"RTN","VPRDIB",89,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDIB",90,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDIB",91,0)
 S @VPR@(VPRI)=X
"RTN","VPRDIB",92,0)
 Q
"RTN","VPRDLRA")
0^24^B76300469^B69605973
"RTN","VPRDLRA",1,0)
VPRDLRA ;SLC/MKB -- Laboratory extract by accession ;8/2/11  15:29
"RTN","VPRDLRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDLRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDLRA",4,0)
 ;
"RTN","VPRDLRA",5,0)
 ; External References          DBIA#
"RTN","VPRDLRA",6,0)
 ; -------------------          -----
"RTN","VPRDLRA",7,0)
 ; ^DPT                         10035
"RTN","VPRDLRA",8,0)
 ; ^LAB(60                      10054
"RTN","VPRDLRA",9,0)
 ; ^LAB(61                        524
"RTN","VPRDLRA",10,0)
 ; ^LRO(68                       1963
"RTN","VPRDLRA",11,0)
 ; ^LRO(69                       2407
"RTN","VPRDLRA",12,0)
 ; ^LR                            525
"RTN","VPRDLRA",13,0)
 ; ^SC                          10040
"RTN","VPRDLRA",14,0)
 ; ^VA(200                      10060
"RTN","VPRDLRA",15,0)
 ; DIC                           2051
"RTN","VPRDLRA",16,0)
 ; DIQ                           2056
"RTN","VPRDLRA",17,0)
 ; LR7OR1,^TMP("LRRR",$J)        2503
"RTN","VPRDLRA",18,0)
 ; LR7OSUM,^TMP("LRC",$J),       2766
"RTN","VPRDLRA",19,0)
 ;  ^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",20,0)
 ; ORX8                          2467
"RTN","VPRDLRA",21,0)
 ; PXAPI                         1894
"RTN","VPRDLRA",22,0)
 ; XUAF4                         2171
"RTN","VPRDLRA",23,0)
 ;
"RTN","VPRDLRA",24,0)
 ; ------------ Get results from VistA ------------
"RTN","VPRDLRA",25,0)
 ;
"RTN","VPRDLRA",26,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's lab results
"RTN","VPRDLRA",27,0)
 N VPRSUB,VPRIDT,VPRN,VPRITM,LRDFN,LR0,ORD,X
"RTN","VPRDLRA",28,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",29,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",30,0)
 S LRDFN=$G(^DPT(DFN,"LR")),VPRSUB=$G(FILTER("type"))
"RTN","VPRDLRA",31,0)
 K ^TMP("LRRR",$J,DFN)
"RTN","VPRDLRA",32,0)
 ;
"RTN","VPRDLRA",33,0)
 ; get result(s)
"RTN","VPRDLRA",34,0)
 I $L($G(ID)) D  ;reset search parameters
"RTN","VPRDLRA",35,0)
 . S VPRSUB=$P(ID,";"),VPRIDT=+$P(ID,";",2)
"RTN","VPRDLRA",36,0)
 . S:VPRIDT (BEG,END)=9999999-VPRIDT
"RTN","VPRDLRA",37,0)
 ;
"RTN","VPRDLRA",38,0)
 D RR^LR7OR1(DFN,,BEG,END,VPRSUB,,,MAX)
"RTN","VPRDLRA",39,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",40,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",41,0)
 .. K VPRITM,ORD,CMMT,^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",42,0)
 .. I "CH^MI"'[VPRSUB D AP(.VPRITM),XML(.VPRITM) Q
"RTN","VPRDLRA",43,0)
 .. S VPRITM("type")=VPRSUB,VPRITM("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",44,0)
 .. S VPRITM("collected")=9999999-VPRIDT,VPRITM("status")="completed"
"RTN","VPRDLRA",45,0)
 .. S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRA",46,0)
 .. S VPRITM("resulted")=$P(LR0,U,3),X=+$P(LR0,U,5) I X D
"RTN","VPRDLRA",47,0)
 ... N IENS,VPRY S IENS=X_","
"RTN","VPRDLRA",48,0)
 ... D GETS^DIQ(61,IENS,".01;2;4.1",,"VPRY")
"RTN","VPRDLRA",49,0)
 ... S VPRITM("specimen")=$G(VPRY(61,IENS,2))_U_$G(VPRY(61,IENS,.01)) ;SNOMED^name
"RTN","VPRDLRA",50,0)
 ... S VPRITM("sample")=$G(VPRY(61,IENS,4.1)) ;name
"RTN","VPRDLRA",51,0)
 .. S X=$P(LR0,U,6),VPRITM("name")=$$AREA(X),VPRITM("groupName")=X
"RTN","VPRDLRA",52,0)
 .. S X=+$P(LR0,U,14) S:X VPRITM("facility")=$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U)
"RTN","VPRDLRA",53,0)
 .. I 'X S VPRITM("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDLRA",54,0)
 .. I VPRSUB="MI" D  ;report
"RTN","VPRDLRA",55,0)
 ... S VPRITM("document",1)=VPRSUB_";"_VPRIDT_"^LR MICROBIOLOGY REPORT^LABORATORY NOTE"
"RTN","VPRDLRA",56,0)
 ... S:$G(VPRTEXT) VPRITM("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",57,0)
 .. S VPRN=0 F  S VPRN=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,VPRN)) Q:VPRN<1  D
"RTN","VPRDLRA",58,0)
 ... S X=$S(VPRSUB="MI":$$MI,1:$$CH)
"RTN","VPRDLRA",59,0)
 ... S:$L(X) VPRITM("value",VPRN)=X
"RTN","VPRDLRA",60,0)
 ... S:$G(ORD) VPRITM("labOrderID")=ORD
"RTN","VPRDLRA",61,0)
 .. I $D(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT,"N")) M CMMT=^("N") S VPRITM("comment")=$$STRING^VPRD(.CMMT)
"RTN","VPRDLRA",62,0)
 .. D XML(.VPRITM)
"RTN","VPRDLRA",63,0)
 K ^TMP("LRRR",$J,DFN),^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",64,0)
 Q
"RTN","VPRDLRA",65,0)
 ;
"RTN","VPRDLRA",66,0)
CH() ; -- return a Chemistry result as:
"RTN","VPRDLRA",67,0)
 ;   id^test^result^interpretation^units^low^high^localName^loinc^vuid^order
"RTN","VPRDLRA",68,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN),LRDFN
"RTN","VPRDLRA",69,0)
 N X,Y,X0,NODE,CMMT,LOINC
"RTN","VPRDLRA",70,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"CH",VPRIDT,VPRN)),NODE=$G(^LR(LRDFN,"CH",VPRIDT,VPRN))
"RTN","VPRDLRA",71,0)
 S X=$P($G(^LAB(60,+X0,0)),U)
"RTN","VPRDLRA",72,0)
 S Y="CH;"_VPRIDT_";"_VPRN_U_X_U_$P(X0,U,2,4)
"RTN","VPRDLRA",73,0)
 S X=$P(X0,U,5) I $L(X),X["-" S X=$TR(X,"- ","^"),$P(Y,U,6,7)=X
"RTN","VPRDLRA",74,0)
 S $P(Y,U,8)=$P(X0,U,15) ;test short name
"RTN","VPRDLRA",75,0)
 S X=$P($P(NODE,U,3),"!",3) S:X LOINC=$$GET1^DIQ(95.3,X_",",.01)
"RTN","VPRDLRA",76,0)
 S:$G(LOINC) $P(Y,U,9,10)=LOINC_U_$$VUID^VPRD(+LOINC,95.3)
"RTN","VPRDLRA",77,0)
 S ORD=+$P(X0,U,17),X=$$ORDER(ORD,+X0) S:X $P(Y,U,11)=X
"RTN","VPRDLRA",78,0)
 Q Y
"RTN","VPRDLRA",79,0)
 ;
"RTN","VPRDLRA",80,0)
MI() ; -- return a Microbiology result as:
"RTN","VPRDLRA",81,0)
 ;   id^test^result^interpretation^units
"RTN","VPRDLRA",82,0)
 ;   Expects ^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)
"RTN","VPRDLRA",83,0)
 N Y,X0
"RTN","VPRDLRA",84,0)
 S X0=$G(^TMP("LRRR",$J,DFN,"MI",VPRIDT,VPRN)),Y=""
"RTN","VPRDLRA",85,0)
 S:$L($P(X0,U))>1 Y="MI;"_VPRIDT_";"_VPRN_U_$P(X0,U,1,4)
"RTN","VPRDLRA",86,0)
 S ORD=+$P(X0,U,17)
"RTN","VPRDLRA",87,0)
 Q Y
"RTN","VPRDLRA",88,0)
 ;
"RTN","VPRDLRA",89,0)
AP(LAB) ; -- return a Pathology result in LAB("attribute")=value
"RTN","VPRDLRA",90,0)
 N LR0,X,I,NODE
"RTN","VPRDLRA",91,0)
 S LR0=$G(^LR(LRDFN,VPRSUB,VPRIDT,0))
"RTN","VPRDLRA",92,0)
 S LAB("type")=VPRSUB,LAB("id")=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",93,0)
 S LAB("collected")=9999999-VPRIDT,LAB("status")="completed"
"RTN","VPRDLRA",94,0)
 S LAB("resulted")=$P(LR0,U,11),LAB("groupName")=$P(LR0,U,6)
"RTN","VPRDLRA",95,0)
 S X="",I=0 F  S I=$O(^LR(LRDFN,VPRSUB,VPRIDT,.1,I)) Q:I<1  S X=X_$S($L(X):", ",1:"")_$P($G(^(I,0)),U)
"RTN","VPRDLRA",96,0)
 S:$L(X) LAB("specimen")=U_X
"RTN","VPRDLRA",97,0)
 S LAB("facility")=$$FAC^VPRD
"RTN","VPRDLRA",98,0)
 S NODE=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",99,0)
 S I=0 F  S I=$O(@NODE@(I)) Q:I<1  S X=+$P($G(@NODE@(I,0)),U,2) I X D
"RTN","VPRDLRA",100,0)
 . N LT,NT,VPRY
"RTN","VPRDLRA",101,0)
 . S LT=$$GET1^DIQ(8925,+X_",",.01) Q:$P(LT," ")="Addendum"
"RTN","VPRDLRA",102,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501") S:NT="" NT="LABORATORY NOTE"
"RTN","VPRDLRA",103,0)
 . S LAB("document",I)=+X_U_LT_U_NT
"RTN","VPRDLRA",104,0)
 . S:$G(VPRTEXT) LAB("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDLRA",105,0)
 I '$O(LAB("document",0)) D  ;non-TIU reports
"RTN","VPRDLRA",106,0)
 . S LAB("document",1)=VPRSUB_";"_VPRIDT_"^LR "_$$NAME(VPRSUB)_" REPORT^LABORATORY NOTE"
"RTN","VPRDLRA",107,0)
 . S:$G(VPRTEXT) LAB("document",1,"content")=$$TEXT(DFN,VPRSUB,VPRIDT)
"RTN","VPRDLRA",108,0)
 Q
"RTN","VPRDLRA",109,0)
 ;
"RTN","VPRDLRA",110,0)
ORDER(LABORD,TEST) ; -- return #100 order^name for Lab order# & Test
"RTN","VPRDLRA",111,0)
 N Y,D,S,T
"RTN","VPRDLRA",112,0)
 S D=$P(9999999-VPRIDT,"."),Y=""
"RTN","VPRDLRA",113,0)
 S S=0 F  S S=$O(^LRO(69,"C",LABORD,D,S)) Q:S<1  D  Q:Y
"RTN","VPRDLRA",114,0)
 . S T=0 F  S T=$O(^LRO(69,D,1,S,2,T)) Q:T<1  I 'TEST!(+$G(^(T,0))=TEST) S Y=+$P(^(0),U,7)
"RTN","VPRDLRA",115,0)
 ;I Y S Y=Y_U_$P($$OI^ORX8(Y),U,2)
"RTN","VPRDLRA",116,0)
 Q Y
"RTN","VPRDLRA",117,0)
 ;
"RTN","VPRDLRA",118,0)
NAME(X) ; -- Return name of subscript X
"RTN","VPRDLRA",119,0)
 I X="AU" Q "AUTOPSY"
"RTN","VPRDLRA",120,0)
 I X="BB" Q "BLOOD BANK"
"RTN","VPRDLRA",121,0)
 I X="CH" Q "CHEM,HEM,TOX,RIA,SER,etc."
"RTN","VPRDLRA",122,0)
 I X="CY" Q "CYTOPATHOLOGY"
"RTN","VPRDLRA",123,0)
 I X="EM" Q "ELECTRON MICROSCOPY"
"RTN","VPRDLRA",124,0)
 I X="MI" Q "MICROBIOLOGY"
"RTN","VPRDLRA",125,0)
 I X="SP" Q "SURGICAL PATHOLOGY"
"RTN","VPRDLRA",126,0)
 Q "ANATOMIC PATHOLOGY"
"RTN","VPRDLRA",127,0)
 ;
"RTN","VPRDLRA",128,0)
AREA(ACCNUM) ; -- Return name of accession area
"RTN","VPRDLRA",129,0)
 N X,Y,VPRA
"RTN","VPRDLRA",130,0)
 S X=$P($G(ACCNUM)," "),Y=""
"RTN","VPRDLRA",131,0)
 I $L(X) D FIND^DIC(68,,.01,"QX",X,,,,,"VPRA")
"RTN","VPRDLRA",132,0)
 S Y=$G(VPRA("DILIST",1,1))
"RTN","VPRDLRA",133,0)
 Q Y
"RTN","VPRDLRA",134,0)
 ;
"RTN","VPRDLRA",135,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDLRA",136,0)
 ;
"RTN","VPRDLRA",137,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's lab reports
"RTN","VPRDLRA",138,0)
 N VPRSUB,VPRIDT,VPRITM,VPRTIU,VPRXID,LRDFN,VPRN,DA
"RTN","VPRDLRA",139,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDLRA",140,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDLRA",141,0)
 S LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",142,0)
 K ^TMP("LRRR",$J,DFN) D RR^LR7OR1(DFN,,BEG,END,"AP",,,MAX)
"RTN","VPRDLRA",143,0)
 S VPRSUB="" F  S VPRSUB=$O(^TMP("LRRR",$J,DFN,VPRSUB)) Q:VPRSUB=""  D
"RTN","VPRDLRA",144,0)
 . S VPRIDT=0 F  S VPRIDT=$O(^TMP("LRRR",$J,DFN,VPRSUB,VPRIDT)) Q:VPRIDT<1  I $O(^(VPRIDT,0)) D
"RTN","VPRDLRA",145,0)
 .. S VPRTIU=$S(VPRSUB="AU":$NA(^LR(LRDFN,101)),1:$NA(^LR(LRDFN,VPRSUB,VPRIDT,.05)))
"RTN","VPRDLRA",146,0)
 .. K VPRITM S VPRXID=VPRSUB_";"_VPRIDT
"RTN","VPRDLRA",147,0)
 .. I '$O(@VPRTIU@(0)) D RPT1(DFN,VPRXID,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM) Q
"RTN","VPRDLRA",148,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRTIU@(VPRN)) Q:VPRN<1  D
"RTN","VPRDLRA",149,0)
 ... S DA=+$P($G(@VPRTIU@(VPRN,0)),U,2) Q:DA<1  K VPRITM
"RTN","VPRDLRA",150,0)
 ... D EN1^VPRDTIU(DA,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDLRA",151,0)
 K ^TMP("LRRR",$J,DFN),^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",152,0)
 Q
"RTN","VPRDLRA",153,0)
 ;
"RTN","VPRDLRA",154,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDLRA",155,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:'$L(ID)
"RTN","VPRDLRA",156,0)
 N SUB,IDT,LRDFN,LR0,X,LOC
"RTN","VPRDLRA",157,0)
 K RPT,^TMP("VPRTEXT",$J)
"RTN","VPRDLRA",158,0)
 S SUB=$P(ID,";"),IDT=+$P(ID,";",2),LRDFN=$G(^DPT(DFN,"LR"))
"RTN","VPRDLRA",159,0)
 S LR0=$S(SUB="AU":$G(^LR(LRDFN,"AU")),1:$G(^LR(LRDFN,SUB,IDT,0)))
"RTN","VPRDLRA",160,0)
 S RPT("id")=ID,RPT("referenceDateTime")=9999999-IDT
"RTN","VPRDLRA",161,0)
 S RPT("localTitle")="LR "_$$NAME(SUB)_" REPORT"
"RTN","VPRDLRA",162,0)
 S RPT("documentClass")="LR LABORATORY REPORTS"
"RTN","VPRDLRA",163,0)
 S RPT("nationalTitle")="4697105^LABORATORY NOTE"
"RTN","VPRDLRA",164,0)
 S RPT("nationalTitleSubject")="4697104^LABORATORY"
"RTN","VPRDLRA",165,0)
 S RPT("nationalTitleType")="4696120^NOTE"
"RTN","VPRDLRA",166,0)
 S RPT("type")="LR",RPT("status")="COMPLETED"
"RTN","VPRDLRA",167,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDLRA",168,0)
 S X=$P(LR0,U,$S(SUB="AU":5,1:8)),LOC="" S:$L(X) LOC=+$O(^SC("B",X,0))
"RTN","VPRDLRA",169,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDLRA",170,0)
 I LOC D  ;look-up visit
"RTN","VPRDLRA",171,0)
 . N CDT S CDT=9999999-IDT
"RTN","VPRDLRA",172,0)
 . S X=$$GETENC^PXAPI(DFN,CDT,LOC)
"RTN","VPRDLRA",173,0)
 . S:X RPT("encounter")=+X
"RTN","VPRDLRA",174,0)
 S X=+$P(LR0,U,$S(SUB="AU":10,1:2)) ;pathologist
"RTN","VPRDLRA",175,0)
 S:X RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A"
"RTN","VPRDLRA",176,0)
 S X=$S(SUB="AU":$P(LR0,U,15,16),1:$P(LR0,U,11)_U_$P(LR0,U,13)) I X D
"RTN","VPRDLRA",177,0)
 . N Y S Y=$P(X,U,2)
"RTN","VPRDLRA",178,0)
 . S RPT("clinician",2)=Y_U_$P($G(^VA(200,+Y,0)),U)_"^S^"_+X_U_$P($G(^VA(200,+Y,20)),U,2)
"RTN","VPRDLRA",179,0)
 S:$G(VPRTEXT) RPT("content")=$$TEXT(DFN,SUB,IDT)
"RTN","VPRDLRA",180,0)
 Q
"RTN","VPRDLRA",181,0)
 ;
"RTN","VPRDLRA",182,0)
TEXT(DFN,SUB,IDT) ; -- Get report text, return temp array name
"RTN","VPRDLRA",183,0)
 N LRDFN,DATE,NAME,VPRS,VPRY,I,X,Y
"RTN","VPRDLRA",184,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",185,0)
 S DATE=9999999-+$G(IDT),NAME=$$NAME(SUB),VPRS(NAME)=""
"RTN","VPRDLRA",186,0)
 D EN^LR7OSUM(.VPRY,DFN,DATE,DATE,,,.VPRS)
"RTN","VPRDLRA",187,0)
 S Y=$NA(^TMP("VPRTEXT",$J,SUB_";"_IDT)) K @Y
"RTN","VPRDLRA",188,0)
 S I=+$G(^TMP("LRH",$J,NAME)) ;LRH=header
"RTN","VPRDLRA",189,0)
 F  S I=$O(^TMP("LRC",$J,I)) Q:I<1  S X=$G(^(I,0)) Q:X?1."="  S @Y@(I)=X
"RTN","VPRDLRA",190,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J),^TMP("LRT",$J)
"RTN","VPRDLRA",191,0)
 Q Y
"RTN","VPRDLRA",192,0)
 ;
"RTN","VPRDLRA",193,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDLRA",194,0)
 ;
"RTN","VPRDLRA",195,0)
XML(LAB) ; -- Return result as XML in @VPR@(#)
"RTN","VPRDLRA",196,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDLRA",197,0)
 D ADD("<accession>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDLRA",198,0)
 S ATT="" F  S ATT=$O(LAB(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDLRA",199,0)
 . I $O(LAB(ATT,0)) D  S Y="" Q
"RTN","VPRDLRA",200,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDLRA",201,0)
 .. S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",ATT="value":"id^test^result^interpretation^units^low^high^localName^loinc^vuid^order^Z",1:"code^name^Z")
"RTN","VPRDLRA",202,0)
 .. S I=0 F  S I=$O(LAB(ATT,I)) Q:I<1  D
"RTN","VPRDLRA",203,0)
 ... S X=$G(LAB(ATT,I))
"RTN","VPRDLRA",204,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDLRA",205,0)
 ... S X=$G(LAB(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDLRA",206,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDLRA",207,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDLRA",208,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDLRA",209,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDLRA",210,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDLRA",211,0)
 . S X=$G(LAB(ATT)),Y="" Q:'$L(X)
"RTN","VPRDLRA",212,0)
 . I ATT="comment" S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDLRA",213,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDLRA",214,0)
 . I $L(X)>1 D  S Y=""
"RTN","VPRDLRA",215,0)
 .. S NAMES="code^name^Z"
"RTN","VPRDLRA",216,0)
 .. S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDLRA",217,0)
 D ADD("</accession>")
"RTN","VPRDLRA",218,0)
 Q
"RTN","VPRDLRA",219,0)
 ;
"RTN","VPRDLRA",220,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDLRA",221,0)
 N STR,P,TAG S STR=""
"RTN","VPRDLRA",222,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDLRA",223,0)
 Q STR
"RTN","VPRDLRA",224,0)
 ;
"RTN","VPRDLRA",225,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDLRA",226,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDLRA",227,0)
 S @VPR@(VPRI)=X
"RTN","VPRDLRA",228,0)
 Q
"RTN","VPRDMC")
0^3^B58328454^n/a
"RTN","VPRDMC",1,0)
VPRDMC ;SLC/MKB -- Clinical Procedures (Medicine) ;3/14/12  09:03
"RTN","VPRDMC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDMC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDMC",4,0)
 ;
"RTN","VPRDMC",5,0)
 ; External References          DBIA#
"RTN","VPRDMC",6,0)
 ; -------------------          -----
"RTN","VPRDMC",7,0)
 ; ^SC                          10040
"RTN","VPRDMC",8,0)
 ; ^TIU(8925.1                   5677
"RTN","VPRDMC",9,0)
 ; ^VA(200                      10060
"RTN","VPRDMC",10,0)
 ; %DT                          10003
"RTN","VPRDMC",11,0)
 ; DILFD                         2055
"RTN","VPRDMC",12,0)
 ; DIQ                           2056
"RTN","VPRDMC",13,0)
 ; GMRCGUIB                      2980
"RTN","VPRDMC",14,0)
 ; ICPTCOD                       1995
"RTN","VPRDMC",15,0)
 ; MCARUTL2                      3279
"RTN","VPRDMC",16,0)
 ; MCARUTL3                      3280
"RTN","VPRDMC",17,0)
 ; MDPS1,^TMP("MDHSP"/"MDPTXT"   4230
"RTN","VPRDMC",18,0)
 ; TIULQ                         2693
"RTN","VPRDMC",19,0)
 ; TIUSRVLO                      2834
"RTN","VPRDMC",20,0)
 ; XUAF4                         2171
"RTN","VPRDMC",21,0)
 ;
"RTN","VPRDMC",22,0)
 ; ------------ Get procedures from VistA ------------
"RTN","VPRDMC",23,0)
 ;
"RTN","VPRDMC",24,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's procedures
"RTN","VPRDMC",25,0)
 N VPRITM,RES,VPRN,VPRX,RTN,DATE,CONS,TIUN,X0,DA,GBL,X,Y,%DT,VPRT,LT,NT,LOC
"RTN","VPRDMC",26,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDMC",27,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDMC",28,0)
 ;
"RTN","VPRDMC",29,0)
 ; get one procedure
"RTN","VPRDMC",30,0)
 I $G(ID) D  ;reset dates for MDPS1
"RTN","VPRDMC",31,0)
 . N VPRMC,IEN,FILE
"RTN","VPRDMC",32,0)
 . S IEN=+ID,FILE=+$P(ID,"(",2) Q:FILE=702
"RTN","VPRDMC",33,0)
 . D MEDLKUP^MCARUTL3(.VPRMC,FILE,IEN)
"RTN","VPRDMC",34,0)
 . S X=$P(VPRMC,U,6) S:X (BEG,END)=X
"RTN","VPRDMC",35,0)
 ;
"RTN","VPRDMC",36,0)
 ; get all procedures
"RTN","VPRDMC",37,0)
 K ^TMP("MDHSP",$J) S RES=""
"RTN","VPRDMC",38,0)
 D EN1^MDPS1(RES,DFN,BEG,END,MAX,"",0)
"RTN","VPRDMC",39,0)
 S VPRN=0 F  S VPRN=$O(^TMP("MDHSP",$J,VPRN)) Q:VPRN<1  S VPRX=$G(^(VPRN)) D
"RTN","VPRDMC",40,0)
 . I $G(ID),ID'=+$P(VPRX,U,2) Q              ;update one procedure
"RTN","VPRDMC",41,0)
 . S RTN=$P(VPRX,U,3,4) Q:RTN="PRPRO^MDPS4"  ;skip non-CP items
"RTN","VPRDMC",42,0)
 . S X=$P(VPRX,U,6),%DT="TX" D ^%DT S:Y>0 DATE=Y
"RTN","VPRDMC",43,0)
 . S GBL=+$P(VPRX,U,2)_";"_$S(RTN="PR702^MDPS1":"MDD(702,",1:$$ROOT(DFN,$P(VPRX,U,11),DATE))
"RTN","VPRDMC",44,0)
 . Q:'GBL  I $G(ID),ID'=GBL Q                ;unknown, or not requested
"RTN","VPRDMC",45,0)
 . ;
"RTN","VPRDMC",46,0)
 . S CONS=+$P(VPRX,U,13) D:CONS DOCLIST^GMRCGUIB(.VPRD,CONS) S X0=$G(VPRD(0)) ;=^GMR(123,ID,0)
"RTN","VPRDMC",47,0)
 . S TIUN=+$P(VPRX,U,14) S:TIUN TIUN=TIUN_U_$$RESOLVE^TIUSRVLO(TIUN)
"RTN","VPRDMC",48,0)
A . ;
"RTN","VPRDMC",49,0)
 . K VPRITM S VPRITM("id")=GBL,VPRITM("name")=$P(VPRX,U)
"RTN","VPRDMC",50,0)
 . S VPRITM("dateTime")=DATE,VPRITM("category")="CP"
"RTN","VPRDMC",51,0)
 . S X=$P(VPRX,U,7) S:$L(X) VPRITM("interpretation")=X
"RTN","VPRDMC",52,0)
 . I CONS,X0 D
"RTN","VPRDMC",53,0)
 .. N VPRJ S VPRITM("consult")=CONS
"RTN","VPRDMC",54,0)
 .. S VPRITM("requested")=+X0,VPRITM("order")=+$P(X0,U,3)
"RTN","VPRDMC",55,0)
 .. S VPRITM("status")=$$EXTERNAL^DILFD(123,8,,$P(X0,U,12))
"RTN","VPRDMC",56,0)
 .. S VPRJ=0 F  S VPRJ=$O(VPRD(50,VPRJ)) Q:VPRJ<1  S X=+$G(VPRD(50,VPRJ)) D
"RTN","VPRDMC",57,0)
 ... K VPRT D EXTRACT^TIULQ(X,"VPRT",,.01) S LT=$G(VPRT(X,.01,"E"))
"RTN","VPRDMC",58,0)
 ... S NT=$$GET1^DIQ(8925.1,+$G(VPRT(X,.01,"I"))_",",1501)
"RTN","VPRDMC",59,0)
 ... S VPRITM("document",X)=X_U_LT_U_NT  ;ien^local^national title
"RTN","VPRDMC",60,0)
 ... S:$G(VPRTEXT) VPRITM("document",X,"content")=$$TEXT^VPRDTIU(X)
"RTN","VPRDMC",61,0)
 ... S:'TIUN TIUN=X ;get supporting fields
"RTN","VPRDMC",62,0)
B . ;
"RTN","VPRDMC",63,0)
 . I TIUN D
"RTN","VPRDMC",64,0)
 .. S X=$P(TIUN,U,5) S:X VPRITM("provider")=+X_U_$P(X,";",3)
"RTN","VPRDMC",65,0)
 .. S:$P(TIUN,U,11) VPRITM("hasImages")=1
"RTN","VPRDMC",66,0)
 .. K VPRT D EXTRACT^TIULQ(+TIUN,"VPRT",,".03;.05;1211",,,"I")
"RTN","VPRDMC",67,0)
 .. S VPRITM("encounter")=+$G(VPRT(+TIUN,.03,"I"))
"RTN","VPRDMC",68,0)
 .. S LOC=+$G(VPRT(+TIUN,1211,"I")) I LOC S LOC=LOC_U_$P($G(^SC(LOC,0)),U)
"RTN","VPRDMC",69,0)
 .. E  S X=$P(TIUN,U,6) S:$L(X) LOC=+$O(^SC("B",X,0))_U_X
"RTN","VPRDMC",70,0)
 .. S:LOC VPRITM("location")=LOC,VPRITM("facility")=$$FAC^VPRD(+LOC)
"RTN","VPRDMC",71,0)
 .. I '$D(VPRITM("status")) S X=+$G(VPRT(+TIUN,.05,"I")),VPRITM("status")=$S(X<6:"PARTIAL RESULTS",1:"COMPLETE")
"RTN","VPRDMC",72,0)
 .. I '$G(VPRITM("document",+TIUN)) D
"RTN","VPRDMC",73,0)
 ... K VPRT D EXTRACT^TIULQ(+TIUN,"VPRT",,.01,,,"I")
"RTN","VPRDMC",74,0)
 ... S NT=$$GET1^DIQ(8925.1,+$G(VPRT(+TIUN,.01,"I"))_",",1501)
"RTN","VPRDMC",75,0)
 ... S VPRITM("document",+TIUN)=$P(TIUN,U,1,2)_U_NT  ;ien^local^national title
"RTN","VPRDMC",76,0)
 ... S:$G(VPRTEXT) VPRITM("document",+TIUN,"content")=$$TEXT^VPRDTIU(+TIUN)
"RTN","VPRDMC",77,0)
C . ;
"RTN","VPRDMC",78,0)
 . ; if no consult or note/visit ...
"RTN","VPRDMC",79,0)
 . I '$D(VPRITM("facility")) S X=$P(X0,U,21),VPRITM("facility")=$S(X:$$STA^XUAF4(X)_U_$P($$NS^XUAF4(X),U),1:$$FAC^VPRD)
"RTN","VPRDMC",80,0)
 . I '$D(VPRITM("status")) S VPRITM("status")="COMPLETE"
"RTN","VPRDMC",81,0)
 . ;I DA D  ;get CPT code from #697.2
"RTN","VPRDMC",82,0)
 . ;. K VPRT D GETS^DIQ(697.2,DA_",","1000*",,"VPRT")
"RTN","VPRDMC",83,0)
 . ;. N IENS S IENS=$O(VPRT(697.21,"")) Q:IENS=""
"RTN","VPRDMC",84,0)
 . ;. S X=VPRT(697.21,IENS,.01),VPRITM("type")=$$CPT(X)
"RTN","VPRDMC",85,0)
 . ;
"RTN","VPRDMC",86,0)
 . D XML(.VPRITM)
"RTN","VPRDMC",87,0)
ENQ ;
"RTN","VPRDMC",88,0)
 K ^TMP("MDHSP",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDMC",89,0)
 Q
"RTN","VPRDMC",90,0)
 ;
"RTN","VPRDMC",91,0)
ROOT(DFN,NAME,DATE) ; -- return vptr ID for procedure instance
"RTN","VPRDMC",92,0)
 N VPRMC,Y
"RTN","VPRDMC",93,0)
 D SUB^MCARUTL2(.VPRMC,DFN,NAME,DATE,DATE)
"RTN","VPRDMC",94,0)
 S Y=$S(+$G(VPRMC):$P($G(VPRMC(VPRMC)),U,4)_",",1:"")
"RTN","VPRDMC",95,0)
 Q Y
"RTN","VPRDMC",96,0)
 ;
"RTN","VPRDMC",97,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDMC",98,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDMC",99,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDMC",100,0)
 S Y=$P(X0,U,2,3)                   ;CPT Code^Short Name
"RTN","VPRDMC",101,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDMC",102,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDMC",103,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDMC",104,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDMC",105,0)
 . S $P(Y,U,2)=X
"RTN","VPRDMC",106,0)
 Q Y
"RTN","VPRDMC",107,0)
 ;
"RTN","VPRDMC",108,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDMC",109,0)
 ;
"RTN","VPRDMC",110,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's medicine reports
"RTN","VPRDMC",111,0)
 N VPRITM,VPRN,VPRX,RTN,TIUN,CONS,VPRD,I,DA,X,Y,%DT,DATE,GBL,RES
"RTN","VPRDMC",112,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDMC",113,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),RES=""
"RTN","VPRDMC",114,0)
 K ^TMP("MDHSP",$J) D EN1^MDPS1(RES,DFN,BEG,END,MAX,"",0)
"RTN","VPRDMC",115,0)
 S VPRN=0 F  S VPRN=$O(^TMP("MDHSP",$J,VPRN)) Q:VPRN<1  S VPRX=$G(^(VPRN)) D
"RTN","VPRDMC",116,0)
 . S RTN=$P(VPRX,U,3,4) ;Q:RTN="PRPRO^MDPS4"  ;skip non-CP items
"RTN","VPRDMC",117,0)
 . S TIUN=+$P(VPRX,U,14) K VPRITM
"RTN","VPRDMC",118,0)
 . I TIUN D EN1^VPRDTIU(TIUN,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",119,0)
 . S CONS=+$P(VPRX,U,13) D:CONS DOCLIST^GMRCGUIB(.VPRD,CONS)
"RTN","VPRDMC",120,0)
 . S I=0 F  S I=$O(VPRD(50,I)) Q:I<1  D
"RTN","VPRDMC",121,0)
 .. K VPRITM S DA=+VPRD(50,I) Q:DA=TIUN
"RTN","VPRDMC",122,0)
 .. D EN1^VPRDTIU(DA,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",123,0)
 . Q:TIUN!$G(DA)                             ;done [got TIU note(s)]
"RTN","VPRDMC",124,0)
 . Q:RTN="PR702^MDPS1"                       ;CP, but no TIU note yet
"RTN","VPRDMC",125,0)
 . Q:RTN="PRPRO^MDPS4"                       ;non-CP procedure
"RTN","VPRDMC",126,0)
 . ; find ID for pre-TIU report
"RTN","VPRDMC",127,0)
 . S X=$P(VPRX,U,6),%DT="TX" D ^%DT S:Y>0 DATE=Y
"RTN","VPRDMC",128,0)
 . S GBL=+$P(VPRX,U,2)_";"_$$ROOT(DFN,$P(VPRX,U,11),DATE)
"RTN","VPRDMC",129,0)
 . I GBL D RPT1(DFN,GBL,.VPRITM),XML^VPRDTIU(.VPRITM):$D(VPRITM)
"RTN","VPRDMC",130,0)
 K ^TMP("MDHSP",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDMC",131,0)
 Q
"RTN","VPRDMC",132,0)
 ;
"RTN","VPRDMC",133,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDMC",134,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:'$L(ID)
"RTN","VPRDMC",135,0)
 N VPRY,VPRFN,X
"RTN","VPRDMC",136,0)
 S VPRFN=+$P(ID,"(",2)
"RTN","VPRDMC",137,0)
 D MEDLKUP^MCARUTL3(.VPRY,VPRFN,+ID)
"RTN","VPRDMC",138,0)
 S RPT("id")=ID,RPT("referenceDateTime")=$P(VPRY,U,6)
"RTN","VPRDMC",139,0)
 S RPT("localTitle")=$P(VPRY,U,9),RPT("category")="CP"
"RTN","VPRDMC",140,0)
 S RPT("documentClass")="CLINICAL PROCEDURES"
"RTN","VPRDMC",141,0)
 S RPT("nationalTitle")="4696566^PROCEDURE REPORT"
"RTN","VPRDMC",142,0)
 S RPT("nationalTitleService")="4696471^PROCEDURE"
"RTN","VPRDMC",143,0)
 S RPT("nationalTitleType")="4696123^REPORT"
"RTN","VPRDMC",144,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDMC",145,0)
 S X=$$GET1^DIQ(VPRFN,+ID_",",1506)
"RTN","VPRDMC",146,0)
 S RPT("status")=$S($L(X):X,1:"COMPLETED")
"RTN","VPRDMC",147,0)
 S X=+$$GET1^DIQ(VPRFN,+ID_",",701,"I")
"RTN","VPRDMC",148,0)
 S:X RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A"
"RTN","VPRDMC",149,0)
 S X=+$$GET1^DIQ(VPRFN,+ID_",",1503,"I")
"RTN","VPRDMC",150,0)
 S:X RPT("clinician",2)=X_U_$P($G(^VA(200,X,0)),U)_"^S^"_$$GET1^DIQ(VPRFN,+ID_",",1505,"I")_U_$$SIG^VPRDTIU(X)
"RTN","VPRDMC",151,0)
 ; RPT("encounter")=$$GET1^DIQ(VPRFN,+ID_",",900,"I")
"RTN","VPRDMC",152,0)
 S RPT("facility")=$$FAC^VPRD
"RTN","VPRDMC",153,0)
 S:$G(VPRTEXT) RPT("content")=$$TEXT(DFN,ID,$P(VPRY,U,9))
"RTN","VPRDMC",154,0)
 Q
"RTN","VPRDMC",155,0)
 ;
"RTN","VPRDMC",156,0)
TEXT(DFN,ID,NAME) ; -- Get report text, return temp array name
"RTN","VPRDMC",157,0)
 N MCARGDA,MCPRO,MDALL,I,X
"RTN","VPRDMC",158,0)
 S MCARGDA=+$G(ID),MCPRO=NAME,MDALL=1 D PR690^MDPS1
"RTN","VPRDMC",159,0)
 K ^TMP("VPRTEXT",$J,ID)
"RTN","VPRDMC",160,0)
 S I=0 F  S I=$O(^TMP("MDPTXT",$J,MCARGDA,MCPRO,I)) Q:I<1  S X=$G(^(I,0)),^TMP("VPRTEXT",$J,ID,I)=X
"RTN","VPRDMC",161,0)
 S Y=$NA(^TMP("VPRTEXT",$J,ID))
"RTN","VPRDMC",162,0)
 Q Y
"RTN","VPRDMC",163,0)
 ;
"RTN","VPRDMC",164,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDMC",165,0)
 ;
"RTN","VPRDMC",166,0)
XML(PROC) ; -- Return patient procedure as XML
"RTN","VPRDMC",167,0)
 ;  as <element code='123' displayName='ABC' />
"RTN","VPRDMC",168,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDMC",169,0)
 D ADD("<procedure>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDMC",170,0)
 S ATT="" F  S ATT=$O(PROC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDMC",171,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDMC",172,0)
 . I $O(PROC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDMC",173,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDMC",174,0)
 .. S I=0 F  S I=$O(PROC(ATT,I)) Q:I<1  D
"RTN","VPRDMC",175,0)
 ... S X=$G(PROC(ATT,I)),Y="<"_ATT_" "_$$LOOP
"RTN","VPRDMC",176,0)
 ... S X=$G(PROC(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDMC",177,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDMC",178,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDMC",179,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDMC",180,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDMC",181,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDMC",182,0)
 . S X=$G(PROC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDMC",183,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDMC",184,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDMC",185,0)
 D ADD("</procedure>")
"RTN","VPRDMC",186,0)
 Q
"RTN","VPRDMC",187,0)
 ;
"RTN","VPRDMC",188,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDMC",189,0)
 N STR,P,TAG S STR=""
"RTN","VPRDMC",190,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDMC",191,0)
 Q STR
"RTN","VPRDMC",192,0)
 ;
"RTN","VPRDMC",193,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDMC",194,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDMC",195,0)
 S @VPR@(VPRI)=X
"RTN","VPRDMC",196,0)
 Q
"RTN","VPRDMDC")
0^4^B44678829^n/a
"RTN","VPRDMDC",1,0)
VPRDMDC ;SLC/MKB,DP -- CLiO extract ;8/2/11  15:29
"RTN","VPRDMDC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDMDC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDMDC",4,0)
 ;
"RTN","VPRDMDC",5,0)
 ; External References          DBIA#
"RTN","VPRDMDC",6,0)
 ; -------------------          -----
"RTN","VPRDMDC",7,0)
 ; ^MDC(704.101                 5748 (Private)
"RTN","VPRDMDC",8,0)
 ; ^MDC(704.102                 5748 (Private)
"RTN","VPRDMDC",9,0)
 ; ^MDC(704.117                 5748 (Private)
"RTN","VPRDMDC",10,0)
 ; ^MDC(704.118                 5748 (Private)
"RTN","VPRDMDC",11,0)
 ; DIC                          2051
"RTN","VPRDMDC",12,0)
 ; DIQ                          2056
"RTN","VPRDMDC",13,0)
 ; XLFDT                       10103
"RTN","VPRDMDC",14,0)
 ; XLFSTR                      10104
"RTN","VPRDMDC",15,0)
 ;
"RTN","VPRDMDC",16,0)
 ; ------------ Get observations from VistA ------------
"RTN","VPRDMDC",17,0)
 ;
"RTN","VPRDMDC",18,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's observations
"RTN","VPRDMDC",19,0)
 N VPRCLIO,VPRN,VPRITM,VPRCNT,X
"RTN","VPRDMDC",20,0)
 ;
"RTN","VPRDMDC",21,0)
 ; get one observation
"RTN","VPRDMDC",22,0)
 I $L($G(ID)) D EN1(ID,.VPRITM),XML(.VPRITM) Q
"RTN","VPRDMDC",23,0)
 ;
"RTN","VPRDMDC",24,0)
 ; get all patient observations
"RTN","VPRDMDC",25,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDMDC",26,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999),VPRCNT=0
"RTN","VPRDMDC",27,0)
 ;D QRYPT^MDCLIO1("VPRCLIO",DFN,BEG,END) ;all [verified] observations
"RTN","VPRDMDC",28,0)
 D QRYPT("VPRCLIO",DFN,BEG,END) ;all [verified] observations
"RTN","VPRDMDC",29,0)
 S VPRN=0 F  S VPRN=$O(VPRCLIO(VPRN)) Q:(VPRN<1)!(VPRCNT'<MAX)  D
"RTN","VPRDMDC",30,0)
 . S ID=$G(VPRCLIO(VPRN)) K VPRITM ;GUID
"RTN","VPRDMDC",31,0)
 . D EN1(ID,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDMDC",32,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDMDC",33,0)
 Q
"RTN","VPRDMDC",34,0)
 ;
"RTN","VPRDMDC",35,0)
EN1(GUID,CLIO) ; -- return an observation in CLIO("attribute")=value
"RTN","VPRDMDC",36,0)
 N VPRT,VPRC,LOC,I,X,Y K CLIO
"RTN","VPRDMDC",37,0)
 S GUID=$G(GUID) Q:GUID=""  ;invalid GUID
"RTN","VPRDMDC",38,0)
 ;D QRYOBS^MDCLIO1("VPRC",GUID) Q:'$D(VPRC)  ;doesn't exist
"RTN","VPRDMDC",39,0)
 D QRYOBS("VPRC",GUID) Q:'$D(VPRC)  ;doesn't exist
"RTN","VPRDMDC",40,0)
 Q:$L($G(VPRC("PARENT_ID","E")))            ;PARENT also in list
"RTN","VPRDMDC",41,0)
 S CLIO("id")=GUID,CLIO("vuid")=$G(VPRC("TERM_ID","I"))
"RTN","VPRDMDC",42,0)
 S CLIO("name")=$G(VPRC("TERM_ID","E"))
"RTN","VPRDMDC",43,0)
 S CLIO("value")=$G(VPRC("SVALUE","E"))
"RTN","VPRDMDC",44,0)
 S CLIO("units")=$G(VPRC("UNIT_ID","ABBV"))
"RTN","VPRDMDC",45,0)
 S CLIO("entered")=$G(VPRC("ENTERED_DATE_TIME","I"))
"RTN","VPRDMDC",46,0)
 S CLIO("observed")=$G(VPRC("OBSERVED_DATE_TIME","I"))
"RTN","VPRDMDC",47,0)
 ;D QRYTYPES^MDCLIO1("VPRT")
"RTN","VPRDMDC",48,0)
 D QRYTYPES("VPRT")
"RTN","VPRDMDC",49,0)
 F I=3:1:7 S X=$G(VPRT(I,"XML")) Q:I<1  I $L($G(VPRC(X,"E"))) D
"RTN","VPRDMDC",50,0)
 . S Y=VPRT(I,"NAME"),Y=$S(Y="LOCATION":"bodySite",1:$$LOW^XLFSTR(Y))
"RTN","VPRDMDC",51,0)
 . S CLIO(Y)=VPRC(X,"I")_U_VPRC(X,"E")
"RTN","VPRDMDC",52,0)
 S CLIO("range")=$G(VPRC("RANGE","E"))
"RTN","VPRDMDC",53,0)
 S CLIO("status")=$G(VPRC("STATUS","E"))
"RTN","VPRDMDC",54,0)
 S LOC=$G(VPRC("HOSPITAL_LOCATION_ID","I")),CLIO("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDMDC",55,0)
 S CLIO("location")=LOC_U_$G(VPRC("HOSPITAL_LOCATION_ID","E"))
"RTN","VPRDMDC",56,0)
 S CLIO("comment")=$G(VPRC("COMMENT","E"))
"RTN","VPRDMDC",57,0)
 Q
"RTN","VPRDMDC",58,0)
 ;
"RTN","VPRDMDC",59,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDMDC",60,0)
 ;
"RTN","VPRDMDC",61,0)
XML(OBS) ; -- Return observation as XML in @VPR@(#)
"RTN","VPRDMDC",62,0)
 N ATT,X,Y,I,J,P,NAMES,TAG
"RTN","VPRDMDC",63,0)
 D ADD("<observation>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDMDC",64,0)
 S ATT="" F  S ATT=$O(OBS(ATT)) Q:ATT=""  D
"RTN","VPRDMDC",65,0)
 . S X=$G(OBS(ATT)),Y="" Q:'$L(X)
"RTN","VPRDMDC",66,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" D ADD(Y) Q
"RTN","VPRDMDC",67,0)
 . I $L(X)>1 D
"RTN","VPRDMDC",68,0)
 .. S Y="<"_ATT_" "
"RTN","VPRDMDC",69,0)
 .. F P=1:1 S TAG=$P("code^name^Z",U,P) Q:TAG="Z"  I $L($P(X,U,P)) S Y=Y_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDMDC",70,0)
 .. S Y=Y_"/>" D ADD(Y)
"RTN","VPRDMDC",71,0)
 D ADD("</observation>")
"RTN","VPRDMDC",72,0)
 Q
"RTN","VPRDMDC",73,0)
 ;
"RTN","VPRDMDC",74,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDMDC",75,0)
 N STR,P,TAG S STR=""
"RTN","VPRDMDC",76,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDMDC",77,0)
 Q STR
"RTN","VPRDMDC",78,0)
 ;
"RTN","VPRDMDC",79,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDMDC",80,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDMDC",81,0)
 S @VPR@(VPRI)=X
"RTN","VPRDMDC",82,0)
 Q
"RTN","VPRDMDC",83,0)
 ;
"RTN","VPRDMDC",84,0)
 ; -- CliO specific code accessing the ^MDC( global for data
"RTN","VPRDMDC",85,0)
 ; 
"RTN","VPRDMDC",86,0)
QRYPT(VPRRET,VPRDFN,VPRFR,VPRTO,VPRSTAT) ; List of observations by pt, datetime, status
"RTN","VPRDMDC",87,0)
 K @VPRRET
"RTN","VPRDMDC",88,0)
 N VPRDT,VPRIEN
"RTN","VPRDMDC",89,0)
 S VPRSTAT=$G(VPRSTAT,1) ; Default to Verfied
"RTN","VPRDMDC",90,0)
 F VPRDT=VPRFR-.0000001:0 S VPRDT=$O(^MDC(704.117,"AS",VPRSTAT,VPRDFN,VPRDT)) Q:'VPRDT!(VPRDT>VPRTO)  D
"RTN","VPRDMDC",91,0)
 . F VPRIEN=0:0 S VPRIEN=$O(^MDC(704.117,"AS",VPRSTAT,VPRDFN,VPRDT,VPRIEN)) Q:'VPRIEN  D
"RTN","VPRDMDC",92,0)
 . . S:$P(^MDC(704.117,VPRIEN,0),U,9)=VPRSTAT @VPRRET@(VPRIEN)=$P(^MDC(704.117,VPRIEN,0),U)
"RTN","VPRDMDC",93,0)
 Q
"RTN","VPRDMDC",94,0)
 ;
"RTN","VPRDMDC",95,0)
QRYOBS(VPRRET,VPRID) ; Return a single observation
"RTN","VPRDMDC",96,0)
 K @VPRRET
"RTN","VPRDMDC",97,0)
 N VPRTMP,VPRIEN
"RTN","VPRDMDC",98,0)
 S VPRIEN=$$FIND1^DIC(704.117,"","PKX",VPRID,"PK")
"RTN","VPRDMDC",99,0)
 I VPRIEN<1 S @VPRRET@(0)="-1^No such observation '"_VPRID_"'" Q
"RTN","VPRDMDC",100,0)
 D GETS^DIQ(704.117,VPRIEN_",","*","EIR","VPRTMP")
"RTN","VPRDMDC",101,0)
 M @VPRRET=VPRTMP(704.117,VPRIEN_",") K VPRTMP
"RTN","VPRDMDC",102,0)
 S @VPRRET@("TERM_ID","I")=$$GET1^DIQ(704.117,VPRIEN_",",".07:99.99")
"RTN","VPRDMDC",103,0)
 S @VPRRET@("TERM_ID","E")=$$GET1^DIQ(704.117,VPRIEN_",",".07:.02")
"RTN","VPRDMDC",104,0)
 S @VPRRET@("TERM_ID","GUID")=$$GET1^DIQ(704.117,VPRIEN_",",".07")
"RTN","VPRDMDC",105,0)
 S @VPRRET@("TERM_ID","ABBV")=$$GET1^DIQ(704.117,VPRIEN_",",".07:.03")
"RTN","VPRDMDC",106,0)
 D:$$GET1^DIQ(704.117,VPRIEN_",",".07:.06","I")=3  ; Coded data values
"RTN","VPRDMDC",107,0)
 . S VPRTMP=$$FIND1^DIC(704.101,"","PKX",@VPRRET@("SVALUE","I"),"PK")
"RTN","VPRDMDC",108,0)
 . S @VPRRET@("SVALUE","E")=$$GET1^DIQ(704.101,VPRTMP_",",.02)
"RTN","VPRDMDC",109,0)
 D QRYQUAL(VPRRET,VPRIEN)
"RTN","VPRDMDC",110,0)
 D QRYCTX($NA(@VPRRET@("CONTEXT")),VPRID)
"RTN","VPRDMDC",111,0)
 Q
"RTN","VPRDMDC",112,0)
 ;
"RTN","VPRDMDC",113,0)
QRYQUAL(VPRRET,VPRIEN) ; Returns the qualifiers for obs in VPRIEN
"RTN","VPRDMDC",114,0)
 ; We do NOT want to kill VPRRET here because it points at the parent node of the return
"RTN","VPRDMDC",115,0)
 N VPRQUAL
"RTN","VPRDMDC",116,0)
 F Y=0:0 S Y=$O(^MDC(704.118,"PK",VPRIEN,Y)) Q:'Y  D
"RTN","VPRDMDC",117,0)
 . S VPRQUAL=$$GET1^DIQ(704.101,Y_",",".05:.02")
"RTN","VPRDMDC",118,0)
 . S @VPRRET@(VPRQUAL,"I")=$$GET1^DIQ(704.101,Y_",","99.99")
"RTN","VPRDMDC",119,0)
 . S @VPRRET@(VPRQUAL,"E")=$$GET1^DIQ(704.101,Y_",",".02")
"RTN","VPRDMDC",120,0)
 . S @VPRRET@(VPRQUAL,"GUID")=$$GET1^DIQ(704.101,Y_",",".01")
"RTN","VPRDMDC",121,0)
 . S @VPRRET@(VPRQUAL,"ABBV")=$$GET1^DIQ(704.101,Y_",",".03")
"RTN","VPRDMDC",122,0)
 Q
"RTN","VPRDMDC",123,0)
 ;
"RTN","VPRDMDC",124,0)
QRYCTX(VPRRET,VPRID) ; We need a terminology based context observation relationship here
"RTN","VPRDMDC",125,0)
 N VPRIEN,VPRCTX,VPRDT,VPRFR,VPRTO,VPRDFN,VPRTERM,VPRCNT,VPRXID,VPROBS
"RTN","VPRDMDC",126,0)
 S VPRIEN=+$$FIND1^DIC(704.117,"","PKX",VPRID,"PK") Q:VPRIEN<1
"RTN","VPRDMDC",127,0)
 S VPRCTX=$$GET1^DIQ(704.117,VPRIEN_",",.07) ; GET THE PRIMARY TERM (GUID)
"RTN","VPRDMDC",128,0)
 ; FILTER OUT EVERYTHING BUT SpO2 for now
"RTN","VPRDMDC",129,0)
 Q:VPRCTX'="{5F84DD55-3CCF-094C-2536-B51EB7FAD999}"
"RTN","VPRDMDC",130,0)
 S VPRDFN=+$$GET1^DIQ(704.117,VPRIEN_",",.08,"I") ; GET THE PATIENT
"RTN","VPRDMDC",131,0)
 S VPRDT=+$$GET1^DIQ(704.117,VPRIEN_",",.05,"I") ; GET THE OBS DATE
"RTN","VPRDMDC",132,0)
 S VPRFR=$$FMADD^XLFDT(VPRDT,0,0,0,-30) ; PREVIOUS 30 SECONDS
"RTN","VPRDMDC",133,0)
 S VPRTO=$$FMADD^XLFDT(VPRDT,0,0,0,30) ; NEXT 30 SECONDS
"RTN","VPRDMDC",134,0)
 ; Now we find the context observations
"RTN","VPRDMDC",135,0)
 F VPRDT=VPRFR:0 S VPRDT=$O(^MDC(704.117,"PT",VPRDFN,VPRDT)) Q:'VPRDT!(VPRDT>VPRTO)  D
"RTN","VPRDMDC",136,0)
 . F VPROBS=0:0 S VPROBS=$O(^MDC(704.117,"PT",VPRDFN,VPRDT,VPROBS)) Q:'VPROBS  D
"RTN","VPRDMDC",137,0)
 . . Q:$$GET1^DIQ(704.117,VPROBS_",",.09,"I")'=1  ; Verfied Only
"RTN","VPRDMDC",138,0)
 . . S VPRXID=$$GET1^DIQ(704.117,VPROBS_",",.01)
"RTN","VPRDMDC",139,0)
 . . Q:VPRXID=VPRID  ; You should ignore yourself in this loop
"RTN","VPRDMDC",140,0)
 . . S VPRTERM=$$GET1^DIQ(704.117,VPROBS_",",".07")
"RTN","VPRDMDC",141,0)
 . . ; INSERT FILTER CODE FOR O2 Flowrate and Concentration here - In the future we will find all context terms for an observation in terminology
"RTN","VPRDMDC",142,0)
 . . Q:(VPRTERM'="{56F82CAC-3564-46CE-A520-1025020DADE9}")&(VPRTERM'="{3BB314E8-9BBB-480E-B34E-B56EDE43BAC4}")
"RTN","VPRDMDC",143,0)
 . . S VPRCNT=$O(@VPRRET@(""),-1)+1,@VPRRET@(0)=VPRCNT
"RTN","VPRDMDC",144,0)
 . . S @VPRRET@(VPRCNT,"OBS_ID","I")=VPRXID
"RTN","VPRDMDC",145,0)
 . . S @VPRRET@(VPRCNT,"OBS_ID","E")=VPRXID
"RTN","VPRDMDC",146,0)
 . . S @VPRRET@(VPRCNT,"TERM_ID","I")=$$GET1^DIQ(704.117,VPROBS_",",".07:99.99")
"RTN","VPRDMDC",147,0)
 . . S @VPRRET@(VPRCNT,"TERM_ID","E")=$$GET1^DIQ(704.117,VPROBS_",",".07:.02")
"RTN","VPRDMDC",148,0)
 . . S @VPRRET@(VPRCNT,"SVALUE","I")=$$GET1^DIQ(704.117,VPROBS_",",".1","I")
"RTN","VPRDMDC",149,0)
 . . S @VPRRET@(VPRCNT,"SVALUE","E")=$$GET1^DIQ(704.117,VPROBS_",",".1","E")
"RTN","VPRDMDC",150,0)
 . . D QRYQUAL($NA(@VPRRET@(VPRCNT)),VPROBS)
"RTN","VPRDMDC",151,0)
 Q
"RTN","VPRDMDC",152,0)
 ;
"RTN","VPRDMDC",153,0)
QRYTYPES(VPRRET) ; Return the terminology Term Types
"RTN","VPRDMDC",154,0)
 K @VPRRET
"RTN","VPRDMDC",155,0)
 N X
"RTN","VPRDMDC",156,0)
 F X=0:0 S X=$O(^MDC(704.102,X)) Q:'X  D
"RTN","VPRDMDC",157,0)
 . S @VPRRET@(X,"NAME")=$P(^MDC(704.102,X,0),U,1)
"RTN","VPRDMDC",158,0)
 . S @VPRRET@(X,"XML")=$P(^MDC(704.102,X,0),U,2)
"RTN","VPRDMDC",159,0)
 . S @VPRRET@("B",$P(^MDC(704.102,X,0),U,1),X)=""
"RTN","VPRDMDC",160,0)
 Q
"RTN","VPRDMDC",161,0)
 ;
"RTN","VPRDOR")
0^5^B13221791^B9187731
"RTN","VPRDOR",1,0)
VPRDOR ;SLC/MKB -- Orders extract ;8/2/11  15:29
"RTN","VPRDOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDOR",4,0)
 ;
"RTN","VPRDOR",5,0)
 ; External References          DBIA#
"RTN","VPRDOR",6,0)
 ; -------------------          -----
"RTN","VPRDOR",7,0)
 ; ^ORA(102.4)                   5769
"RTN","VPRDOR",8,0)
 ; ^SC                          10040
"RTN","VPRDOR",9,0)
 ; ^VA(200)                     10060
"RTN","VPRDOR",10,0)
 ; DIQ                           2056
"RTN","VPRDOR",11,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDOR",12,0)
 ; ORQ12,^TMP("ORGOTIT",$J)      5704
"RTN","VPRDOR",13,0)
 ; ORX8                          2467
"RTN","VPRDOR",14,0)
 ;
"RTN","VPRDOR",15,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDOR",16,0)
 ;
"RTN","VPRDOR",17,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's orders
"RTN","VPRDOR",18,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDOR",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDOR",20,0)
 N ORLIST,VPRN,VPRITM,VPRCNT
"RTN","VPRDOR",21,0)
 ;
"RTN","VPRDOR",22,0)
 ; get one order
"RTN","VPRDOR",23,0)
 I $G(IFN) D  G ENQ
"RTN","VPRDOR",24,0)
 . N ORLST S ORLST=0,ORLIST=$H
"RTN","VPRDOR",25,0)
 . D GET^ORQ12(IFN,ORLIST,1) S VPRN=1
"RTN","VPRDOR",26,0)
 . D EN1(VPRN,.VPRITM),XML(.VPRITM)
"RTN","VPRDOR",27,0)
 . K ^TMP("ORGOTIT",$J)
"RTN","VPRDOR",28,0)
 ;
"RTN","VPRDOR",29,0)
 ; get all orders
"RTN","VPRDOR",30,0)
 D EN^ORQ1(DFN_";DPT(",,6,,BEG,END,1) S VPRCNT=0
"RTN","VPRDOR",31,0)
 S VPRN=0 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDOR",32,0)
 . K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDOR",33,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDOR",34,0)
ENQ ; end
"RTN","VPRDOR",35,0)
 K ^TMP("ORR",$J),^TMP("VPRTEXT",$J)
"RTN","VPRDOR",36,0)
 Q
"RTN","VPRDOR",37,0)
 ;
"RTN","VPRDOR",38,0)
EN1(NUM,ORD) ; -- return an order in ORD("attribute")=value
"RTN","VPRDOR",39,0)
 ;  from EN: expects ^TMP("ORR",$J,ORLIST,VPRN)
"RTN","VPRDOR",40,0)
 N X0,IFN,LOC,X,DA
"RTN","VPRDOR",41,0)
 K ORD,^TMP("VPRTEXT",$J)
"RTN","VPRDOR",42,0)
 S X0=$G(^TMP("ORR",$J,ORLIST,NUM)),IFN=+X0
"RTN","VPRDOR",43,0)
 S ORD("id")=IFN,ORD("name")=$$OI^ORX8(+X0)
"RTN","VPRDOR",44,0)
 S ORD("group")=$P(X0,U,2),ORD("entered")=$P(X0,U,3)
"RTN","VPRDOR",45,0)
 S ORD("start")=$P(X0,U,4),ORD("stop")=$P(X0,U,5)
"RTN","VPRDOR",46,0)
 S ORD("status")=$P(X0,U,7)_U_$P(X0,U,6)_U_$$STS($P(X0,U,7))
"RTN","VPRDOR",47,0)
 M ^TMP("VPRTEXT",$J,IFN)=^TMP("ORR",$J,ORLIST,VPRN,"TX")
"RTN","VPRDOR",48,0)
 S ORD("content")=$NA(^TMP("VPRTEXT",$J,IFN))
"RTN","VPRDOR",49,0)
 S X=$$GET1^DIQ(100,IFN_",",1,"I"),ORD("provider")=X_U_$P($G(^VA(200,+X,0)),U)
"RTN","VPRDOR",50,0)
 S X=$$GET1^DIQ(100,IFN_",",6),LOC="" I $L(X) D
"RTN","VPRDOR",51,0)
 . S LOC=+$O(^SC("B",X,0)),ORD("location")=LOC_U_X
"RTN","VPRDOR",52,0)
 S ORD("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDOR",53,0)
 S ORD("service")=$$GET1^DIQ(100,IFN_",","12:1")
"RTN","VPRDOR",54,0)
 ; acknowledgements
"RTN","VPRDOR",55,0)
 S DA=0 F  S DA=$O(^ORA(102.4,"B",+IFN,DA)) Q:DA<1  D
"RTN","VPRDOR",56,0)
 . S X0=$G(^ORA(102.4,DA,0)) Q:'$P(X0,U,3)  ;stub - not ack'd
"RTN","VPRDOR",57,0)
 . S X=+$P(X0,U,2),X=$S(X:X_U_$P($G(^VA(200,X,0)),U),1:U)
"RTN","VPRDOR",58,0)
 . S ORD("acknowledgement",DA)=X_U_$P(X0,U,3)
"RTN","VPRDOR",59,0)
 Q
"RTN","VPRDOR",60,0)
 ;
"RTN","VPRDOR",61,0)
STS(X) ; -- return VUID for status abbreviation X
"RTN","VPRDOR",62,0)
 N Y,I,STS
"RTN","VPRDOR",63,0)
 S STS="dc^comp^hold^flag^pend^actv^exp^schd^part^dlay^unr^dc/e^canc^laps^rnew^none"
"RTN","VPRDOR",64,0)
 F I=1:1:16 Q:$P(STS,U,I)=X
"RTN","VPRDOR",65,0)
 S Y=$$VUID^VPRD(I,100.01)
"RTN","VPRDOR",66,0)
 Q Y
"RTN","VPRDOR",67,0)
 ;
"RTN","VPRDOR",68,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDOR",69,0)
 ;
"RTN","VPRDOR",70,0)
XML(ORD) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDOR",71,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDOR",72,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDOR",73,0)
 D ADD("<order>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDOR",74,0)
 S ATT="" F  S ATT=$O(ORD(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDOR",75,0)
 . S NAMES="code^name^"_$S(ATT?1"ack".E:"date",1:"vuid")_"^Z"
"RTN","VPRDOR",76,0)
 . I ATT?1"ack".E D  S Y="" Q
"RTN","VPRDOR",77,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDOR",78,0)
 .. S I=0 F  S I=$O(ORD(ATT,I)) Q:I<1  D
"RTN","VPRDOR",79,0)
 ... S X=$G(ORD(ATT,I))
"RTN","VPRDOR",80,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDOR",81,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDOR",82,0)
 . S X=$G(ORD(ATT)),Y="" Q:'$L(X)
"RTN","VPRDOR",83,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDOR",84,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDOR",85,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDOR",86,0)
 .. D ADD("</content>")
"RTN","VPRDOR",87,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDOR",88,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDOR",89,0)
 D ADD("</order>")
"RTN","VPRDOR",90,0)
 Q
"RTN","VPRDOR",91,0)
 ;
"RTN","VPRDOR",92,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDOR",93,0)
 N STR,P,TAG S STR=""
"RTN","VPRDOR",94,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDOR",95,0)
 Q STR
"RTN","VPRDOR",96,0)
 ;
"RTN","VPRDOR",97,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDOR",98,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDOR",99,0)
 S @VPR@(VPRI)=X
"RTN","VPRDOR",100,0)
 Q
"RTN","VPRDPROC")
0^6^B10570617^B8662758
"RTN","VPRDPROC",1,0)
VPRDPROC ;SLC/MKB -- Procedure extract ;8/2/11  15:29
"RTN","VPRDPROC",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPROC",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPROC",4,0)
 ;
"RTN","VPRDPROC",5,0)
 ; External References          DBIA#
"RTN","VPRDPROC",6,0)
 ; -------------------          -----
"RTN","VPRDPROC",7,0)
 ; RAO7PC1                       2043
"RTN","VPRDPROC",8,0)
 ; SROESTV                       3533
"RTN","VPRDPROC",9,0)
 ;
"RTN","VPRDPROC",10,0)
 ; ------------ Get procedure(s) from VistA ------------
"RTN","VPRDPROC",11,0)
 ;
"RTN","VPRDPROC",12,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's procedures
"RTN","VPRDPROC",13,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPROC",14,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPROC",15,0)
 ;
"RTN","VPRDPROC",16,0)
 N VPRN,VPRCNT,VPRITM,VPRY,VPRCATG
"RTN","VPRDPROC",17,0)
 S VPRCATG=$G(FILTER("category"),"SR;RA") ;NwHIN default
"RTN","VPRDPROC",18,0)
 ;
"RTN","VPRDPROC",19,0)
 ; get one procedure
"RTN","VPRDPROC",20,0)
 I $G(ID),ID'[";" D  D:$D(VPRITM) XML(.VPRITM) Q
"RTN","VPRDPROC",21,0)
 . I ID'["-" D EN1^VPRDSR(ID,.VPRITM) Q    ;Surgery
"RTN","VPRDPROC",22,0)
 . S (BEG,END)=9999999.9999=+ID D EN1^RAO7PC1(DFN,BEG,END,"1P")
"RTN","VPRDPROC",23,0)
 . D EN1^VPRDRA(ID,.VPRITM)                ;Radiology
"RTN","VPRDPROC",24,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDPROC",25,0)
 I $G(ID),ID[";" D EN^VPRDMC(DFN,,,,ID) Q  ;CP/Medicine
"RTN","VPRDPROC",26,0)
 ;
"RTN","VPRDPROC",27,0)
SR ; get all surgeries
"RTN","VPRDPROC",28,0)
 I VPRCATG'["SR" G RA
"RTN","VPRDPROC",29,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDPROC",30,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDPROC",31,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDPROC",32,0)
 . K VPRITM D ONE^VPRDSR(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",33,0)
 . ;Q:$G(VPRITM("status"))'?1"COMP".E
"RTN","VPRDPROC",34,0)
 . D XML(.VPRITM)
"RTN","VPRDPROC",35,0)
 K @VPRY
"RTN","VPRDPROC",36,0)
 ;
"RTN","VPRDPROC",37,0)
RA ; get all radiology exams
"RTN","VPRDPROC",38,0)
 I VPRCATG'["RA" G CP
"RTN","VPRDPROC",39,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDPROC",40,0)
 S VPRCNT=+$G(VPRTOTL),VPRN=""
"RTN","VPRDPROC",41,0)
 F  S VPRN=$O(^TMP($J,"RAE1",DFN,VPRN)) Q:VPRN=""   D  Q:VPRCNT'<MAX  ;I $P($P($G(^(VPRN)),U,6),"~",2)?1"COMP".E
"RTN","VPRDPROC",42,0)
 . K VPRITM D EN1^VPRDRA(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPROC",43,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPROC",44,0)
 K ^TMP($J,"RAE1")
"RTN","VPRDPROC",45,0)
 ;
"RTN","VPRDPROC",46,0)
CP ; get CP procedures
"RTN","VPRDPROC",47,0)
 D:VPRCATG["CP" EN^VPRDMC(DFN,BEG,END,MAX)
"RTN","VPRDPROC",48,0)
 ;
"RTN","VPRDPROC",49,0)
 ; V-CPT
"RTN","VPRDPROC",50,0)
 ;
"RTN","VPRDPROC",51,0)
 Q
"RTN","VPRDPROC",52,0)
 ;
"RTN","VPRDPROC",53,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPROC",54,0)
 ;
"RTN","VPRDPROC",55,0)
XML(PROC) ; -- Return procedures as XML
"RTN","VPRDPROC",56,0)
 N ATT,X,Y,I,J,NAMES
"RTN","VPRDPROC",57,0)
 D ADD("<procedure>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPROC",58,0)
 S ATT="" F  S ATT=$O(PROC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPROC",59,0)
 . S NAMES=$S(ATT="document"!(ATT="opReport"):"id^localTitle^nationalTitle^status^Z",1:"code^name^Z")
"RTN","VPRDPROC",60,0)
 . I $O(PROC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPROC",61,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPROC",62,0)
 .. S I=0 F  S I=$O(PROC(ATT,I)) Q:I<1  D
"RTN","VPRDPROC",63,0)
 ... S X=$G(PROC(ATT,I))
"RTN","VPRDPROC",64,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDPROC",65,0)
 ... S X=$G(PROC(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDPROC",66,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDPROC",67,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDPROC",68,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDPROC",69,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDPROC",70,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPROC",71,0)
 . S X=$G(PROC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPROC",72,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPROC",73,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPROC",74,0)
 D ADD("</procedure>")
"RTN","VPRDPROC",75,0)
 Q
"RTN","VPRDPROC",76,0)
 ;
"RTN","VPRDPROC",77,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPROC",78,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPROC",79,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPROC",80,0)
 Q STR
"RTN","VPRDPROC",81,0)
 ;
"RTN","VPRDPROC",82,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDPROC",83,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPROC",84,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPROC",85,0)
 Q
"RTN","VPRDPS")
0^7^B18817165^B14378656
"RTN","VPRDPS",1,0)
VPRDPS ;SLC/MKB -- Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPS",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPS",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPS",4,0)
 ;
"RTN","VPRDPS",5,0)
 ; External References          DBIA#
"RTN","VPRDPS",6,0)
 ; -------------------          -----
"RTN","VPRDPS",7,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPS",8,0)
 ; PSS50,^TMP($J                 4533
"RTN","VPRDPS",9,0)
 ; PSS50P7,^TMP($J               4662
"RTN","VPRDPS",10,0)
 ; PSSDI                         4551
"RTN","VPRDPS",11,0)
 ;
"RTN","VPRDPS",12,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPS",13,0)
 ;
"RTN","VPRDPS",14,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find patient's meds
"RTN","VPRDPS",15,0)
 N PS0,VPRN,VPRITM,TYPE,ID K ^TMP("PS",$J)
"RTN","VPRDPS",16,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPS",17,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPS",18,0)
 ;
"RTN","VPRDPS",19,0)
 ; get one med
"RTN","VPRDPS",20,0)
 I $G(ORIFN) D EN1^VPRDPSOR(ORIFN,.VPRITM),XML(.VPRITM):$D(VPRITM) Q
"RTN","VPRDPS",21,0)
 ;
"RTN","VPRDPS",22,0)
 ; get all meds
"RTN","VPRDPS",23,0)
 D OCL^PSOORRL(DFN,BEG,END) M ^TMP("VPRPS",$J)=^TMP("PS",$J)
"RTN","VPRDPS",24,0)
 S TYPE=$G(FILTER("vaType"))
"RTN","VPRDPS",25,0)
 S VPRN=0 F  S VPRN=$O(^TMP("VPRPS",$J,VPRN)) Q:VPRN<1!(VPRN>MAX)  S PS0=$G(^(VPRN,0)) D  I $D(VPRITM)>9 D XML(.VPRITM)
"RTN","VPRDPS",26,0)
 . S ID=$P(PS0,U),ORIFN=+$P(PS0,U,8) K VPRITM
"RTN","VPRDPS",27,0)
 . Q:'ORIFN!'$D(^OR(100,ORIFN,0))
"RTN","VPRDPS",28,0)
 . I $L(TYPE) Q:'$$MATCH
"RTN","VPRDPS",29,0)
 . D:ORIFN EN1^VPRDPSOR(ORIFN,.VPRITM)
"RTN","VPRDPS",30,0)
 K ^TMP("VPRPS",$J),^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","VPRDPS",31,0)
 Q
"RTN","VPRDPS",32,0)
 ;
"RTN","VPRDPS",33,0)
MATCH() ; -- Return 1 or 0, if order matches FILTER criteria
"RTN","VPRDPS",34,0)
 N Y S Y=0
"RTN","VPRDPS",35,0)
 I ID["O" D
"RTN","VPRDPS",36,0)
 . I TYPE="N",ID["N" S Y=1 Q
"RTN","VPRDPS",37,0)
 . I TYPE="O",ID'["N" S Y=1 Q
"RTN","VPRDPS",38,0)
 . ; TYPE="S",ID'["N",$$SUPPLY(ORIFN) S Y=1 Q
"RTN","VPRDPS",39,0)
 I ID["I" D
"RTN","VPRDPS",40,0)
 . N IV S IV=$S(ID["V":1,$G(^TMP("VPRPS",$J,VPRN,"B",0)):1,1:0)
"RTN","VPRDPS",41,0)
 . I TYPE="V",IV S Y=1
"RTN","VPRDPS",42,0)
 . I TYPE="I",'IV S Y=1
"RTN","VPRDPS",43,0)
 Q Y
"RTN","VPRDPS",44,0)
 ;
"RTN","VPRDPS",45,0)
SUPPLY(ORDER) ; -- Return 1 or 0, if ORDER is for a supply item
"RTN","VPRDPS",46,0)
 N OI,Y S OI=$$OI^ORX8(ORDER),Y=0
"RTN","VPRDPS",47,0)
 D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","VPRDPS",48,0)
 S Y=+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09))
"RTN","VPRDPS",49,0)
 Q Y
"RTN","VPRDPS",50,0)
 ;
"RTN","VPRDPS",51,0)
NDF(DRUG,VPI,ORD) ; -- Set NDF data for dispense DRUG ien
"RTN","VPRDPS",52,0)
 N VPRX,STR,VUID,X,I
"RTN","VPRDPS",53,0)
 S DRUG=+$G(DRUG) Q:'DRUG
"RTN","VPRDPS",54,0)
 D EN^PSSDI(50,,50,"901;902",DRUG,"VPRX")
"RTN","VPRDPS",55,0)
 S STR=$S($G(VPRX(50,DRUG,901)):$G(VPRX(50,DRUG,901))_" "_$G(VPRX(50,DRUG,902)),1:"")
"RTN","VPRDPS",56,0)
 D NDF^PSS50(DRUG,,,,,"NDF") S VPI=+$G(VPI,1)
"RTN","VPRDPS",57,0)
 S MED("product",VPI)=DRUG_U_$G(^TMP($J,"NDF",DRUG,.01))_"^^D^"_STR_U_$G(ORD) ;Drug
"RTN","VPRDPS",58,0)
 S X=$G(^TMP($J,"NDF",DRUG,20)) ;VA Generic
"RTN","VPRDPS",59,0)
 S MED("product",VPI,"G")=X_U_$$VUID^VPRD(+X,50.6)
"RTN","VPRDPS",60,0)
 S X=$G(^TMP($J,"NDF",DRUG,22)) ;VA Product
"RTN","VPRDPS",61,0)
 S MED("product",VPI,"P")=X_U_$$VUID^VPRD(+X,50.68)
"RTN","VPRDPS",62,0)
 S X=$G(^TMP($J,"NDF",DRUG,25)) ;VA Drug Class
"RTN","VPRDPS",63,0)
 S MED("product",VPI,"C")=$P(X,U,2,3)_U_$$VUID^VPRD(+X,50.605)
"RTN","VPRDPS",64,0)
 K ^TMP($J,"NDF",DRUG)
"RTN","VPRDPS",65,0)
 Q
"RTN","VPRDPS",66,0)
 ;
"RTN","VPRDPS",67,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPS",68,0)
 ;
"RTN","VPRDPS",69,0)
XML(MED) ; -- Return patient meds as XML
"RTN","VPRDPS",70,0)
 N ATT,X,Y,I,NAMES
"RTN","VPRDPS",71,0)
 D ADD("<med>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPS",72,0)
 S ATT="" F  S ATT=$O(MED(ATT)) Q:ATT=""  D  I $L(Y) D ADD(Y)
"RTN","VPRDPS",73,0)
 . I $O(MED(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDPS",74,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDPS",75,0)
 .. S I=0 F  S I=$O(MED(ATT,I)) Q:I<1  D
"RTN","VPRDPS",76,0)
 ... S X=$G(MED(ATT,I)),NAMES=""
"RTN","VPRDPS",77,0)
 ... I ATT="dose" S NAMES="dose^units^unitsPerDose^noun^route^schedule^duration^conjunction^doseStart^doseStop^order^Z"
"RTN","VPRDPS",78,0)
 ... I ATT="fill" S NAMES="fillDate^fillRouting^releaseDate^fillQuantity^fillDaysSupply^partial^Z"
"RTN","VPRDPS",79,0)
 ... I ATT="product" S NAMES="code^name^vuid^role^concentration^order^Z"
"RTN","VPRDPS",80,0)
 ... S Y="<"_ATT_" "_$$LOOP_$S(ATT'="product":"/>",1:">") D ADD(Y)
"RTN","VPRDPS",81,0)
 ... Q:ATT'="product"
"RTN","VPRDPS",82,0)
 ... S X=$G(MED(ATT,I,"O")) I $L(X) S Y="<ordItem "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",83,0)
 ... S X=$G(MED(ATT,I,"C")) I $L(X) S Y="<class "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",84,0)
 ... S X=$G(MED(ATT,I,"G")) I $L(X) S Y="<vaGeneric "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",85,0)
 ... S X=$G(MED(ATT,I,"P")) I $L(X) S Y="<vaProduct "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDPS",86,0)
 ... D ADD("</product>")
"RTN","VPRDPS",87,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDPS",88,0)
 . S X=$G(MED(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPS",89,0)
 . I ATT="sig"!(ATT?1"ptIn"1.A) S Y="<"_ATT_" xml:space='preserve'>"_$$ESC^VPRD(X)_"</"_ATT_">" Q
"RTN","VPRDPS",90,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPS",91,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDPS",92,0)
 D ADD("</med>")
"RTN","VPRDPS",93,0)
 Q
"RTN","VPRDPS",94,0)
 ;
"RTN","VPRDPS",95,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDPS",96,0)
 N STR,P,TAG S STR=""
"RTN","VPRDPS",97,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDPS",98,0)
 Q STR
"RTN","VPRDPS",99,0)
 ;
"RTN","VPRDPS",100,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPS",101,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPS",102,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPS",103,0)
 Q
"RTN","VPRDPSI")
0^8^B41207623^B41960179
"RTN","VPRDPSI",1,0)
VPRDPSI ;SLC/MKB -- Inpatient Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPSI",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPSI",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSI",4,0)
 ;
"RTN","VPRDPSI",5,0)
 ; External References          DBIA#
"RTN","VPRDPSI",6,0)
 ; -------------------          -----
"RTN","VPRDPSI",7,0)
 ; ^OR(100                       5771
"RTN","VPRDPSI",8,0)
 ; ^ORD(101.43                   2843
"RTN","VPRDPSI",9,0)
 ; ^SC                          10040
"RTN","VPRDPSI",10,0)
 ; ^VA(200                      10060
"RTN","VPRDPSI",11,0)
 ; DIQ                           2056
"RTN","VPRDPSI",12,0)
 ; ORX8                      871,2467
"RTN","VPRDPSI",13,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPSI",14,0)
 ; PSS50P7                       4662
"RTN","VPRDPSI",15,0)
 ; PSS51P2                       4548
"RTN","VPRDPSI",16,0)
 ; PSS52P6                       4549
"RTN","VPRDPSI",17,0)
 ; PSS52P7                       4550
"RTN","VPRDPSI",18,0)
 ; XLFSTR                       10104
"RTN","VPRDPSI",19,0)
 ;
"RTN","VPRDPSI",20,0)
 ; ------------ Get medications from VistA ------------
"RTN","VPRDPSI",21,0)
 ;            [used to be called from VPRDPS]
"RTN","VPRDPSI",22,0)
 ;
"RTN","VPRDPSI",23,0)
IN(ID,MED) ; -- return a medication in MED("attribute")=value
"RTN","VPRDPSI",24,0)
 ; [expects VPRN, OCL^PSOORRL data]
"RTN","VPRDPSI",25,0)
 N X,PS,PS0,ORDER,DOSE,UNTS,RTE,SCH,OI,PSOI,LOC K MED
"RTN","VPRDPSI",26,0)
 M PS=^TMP("VPRPS",$J,VPRN) S PS0=PS(0)
"RTN","VPRDPSI",27,0)
 S MED("medID")=ID_";I",MED("vaType")="I"
"RTN","VPRDPSI",28,0)
 S X=$P(PS0,U,15) S:X MED("start")=X
"RTN","VPRDPSI",29,0)
 S X=$P(PS0,U,4) S:X MED("stop")=X
"RTN","VPRDPSI",30,0)
 S MED("name")=$P(PS0,U,2),X=$P(PS0,U,9),MED("vaStatus")=X,X=$E(X,1,3)
"RTN","VPRDPSI",31,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="REN"):"historical",X="REI":"active",1:$$LOW^XLFSTR($P(PS0,U,9)))
"RTN","VPRDPSI",32,0)
 S DOSE=$P(PS0,U,6) S:DOSE="" DOSE=$G(PS("SIG",1,0))
"RTN","VPRDPSI",33,0)
 S RTE=$G(PS("MDR",1,0)),SCH=$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",34,0)
 S MED("dose",1)=DOSE_"^^^^"_RTE_U_SCH
"RTN","VPRDPSI",35,0)
 S MED("sig")="Give: "_DOSE_" "_RTE_" "_SCH I $G(PS("SIO",0)) D
"RTN","VPRDPSI",36,0)
 . N SIO M SIO=PS("SIO")
"RTN","VPRDPSI",37,0)
 . S MED("sig")=MED("sig")_" "_$$STRING^VPRD(.SIO)
"RTN","VPRDPSI",38,0)
 I $D(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",39,0)
 I $G(PS("CLINIC",0)) S MED("IMO")=1
"RTN","VPRDPSI",40,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",41,0)
 S ORDER=+$P(PS0,U,8) D:ORDER ORD
"RTN","VPRDPSI",42,0)
 Q
"RTN","VPRDPSI",43,0)
 ;
"RTN","VPRDPSI",44,0)
IN1(ID,MED) ; -- return a medication in MED("attribute")=value
"RTN","VPRDPSI",45,0)
 ; [expects OEL^PSOORRL data]
"RTN","VPRDPSI",46,0)
 N X,PS,PS0,ORDER,DOSE,UNTS,RTE,SCH,OI,PSOI,DRUG,LOC K MED
"RTN","VPRDPSI",47,0)
 M PS=^TMP("PS",$J) S PS0=PS(0)
"RTN","VPRDPSI",48,0)
 S MED("medID")=ID_";I",MED("vaType")="I"
"RTN","VPRDPSI",49,0)
 S X=$P(PS0,U,5) S:X MED("start")=X
"RTN","VPRDPSI",50,0)
 S X=$P(PS0,U,3) S:X MED("stop")=X
"RTN","VPRDPSI",51,0)
 S MED("name")=$P(PS0,U),X=$P(PS0,U,6),MED("vaStatus")=X,X=$E(X,1,3)
"RTN","VPRDPSI",52,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="REN"):"historical",X="REI":"active",1:$$LOW^XLFSTR($P(PS0,U,6)))
"RTN","VPRDPSI",53,0)
 S DOSE=$P(PS0,U,9) S:DOSE="" DOSE=$G(PS("SIG",1,0))
"RTN","VPRDPSI",54,0)
 S RTE=$G(PS("MDR",1,0)),SCH=$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",55,0)
 S MED("dose",1)=DOSE_"^^^^"_RTE_U_SCH
"RTN","VPRDPSI",56,0)
 S MED("sig")="Give: "_DOSE_" "_RTE_" "_SCH I $G(PS("SIO",0)) D
"RTN","VPRDPSI",57,0)
 . N SIO M SIO=PS("SIO")
"RTN","VPRDPSI",58,0)
 . S MED("sig")=MED("sig")_" "_$$STRING^VPRD(.SIO)
"RTN","VPRDPSI",59,0)
 I $D(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",60,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",61,0)
 S ORDER=+$P(PS0,U,11) D:ORDER ORD
"RTN","VPRDPSI",62,0)
 I $P($G(^SC(+$G(LOC),0)),U,25) S MED("IMO")=1
"RTN","VPRDPSI",63,0)
 Q
"RTN","VPRDPSI",64,0)
 ;
"RTN","VPRDPSI",65,0)
IV1(ID,MED) ; -- return an infusion in MED("attribute")=value
"RTN","VPRDPSI",66,0)
 ; [expects OEL^PSOORRL data]
"RTN","VPRDPSI",67,0)
 N PS,PS0,X,ORDER,LOC K MED
"RTN","VPRDPSI",68,0)
 M PS=^TMP("PS",$J) S PS0=PS(0)
"RTN","VPRDPSI",69,0)
 S MED("medID")=ID_";I",MED("vaType")="V",MED("name")=$P(PS0,U)
"RTN","VPRDPSI",70,0)
 S X=$P(PS0,U,5) S:X MED("start")=X
"RTN","VPRDPSI",71,0)
 S X=$P(PS0,U,3) S:X MED("stop")=X
"RTN","VPRDPSI",72,0)
 S MED("vaStatus")=$P(PS0,U,6),X=$E($P(PS0,U,6),1,3)
"RTN","VPRDPSI",73,0)
 S MED("status")=$S(X="DIS"!(X="PEN"):"not active",X="EXP"!(X="PUR"):"historical",X="HOL":"hold",1:"active")
"RTN","VPRDPSI",74,0)
 S MED("dose",1)="^^^^"_$G(PS("MDR",1,0))_U_$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",75,0)
 S MED("rate")=$P(PS0,U,2) D IVP
"RTN","VPRDPSI",76,0)
 S X=$G(PS("IVLIM",0)) S:$L(X) MED("ivLimit")=$$IVLIM(X)
"RTN","VPRDPSI",77,0)
 I $G(PS("P",0)) S MED("orderingProvider")=PS("P",0)
"RTN","VPRDPSI",78,0)
 S MED("facility")=$$FAC^VPRD ;local stn#^name
"RTN","VPRDPSI",79,0)
 S ORDER=+$P(PS0,U,11) D:ORDER ORDLOC
"RTN","VPRDPSI",80,0)
 I $P($G(^SC(+$G(LOC),0)),U,25) S MED("IMO")=1
"RTN","VPRDPSI",81,0)
 Q
"RTN","VPRDPSI",82,0)
 ;
"RTN","VPRDPSI",83,0)
ORD ; get rest of inpatient data from ORDER
"RTN","VPRDPSI",84,0)
 S OI=$$OI^ORX8(ORDER),PSOI=+$P(OI,U,3)
"RTN","VPRDPSI",85,0)
 S MED("name")=$P(OI,U,2) I PSOI D
"RTN","VPRDPSI",86,0)
 . D ZERO^PSS50P7(PSOI,,,"OI")
"RTN","VPRDPSI",87,0)
 . S MED("form")=$P($G(^TMP($J,"OI",PSOI,.02)),U,2)
"RTN","VPRDPSI",88,0)
 S X=$$VALUE^ORX8(ORDER,"DOSE"),DOSE=DOSE_"^^^"
"RTN","VPRDPSI",89,0)
 S DRUG="" I X'="",X["&" D
"RTN","VPRDPSI",90,0)
 . S DRUG=+$P(X,"&",6)
"RTN","VPRDPSI",91,0)
 . S DOSE=$TR($P(X,"&",1,4),"&","^")
"RTN","VPRDPSI",92,0)
 . S $P(MED("dose",1),U,1,4)=DOSE
"RTN","VPRDPSI",93,0)
 S:'DRUG DRUG=+$$VALUE^ORX8(ORDER,"DRUG")
"RTN","VPRDPSI",94,0)
 D:DRUG NDF^VPRDPS(DRUG)
"RTN","VPRDPSI",95,0)
 S X=$$GET1^DIQ(100,ORDER_",",36,"I") S:X MED("parent")=X
"RTN","VPRDPSI",96,0)
 K ^TMP($J,"OI")
"RTN","VPRDPSI",97,0)
ORDLOC ; enter here for IV's
"RTN","VPRDPSI",98,0)
 N ORUPCHUK D EN^ORX8(ORDER)
"RTN","VPRDPSI",99,0)
 S MED("orderID")=ORDER
"RTN","VPRDPSI",100,0)
 S MED("ordered")=$G(ORUPCHUK("ORODT"))
"RTN","VPRDPSI",101,0)
 S LOC=+$G(ORUPCHUK("ORL")) I LOC D
"RTN","VPRDPSI",102,0)
 . S MED("location")=LOC_U_$P($G(^SC(LOC,0)),U)
"RTN","VPRDPSI",103,0)
 . S MED("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPSI",104,0)
 Q
"RTN","VPRDPSI",105,0)
 ;
"RTN","VPRDPSI",106,0)
 ; ---------- Called from VPRDPSOR ----------
"RTN","VPRDPSI",107,0)
 ;
"RTN","VPRDPSI",108,0)
IV ; -- add IV data to MED("attribute")=value
"RTN","VPRDPSI",109,0)
 ; [expects IFN, ORPK, OEL^PSOORRL data]
"RTN","VPRDPSI",110,0)
 N PS,PS0,X,X0,ID,RTE,I
"RTN","VPRDPSI",111,0)
 S MED("vaType")="V" I ORPK,$D(^TMP("PS",$J)) D  G IVQ
"RTN","VPRDPSI",112,0)
 . M PS=^TMP("PS",$J) S PS0=$G(PS(0)),MED("name")=$P(PS0,U)
"RTN","VPRDPSI",113,0)
 . S MED("dose",1)="^^^^"_$G(PS("MDR",1,0))_U_$P($G(PS("SCH",1,0)),U)
"RTN","VPRDPSI",114,0)
 . S MED("rate")=$P(PS0,U,2),ID=ORPK D IVP
"RTN","VPRDPSI",115,0)
 . S X=$G(PS("IVLIM",0)) S:$L(X) MED("ivLimit")=$$IVLIM(X)
"RTN","VPRDPSI",116,0)
 . S X=+$P($G(^TMP("PS",$J,"RXN",0)),U,5)
"RTN","VPRDPSI",117,0)
 . S:X MED("pharmacist")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPSI",118,0)
 ; no med in PS, so use Order values
"RTN","VPRDPSI",119,0)
 S RTE=+$$VALUE^ORX8(IFN,"ROUTE") D ALL^PSS51P2(RTE,,,,"VPRTE")
"RTN","VPRDPSI",120,0)
 S MED("dose",1)="^^^^"_$G(^TMP($J,"VPRTE",RTE,1))_U_$$VALUE^ORX8(IFN,"SCHEDULE")
"RTN","VPRDPSI",121,0)
 S MED("rate")=$$VALUE^ORX8(IFN,"RATE")
"RTN","VPRDPSI",122,0)
 S I=0 F  S I=$O(^OR(100,IFN,.1,I)) Q:I<1  S X=+$G(^(I,0)) D
"RTN","VPRDPSI",123,0)
 . S X0=$G(^ORD(101.43,X,0)),MED("name")=$P(X0,U)
"RTN","VPRDPSI",124,0)
 . S MED("product",I,"O")=+$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDPSI",125,0)
 S X=$$VALUE^ORX8(IFN,"DAYS") I $L(X) D  S MED("ivLimit")=X
"RTN","VPRDPSI",126,0)
 . I X?1.A1.N S X=$$IVLIM(X) Q
"RTN","VPRDPSI",127,0)
 . ; CPRS format = "for a total of 3 doses" or "with total volume 100ml"
"RTN","VPRDPSI",128,0)
 . F I=1:1:$L(X) I $E(X,I)=+$E(X,I) S X=$E(X,I,$L(X)) Q
"RTN","VPRDPSI",129,0)
IVQ ; done
"RTN","VPRDPSI",130,0)
 K ^TMP("PS",$J),^TMP($J,"VPRTE")
"RTN","VPRDPSI",131,0)
 Q
"RTN","VPRDPSI",132,0)
 ;
"RTN","VPRDPSI",133,0)
IVP ; -- add IV products for ID,DFN
"RTN","VPRDPSI",134,0)
 ; [expects PS("A") & PS("B") data arrays from IV*/PSOORRL]
"RTN","VPRDPSI",135,0)
 N VPI,N,NAME,IEN,DRUG,X S N=0
"RTN","VPRDPSI",136,0)
 ; IV Additives
"RTN","VPRDPSI",137,0)
 S VPI=0 F  S VPI=$O(PS("A",VPI)) Q:VPI<1  D
"RTN","VPRDPSI",138,0)
 . K ^TMP($J,"VPRPSIV") S NAME=$P($G(PS("A",VPI,0)),U)
"RTN","VPRDPSI",139,0)
 . D ZERO^PSS52P6("",NAME,"","VPRPSIV")
"RTN","VPRDPSI",140,0)
 . S IEN=$O(^TMP($J,"VPRPSIV",0)),DRUG=+$G(^(IEN,1)) Q:IEN<1
"RTN","VPRDPSI",141,0)
 . S N=N+1 D:DRUG NDF^VPRDPS(DRUG,N) S:'DRUG MED("product",N)=U_NAME
"RTN","VPRDPSI",142,0)
 . S $P(MED("product",N),U,4,5)="A^"_$P($G(PS("A",VPI,0)),U,2)
"RTN","VPRDPSI",143,0)
 . S X=$G(^TMP($J,"VPRPSIV",IEN,15))
"RTN","VPRDPSI",144,0)
 . S:X MED("product",N,"O")=+X_U_$$NAME^PSS50P7(+X)
"RTN","VPRDPSI",145,0)
 ; IV Base Solutions
"RTN","VPRDPSI",146,0)
 S VPI=0 F  S VPI=$O(PS("B",VPI)) Q:VPI<1  D
"RTN","VPRDPSI",147,0)
 . K ^TMP($J,"VPRPSIV") S NAME=$P($G(PS("B",VPI,0)),U)
"RTN","VPRDPSI",148,0)
 . D ZERO^PSS52P7("",NAME,"","VPRPSIV")
"RTN","VPRDPSI",149,0)
 . S IEN=$O(^TMP($J,"VPRPSIV",0)),DRUG=+$G(^(IEN,1)) Q:IEN<1
"RTN","VPRDPSI",150,0)
 . S N=N+1 D:DRUG NDF^VPRDPS(DRUG,N) S:'DRUG MED("product",N)=U_NAME
"RTN","VPRDPSI",151,0)
 . S $P(MED("product",N),U,4,5)="B^"_$P($G(PS("B",VPI,0)),U,2)
"RTN","VPRDPSI",152,0)
 . S X=$G(^TMP($J,"VPRPSIV",IEN,9))
"RTN","VPRDPSI",153,0)
 . S:X MED("product",N,"O")=+X_U_$$NAME^PSS50P7(+X)
"RTN","VPRDPSI",154,0)
 K ^TMP($J,"VPRPSIV")
"RTN","VPRDPSI",155,0)
 Q 
"RTN","VPRDPSI",156,0)
 ;
"RTN","VPRDPSI",157,0)
IVLIM(X) ; -- Return expanded version of IV Limit X
"RTN","VPRDPSI",158,0)
 I '$L($G(X)) Q ""
"RTN","VPRDPSI",159,0)
 N Y,VAL,UNT,I
"RTN","VPRDPSI",160,0)
 S Y="",X=$$UP^XLFSTR(X)
"RTN","VPRDPSI",161,0)
 I X?1"DOSES".E S X="A"_$P(X,"DOSES",2)
"RTN","VPRDPSI",162,0)
 S UNT=$E(X),VAL=0 F I=2:1:$L(X) I $E(X,I) S VAL=$E(X,I,$L(X)) Q
"RTN","VPRDPSI",163,0)
 I UNT="A" S Y=+VAL_$S(+VAL>1:" doses",1:" dose")
"RTN","VPRDPSI",164,0)
 I UNT="D" S Y=+VAL_$S(+VAL>1:" days",1:" day")
"RTN","VPRDPSI",165,0)
 I UNT="H" S Y=+VAL_$S(+VAL>1:" hours",1:" hour")
"RTN","VPRDPSI",166,0)
 I UNT="C" S Y=+VAL_" CC"
"RTN","VPRDPSI",167,0)
 I UNT="M" S Y=+VAL_" ml"
"RTN","VPRDPSI",168,0)
 I UNT="L" S Y=+VAL_" L"
"RTN","VPRDPSI",169,0)
 Q Y
"RTN","VPRDPSO")
0^9^B15569449^B68282901
"RTN","VPRDPSO",1,0)
VPRDPSO ;SLC/MKB -- Outpatient Pharmacy extract ;8/2/11  15:29
"RTN","VPRDPSO",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPSO",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSO",4,0)
 ;
"RTN","VPRDPSO",5,0)
 ; External References          DBIA#
"RTN","VPRDPSO",6,0)
 ; -------------------          -----
"RTN","VPRDPSO",7,0)
 ; PSODI                         4858
"RTN","VPRDPSO",8,0)
 ; PSOORDER,^TMP("PSOR",$J)      1878
"RTN","VPRDPSO",9,0)
 ; PSS50P7                       4662
"RTN","VPRDPSO",10,0)
 ; PSS51P2                       4548
"RTN","VPRDPSO",11,0)
 ; XLFDT                        10103
"RTN","VPRDPSO",12,0)
 ; XLFSTR                       10104
"RTN","VPRDPSO",13,0)
 ;
"RTN","VPRDPSO",14,0)
 ; ------------ Get prescription from VistA ------------
"RTN","VPRDPSO",15,0)
 ;
"RTN","VPRDPSO",16,0)
RX(ID,MED) ; -- return a prescription in MED("attribute")=value
"RTN","VPRDPSO",17,0)
 N RX0,RX1,DRUG,PSOI,X,I,START,STOP,ORIFN,FILL,RFD,PRV K MED
"RTN","VPRDPSO",18,0)
 N VPR ;PSOORDER kills VPR
"RTN","VPRDPSO",19,0)
 K ^TMP("PSOR",$J) D EN^PSOORDER(DFN,+ID)
"RTN","VPRDPSO",20,0)
 S RX0=$G(^TMP("PSOR",$J,+ID,0)),RX1=$G(^(1)),DRUG=$G(^("DRUG",0))
"RTN","VPRDPSO",21,0)
 S MED("medID")=ID_";O",MED("vaType")="O",MED("type")="Prescription"
"RTN","VPRDPSO",22,0)
 S ORIFN=+$P(RX1,U,8) S:ORIFN MED("orderID")=ORIFN
"RTN","VPRDPSO",23,0)
 S PSOI=$G(^TMP("PSOR",$J,+ID,"DRUGOI",0)) I PSOI D
"RTN","VPRDPSO",24,0)
 . S MED("name")=$P(PSOI,";",2)
"RTN","VPRDPSO",25,0)
 . D ZERO^PSS50P7(+PSOI,,,"OI")
"RTN","VPRDPSO",26,0)
 . S MED("form")=$P($G(^TMP($J,"OI",+PSOI,.02)),U,2)
"RTN","VPRDPSO",27,0)
 . S:+$G(^TMP($J,"OI",+PSOI,.09)) MED("supply")=1
"RTN","VPRDPSO",28,0)
 D:DRUG NDF^VPRDPS(+DRUG) ;add NDF data
"RTN","VPRDPSO",29,0)
 S START=$P(RX0,U) S:START MED("start")=START
"RTN","VPRDPSO",30,0)
 S STOP=$P(RX0,U,12) S:STOP MED("stop")=STOP ;_".2359"?
"RTN","VPRDPSO",31,0)
 S X=$$GET1^PSODI(52,+ID_",",26,"I") S:X MED("expires")=$P(X,U,2) ;1^date
"RTN","VPRDPSO",32,0)
 S X=$P(RX0,U,17) S:X MED("ordered")=X
"RTN","VPRDPSO",33,0)
 S MED("vaStatus")=$$UP^XLFSTR($P($P(RX0,U,4),";",2)),X=$P($P(RX0,U,4),";")
"RTN","VPRDPSO",34,0)
 S MED("status")=$S(X="H":"hold",X="DC":"not active",X="D"!(X="E"):"historical",1:"active")
"RTN","VPRDPSO",35,0)
 S MED("quantity")=$P(RX0,U,6),MED("daysSupply")=$P(RX0,U,7)
"RTN","VPRDPSO",36,0)
 S MED("fillsAllowed")=$P(RX0,U,8),MED("fillsRemaining")=$P(RX0,U,9)
"RTN","VPRDPSO",37,0)
 S MED("routing")=$P($P(RX1,U,6),";"),MED("prescription")=$P(RX0,U,5)
"RTN","VPRDPSO",38,0)
 S MED("lastFilled")=$P(RX0,U,3) K FILL
"RTN","VPRDPSO",39,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"REF",I)) Q:I<1  S X=$G(^(I,0)),FILL(+X)=X
"RTN","VPRDPSO",40,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"RPAR",I)) Q:I<1  S X=$G(^(I,0)),$P(X,U,14)=1,FILL(+X)=X
"RTN","VPRDPSO",41,0)
 S (I,RFD,PRV)=0 F  S RFD=$O(FILL(RFD)) Q:RFD<1  S X=$G(FILL(RFD)) D  ;sort 1st
"RTN","VPRDPSO",42,0)
 . N MW,REL S I=I+1
"RTN","VPRDPSO",43,0)
 . S MW=$P($P(X,U,10),";"),REL=$P($P(X,U,8),".")
"RTN","VPRDPSO",44,0)
 . S MED("fill",I)=$P(RFD,".")_U_MW_U_REL_U_$P(X,U,4,5)_$S($P(X,U,14):"^1",1:"")
"RTN","VPRDPSO",45,0)
 . S:$P(X,U,2) PRV=$P(X,U,2) ;save last provider
"RTN","VPRDPSO",46,0)
 . ; fill comments?
"RTN","VPRDPSO",47,0)
 S X=$S($P(RX0,U,11):$P(RX0,U,11),$P(RX0,U,10):$P(RX0,U,10),1:0)
"RTN","VPRDPSO",48,0)
 S:X MED("fillCost")=X
"RTN","VPRDPSO",49,0)
 S X=$G(^TMP("PSOR",$J,+ID,"SIG",1,0)),I=1
"RTN","VPRDPSO",50,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"SIG",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",51,0)
 S MED("sig")=X
"RTN","VPRDPSO",52,0)
 S X=$G(^TMP("PSOR",$J,+ID,"PI",1,0)),I=1
"RTN","VPRDPSO",53,0)
 F  S I=$O(^TMP("PSOR",$J,+ID,"PI",I)) Q:I<1  S X=X_$G(^(I,0))
"RTN","VPRDPSO",54,0)
 S:$L(X) MED("ptInstructions")=X
"RTN","VPRDPSO",55,0)
 S I=0 F  S I=$O(^TMP("PSOR",$J,+ID,"MI",I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPSO",56,0)
 . N UD,NOUN,DOSE,UNIT,RTE,SCH,DUR,CONJ,END
"RTN","VPRDPSO",57,0)
 . S UD=$P(X,U,2),NOUN=$P(X,U,4)
"RTN","VPRDPSO",58,0)
 . S DOSE=$P(X,U),UNIT=$P($P(X,U,3),";",2)
"RTN","VPRDPSO",59,0)
 . S RTE=+$P(X,U,7) D ALL^PSS51P2(RTE,,,,"MR")
"RTN","VPRDPSO",60,0)
 . S RTE=$G(^TMP($J,"MR",RTE,1))
"RTN","VPRDPSO",61,0)
 . S DUR=$P(X,U,5),CONJ=$P(X,U,6),SCH=$P(X,U,8)
"RTN","VPRDPSO",62,0)
 . S END=$S(DUR:$$STOP(START,DUR),1:STOP)
"RTN","VPRDPSO",63,0)
 . S MED("dose",I)=DOSE_U_UNIT_U_UD_U_NOUN_U_RTE_U_SCH_U_DUR_U_CONJ_U_START_U_END
"RTN","VPRDPSO",64,0)
 . I $E(CONJ)="T",DUR S START=END
"RTN","VPRDPSO",65,0)
 S:RX1 X=$TR($P(RX1,U),";","^"),MED("orderingProvider")=X,MED("currentProvider")=X
"RTN","VPRDPSO",66,0)
 S:$G(PRV) MED("currentProvider")=$TR(PRV,";","^")
"RTN","VPRDPSO",67,0)
 S:$P(RX1,U,9) MED("pharmacist")=$TR($P(RX1,U,9),";","^")
"RTN","VPRDPSO",68,0)
 S:$P(RX1,U,4) MED("location")=$TR($P(RX1,U,4),";","^")
"RTN","VPRDPSO",69,0)
 S MED("facility")=$$FAC^VPRD(+$P(RX1,U,4))
"RTN","VPRDPSO",70,0)
 K ^TMP("PSOR",$J),^TMP($J,"MR"),^TMP($J,"NDF"),^TMP($J,"OI")
"RTN","VPRDPSO",71,0)
 Q
"RTN","VPRDPSO",72,0)
 ;
"RTN","VPRDPSO",73,0)
STOP(BEG,X) ; -- Return date after adding X to BEG
"RTN","VPRDPSO",74,0)
 N D,H,M,UNT,Y
"RTN","VPRDPSO",75,0)
 S Y=BEG,(D,H,M)=0,UNT=$P(X,+X,2),X=+X
"RTN","VPRDPSO",76,0)
 S:$E(UNT)=" " UNT=$E(UNT,2,99) I UNT="" S UNT="D"
"RTN","VPRDPSO",77,0)
 S:UNT="L" D=30*X
"RTN","VPRDPSO",78,0)
 S:UNT="W" D=7*X
"RTN","VPRDPSO",79,0)
 S:UNT="D" D=X
"RTN","VPRDPSO",80,0)
 S:UNT="H" H=X
"RTN","VPRDPSO",81,0)
 S:UNT="M" M=X
"RTN","VPRDPSO",82,0)
 S Y=$$FMADD^XLFDT(BEG,D,H,M)
"RTN","VPRDPSO",83,0)
 Q Y
"RTN","VPRDPSO",84,0)
 ;
"RTN","VPRDPSO",85,0)
ACTIVE(X) ; -- return 1 or 0, if X is an active status
"RTN","VPRDPSO",86,0)
 N Y S Y=1
"RTN","VPRDPSO",87,0)
 I X="PURGE" S Y=0
"RTN","VPRDPSO",88,0)
 I X="DELETED" S Y=0
"RTN","VPRDPSO",89,0)
 I X="EXPIRED" S Y=0 ;keep, to renew?
"RTN","VPRDPSO",90,0)
 I $P(X," ")="DISCONTINUED" S Y=0
"RTN","VPRDPSO",91,0)
 Q Y
"RTN","VPRDPSOR")
0^10^B39128356^n/a
"RTN","VPRDPSOR",1,0)
VPRDPSOR ;SLC/MKB -- Medication extract by order ;8/2/11  15:29
"RTN","VPRDPSOR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPSOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPSOR",4,0)
 ;
"RTN","VPRDPSOR",5,0)
 ; External References          DBIA#
"RTN","VPRDPSOR",6,0)
 ; -------------------          -----
"RTN","VPRDPSOR",7,0)
 ; ^OR(100                       5771
"RTN","VPRDPSOR",8,0)
 ; ^ORD(100.98                    873
"RTN","VPRDPSOR",9,0)
 ; ^SC                          10040
"RTN","VPRDPSOR",10,0)
 ; ^VA(200                      10060
"RTN","VPRDPSOR",11,0)
 ; DIQ                           2056
"RTN","VPRDPSOR",12,0)
 ; ORCD                          5493
"RTN","VPRDPSOR",13,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","VPRDPSOR",14,0)
 ; ORX8                 871,2467,3071
"RTN","VPRDPSOR",15,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","VPRDPSOR",16,0)
 ; PSS50P7                       4662
"RTN","VPRDPSOR",17,0)
 ; PSS51P2                       4548
"RTN","VPRDPSOR",18,0)
 ;
"RTN","VPRDPSOR",19,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPSOR",20,0)
 ;
"RTN","VPRDPSOR",21,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find a patient's orders
"RTN","VPRDPSOR",22,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPSOR",23,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPSOR",24,0)
 N ORDIALOG              ;med dialog array, keep/reuse
"RTN","VPRDPSOR",25,0)
 ;
"RTN","VPRDPSOR",26,0)
 ; get one order
"RTN","VPRDPSOR",27,0)
 I $G(ORIFN) D EN1(ORIFN,.VPRITM),XML^VPRDPS(.VPRITM):$D(VPRITM) Q
"RTN","VPRDPSOR",28,0)
 ;
"RTN","VPRDPSOR",29,0)
 ; get all orders
"RTN","VPRDPSOR",30,0)
 N TYPE,ORDG,ORVP,ORLIST,VPRITM,VPRCNT,VPRN,ORLIST,ORIFN,X3,X4,DAD
"RTN","VPRDPSOR",31,0)
 S TYPE=$G(FILTER("vaType")) S:$L(TYPE) TYPE=$S(TYPE="N":"NV",TYPE="V":"IV",1:TYPE)_" "
"RTN","VPRDPSOR",32,0)
 S ORDG=+$O(^ORD(100.98,"B",TYPE_"RX",0)),ORVP=DFN_";DPT("
"RTN","VPRDPSOR",33,0)
 D EN^ORQ1(ORVP,ORDG,6,,BEG,END)
"RTN","VPRDPSOR",34,0)
 K ^TMP("VPROR",$J) S (VPRCNT,VPRN)=0
"RTN","VPRDPSOR",35,0)
 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ORIFN=$G(^(VPRN)) D  Q:VPRCNT'<MAX
"RTN","VPRDPSOR",36,0)
 . Q:$D(^TMP("VPROR",$J,+ORIFN))  Q:$P(ORIFN,";",2)>1  S ORIFN=+ORIFN
"RTN","VPRDPSOR",37,0)
 . S X3=$G(^OR(100,ORIFN,3)),X4=$G(^(4))
"RTN","VPRDPSOR",38,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1 Q  ;cancelled
"RTN","VPRDPSOR",39,0)
 . S DAD=$P(X3,U,9) I DAD Q:$D(^TMP("VPROR",$J,DAD))  S ORIFN=DAD
"RTN","VPRDPSOR",40,0)
 . K VPRITM D EN1(ORIFN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPSOR",41,0)
 . D XML^VPRDPS(.VPRITM)
"RTN","VPRDPSOR",42,0)
 . S ^TMP("VPROR",$J,ORIFN)="",VPRCNT=VPRCNT+1
"RTN","VPRDPSOR",43,0)
 K ^TMP("VPROR",$J),^TMP("ORR",$J),^TMP($J,"PSOI")
"RTN","VPRDPSOR",44,0)
 Q
"RTN","VPRDPSOR",45,0)
 ;
"RTN","VPRDPSOR",46,0)
EN1(IFN,MED) ; -- return an order in MED("attribute")=value [from EN]
"RTN","VPRDPSOR",47,0)
 N ORUPCHUK,ORVP,ORPCL,ORPK,ORDUZ,ORODT,ORSTRT,ORSTOP,ORL,ORTO,ORSTS,ORNP,ORPV,ORTX
"RTN","VPRDPSOR",48,0)
 N CLS,OI,X,LOC,DRUG,DA,CNT,VPRESP K MED
"RTN","VPRDPSOR",49,0)
 S IFN=+$G(IFN) I IFN<1!'$D(^OR(100,IFN)) Q
"RTN","VPRDPSOR",50,0)
 S ORPK=$$PKGID^ORX8(IFN)
"RTN","VPRDPSOR",51,0)
 S X=$S(ORPK:$E(ORPK,$L(ORPK)),1:"Z") S:X=+X X="R" ;last char = PS file
"RTN","VPRDPSOR",52,0)
 S CLS=$S("RSN"[X:"O","UV"[X:"I",1:$$GET1^DIQ(100,IFN_",",10,"I"))
"RTN","VPRDPSOR",53,0)
 I CLS="O",ORPK=+ORPK!(ORPK["R") D RX^VPRDPSO(ORPK,.MED) S MED("id")=IFN Q
"RTN","VPRDPSOR",54,0)
 S MED("id")=IFN,MED("orderID")=IFN,MED("vaType")=CLS
"RTN","VPRDPSOR",55,0)
 S:ORPK MED("medID")=ORPK_";"_CLS
"RTN","VPRDPSOR",56,0)
 D EN^ORX8(IFN) S X="" F  S X=$O(ORUPCHUK(X)) Q:X=""  S:$D(ORUPCHUK(X))#2 @X=ORUPCHUK(X)
"RTN","VPRDPSOR",57,0)
 S MED("ordered")=$G(ORODT),MED("orderingProvider")=$G(ORNP)
"RTN","VPRDPSOR",58,0)
 S MED("currentProvider")=$$LASTPROV(IFN)
"RTN","VPRDPSOR",59,0)
 S MED("start")=$G(ORSTRT),MED("stop")=$G(ORSTOP)
"RTN","VPRDPSOR",60,0)
 S MED("vaStatus")=$P($G(ORSTS),U,2),MED("status")=$$STATUS(+$G(ORSTS))
"RTN","VPRDPSOR",61,0)
 S LOC=+$G(ORL) S:LOC MED("location")=LOC_U_$P(^SC(LOC,0),U)
"RTN","VPRDPSOR",62,0)
 I CLS="I" D
"RTN","VPRDPSOR",63,0)
 . S:$P($G(^SC(+$G(LOC),0)),U,25) MED("IMO")=1
"RTN","VPRDPSOR",64,0)
 . S X=$P($G(^OR(100,IFN,3)),U,9) S:X MED("parent")=X
"RTN","VPRDPSOR",65,0)
 S MED("facility")=$$FAC^VPRD(LOC) I ORPK D
"RTN","VPRDPSOR",66,0)
 . N IFN D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","VPRDPSOR",67,0)
 I $$IV D IV^VPRDPSI Q
"RTN","VPRDPSOR",68,0)
 S:CLS="O" MED("type")="Prescription"
"RTN","VPRDPSOR",69,0)
 S:ORPK["N" MED("vaType")="N",MED("type")="OTC"
"RTN","VPRDPSOR",70,0)
ENA ; get order responses
"RTN","VPRDPSOR",71,0)
 S OI=$$OI^ORX8(IFN) I OI S MED("name")=$P(OI,U,2) D
"RTN","VPRDPSOR",72,0)
 . D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","VPRDPSOR",73,0)
 . S MED("form")=$P($G(^TMP($J,"PSOI",+$P(OI,U,3),.02)),U,2)
"RTN","VPRDPSOR",74,0)
 . S:+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09)) MED("supply")=1
"RTN","VPRDPSOR",75,0)
 D RESP(IFN,.VPRESP) ;order responses
"RTN","VPRDPSOR",76,0)
 S DRUG=+$G(^TMP("PS",$J,"DD",1,0)) S:'DRUG DRUG=+$G(VPRESP("DRUG",1))
"RTN","VPRDPSOR",77,0)
 S MED("sig")=$S(CLS="I":"Give: ",1:"")_$G(VPRESP("SIG",1)) ;ORTX(2)
"RTN","VPRDPSOR",78,0)
 I CLS="I"!(ORPK["N") D  G ENQ ;UD or NVA: single dose, or child orders
"RTN","VPRDPSOR",79,0)
 . I '$O(^OR(100,IFN,2,0)) S MED("dose",1)=$$DOSE(1)_U_$G(ORSTRT)_U_$G(ORSTOP) Q
"RTN","VPRDPSOR",80,0)
 . N DD,CONJ M CONJ=VPRESP("CONJ")
"RTN","VPRDPSOR",81,0)
 . S (DA,CNT)=0 F  S DA=$O(^OR(100,IFN,2,DA)) Q:DA<1  D
"RTN","VPRDPSOR",82,0)
 .. K VPRESP D RESP(DA,.VPRESP)
"RTN","VPRDPSOR",83,0)
 .. S CNT=CNT+1,MED("dose",CNT)=$$DOSE(1)_U_$P($G(^OR(100,DA,0)),U,8,9)_U_DA
"RTN","VPRDPSOR",84,0)
 .. S $P(MED("dose",CNT),U,8)=$G(CONJ(CNT))
"RTN","VPRDPSOR",85,0)
 .. I $P(MED("dose",CNT),U,10)>$G(ORSTOP) S ORSTOP=$P(MED("dose",CNT),U,10)
"RTN","VPRDPSOR",86,0)
 .. S:'DRUG DD=+$G(VPRESP("DRUG",1)),DD(DD,DA)="" ;dispense drug(s)
"RTN","VPRDPSOR",87,0)
 .. ; get ^TMP("PS",$J) from 1st child, if Inpt parent:
"RTN","VPRDPSOR",88,0)
 .. I '$D(^TMP("PS",$J)) S ORPK=$$PKGID^ORX8(DA) D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","VPRDPSOR",89,0)
 . S MED("stop")=$G(ORSTOP) ;reset from last child order
"RTN","VPRDPSOR",90,0)
 . S DD=$O(DD(0)) I DD,'$O(DD(DD)) S DRUG=DD Q  ;1 drug for order
"RTN","VPRDPSOR",91,0)
 . S (DD,CNT)=0 F  S DD=$O(DD(DD)) Q:DD<1  S DA=0 F  S DA=$O(DD(DD,DA)) Q:DA<1  S CNT=CNT+1 D NDF^VPRDPS(DD,CNT,DA)
"RTN","VPRDPSOR",92,0)
 ; pending Rx: dose(s), qty, etc.
"RTN","VPRDPSOR",93,0)
 S CNT=0 F  S CNT=$O(VPRESP("INSTR",CNT)) Q:CNT<1  S MED("dose",CNT)=$$DOSE(CNT) ;_STRT^STOP
"RTN","VPRDPSOR",94,0)
 S MED("quantity")=$G(VPRESP("QTY",1))
"RTN","VPRDPSOR",95,0)
 S MED("daysSupply")=$G(VPRESP("SUPPLY",1))
"RTN","VPRDPSOR",96,0)
 S MED("routing")=$G(VPRESP("PICKUP",1))
"RTN","VPRDPSOR",97,0)
 S MED("fillsAllowed")=$G(VPRESP("REFILLS",1))
"RTN","VPRDPSOR",98,0)
 S MED("ptInstructions")=$G(VPRESP("PI",1))
"RTN","VPRDPSOR",99,0)
ENQ ; finish
"RTN","VPRDPSOR",100,0)
 D:DRUG NDF^VPRDPS(+DRUG)
"RTN","VPRDPSOR",101,0)
 S X=+$P($G(^TMP("PS",$J,"RXN",0)),U,5)
"RTN","VPRDPSOR",102,0)
 S:X MED("pharmacist")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDPSOR",103,0)
 K ^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","VPRDPSOR",104,0)
 Q
"RTN","VPRDPSOR",105,0)
 ;
"RTN","VPRDPSOR",106,0)
IV() ; -- Return 1 or 0, if order is for IV/infusion
"RTN","VPRDPSOR",107,0)
 I ORPK["V" Q 1
"RTN","VPRDPSOR",108,0)
 I $P($G(ORTO),U,2)?1"IV".E Q 1
"RTN","VPRDPSOR",109,0)
 I +$G(ORPCL)=130 Q 1
"RTN","VPRDPSOR",110,0)
 I $G(^TMP("PS",$J,"B",0)) Q 1
"RTN","VPRDPSOR",111,0)
 Q 0
"RTN","VPRDPSOR",112,0)
 ;
"RTN","VPRDPSOR",113,0)
DOSE(N) ; --add dosage data from VPRESP(ID,N) [instance N]
"RTN","VPRDPSOR",114,0)
 N DOSE,X,ID S N=+$G(N,1)
"RTN","VPRDPSOR",115,0)
 S DOSE=$P($G(VPRESP("DOSE",N)),"&",1,4),DOSE=$TR(DOSE,"&","^")
"RTN","VPRDPSOR",116,0)
 I '$L($P(DOSE,U)) S DOSE=$G(VPRESP("INSTR",N))_"^^^"
"RTN","VPRDPSOR",117,0)
 S X=+$G(VPRESP("ROUTE",N)) D ALL^PSS51P2(X,,,,"VPRTE")
"RTN","VPRDPSOR",118,0)
 S DOSE=DOSE_U_$G(^TMP($J,"VPRTE",X,1))
"RTN","VPRDPSOR",119,0)
 F ID="SCHEDULE","DAYS","CONJ" S DOSE=DOSE_U_$G(VPRESP(ID,N))
"RTN","VPRDPSOR",120,0)
 K ^TMP($J,"VPRTE")
"RTN","VPRDPSOR",121,0)
 Q DOSE
"RTN","VPRDPSOR",122,0)
 ;
"RTN","VPRDPSOR",123,0)
LASTPROV(IFN) ; -- return last provider who took action on order IFN
"RTN","VPRDPSOR",124,0)
 N I,X,Y S Y=""
"RTN","VPRDPSOR",125,0)
 S I="A" F  S I=$O(^OR(100,IFN,8,I),-1) Q:I<1  S X=$G(^(I,0)) D  Q:Y
"RTN","VPRDPSOR",126,0)
 . I $P(X,U,5) S Y=+$P(X,U,5) Q  ;signer
"RTN","VPRDPSOR",127,0)
 . I $P(X,U,3) S Y=+$P(X,U,3) Q  ;orderer
"RTN","VPRDPSOR",128,0)
 S:Y Y=Y_U_$P($G(^VA(200,Y,0)),U)
"RTN","VPRDPSOR",129,0)
 Q Y
"RTN","VPRDPSOR",130,0)
 ;
"RTN","VPRDPSOR",131,0)
STRING(IFN,ID) ; -- return text value as a string
"RTN","VPRDPSOR",132,0)
 N DA,I,X,Y
"RTN","VPRDPSOR",133,0)
 S DA=+$O(^OR(100,IFN,4.5,"ID",ID,0)) Q:DA<1 ""
"RTN","VPRDPSOR",134,0)
 S I=+$O(^OR(100,IFN,4.5,DA,2,0)),Y=$G(^(I,0))
"RTN","VPRDPSOR",135,0)
 F  S I=+$O(^OR(100,IFN,4.5,DA,2,I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPSOR",136,0)
 . I $E(Y,$L(Y))'=" " S Y=Y_" "
"RTN","VPRDPSOR",137,0)
 . S Y=Y_X
"RTN","VPRDPSOR",138,0)
 Q Y
"RTN","VPRDPSOR",139,0)
 ;
"RTN","VPRDPSOR",140,0)
STATUS(X) ; -- return HITSP status for 100.01 #X
"RTN","VPRDPSOR",141,0)
 S X=+$G(X) S:'X X=99  ;no status
"RTN","VPRDPSOR",142,0)
 I X=3 Q "hold"
"RTN","VPRDPSOR",143,0)
 I X=10!(X=11)!(X=5) Q "not active"
"RTN","VPRDPSOR",144,0)
 I X=1!(X=12)!(X=13) Q "not active"
"RTN","VPRDPSOR",145,0)
 I X=14!(X=99)       Q "not active"
"RTN","VPRDPSOR",146,0)
 I X=2!(X=7)!(X=15)  Q "historical"
"RTN","VPRDPSOR",147,0)
 Q "active"
"RTN","VPRDPSOR",148,0)
 ;
"RTN","VPRDPSOR",149,0)
RESP(ORIFN,RESP) ; -- return order responses [internal form]
"RTN","VPRDPSOR",150,0)
 N VPRDLG,I,J,W,ID,TYPE,X,Y
"RTN","VPRDPSOR",151,0)
 I '$D(ORDIALOG) S ORDIALOG=129 D GETDLG1^ORCD(129)
"RTN","VPRDPSOR",152,0)
 D GETORDER^ORCD(+$G(ORIFN),"VPRDLG")
"RTN","VPRDPSOR",153,0)
 S I=0 F  S I=$O(VPRDLG(I)) Q:I<1  D
"RTN","VPRDPSOR",154,0)
 . S ID=$P($G(ORDIALOG(I)),U,2) Q:'$L(ID)
"RTN","VPRDPSOR",155,0)
 . S TYPE=$P($G(ORDIALOG(I,0)),U)
"RTN","VPRDPSOR",156,0)
 . S J=0 F  S J=$O(VPRDLG(I,J)) Q:J<1  I $D(VPRDLG(I,J)) D
"RTN","VPRDPSOR",157,0)
 .. S X=VPRDLG(I,J) I TYPE'="W" S RESP(ID,J)=X Q
"RTN","VPRDPSOR",158,0)
 .. S Y=$G(@X@(1,0)),W=1 F  S W=$O(@X@(W)) Q:W<1  S Y=Y_$S($E(Y,$L(Y))'=" ":" ",1:"")_$G(@X@(W,0))
"RTN","VPRDPSOR",159,0)
 .. S:$L(Y) RESP(ID,J)=Y
"RTN","VPRDPSOR",160,0)
 Q
"RTN","VPRDPT")
0^11^B70553505^B65865871
"RTN","VPRDPT",1,0)
VPRDPT ;SLC/MKB -- Patient demographics extract ;8/11/11  15:29
"RTN","VPRDPT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPT",4,0)
 ;
"RTN","VPRDPT",5,0)
 ; External References          DBIA#
"RTN","VPRDPT",6,0)
 ; -------------------          -----
"RTN","VPRDPT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPT",8,0)
 ; ^DGSL(38.1                     767
"RTN","VPRDPT",9,0)
 ; ^DIC(4                       10090
"RTN","VPRDPT",10,0)
 ; ^DIC(31                        733
"RTN","VPRDPT",11,0)
 ; ^DIC(42                  723,10039
"RTN","VPRDPT",12,0)
 ; ^DPT               3581,5597,10035
"RTN","VPRDPT",13,0)
 ; DGCV                          4156
"RTN","VPRDPT",14,0)
 ; DGMSTAPI                      2716
"RTN","VPRDPT",15,0)
 ; DGNTAPI                       3457
"RTN","VPRDPT",16,0)
 ; DGPFAPI                       3860
"RTN","VPRDPT",17,0)
 ; DGRPDB                        4807
"RTN","VPRDPT",18,0)
 ; DILFD                         2055
"RTN","VPRDPT",19,0)
 ; DIQ                           2056
"RTN","VPRDPT",20,0)
 ; MPIF001                       2701
"RTN","VPRDPT",21,0)
 ; SDUTL3                        1252
"RTN","VPRDPT",22,0)
 ; VADPT                        10061
"RTN","VPRDPT",23,0)
 ; VAFCTFU1                      2990
"RTN","VPRDPT",24,0)
 ; VASITE                       10112
"RTN","VPRDPT",25,0)
 ; XUAF4                         2171
"RTN","VPRDPT",26,0)
 ;
"RTN","VPRDPT",27,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPT",28,0)
 ;
"RTN","VPRDPT",29,0)
EN(DFN,BEG,END,MAX,ID) ; -- find current patient demographics
"RTN","VPRDPT",30,0)
 ; [BEG,END,MAX,ID not currently used]
"RTN","VPRDPT",31,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPT",32,0)
 N PAT,SYS S SYS=$$SITE^VASITE
"RTN","VPRDPT",33,0)
 D DEM,SVC,PRF,ATC,SUPP,ALIAS,FAC
"RTN","VPRDPT",34,0)
 I $D(PAT)>9 D XML(.PAT)
"RTN","VPRDPT",35,0)
 Q
"RTN","VPRDPT",36,0)
 ;
"RTN","VPRDPT",37,0)
DEM ;-demographic data
"RTN","VPRDPT",38,0)
 N VADM,VA,VAERR,X
"RTN","VPRDPT",39,0)
 S X=+$$GETICN^MPIF001(DFN) S:X>1 PAT("icn")=X
"RTN","VPRDPT",40,0)
 D DEM^VADPT S X=VADM(1),PAT("fullName")=X
"RTN","VPRDPT",41,0)
 S PAT("familyName")=$P(X,","),PAT("givenNames")=$P(X,",",2,99)
"RTN","VPRDPT",42,0)
 S PAT("ssn")=$P(VADM(2),U),PAT("id")=DFN
"RTN","VPRDPT",43,0)
 S:$D(VA("BID")) PAT("bid")=$E(X)_VA("BID")
"RTN","VPRDPT",44,0)
 S PAT("dob")=+$P($P(VADM(3),U),".")
"RTN","VPRDPT",45,0)
 S PAT("gender")=$P(VADM(5),U)
"RTN","VPRDPT",46,0)
 S PAT("lrdfn")=+$G(^DPT(DFN,"LR"))
"RTN","VPRDPT",47,0)
 S X=+$P($P(VADM(6),U),".") S:X PAT("died")=X
"RTN","VPRDPT",48,0)
 S X=$$GET1^DIQ(38.1,DFN_",",2,"I") S:$L(X) PAT("sensitive")=X
"RTN","VPRDPT",49,0)
 S X=+VADM(9) S:X PAT("religion")=X
"RTN","VPRDPT",50,0)
 S X=$P(VADM(10),U,2) S:$L(X) PAT("maritalStatus")=$E(X)
"RTN","VPRDPT",51,0)
 I VADM(11) D
"RTN","VPRDPT",52,0)
 . N I S I=0
"RTN","VPRDPT",53,0)
 . F  S I=$O(VADM(11,I)) Q:I<1  S X=+VADM(11,I),PAT("ethnicity",X)=$$GET1^DIQ(2.06,X_","_DFN_",",".01:3")
"RTN","VPRDPT",54,0)
 I VADM(12) D
"RTN","VPRDPT",55,0)
 . N I S I=0
"RTN","VPRDPT",56,0)
 . F  S I=$O(VADM(12,I)) Q:I<1  S X=+VADM(12,I),PAT("race",X)=$$GET1^DIQ(2.02,X_","_DFN_",",".01:3")
"RTN","VPRDPT",57,0)
 Q
"RTN","VPRDPT",58,0)
SVC ;-service data
"RTN","VPRDPT",59,0)
 N VAEL,VASV,VAERR,X,Y,I,AO,IR,PGF,HNC,MST,CV
"RTN","VPRDPT",60,0)
 D 7^VADPT
"RTN","VPRDPT",61,0)
 S PAT("veteran")=VAEL(4)
"RTN","VPRDPT",62,0)
 S PAT("sc")=+VAEL(3) S:VAEL(3) PAT("scPercent")=+$P(VAEL(3),U,2)
"RTN","VPRDPT",63,0)
 ;
"RTN","VPRDPT",64,0)
 ; exposures
"RTN","VPRDPT",65,0)
 S AO=VASV(2),IR=VASV(3)
"RTN","VPRDPT",66,0)
 S PGF=VASV(11)!VASV(12)!VASV(13) ;OIF/OEF
"RTN","VPRDPT",67,0)
 S X=$$GETCUR^DGNTAPI(DFN,"HNC"),X=+($G(HNC("STAT")))
"RTN","VPRDPT",68,0)
 S HNC=$S(X=4:1,X=5:1,X=1:0,X=6:0,1:"")
"RTN","VPRDPT",69,0)
 S X=$P($$GETSTAT^DGMSTAPI(DFN),U,2),MST=$S(X="Y":1,X="N":0,1:"")
"RTN","VPRDPT",70,0)
 S X=$$CVEDT^DGCV(DFN),CV=$S(+X<0:"",+X=0:0,$P(X,U,3):1,1:0)
"RTN","VPRDPT",71,0)
 S PAT("exposures")=AO_U_IR_U_PGF_U_HNC_U_MST_U_CV
"RTN","VPRDPT",72,0)
 ;
"RTN","VPRDPT",73,0)
 ; rated disabilities [DGRPDB]
"RTN","VPRDPT",74,0)
 N VPRDIS,DIS,NM,DX
"RTN","VPRDPT",75,0)
 D RDIS^DGRPDB(DFN,.VPRDIS)
"RTN","VPRDPT",76,0)
 S I=0 F  S I=$O(VPRDIS(I)) Q:I<1  D
"RTN","VPRDPT",77,0)
 . S DIS=VPRDIS(I)
"RTN","VPRDPT",78,0)
 . S NM=$$GET1^DIQ(31,+DIS_",",.01),DX=$$GET1^DIQ(31,+DIS_",",2)
"RTN","VPRDPT",79,0)
 . S PAT("disability",+DX)=NM_U_$P(DIS,U,2,3) ;name^%^sc
"RTN","VPRDPT",80,0)
 Q
"RTN","VPRDPT",81,0)
PRF ;-patient record flags
"RTN","VPRDPT",82,0)
 N VPRPF,I,NAME,TEXT
"RTN","VPRDPT",83,0)
 Q:'$$GETACT^DGPFAPI(DFN,"VPRPF")
"RTN","VPRDPT",84,0)
 S I=0 F  S I=$O(VPRPF(I)) Q:I<1  D
"RTN","VPRDPT",85,0)
 . S NAME=$P(VPRPF(I,"FLAG"),U,2)
"RTN","VPRDPT",86,0)
 . M TEXT=VPRPF(I,"NARR")
"RTN","VPRDPT",87,0)
 . S PAT("flag",I)=NAME_U_$$STRING^VPRD(.TEXT)
"RTN","VPRDPT",88,0)
 Q
"RTN","VPRDPT",89,0)
ATC ;-address & telecom
"RTN","VPRDPT",90,0)
 N VAPA,I,X
"RTN","VPRDPT",91,0)
 S VAPA("P")="" D ADD^VADPT ;permanent address
"RTN","VPRDPT",92,0)
 S X="" F I=1:1:4 S X=X_VAPA(I)_U
"RTN","VPRDPT",93,0)
 S X=X_$P(VAPA(5),U,2)_U_$P(VAPA(11),U,2)
"RTN","VPRDPT",94,0)
 S PAT("address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",95,0)
 S X=$$FORMAT(VAPA(8))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.134))_U_$$FORMAT($$GET1^DIQ(2,DFN_",",.132))
"RTN","VPRDPT",96,0)
 S PAT("telecom")=X ;home^cell^work phones
"RTN","VPRDPT",97,0)
 Q
"RTN","VPRDPT",98,0)
SUPP ;-support contacts
"RTN","VPRDPT",99,0)
 N VAOA,A,I,X,TYPE
"RTN","VPRDPT",100,0)
 F A="",1 K VAOA D
"RTN","VPRDPT",101,0)
 . S:A VAOA("A")=A D OAD^VADPT Q:'$L($G(VAOA(9)))
"RTN","VPRDPT",102,0)
 . S TYPE=$S(A=1:"ECON",1:"NOK")
"RTN","VPRDPT",103,0)
 . S PAT("support",TYPE)=VAOA(9)_U_VAOA(10) ;name^relationship
"RTN","VPRDPT",104,0)
 . S X="" F I=1:1:4 S X=X_VAOA(I)_U
"RTN","VPRDPT",105,0)
 . S X=X_$P(VAOA(5),U,2)_U_$P(VAOA(11),U,2)
"RTN","VPRDPT",106,0)
 . S PAT("support",TYPE,"address")=X ;street1^st2^st3^city^state^zip
"RTN","VPRDPT",107,0)
 . S I=$S(A=1:.33011,1:.21011),X=$$FORMAT(VAOA(8))_U_U_$$FORMAT($$GET1^DIQ(2,DFN_",",I))
"RTN","VPRDPT",108,0)
 . S PAT("support",TYPE,"telecom")=X ;home^cell^work phones
"RTN","VPRDPT",109,0)
 Q
"RTN","VPRDPT",110,0)
ALIAS ;-other names used
"RTN","VPRDPT",111,0)
 N I,X
"RTN","VPRDPT",112,0)
 S I=0 F  S I=$O(^DPT(DFN,.01,I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","VPRDPT",113,0)
 . S PAT("alias",I)=$P(X,U)
"RTN","VPRDPT",114,0)
 Q
"RTN","VPRDPT",115,0)
FORMAT(X) ; -- enforce (xxx)xxx-xxxx phone format
"RTN","VPRDPT",116,0)
 S X=$G(X) I X?1"("3N1")"3N1"-"4N.E Q X
"RTN","VPRDPT",117,0)
 N P,N,I,Y S P=""
"RTN","VPRDPT",118,0)
 F I=1:1:$L(X) S N=$E(X,I) I N=+N S P=P_N
"RTN","VPRDPT",119,0)
 S:$L(P)<10 P=$E("0000000000",1,10-$L(P))_P
"RTN","VPRDPT",120,0)
 S Y=$S(P:"("_$E(P,1,3)_")"_$E(P,4,6)_"-"_$E(P,7,10),1:"")
"RTN","VPRDPT",121,0)
 Q Y
"RTN","VPRDPT",122,0)
FAC ;-treating facilities [see FACLIST^ORWCIRN]
"RTN","VPRDPT",123,0)
 N IFN S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDPT",124,0)
 N VPRY,HOME,LAST,I,X,IEN
"RTN","VPRDPT",125,0)
 I $L($T(TFL^VAFCTFU1)) D TFL^VAFCTFU1(.VPRY,DFN)
"RTN","VPRDPT",126,0)
 S HOME=+$P($G(^DPT(DFN,"MPI")),U,3) ;home facility
"RTN","VPRDPT",127,0)
 I $P($G(VPRY(1)),U)<0 D  Q  ;not setup
"RTN","VPRDPT",128,0)
 . S X=$O(^AUPNVSIT("AA",DFN,0)),LAST=$S(X:9999999-$P(X,"."),1:"")
"RTN","VPRDPT",129,0)
 . S X=$$SITE^VASITE
"RTN","VPRDPT",130,0)
 . S PAT("facility",+X)=$P(X,U,3)_U_$P(X,U,2)_U_LAST_U_$$GET1^DIQ(4,+X_",",60)
"RTN","VPRDPT",131,0)
 S I=0 F  S I=$O(VPRY(I)) Q:I<1  D
"RTN","VPRDPT",132,0)
 . S X=VPRY(I) Q:$P(X,U)=""  ;unknown
"RTN","VPRDPT",133,0)
 . S IEN=+$$IEN^XUAF4($P(X,U))
"RTN","VPRDPT",134,0)
 . I +X=776!(+X=200) S $P(X,U,2)="DEPT. OF DEFENSE"
"RTN","VPRDPT",135,0)
 . S PAT("facility",IEN)=$P(X,U,1,3) ;stn# ^ name ^ last date ^ VistA domain
"RTN","VPRDPT",136,0)
 . S $P(PAT("facility",IEN),U,4)=$$GET1^DIQ(4,IEN_",",60)
"RTN","VPRDPT",137,0)
 . I IEN=HOME S $P(PAT("facility",IEN),U,5)=1
"RTN","VPRDPT",138,0)
 Q
"RTN","VPRDPT",139,0)
 ;
"RTN","VPRDPT",140,0)
INPT ;-current inpt status data
"RTN","VPRDPT",141,0)
 N ADM,X
"RTN","VPRDPT",142,0)
 S ADM=+$G(^DPT(DFN,.105)) I ADM D
"RTN","VPRDPT",143,0)
 . N VAIN,VAERR,HLOC,SVC
"RTN","VPRDPT",144,0)
 . D INP^VADPT S PAT("admitted")=ADM_U_+VAIN(7)
"RTN","VPRDPT",145,0)
 . S PAT("ward")=VAIN(4),PAT("roomBed")=VAIN(5)
"RTN","VPRDPT",146,0)
 . S HLOC=+$G(^DIC(42,+VAIN(4),44)),SVC=$P($G(^(0)),U,3)
"RTN","VPRDPT",147,0)
 . S PAT("location")=HLOC_U_$P(VAIN(4),U,2)
"RTN","VPRDPT",148,0)
 . S:$L(SVC) PAT("locSvc")=SVC_U_$$EXTERNAL^DILFD(42,.03,,SVC)
"RTN","VPRDPT",149,0)
 . S PAT("specialty")=VAIN(3)
"RTN","VPRDPT",150,0)
 . S PAT("attending")=VAIN(11)
"RTN","VPRDPT",151,0)
 . S X=$$FAC^VPRD(HLOC),PAT("site")=X
"RTN","VPRDPT",152,0)
 S PAT("inpatient")=$S(ADM:"true",1:"false")
"RTN","VPRDPT",153,0)
 S X=$$OUTPTPR^SDUTL3(DFN) S:X PAT("pcProvider")=X
"RTN","VPRDPT",154,0)
 S X=$$OUTPTTM^SDUTL3(DFN) S:X PAT("pcTeam")=X
"RTN","VPRDPT",155,0)
 Q
"RTN","VPRDPT",156,0)
 ;
"RTN","VPRDPT",157,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPT",158,0)
 ;
"RTN","VPRDPT",159,0)
XML(ITEM) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPT",160,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPT",161,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPT",162,0)
 D ADD("<patient>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPT",163,0)
 S ATT="" F  S ATT=$O(ITEM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",164,0)
 . I ATT="exposures" D:X["1"  S Y="" Q
"RTN","VPRDPT",165,0)
 .. S I=0,Y="<exposures>" D ADD(Y)
"RTN","VPRDPT",166,0)
 .. F ID="AO","IR","PG","HNC","MST","CV" S I=I+1 I $P(X,U,I) S Y="<exposure value='"_ID_"' />" D ADD(Y)
"RTN","VPRDPT",167,0)
 .. D ADD("</exposures>")
"RTN","VPRDPT",168,0)
 . I $L($O(ITEM(ATT,""))) D  Q  ;multiples
"RTN","VPRDPT",169,0)
 .. S ID=$S($E(ATT,$L(ATT))="s":ATT_"es",$E(ATT,$L(ATT))="y":$E(ATT,1,$L(ATT)-1)_"ies",1:ATT_"s")
"RTN","VPRDPT",170,0)
 .. D ADD("<"_ID_">")
"RTN","VPRDPT",171,0)
 .. S I="" F  S I=$O(ITEM(ATT,I)) Q:I=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPT",172,0)
 ... S X=ITEM(ATT,I),Y="<"_ATT_" "
"RTN","VPRDPT",173,0)
 ... I ATT="support" D  S Y="" Q
"RTN","VPRDPT",174,0)
 .... S Y=Y_"contactType='"_I_"' name='"_$$ESC^VPRD($P(X,U))_$S($L($P(X,U,2)):"' relationship='"_$$ESC^VPRD($P(X,U,2)),1:"")_"' >" D ADD(Y)
"RTN","VPRDPT",175,0)
 .... S X=$G(ITEM(ATT,I,"address")) I $L(X) D ADDR(X)
"RTN","VPRDPT",176,0)
 .... S X=$G(ITEM(ATT,I,"telecom")) I $L(X) D PHONE(X)
"RTN","VPRDPT",177,0)
 .... D ADD("</support>")
"RTN","VPRDPT",178,0)
 ... I ATT="alias" S Y=Y_"fullName='"_$$ESC^VPRD(X)_$S(X[",":"' familyName='"_$$ESC^VPRD($P(X,","))_"' givenNames='"_$$ESC^VPRD($P(X,",",2,99)),1:"")_"' />" Q
"RTN","VPRDPT",179,0)
 ... I ATT="flag" S Y=Y_"name='"_$$ESC^VPRD($P(X,U))_"' text='"_$$ESC^VPRD($P(X,U,2))_"' />" Q
"RTN","VPRDPT",180,0)
 ... I ATT="facility" S Y=Y_"code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"'"_$S($P(X,U,3):" latestDate='"_$P($P(X,U,3),".")_"'",1:"")_$S($L($P(X,U,4))>0:" domain='"_$P(X,U,4)_"'",1:"")_$S($P(X,U,5):" homeSite='1'",1:"")_" />" Q
"RTN","VPRDPT",181,0)
 ... I ATT="disability" S Y=Y_"vaCode='"_I_"' printName='"_$$ESC^VPRD($P(X,U))_$S($P(X,U,3):"' sc='"_$P(X,U,3)_"' scPercent='"_$P(X,U,2),1:"")_"' />" Q
"RTN","VPRDPT",182,0)
 ... S Y=Y_"value='"_$$ESC^VPRD(ITEM(ATT,I))_"' />"
"RTN","VPRDPT",183,0)
 .. D ADD("</"_ID_">") S Y=""
"RTN","VPRDPT",184,0)
 . S X=$G(ITEM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPT",185,0)
 . I ATT="address" D ADDR(X) S Y="" Q
"RTN","VPRDPT",186,0)
 . I ATT="telecom" D PHONE(X) S Y="" Q
"RTN","VPRDPT",187,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPT",188,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPT",189,0)
 D ADD("</patient>")
"RTN","VPRDPT",190,0)
 Q
"RTN","VPRDPT",191,0)
 ;
"RTN","VPRDPT",192,0)
ADDR(X) ; -- XML address node from X=street1^st2^st3^city^state^zip
"RTN","VPRDPT",193,0)
 N I,Y Q:$L(X)'>5  ;no data
"RTN","VPRDPT",194,0)
 S Y="<address"
"RTN","VPRDPT",195,0)
 F I=1,2,3 I $L($P(X,U,I)) S Y=Y_" streetLine"_I_"='"_$$ESC^VPRD($P(X,U,I))_"'"
"RTN","VPRDPT",196,0)
 I $L($P(X,U,4)) S Y=Y_" city='"_$$ESC^VPRD($P(X,U,4))_"'"
"RTN","VPRDPT",197,0)
 I $L($P(X,U,5)) S Y=Y_" stateProvince='"_$P(X,U,5)_"'"
"RTN","VPRDPT",198,0)
 I $L($P(X,U,6)) S Y=Y_" postalCode='"_$P(X,U,6)_"'"
"RTN","VPRDPT",199,0)
 S Y=Y_" />" D ADD(Y)
"RTN","VPRDPT",200,0)
 Q
"RTN","VPRDPT",201,0)
 ;
"RTN","VPRDPT",202,0)
PHONE(X) ; -- XML telecom node from X=home^cell^work numbers
"RTN","VPRDPT",203,0)
 N I,Y Q:$L(X)'>2  ;no data
"RTN","VPRDPT",204,0)
 D ADD("<telecomList>")
"RTN","VPRDPT",205,0)
 I $L($P(X,U,1)) S Y="<telecom usageType='H' value='"_$P(X,U,1)_"' />" D ADD(Y)
"RTN","VPRDPT",206,0)
 I $L($P(X,U,2)) S Y="<telecom usageType='MC' value='"_$P(X,U,2)_"' />" D ADD(Y)
"RTN","VPRDPT",207,0)
 I $L($P(X,U,3)) S Y="<telecom usageType='WP' value='"_$P(X,U,3)_"' />" D ADD(Y)
"RTN","VPRDPT",208,0)
 D ADD("</telecomList>")
"RTN","VPRDPT",209,0)
 Q
"RTN","VPRDPT",210,0)
 ;
"RTN","VPRDPT",211,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPT",212,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPT",213,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPT",214,0)
 Q
"RTN","VPRDPXAM")
0^18^B9620825^n/a
"RTN","VPRDPXAM",1,0)
VPRDPXAM ;SLC/MKB -- PCE V Exams ;8/2/11  15:29
"RTN","VPRDPXAM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPXAM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXAM",4,0)
 ;
"RTN","VPRDPXAM",5,0)
 ; External References          DBIA#
"RTN","VPRDPXAM",6,0)
 ; -------------------          -----
"RTN","VPRDPXAM",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPXAM",8,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXAM",9,0)
 ; DILFD                         2055
"RTN","VPRDPXAM",10,0)
 ; PXPXRM                        4250
"RTN","VPRDPXAM",11,0)
 ; XUAF4                         2171
"RTN","VPRDPXAM",12,0)
 ;
"RTN","VPRDPXAM",13,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPXAM",14,0)
 ;
"RTN","VPRDPXAM",15,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's exams
"RTN","VPRDPXAM",16,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXAM",17,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPXAM",18,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXAM",19,0)
 ;
"RTN","VPRDPXAM",20,0)
 ; get one exam
"RTN","VPRDPXAM",21,0)
 I $G(IFN) D  Q
"RTN","VPRDPXAM",22,0)
 . N ITM,DATE K ^TMP("VPRPX",$J)
"RTN","VPRDPXAM",23,0)
 . S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.13,"PI",+$G(DFN),ITM)) Q:ITM<1  D  Q:$D(VPRITM)
"RTN","VPRDPXAM",24,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.13,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXAM",25,0)
 ... S VPRIDT=9999999-DATE,^TMP("VPRPX",$J,VPRIDT,IFN)=ITM_U_DATE
"RTN","VPRDPXAM",26,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXAM",27,0)
 ;
"RTN","VPRDPXAM",28,0)
 ; get all exams
"RTN","VPRDPXAM",29,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXAM",30,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRPX",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXAM",31,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRPX",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXAM",32,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXAM",33,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXAM",34,0)
 K ^TMP("VPRPX",$J)
"RTN","VPRDPXAM",35,0)
 Q
"RTN","VPRDPXAM",36,0)
 ;
"RTN","VPRDPXAM",37,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRPX",$J,9999999-DATE,DA)=ITM^DATE in range
"RTN","VPRDPXAM",38,0)
 ;  from ^PXRMINDX(9000010.13,"PI",DFN,ITM,DATE,DA)
"RTN","VPRDPXAM",39,0)
 N ITM,DATE,DA,IDT K ^TMP("VPRPX",$J)
"RTN","VPRDPXAM",40,0)
 S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.13,"PI",+$G(DFN),ITM)) Q:ITM<1  D
"RTN","VPRDPXAM",41,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.13,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  D
"RTN","VPRDPXAM",42,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXAM",43,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.13,"PI",+$G(DFN),ITM,DATE,DA)) Q:DA<1  S ^TMP("VPRPX",$J,IDT,DA)=ITM_U_DATE
"RTN","VPRDPXAM",44,0)
 Q
"RTN","VPRDPXAM",45,0)
 ;
"RTN","VPRDPXAM",46,0)
EN1(IEN,PCE) ; -- return an exam in PCE("attribute")=value
"RTN","VPRDPXAM",47,0)
 ;  from EN: expects ^TMP("VPRPX",$J,VPRIDT,IEN)=ITM^DATE
"RTN","VPRDPXAM",48,0)
 N VPRF,TMP,VISIT,X0,FAC,LOC,X K PCE
"RTN","VPRDPXAM",49,0)
 D VXAM^PXPXRM(IEN,.VPRF)
"RTN","VPRDPXAM",50,0)
 S PCE("id")=IEN,X=$G(VPRF("VALUE"))
"RTN","VPRDPXAM",51,0)
 S PCE("result")=$$EXTERNAL^DILFD(9000010.13,.04,,X)
"RTN","VPRDPXAM",52,0)
 S TMP=$G(^TMP("VPRPX",$J,VPRIDT,IEN)),PCE("dateTime")=$P(TMP,U,2)
"RTN","VPRDPXAM",53,0)
 S PCE("name")=$$EXTERNAL^DILFD(9000010.13,.01,,+TMP)
"RTN","VPRDPXAM",54,0)
 S PCE("comment")=$G(VPRF("COMMENTS"))
"RTN","VPRDPXAM",55,0)
 S VISIT=$G(VPRF("VISIT")),PCE("encounter")=VISIT
"RTN","VPRDPXAM",56,0)
 S X0=$G(^AUPNVSIT(+VISIT,0))
"RTN","VPRDPXAM",57,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXAM",58,0)
 S:FAC PCE("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXAM",59,0)
 S:'FAC PCE("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXAM",60,0)
 Q
"RTN","VPRDPXAM",61,0)
 ;
"RTN","VPRDPXAM",62,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXAM",63,0)
 ;
"RTN","VPRDPXAM",64,0)
XML(PCE) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPXAM",65,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPXAM",66,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPXAM",67,0)
 D ADD("<exam>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXAM",68,0)
 S ATT="" F  S ATT=$O(PCE(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXAM",69,0)
 . S X=$G(PCE(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXAM",70,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXAM",71,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPXAM",72,0)
 D ADD("</exam>")
"RTN","VPRDPXAM",73,0)
 Q
"RTN","VPRDPXAM",74,0)
 ;
"RTN","VPRDPXAM",75,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXAM",76,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXAM",77,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXAM",78,0)
 Q
"RTN","VPRDPXED")
0^19^B9831355^n/a
"RTN","VPRDPXED",1,0)
VPRDPXED ;SLC/MKB -- PCE V Patient Education ;8/2/11  15:29
"RTN","VPRDPXED",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPXED",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXED",4,0)
 ;
"RTN","VPRDPXED",5,0)
 ; External References          DBIA#
"RTN","VPRDPXED",6,0)
 ; -------------------          -----
"RTN","VPRDPXED",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPXED",8,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXED",9,0)
 ; DILFD                         2055
"RTN","VPRDPXED",10,0)
 ; PXPXRM                        4250
"RTN","VPRDPXED",11,0)
 ; XUAF4                         2171
"RTN","VPRDPXED",12,0)
 ;
"RTN","VPRDPXED",13,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPXED",14,0)
 ;
"RTN","VPRDPXED",15,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's education
"RTN","VPRDPXED",16,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXED",17,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPXED",18,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXED",19,0)
 ;
"RTN","VPRDPXED",20,0)
 ; get one item
"RTN","VPRDPXED",21,0)
 I $G(IFN) D  Q
"RTN","VPRDPXED",22,0)
 . N ITM,DATE K ^TMP("VPRPX",$J)
"RTN","VPRDPXED",23,0)
 . S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.16,"PI",+$G(DFN),ITM)) Q:ITM<1  D  Q:$D(VPRITM)
"RTN","VPRDPXED",24,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.16,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXED",25,0)
 ... S VPRIDT=9999999-DATE,^TMP("VPRPX",$J,VPRIDT,IFN)=ITM_U_DATE
"RTN","VPRDPXED",26,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXED",27,0)
 ;
"RTN","VPRDPXED",28,0)
 ; get all items
"RTN","VPRDPXED",29,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXED",30,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRPX",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXED",31,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRPX",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXED",32,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXED",33,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXED",34,0)
 K ^TMP("VPRPX",$J)
"RTN","VPRDPXED",35,0)
 Q
"RTN","VPRDPXED",36,0)
 ;
"RTN","VPRDPXED",37,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRPX",$J,9999999-DATE,DA)=ITM^DATE in range
"RTN","VPRDPXED",38,0)
 ;  from ^PXRMINDX(9000010.16,"PI",DFN,ITM,DATE,DA)
"RTN","VPRDPXED",39,0)
 N ITM,DATE,DA,IDT K ^TMP("VPRPX",$J)
"RTN","VPRDPXED",40,0)
 S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.16,"PI",+$G(DFN),ITM)) Q:ITM<1  D
"RTN","VPRDPXED",41,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.16,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  D
"RTN","VPRDPXED",42,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXED",43,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.16,"PI",+$G(DFN),ITM,DATE,DA)) Q:DA<1  S ^TMP("VPRPX",$J,IDT,DA)=ITM_U_DATE
"RTN","VPRDPXED",44,0)
 Q
"RTN","VPRDPXED",45,0)
 ;
"RTN","VPRDPXED",46,0)
EN1(IEN,PCE) ; -- return education in PCE("attribute")=value
"RTN","VPRDPXED",47,0)
 ;  from EN: expects ^TMP("VPRPX",$J,VPRIDT,IEN)=ITM^DATE
"RTN","VPRDPXED",48,0)
 N VPRF,TMP,VISIT,X0,FAC,LOC,X K PCE
"RTN","VPRDPXED",49,0)
 D VPEDU^PXPXRM(IEN,.VPRF)
"RTN","VPRDPXED",50,0)
 S PCE("id")=IEN,X=$G(VPRF("VALUE"))
"RTN","VPRDPXED",51,0)
 S PCE("result")=$$EXTERNAL^DILFD(9000010.16,.06,,X)
"RTN","VPRDPXED",52,0)
 S TMP=$G(^TMP("VPRPX",$J,VPRIDT,IEN)),PCE("dateTime")=$P(TMP,U,2)
"RTN","VPRDPXED",53,0)
 S PCE("name")=$$EXTERNAL^DILFD(9000010.16,.01,,+TMP)
"RTN","VPRDPXED",54,0)
 S PCE("comment")=$G(VPRF("COMMENTS"))
"RTN","VPRDPXED",55,0)
 S VISIT=$G(VPRF("VISIT")),PCE("encounter")=VISIT
"RTN","VPRDPXED",56,0)
 S X0=$G(^AUPNVSIT(+VISIT,0))
"RTN","VPRDPXED",57,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXED",58,0)
 S:FAC PCE("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXED",59,0)
 S:'FAC PCE("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXED",60,0)
 Q
"RTN","VPRDPXED",61,0)
 ;
"RTN","VPRDPXED",62,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXED",63,0)
 ;
"RTN","VPRDPXED",64,0)
XML(PCE) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPXED",65,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPXED",66,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPXED",67,0)
 D ADD("<educationTopic>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXED",68,0)
 S ATT="" F  S ATT=$O(PCE(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXED",69,0)
 . S X=$G(PCE(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXED",70,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXED",71,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPXED",72,0)
 D ADD("</educationTopic>")
"RTN","VPRDPXED",73,0)
 Q
"RTN","VPRDPXED",74,0)
 ;
"RTN","VPRDPXED",75,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXED",76,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXED",77,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXED",78,0)
 Q
"RTN","VPRDPXHF")
0^12^B10068928^B9504608
"RTN","VPRDPXHF",1,0)
VPRDPXHF ;SLC/MKB -- PCE Health Factors ;8/2/11  15:29
"RTN","VPRDPXHF",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPXHF",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXHF",4,0)
 ;
"RTN","VPRDPXHF",5,0)
 ; External References          DBIA#
"RTN","VPRDPXHF",6,0)
 ; -------------------          -----
"RTN","VPRDPXHF",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPXHF",8,0)
 ; ^AUTTHF                       4295
"RTN","VPRDPXHF",9,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXHF",10,0)
 ; DILFD                         2055
"RTN","VPRDPXHF",11,0)
 ; DIQ                           2056
"RTN","VPRDPXHF",12,0)
 ; PXPXRM                        4250
"RTN","VPRDPXHF",13,0)
 ; XUAF4                         2171
"RTN","VPRDPXHF",14,0)
 ;
"RTN","VPRDPXHF",15,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPXHF",16,0)
 ;
"RTN","VPRDPXHF",17,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's health factors
"RTN","VPRDPXHF",18,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXHF",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPXHF",20,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXHF",21,0)
 ;
"RTN","VPRDPXHF",22,0)
 ; get one health factor
"RTN","VPRDPXHF",23,0)
 I $G(IFN) D  Q
"RTN","VPRDPXHF",24,0)
 . N HF,DATE K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",25,0)
 . S HF=0 F  S HF=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF)) Q:HF<1  D  Q:$D(VPRITM)
"RTN","VPRDPXHF",26,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXHF",27,0)
 ... S VPRIDT=9999999-DATE,^TMP("VPRHF",$J,VPRIDT,IFN)=HF_U_DATE
"RTN","VPRDPXHF",28,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXHF",29,0)
 ;
"RTN","VPRDPXHF",30,0)
 ; get all health factors
"RTN","VPRDPXHF",31,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXHF",32,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRHF",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXHF",33,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRHF",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXHF",34,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXHF",35,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXHF",36,0)
 K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",37,0)
 Q
"RTN","VPRDPXHF",38,0)
 ;
"RTN","VPRDPXHF",39,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRHF",$J,9999999-DATE,DA)=HF^DATE in range
"RTN","VPRDPXHF",40,0)
 ;  from ^PXRMINDX(9000010.23,"PI",DFN,HF,DATE,DA)
"RTN","VPRDPXHF",41,0)
 N HF,DATE,DA,IDT K ^TMP("VPRHF",$J)
"RTN","VPRDPXHF",42,0)
 S HF=0 F  S HF=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF)) Q:HF<1  D
"RTN","VPRDPXHF",43,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE)) Q:DATE<1  D
"RTN","VPRDPXHF",44,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXHF",45,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.23,"PI",+$G(DFN),HF,DATE,DA)) Q:DA<1  S ^TMP("VPRHF",$J,IDT,DA)=HF_U_DATE
"RTN","VPRDPXHF",46,0)
 Q
"RTN","VPRDPXHF",47,0)
 ;
"RTN","VPRDPXHF",48,0)
EN1(IEN,HF) ; -- return a health factor in HF("attribute")=value
"RTN","VPRDPXHF",49,0)
 ;  from EN: expects ^TMP("VPRHF",$J,VPRIDT,IEN)=HF^DATE
"RTN","VPRDPXHF",50,0)
 N VPRF,TMP,VISIT,X0,FAC,LOC,X K HF
"RTN","VPRDPXHF",51,0)
 D VHF^PXPXRM(IEN,.VPRF)
"RTN","VPRDPXHF",52,0)
 S HF("id")=IEN,HF("severity")=$G(VPRF("VALUE"))
"RTN","VPRDPXHF",53,0)
 S TMP=$G(^TMP("VPRHF",$J,VPRIDT,IEN)),HF("recorded")=$P(TMP,U,2)
"RTN","VPRDPXHF",54,0)
 S HF("name")=$$EXTERNAL^DILFD(9000010.23,.01,,+TMP)
"RTN","VPRDPXHF",55,0)
 S HF("comment")=$G(VPRF("COMMENTS"))
"RTN","VPRDPXHF",56,0)
 S VISIT=$G(VPRF("VISIT")),HF("encounter")=VISIT
"RTN","VPRDPXHF",57,0)
 S X0=$G(^AUPNVSIT(+VISIT,0))
"RTN","VPRDPXHF",58,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXHF",59,0)
 S:FAC HF("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXHF",60,0)
 S:'FAC HF("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXHF",61,0)
 S X=$$GET1^DIQ(9999999.64,+TMP_",",.03,"I")
"RTN","VPRDPXHF",62,0)
 S:X HF("category")=X_U_$$GET1^DIQ(9999999.64,+TMP_",",.03)
"RTN","VPRDPXHF",63,0)
 Q
"RTN","VPRDPXHF",64,0)
 ;
"RTN","VPRDPXHF",65,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXHF",66,0)
 ;
"RTN","VPRDPXHF",67,0)
XML(HF) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPXHF",68,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPXHF",69,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPXHF",70,0)
 D ADD("<factor>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXHF",71,0)
 S ATT="" F  S ATT=$O(HF(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXHF",72,0)
 . S X=$G(HF(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXHF",73,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXHF",74,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPXHF",75,0)
 D ADD("</factor>")
"RTN","VPRDPXHF",76,0)
 Q
"RTN","VPRDPXHF",77,0)
 ;
"RTN","VPRDPXHF",78,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXHF",79,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXHF",80,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXHF",81,0)
 Q
"RTN","VPRDPXSK")
0^21^B9706647^n/a
"RTN","VPRDPXSK",1,0)
VPRDPXSK ;SLC/MKB -- PCE V Skin Tests ;8/2/11  15:29
"RTN","VPRDPXSK",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDPXSK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDPXSK",4,0)
 ;
"RTN","VPRDPXSK",5,0)
 ; External References          DBIA#
"RTN","VPRDPXSK",6,0)
 ; -------------------          -----
"RTN","VPRDPXSK",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDPXSK",8,0)
 ; ^PXRMINDX                     4290
"RTN","VPRDPXSK",9,0)
 ; DILFD                         2055
"RTN","VPRDPXSK",10,0)
 ; PXPXRM                        4250
"RTN","VPRDPXSK",11,0)
 ; XUAF4                         2171
"RTN","VPRDPXSK",12,0)
 ;
"RTN","VPRDPXSK",13,0)
 ; ------------ Get data from VistA ------------
"RTN","VPRDPXSK",14,0)
 ;
"RTN","VPRDPXSK",15,0)
EN(DFN,BEG,END,MAX,IFN) ; -- find a patient's skin tests
"RTN","VPRDPXSK",16,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","VPRDPXSK",17,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDPXSK",18,0)
 N VPRIDT,VPRN,VPRITM,VPRCNT
"RTN","VPRDPXSK",19,0)
 ;
"RTN","VPRDPXSK",20,0)
 ; get one skin test
"RTN","VPRDPXSK",21,0)
 I $G(IFN) D  Q
"RTN","VPRDPXSK",22,0)
 . N ITM,DATE K ^TMP("VPRPX",$J)
"RTN","VPRDPXSK",23,0)
 . S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.12,"PI",+$G(DFN),ITM)) Q:ITM<1  D  Q:$D(VPRITM)
"RTN","VPRDPXSK",24,0)
 .. S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.12,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  I $D(^(DATE,IFN)) D  Q
"RTN","VPRDPXSK",25,0)
 ... S VPRIDT=9999999-DATE,^TMP("VPRPX",$J,VPRIDT,IFN)=ITM_U_DATE
"RTN","VPRDPXSK",26,0)
 ... D EN1(IFN,.VPRITM),XML(.VPRITM)
"RTN","VPRDPXSK",27,0)
 ;
"RTN","VPRDPXSK",28,0)
 ; get all skin tests
"RTN","VPRDPXSK",29,0)
 D SORT(DFN,BEG,END) S VPRCNT=0
"RTN","VPRDPXSK",30,0)
 S VPRIDT=0 F  S VPRIDT=$O(^TMP("VPRPX",$J,VPRIDT)) Q:VPRIDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXSK",31,0)
 . S VPRN=0 F  S VPRN=$O(^TMP("VPRPX",$J,VPRIDT,VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDPXSK",32,0)
 .. K VPRITM D EN1(VPRN,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDPXSK",33,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDPXSK",34,0)
 K ^TMP("VPRPX",$J)
"RTN","VPRDPXSK",35,0)
 Q
"RTN","VPRDPXSK",36,0)
 ;
"RTN","VPRDPXSK",37,0)
SORT(DFN,START,STOP) ; -- build ^TMP("VPRPX",$J,9999999-DATE,DA)=ITM^DATE in range
"RTN","VPRDPXSK",38,0)
 ;  from ^PXRMINDX(9000010.12,"PI",DFN,ITM,DATE,DA)
"RTN","VPRDPXSK",39,0)
 N ITM,DATE,DA,IDT K ^TMP("VPRPX",$J)
"RTN","VPRDPXSK",40,0)
 S ITM=0 F  S ITM=$O(^PXRMINDX(9000010.12,"PI",+$G(DFN),ITM)) Q:ITM<1  D
"RTN","VPRDPXSK",41,0)
 . S DATE=0 F  S DATE=$O(^PXRMINDX(9000010.12,"PI",+$G(DFN),ITM,DATE)) Q:DATE<1  D
"RTN","VPRDPXSK",42,0)
 .. Q:DATE<START  Q:DATE>STOP  S IDT=9999999-DATE
"RTN","VPRDPXSK",43,0)
 .. S DA=0 F  S DA=$O(^PXRMINDX(9000010.12,"PI",+$G(DFN),ITM,DATE,DA)) Q:DA<1  S ^TMP("VPRPX",$J,IDT,DA)=ITM_U_DATE
"RTN","VPRDPXSK",44,0)
 Q
"RTN","VPRDPXSK",45,0)
 ;
"RTN","VPRDPXSK",46,0)
EN1(IEN,PCE) ; -- return a skin test in PCE("attribute")=value
"RTN","VPRDPXSK",47,0)
 ;  from EN: expects ^TMP("VPRPX",$J,VPRIDT,IEN)=ITM^DATE
"RTN","VPRDPXSK",48,0)
 N VPRF,TMP,VISIT,X0,FAC,LOC,X K PCE
"RTN","VPRDPXSK",49,0)
 D VSKIN^PXPXRM(IEN,.VPRF)
"RTN","VPRDPXSK",50,0)
 S PCE("id")=IEN,X=$G(VPRF("VALUE"))
"RTN","VPRDPXSK",51,0)
 S PCE("result")=$$EXTERNAL^DILFD(9000010.12,.04,,X)
"RTN","VPRDPXSK",52,0)
 S TMP=$G(^TMP("VPRPX",$J,VPRIDT,IEN)),PCE("dateTime")=$P(TMP,U,2)
"RTN","VPRDPXSK",53,0)
 S PCE("name")=$$EXTERNAL^DILFD(9000010.12,.01,,+TMP)
"RTN","VPRDPXSK",54,0)
 S PCE("comment")=$G(VPRF("COMMENTS"))
"RTN","VPRDPXSK",55,0)
 S VISIT=$G(VPRF("VISIT")),PCE("encounter")=VISIT
"RTN","VPRDPXSK",56,0)
 S X0=$G(^AUPNVSIT(+VISIT,0))
"RTN","VPRDPXSK",57,0)
 S FAC=+$P(X0,U,6),LOC=+$P(X0,U,22)
"RTN","VPRDPXSK",58,0)
 S:FAC PCE("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDPXSK",59,0)
 S:'FAC PCE("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDPXSK",60,0)
 Q
"RTN","VPRDPXSK",61,0)
 ;
"RTN","VPRDPXSK",62,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDPXSK",63,0)
 ;
"RTN","VPRDPXSK",64,0)
XML(PCE) ; -- Return patient data as XML in @VPR@(n)
"RTN","VPRDPXSK",65,0)
 ; as <element code='123' displayName='ABC' />
"RTN","VPRDPXSK",66,0)
 N ATT,X,Y,I,ID
"RTN","VPRDPXSK",67,0)
 D ADD("<skinTest>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDPXSK",68,0)
 S ATT="" F  S ATT=$O(PCE(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDPXSK",69,0)
 . S X=$G(PCE(ATT)),Y="" Q:'$L(X)
"RTN","VPRDPXSK",70,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDPXSK",71,0)
 . S Y="<"_ATT_" code='"_$P(X,U)_"' name='"_$$ESC^VPRD($P(X,U,2))_"' />"
"RTN","VPRDPXSK",72,0)
 D ADD("</skinTest>")
"RTN","VPRDPXSK",73,0)
 Q
"RTN","VPRDPXSK",74,0)
 ;
"RTN","VPRDPXSK",75,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDPXSK",76,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDPXSK",77,0)
 S @VPR@(VPRI)=X
"RTN","VPRDPXSK",78,0)
 Q
"RTN","VPRDRA")
0^25^B41770325^B39795192
"RTN","VPRDRA",1,0)
VPRDRA ;SLC/MKB -- Radiology extract ;8/2/11  15:29
"RTN","VPRDRA",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDRA",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDRA",4,0)
 ;
"RTN","VPRDRA",5,0)
 ; External References          DBIA#
"RTN","VPRDRA",6,0)
 ; -------------------          -----
"RTN","VPRDRA",7,0)
 ; ^RADPT                        2480
"RTN","VPRDRA",8,0)
 ; ^RARPT                        5605
"RTN","VPRDRA",9,0)
 ; ^SC(                         10040
"RTN","VPRDRA",10,0)
 ; ^VA(200                      10060
"RTN","VPRDRA",11,0)
 ; DIQ                           2056
"RTN","VPRDRA",12,0)
 ; ICPTCOD                       1995
"RTN","VPRDRA",13,0)
 ; RAO7PC1                  2043,2265
"RTN","VPRDRA",14,0)
 ; RAO7PC3                       2877
"RTN","VPRDRA",15,0)
 ;
"RTN","VPRDRA",16,0)
 ; ------------ Get exam(s) from VistA ------------
"RTN","VPRDRA",17,0)
 ;
"RTN","VPRDRA",18,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's radiology exams
"RTN","VPRDRA",19,0)
 N VPRITM,VPRXID
"RTN","VPRDRA",20,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",21,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",22,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",23,0)
 ;
"RTN","VPRDRA",24,0)
 ; get exam(s)
"RTN","VPRDRA",25,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDRA",26,0)
 ;
"RTN","VPRDRA",27,0)
 ; get all exams
"RTN","VPRDRA",28,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",29,0)
 . K VPRITM D EN1(VPRXID,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDRA",30,0)
 . D XML(.VPRITM)
"RTN","VPRDRA",31,0)
ENQ ; end
"RTN","VPRDRA",32,0)
 K ^TMP($J,"RAE1"),^TMP("VPRTEXT",$J)
"RTN","VPRDRA",33,0)
 Q
"RTN","VPRDRA",34,0)
 ;
"RTN","VPRDRA",35,0)
EN1(ID,EXAM) ; -- return an exam in EXAM("attribute")=value
"RTN","VPRDRA",36,0)
 ;   Expects ^TMP($J,"RAE1",DFN,ID) from EN1^RAO7PC1
"RTN","VPRDRA",37,0)
 N X0,SET,PROC,DATE,LOC,X,Y,IENS
"RTN","VPRDRA",38,0)
 K EXAM,^TMP("VPRTEXT",$J)
"RTN","VPRDRA",39,0)
 S X0=$G(^TMP($J,"RAE1",DFN,ID)),SET=$G(^(ID,"CPRS")),PROC=$P(X0,U)
"RTN","VPRDRA",40,0)
 S EXAM("id")=ID,EXAM("name")=PROC,EXAM("case")=$P(X0,U,2)
"RTN","VPRDRA",41,0)
 S DATE=9999999.9999-+ID,EXAM("dateTime")=DATE
"RTN","VPRDRA",42,0)
 I $P(X0,U,5) D  ;report exists
"RTN","VPRDRA",43,0)
 . N NM S NM=$S(+SET=2:$P(SET,U,2),1:PROC)     ;2 = shared report
"RTN","VPRDRA",44,0)
 . S EXAM("document",1)=ID_U_NM_"^^"_$P(X0,U,3) ;id^localTitle^^status
"RTN","VPRDRA",45,0)
 . S:$G(VPRTEXT) EXAM("document",1,"content")=$$TEXT(DFN,ID)
"RTN","VPRDRA",46,0)
 S:$L($P(X0,U,6)) EXAM("status")=$P($P(X0,U,6),"~",2)
"RTN","VPRDRA",47,0)
 S X=$P(X0,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",48,0)
 . S LOC=+$O(^SC("B",X,0)),EXAM("location")=LOC_U_X
"RTN","VPRDRA",49,0)
 S EXAM("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",50,0)
 I $L($P(X0,U,8)) S X=$TR($P(X0,U,8),"~","^"),EXAM("imagingType")=X
"RTN","VPRDRA",51,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",52,0)
 S X=$P(X0,U,10) I X D
"RTN","VPRDRA",53,0)
 . S EXAM("type")=$$CPT(X)
"RTN","VPRDRA",54,0)
 . I $D(^TMP($J,"RAE1",DFN,ID,"CMOD")) M EXAM("modifier")=^("CMOD")
"RTN","VPRDRA",55,0)
 I $P(X0,U,11) S EXAM("order")=+$P(X0,U,11)_U_$S($L(SET):$P(SET,U,2),1:PROC)
"RTN","VPRDRA",56,0)
 S EXAM("hasImages")=$S($P(X0,U,12)="Y":1,1:0)
"RTN","VPRDRA",57,0)
 I $P(X0,U,4)="Y"!($P(X0,U,9)="Y") S EXAM("interpretation")="ABNORMAL"
"RTN","VPRDRA",58,0)
 S EXAM("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",59,0)
 S ID=DFN_U_$TR(ID,"-","^") D EN3^RAO7PC1(ID) D  ;get additional values
"RTN","VPRDRA",60,0)
 . S X=+$G(^TMP($J,"RAE2",DFN,+$P(ID,U,3),PROC,"P"))
"RTN","VPRDRA",61,0)
 . I X S EXAM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDRA",62,0)
 S EXAM("category")="RA"
"RTN","VPRDRA",63,0)
 Q
"RTN","VPRDRA",64,0)
 ;
"RTN","VPRDRA",65,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDRA",66,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDRA",67,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDRA",68,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDRA",69,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDRA",70,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDRA",71,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDRA",72,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDRA",73,0)
 . S $P(Y,U,2)=X
"RTN","VPRDRA",74,0)
 Q Y
"RTN","VPRDRA",75,0)
 ;
"RTN","VPRDRA",76,0)
TEXT(PAT,ID) ; -- Get report text, return temp array name
"RTN","VPRDRA",77,0)
 S PAT=+$G(PAT),ID=$G(ID) I PAT<1!(ID<1) Q ""
"RTN","VPRDRA",78,0)
 N DFN,EXAM,CASE,PROC,I,X,Y
"RTN","VPRDRA",79,0)
 S EXAM=PAT_U_$TR(ID,"-","^") D EN3^RAO7PC3(EXAM)
"RTN","VPRDRA",80,0)
 S Y=$NA(^TMP("VPRTEXT",$J,ID)) K @Y
"RTN","VPRDRA",81,0)
 S CASE=$O(^TMP($J,"RAE3",PAT,0)),PROC=$O(^(CASE,""))
"RTN","VPRDRA",82,0)
 S I=0 F  S I=$O(^TMP($J,"RAE3",PAT,CASE,PROC,I)) Q:I<1  S X=^(I),@Y@(I)=X
"RTN","VPRDRA",83,0)
 K ^TMP($J,"RAE3",PAT)
"RTN","VPRDRA",84,0)
 Q Y
"RTN","VPRDRA",85,0)
 ;
"RTN","VPRDRA",86,0)
 ; ------------ Get report(s) [via VPRDTIU] ------------
"RTN","VPRDRA",87,0)
 ;
"RTN","VPRDRA",88,0)
RPTS(DFN,BEG,END,MAX) ; -- find patient's radiology reports
"RTN","VPRDRA",89,0)
 N VPRITM,VPRXID,STS,PSET
"RTN","VPRDRA",90,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDRA",91,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)_"P"
"RTN","VPRDRA",92,0)
 K ^TMP($J,"RAE1") D EN1^RAO7PC1(DFN,BEG,END,MAX)
"RTN","VPRDRA",93,0)
 S VPRXID="" F  S VPRXID=$O(^TMP($J,"RAE1",DFN,VPRXID)) Q:VPRXID=""  D
"RTN","VPRDRA",94,0)
 . S STS=$P($G(^TMP($J,"RAE1",DFN,VPRXID)),U,3),PSET=$G(^(VPRXID,"CPRS"))
"RTN","VPRDRA",95,0)
 . Q:STS="No Report"!(STS="Deleted")  ;!(STS["Draft") ??
"RTN","VPRDRA",96,0)
 . I +PSET=2,$G(PSET(+VPRXID,$P(PSET,U,2))) Q  ;already have report
"RTN","VPRDRA",97,0)
 . K VPRITM D RPT1(DFN,VPRXID,.VPRITM) D:$D(VPRITM) XML^VPRDTIU(.VPRITM)
"RTN","VPRDRA",98,0)
 . I +PSET=2 S PSET(+VPRXID,$P(PSET,U,2))=$P(VPRXID,"-",2) ;parent
"RTN","VPRDRA",99,0)
 K ^TMP($J,"RAE1"),^TMP("VPRTEXT",$J)
"RTN","VPRDRA",100,0)
 Q
"RTN","VPRDRA",101,0)
 ;
"RTN","VPRDRA",102,0)
RPT1(DFN,ID,RPT) ; -- return report as a TIU document
"RTN","VPRDRA",103,0)
 S DFN=+$G(DFN),ID=$G(ID) Q:DFN<1  Q:ID<1
"RTN","VPRDRA",104,0)
 N EXAM,CASE,PROC,RAE3,RAE1,I,X,Y,IENS,LOC
"RTN","VPRDRA",105,0)
 K RPT,^TMP("VPRTEXT",$J)
"RTN","VPRDRA",106,0)
 S EXAM=DFN_U_$TR(ID,"-","^") D
"RTN","VPRDRA",107,0)
 . N DFN D EN3^RAO7PC3(EXAM) ;report
"RTN","VPRDRA",108,0)
 . D EN3^RAO7PC1(EXAM)       ;add'l values
"RTN","VPRDRA",109,0)
 S CASE=$O(^TMP($J,"RAE3",DFN,0)),PROC=$O(^(CASE,"")),RAE3=$G(^(PROC))
"RTN","VPRDRA",110,0)
 S RAE1=$G(^TMP($J,"RAE1",DFN,ID))
"RTN","VPRDRA",111,0)
 I $G(VPRTEXT) D
"RTN","VPRDRA",112,0)
 . S Y=$NA(^TMP("VPRTEXT",$J,ID))
"RTN","VPRDRA",113,0)
 . S I=0 F  S I=$O(^TMP($J,"RAE3",DFN,CASE,PROC,I)) Q:I<1  S X=^(I),@Y@(I)=X
"RTN","VPRDRA",114,0)
 . S RPT("content")=Y
"RTN","VPRDRA",115,0)
 S RPT("id")=ID,RPT("status")=$P(RAE3,U)
"RTN","VPRDRA",116,0)
 S X=9999999.9999-(+ID),RPT("referenceDateTime")=X
"RTN","VPRDRA",117,0)
 S X=+$G(^TMP($J,"RAE2",DFN,CASE,PROC,"P"))
"RTN","VPRDRA",118,0)
 I X S RPT("clinician",1)=X_U_$P($G(^VA(200,X,0)),U)_"^A"
"RTN","VPRDRA",119,0)
 S X=$G(^TMP($J,"RAE2",DFN,CASE,PROC,"V")) I X D
"RTN","VPRDRA",120,0)
 . N Y S Y=$$GET1^DIQ(74,+$P(RAE1,U,5)_",",7,"I")
"RTN","VPRDRA",121,0)
 . S RPT("clinician",2)=+X_U_$P($G(^VA(200,+X,0)),U)_"^S^"_Y_U_$P(X,U,2)
"RTN","VPRDRA",122,0)
 I $D(^TMP($J,"RAE3",DFN,"PRINT_SET")) S PROC=$G(^("ORD")) ;use parent, if printset
"RTN","VPRDRA",123,0)
 S RPT("localTitle")=PROC,RPT("category")="RA"
"RTN","VPRDRA",124,0)
 S RPT("nationalTitle")="4695068^RADIOLOGY REPORT"
"RTN","VPRDRA",125,0)
 S RPT("nationalTitleSubject")="4693357^RADIOLOGY"
"RTN","VPRDRA",126,0)
 S RPT("nationalTitleType")="4696123^REPORT"
"RTN","VPRDRA",127,0)
 S X=$P(RAE1,U,7),LOC="" I $L(X) D
"RTN","VPRDRA",128,0)
 . S LOC=+$O(^SC("B",X,0)) ;,EXAM("location")=LOC_U_X
"RTN","VPRDRA",129,0)
 S RPT("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDRA",130,0)
 S IENS=$P(ID,"-",2)_","_+ID_","_DFN_","
"RTN","VPRDRA",131,0)
 S RPT("encounter")=$$GET1^DIQ(70.03,IENS,27,"I")
"RTN","VPRDRA",132,0)
 S:$G(FILTER("loinc")) RPT("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDRA",133,0)
 K ^TMP($J,"RAE3",DFN),^TMP($J,"RAE2",DFN)
"RTN","VPRDRA",134,0)
 Q
"RTN","VPRDRA",135,0)
 ;
"RTN","VPRDRA",136,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDRA",137,0)
 ;
"RTN","VPRDRA",138,0)
XML(EXAM) ; -- Return exams as XML
"RTN","VPRDRA",139,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDRA",140,0)
 D ADD("<radiology>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDRA",141,0)
 S ATT="" F  S ATT=$O(EXAM(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDRA",142,0)
 . S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^status^Z",1:"code^name^Z")
"RTN","VPRDRA",143,0)
 . I $O(EXAM(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDRA",144,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDRA",145,0)
 .. S I=0 F  S I=$O(EXAM(ATT,I)) Q:I<1  D
"RTN","VPRDRA",146,0)
 ... S X=$G(EXAM(ATT,I))
"RTN","VPRDRA",147,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDRA",148,0)
 ... S X=$G(EXAM(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDRA",149,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDRA",150,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDRA",151,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDRA",152,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDRA",153,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDRA",154,0)
 . S X=$G(EXAM(ATT)),Y="" Q:'$L(X)
"RTN","VPRDRA",155,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDRA",156,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDRA",157,0)
 D ADD("</radiology>")
"RTN","VPRDRA",158,0)
 Q
"RTN","VPRDRA",159,0)
 ;
"RTN","VPRDRA",160,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDRA",161,0)
 N STR,P,TAG S STR=""
"RTN","VPRDRA",162,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDRA",163,0)
 Q STR
"RTN","VPRDRA",164,0)
 ;
"RTN","VPRDRA",165,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDRA",166,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDRA",167,0)
 S @VPR@(VPRI)=X
"RTN","VPRDRA",168,0)
 Q
"RTN","VPRDSDAM")
0^13^B20114385^B9762566
"RTN","VPRDSDAM",1,0)
VPRDSDAM ;SLC/MKB -- Appointment extract ;8/2/11  15:29
"RTN","VPRDSDAM",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDSDAM",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSDAM",4,0)
 ;
"RTN","VPRDSDAM",5,0)
 ; External References          DBIA#
"RTN","VPRDSDAM",6,0)
 ; -------------------          -----
"RTN","VPRDSDAM",7,0)
 ; ^DGS(41.1                     3796
"RTN","VPRDSDAM",8,0)
 ; ^DIC(42                      10039
"RTN","VPRDSDAM",9,0)
 ; ^SC                          10040
"RTN","VPRDSDAM",10,0)
 ; ^VA(200                      10060
"RTN","VPRDSDAM",11,0)
 ; DIQ                           2056
"RTN","VPRDSDAM",12,0)
 ; SDAMA301                      4433
"RTN","VPRDSDAM",13,0)
 ;
"RTN","VPRDSDAM",14,0)
 ; ------------ Get appointment(s) from VistA ------------
"RTN","VPRDSDAM",15,0)
 ;
"RTN","VPRDSDAM",16,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's [future] appointments
"RTN","VPRDSDAM",17,0)
 N VPRX,VPRNUM,VPRDT,VPRCNT,VPRITM,VPRA,X
"RTN","VPRDSDAM",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSDAM",19,0)
 S BEG=$G(BEG,DT),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSDAM",20,0)
 S VPRX(1)=BEG_";"_END,VPRX(4)=DFN,VPRX("FLDS")="1;2;3;10;13",VPRX("SORT")="P"
"RTN","VPRDSDAM",21,0)
 ;
"RTN","VPRDSDAM",22,0)
 ; get one appt
"RTN","VPRDSDAM",23,0)
 I $L($G(ID)) D  Q
"RTN","VPRDSDAM",24,0)
 . S (BEG,END)=$P(ID,";",2),VPRX(1)=BEG_";"_END,VPRX(2)=$P(ID,";",3)
"RTN","VPRDSDAM",25,0)
 . S VPRNUM=$$SDAPI^SDAMA301(.VPRX) Q:VPRNUM<1
"RTN","VPRDSDAM",26,0)
 . D EN1(BEG,.VPRITM),XML(.VPRITM)
"RTN","VPRDSDAM",27,0)
 . K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",28,0)
 ;
"RTN","VPRDSDAM",29,0)
 ; get all [future] appointments
"RTN","VPRDSDAM",30,0)
 S VPRX(3)="R;I;NS;NSR;NT" ;no cancelled appt's
"RTN","VPRDSDAM",31,0)
 S VPRNUM=$$SDAPI^SDAMA301(.VPRX),(VPRDT,VPRCNT)=0
"RTN","VPRDSDAM",32,0)
 F  S VPRDT=$O(^TMP($J,"SDAMA301",DFN,VPRDT)) Q:VPRDT<1  D  Q:VPRCNT'<MAX
"RTN","VPRDSDAM",33,0)
 . S X=$P($G(^TMP($J,"SDAMA301",DFN,VPRDT)),U,3)
"RTN","VPRDSDAM",34,0)
 . I VPRDT<DT,$P(X,";")'["NS" Q   ;no prior kept appt's
"RTN","VPRDSDAM",35,0)
 . K VPRITM D EN1(VPRDT,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDSDAM",36,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDSDAM",37,0)
 K ^TMP($J,"SDAMA301",DFN)
"RTN","VPRDSDAM",38,0)
 ;
"RTN","VPRDSDAM",39,0)
 ; get scheduled admissions
"RTN","VPRDSDAM",40,0)
 S VPRA=0 F  S VPRA=$O(^DGS(41.1,"B",DFN,VPRA)) Q:VPRA<1  D  Q:VPRCNT'<MAX
"RTN","VPRDSDAM",41,0)
 . S VPRX=$G(^DGS(41.1,VPRA,0))
"RTN","VPRDSDAM",42,0)
 . Q:$P(VPRX,U,13)  Q:$P(VPRX,U,17)  ;cancelled or admitted
"RTN","VPRDSDAM",43,0)
 . S X=$P(VPRX,U,2) Q:X<BEG!(X>END)  ;out of date range
"RTN","VPRDSDAM",44,0)
 . K VPRITM D DGS(VPRA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDSDAM",45,0)
 . D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDSDAM",46,0)
 Q
"RTN","VPRDSDAM",47,0)
 ;
"RTN","VPRDSDAM",48,0)
EN1(DATE,APPT) ; -- return an appointment in APPT("attribute")=value
"RTN","VPRDSDAM",49,0)
 ;  Expects ^TMP($J,"SDAMA301",DFN,DATE)
"RTN","VPRDSDAM",50,0)
 N X,HLOC,STS,CLS,SV,PRV K APPT
"RTN","VPRDSDAM",51,0)
 S X=$G(^TMP($J,"SDAMA301",DFN,DATE))
"RTN","VPRDSDAM",52,0)
 S DATE=+$G(DATE),HLOC=$P(X,U,2),APPT("type")=$TR($P(X,U,10),";","^")
"RTN","VPRDSDAM",53,0)
 S STS=$P(X,U,3),CLS=$S($E(STS)="I":"I",1:"O")
"RTN","VPRDSDAM",54,0)
 S APPT("id")="A;"_DATE_";"_+HLOC,APPT("dateTime")=DATE I HLOC D
"RTN","VPRDSDAM",55,0)
 . S APPT("location")=$P(HLOC,";",2)
"RTN","VPRDSDAM",56,0)
 . S APPT("clinicStop")=$$AMIS^VPRDVSIT(+$P(X,U,13))
"RTN","VPRDSDAM",57,0)
 . S SV=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDSDAM",58,0)
 . I SV S APPT("service")=$$SERV(SV)
"RTN","VPRDSDAM",59,0)
 . ;find default provider
"RTN","VPRDSDAM",60,0)
 . S PRV=+$$GET1^DIQ(44,+HLOC_",",16,"I") I 'PRV D
"RTN","VPRDSDAM",61,0)
 .. N VPRP,I,FIRST
"RTN","VPRDSDAM",62,0)
 .. D GETS^DIQ(44,+HLOC_",","2600*","I","VPRP")
"RTN","VPRDSDAM",63,0)
 .. S FIRST=$O(VPRP(44.1,"")),I=""
"RTN","VPRDSDAM",64,0)
 .. F  S I=$O(VPRP(44.1,I)) Q:I=""  I $G(VPRP(44.1,I,.02,"I")) S PRV=$G(VPRP(44.1,I,.01,"I")) Q
"RTN","VPRDSDAM",65,0)
 .. I 'PRV,FIRST S PRV=$G(VPRP(44.1,FIRST,.01,"I"))
"RTN","VPRDSDAM",66,0)
 . I PRV S APPT("provider")=PRV_U_$P($G(^VA(200,PRV,0)),U) Q
"RTN","VPRDSDAM",67,0)
 S APPT("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDSDAM",68,0)
 S APPT("patientClass")=$S(CLS="I":"IMP",1:"AMB")
"RTN","VPRDSDAM",69,0)
 S APPT("serviceCategory")=$S(CLS="I":"I^INPATIENT VISIT",1:"A^AMBULATORY")
"RTN","VPRDSDAM",70,0)
 S APPT("apptStatus")=$P(STS,";",2)
"RTN","VPRDSDAM",71,0)
 S APPT("visitString")=+HLOC_";"_DATE_";A"
"RTN","VPRDSDAM",72,0)
 Q
"RTN","VPRDSDAM",73,0)
 ;
"RTN","VPRDSDAM",74,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDSDAM",75,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDSDAM",76,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDSDAM",77,0)
 Q Y
"RTN","VPRDSDAM",78,0)
 ;
"RTN","VPRDSDAM",79,0)
DGS(IFN,ADM) ; -- return a scheduled admission in ADM("attribute")=value
"RTN","VPRDSDAM",80,0)
 N X0,DATE,HLOC,SV,X K ADM
"RTN","VPRDSDAM",81,0)
 S X0=$G(^DGS(41.1,+$G(IFN),0)) Q:X0=""  ;deleted
"RTN","VPRDSDAM",82,0)
 S DATE=+$P(X0,U,2),HLOC=+$G(^DIC(42,+$P(X0,U,8),44))
"RTN","VPRDSDAM",83,0)
 S ADM("id")="H;"_DATE,ADM("dateTime")=DATE I HLOC D
"RTN","VPRDSDAM",84,0)
 . S ADM("id")=ADM("id")_";"_HLOC,ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDSDAM",85,0)
 . S ADM("location")=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDSDAM",86,0)
 . S X=$$GET1^DIQ(44,HLOC_",",8,"I"),ADM("clinicStop")=$$AMIS^VPRDVSIT(X)
"RTN","VPRDSDAM",87,0)
 . S SV=$$GET1^DIQ(44,HLOC_",",9.5,"I")
"RTN","VPRDSDAM",88,0)
 . I SV S ADM("service")=$$SERV(SV)
"RTN","VPRDSDAM",89,0)
 S ADM("facility")=$$FAC^VPRD(HLOC)
"RTN","VPRDSDAM",90,0)
 S X=$P(X0,U,5) I X S ADM("provider")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","VPRDSDAM",91,0)
 S ADM("patientClass")="IMP",ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDSDAM",92,0)
 S ADM("apptStatus")=$S($P(X0,U,17):"ADMITTED",$P(X0,U,13):"CANCELLED",1:"SCHEDULED")
"RTN","VPRDSDAM",93,0)
 Q
"RTN","VPRDSDAM",94,0)
 ;
"RTN","VPRDSDAM",95,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSDAM",96,0)
 ;
"RTN","VPRDSDAM",97,0)
XML(APPT) ; -- Return appointment as XML
"RTN","VPRDSDAM",98,0)
 N ATT,X,Y,NAMES
"RTN","VPRDSDAM",99,0)
 D ADD("<appointment>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSDAM",100,0)
 S ATT="" F  S ATT=$O(APPT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSDAM",101,0)
 . S X=$G(APPT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSDAM",102,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSDAM",103,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSDAM",104,0)
 D ADD("</appointment>")
"RTN","VPRDSDAM",105,0)
 Q
"RTN","VPRDSDAM",106,0)
 ;
"RTN","VPRDSDAM",107,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSDAM",108,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSDAM",109,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSDAM",110,0)
 Q STR
"RTN","VPRDSDAM",111,0)
 ;
"RTN","VPRDSDAM",112,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSDAM",113,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSDAM",114,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSDAM",115,0)
 Q
"RTN","VPRDSR")
0^26^B30371946^B29738621
"RTN","VPRDSR",1,0)
VPRDSR ;SLC/MKB -- Surgical Procedures ;8/2/11  15:29
"RTN","VPRDSR",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDSR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDSR",4,0)
 ;
"RTN","VPRDSR",5,0)
 ; External References          DBIA#
"RTN","VPRDSR",6,0)
 ; -------------------          -----
"RTN","VPRDSR",7,0)
 ; ^SRF(130                      5675
"RTN","VPRDSR",8,0)
 ; ^SRO(136                      4872
"RTN","VPRDSR",9,0)
 ; DIQ                           2056
"RTN","VPRDSR",10,0)
 ; ICPTCOD                       1995
"RTN","VPRDSR",11,0)
 ; ICPTMOD                       1996
"RTN","VPRDSR",12,0)
 ; SROESTV                       3533
"RTN","VPRDSR",13,0)
 ;
"RTN","VPRDSR",14,0)
 ; ------------ Get surgery(ies) from VistA ------------
"RTN","VPRDSR",15,0)
 ;
"RTN","VPRDSR",16,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's surgeries
"RTN","VPRDSR",17,0)
 N VPRN,VPRCNT,VPRITM,VPRY
"RTN","VPRDSR",18,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDSR",19,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDSR",20,0)
 ;
"RTN","VPRDSR",21,0)
 ; get one surgery
"RTN","VPRDSR",22,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDSR",23,0)
 ;
"RTN","VPRDSR",24,0)
 ; get all surgeries
"RTN","VPRDSR",25,0)
 Q:'$L($T(LIST^SROESTV))
"RTN","VPRDSR",26,0)
 N SHOWADD S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",27,0)
 D LIST^SROESTV(.VPRY,DFN,BEG,END,MAX,1)
"RTN","VPRDSR",28,0)
 S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D
"RTN","VPRDSR",29,0)
 . K VPRITM D ONE(VPRN,.VPRITM)
"RTN","VPRDSR",30,0)
 . I $D(VPRITM) D XML(.VPRITM)
"RTN","VPRDSR",31,0)
 K @VPRY
"RTN","VPRDSR",32,0)
ENQ ; end
"RTN","VPRDSR",33,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDSR",34,0)
 Q
"RTN","VPRDSR",35,0)
 ;
"RTN","VPRDSR",36,0)
ONE(NUM,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",37,0)
 ;  Expects DFN, @VPRY@(NUM) from LIST^SROESTV
"RTN","VPRDSR",38,0)
 N IEN,VPRX,X,Y,I,VPRMOD,VPROTH
"RTN","VPRDSR",39,0)
 K SURG,^TMP("VPRTEXT",$J)
"RTN","VPRDSR",40,0)
 S VPRX=$G(@VPRY@(NUM)),IEN=+$P(VPRX,U) Q:IEN<1
"RTN","VPRDSR",41,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",42,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",43,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",44,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")
"RTN","VPRDSR",45,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",46,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",47,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",48,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",49,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",50,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",51,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",52,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",53,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",54,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",55,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",56,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",57,0)
 S I=0 F  S I=$O(@VPRY@(NUM,I)) Q:I<1  S X=$G(@VPRY@(NUM,I)) I X D
"RTN","VPRDSR",58,0)
 . N LT,NT S LT=$P(X,U,2) Q:$P(LT," ")="Addendum"
"RTN","VPRDSR",59,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501")
"RTN","VPRDSR",60,0)
 . S SURG("document",I)=+X_U_LT_U_NT
"RTN","VPRDSR",61,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",62,0)
 . I LT["OPERATION REPORT"!(LT["PROCEDURE REPORT") S SURG("opReport")=+X_U_LT_U_NT
"RTN","VPRDSR",63,0)
 S SURG("category")="SR"
"RTN","VPRDSR",64,0)
 Q
"RTN","VPRDSR",65,0)
 ;
"RTN","VPRDSR",66,0)
EN1(IEN,SURG) ; -- return a surgery in SURG("attribute")=value
"RTN","VPRDSR",67,0)
 N VPRX,VPRY,X,Y,I,VPRMOD,VPROTH,SHOWADD
"RTN","VPRDSR",68,0)
 K SURG,^TMP("VPRTEXT",$J)
"RTN","VPRDSR",69,0)
 S SHOWADD=1 ;to omit leading '+' with note titles
"RTN","VPRDSR",70,0)
 D ONE^SROESTV("VPRY",IEN) S VPRX=$G(VPRY(IEN)) Q:VPRX=""
"RTN","VPRDSR",71,0)
 S SURG("id")=IEN,X=$P(VPRX,U,2),SURG("status")="COMPLETED"
"RTN","VPRDSR",72,0)
 I X?1"* Aborted * ".E S X=$E(X,13,999),SURG("status")="ABORTED"
"RTN","VPRDSR",73,0)
 S SURG("name")=X,SURG("dateTime")=$P(VPRX,U,3)
"RTN","VPRDSR",74,0)
 S X=$P(VPRX,U,4) S:X SURG("provider")=$TR(X,";","^")
"RTN","VPRDSR",75,0)
 S X=$$GET1^DIQ(130,IEN_",",50,"I"),SURG("facility")=$$FAC^VPRD(X)
"RTN","VPRDSR",76,0)
 S SURG("encounter")=$$GET1^DIQ(130,IEN_",",.015,"I")
"RTN","VPRDSR",77,0)
 S X=$$GET1^DIQ(136,IEN_",",.02,"I") I X D
"RTN","VPRDSR",78,0)
 . S SURG("type")=$$CPT(X)
"RTN","VPRDSR",79,0)
 . D GETS^DIQ(136,IEN_",","1*","I","VPRMOD") ;CPT modifiers
"RTN","VPRDSR",80,0)
 . S I="" F  S I=$O(VPRMOD(136.01,I)) Q:I=""  D
"RTN","VPRDSR",81,0)
 .. S X=+$G(VPRMOD(136.01,I,.01,"I")),Y=$$MOD^ICPTMOD(X,"I")
"RTN","VPRDSR",82,0)
 .. S SURG("modifier",+I)=$P(Y,U,2,3)
"RTN","VPRDSR",83,0)
 D GETS^DIQ(136,IEN_",","3*","I","VPROTH") ;other procedures
"RTN","VPRDSR",84,0)
 S I="" F  S I=$O(VPROTH(136.03,I)) Q:I=""  D
"RTN","VPRDSR",85,0)
 . S X=+$G(VPROTH(136.03,I,.01,"I")) Q:'X
"RTN","VPRDSR",86,0)
 . S SURG("otherProcedure",+I)=$$CPT(X)
"RTN","VPRDSR",87,0)
 S I=0 F  S I=$O(VPRY(IEN,I)) Q:I<1  S X=$G(VPRY(IEN,I)) I X D
"RTN","VPRDSR",88,0)
 . N LT,NT S LT=$P(X,U,2) Q:$P(LT," ")="Addendum"
"RTN","VPRDSR",89,0)
 . S NT=$$GET1^DIQ(8925,+X_",",".01:1501")
"RTN","VPRDSR",90,0)
 . S SURG("document",I)=+X_U_LT_U_NT
"RTN","VPRDSR",91,0)
 . S:$G(VPRTEXT) SURG("document",I,"content")=$$TEXT^VPRDTIU(+X)
"RTN","VPRDSR",92,0)
 . I LT["OPERATION REPORT"!(LT["PROCEDURE REPORT") S SURG("opReport")=+X_U_LT_U_NT
"RTN","VPRDSR",93,0)
 S SURG("category")="SR"
"RTN","VPRDSR",94,0)
 Q
"RTN","VPRDSR",95,0)
 ;
"RTN","VPRDSR",96,0)
CPT(IEN) ; -- return code^description for CPT code, or "^" if error
"RTN","VPRDSR",97,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDSR",98,0)
 S X0=$$CPT^ICPTCOD(IEN) I X0<0 Q "^"
"RTN","VPRDSR",99,0)
 S Y=$P(X0,U,2,3)                  ;CPT Code^Short Name
"RTN","VPRDSR",100,0)
 S N=$$CPTD^ICPTCOD($P(Y,U),"VPRX") ;CPT Description
"RTN","VPRDSR",101,0)
 I N>0,$L($G(VPRX(1))) D
"RTN","VPRDSR",102,0)
 . S X=$G(VPRX(1)),I=1
"RTN","VPRDSR",103,0)
 . F  S I=$O(VPRX(I)) Q:I<1  Q:VPRX(I)=" "  S X=X_" "_VPRX(I)
"RTN","VPRDSR",104,0)
 . S $P(Y,U,2)=X
"RTN","VPRDSR",105,0)
 Q Y
"RTN","VPRDSR",106,0)
 ;
"RTN","VPRDSR",107,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDSR",108,0)
 ;
"RTN","VPRDSR",109,0)
XML(SURG) ; -- Return surgery as XML
"RTN","VPRDSR",110,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDSR",111,0)
 D ADD("<surgery>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDSR",112,0)
 S ATT="" F  S ATT=$O(SURG(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDSR",113,0)
 . I $O(SURG(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDSR",114,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDSR",115,0)
 .. S I=0 F  S I=$O(SURG(ATT,I)) Q:I<1  D
"RTN","VPRDSR",116,0)
 ... S X=$G(SURG(ATT,I)),NAMES=""
"RTN","VPRDSR",117,0)
 ... S NAMES=$S(ATT="document":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDSR",118,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDSR",119,0)
 ... S X=$G(SURG(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDSR",120,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDSR",121,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDSR",122,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDSR",123,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDSR",124,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDSR",125,0)
 . S X=$G(SURG(ATT)),Y="" Q:'$L(X)
"RTN","VPRDSR",126,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDSR",127,0)
 . S NAMES=$S(ATT="opReport":"id^localTitle^nationalTitle^Z",1:"code^name^Z")
"RTN","VPRDSR",128,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDSR",129,0)
 D ADD("</surgery>")
"RTN","VPRDSR",130,0)
 Q
"RTN","VPRDSR",131,0)
 ;
"RTN","VPRDSR",132,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDSR",133,0)
 N STR,P,TAG S STR=""
"RTN","VPRDSR",134,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDSR",135,0)
 Q STR
"RTN","VPRDSR",136,0)
 ;
"RTN","VPRDSR",137,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDSR",138,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDSR",139,0)
 S @VPR@(VPRI)=X
"RTN","VPRDSR",140,0)
 Q
"RTN","VPRDTIU")
0^14^B80235055^B61120410
"RTN","VPRDTIU",1,0)
VPRDTIU ;SLC/MKB -- TIU extract ;8/2/11  15:29
"RTN","VPRDTIU",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDTIU",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDTIU",4,0)
 ;
"RTN","VPRDTIU",5,0)
 ; External References          DBIA#
"RTN","VPRDTIU",6,0)
 ; -------------------          -----
"RTN","VPRDTIU",7,0)
 ; ^SC(                         10040
"RTN","VPRDTIU",8,0)
 ; ^TIU(8925.1              2321,5677
"RTN","VPRDTIU",9,0)
 ; ^TIU(8926.1                   5678
"RTN","VPRDTIU",10,0)
 ; ^VA(200                      10060
"RTN","VPRDTIU",11,0)
 ; DIQ                           2056
"RTN","VPRDTIU",12,0)
 ; RAO7PC1                       2043
"RTN","VPRDTIU",13,0)
 ; TIUCNSLT                      5546
"RTN","VPRDTIU",14,0)
 ; TIUCP                         3568
"RTN","VPRDTIU",15,0)
 ; TIULQ                         2693
"RTN","VPRDTIU",16,0)
 ; TIULX                         3058
"RTN","VPRDTIU",17,0)
 ; TIUSROI                       5676
"RTN","VPRDTIU",18,0)
 ; TIUSRVLO                 2834,2865
"RTN","VPRDTIU",19,0)
 ; TIUSRVR1                      2944
"RTN","VPRDTIU",20,0)
 ; XLFSTR                       10104
"RTN","VPRDTIU",21,0)
 ;
"RTN","VPRDTIU",22,0)
 ; ------------ Get documents from VistA ------------
"RTN","VPRDTIU",23,0)
 ;
"RTN","VPRDTIU",24,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's documents
"RTN","VPRDTIU",25,0)
 N VPRITM,VPRN,VPRX,VPRY,VPRCNT
"RTN","VPRDTIU",26,0)
 S DFN=+$G(DFN) Q:$G(DFN)<1
"RTN","VPRDTIU",27,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDTIU",28,0)
 ;
"RTN","VPRDTIU",29,0)
 ; get one document
"RTN","VPRDTIU",30,0)
 I $L($G(ID)),ID[";" D  G ENQ
"RTN","VPRDTIU",31,0)
 . I ID D RPT1^VPRDMC(DFN,ID,.VPRITM),XML(.VPRITM) Q  ;CP
"RTN","VPRDTIU",32,0)
 . D RPT1^VPRDLRA(DFN,ID,.VPRITM),XML(.VPRITM) Q      ;Lab
"RTN","VPRDTIU",33,0)
 I $G(ID),ID["-" D  G ENQ                             ;Radiology
"RTN","VPRDTIU",34,0)
 . S (BEG,END)=9999999.9999-+ID D EN1^RAO7PC1(DFN,BEG,END,"99P")
"RTN","VPRDTIU",35,0)
 . D RPT1^VPRDRA(DFN,ID,.VPRITM),XML(.VPRITM)
"RTN","VPRDTIU",36,0)
 . K ^TMP($J,"RAE1")
"RTN","VPRDTIU",37,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM):$D(VPRITM) G ENQ
"RTN","VPRDTIU",38,0)
 ;
"RTN","VPRDTIU",39,0)
 ; get all documents
"RTN","VPRDTIU",40,0)
 N CLASS,SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS,VPRC,CLS,VPRS,CTXT
"RTN","VPRDTIU",41,0)
 D SETUP S VPRCNT=0 ;define search criteria
"RTN","VPRDTIU",42,0)
 I CLASS="CP" D RPTS^VPRDMC(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",43,0)
 I CLASS="RA" D RPTS^VPRDRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",44,0)
 I CLASS="LR" D RPTS^VPRDLRA(DFN,BEG,END,MAX) Q
"RTN","VPRDTIU",45,0)
 F VPRC=1:1:$L(CLASS,U) S CLS=$P(CLASS,U,VPRC) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",46,0)
 . F VPRS=1:1:$L(STATUS,U) S CTXT=$P(STATUS,U,VPRS) D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",47,0)
 .. D CONTEXT^TIUSRVLO(.VPRY,CLS,CTXT,DFN,BEG,END,,MAX,,1)
"RTN","VPRDTIU",48,0)
 .. S VPRN=0 F  S VPRN=$O(@VPRY@(VPRN)) Q:VPRN<1  D  Q:VPRCNT'<MAX
"RTN","VPRDTIU",49,0)
 ... S VPRX=$G(@VPRY@(VPRN)) Q:'$$MATCH(VPRX)
"RTN","VPRDTIU",50,0)
 ... Q:$D(^TMP("VPRD",$J,+VPRX))  ;already included
"RTN","VPRDTIU",51,0)
 ... K VPRITM D EN1(VPRX,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDTIU",52,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDTIU",53,0)
 .. K @VPRY
"RTN","VPRDTIU",54,0)
ENQ ; end
"RTN","VPRDTIU",55,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",56,0)
 Q
"RTN","VPRDTIU",57,0)
 ;
"RTN","VPRDTIU",58,0)
EN1(VPRX,DOC) ; -- return a document in DOC("attribute")=value
"RTN","VPRDTIU",59,0)
 ;  Expects DFN, VPRX=IEN^$$RESOLVE^TIUSRVLO(IEN)
"RTN","VPRDTIU",60,0)
 N IEN,X,NAME,VPRTIU,ES,I,VPRY
"RTN","VPRDTIU",61,0)
 K DOC,^TMP("VPRTEXT",$J)
"RTN","VPRDTIU",62,0)
 S IEN=+$G(VPRX) Q:IEN<1  ;invalid ien
"RTN","VPRDTIU",63,0)
 I +VPRX=VPRX D  ;get data string, if needed
"RTN","VPRDTIU",64,0)
 . N SHOWADD,DA S SHOWADD=1,DA=+VPRX
"RTN","VPRDTIU",65,0)
 . S VPRX=DA_U_$$RESOLVE^TIUSRVLO(DA)
"RTN","VPRDTIU",66,0)
 Q:"UNKNOWN"[$P($G(VPRX),U,2)  ;null or invalid
"RTN","VPRDTIU",67,0)
 S NAME=$P(VPRX,U,2) ;I $P(VPRX,U,14),$P(NAME," ")="Addendum" Q
"RTN","VPRDTIU",68,0)
 S DOC("id")=IEN,DOC("localTitle")=NAME
"RTN","VPRDTIU",69,0)
 D EXTRACT^TIULQ(IEN,"VPRTIU",,".01:.04;1501:1508")
"RTN","VPRDTIU",70,0)
 S X=$$GET1^DIQ(8925,IEN_",",".01:1501","I") I X D
"RTN","VPRDTIU",71,0)
 . N IENS,TIU,Y,FNUM
"RTN","VPRDTIU",72,0)
 . S IENS=X_"," D GETS^DIQ(8926.1,IENS,"*","IE","TIU")
"RTN","VPRDTIU",73,0)
 . S DOC("nationalTitle")=$G(TIU(8926.1,IENS,99.99,"E"))_U_$G(TIU(8926.1,IENS,.01,"E"))
"RTN","VPRDTIU",74,0)
 . F I=".04^Subject^2",".05^Role^3",".06^Setting^4",".07^Service^5",".08^Type^6" D
"RTN","VPRDTIU",75,0)
 .. S Y=+$G(TIU(8926.1,IENS,+I,"I")) Q:Y'>0
"RTN","VPRDTIU",76,0)
 .. S FNUM="8926."_+$P(I,U,3)
"RTN","VPRDTIU",77,0)
 .. S DOC("nationalTitle"_$P(I,U,2))=$$VUID^VPRD(Y,FNUM)_U_$G(TIU(8926.1,IENS,+I,"E"))
"RTN","VPRDTIU",78,0)
 S:$G(FILTER("loinc")) DOC("loinc")=$P(FILTER("loinc"),U)
"RTN","VPRDTIU",79,0)
 S X=+$G(VPRTIU(IEN,.01,"I")),X=$$CATG(X),(DOC("type"),DOC("category"))=X
"RTN","VPRDTIU",80,0)
 S DOC("documentClass")=$S(X="LR":"LR LABORATORY REPORTS",X="SR":"SURGICAL REPORTS",X="CP":"CLINICAL PROCEDURES",X="DS":"DISCHARGE SUMMARY",1:"PROGRESS NOTES")
"RTN","VPRDTIU",81,0)
 S DOC("referenceDateTime")=$P(VPRX,U,3)
"RTN","VPRDTIU",82,0)
 S X=$P(VPRX,U,6) D  ;S:$L(X) DOC("location")=X
"RTN","VPRDTIU",83,0)
 . N LOC S LOC=$S($L(X):+$O(^SC("B",X,0)),1:0)
"RTN","VPRDTIU",84,0)
 . S DOC("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDTIU",85,0)
 S X=$P(VPRX,U,7) S:$L(X) DOC("status")=X
"RTN","VPRDTIU",86,0)
 S:$P(VPRX,U,11) DOC("images")=+$P(VPRX,U,11)
"RTN","VPRDTIU",87,0)
 S:$L($P(VPRX,U,12)) DOC("subject")=$P(VPRX,U,12)
"RTN","VPRDTIU",88,0)
 ; X=$S($P(VPRX,U,13)[">":"C",$P(VPRX,U,13)["<":"I",1:"") ;componentType
"RTN","VPRDTIU",89,0)
 I $P(VPRX,U,14)>5 S DOC("parent")=$P(VPRX,U,14) ;ID notes
"RTN","VPRDTIU",90,0)
 S DOC("encounter")=$G(VPRTIU(IEN,.03,"I"))
"RTN","VPRDTIU",91,0)
 S:$G(VPRTEXT) DOC("content")=$$TEXT(IEN)
"RTN","VPRDTIU",92,0)
 ; providers &/or signatures
"RTN","VPRDTIU",93,0)
 S X=$P(VPRX,U,5),I=0 S:X I=I+1,DOC("clinician",I)=+X_U_$P(X,";",3)_"^A" ;author
"RTN","VPRDTIU",94,0)
 M ES=VPRTIU(IEN) I ES(1501,"I") D
"RTN","VPRDTIU",95,0)
 . S I=I+1
"RTN","VPRDTIU",96,0)
 . S DOC("clinician",I)=ES(1502,"I")_U_ES(1502,"E")_"^S^"_ES(1501,"I")_U_$$SIG(ES(1502,"I"))
"RTN","VPRDTIU",97,0)
 I ES(1507,"I") D  ; cosigner
"RTN","VPRDTIU",98,0)
 . S I=I+1
"RTN","VPRDTIU",99,0)
 . S DOC("clinician",I)=ES(1508,"I")_U_ES(1508,"E")_"^C^"_ES(1507,"I")_U_$$SIG(ES(1508,"I"))
"RTN","VPRDTIU",100,0)
 Q
"RTN","VPRDTIU",101,0)
 ;
"RTN","VPRDTIU",102,0)
CATG(DA) ; -- Return a code for document type #8925.1 DA
"RTN","VPRDTIU",103,0)
 N X
"RTN","VPRDTIU",104,0)
 D ISCNSLT^TIUCNSLT(.X,DA) I X Q "CR"  ;consult result
"RTN","VPRDTIU",105,0)
 I $$ISA^TIULX(DA,25) Q "A"            ;CWAD note/Allergy
"RTN","VPRDTIU",106,0)
 I $$ISA^TIULX(DA,27) Q "D"            ;CWAD note/Advance Directive
"RTN","VPRDTIU",107,0)
 I $$ISA^TIULX(DA,30) Q "C"            ;CWAD note/Crisis Note
"RTN","VPRDTIU",108,0)
 I $$ISA^TIULX(DA,31) Q "W"            ;CWAD note/Clinical Warning
"RTN","VPRDTIU",109,0)
 I $$ISA^TIULX(DA,3) Q "PN"            ;progress note
"RTN","VPRDTIU",110,0)
 ;
"RTN","VPRDTIU",111,0)
 I $$ISA^TIULX(DA,244) Q "DS"          ;discharge summary
"RTN","VPRDTIU",112,0)
 D ISCP^TIUCP(.X,DA) I X Q "CP"        ;clinical procedure
"RTN","VPRDTIU",113,0)
 D ISSURG^TIUSROI(.X,DA) I X Q "SR"    ;surgery
"RTN","VPRDTIU",114,0)
 I $$ISA^TIULX(DA,$$LR) Q "LR"         ;laboratory
"RTN","VPRDTIU",115,0)
 Q ""
"RTN","VPRDTIU",116,0)
 ;
"RTN","VPRDTIU",117,0)
LR() ; -- Return ien of Lab class
"RTN","VPRDTIU",118,0)
 N Y S Y=+$O(^TIU(8925.1,"B","LR LABORATORY REPORTS",0))
"RTN","VPRDTIU",119,0)
 I Y>0,$S($P($G(^TIU(8925.1,Y,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S Y=0
"RTN","VPRDTIU",120,0)
 Q Y
"RTN","VPRDTIU",121,0)
 ;
"RTN","VPRDTIU",122,0)
SIG(X) ; -- Return Signature Block Name_Title
"RTN","VPRDTIU",123,0)
 N X20,Y S X20=$G(^VA(200,+$G(X),20))
"RTN","VPRDTIU",124,0)
 S Y=$P(X20,U,2)_" "_$P(X20,U,3)
"RTN","VPRDTIU",125,0)
 Q Y
"RTN","VPRDTIU",126,0)
 ;
"RTN","VPRDTIU",127,0)
RPT(VPRY,IFN) ; -- Return text of document in @VPRY@(n)
"RTN","VPRDTIU",128,0)
 N I,J ;protect for calling loops
"RTN","VPRDTIU",129,0)
 D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",130,0)
 Q
"RTN","VPRDTIU",131,0)
 ;
"RTN","VPRDTIU",132,0)
TEXT(IFN) ; -- Get document IFN text, return temp array name
"RTN","VPRDTIU",133,0)
 N VPRY,Y,I,J ;protect I&J for calling loops
"RTN","VPRDTIU",134,0)
 S IFN=+$G(IFN) D TGET^TIUSRVR1(.VPRY,IFN)
"RTN","VPRDTIU",135,0)
 M ^TMP("VPRTEXT",$J,IFN)=@VPRY K @VPRY
"RTN","VPRDTIU",136,0)
 S Y=$NA(^TMP("VPRTEXT",$J,IFN))
"RTN","VPRDTIU",137,0)
 Q Y
"RTN","VPRDTIU",138,0)
 ;
"RTN","VPRDTIU",139,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDTIU",140,0)
 ;
"RTN","VPRDTIU",141,0)
XML(DOC) ; -- Return patient documents as XML
"RTN","VPRDTIU",142,0)
 N ATT,X,Y,NAMES,TYPE,I
"RTN","VPRDTIU",143,0)
 D ADD("<document>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDTIU",144,0)
 S ATT="" F  S ATT=$O(DOC(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDTIU",145,0)
 . I $O(DOC(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDTIU",146,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDTIU",147,0)
 .. S I=0 F  S I=$O(DOC(ATT,I)) Q:I<1  D
"RTN","VPRDTIU",148,0)
 ... S X=$G(DOC(ATT,I)),NAMES=""
"RTN","VPRDTIU",149,0)
 ... I ATT="clinician" S NAMES="code^name^role^dateTime^signature^Z"
"RTN","VPRDTIU",150,0)
 ... S Y="<"_ATT_" "_$$LOOP_"/>" D ADD(Y)
"RTN","VPRDTIU",151,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDTIU",152,0)
 . S X=$G(DOC(ATT)),Y="" Q:'$L(X)
"RTN","VPRDTIU",153,0)
 . I ATT="content" D  S Y="" Q  ;text
"RTN","VPRDTIU",154,0)
 .. S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDTIU",155,0)
 .. S I=0 F  S I=$O(@X@(I)) Q:I<1  S Y=$$ESC^VPRD(@X@(I)) D ADD(Y)
"RTN","VPRDTIU",156,0)
 .. D ADD("</content>")
"RTN","VPRDTIU",157,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDTIU",158,0)
 . I $L(X)>1 S NAMES="code^name^Z",Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDTIU",159,0)
 D ADD("</document>")
"RTN","VPRDTIU",160,0)
 Q
"RTN","VPRDTIU",161,0)
 ;
"RTN","VPRDTIU",162,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDTIU",163,0)
 N STR,P,TAG S STR=""
"RTN","VPRDTIU",164,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDTIU",165,0)
 Q STR
"RTN","VPRDTIU",166,0)
 ;
"RTN","VPRDTIU",167,0)
ADD(X) ; Add a line @VPR@(n)=X
"RTN","VPRDTIU",168,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDTIU",169,0)
 S @VPR@(VPRI)=X
"RTN","VPRDTIU",170,0)
 Q
"RTN","VPRDTIU",171,0)
 ;
"RTN","VPRDTIU",172,0)
 ; ------------ Get/apply search criteria ------------
"RTN","VPRDTIU",173,0)
 ;
"RTN","VPRDTIU",174,0)
SETUP ; -- convert FILTER("attribute") = value to TIU criteria
"RTN","VPRDTIU",175,0)
 ; Expects: FILTER("category") = code (see $$CATG)
"RTN","VPRDTIU",176,0)
 ;          FILTER("loinc")    = LOINC
"RTN","VPRDTIU",177,0)
 ;          FILTER("status")   = 'all','completed','unsigned'
"RTN","VPRDTIU",178,0)
 ; Returns CLASS,[SUBCLASS,TITLE,SERVICE,SUBJECT,STATUS]
"RTN","VPRDTIU",179,0)
 ;
"RTN","VPRDTIU",180,0)
 N LOINC,TYPE,STS,CP
"RTN","VPRDTIU",181,0)
 S LOINC=+$G(FILTER("loinc")),TYPE=$$UP^XLFSTR($G(FILTER("category")))
"RTN","VPRDTIU",182,0)
 S CLASS="3^244",(SUBCLASS,TITLE,SERVICE,SUBJECT,NOTSUBJ,STATUS)=""
"RTN","VPRDTIU",183,0)
 ;
"RTN","VPRDTIU",184,0)
 ; status [default='complete']
"RTN","VPRDTIU",185,0)
 S STS=$$LOW^XLFSTR($G(FILTER("status")))
"RTN","VPRDTIU",186,0)
 S STATUS=$S(STS?1"unsig".E:2,STS="all":"5^2",1:5)  ;TIUSRVLO statuses
"RTN","VPRDTIU",187,0)
 ;
"RTN","VPRDTIU",188,0)
 ; progress notes
"RTN","VPRDTIU",189,0)
 I TYPE="PN" S CLASS=3 Q
"RTN","VPRDTIU",190,0)
 I TYPE="CR"!(LOINC=11488) S CLASS=3,SUBCLASS=+$$CLASS^TIUCNSLT Q
"RTN","VPRDTIU",191,0)
 ; LOINC=26442 S CLASS=3,SUBJECT="^114^" Q         ;OB/GYN
"RTN","VPRDTIU",192,0)
 I LOINC=34117 S CLASS=3,SERVICE="^88^" Q          ;H&P
"RTN","VPRDTIU",193,0)
 I TYPE="CWAD" S CLASS=3,SUBCLASS="25^27^30^31" Q  ;CWAD
"RTN","VPRDTIU",194,0)
 I TYPE="C" S CLASS=3,SUBCLASS=30 Q                ;Crisis Note
"RTN","VPRDTIU",195,0)
 I TYPE="W" S CLASS=3,SUBCLASS=31 Q                ;Clinical Warning
"RTN","VPRDTIU",196,0)
 I TYPE="A" S CLASS=3,SUBCLASS=25 Q                ;Allergy Note
"RTN","VPRDTIU",197,0)
 I TYPE="D"!(LOINC=42348) S CLASS=3,SUBCLASS=27 Q  ;Advance Directive
"RTN","VPRDTIU",198,0)
 ;
"RTN","VPRDTIU",199,0)
 ; discharge summaries
"RTN","VPRDTIU",200,0)
 I TYPE="DS"!(LOINC=18842) S CLASS=244 Q
"RTN","VPRDTIU",201,0)
 ;
"RTN","VPRDTIU",202,0)
 ; procedures
"RTN","VPRDTIU",203,0)
 I TYPE="SR"!(LOINC=29752) S CLASS=+$$CLASS^TIUSROI("SURGICAL REPORTS") Q
"RTN","VPRDTIU",204,0)
 D CPCLASS^TIUCP(.CP)
"RTN","VPRDTIU",205,0)
 I TYPE="CP" S CLASS=$S(STATUS=2:CP,1:"CP") Q       ;CLINICAL PROCEDURES
"RTN","VPRDTIU",206,0)
 I LOINC=26441 D  Q                                 ;CARDIOLOGY
"RTN","VPRDTIU",207,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",208,0)
 . S SUBJECT="^18^142^174^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",209,0)
 I LOINC=27896 D  Q                                 ;PULMONARY
"RTN","VPRDTIU",210,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",211,0)
 . S SUBJECT="^23^142^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",212,0)
 I LOINC=27895 D  Q                                 ;GASTROENTEROLOGY
"RTN","VPRDTIU",213,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",214,0)
 . S SUBJECT="^20^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",215,0)
 I LOINC=27897 D  Q                                 ;NEUROLOGY
"RTN","VPRDTIU",216,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",217,0)
 . S SUBJECT="^44^45^52^111^112^143^146^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",218,0)
 I LOINC=28619 D  Q                                 ;OPHTH/OPTOMETRY
"RTN","VPRDTIU",219,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",220,0)
 . S SUBJECT="^13^14^103^",SERVICE="^75^76^115^"
"RTN","VPRDTIU",221,0)
 I LOINC=28634 D  Q                                 ;MISC/ALL OTHERS
"RTN","VPRDTIU",222,0)
 . S CLASS=CP_"^3",SERVICE="^75^76^115^"
"RTN","VPRDTIU",223,0)
 . S NOTSUBJ="^18^142^174^23^142^20^44^45^52^111^112^143^146^13^14^103^"
"RTN","VPRDTIU",224,0)
 I LOINC=28570 D  Q                                 ;UNSPECIFIED/ALL
"RTN","VPRDTIU",225,0)
 . S CLASS=CP_"^3"
"RTN","VPRDTIU",226,0)
 . S SERVICE="^75^76^115^"
"RTN","VPRDTIU",227,0)
 ;
"RTN","VPRDTIU",228,0)
 ; pathology/lab
"RTN","VPRDTIU",229,0)
 I TYPE="LR"!(LOINC=27898) S CLASS=$S(STATUS=2:$$LR,1:"LR") Q
"RTN","VPRDTIU",230,0)
 ;
"RTN","VPRDTIU",231,0)
 ; radiology
"RTN","VPRDTIU",232,0)
 I TYPE="RA"!(LOINC=18726) S CLASS="RA" Q
"RTN","VPRDTIU",233,0)
 ;
"RTN","VPRDTIU",234,0)
 ; unknown
"RTN","VPRDTIU",235,0)
 I $L(TYPE)!LOINC S CLASS=0
"RTN","VPRDTIU",236,0)
 Q
"RTN","VPRDTIU",237,0)
 ;
"RTN","VPRDTIU",238,0)
MATCH(DOC) ; -- Return 1 or 0, if document DA matches search criteria
"RTN","VPRDTIU",239,0)
 N Y,DA,LOCAL,NATL,X0,OK S Y=0
"RTN","VPRDTIU",240,0)
 S DA=+$G(DOC) G:DA<1 MQ
"RTN","VPRDTIU",241,0)
 ; include addenda if pulling only unsigned items
"RTN","VPRDTIU",242,0)
 I $P(DOC,U,2)?1"Addendum ".E,STATUS'=2 G MQ
"RTN","VPRDTIU",243,0)
 ; TIU unsigned list can include completed parent notes
"RTN","VPRDTIU",244,0)
 I CTXT=2,$P(DOC,U,7)'="unsigned" G MQ
"RTN","VPRDTIU",245,0)
 S LOCAL=$$GET1^DIQ(8925,DA_",",.01,"I") ;local Title 8925.1 ien
"RTN","VPRDTIU",246,0)
 I $L(SUBCLASS) D  G:'OK MQ
"RTN","VPRDTIU",247,0)
 . N I,X S OK=0
"RTN","VPRDTIU",248,0)
 . F I=1:1:$L(SUBCLASS,"^") S X=$P(SUBCLASS,U,I) I $$ISA^TIULX(LOCAL,X) S OK=1 Q
"RTN","VPRDTIU",249,0)
 S NATL=+$$GET1^DIQ(8925.1,LOCAL_",",1501,"I") ;Natl Title 8926.1 ien
"RTN","VPRDTIU",250,0)
 I $L(TITLE) G:TITLE'[(U_+NATL_U) MQ
"RTN","VPRDTIU",251,0)
 S X0=$G(^TIU(8926.1,NATL,0))
"RTN","VPRDTIU",252,0)
 I $L(SERVICE) G:SERVICE'[(U_+$P(X0,U,7)_U) MQ
"RTN","VPRDTIU",253,0)
 I $L(SUBJECT) G:SUBJECT'[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",254,0)
 I $L(NOTSUBJ) G:NOTSUBJ[(U_+$P(X0,U,4)_U) MQ
"RTN","VPRDTIU",255,0)
 S Y=1
"RTN","VPRDTIU",256,0)
MQ Q Y
"RTN","VPRDVSIT")
0^15^B89381077^B71801802
"RTN","VPRDVSIT",1,0)
VPRDVSIT ;SLC/MKB -- Visit/Encounter extract ;8/2/11  15:29
"RTN","VPRDVSIT",2,0)
 ;;1.0;VIRTUAL PATIENT RECORD;**1**;Sep 01, 2011;Build 38
"RTN","VPRDVSIT",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","VPRDVSIT",4,0)
 ;
"RTN","VPRDVSIT",5,0)
 ; External References          DBIA#
"RTN","VPRDVSIT",6,0)
 ; -------------------          -----
"RTN","VPRDVSIT",7,0)
 ; ^AUPNVSIT                     2028
"RTN","VPRDVSIT",8,0)
 ; ^DIC(40.7                      557
"RTN","VPRDVSIT",9,0)
 ; ^DIC(42                      10039
"RTN","VPRDVSIT",10,0)
 ; ^DIC(45.7                     1154
"RTN","VPRDVSIT",11,0)
 ; ^DPT(                        10035
"RTN","VPRDVSIT",12,0)
 ; ^SC                          10040
"RTN","VPRDVSIT",13,0)
 ; ^VA(200                      10060
"RTN","VPRDVSIT",14,0)
 ; DGPTFAPI                      3157
"RTN","VPRDVSIT",15,0)
 ; DIC                           2051
"RTN","VPRDVSIT",16,0)
 ; DILFD                         2055
"RTN","VPRDVSIT",17,0)
 ; DIQ                           2056
"RTN","VPRDVSIT",18,0)
 ; ICDCODE                       3990
"RTN","VPRDVSIT",19,0)
 ; ICPTCOD                       1995
"RTN","VPRDVSIT",20,0)
 ; PXAPI,^TMP("PXKENC",$J        1894
"RTN","VPRDVSIT",21,0)
 ; SDOE                          2546
"RTN","VPRDVSIT",22,0)
 ; VADPT                        10061
"RTN","VPRDVSIT",23,0)
 ; VADPT2                         325
"RTN","VPRDVSIT",24,0)
 ; XUAF4                         2171
"RTN","VPRDVSIT",25,0)
 ;
"RTN","VPRDVSIT",26,0)
 ; ------------ Get encounter(s) from VistA ------------
"RTN","VPRDVSIT",27,0)
 ;
"RTN","VPRDVSIT",28,0)
EN(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments
"RTN","VPRDVSIT",29,0)
 N VPRCNT,VPRITM,VPRDT,VPRLOC,VPRDA
"RTN","VPRDVSIT",30,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",31,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",32,0)
 ;
"RTN","VPRDVSIT",33,0)
 ; get one visit
"RTN","VPRDVSIT",34,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) G ENQ
"RTN","VPRDVSIT",35,0)
 ;
"RTN","VPRDVSIT",36,0)
 ; -- get all visits
"RTN","VPRDVSIT",37,0)
 I END,END'["." S END=END_".24" ;assume end of day
"RTN","VPRDVSIT",38,0)
 S VPRCNT=0
"RTN","VPRDVSIT",39,0)
 ;F  S IDX=$Q(@IDX,-1) Q:DFN'=$P(IDX,",",2)  Q:$P(IDX,",",3)<BEG  I $P(IDX,",",5)["P" D
"RTN","VPRDVSIT",40,0)
 S VPRDT=END F  S VPRDT=$O(^AUPNVSIT("AET",DFN,VPRDT),-1)  Q:VPRDT<BEG  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",41,0)
 . S VPRLOC=0 F  S VPRLOC=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC)) Q:VPRLOC<1  D
"RTN","VPRDVSIT",42,0)
 .. S VPRDA=0 F  S VPRDA=$O(^AUPNVSIT("AET",DFN,VPRDT,VPRLOC,"P",VPRDA)) Q:VPRDA<1  D
"RTN","VPRDVSIT",43,0)
 ... K VPRITM D EN1(VPRDA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",44,0)
 ... D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",45,0)
ENQ ; end
"RTN","VPRDVSIT",46,0)
 K ^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",47,0)
 Q
"RTN","VPRDVSIT",48,0)
 ;
"RTN","VPRDVSIT",49,0)
ENAA(DFN,BEG,END,MAX,ID) ; -- find patient's visits and appointments [AA]
"RTN","VPRDVSIT",50,0)
 N IDT,DA,VPRCNT,VPRITM
"RTN","VPRDVSIT",51,0)
 S DFN=+$G(DFN) Q:DFN<1
"RTN","VPRDVSIT",52,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","VPRDVSIT",53,0)
 I $G(ID) D EN1(ID,.VPRITM),XML(.VPRITM) Q  ;one visit
"RTN","VPRDVSIT",54,0)
 D IDT S VPRCNT=0
"RTN","VPRDVSIT",55,0)
 S IDT=BEG F  S IDT=$O(^AUPNVSIT("AA",DFN,IDT)) Q:IDT<1!(IDT>END)  D  Q:VPRCNT'<MAX
"RTN","VPRDVSIT",56,0)
 . S DA=0 F  S DA=$O(^AUPNVSIT("AA",DFN,IDT,DA)) Q:DA<1  D
"RTN","VPRDVSIT",57,0)
 .. K VPRITM D EN1(DA,.VPRITM) Q:'$D(VPRITM)
"RTN","VPRDVSIT",58,0)
 .. D XML(.VPRITM) S VPRCNT=VPRCNT+1
"RTN","VPRDVSIT",59,0)
 Q
"RTN","VPRDVSIT",60,0)
IDT ; -- invert BEG and END dates for visit format:
"RTN","VPRDVSIT",61,0)
 ;  IDT=(9999999-$P(VDT,"."))_"."_$P(VDT,".",2)
"RTN","VPRDVSIT",62,0)
 N X S X=BEG
"RTN","VPRDVSIT",63,0)
 S BEG=(9999999-$P(END,"."))
"RTN","VPRDVSIT",64,0)
 S END=(9999999-$P(X,"."))_".2359"
"RTN","VPRDVSIT",65,0)
 Q
"RTN","VPRDVSIT",66,0)
 ;
"RTN","VPRDVSIT",67,0)
EN1(IEN,VST) ; -- return a visit in VST("attribute")=value
"RTN","VPRDVSIT",68,0)
 N X0,X15,X,FAC,LOC,CATG,INPT,DA
"RTN","VPRDVSIT",69,0)
 K VST,^TMP("VPRTEXT",$J)
"RTN","VPRDVSIT",70,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid
"RTN","VPRDVSIT",71,0)
 D ENCEVENT^PXAPI(IEN)
"RTN","VPRDVSIT",72,0)
 S X0=$G(^TMP("PXKENC",$J,IEN,"VST",IEN,0)),X15=$G(^(150))
"RTN","VPRDVSIT",73,0)
 Q:$P(X15,U,3)'="P"  Q:$P(X0,U,7)="E"  ;want primary, not historical
"RTN","VPRDVSIT",74,0)
 I $P(X0,U,7)="H" D ADM(IEN,+X0,.VST) Q
"RTN","VPRDVSIT",75,0)
 S VST("id")=IEN,VST("dateTime")=+X0
"RTN","VPRDVSIT",76,0)
 S FAC=+$P(X0,U,6),CATG=$P(X0,U,7),LOC=+$P(X0,U,22)
"RTN","VPRDVSIT",77,0)
 S:FAC VST("facility")=$$STA^XUAF4(FAC)_U_$P($$NS^XUAF4(FAC),U)
"RTN","VPRDVSIT",78,0)
 S:'FAC VST("facility")=$$FAC^VPRD(LOC)
"RTN","VPRDVSIT",79,0)
 S VST("serviceCategory")=CATG_U_$$CATG(CATG)
"RTN","VPRDVSIT",80,0)
 S VST("visitString")=LOC_";"_+X0_";"_CATG
"RTN","VPRDVSIT",81,0)
 S INPT=$P(X15,U,2) S:INPT="" INPT=$S("H^I^R^D"[CATG:1,1:0)
"RTN","VPRDVSIT",82,0)
 S X=$$CPT(IEN) S:X VST("type")=$P($$CPT^ICPTCOD(X),U,2,3)
"RTN","VPRDVSIT",83,0)
 I 'X S VST("type")=U_$S('INPT&LOC:$P($G(^SC(LOC,0)),U)_" VISIT",1:$$CATG(CATG))
"RTN","VPRDVSIT",84,0)
 S VST("patientClass")=$S(INPT:"IMP",1:"AMB")
"RTN","VPRDVSIT",85,0)
 S X=$P(X0,U,8) S:X VST("stopCode")=$$AMIS(X) I LOC D
"RTN","VPRDVSIT",86,0)
 . N L0 S L0=$G(^SC(LOC,0))
"RTN","VPRDVSIT",87,0)
 . I 'X S VST("stopCode")=$$AMIS($P(L0,U,7))
"RTN","VPRDVSIT",88,0)
 . S VST("location")=$P(L0,U),VST("service")=$$SERV($P(L0,U,20))
"RTN","VPRDVSIT",89,0)
 . S X=$P(L0,U,18) S:X VST("creditStopCode")=$$AMIS(X)
"RTN","VPRDVSIT",90,0)
 S VST("reason")=$$POV(IEN)
"RTN","VPRDVSIT",91,0)
 ; provider(s)
"RTN","VPRDVSIT",92,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,IEN,"PRV",DA)) Q:DA<1  S X0=$G(^(DA,0)) D
"RTN","VPRDVSIT",93,0)
 . S VST("provider",DA)=+X0_U_$P($G(^VA(200,+X0,0)),U)_$S($P(X0,U,4)="P":"^P^1",1:"^S^")
"RTN","VPRDVSIT",94,0)
 ; note(s)
"RTN","VPRDVSIT",95,0)
 D TIU(IEN)
"RTN","VPRDVSIT",96,0)
 K ^TMP("PXKENC",$J,IEN)
"RTN","VPRDVSIT",97,0)
 Q
"RTN","VPRDVSIT",98,0)
 ;
"RTN","VPRDVSIT",99,0)
TIU(VISIT) ; -- add notes to VST("document")
"RTN","VPRDVSIT",100,0)
 N X,Y,I,VPRX,LT,NT,DA,CNT,VPRY
"RTN","VPRDVSIT",101,0)
 D FIND^DIC(8925,,.01,"QX",+$G(VISIT),,"V",,,"VPRX")
"RTN","VPRDVSIT",102,0)
 S Y="",(I,CNT)=0
"RTN","VPRDVSIT",103,0)
 F  S I=$O(VPRX("DILIST",1,I)) Q:I<1  D
"RTN","VPRDVSIT",104,0)
 . S LT=$G(VPRX("DILIST","ID",I,.01)) Q:$P(LT," ")="Addendum"
"RTN","VPRDVSIT",105,0)
 . S DA=$G(VPRX("DILIST",2,I))
"RTN","VPRDVSIT",106,0)
 . S NT=$$GET1^DIQ(8925,+DA_",",".01:1501")
"RTN","VPRDVSIT",107,0)
 . S CNT=CNT+1,VST("document",CNT)=DA_U_LT_U_NT
"RTN","VPRDVSIT",108,0)
 . S:$G(VPRTEXT) VST("document",CNT,"content")=$$TEXT^VPRDTIU(DA)
"RTN","VPRDVSIT",109,0)
 Q
"RTN","VPRDVSIT",110,0)
 ;
"RTN","VPRDVSIT",111,0)
POV(VISIT) ; -- return the primary Purpose of Visit as ICD^ProviderNarrative
"RTN","VPRDVSIT",112,0)
 N DA,Y,X,X0,ICD S Y=""
"RTN","VPRDVSIT",113,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"POV",DA)) Q:DA<1  S X0=$G(^(DA,0)) I $P(X0,U,12)="P" D  Q:$L(Y)
"RTN","VPRDVSIT",114,0)
 . S X=+$P(X0,U,4),ICD=$$ICD(+X0)
"RTN","VPRDVSIT",115,0)
 . S Y=ICD_U_$$EXTERNAL^DILFD(9000010.07,.04,,X)
"RTN","VPRDVSIT",116,0)
 Q Y
"RTN","VPRDVSIT",117,0)
 ;
"RTN","VPRDVSIT",118,0)
ICD(IEN) ; -- return code^description for ICD code, or "^" if error
"RTN","VPRDVSIT",119,0)
 N X0,VPRX,N,I,X,Y S IEN=+$G(IEN)
"RTN","VPRDVSIT",120,0)
 S X0=$$ICDDX^ICDCODE(IEN) I X0<0 Q "^"
"RTN","VPRDVSIT",121,0)
 S Y=$P(X0,U,2)_U_$P(X0,U,4)       ;ICD Code^Dx name
"RTN","VPRDVSIT",122,0)
 S N=$$ICDD^ICDCODE($P(Y,U),"VPRX") ;ICD Description
"RTN","VPRDVSIT",123,0)
 I N>0,$L($G(VPRX(1))) S $P(Y,U,2)=VPRX(1)
"RTN","VPRDVSIT",124,0)
 Q Y
"RTN","VPRDVSIT",125,0)
 ;
"RTN","VPRDVSIT",126,0)
CPT(VISIT) ; -- Return CPT code of encounter type
"RTN","VPRDVSIT",127,0)
 N DA,Y,X,X0 S Y=""
"RTN","VPRDVSIT",128,0)
 S DA=0 F  S DA=$O(^TMP("PXKENC",$J,VISIT,"CPT",DA)) Q:DA<1  S X0=$G(^(DA,0)) D  Q:$L(Y)
"RTN","VPRDVSIT",129,0)
 . S X=$P(X0,U) I X?1"992"2N S Y=X Q
"RTN","VPRDVSIT",130,0)
 Q Y
"RTN","VPRDVSIT",131,0)
 ;
"RTN","VPRDVSIT",132,0)
AMIS(X) ; -- return the AMIS code^name of Credit Stop X
"RTN","VPRDVSIT",133,0)
 N Y,X0 S Y=""
"RTN","VPRDVSIT",134,0)
 S X0=$G(^DIC(40.7,+$G(X),0)) S:$L(X0) Y=$P(X0,U,2)_U_$P(X0,U)
"RTN","VPRDVSIT",135,0)
 Q Y
"RTN","VPRDVSIT",136,0)
 ;
"RTN","VPRDVSIT",137,0)
CATG(X) ; -- Return name of visit Service Category code X
"RTN","VPRDVSIT",138,0)
 N Y S Y=""
"RTN","VPRDVSIT",139,0)
 I X="A" S Y="AMBULATORY"
"RTN","VPRDVSIT",140,0)
 I X="H" S Y="HOSPITALIZATION"
"RTN","VPRDVSIT",141,0)
 I X="I" S Y="IN HOSPITAL"
"RTN","VPRDVSIT",142,0)
 I X="C" S Y="CHART REVIEW"
"RTN","VPRDVSIT",143,0)
 I X="T" S Y="TELECOMMUNICATIONS"
"RTN","VPRDVSIT",144,0)
 I X="N" S Y="NOT FOUND"
"RTN","VPRDVSIT",145,0)
 I X="S" S Y="DAY SURGERY"
"RTN","VPRDVSIT",146,0)
 I X="O" S Y="OBSERVATION"
"RTN","VPRDVSIT",147,0)
 I X="E" S Y="EVENT (HISTORICAL)"
"RTN","VPRDVSIT",148,0)
 I X="R" S Y="NURSING HOME"
"RTN","VPRDVSIT",149,0)
 I X="D" S Y="DAILY HOSPITALIZATION DATA"
"RTN","VPRDVSIT",150,0)
 I X="X" S Y="ANCILLARY PACKAGE DAILY DATA"
"RTN","VPRDVSIT",151,0)
 Q Y
"RTN","VPRDVSIT",152,0)
 ;
"RTN","VPRDVSIT",153,0)
SERV(FTS) ; -- Return #42.4 Service for a Facility Treating Specialty
"RTN","VPRDVSIT",154,0)
 N Y S Y="",FTS=+$G(FTS)
"RTN","VPRDVSIT",155,0)
 S Y=$$GET1^DIQ(45.7,FTS_",","1:3","E")
"RTN","VPRDVSIT",156,0)
 Q Y
"RTN","VPRDVSIT",157,0)
 ;
"RTN","VPRDVSIT",158,0)
ADM(IEN,DATE,ADM) ; -- return an admission in ADM("attribute")=value
"RTN","VPRDVSIT",159,0)
 N VAINDT,VADMVT,VAIP,VAIN,VAERR,HLOC,ICD,I K ADM
"RTN","VPRDVSIT",160,0)
 S IEN=+$G(IEN),DATE=+$G(DATE) Q:IEN<1  Q:DATE<1
"RTN","VPRDVSIT",161,0)
 S VAINDT=DATE D ADM^VADPT2 Q:VADMVT<1
"RTN","VPRDVSIT",162,0)
 I VADMVT=$G(^DPT(DFN,.105)) D INPT Q  ;current inpatient
"RTN","VPRDVSIT",163,0)
 S VAIP("E")=VADMVT D IN5^VADPT Q:'$G(VAIP(1))  ;deleted
"RTN","VPRDVSIT",164,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP"
"RTN","VPRDVSIT",165,0)
 ; ADM("admitType")=$P($G(VAIP(4)),U,2)
"RTN","VPRDVSIT",166,0)
 S DATE=+$G(VAIP(13,1)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",167,0)
 S:$G(VAIP(7)) I=I+1,ADM("provider",I)=VAIP(7)_"^P^1" ;primary
"RTN","VPRDVSIT",168,0)
 S:$G(VAIP(18)) I=I+1,ADM("provider",I)=VAIP(18)_"^A" ;attending
"RTN","VPRDVSIT",169,0)
 S ADM("specialty")=$P($G(VAIP(8)),U,2)
"RTN","VPRDVSIT",170,0)
 S X=$$SERV(+$G(VAIP(8))),ADM("service")=X
"RTN","VPRDVSIT",171,0)
 S ICD=$$POV(IEN) S:'ICD ICD=$$PTF(DFN,VAIP(12)) ;PTF>ICD
"RTN","VPRDVSIT",172,0)
 S ADM("reason")=ICD_U_$G(VAIP(9)) ;ICD code^description^Dx text
"RTN","VPRDVSIT",173,0)
 S HLOC=+$G(^DIC(42,+$G(VAIP(5)),44))
"RTN","VPRDVSIT",174,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",175,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIP(6),U,2)
"RTN","VPRDVSIT",176,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",177,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",178,0)
 I $G(VAIP(17)) D
"RTN","VPRDVSIT",179,0)
 . S ADM("departureDateTime")=+$G(VAIP(17,1))
"RTN","VPRDVSIT",180,0)
 . ; ADM("disposition")=$G(VAIP(17,3)) ;Discharge Mvt Type
"RTN","VPRDVSIT",181,0)
 S ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",182,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",183,0)
 Q
"RTN","VPRDVSIT",184,0)
 ;
"RTN","VPRDVSIT",185,0)
INPT ; -- return current admission in ADM("attribute")=value [from ADM]
"RTN","VPRDVSIT",186,0)
 K VAINDT D INP^VADPT Q:VAIN(1)<1
"RTN","VPRDVSIT",187,0)
 S ADM("id")=IEN,ADM("patientClass")="IMP"
"RTN","VPRDVSIT",188,0)
 ; ADM("admitType")=$P($G(VAIN(8)),U,2)
"RTN","VPRDVSIT",189,0)
 S DATE=+$G(VAIN(7)),(ADM("dateTime"),ADM("arrivalDateTime"))=DATE,I=0
"RTN","VPRDVSIT",190,0)
 S:$G(VAIN(2)) I=I+1,ADM("provider",I)=VAIN(2)_"^P^1" ;primary
"RTN","VPRDVSIT",191,0)
 S:$G(VAIN(11)) I=I+1,ADM("provider",I)=VAIN(11)_"^A" ;attending
"RTN","VPRDVSIT",192,0)
 S ADM("specialty")=$P($G(VAIN(3)),U,2)
"RTN","VPRDVSIT",193,0)
 S X=$$SERV(+$G(VAIN(3))),ADM("service")=X
"RTN","VPRDVSIT",194,0)
 S ICD=$$POV(IEN) S:'ICD ICD=$$PTF(DFN,VAIN(10)) ;PTF>ICD
"RTN","VPRDVSIT",195,0)
 S ADM("reason")=ICD_U_$G(VAIN(9)) ;ICD code^description^Dx text
"RTN","VPRDVSIT",196,0)
 S HLOC=+$G(^DIC(42,+$G(VAIN(4)),44))
"RTN","VPRDVSIT",197,0)
 S:HLOC ADM("location")=$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",198,0)
 S ADM("facility")=$$FAC^VPRD(+HLOC),ADM("roomBed")=$P(VAIN(5),U,2)
"RTN","VPRDVSIT",199,0)
 S ADM("serviceCategory")="H^HOSPITALIZATION"
"RTN","VPRDVSIT",200,0)
 S X=$$CPT(IEN),ADM("type")=$S(X:$P($$CPT^ICPTCOD(X),U,2,3),1:U_$$CATG("H"))
"RTN","VPRDVSIT",201,0)
 ; ADM("visitString")=HLOC_";"_DATE_";H"
"RTN","VPRDVSIT",202,0)
 D TIU(IEN) ;notes/summary
"RTN","VPRDVSIT",203,0)
 Q
"RTN","VPRDVSIT",204,0)
 ;
"RTN","VPRDVSIT",205,0)
PTF(DFN,PTF) ; -- return ICD code^description for a PTF record
"RTN","VPRDVSIT",206,0)
 N VPRPTF,N,VPRX
"RTN","VPRDVSIT",207,0)
 D:$G(PTF) RPC^DGPTFAPI(.VPRPTF,+PTF) I $G(VPRPTF(0))<1 Q "^"
"RTN","VPRDVSIT",208,0)
 S Y=$P($G(VPRPTF(1)),U,3)_U
"RTN","VPRDVSIT",209,0)
 S N=$$ICDD^ICDCODE(Y,"VPRX") ;ICD Description
"RTN","VPRDVSIT",210,0)
 I N>0,$L($G(VPRX(1))) S Y=Y_VPRX(1)
"RTN","VPRDVSIT",211,0)
 Q Y
"RTN","VPRDVSIT",212,0)
 ;
"RTN","VPRDVSIT",213,0)
ENC(IEN,ENC) ; -- return an encounter in ENC("attribute")=value
"RTN","VPRDVSIT",214,0)
 N X0,DATE,HLOC,TYPE,STS,X,Y K ENC
"RTN","VPRDVSIT",215,0)
 S IEN=+$G(IEN) Q:IEN<1  ;invalid ien
"RTN","VPRDVSIT",216,0)
 S ENC("id")="E"_IEN,X0=$$GETOE^SDOE(IEN) ;^SCE(IEN,0) node
"RTN","VPRDVSIT",217,0)
 S DATE=+X0,ENC("dateTime")=DATE
"RTN","VPRDVSIT",218,0)
 S HLOC=+$P(X0,U,4) I HLOC D
"RTN","VPRDVSIT",219,0)
 . S HLOC=HLOC_U_$P($G(^SC(HLOC,0)),U)
"RTN","VPRDVSIT",220,0)
 . S ENC("location")=$P(HLOC,U,2)
"RTN","VPRDVSIT",221,0)
 . S X=$$GET1^DIQ(44,+HLOC_",",9.5,"I")
"RTN","VPRDVSIT",222,0)
 . I X S ENC("service")=$$SERV(X)
"RTN","VPRDVSIT",223,0)
 S ENC("facility")=$$FAC^VPRD(+HLOC)
"RTN","VPRDVSIT",224,0)
 S STS=$$EXTERNAL^DILFD(409.68,.12,,$P(X0,U,12))
"RTN","VPRDVSIT",225,0)
 S X=$S(STS?1"INP".E:"IMP",1:"AMB"),ENC("patientClass")=X,TYPE=$E(X)
"RTN","VPRDVSIT",226,0)
 S ENC("type")=U_$S(HLOC:$P(HLOC,U,2)_" VISIT",1:$$CATG(TYPE))
"RTN","VPRDVSIT",227,0)
 S ENC("serviceCategory")=TYPE_U_$$CATG(TYPE)
"RTN","VPRDVSIT",228,0)
 S ENC("visitString")=+HLOC_";"_DATE_";"_TYPE
"RTN","VPRDVSIT",229,0)
 Q
"RTN","VPRDVSIT",230,0)
 ;
"RTN","VPRDVSIT",231,0)
 ; ------------ Return data to middle tier ------------
"RTN","VPRDVSIT",232,0)
 ;
"RTN","VPRDVSIT",233,0)
XML(VISIT) ; -- Return patient visit as XML
"RTN","VPRDVSIT",234,0)
 N ATT,X,Y,NAMES,I,J
"RTN","VPRDVSIT",235,0)
 D ADD("<visit>") S VPRTOTL=$G(VPRTOTL)+1
"RTN","VPRDVSIT",236,0)
 S ATT="" F  S ATT=$O(VISIT(ATT)) Q:ATT=""  D  D:$L(Y) ADD(Y)
"RTN","VPRDVSIT",237,0)
 . I $O(VISIT(ATT,0)) D  S Y="" Q  ;multiples
"RTN","VPRDVSIT",238,0)
 .. D ADD("<"_ATT_"s>")
"RTN","VPRDVSIT",239,0)
 .. S I=0 F  S I=$O(VISIT(ATT,I)) Q:I<1  D
"RTN","VPRDVSIT",240,0)
 ... S X=$G(VISIT(ATT,I)),NAMES=""
"RTN","VPRDVSIT",241,0)
 ... I ATT="document" S NAMES="id^localTitle^nationalTitle^Z"
"RTN","VPRDVSIT",242,0)
 ... I ATT="provider" S NAMES="code^name^role^primary^Z"
"RTN","VPRDVSIT",243,0)
 ... S Y="<"_ATT_" "_$$LOOP ;_"/>" D ADD(Y)
"RTN","VPRDVSIT",244,0)
 ... S X=$G(VISIT(ATT,I,"content")) I '$L(X) S Y=Y_"/>" D ADD(Y) Q
"RTN","VPRDVSIT",245,0)
 ... S Y=Y_">" D ADD(Y)
"RTN","VPRDVSIT",246,0)
 ... S Y="<content xml:space='preserve'>" D ADD(Y)
"RTN","VPRDVSIT",247,0)
 ... S J=0 F  S J=$O(@X@(J)) Q:J<1  S Y=$$ESC^VPRD(@X@(J)) D ADD(Y)
"RTN","VPRDVSIT",248,0)
 ... D ADD("</content>"),ADD("</"_ATT_">")
"RTN","VPRDVSIT",249,0)
 .. D ADD("</"_ATT_"s>")
"RTN","VPRDVSIT",250,0)
 . S X=$G(VISIT(ATT)),Y="" Q:'$L(X)
"RTN","VPRDVSIT",251,0)
 . S NAMES="code^name^"_$S(ATT="reason":"narrative^",1:"")_"Z"
"RTN","VPRDVSIT",252,0)
 . I X'["^" S Y="<"_ATT_" value='"_$$ESC^VPRD(X)_"' />" Q
"RTN","VPRDVSIT",253,0)
 . I $L(X)>1 S Y="<"_ATT_" "_$$LOOP_"/>"
"RTN","VPRDVSIT",254,0)
 D ADD("</visit>")
"RTN","VPRDVSIT",255,0)
 Q
"RTN","VPRDVSIT",256,0)
 ;
"RTN","VPRDVSIT",257,0)
LOOP() ; -- build sub-items string from NAMES and X
"RTN","VPRDVSIT",258,0)
 N STR,P,TAG S STR=""
"RTN","VPRDVSIT",259,0)
 F P=1:1 S TAG=$P(NAMES,U,P) Q:TAG="Z"  I $L($P(X,U,P)) S STR=STR_TAG_"='"_$$ESC^VPRD($P(X,U,P))_"' "
"RTN","VPRDVSIT",260,0)
 Q STR
"RTN","VPRDVSIT",261,0)
 ;
"RTN","VPRDVSIT",262,0)
ADD(X) ; -- Add a line @VPR@(n)=X
"RTN","VPRDVSIT",263,0)
 S VPRI=$G(VPRI)+1
"RTN","VPRDVSIT",264,0)
 S @VPR@(VPRI)=X
"RTN","VPRDVSIT",265,0)
 Q
"VER")
8.0^22.0
"BLD",8062,6)
^1
**END**
**END**
