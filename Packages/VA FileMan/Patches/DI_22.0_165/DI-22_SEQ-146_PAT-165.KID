Released DI*22*165 SEQ #146
Extracted from mail message
**KIDS**:DI*22.0*165^

**INSTALL NAME**
DI*22.0*165
"BLD",774,0)
DI*22.0*165^VA FILEMAN^0^3110614^y
"BLD",774,1,0)
^^2^2^3100623^^^^
"BLD",774,1,1,0)
See patch DI*22*165 in the National Patch Module on FORUM for complete
"BLD",774,1,2,0)
information on this patch.
"BLD",774,4,0)
^9.64PA^^
"BLD",774,6)
7^
"BLD",774,6.3)
32
"BLD",774,"ABPKG")
n
"BLD",774,"INID")
^n
"BLD",774,"INIT")
POSTINIT^DIPR165
"BLD",774,"KRN",0)
^9.67PA^779.2^20
"BLD",774,"KRN",.4,0)
.4
"BLD",774,"KRN",.401,0)
.401
"BLD",774,"KRN",.402,0)
.402
"BLD",774,"KRN",.403,0)
.403
"BLD",774,"KRN",.5,0)
.5
"BLD",774,"KRN",.84,0)
.84
"BLD",774,"KRN",3.6,0)
3.6
"BLD",774,"KRN",3.8,0)
3.8
"BLD",774,"KRN",9.2,0)
9.2
"BLD",774,"KRN",9.8,0)
9.8
"BLD",774,"KRN",9.8,"NM",0)
^9.68A^15^13
"BLD",774,"KRN",9.8,"NM",1,0)
DICE^^0^B18028605
"BLD",774,"KRN",9.8,"NM",2,0)
DICF^^0^B33106724
"BLD",774,"KRN",9.8,"NM",3,0)
DICF4^^0^B21205416
"BLD",774,"KRN",9.8,"NM",6,0)
DIDT^^0^B22414014
"BLD",774,"KRN",9.8,"NM",7,0)
DINIT21^^0^B10884786
"BLD",774,"KRN",9.8,"NM",8,0)
DIC1^^0^B33532125
"BLD",774,"KRN",9.8,"NM",9,0)
DIC3^^0^B34032053
"BLD",774,"KRN",9.8,"NM",10,0)
DICM^^0^B34755435
"BLD",774,"KRN",9.8,"NM",11,0)
DIK1^^0^B14766986
"BLD",774,"KRN",9.8,"NM",12,0)
DICUIX^^0^B19486149
"BLD",774,"KRN",9.8,"NM",13,0)
DIDTC^^0^B31993211
"BLD",774,"KRN",9.8,"NM",14,0)
DDBR^^0^B25668351
"BLD",774,"KRN",9.8,"NM",15,0)
DICU2^^0^B28509022
"BLD",774,"KRN",9.8,"NM","B","DDBR",14)

"BLD",774,"KRN",9.8,"NM","B","DIC1",8)

"BLD",774,"KRN",9.8,"NM","B","DIC3",9)

"BLD",774,"KRN",9.8,"NM","B","DICE",1)

"BLD",774,"KRN",9.8,"NM","B","DICF",2)

"BLD",774,"KRN",9.8,"NM","B","DICF4",3)

"BLD",774,"KRN",9.8,"NM","B","DICM",10)

"BLD",774,"KRN",9.8,"NM","B","DICU2",15)

"BLD",774,"KRN",9.8,"NM","B","DICUIX",12)

"BLD",774,"KRN",9.8,"NM","B","DIDT",6)

"BLD",774,"KRN",9.8,"NM","B","DIDTC",13)

"BLD",774,"KRN",9.8,"NM","B","DIK1",11)

"BLD",774,"KRN",9.8,"NM","B","DINIT21",7)

"BLD",774,"KRN",19,0)
19
"BLD",774,"KRN",19,"NM",0)
^9.68A^^
"BLD",774,"KRN",19.1,0)
19.1
"BLD",774,"KRN",101,0)
101
"BLD",774,"KRN",409.61,0)
409.61
"BLD",774,"KRN",771,0)
771
"BLD",774,"KRN",779.2,0)
779.2
"BLD",774,"KRN",870,0)
870
"BLD",774,"KRN",8989.51,0)
8989.51
"BLD",774,"KRN",8989.52,0)
8989.52
"BLD",774,"KRN",8994,0)
8994
"BLD",774,"KRN","B",.4,.4)

"BLD",774,"KRN","B",.401,.401)

"BLD",774,"KRN","B",.402,.402)

"BLD",774,"KRN","B",.403,.403)

"BLD",774,"KRN","B",.5,.5)

"BLD",774,"KRN","B",.84,.84)

"BLD",774,"KRN","B",3.6,3.6)

"BLD",774,"KRN","B",3.8,3.8)

"BLD",774,"KRN","B",9.2,9.2)

"BLD",774,"KRN","B",9.8,9.8)

"BLD",774,"KRN","B",19,19)

"BLD",774,"KRN","B",19.1,19.1)

"BLD",774,"KRN","B",101,101)

"BLD",774,"KRN","B",409.61,409.61)

"BLD",774,"KRN","B",771,771)

"BLD",774,"KRN","B",779.2,779.2)

"BLD",774,"KRN","B",870,870)

"BLD",774,"KRN","B",8989.51,8989.51)

"BLD",774,"KRN","B",8989.52,8989.52)

"BLD",774,"KRN","B",8994,8994)

"BLD",774,"PRE")
DIPR165
"BLD",774,"QUES",0)
^9.62^^
"BLD",774,"REQB",0)
^9.611^6^5
"BLD",774,"REQB",2,0)
DI*22.0*58^1
"BLD",774,"REQB",3,0)
DI*22.0*162^1
"BLD",774,"REQB",4,0)
DI*22.0*160^1
"BLD",774,"REQB",5,0)
DI*22.0*164^1
"BLD",774,"REQB",6,0)
DI*22.0*122^1
"BLD",774,"REQB","B","DI*22.0*122",6)

"BLD",774,"REQB","B","DI*22.0*160",4)

"BLD",774,"REQB","B","DI*22.0*162",3)

"BLD",774,"REQB","B","DI*22.0*164",5)

"BLD",774,"REQB","B","DI*22.0*58",2)

"INIT")
POSTINIT^DIPR165
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3080318^1163
"PKG",5,22,1,"PAH",1,0)
165^3110614^1163
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3110614
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*165 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"PRE")
DIPR165
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","DDBR")
0^14^B25668351^B25667508
"RTN","DDBR",1,0)
DDBR ;SFISC/DCL-VA FILEMAN BROWSER ;4MAY2011
"RTN","DDBR",2,0)
 ;;22.0;VA FileMan;**165**;Mar 30, 1999;Build 32
"RTN","DDBR",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DDBR",4,0)
EN N DDBC,DDBFLG,DDBL,DDBPMSG,DDBSA,DDBX,IOTM,IOBM
"RTN","DDBR",5,0)
 I '$$TEST^DDBRT W $C(7),!!,"This terminal does not support scroll region or reverse index",!! Q
"RTN","DDBR",6,0)
 D LIST^DDBR3(.DDBX)
"RTN","DDBR",7,0)
 I DDBX'>0 W:DDBX=0 $C(7),!!,"No Text",!! Q
"RTN","DDBR",8,0)
 S DDBSA=DDBX(6)
"RTN","DDBR",9,0)
 S DDBFLG=DDBX(4)
"RTN","DDBR",10,0)
 S DDBPMSG=DDBX(5)
"RTN","DDBR",11,0)
 D CONTNU
"RTN","DDBR",12,0)
 D KTMP^DDBRU
"RTN","DDBR",13,0)
 Q
"RTN","DDBR",14,0)
WP(DDBFN,DDBRN,DDBFLD,DDBFLG,DDBPMSG,DDBL,DDBC,IOTM,IOBM) N DDBSA
"RTN","DDBR",15,0)
 S DDBSA=$$GET^DIQG($G(DDBFN),$G(DDBRN),$G(DDBFLD),"B")
"RTN","DDBR",16,0)
 I $G(DIERR) D CLEAN Q
"RTN","DDBR",17,0)
 S DDBSA=$P(DDBSA,"$CREF$",2)
"RTN","DDBR",18,0)
 I DDBSA']"" D ERR("FILE, RECORD and/or FIELD") Q
"RTN","DDBR",19,0)
 I '$D(@DDBSA) D ERR("SOURCE ARRAY") Q
"RTN","DDBR",20,0)
 I $G(DDBFLG)["A" D
"RTN","DDBR",21,0)
 .N DDBSAN
"RTN","DDBR",22,0)
 .S DDBSAN=$$NROOT^DDBRAP($NA(@DDBSA))
"RTN","DDBR",23,0)
 .I '$D(@DDBSAN) D WP^DDBRAP($NA(@DDBSA))
"RTN","DDBR",24,0)
 .Q:$G(DDBPMSG)]""
"RTN","DDBR",25,0)
 .I $D(@DDBSAN@("TITLE")) S DDBPMSG=@DDBSAN@("TITLE") Q
"RTN","DDBR",26,0)
 .Q
"RTN","DDBR",27,0)
 S DDBPMSG=$S($G(DDBPMSG)]"":DDBPMSG,1:"VA FileMan Browser (wp) DOCUMENT 1")
"RTN","DDBR",28,0)
 D CONTNU
"RTN","DDBR",29,0)
 D:$G(DDBFLG)'["P" KTMP^DDBRU
"RTN","DDBR",30,0)
 Q
"RTN","DDBR",31,0)
BROWSE(DDBSA,DDBFLG,DDBPMSG,DDBL,DDBC,IOTM,IOBM) N DDBRLIST
"RTN","DDBR",32,0)
CONTNU I $G(U)'="^" N U S U="^"
"RTN","DDBR",33,0)
 I $G(DDBFLG)["A" D
"RTN","DDBR",34,0)
 .N DDBSAN
"RTN","DDBR",35,0)
 .S DDBSAN=$$NROOT^DDBRAP($NA(@DDBSA))
"RTN","DDBR",36,0)
 .I '$D(@DDBSAN) D WP^DDBRAP($NA(@DDBSA))
"RTN","DDBR",37,0)
 .Q:$G(DDBPMSG)]""
"RTN","DDBR",38,0)
 .I $D(@DDBSAN@("TITLE")) S DDBPMSG=@DDBSAN@("TITLE") Q
"RTN","DDBR",39,0)
 .Q
"RTN","DDBR",40,0)
 S DDBPMSG=$S($G(DDBPMSG)]"":DDBPMSG,1:"VA FileMan Browser DOCUMENT 1")
"RTN","DDBR",41,0)
 N %,D,DX,IOP,XY,X,Y
"RTN","DDBR",42,0)
 D:$G(DDBFLG)'["H" INIT I $G(DIERR) D CLEAN Q
"RTN","DDBR",43,0)
 I $G(DDBSA)']"" D ERR("SOURCE ARRAY") Q
"RTN","DDBR",44,0)
 I '$D(@DDBSA) D ERR("SOURCE ARRAY") Q
"RTN","DDBR",45,0)
 I $G(DDBFLG)'["N",DDBSA'="^TMP(""DDB"",$J)" D
"RTN","DDBR",46,0)
 .I $NA(@DDBSA)=$NA(^TMP("DDB",$J)) S DDBSA="^TMP(""DDB"",$J)" Q
"RTN","DDBR",47,0)
 .K ^TMP("DDB",$J)
"RTN","DDBR",48,0)
 .D XY^%RCR($$OREF(DDBSA),"^TMP(""DDB"",$J,")
"RTN","DDBR",49,0)
 .;M ^TMP("DDB",$J)=@DDBSA
"RTN","DDBR",50,0)
 .S DDBSA="^TMP(""DDB"",$J)"
"RTN","DDBR",51,0)
 .Q
"RTN","DDBR",52,0)
 N DDBRE,DDBRPE,DDBPSA,DDBTO,DDBDM,DDBFNO,I,DDBFLGS,DDBRHT,DDBRHTF
"RTN","DDBR",53,0)
 N DDBHDR,DDBHDRC,DDBFTR,DDBSP,DDBSF,DDBST,DDBTL,DDBTPG,DDBZN
"RTN","DDBR",54,0)
 I '$G(DDBRLIST) N DDBSRL,DDBSX,DDBSY,DDBRSA
"RTN","DDBR",55,0)
 S DDBFTR=$E("Col>     |<PF1>H=Help <PF1>E=Exit| Line>                 Screen>"_$J("",IOM),1,IOM)
"RTN","DDBR",56,0)
 I '$G(DDBRLIST) S IOBM=$S($G(IOBM)>0:IOBM,1:$G(IOSL,24))-1,IOTM=$S($G(IOTM)>0:IOTM,1:1)+1
"RTN","DDBR",57,0)
 S DDBRSA=0
"RTN","DDBR",58,0)
 D TB^DDBRS(.IOTM,.IOBM,.DDBRSA)
"RTN","DDBR",59,0)
 S DDBSX="0;4;40;65"
"RTN","DDBR",60,0)
 S DDBSY=DDBRSA(0,"DDBSY")
"RTN","DDBR",61,0)
 I IOBM>(IOSL-1) D ERR("BOTTOM MARGIN") Q
"RTN","DDBR",62,0)
 I IOTM<2 D ERR("TOP MARGIN") Q
"RTN","DDBR",63,0)
 I IOBM'>IOTM D ERR("TOP & BOTTOM MARGINS") Q
"RTN","DDBR",64,0)
 S DDBSRL=DDBRSA(0,"DDBSRL")
"RTN","DDBR",65,0)
 I DDBSRL'>4,$G(DDBFLG)'["H" D ERR("SCROLL REGION (TOO SMALL)") Q
"RTN","DDBR",66,0)
 I DDBRSA(1,"DDBSRL")'>4 K DDBRSA(1),DDBRSA(2)
"RTN","DDBR",67,0)
 S DDBHDR=$$CTXT(DDBPMSG,$J("",IOM+1),IOM),DDBHDRC=0
"RTN","DDBR",68,0)
 S DDBTL=$P($G(@DDBSA@(0)),"^",3) S:DDBTL'>0 DDBTL=$O(@DDBSA@(" "),-1)
"RTN","DDBR",69,0)
 I DDBTL'>0 D  I DDBTL'>0 D BLD^DIALOG(1700,"*NO TEXT*"_DDBSA) D CLEAN Q
"RTN","DDBR",70,0)
 .N I S I=0 F  S I=$O(@DDBSA@(I)) Q:I'>0  S DDBTL=I
"RTN","DDBR",71,0)
 .Q
"RTN","DDBR",72,0)
 S DDBZN=$D(@DDBSA@(DDBTL,0))#2,DDBTPG=DDBTL\DDBSRL+(DDBTL#DDBSRL'<1),DDBSF=1,DDBST=IOM
"RTN","DDBR",73,0)
 S DDBDM=DDBSA="^TMP(""DDB"",$J)"
"RTN","DDBR",74,0)
 I $G(DDBC)=+$G(DDBC) D ERR("TAB (Closed Array Root)") Q
"RTN","DDBR",75,0)
 S:$G(DDBC)="" DDBC="^TMP(""DDBC"",$J)"
"RTN","DDBR",76,0)
 I '$D(@DDBC) F I=1,22:22:176 S @DDBC@(I)=""
"RTN","DDBR",77,0)
 I $D(@DDBC@(1))'>9 N DDBC0,DDBC1 S @DDBC@(1)="",DDBC1=1,DDBC0=DDBC
"RTN","DDBR",78,0)
 S DDBPSA=0,DDBFLG=$G(DDBFLG)
"RTN","DDBR",79,0)
 S DDBFLGS=DDBFLG["S",DDBRHTF=DDBFLG["A"
"RTN","DDBR",80,0)
 I DDBRHTF S $E(DDBFTR,1,9)="HYPER-TXT"
"RTN","DDBR",81,0)
 G EN^DDBRGE
"RTN","DDBR",82,0)
DOCLIST(DDBDSA,DDBFLG,IOTM,IOBM) S IOP="HOME" D ^%ZIS
"RTN","DDBR",83,0)
 N DDBPMSG,DDBL,DDBC,DDBSA,DDBSRL,DDBSX,DDBSY,DDBRSA,DDBRLIST
"RTN","DDBR",84,0)
 S IOBM=$S($G(IOBM)>0:IOBM,1:$G(IOSL,24))-1,IOTM=$S($G(IOTM)>0:IOTM,1:1)+1
"RTN","DDBR",85,0)
 S DDBSX="0;4;40;65"
"RTN","DDBR",86,0)
 S DDBSY=(IOTM-2)_";"_(IOTM-1)_";"_(IOBM-1)_";"_(IOBM)  ;hdr,txttop,txtbot,ftr
"RTN","DDBR",87,0)
 I IOBM>(IOSL-1) D ERR("BOTTOM MARGIN") Q
"RTN","DDBR",88,0)
 I IOTM<2 D ERR("TOP MARGIN") Q
"RTN","DDBR",89,0)
 I IOBM'>IOTM D ERR("TOP & BOTTOM MARGINS") Q
"RTN","DDBR",90,0)
 S DDBSRL=(IOBM-IOTM)+1  ;scroll region lines
"RTN","DDBR",91,0)
 I '$D(@DDBDSA) D ERR("DOCUMENT ARRAY INVALID") Q
"RTN","DDBR",92,0)
 S DDBFLG=$TR($G(DDBFLG),"P")_"N"
"RTN","DDBR",93,0)
 S DDBPMSG=$O(@DDBDSA@("")) S:DDBPMSG]"" DDBSA=@DDBDSA@(DDBPMSG)
"RTN","DDBR",94,0)
 I DDBPMSG']""!(DDBSA']"") D ERR("DOCUMENT ARRAY INVALID") Q
"RTN","DDBR",95,0)
 D  I $G(DIERR) K ^TMP("DDBLST",$J) D CLEAN Q
"RTN","DDBR",96,0)
 .N DOC,DOCSA
"RTN","DDBR",97,0)
 .S DOC=""
"RTN","DDBR",98,0)
 .K ^TMP("DDBLST",$J)
"RTN","DDBR",99,0)
 .F  S DOC=$O(@DDBDSA@(DOC)) Q:DOC=""  D
"RTN","DDBR",100,0)
 ..S DOCSA=@DDBDSA@(DOC)
"RTN","DDBR",101,0)
 ..D LOADCL^DDBR4(DOCSA,"",DOC)
"RTN","DDBR",102,0)
 ..Q
"RTN","DDBR",103,0)
 .Q
"RTN","DDBR",104,0)
 Q:$G(DDBENDR)
"RTN","DDBR",105,0)
 S DDBRLIST=1
"RTN","DDBR",106,0)
 G CONTNU
"RTN","DDBR",107,0)
RTN G DR^DDBRU
"RTN","DDBR",108,0)
ROOT G EN^DDBRU2
"RTN","DDBR",109,0)
CTXT(X,T,W) Q:X="" $G(T)
"RTN","DDBR",110,0)
 N HW
"RTN","DDBR",111,0)
 S W=$G(W,79),HW=W\2
"RTN","DDBR",112,0)
 S $E(T,HW-($L(X)\2),HW-($L(X)\2)+$L(X))=X Q $E(T,1,W)
"RTN","DDBR",113,0)
OREF(X) N X1,X2 S X1=$P(X,"(")_"(",X2=$$OR2($P(X,"(",2)) Q:X2="" X1 Q X1_X2_","
"RTN","DDBR",114,0)
OR2(%) Q:%=")"!(%=",") "" Q:$L(%)=1 %  S:"),"[$E(%,$L(%)) %=$E(%,1,$L(%)-1) Q %
"RTN","DDBR",115,0)
INIT I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DDBR",116,0)
 D INIT^DDGLIB0()
"RTN","DDBR",117,0)
 I $G(DIERR) Q
"RTN","DDBR",118,0)
 I '$D(IOSTBM)!('$D(IORI)) S X="IOSTBM;IORI" D ENDR^%ZISS
"RTN","DDBR",119,0)
 D:$G(IOSTBM)="" TRMERR^DDGLIB0("Set top and bottom margins")
"RTN","DDBR",120,0)
 D:$G(IORI)="" TRMERR^DDGLIB0("Reverse index")
"RTN","DDBR",121,0)
 Q
"RTN","DDBR",122,0)
ERR(DDBERR) N P S P(1)=DDBERR
"RTN","DDBR",123,0)
 I $G(U)="^" N U S U="^"
"RTN","DDBR",124,0)
 D BLD^DIALOG(202,.P),OUT^DDBRU:$D(DDGLDEL)
"RTN","DDBR",125,0)
CLEAN D:'$D(DDS) KILL^DDGLIB0($G(DDBFLG))
"RTN","DDBR",126,0)
 Q
"RTN","DIC1")
0^8^B33532125^B33524054
"RTN","DIC1",1,0)
DIC1 ;SFISC/GFT/TKW-READ X, SHOW CHOICES ;29SEP2010
"RTN","DIC1",2,0)
 ;;22.0;VA FileMan;**1,4,17,20,31,48,78,86,70,122,165**;Mar 30, 1999;Build 32
"RTN","DIC1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DIC1",4,0)
 K DUOUT,DTOUT N DD,DIY,DISUB,DIPRMT
"RTN","DIC1",5,0)
 D GETFA(.DIC,.DO)
"RTN","DIC1",6,0)
 N DIPRMT D GETPRMT^DIC11(.DIC,.DO,.DINDEX,.DIPRMT)
"RTN","DIC1",7,0)
B I $D(DIC("B")) D
"RTN","DIC1",8,0)
 . N B S B(1)=$G(DIC("B")) M B=DIC("B")
"RTN","DIC1",9,0)
 . N DIGBL,DINONULL S DIGBL=DIC_""""_DINDEX_"""",DINONULL=1
"RTN","DIC1",10,0)
 . F DISUB=1:1:DINDEX("#") D  S:B]"" DIY(DISUB)=B
"RTN","DIC1",11,0)
 . . S B=$G(B(DISUB)) I B="" S DINONULL=0 Q
"RTN","DIC1",12,0)
 . . S X="" S:DINONULL X=$O(@(DIGBL_",B)"))
"RTN","DIC1",13,0)
 . . S B=$S($D(^(B)):B,$F(X,B)-1=$L(B):X,$D(@(DIC_"B,0)")):$P(^(0),U),1:B)
"RTN","DIC1",14,0)
 . . N B1 S B1=B I "VPD"[DINDEX(DISUB,"TYPE") D
"RTN","DIC1",15,0)
 . . . I B D  Q:$D(DIY(DISUB,"EXT"))
"RTN","DIC1",16,0)
 . . . . N TYPE S TYPE=DINDEX(DISUB,"TYPE")
"RTN","DIC1",17,0)
 . . . . I TYPE="D" Q:B'?7N.1".".N
"RTN","DIC1",18,0)
 . . . . I TYPE="P" Q:B'?.N.1".".N
"RTN","DIC1",19,0)
 . . . . I TYPE="V" Q:B'?1.N.1".".N1";".E
"RTN","DIC1",20,0)
 . . . . S DIY(DISUB,"EXT")=$$EXT^DIC2(DINDEX(DISUB,"FILE"),DINDEX(DISUB,"FIELD"),B)
"RTN","DIC1",21,0)
 . . . . S:TYPE="P" B=DIY(DISUB,"EXT") Q
"RTN","DIC1",22,0)
 . . . D CHK^DIE(DINDEX(DISUB,"FILE"),DINDEX(DISUB,"FIELD"),"",B,.B1,"DIERROR") S:$G(DIERROR) B1=B
"RTN","DIC1",23,0)
 . . . K DIERROR,DIERR Q
"RTN","DIC1",24,0)
 . . S:DINONULL DIGBL=DIGBL_","_$S(+$P(B1,"E")=B1:B1,1:""""_B1_"""")
"RTN","DIC1",25,0)
 . . Q
"RTN","DIC1",26,0)
 . Q
"RTN","DIC1",27,0)
PROMPT ; Prompt user for lookup values
"RTN","DIC1",28,0)
 D PROMPT^DIC11
"RTN","DIC1",29,0)
 Q
"RTN","DIC1",30,0)
 ;
"RTN","DIC1",31,0)
 ;
"RTN","DIC1",32,0)
GETFA(DIC,DO) ; Get file attributes
"RTN","DIC1",33,0)
 ; DIC is open global reference, output same as documented in DO^DIC1.
"RTN","DIC1",34,0)
 D DO Q
"RTN","DIC1",35,0)
 ;
"RTN","DIC1",36,0)
DO ; GET FILE ATTR
"RTN","DIC1",37,0)
 Q:$D(DO(2))  I $D(@(DIC_"0)")) S DO=^(0)
"RTN","DIC1",38,0)
 E  S DO="0^-1" I $D(DIC("P")) S DO=U_DIC("P"),^(0)=DO
"RTN","DIC1",39,0)
DO2 S DO(2)=$P(DO,U,2) I DO?1"^".E S DO=$O(^DD(+DO(2),0,"NM",0))_DO
"RTN","DIC1",40,0)
 I DO(2)["s",$D(^DD(+DO(2),0,"SCR")) S DO("SCR")=^("SCR")
"RTN","DIC1",41,0)
 Q:$D(DIC("W"))  Q:DO(2)'["I"  Q:'$D(^DD(+DO(2),0,"ID"))
"RTN","DIC1",42,0)
 S DIC("W")=""
"RTN","DIC1",43,0)
P ; Add code to DIC("W") to display identifiers on pointed-to files
"RTN","DIC1",44,0)
 I DO(2)["P" D WOV,PTRID^DIC5(.DO,.DIC) Q
"RTN","DIC1",45,0)
 N % S %=0
"RTN","DIC1",46,0)
 ;
"RTN","DIC1",47,0)
W F  S %=$O(^DD(+DO(2),0,"ID",%)) D:%]""  Q:%=""
"RTN","DIC1",48,0)
 . N X S X=^DD(+DO(2),0,"ID",%) Q:X="W """""
"RTN","DIC1",49,0)
 . I $L(DIC("W"))+$L(X)>224 D WOV S %="" Q
"RTN","DIC1",50,0)
 . I DIC("W")="" S DIC("W")="N C,DINAME"
"RTN","DIC1",51,0)
 . S DIC("W")=DIC("W")_" W ""  "" "_X
"RTN","DIC1",52,0)
 . Q
"RTN","DIC1",53,0)
 Q
"RTN","DIC1",54,0)
 ;
"RTN","DIC1",55,0)
WOV S DIC("W")="N DIFILEI,DIEN,DIGBL S DIFILEI=+DO(2),DIEN=Y,DIGBL=DIC D WOV^DICQ1"
"RTN","DIC1",56,0)
 Q
"RTN","DIC1",57,0)
 ;
"RTN","DIC1",58,0)
RENUM ;
"RTN","DIC1",59,0)
 D GETFA(.DIC,.DO)
"RTN","DIC1",60,0)
 I '$D(DF),X?.NP,^DD(+DO(2),.01,0)["DINUM",$D(@(DIC_"X)")) D  Q:Y>0
"RTN","DIC1",61,0)
 . S Y=X D S^DIC3 I $T N DZ D ADDKEY^DIC3,GOT^DIC2 Q
"RTN","DIC1",62,0)
 . S Y=-1 Q
"RTN","DIC1",63,0)
 D F^DIC Q
"RTN","DIC1",64,0)
 ;
"RTN","DIC1",65,0)
DT S DST=DST_$$FMTE^DILIBF(%,"7S")
"RTN","DIC1",66,0)
 I '$D(DDS) W DST S DST=""
"RTN","DIC1",67,0)
 Q
"RTN","DIC1",68,0)
 ;
"RTN","DIC1",69,0)
Y ; Display a list of entries
"RTN","DIC1",70,0)
 N DD,DDD,DDC,DDH,DIOUT S DIY="",DIOUT=0,DD=DS("DD")
"RTN","DIC1",71,0)
 I DD=0,DIC(0)["T",DIC(0)["E" D DSPH^DIC0
"RTN","DIC1",72,0)
 F  S DD=$O(DS(DD)) Q:'DD  D  Q:DIOUT
"RTN","DIC1",73,0)
 . S DDH=DD-1,DIYX=0,DS("DD")=DD
"RTN","DIC1",74,0)
 . I DIC(0)["E" W:'$D(DDS) !?5,DD,?9 D
"RTN","DIC1",75,0)
 . . N Y S Y=+DS(DD)
"RTN","DIC1",76,0)
 . . D E Q
"RTN","DIC1",77,0)
 . I DIC(0)["Y" Q:DD<DS  D
"RTN","DIC1",78,0)
 . . F Y=DS:-1 Q:'$G(DS(Y))  S Y(+DS(Y))=""
"RTN","DIC1",79,0)
 . . Q
"RTN","DIC1",80,0)
 . I DIC(0)'["E"!(DIC(0)["Y") S DS(0)="1^",DIOUT=1,DIY="" Q
"RTN","DIC1",81,0)
 . I DS>DD Q:DD#5
"RTN","DIC1",82,0)
 . S DIOUT=1
"RTN","DIC1",83,0)
 . I $D(DDS) S DDD=2,DDC=5 D LIST^DDSU K DDD,DDC
"RTN","DIC1",84,0)
 . I '$D(DDS) D
"RTN","DIC1",85,0)
 . . I DS>DD W !,"Press <RETURN> to see more, '^' to exit this list,"_$S(DIC(0)["T":" '^^' to exit all lists,",1:"")_" OR" ;**122**
"RTN","DIC1",86,0)
 . . W !,"CHOOSE "_$O(DS(0))_"-"_DD R ": ",DIY:$S($D(DTIME):DTIME,1:300) S:'$T DTOUT=1 Q
"RTN","DIC1",87,0)
 . I $G(DTOUT) W $C(7) S X="" Q
"RTN","DIC1",88,0)
 . I DIY[U!($G(DUOUT)) S DUOUT=1,X=U D  Q
"RTN","DIC1",89,0)
 . . I DIY?1"^^".E,DIC(0)["T" S DIROUT=1 Q
"RTN","DIC1",90,0)
 . . I DIY?1"^".E,DIC(0)["E",DIC(0)'["T" S DIROUT=1 Q
"RTN","DIC1",91,0)
 . Q
"RTN","DIC1",92,0)
 I DIY?1.N.1".".N D  I DIY,DIY'>DD,$G(DS(DIY)) S Y=+DS(DIY) D GOT S DS(0)=1_"^"_+Y Q
"RTN","DIC1",93,0)
 . S:($L($P(DIY,"."))>25!($L($P(DIY,".",2))>25)) DIY="-1" Q
"RTN","DIC1",94,0)
 I $L(DIY)>25 S DIY=-1
"RTN","DIC1",95,0)
 N I S I=$S($G(DUOUT):"1^U",$G(DTOUT):"1^T",DIY?1."?":"1^?",DIY:1,1:"")
"RTN","DIC1",96,0)
 I 'I,DIY]"",+$P(DIY,"E")'=DIY,'$G(DICR),DINDEX("#")=1 S I="2^"_DIY
"RTN","DIC1",97,0)
 Q:'I
"RTN","DIC1",98,0)
 S DS(0)=I,Y=-1
"RTN","DIC1",99,0)
 I DIY?1."?" D
"RTN","DIC1",100,0)
 . I (DIC(0)_$G(DICR(1,0)))'["A",$D(DICRS) Q
"RTN","DIC1",101,0)
 . N X,Y,DS D DSPHLP^DICQ(.DIC,.DIFILEI,.DINDEX,"?",1)
"RTN","DIC1",102,0)
 K DIY,DIYX Q
"RTN","DIC1",103,0)
 ;
"RTN","DIC1",104,0)
E S DST="" D
"RTN","DIC1",105,0)
 . Q:DIC(0)["U"
"RTN","DIC1",106,0)
 . I $O(DS(DD,0)) S DST=$$BLDDSP(.DS,DD) Q
"RTN","DIC1",107,0)
 . S %=$S($G(DILONGX):DICR(DILONGX,"ORG"),$G(DINDEX("IXTYPE"))'="S":$P(X,U),1:"")
"RTN","DIC1",108,0)
 . S %=%_$P(DS(DD),U,2,9)_$S($G(DIYX(DD)):DIY(DD),1:"")
"RTN","DIC1",109,0)
 . I ($G(DITRANX)!($G(DICRS))),$G(DINDEX(1,"TRANOUT"))]"",%]"" D  Q
"RTN","DIC1",110,0)
 . . N X S X=% X DINDEX(1,"TRANOUT") S DST=$G(X) Q
"RTN","DIC1",111,0)
 . I +$P(%,"E")=%,$D(DIDA) D DT Q
"RTN","DIC1",112,0)
 . I $G(DICRS),$G(DINDEX("IXTYPE"))="R" D
"RTN","DIC1",113,0)
 . . N F1,F2 S F1=$G(DINDEX(1,"FILE")),F2=$G(DINDEX(1,"FIELD"))
"RTN","DIC1",114,0)
 . . I F1,F2 S %=$$EXT^DIC2(F1,F2,%,"h")
"RTN","DIC1",115,0)
 . . Q
"RTN","DIC1",116,0)
 . S DST=% Q
"RTN","DIC1",117,0)
 I DIC(0)["s" S DIC(0)=$TR(DIC(0),"s")
"RTN","DIC1",118,0)
 I $D(DS(DD,"K")) S %=$G(DIX) M DIX=DS(DD) S DIX=%
"RTN","DIC1",119,0)
 S DIY=$S($G(DIYX(DD)):"",1:DIY(DD)) D WO^DIC2 Q
"RTN","DIC1",120,0)
 ;
"RTN","DIC1",121,0)
BLDDSP(DS,DD,DINDXFL,DIYX,DIY,DICRS) ; Build display of index values
"RTN","DIC1",122,0)
 N X,I S X=""
"RTN","DIC1",123,0)
 F I=0:0 S I=$O(DS(DD,I)) Q:'I  D
"RTN","DIC1",124,0)
 . I $L(X)+$L(DS(DD,I))>240 Q
"RTN","DIC1",125,0)
 . I I=1,$G(DINDXFL) S X=$P(DS(1),U,2,99)_$S($G(DIYX(1)):$G(DIY(1)),1:"") Q
"RTN","DIC1",126,0)
 . I I=1,$G(DICRS) Q
"RTN","DIC1",127,0)
 . S X=X_$P("  ^",U,I>1)_DS(DD,I) Q
"RTN","DIC1",128,0)
 Q X
"RTN","DIC1",129,0)
 ;
"RTN","DIC1",130,0)
GOT ; Set data for single entry selected by user.
"RTN","DIC1",131,0)
 N I,J,K
"RTN","DIC1",132,0)
 I DIY(DIY)="" S DIY(DIY)=$P($G(@(DIC_"Y,0)")),U)
"RTN","DIC1",133,0)
 S:$D(DDS) DST=X_$P(DS(DIY),U,2,9)_$S($G(DIYX(DIY)):$G(DIY(DIY)),1:"")
"RTN","DIC1",134,0)
 S K=$O(DIVPSEL("A"),-1) I K]"" S DIVPSEL(K)=Y
"RTN","DIC1",135,0)
 I $G(DIFINDR) D  Q
"RTN","DIC1",136,0)
 . S:$D(DDS) DS(0,"DST")=DST
"RTN","DIC1",137,0)
 . S DS(0,"Y")=+DS(DIY),DS(0,"X")=X_$P(DS(DIY),"^",2),DS(0,"DIYX")=$G(DIYX(DIY)),DS(0,"DIY")=DIY(DIY)
"RTN","DIC1",138,0)
 . M DS(0,1)=DS(DIY)
"RTN","DIC1",139,0)
 . Q
"RTN","DIC1",140,0)
 I $G(DIYX(DIY)) K DIYX S DIY(DIY)=$P($G(@(DIC_"Y,0)")),U)
"RTN","DIC1",141,0)
 D C^DIC2 Q
"RTN","DIC1",142,0)
 ;
"RTN","DIC1",143,0)
OK ;
"RTN","DIC1",144,0)
 S %=1 I $G(DS)=1 S DST="         ...OK" D Y^DICN W:'$D(DDS) !
"RTN","DIC1",145,0)
 I %>0 Q:%=1  D  S X=$G(DIX),Y=-1 Q  ;%=1=Yes, %=2=No
"RTN","DIC1",146,0)
 . I $G(DICR) S DICR(DICR,31.2)=+Y ;Preserve IEN for future reference
"RTN","DIC1",147,0)
 . I +$G(DS) K DS S (DS,DS(0),DS("DD"))=0 ;ReInit Display array
"RTN","DIC1",148,0)
 . Q
"RTN","DIC1",149,0)
 I %=0 W !?4,$$EZBLD^DIALOG(8040),! G OK ;User asked for Help
"RTN","DIC1",150,0)
 I %=-1,$D(DTOUT) S DIROUT=1 ;User TIMED Out; DTOUT set in DICN
"RTN","DIC1",151,0)
 I %=-1,'$D(DTOUT) S (DUOUT,DIROUT)=1 ;User single up-arrowed out
"RTN","DIC1",152,0)
BAD S Y=-1
"RTN","DIC1",153,0)
 I $G(%Y)?1"^^".E S (DIROUT,DUOUT)=1
"RTN","DIC1",154,0)
 S DS(0)=$S($G(DTOUT):"1^T",$G(DUOUT):"1^U",$G(%)=-1:"1^U",1:"1^") Q
"RTN","DIC1",155,0)
MIX ;
"RTN","DIC1",156,0)
 N DID S DID=D_"^-1",DID(1)=2
"RTN","DIC1",157,0)
 N D S D=$P(DID,U)
"RTN","DIC1",158,0)
 G IX^DIC
"RTN","DIC1",159,0)
 ;
"RTN","DIC1",160,0)
 ;#8042  Select |filename|:
"RTN","DIC1",161,0)
 ;#8040   Answer with 'Yes' or 'No'
"RTN","DIC3")
0^9^B34032053^B33944165
"RTN","DIC3",1,0)
DIC3 ;SFISC/XAK,TKW,SEA/TOAD-VA FileMan: Lookup, Part 1 (called from DIC) ;28SEP2010
"RTN","DIC3",2,0)
 ;;22.0;VA FileMan;**1,16,4,17,20,28,40,86,70,159,164,165**;Mar 30, 1999;Build 32
"RTN","DIC3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DIC3",4,0)
 ;
"RTN","DIC3",5,0)
SEARCH ; Begin search through x-refs.
"RTN","DIC3",6,0)
 I DIC(0)["T",'$G(DICR) N:'$D(DICR(1)) DICR S DICR=0 D:DIC(0)["O"
"RTN","DIC3",7,0)
 . I DIC(0)'["X" S DIC(0)=DIC(0)_"X" Q
"RTN","DIC3",8,0)
 . S DIC(0)=$TR(DIC(0),"X") Q
"RTN","DIC3",9,0)
 I X?1"`".NP D ^DICM Q
"RTN","DIC3",10,0)
 I $L(X)>DINDEX(1,"LENGTH"),'$G(DILONGX) D ^DICM Q
"RTN","DIC3",11,0)
 N DIOK,DIEXACTN K % I $G(DISKIPIX)=D K DISKIPIX G M
"RTN","DIC3",12,0)
EXACT ; Find all exact matches to the lookup values
"RTN","DIC3",13,0)
 S DISAVDS=DS,DIEXACTN=0
"RTN","DIC3",14,0)
 I $G(DILONGX) D  ;G:$L(DICR(DICR,"ORG"))'>DINDEX(1,"LENGTH") M D  ;JUMPED AWAY FROM USING THIS INDEX, EVEN THOUGH IT MIGHT NEVER HAVE BEEN TRIED BEFORE
"RTN","DIC3",15,0)
 . S (X,X(1),DIVAL,DIVAL(1))=$E(DICR(DILONGX,"ORG"),1,DINDEX(1,"LENGTH")) ;TRIM LOOKUP VALUE DOWN TO SIZE!
"RTN","DIC3",16,0)
 I DINDEX("#")>1,($G(DIALLVAL)!($G(DICR))),(DIC(0)["X"!(DIC(0)["O")) D EXACT^DIC4,SET^DIC4
"RTN","DIC3",17,0)
 I DINDEX("#")'>1 S Y=0,DIX=X F  D MOREX Q:Y=-1!(DS(0))
"RTN","DIC3",18,0)
 I DS(0) Q:DIC(0)'["T"  Q:$P(DS(0),U,2)'="U"!($G(DIROUT))  S DS(0)=0
"RTN","DIC3",19,0)
 I DIC(0)["T",DIC(0)["E",$G(DUOUT) D  ;22*70
"RTN","DIC3",20,0)
 . ; Set up variables for next index lookup
"RTN","DIC3",21,0)
 . K DS,DUOUT
"RTN","DIC3",22,0)
 . S (DS,DS(0),DS("DD"))=0
"RTN","DIC3",23,0)
 . S X=DIVAL(1)
"RTN","DIC3",24,0)
 . Q
"RTN","DIC3",25,0)
 I DISAVDS=0,DS=1,DIC(0)["O"!(DIC(0)'["E"),DIC(0)'["T" D  Q:Y>0!($D(DIROUT))  ;Good IEN returned or user bailed out
"RTN","DIC3",26,0)
 . I DINDEX("#")'>1,DIEXACTN>1,DINDEX'="B" S Y=-1 Q
"RTN","DIC3",27,0)
 . S Y=+DS(1),DS("DD")=1
"RTN","DIC3",28,0)
 . I DINDEX("#")'>1,DIEXACTN'>1 S DIY=1 D C^DIC2 Q
"RTN","DIC3",29,0)
 . D G^DIC2 Q
"RTN","DIC3",30,0)
 ;
"RTN","DIC3",31,0)
PARTIAL ; Find all partial matches to the lookup values
"RTN","DIC3",32,0)
 I DIC(0)'["X",DINDEX("#")>1 D PARTIAL^DIC4,SET^DIC4
"RTN","DIC3",33,0)
 I DIC(0)'["X",DINDEX("#")'>1 F  D  Q:$G(DIX)=""!(DS(0))
"RTN","DIC3",34,0)
 . N DITYP S DITYP=$G(DINDEX(1,"TYPE"))
"RTN","DIC3",35,0)
 . D
"RTN","DIC3",36,0)
 . . I DIC(0)["E",(DITYP["F"!(DITYP["S")) Q:DIC(0)["n"
"RTN","DIC3",37,0)
 . . I $TR(X,"-.")?.N,DO(2)'["D",'$D(DIDA) S DIX=$O(@(DIC_"D,DIX_"" "")"),-1)
"RTN","DIC3",38,0)
 . . Q
"RTN","DIC3",39,0)
 . S DIX=$O(@(DIC_"D,DIX)"))
"RTN","DIC3",40,0)
 . Q:DIX=""
"RTN","DIC3",41,0)
 . I $P(DIX,X)'="" D  Q:DIX=""
"RTN","DIC3",42,0)
 . . I +$P(X,"E")'=X!(DIC(0)'["E") S DIX="" Q
"RTN","DIC3",43,0)
 . . I DIC(0)'["n"!(DITYP'["F"&(DITYP'["S")) S DIX="" Q
"RTN","DIC3",44,0)
 . . D FINDMORE^DICLIX0(1,.DIX,X,.DINDEX) ;DIC(0)["n" SO WE KEEP LOOKING FOR PARTIAL NUMERIC MATCHES
"RTN","DIC3",45,0)
 . . S:$P(DIX,X)'="" DIX="" Q
"RTN","DIC3",46,0)
 . S Y=0 F  D MOREX Q:Y=-1!(DS(0))
"RTN","DIC3",47,0)
 . Q
"RTN","DIC3",48,0)
 I DS(0) Q:DIC(0)'["T"  Q:$P(DS(0),U,2)'="U"!($G(DIROUT))  S DS(0)=0
"RTN","DIC3",49,0)
 I DIC(0)["T",DIC(0)["E",$G(DUOUT) D  ;22*70
"RTN","DIC3",50,0)
 . ; Set up variables for next index lookup
"RTN","DIC3",51,0)
 . K DS,DUOUT
"RTN","DIC3",52,0)
 . S (DS,DS(0),DS("DD"))=0
"RTN","DIC3",53,0)
 . S X=DIVAL(1)
"RTN","DIC3",54,0)
 . Q
"RTN","DIC3",55,0)
 ;
"RTN","DIC3",56,0)
M ; Find the next index.  At end, display the rest
"RTN","DIC3",57,0)
 I DIC(0)["T" D KEEPON^DIC5 I DS(0) Q:$P(DS(0),U,2)'="U"!($G(DIROUT))
"RTN","DIC3",58,0)
 I DIC(0)["M" S DIOK=0 F  D  Q:DIOK
"RTN","DIC3",59,0)
 . N Y S Y=DINDEX("START") K DINDEX S DINDEX("WAY")=1,DINDEX("START")=Y,DINDEX("#")=1
"RTN","DIC3",60,0)
 . S (D,DINDEX)=$S($D(DID):$P(DID,U,DID(1)),1:$O(@(DIC_"D)"))) ;GRAB THE NEXT EXISTING CROSS-REF
"RTN","DIC3",61,0)
 . S:$D(DID) DID(1)=DID(1)+1
"RTN","DIC3",62,0)
 . I D=""!(D=-1) S D="",DIOK=1 Q
"RTN","DIC3",63,0)
 . I $D(@(DIC_"D)"))-10 Q
"RTN","DIC3",64,0)
 . ; Check Index, build index info
"RTN","DIC3",65,0)
 . D IXCHK^DIC4(.DIFILEI,.DINDEX,.DIOK,.DIALLVAL,.DIVAL,$G(DID)) ;DINDEX=D.  Check that it's OK
"RTN","DIC3",66,0)
 I DIC(0)["M",D]"" G EXACT
"RTN","DIC3",67,0)
 D:DIC(0)["M" D^DIC0
"RTN","DIC3",68,0)
 I DS=1 S DS("DD")=1 D G^DIC2 Q
"RTN","DIC3",69,0)
 I DS D Y^DIC1 Q:DS(0)  I DINDEX("#")'>1 D:DO(2)["O"&(DO(2)'["A") L^DICM Q
"RTN","DIC3",70,0)
 I $G(DILONGX) S X=$E(DICR(DILONGX,"ORG"),1,30)
"RTN","DIC3",71,0)
 I DIC(0)["T",'$G(DICR),DIC(0)["O",DIC(0)["X" G SEARCH
"RTN","DIC3",72,0)
 I DINDEX("#")>1,'$G(DICR) D:DIC(0)["L"  D:Y=-1 BAD^DIC1 Q
"RTN","DIC3",73,0)
 . S Y=-1 I $G(DICR)="" N DICR S DICR=0
"RTN","DIC3",74,0)
 . I $A(X)=34,X?.E1"""" D N^DICM Q
"RTN","DIC3",75,0)
 . K DD D L^DICM Q
"RTN","DIC3",76,0)
 D ^DICM Q
"RTN","DIC3",77,0)
 ;
"RTN","DIC3",78,0)
 ;
"RTN","DIC3",79,0)
MOREX ; Find more exact matches to lookup value DIX
"RTN","DIC3",80,0)
 S Y=$O(@(DIC_"D,DIX,Y)")) I 'Y S Y=-1 Q
"RTN","DIC3",81,0)
 I $D(DIEXACTN)#2 S DIEXACTN=DIEXACTN+1
"RTN","DIC3",82,0)
 D MN Q:'$T  D K  Q:$G(DS(0))
"RTN","DIC3",83,0)
 I DS>1,DIC(0)'["E",DIC(0)'["Y" K DS S DS=0,DS(0)=1,Y=-1
"RTN","DIC3",84,0)
 Q
"RTN","DIC3",85,0)
 ;
"RTN","DIC3",86,0)
MN N DZ S DZ=$S((DIC(0)["D"&(DINDEX="B")):1,$G(DINDEX("#"))>1:0,$G(@(DIC_"D,DIX,Y)")):1,1:0) S DIYX=0
"RTN","DIC3",87,0)
 D:'$D(DO) GETFA^DIC1(.DIC,.DO)
"RTN","DIC3",88,0)
 I D="B",'DZ,'($D(@(DIC_"D,DIX,Y)"))#2) D
"RTN","DIC3",89,0)
 . N I S I=Y F  S DZ=$G(^(I)),I=$O(^(I,0)) Q:I=""
"RTN","DIC3",90,0)
 . Q
"RTN","DIC3",91,0)
 S DIY="" I '$D(@(DIC_"Y,0)")) X "I 0" Q
"RTN","DIC3",92,0)
 I D="B",'DZ,'$D(DO("SCR")),$L(DIX)<30,'$D(DIC("S")),'$D(@(DIC_"Y,-9)")),'$G(DINDEX("OLDSUB")) D ADDKEY I 1 Q
"RTN","DIC3",93,0)
 D S I  D
"RTN","DIC3",94,0)
 . I DINDEX("FLISTD")["^.01^",DINDEX("#")=1,'DZ,$P(DIY,DIX)="",'$G(DINDEX("OLDSUB")) D  Q
"RTN","DIC3",95,0)
 . . N I S I=$S($G(DILONGX):DICR(DILONGX,"ORG"),1:DIX)
"RTN","DIC3",96,0)
 . . S DIY=$P(DIY,I,2,9),DIYX=1 D ADDKEY Q
"RTN","DIC3",97,0)
 . Q:DIC(0)["Y"
"RTN","DIC3",98,0)
 . I ($G(DINDEX("#"))>1)!($G(DINDEX("OLDSUB"))) D  Q
"RTN","DIC3",99,0)
 . . D ADDIX^DIC4(.DIFILEI,Y,.DINDEX,.DIX,.DISCREEN)
"RTN","DIC3",100,0)
 . . D ADDKEY Q
"RTN","DIC3",101,0)
 . D ADDKEY
"RTN","DIC3",102,0)
 . I DINDEX("FLISTD")["^.01^",'DZ S DIY=""
"RTN","DIC3",103,0)
 . Q
"RTN","DIC3",104,0)
 Q
"RTN","DIC3",105,0)
 ;
"RTN","DIC3",106,0)
S D:'$D(DO) GETFA^DIC1(.DIC,.DO)
"RTN","DIC3",107,0)
 I $D(@(DIC_"Y,0)")),'$D(^(-9)) S DIY=$P(^(0),U)
"RTN","DIC3",108,0)
 E  S DIY="" Q
"RTN","DIC3",109,0)
 I '$D(DIC("S")),'$D(DO("SCR")) Q
"RTN","DIC3",110,0)
 I $G(DINDEX("#"))>1!($G(DINDEX("OLDSUB"))) Q
"RTN","DIC3",111,0)
 I $G(DILONGX) N DI0NODE,DIVAL D
"RTN","DIC3",112,0)
 . N % S %=DINDEX(1,"GET")
"RTN","DIC3",113,0)
 . I %="DIVAL=DINDEX(DISUB)" S DIVAL=X Q
"RTN","DIC3",114,0)
 . I %["DI0NODE" S DI0NODE=@(DIC_"Y,0)")
"RTN","DIC3",115,0)
 . N DIFILE S DIFILE=DIFILEI,DIFILE(DIFILE)=DIFILEI(DIFILEI)
"RTN","DIC3",116,0)
 . N DIEN S DIEN=Y_DIENS
"RTN","DIC3",117,0)
 . S @% Q
"RTN","DIC3",118,0)
 N DIAC,DIFILE,DISAVEX,DISAVEY,DISAVED
"RTN","DIC3",119,0)
 M DISAVEX=X,DISAVEY=Y S DISAVED=D I $D(@(DIC_"Y,0)"))
"RTN","DIC3",120,0)
 I $D(DIVAL(1)),$D(DIVAL)=10 S DIVAL=DIVAL(1) ;*159
"RTN","DIC3",121,0)
 I 1 X:$D(DIC("S")) DIC("S") K DIAC,DIFILE D:$D(DIC("S")) SX Q:'$T
"RTN","DIC3",122,0)
 I $D(DO("SCR")),$D(@(DIC_"Y,0)")) X DO("SCR") D SX Q:'$T
"RTN","DIC3",123,0)
 I 1 Q
"RTN","DIC3",124,0)
 ;
"RTN","DIC3",125,0)
SX M X=DISAVEX,Y=DISAVEY S D=DISAVED Q
"RTN","DIC3",126,0)
 ;
"RTN","DIC3",127,0)
ADDKEY ; Put KEY values into output array for display
"RTN","DIC3",128,0)
 S DIX("F")="" I DIC(0)'["U" S DIX("F")=$G(DINDEX("FLISTD"))
"RTN","DIC3",129,0)
 Q:'$D(DIFILEI(DIFILEI,"KEY"))  Q:DIC(0)["S"
"RTN","DIC3",130,0)
 N DIKX,DII,DIFLD,DIERR,I
"RTN","DIC3",131,0)
 M DIKX=DIFILEI(DIFILEI,"KEY",DIFILEI) Q:'$D(DIKX)
"RTN","DIC3",132,0)
 K DIX("K")
"RTN","DIC3",133,0)
 F I=0:0 S I=$O(DIKX(I)) Q:'I  F DIFLD=0:0 S DIFLD=$O(DIKX(I,DIFLD)) Q:'DIFLD  D
"RTN","DIC3",134,0)
 . I DIFLD=.01,$G(DZ)=0 S DIY=""
"RTN","DIC3",135,0)
 . S DIX("K",I,DIFLD)=$$GET1^DIQ(DIFILEI,Y_DIFILEI(DIFILEI,"KEY","IEN"),DIFLD,"","","DIERR") Q
"RTN","DIC3",136,0)
 Q
"RTN","DIC3",137,0)
 ;
"RTN","DIC3",138,0)
K ; Put an IEN into the DS array for display
"RTN","DIC3",139,0)
 N DZ,I S DZ=$O(DS(0)) F I=DZ:1:DS I +$G(DS(I))=Y,DIC(0)'["C" S I=-1 Q
"RTN","DIC3",140,0)
 I I'=-1,DIC(0)["T" D
"RTN","DIC3",141,0)
 . Q:'$D(^TMP($J,"DICSEEN",DIFILEI))
"RTN","DIC3",142,0)
 . I $D(^TMP($J,"DICSEEN",DIFILEI,Y)) S I=-1 Q
"RTN","DIC3",143,0)
 . S ^TMP($J,"DICSEEN",DIFILEI,Y)="" Q
"RTN","DIC3",144,0)
 I I=-1 S I=DIX K DIX S DIX=I,I=-1 Q
"RTN","DIC3",145,0)
 I DS-DZ>100 D
"RTN","DIC3",146,0)
 . N D1,D2 S D2=DZ+19 F D1=DZ:1:D2 K DS(D1),DIY(D1),DIYX(D1)
"RTN","DIC3",147,0)
 . Q
"RTN","DIC3",148,0)
 S DS=DS+1 D
"RTN","DIC3",149,0)
 . S I=DS M DS(DS)=DIX S DS=I,I=DIX K DIX S DIX=I
"RTN","DIC3",150,0)
 . S DS(DS)=Y_"^"_$P(DIX,X,2,99) Q
"RTN","DIC3",151,0)
 S DIY(DS)=DIY S:DIY]""&$G(DIYX) DIYX(DS)=1
"RTN","DIC3",152,0)
 I DS#5-1!(DS=1)!(DIC(0)["Y") Q
"RTN","DIC3",153,0)
 D Y^DIC1 Q
"RTN","DICE")
0^1^B18028605^B16732240
"RTN","DICE",1,0)
DICE ;SFISC/GFT-CREATE AN XREF ;8JUN2010
"RTN","DICE",2,0)
 ;;22.0;VA FileMan;**26,58,165**;Mar 30, 1999;Build 32
"RTN","DICE",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICE",4,0)
 S %=2,DCOND="CROSS-REFERENCE" W !,"WANT TO CREATE A NEW ",DCOND," FOR THIS FIELD" D YN^DICN G Q:%-1
"RTN","DICE",5,0)
N F DQ=1:1 Q:'$D(^DD(DI,DA,1,DQ))
"RTN","DICE",6,0)
 W !,"CROSS-REFERENCE NUMBER: "_DQ_"// " R X:DTIME S:'$T DTOUT=1 G Q:'$T S:X="" X=DQ G NQ:X'?.N!'X,X:$D(^(X)) S DQ=X
"RTN","DICE",7,0)
 S DH=0,DIC="^DOPT(""DICR"",",DIC(0)="EQA",DIC("B")=1,DIC("S")="I 1"_$P(",Y-4",U,DUZ(0)'="@")_$P(",Y-5",U,$D(^DD(J(N),0,"LOOK"))>0)_$P(",Y-7",U,'$D(^XMB(3.6))) S:$P($G(^DD($$FNO^DILIBF(J(N)),0,"DI")),U)="Y" DIC("S")=DIC("S")_",Y-4,Y-6,Y-7"
"RTN","DICE",8,0)
 D ^DIC K DIC D QQ S Y=+Y G X:Y<0,6^DICE0:Y=6,^DICE7:Y=7 ;1=REGULAR 2=KWIC 3=MNEMONIC 4=MUMPS 5=SOUNDEX 6=TRIGGER 7=BULLETIN
"RTN","DICE",9,0)
 G A:'N W !,"WANT TO ",DCOND," WHOLE FILE BY THIS FIELD" D YN^DICN G X:%<1 I %=1 S DH=N G A
"RTN","DICE",10,0)
 F DH=N-1:-1 Q:'DH  S %=1 W !,"WANT TO "_DCOND_" "_$P(^DD(J(N-DH),0),U,1)_" BY THIS FIELD" D YN^DICN G X:%<1,A:%=1
"RTN","DICE",11,0)
A S %=1,DIK="" I Y=1!(Y=4) W !,"WANT ",DCOND," TO BE USED FOR LOOKUP AS WELL AS FOR SORTING" D YN^DICN G X:%<1 I %=2 S DIK="A"
"RTN","DICE",12,0)
 I Y=2 S DIKWIC="(,.?! '-/&:;)" W !,"PARSE ON THE FOLLOWING CHARACTERS: ",DIKWIC,"//" R X:DTIME S:'$T DTOUT=1 G Q:X=U!'$T S:X]"" DIKWIC=X I X["""" S X="?"
"RTN","DICE",13,0)
 I Y=2,X]"",X'?1P.P!(X?1"?"."?") W !?5,"Please enter the punctuation marks (except quotes) which will be used to ",!?5,"separate the words in this field." G A
"RTN","DICE",14,0)
 I Y=3 F I=0:0 S I=$O(^DD(J(N-DH),.01,1,I)) G X:I=""!(DL=.01&'DH) I $D(^(I,0)) S DE=$P(^(0),U,2) G CKF:DE?1U.UN
"RTN","DICE",15,0)
 I Y=4 D M G:$D(DIRUT) Q S:$D(XX(1)) X(1)=XX(1) S:$D(XX(2)) X(2)=XX(2) K XX
"RTN","DICE",16,0)
 ;GFT MODIFIED NEXT 6 LINES: INDEX MUST BE UPPER-CASE, START WITH PROPER LETTER, AND NOT BE A DUPLICATE
"RTN","DICE",17,0)
 N DISTART S DISTART=$S(Y-1&(Y-3)!(DA-.01):67,1:66) ;START WITH "B" OR "C"
"RTN","DICE",18,0)
IX F X=DISTART:1 S DE=DIK_$C(X) D  I $D(DE) G CKF:DUZ(0)'="@" W !,"INDEX: ",DE,"// " R X:DTIME S:'$T DTOUT=1 S:X]"" DE=X G Q:X[U!'$T D  G IX:'$D(DE) Q
"RTN","DICE",19,0)
 .I $D(^DD(J(N-DH),0,"IX",DE))!$D(^DD("IX","BB",J(N-DH),DE)) K DE Q  ;SUBROUTINE CALLED TWICE!  KILLS 'DE' IF NO GOOD   CAN'T ALREADY EXIST
"RTN","DICE",20,0)
 .I DE'?1U.UN K DE Q
"RTN","DICE",21,0)
 .I DIK="A" K:DE'?1"A".E DE Q
"RTN","DICE",22,0)
 .E  I DE?1"A".E K DE
"RTN","DICE",23,0)
CKF W !,"..." S DREF=Y
"RTN","DICE",24,0)
 D ^DICE0 W ! D DSC,DIEZ^DIU0,F G Q
"RTN","DICE",25,0)
 ;
"RTN","DICE",26,0)
F S X=^DD(J(N),DA,1,DQ,1),%=1 I DREF=1!(DREF=4)!$D(^("CONDITION")),@("$O("_DIU_"0))>0") D  G:'% F
"RTN","DICE",27,0)
 . W !!,"DO YOU WANT TO CROSS-REFERENCE EXISTING DATA NOW"
"RTN","DICE",28,0)
 . S %=0 D YN^DICN Q:%
"RTN","DICE",29,0)
 . W !!,"Enter 'YES' to execute the new set logic now."
"RTN","DICE",30,0)
 . W !,"Otherwise, enter 'NO'."
"RTN","DICE",31,0)
 D DD^DICD:%=1 I $D(DDA),DDA="" S DDA="N" D XA^DICATTA
"RTN","DICE",32,0)
 K % Q
"RTN","DICE",33,0)
 ;
"RTN","DICE",34,0)
M N Y,DQ
"RTN","DICE",35,0)
 F I=1,2 S DIR(0)=".1,"_I D  Q:$D(DTOUT)!$D(DUOUT)
"RTN","DICE",36,0)
 . F  D ^DIR Q:$D(DTOUT)!$D(DUOUT)  I X]"" S XX(I)=X Q
"RTN","DICE",37,0)
 K DIR Q
"RTN","DICE",38,0)
 ;
"RTN","DICE",39,0)
Q D QQ K DE,DB,DREF,DCOND,DICOMPX,I,DQ,DA,DH,DIK,DIC,N,DL,J,X,Y,A,XX Q
"RTN","DICE",40,0)
 ;
"RTN","DICE",41,0)
EDT ;
"RTN","DICE",42,0)
 I DH(DQ,4) D R^DICD Q:'$D(DICD)  S DQ=DICD
"RTN","DICE",43,0)
 I $D(DDA) S DDA="E" D XS^DICATTA
"RTN","DICE",44,0)
 W ! F A0=1:1:2 S A1(A0)=^DD(J(N),DA,1,DQ,A0)
"RTN","DICE",45,0)
 S A0=DI,DR=$S(DUZ(0)="@"&($P(DH(DQ),U,3)["MUMPS"):"1:3;10",1:"3;10") D ED
"RTN","DICE",46,0)
 F A0=1:1:2 I A1(A0)'=^DD(J(N),DA,1,DQ,A0) S ^("DT")=DT,DREF=4 D DIEZ^DIU0,KOLD^DICD,F,D^DICD Q
"RTN","DICE",47,0)
 K A0,A1 I $D(DDA) D XA^DICATTA
"RTN","DICE",48,0)
 Q
"RTN","DICE",49,0)
 ;
"RTN","DICE",50,0)
ED S:$D(DA(1))#2 A1(3)=DA(1) S DICD=DL,DA(2)=A0,DA(1)=DA,DA=DQ,DIE="^DD("_DA(2)_","_DA(1)_",1," D DIE K DIE,DR
"RTN","DICE",51,0)
 S DL=DICD,DQ=DA,DA=DA(1) S:$D(A1(3)) DA(1)=A1(3) K DICD Q
"RTN","DICE",52,0)
 ;
"RTN","DICE",53,0)
DIE N J,N,DI,A1 D ^DIE Q
"RTN","DICE",54,0)
DSC S A0=J(N),DR="3;4///"_DT_";10" D ED K A0 Q
"RTN","DICE",55,0)
 ;
"RTN","DICE",56,0)
NQ I X'[U D HLP G N
"RTN","DICE",57,0)
X W $C(7),"??" G Q
"RTN","DICE",58,0)
 ;
"RTN","DICE",59,0)
QQ K ^UTILITY("DICE",$J),DBOOL,DLAY,DQI,DICOMPX,DIN,DCNEW,DFLD,DREF,DENEW,DLOC,DSUB,DHI,DOLD,DNEW,%X,V
"RTN","DICE",60,0)
 Q
"RTN","DICE",61,0)
HLP ; Traditional Cross Reference Help - Called From NQ
"RTN","DICE",62,0)
 ; SF-CIOFO/SO 1/12/00
"RTN","DICE",63,0)
 W !
"RTN","DICE",64,0)
 W !,?5,"You may use the number shown if you are the custodian of the file this"
"RTN","DICE",65,0)
 W !,?5,"cross-reference is in.  If you are not the custodian of the file, you"
"RTN","DICE",66,0)
 W !,?5,"should select a number that corresponds with a numberspace for which you"
"RTN","DICE",67,0)
 W !,?5,"have custody.  Questions regarding numberspace custody may be referred"
"RTN","DICE",68,0)
 W !,?5,"to:  DBA@FORUM.VA.GOV",!
"RTN","DICE",69,0)
 Q
"RTN","DICF")
0^2^B33106724^B32265284
"RTN","DICF",1,0)
DICF ;SEA/TOAD,SF/TKW-VA FileMan: Finder, Part 1 (Main) ;20APR2010
"RTN","DICF",2,0)
 ;;22.0;VA FileMan;**20,31,165**;Mar 30, 1999;Build 32
"RTN","DICF",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DICF",4,0)
FIND(DIFILE,DIFIEN,DIFIELDS,DIFLAGS,DIVALUE,DINUMBER,DIFORCE,DISCREEN,DIWRITE,DILIST,DIMSGA,DINDEX,DIC,DIY,DIYX) ;
"RTN","DICF",5,0)
 ; ENTRY POINT--silent selecter
"RTN","DICF",6,0)
 ;
"RTN","DICF",7,0)
FINDX ; branch in from FIND^DIC
"RTN","DICF",8,0)
 I '$D(DIQUIET),$G(DIC(0))'["E" N DIQUIET S DIQUIET=1
"RTN","DICF",9,0)
 I '$D(DIFM) N DIFM S DIFM=1 D INIZE^DIEFU
"RTN","DICF",10,0)
 N DICLERR S DICLERR=$G(DIERR) K DIERR
"RTN","DICF",11,0)
 N DIEN,DIFAIL
"RTN","DICF",12,0)
 M DIEN=DIVALUE N DIVALUE M DIVALUE=DIEN K DIEN
"RTN","DICF",13,0)
 N DIDENT S DIDENT(-1)=+$G(DILIST("C"))
"RTN","DICF",14,0)
 ;
"RTN","DICF",15,0)
INPUT ; Verify correctness of input parameters
"RTN","DICF",16,0)
 S DIFLAGS=$G(DIFLAGS)
"RTN","DICF",17,0)
 I DIFLAGS'["l" N DINDEX S DINDEX("WAY")=1
"RTN","DICF",18,0)
 S DIFAIL=0 D  I DIFAIL D CLOSE Q
"RTN","DICF",19,0)
I0 . ; flags
"RTN","DICF",20,0)
 . I DIFLAGS["p" S DIFLAGS=DIFLAGS_"f"
"RTN","DICF",21,0)
 . I DIFLAGS'["p" D  Q:DIFAIL
"RTN","DICF",22,0)
 . . I $G(DIFIELDS)["IX",DIFIELDS'["-IX" D
"RTN","DICF",23,0)
 . . . N D S D=";"_DIFIELDS_";" I D'[";IX;",D'[";IXE",D'[";IXIE" Q
"RTN","DICF",24,0)
 . . . S DIDENT(-5)=1 Q
"RTN","DICF",25,0)
 . . S DIFLAGS=DIFLAGS_4
"RTN","DICF",26,0)
 . . I DIFLAGS["O",DIFLAGS["X" S DIFLAGS=$TR(DIFLAGS,"O")
"RTN","DICF",27,0)
 . . S DIFLAGS=DIFLAGS_"t"
"RTN","DICF",28,0)
I1 . . ; value
"RTN","DICF",29,0)
 . . I DIFLAGS'["l" N DIERRM D  I DIFAIL D ERR^DICF4(202,"","","",DIERRM) Q
"RTN","DICF",30,0)
 . . . S DIERRM="Lookup values"
"RTN","DICF",31,0)
 . . . I $G(DIVALUE(1))="" S DIVALUE(1)=$G(DIVALUE)
"RTN","DICF",32,0)
 . . . N I,DIEND S DIFAIL=1,DIEND=$O(DIVALUE(999999),-1)
"RTN","DICF",33,0)
 . . . F I=1:1:DIEND S DIVALUE(I)=$G(DIVALUE(I)) I DIVALUE(I)]"" S DIFAIL=$$BADVAL(DIVALUE(I)) Q:DIFAIL
"RTN","DICF",34,0)
 . . . Q
"RTN","DICF",35,0)
 . . Q
"RTN","DICF",36,0)
I2 . ; target_root
"RTN","DICF",37,0)
 . S DILIST=$G(DILIST)
"RTN","DICF",38,0)
 . I DILIST'="",DIFLAGS'["l" D
"RTN","DICF",39,0)
 . . I DIFLAGS'["p" K @DILIST
"RTN","DICF",40,0)
 . . I DIFLAGS'["f" S DILIST=$NA(@DILIST@("DILIST"))
"RTN","DICF",41,0)
 . . Q
"RTN","DICF",42,0)
 . I DILIST="" S DILIST="^TMP(""DILIST"",$J)" K @DILIST
"RTN","DICF",43,0)
I3 . ; file and screens
"RTN","DICF",44,0)
 . D:DIFLAGS'["v"&(DIFLAGS'["l") FILE^DICUF(.DIFILE,.DIFIEN,DIFLAGS)
"RTN","DICF",45,0)
 . I $G(DIERR) S DIFAIL=1 Q
"RTN","DICF",46,0)
 . D SCREEN^DICUF(DIFLAGS,.DIFILE,.DISCREEN)
"RTN","DICF",47,0)
 . D DA^DILF(DIFIEN,.DIEN)
"RTN","DICF",48,0)
I4 . ; fields
"RTN","DICF",49,0)
 . S DIFIELDS=$G(DIFIELDS)
"RTN","DICF",50,0)
I5 . ; flags again
"RTN","DICF",51,0)
 . I DIFLAGS'["p",DIFLAGS'["l" D  Q:DIFAIL
"RTN","DICF",52,0)
 . . I $TR(DIFLAGS,"ABCKMOPQSUXfglpqtv4")'="" S DIFAIL=1 D  Q
"RTN","DICF",53,0)
 . . . D ERR^DICF4(301,"","","",$TR(DIFLAGS,"fglpqtv4")) Q
"RTN","DICF",54,0)
 . . Q
"RTN","DICF",55,0)
I6 . ; determine starting index.
"RTN","DICF",56,0)
 . I DIFLAGS'["l" D  Q:DIFAIL
"RTN","DICF",57,0)
 . . S DIFORCE=$G(DIFORCE),DIFORCE(1)=1
"RTN","DICF",58,0)
 . . I "*"[DIFORCE D
"RTN","DICF",59,0)
 . . . I DIFLAGS["M" S DIFORCE=0,DIFORCE(0)="*" Q
"RTN","DICF",60,0)
 . . . S DIFORCE(0)=$$DINDEX^DICL(DIFILE,DIFLAGS),DIFORCE=1 Q
"RTN","DICF",61,0)
 . . E  D  I DIFAIL D ERR^DICF4(202,"","","","Indexes") Q
"RTN","DICF",62,0)
 . . . I $P(DIFORCE,U)="" S DIFAIL=1 Q
"RTN","DICF",63,0)
 . . . S DIFORCE(0)=DIFORCE,DIFORCE=1
"RTN","DICF",64,0)
 . . . I $P(DIFORCE(0),U,2)]"",DIFLAGS'["M" S DIFLAGS=DIFLAGS_"M"
"RTN","DICF",65,0)
 . . . Q
"RTN","DICF",66,0)
 . . I DIFORCE S DINDEX=$P(DIFORCE(0),U) Q
"RTN","DICF",67,0)
 . . S DINDEX=$$DINDEX^DICL(DIFILE,DIFLAGS) Q
"RTN","DICF",68,0)
I7 . ; rest
"RTN","DICF",69,0)
 . I DIFLAGS'["p",DIFLAGS'["l" D  Q:DIFAIL
"RTN","DICF",70,0)
 . . S DINUMBER=$S($G(DINUMBER):DINUMBER,1:"*")
"RTN","DICF",71,0)
 . . I DINUMBER'="*" D  Q:DIFAIL
"RTN","DICF",72,0)
 . . . I DINUMBER\1=DINUMBER,DINUMBER>0 Q
"RTN","DICF",73,0)
 . . . S DIFAIL=1 D ERR^DICF4(202,"","","","Number")
"RTN","DICF",74,0)
 . . . Q
"RTN","DICF",75,0)
 . . Q
"RTN","DICF",76,0)
 . S DIWRITE=$G(DIWRITE)
"RTN","DICF",77,0)
 . Q
"RTN","DICF",78,0)
I8 I DIFLAGS["P" S DIDENT(-3)=""
"RTN","DICF",79,0)
 S DIDENT(-1,"JUST LOOKING")=0,DIDENT(-1,"MAX")=DINUMBER,DIDENT(-1,"MORE?")=0
"RTN","DICF",80,0)
 N DIOUT S DIOUT=0
"RTN","DICF",81,0)
 ;
"RTN","DICF",82,0)
HOOK75 ;
"RTN","DICF",83,0)
 N DIHOOK75
"RTN","DICF",84,0)
 S DIHOOK75=$G(^DD(DIFILE,.01,7.5))
"RTN","DICF",85,0)
 I DIHOOK75'="",DIVALUE(1)]"",DIVALUE(1)'?."?",'$O(DIVALUE(1)),DIFLAGS'["l" D  I DIOUT D CLOSE Q
"RTN","DICF",86,0)
 .N DIC D  ;I DIFLAGS["p" N DIC D
"RTN","DICF",87,0)
 . . S DIC=DIFILE,DIC(0)=$TR(DIFLAGS,"2^fglpqtv4") Q
"RTN","DICF",88,0)
 . N %,D,X,Y,Y1
"RTN","DICF",89,0)
 . S X=DIVALUE(1),D=DINDEX
"RTN","DICF",90,0)
 . M Y=DIEN S Y="",Y1=DIFIEN
"RTN","DICF",91,0)
 . X DIHOOK75 I '$D(X)!$G(DIERR) S DIOUT=1 D:$G(DIERR)  Q
"RTN","DICF",92,0)
 . . S %=$$EZBLD^DIALOG(8090) ;Pre-lookup transform (7.5 node)
"RTN","DICF",93,0)
 . . D ERR^DICF4(120,DIFILE,"",.01,%)
"RTN","DICF",94,0)
 . S DIVALUE(1)=X,DIOUT=$$BADVAL(DIVALUE(1)) Q:DIOUT
"RTN","DICF",95,0)
 . I $G(DIC("S"))'="" S DISCREEN("S")=DIC("S") ;DIHOOK MAY HAVE SET THIS
"RTN","DICF",96,0)
 . I $G(DIC("V"))'="" S (DISCREEN("V"),DISCREEN("V",1))=DIC("V") ;...OR THIS
"RTN","DICF",97,0)
 ;
"RTN","DICF",98,0)
LOOKUP ;
"RTN","DICF",99,0)
 I DIFLAGS'["l" D  I DIOUT!($G(DIERR)) D CLOSE Q
"RTN","DICF",100,0)
 . D INDEX^DICUIX(.DIFILE,DIFLAGS,.DINDEX,"",.DIVALUE,DINUMBER,.DISCREEN,DILIST,.DIOUT) Q
"RTN","DICF",101,0)
 I '$D(DINDEX("MAXSUB")) D
"RTN","DICF",102,0)
 . S DINDEX("MAXSUB")=$P($G(^DD("OS",+$G(^DD("OS")),0)),U,7)
"RTN","DICF",103,0)
 . I DINDEX("MAXSUB") S DINDEX("MAXSUB")=DINDEX("MAXSUB")-13 Q
"RTN","DICF",104,0)
 . S DINDEX("MAXSUB")=50 Q
"RTN","DICF",105,0)
 I $D(DISCREEN("V")) D VPDATA^DICUF(.DINDEX,.DISCREEN)
"RTN","DICF",106,0)
 I (DINDEX'="#")!($O(DIVALUE(1))) D CHKVAL1^DIC0(DINDEX("#"),.DIVALUE,DIFLAGS)  I $G(DIERR) D CLOSE Q
"RTN","DICF",107,0)
 I DIFLAGS'["f" D  I $G(DIERR) D CLOSE Q
"RTN","DICF",108,0)
 . D IDENTS^DICU1(DIFLAGS,.DIFILE,DIFIELDS,DIWRITE,.DIDENT,.DINDEX)
"RTN","DICF",109,0)
 . Q
"RTN","DICF",110,0)
 I DIFLAGS'["p",DIFLAGS'["l" D  I DIOUT!($G(DIERR)) D CLOSE Q
"RTN","DICF",111,0)
 . N I F I=2:1:DINDEX("#") Q:$G(DIVALUE(I))]""
"RTN","DICF",112,0)
 . Q:$G(DIVALUE(I))]""
"RTN","DICF",113,0)
 . D SPECIAL^DICF1(.DIFILE,.DIEN,DIFIEN,DIFLAGS,DIVALUE(1),.DINDEX,.DISCREEN,.DIDENT,.DIOUT,.DILIST)
"RTN","DICF",114,0)
 . Q
"RTN","DICF",115,0)
 I DIFLAGS["t" D XFORM^DICF1(.DIFLAGS,.DIVALUE,.DISCREEN,.DINDEX)
"RTN","DICF",116,0)
 I DINDEX("#")>1,DIVALUE(1)="" N S M S=DISCREEN N DISCREEN M DISCREEN=S K S D
"RTN","DICF",117,0)
 . I DIFIELDS["IX",DIFIELDS'["-IX" Q
"RTN","DICF",118,0)
 . N DISAVMAX S DISAVMAX=DINDEX("MAXSUB")
"RTN","DICF",119,0)
 . D ALTIDX^DICF0(.DINDEX,.DIFILE,.DIVALUE,.DISCREEN,DINUMBER)
"RTN","DICF",120,0)
 . S DINDEX("MAXSUB")=DISAVMAX Q
"RTN","DICF",121,0)
 D CHKALL^DICF2(.DIFILE,.DIEN,DIFIEN,.DIFLAGS,.DIVALUE,.DISCREEN,DINUMBER,.DIFORCE,.DINDEX,.DIDENT,.DILIST,.DIC,.DIY,.DIYX)
"RTN","DICF",122,0)
 D CLOSE
"RTN","DICF",123,0)
 Q
"RTN","DICF",124,0)
 ;
"RTN","DICF",125,0)
BADVAL(DIVALUE) ; Check for invalid characters in value
"RTN","DICF",126,0)
 I "^"[DIVALUE Q 1
"RTN","DICF",127,0)
 I DIVALUE'?.ANP D ERR^DICF4(204,"","","",DIVALUE) Q 1
"RTN","DICF",128,0)
 Q 0
"RTN","DICF",129,0)
CLOSE ;
"RTN","DICF",130,0)
 ; cleanup
"RTN","DICF",131,0)
 I $G(DIMSGA)'="" D CALLOUT^DIEFU(DIMSGA)
"RTN","DICF",132,0)
 I DICLERR'=""!$G(DIERR) D
"RTN","DICF",133,0)
 . I DIFLAGS["l",+DIERR=1 Q
"RTN","DICF",134,0)
 . S DIERR=$G(DIERR)+DICLERR_U_($P($G(DIERR),U,2)+$P(DICLERR,U,2))
"RTN","DICF",135,0)
 I $G(DIERR) D  Q
"RTN","DICF",136,0)
 . Q:$G(DILIST)=""  K @DILIST@("B") Q
"RTN","DICF",137,0)
 I DIFLAGS["p" S @DILIST=DIDENT(-1) Q
"RTN","DICF",138,0)
 Q:DIFLAGS["l"
"RTN","DICF",139,0)
 S @DILIST@(0)=DIDENT(-1)_U_DIDENT(-1,"MAX")_U_DIDENT(-1,"MORE?")_U_$S(DIFLAGS[2:"H",1:"")
"RTN","DICF",140,0)
 I DIFLAGS["P" S @DILIST@(0,"MAP")=$G(DIDENT(-3))
"RTN","DICF",141,0)
 E  D SETMAP^DICL1(.DIDENT,DILIST)
"RTN","DICF",142,0)
 K @DILIST@("B")
"RTN","DICF",143,0)
 Q
"RTN","DICF",144,0)
 ;
"RTN","DICF",145,0)
 ; Error messages:
"RTN","DICF",146,0)
 ; 120  The previous error occurred when performin
"RTN","DICF",147,0)
 ; 202  The input parameter that identifies the |1
"RTN","DICF",148,0)
 ; 204  The input value contains control character
"RTN","DICF",149,0)
 ; 301  The passed flag(s) '|1|' are unknown or in
"RTN","DICF",150,0)
 ; 8090 Pre-lookup transform (7.5 node)
"RTN","DICF",151,0)
 ; 8093 Too many lookup values for this index.
"RTN","DICF",152,0)
 ; 8094 Not enough lookup values provided for an e
"RTN","DICF",153,0)
 ; 8095 Only one compound index allowed on a looku
"RTN","DICF",154,0)
 ;
"RTN","DICF4")
0^3^B21205416^B20498815
"RTN","DICF4",1,0)
DICF4 ;SEA/TOAD,SF/TKW-VA FileMan: Finder, (pointer indexes) ;28JAN2011
"RTN","DICF4",2,0)
 ;;22.0;VA FileMan;**4,31,165**;Mar 30, 1999;Build 32
"RTN","DICF4",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DICF4",4,0)
 ;
"RTN","DICF4",5,0)
POINT(DIFILE,DIFLAGS,DINDEX,DIDENT,DIEN,DIFIEN,DISCREEN,DIVALUE,DIC,DIFORCE) ;
"RTN","DICF4",6,0)
 ; PREPIX^DICF2--transform value for indexed pointer field
"RTN","DICF4",7,0)
 N DIF,DIFL,DIX,DIPVAL,DISCR,DITARGET,DISKIP,DIPRV,DINEW
"RTN","DICF4",8,0)
 S DIF=$TR(DIFLAGS,$TR(DIFLAGS,"4XOB"))_"Mp",DIX="B"
"RTN","DICF4",9,0)
 I DIFLAGS["B" S DIF=$TR(DIF,"M")
"RTN","DICF4",10,0)
 D GETTMP^DICUIX1(.DITARGET,"DICF")
"RTN","DICF4",11,0)
 S DITARGET("C")=0
"RTN","DICF4",12,0)
 S (DIPRV,DINEW)="S" F  S DINEW=$O(DISCREEN(DINEW)) Q:$E(DINEW)'="S"  S DIPRV=DINEW,DISCR(DIPRV)=DISCREEN(DIPRV)
"RTN","DICF4",13,0)
 S DINEW="S"_($P(DIPRV,"S",2)+1)
"RTN","DICF4",14,0)
P1 ; Process regular pointer
"RTN","DICF4",15,0)
 I DINDEX(1,"TYPE")="P" D  Q
"RTN","DICF4",16,0)
 . S DIFL=+$P($P(DINDEX(1,"NODE"),U,2),"P",2) Q:'DIFL
"RTN","DICF4",17,0)
 . M DIPVAL(1)=DIVALUE(1),DISCR(1)=DISCREEN(1)
"RTN","DICF4",18,0)
 . I DIFLAGS["l" D DIC(.DIC,.DIEN,.DIFILE,.DINDEX,.DIVALUE,DITARGET)
"RTN","DICF4",19,0)
 . I DIFLAGS'["l" D
"RTN","DICF4",20,0)
NUM ..I +$P(DIPVAL(1),"E")=DIPVAL(1),$G(DINDEX)'="B",DIFLAGS["M" Q  ;GFT  PATCH 165   DO NOT LOOK UP POINTERS
"RTN","DICF4",21,0)
 . . I $D(DIFORCE("PTRIX")) D SETIX(.DIFORCE,.DINDEX,.DIX,.DIF)
"RTN","DICF4",22,0)
 . . N F S F=DIF N DIF S DIF=F K F M DIFL("CHAIN")=DIFILE("CHAIN")
"RTN","DICF4",23,0)
 . . D BLDSCR(.DISCR,DINEW,DIPRV,.DIFL,.DINDEX,.DISCREEN,.DIFILE)
"RTN","DICF4",24,0)
 . . D FIND^DICF(.DIFL,",","",DIF,.DIPVAL,"",.DIX,.DISCR,"",.DITARGET)
"RTN","DICF4",25,0)
 . I $G(DIERR)!('$G(@DITARGET)) K @DITARGET Q
"RTN","DICF4",26,0)
 . S DINDEX(1,"IXROOT")=DINDEX(1,"ROOT"),DINDEX(1,"ROOT")=$NA(@DITARGET@("B"))
"RTN","DICF4",27,0)
 . Q
"RTN","DICF4",28,0)
P2 ; Process variable pointer
"RTN","DICF4",29,0)
 I DIFLAGS["l" D  Q
"RTN","DICF4",30,0)
 . D DIC(.DIC,.DIEN,.DIFILE,.DINDEX,.DIVALUE,DITARGET)
"RTN","DICF4",31,0)
 . I $G(DIERR)!('$G(@DITARGET)) K @DITARGET Q
"RTN","DICF4",32,0)
 . S DINDEX(1,"IXROOT")=DINDEX(1,"ROOT"),DINDEX(1,"ROOT")=$NA(@DITARGET@("B"))
"RTN","DICF4",33,0)
 . Q
"RTN","DICF4",34,0)
 N DIFILES I DIVALUE(1)[".",$P(DIVALUE(1),".")]"" D
"RTN","DICF4",35,0)
 . N V S V=$$OUT^DIALOGU($P(DIVALUE(1),"."),"UC")
"RTN","DICF4",36,0)
 . D VPFILES^DIEV1(DINDEX(1,"FILE"),DINDEX(1,"FIELD"),V,.DIFILES)
"RTN","DICF4",37,0)
 . Q
"RTN","DICF4",38,0)
P21 D P3 I $G(DIERR) K @DITARGET Q
"RTN","DICF4",39,0)
 I $O(DIFILES(0)),'$G(@DITARGET) K DIFILES D P3
"RTN","DICF4",40,0)
 I $G(DIERR)!('$G(@DITARGET)) K @DITARGET Q
"RTN","DICF4",41,0)
 S DINDEX(1,"IXROOT")=DINDEX(1,"ROOT"),DINDEX(1,"ROOT")=$NA(@DITARGET@("B"))
"RTN","DICF4",42,0)
 Q
"RTN","DICF4",43,0)
 ;
"RTN","DICF4",44,0)
P3 N DIVP,G,I,X,DIF1,DIS1
"RTN","DICF4",45,0)
 F DIVP=0:0 S DIVP=$O(^DD(DINDEX(1,"FILE"),DINDEX(1,"FIELD"),"V",DIVP)) Q:'DIVP  S X=$G(^(DIVP,0)) D  Q:$G(DIERR)
"RTN","DICF4",46,0)
 . K DIF1,DIFL,DIPVAL,DIS1,DIX S DIX="B"
"RTN","DICF4",47,0)
 . Q:'X  I $O(DIFILES(0)) Q:'$D(DIFILES(+X))
"RTN","DICF4",48,0)
 . I $G(DISCREEN("V",1))]"" D  Q:G=""
"RTN","DICF4",49,0)
 . . S G=$G(^DIC(+X,0,"GL")) Q:G=""
"RTN","DICF4",50,0)
 . . S:'$D(DINDEX(DISUB,"VP",G)) G="" Q
"RTN","DICF4",51,0)
 . S DIF1=DIF_"v",DIFL=+X
"RTN","DICF4",52,0)
 . I $D(DIFORCE("PTRIX")) D SETIX(.DIFORCE,.DINDEX,.DIX,.DIF1)
"RTN","DICF4",53,0)
 . D FILE^DICUF(.DIFL,"",.DIF1) Q:$G(DIERR)
"RTN","DICF4",54,0)
 . M DIS1=DISCR
"RTN","DICF4",55,0)
 . I '$O(DIFILES(0)) M DIPVAL(1)=DIVALUE(1),DIS1(1)=DISCREEN(1)
"RTN","DICF4",56,0)
 . E  D
"RTN","DICF4",57,0)
 . . S DIF1=DIF1_"t"
"RTN","DICF4",58,0)
 . . S DIPVAL(1)=$P(DIVALUE(1),".",2,99)
"RTN","DICF4",59,0)
 . . Q
"RTN","DICF4",60,0)
 . M DIFL("CHAIN")=DIFILE("CHAIN")
"RTN","DICF4",61,0)
 . D BLDSCR(.DIS1,DINEW,DIPRV,.DIFL,.DINDEX,.DISCREEN,.DIFILE)
"RTN","DICF4",62,0)
 . S DITARGET("C")=+$G(@DITARGET)
"RTN","DICF4",63,0)
 . D FIND^DICF(.DIFL,",","",DIF1,.DIPVAL,"",.DIX,.DIS1,"",.DITARGET)
"RTN","DICF4",64,0)
 . Q
"RTN","DICF4",65,0)
 Q
"RTN","DICF4",66,0)
 ;
"RTN","DICF4",67,0)
SETIX(DIFORCE,DINDEX,DIX,DIF) ; If user passes list of indexes to use on pointed-to file, set up to use them.
"RTN","DICF4",68,0)
 M DIX("PTRIX")=DIFORCE("PTRIX") N %
"RTN","DICF4",69,0)
 S %=$G(DIX("PTRIX",DINDEX(1,"FILE"),DINDEX(1,"FIELD"),DIFL))
"RTN","DICF4",70,0)
 Q:%=""  S DIX=%
"RTN","DICF4",71,0)
 I $P(DIX,U,2)="" S:DIF["M" DIF=$TR(DIF,"M") Q
"RTN","DICF4",72,0)
 S:DIF'["M" DIF=DIF_"M" Q
"RTN","DICF4",73,0)
 ;
"RTN","DICF4",74,0)
BLDSCR(DISCR,DINEW,DIPRV,DIFL,DINDEX,DISCREEN,DIFILE) ; Build screen to make sure entry is in pointer index.
"RTN","DICF4",75,0)
 N DICSUBS S DICSUBS=""
"RTN","DICF4",76,0)
 S DISCR(DINEW)=$S(DIPRV="S":" Q",1:" "_DISCREEN("S")_" Q:$T")
"RTN","DICF4",77,0)
 N I S I="I" S:DINDEX(1,"TYPE")["V" I=I_"_"";"_$P(DIFL(DIFL,"O"),U,2)_""""
"RTN","DICF4",78,0)
 S DISCR("S")=DICSUBS_"N "_DINEW_" S "_DINEW_"="_I_" X DISCREEN("""_DINEW_""")"
"RTN","DICF4",79,0)
 I DINDEX("#")>1 D  Q
"RTN","DICF4",80,0)
 . S DISCR(DINEW)="X ""I 0"" I $D("_DIFILE(DIFILE,"O")_""""_DINDEX_""","_DINEW_"))"_DISCR(DINEW)
"RTN","DICF4",81,0)
 . Q
"RTN","DICF4",82,0)
 S DISCR(DINEW)="X ""I 0"" N I F I=0:0 S I=$O("_DIFILE(DIFILE,"O")_""""_DINDEX_""","_DINEW_",I)) Q:'I  I $D("_DIFILE(DIFILE,"O")_"I,0))"_DISCR(DINEW)
"RTN","DICF4",83,0)
 Q
"RTN","DICF4",84,0)
 ;
"RTN","DICF4",85,0)
SETDA(DIEN) ; Return code that sets DA array to current level when pointer field is in a multiple.  DA itself=DA(1).
"RTN","DICF4",86,0)
 N %,DICODE S DICODE="S DA="_+$G(DIEN(1))
"RTN","DICF4",87,0)
 F %=1:1 Q:'$D(DIEN(%))  S DICODE=DICODE_",DA("_%_")="_DIEN(%)
"RTN","DICF4",88,0)
 Q DICODE
"RTN","DICF4",89,0)
 ;
"RTN","DICF4",90,0)
DIC(DIC,DIEN,DIFILE,DINDEX,DIVALUE,DITARGET) ; If we were called from ^DIC, we want to do recursive lookup there.
"RTN","DICF4",91,0)
 N %,%Y,D,DD,DIVAL,DF,DID,DINUM,DICRS,DS,DO,X,Y,DIFINDER
"RTN","DICF4",92,0)
 S DO(2)=DIFILE,(D,DF)=DINDEX("START"),(X,DIVAL(1))=DIVALUE(1),DIVAL(0)=1
"RTN","DICF4",93,0)
 S DD=0,%=DINDEX,DS=$G(^DD(DINDEX(1,"FILE"),DINDEX(1,"FIELD"),0)),Y=DINDEX(1,"TYPE"),%Y=DINDEX(1,"FIELD")
"RTN","DICF4",94,0)
 S:$G(DICR)="" DICR=0
"RTN","DICF4",95,0)
 D
"RTN","DICF4",96,0)
 . N DIFILE,I
"RTN","DICF4",97,0)
 . S DIFINDER="p"
"RTN","DICF4",98,0)
 . M I=DIC N DIC M DIC=I K I
"RTN","DICF4",99,0)
 . N DA X $$SETDA(.DIEN) N DIEN
"RTN","DICF4",100,0)
 . D A^DICM Q:Y=-1  D ^DICM1 K DICR(DICR) S DICR=DICR-1 I DICR<1 K DICR
"RTN","DICF4",101,0)
 . Q
"RTN","DICF4",102,0)
 Q:Y'>0
"RTN","DICF4",103,0)
 S @DITARGET@("B",($P(Y,U,2)_U_X))="",@DITARGET=1
"RTN","DICF4",104,0)
 Q
"RTN","DICF4",105,0)
 ;
"RTN","DICF4",106,0)
ERR(DIERN,DIFILE,DIIENS,DIFIELD,DI1,DI2,DI3) ;
"RTN","DICF4",107,0)
 ; error logging procedure
"RTN","DICF4",108,0)
 N DIPE
"RTN","DICF4",109,0)
 N DI F DI="FILE","IENS","FIELD",1:1:3 S DIPE(DI)=$G(@("DI"_DI))
"RTN","DICF4",110,0)
 D BLD^DIALOG(DIERN,.DIPE,.DIPE)
"RTN","DICF4",111,0)
 Q
"RTN","DICF4",112,0)
 ;
"RTN","DICM")
0^10^B34755435^B32299770
"RTN","DICM",1,0)
DICM ;SFISC/GFT,XAK,TKW-MULTIPLE LOOKUP FOR FLDS WHICH MUST BE TRANSFORMED ;28SEP2010
"RTN","DICM",2,0)
 ;;22.0;VA FileMan;**4,20,31,40,149,159,165**;Mar 30, 1999;Build 32
"RTN","DICM",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DICM",4,0)
 I '$D(DICR(1)),DIC(0)'["T" N DICR S DICR=0
"RTN","DICM",5,0)
 I $A(X)=34,X?.E1"""" G N
"RTN","DICM",6,0)
 I $G(^DD(+DO(2),0,"LOOK"))]"",^("LOOK")'="SOUNDEX" G @^("LOOK")
"RTN","DICM",7,0)
 I DIC(0)["U" S DD=0 G W
"RTN","DICM",8,0)
 I DIC(0)["T" G 2
"RTN","DICM",9,0)
R N DIFLAGS S DIFLAGS="4l"_$P("M^",U,DIC(0)["M")
"RTN","DICM",10,0)
 N DIFORCE D
"RTN","DICM",11,0)
 . S DIFORCE=0 I DIC(0)'["M"!($D(DID)) S DIFORCE=1
"RTN","DICM",12,0)
 . S DIFORCE(0)=$S(DIC(0)'["M":DINDEX,$D(DID):DID,1:"*"),DIFORCE(1)=1
"RTN","DICM",13,0)
 F  D 1 I DINDEX=""!(Y>0)!($G(DTOUT))!($G(DIROUT)) Q  ;LOOP THRU ALL THE INDEXES!
"RTN","DICM",14,0)
 G 2
"RTN","DICM",15,0)
 ;
"RTN","DICM",16,0)
1 N DS,%Y,DIV
"RTN","DICM",17,0)
 I $G(DINDEX("IXFILE")) S Y=DINDEX(1,"FILE"),%Y=DINDEX(1,"FIELD")
"RTN","DICM",18,0)
 E  S Y=$O(^DD(+DO(2),0,"IX",DINDEX,0)) S:Y="" Y=-1 S %Y=+$O(^(Y,0))
"RTN","DICM",19,0)
 I Y=-1,DINDEX="B" S Y=+DO(2),%Y=.01
"RTN","DICM",20,0)
 S:Y="" Y=-1 S:%Y="" %Y=-1
"RTN","DICM",21,0)
 I $D(DICR(U,Y,%Y,DINDEX)) S Y=-1 ;HAVE WE ALREADY TRIED THIS INDEX?
"RTN","DICM",22,0)
 E  I %Y=.01,DINDEX'="B",Y=+DO(2),$D(DICR(U,Y,%Y,"B")),$G(DINDEX(1,"TRANCODE"))="" S Y=-1 ;!
"RTN","DICM",23,0)
 I Y'<0 D
"RTN","DICM",24,0)
 . S DS=$G(^DD(Y,%Y,0)) I DS="" S Y=-1 Q
"RTN","DICM",25,0)
 . S %=DINDEX,DICR(U,Y,%Y,DINDEX)=0
"RTN","DICM",26,0)
 . I $D(^DD(Y,%Y,7)) D RS K DS X ^(7) Q
"RTN","DICM",27,0)
 . I $G(DINDEX("IXTYPE"))="S" D A,SOU^DICM1,D Q:Y>0  S Y=-1 Q
"RTN","DICM",28,0)
 . S DIX=Y,Y=$P(DS,U,2)
"RTN","DICM",29,0)
 . S Y=$S(Y["P":"P",Y["D":"D",Y["S":"S",Y["V":"V",1:"") ;TRANSFORMATION WILL BE NECESSARY IF X-REF'D FIELD IS DATE, POINTER, SET OR VARIABLE-POINTER
"RTN","DICM",30,0)
 . I Y]"" D A D:'Y ^DICM1,D Q:Y>0  S Y=-1 Q
"RTN","DICM",31,0)
 . I $G(DINDEX(1,"TRANCODE"))]"" S Y="T" D A,^DICM1 N DITRANX S DITRANX=1 D D
"RTN","DICM",32,0)
 . Q:Y>0  S Y=-1 Q
"RTN","DICM",33,0)
 Q:Y>0!(DIC(0)["T")  D
"RTN","DICM",34,0)
 . K DIV M DIV=X S DIV(1)=X N X,Y
"RTN","DICM",35,0)
 . D NXTINDX^DICF2(.DINDEX,.DIFORCE,.DIFILEI,DIFLAGS,.DIV,"*") Q
"RTN","DICM",36,0)
 Q
"RTN","DICM",37,0)
 ;
"RTN","DICM",38,0)
2 D D^DIC0 S %=D ;HERE'S WHERE WE TRY ALTERNATE LOOKUPS: UPPER CASE, COMMA-PIECING, TRUNCATE LONG INPUT
"RTN","DICM",39,0)
 G K:Y>0!($G(DIROUT))
"RTN","DICM",40,0)
 I X?.E1L.E,DIC(0)'["X" D  G K:$G(DIROUT) ;CONVERT TO UPPER-CASE
"RTN","DICM",41,0)
 . D % N DIFILEI,DINDEX
"RTN","DICM",42,0)
 . S DIC(0)=$TR(DIC(0),"L"),X=$$UP^DILIBF(X) S:$G(DILONGX) DICR(DILONGX,"ORG")=X
"RTN","DICM",43,0)
 . D DIC Q
"RTN","DICM",44,0)
 I Y'>0,X["," S DS="",DIX=$P(X,",") I DIC(0)'["X",$L(DIX)<31 D  G K:$G(DIROUT) ;COMMA-PIECING
"RTN","DICM",45,0)
 . F %=2:1 S DD=$P(X,",",%) I DD'["""" D  Q:DD=""
"RTN","DICM",46,0)
 . . F  Q:$A(DD)-32  S DD=$E(DD,2,999)
"RTN","DICM",47,0)
 . . F  Q:$A(DD,$L(DD))-32  S DD=$E(DD,1,$L(DD)-1)
"RTN","DICM",48,0)
 . . I $L(DD)*2+$L(DS)>200!(DD="") S DD="" Q
"RTN","DICM",49,0)
 . . S DS=DS_" I %?.E1P1"""_DD_""".E!(D'=""B""&(%?1"""_DD_""".E))" Q
"RTN","DICM",50,0)
 . Q:DS=""  S %=D
"RTN","DICM",51,0)
 . D % S X=DIX N DILONGX
"RTN","DICM",52,0)
 . S DS="S %=$P(^(0),U)"_DS,DIC(0)=DIC(0)_"D" D 7 Q
"RTN","DICM",53,0)
 I Y'>0,$L(X)>30 D  ;LONG DATA
"RTN","DICM",54,0)
 . N DILONGX
"RTN","DICM",55,0)
 . S %=D D % S DILONGX=DICR,Y="DICR("_DICR_")",DICR(DICR,"ORG")=X
"RTN","DICM",56,0)
 . S DS=$S(DIC(0)["X":"I DIVAL="_Y,1:"I '$L($P(DIVAL,"_Y_"))")
"RTN","DICM",57,0)
 . S:DIC(0)["O"&(DIC(0)'["E") DS=DS_",'$L($P(DIVAL,"_Y_",2))"
"RTN","DICM",58,0)
 . D 7 I Y>0!(X'?.E1L.E)!(DIC(0)["X") Q
"RTN","DICM",59,0)
 . S %=D D % S (X,DICR(DICR,"ORG"))=$$UP^DILIBF(X)
"RTN","DICM",60,0)
 . S Y="DICR("_DICR_",""ORG"")"
"RTN","DICM",61,0)
 . S DS="I '$L($P(DIVAL,"_Y_"))" S:DIC(0)["O"&(DIC(0)'["E") DS=DS_",'$L($P(DIVAL,"_Y_",2))"
"RTN","DICM",62,0)
 . D 7
"RTN","DICM",63,0)
 ;
"RTN","DICM",64,0)
K S DICR=+$G(DICR),DD=$D(DICR(DICR,6)) K:'DICR DICR
"RTN","DICM",65,0)
 I Y>0 K DIC("W") D R^DIC2 Q
"RTN","DICM",66,0)
 I $G(DTOUT)!($G(DIROUT)) Q
"RTN","DICM",67,0)
W I @("$O("_DIC_"""A[""))]""""") G NL:DIC(0)["N",DD
"RTN","DICM",68,0)
 I DO(2)'["Z" S Y=0 D  Q:Y>0!($G(DIROUT))
"RTN","DICM",69,0)
DINUM .I $G(DINDEX("1","FIELD"))=.01,X?1.15NP,$P($G(^DD(+DO(2),.01,0)),U,5,99)["DINUM=X",$P($G(@(DIC_"X,0)")),U)=X D  Q:Y>0
"RTN","DICM",70,0)
 ..S Y=X I 1 X:$D(DIC("S")) DIC("S") I  S DIY="",DS=1 N DZ,DD D ADDKEY^DIC3,GOT^DIC2 Q
"RTN","DICM",71,0)
 ..S Y=0
"RTN","DICM",72,0)
 .N DIOUT S DIOUT=0 F DS=1:1 S @("Y=$O("_DIC_"Y))") D  Q:DIOUT
"RTN","DICM",73,0)
 . . I 'Y S Y=-1,DIOUT=1 Q
"RTN","DICM",74,0)
 . . W:DIC(0)["E"&(DS#20=0) ".."
"RTN","DICM",75,0)
 . . I $D(@(DIC_Y_",0)")),$P(^(0),U)=X X:$D(DIC("S")) DIC("S") I  S DIOUT=1
"RTN","DICM",76,0)
 . . I DIOUT S DIY="",DS=1 N DZ,DD D ADDKEY^DIC3,GOT^DIC2
"RTN","DICM",77,0)
 . . Q
"RTN","DICM",78,0)
NL I '$G(DICR) D NQ I $T D  Q:Y>0!($G(DTOUT))!($G(DIROUT))
"RTN","DICM",79,0)
 . N:'$G(DIASKOK) DIASKOK S (DS,DIASKOK)=1 N DZ,DD
"RTN","DICM",80,0)
 . D ADDKEY^DIC3,GOT^DIC2 Q
"RTN","DICM",81,0)
DD S Y=-1 I DD D BAD^DIC1 Q
"RTN","DICM",82,0)
L I DIC(0)["L" K DD G ^DICN
"RTN","DICM",83,0)
B D BAD^DIC1 Q
"RTN","DICM",84,0)
 ;
"RTN","DICM",85,0)
N D RS S X=$E(X,2,$L(X)-1),%=D D
"RTN","DICM",86,0)
 . I DINDEX("#")>1 S %Y=+$G(DINDEX(1,"FIELD")),DS=$G(^DD(+$G(DINDEX(1,"FILE")),%Y,0)) Q:DS]""
"RTN","DICM",87,0)
 . S DS=^DD(+DO(2),.01,0),%Y=.01 Q
"RTN","DICM",88,0)
 F Y="P","D","S","V" I $P(DS,U,2)[Y K:Y="P" DO D ^DICM1 S:$D(X)#2 DS("INT")=X Q
"RTN","DICM",89,0)
 I $D(X),DINDEX("#")>1 S X(1)=X
"RTN","DICM",90,0)
 S Y=-1 D L:$D(X),E
"RTN","DICM",91,0)
 I Y'>0 K DUOUT D BAD^DIC1 Q
"RTN","DICM",92,0)
 G 2
"RTN","DICM",93,0)
 ;
"RTN","DICM",94,0)
A ; Set variables needed for transforming date/set/ptr/var.ptr
"RTN","DICM",95,0)
 S DICR(DICR+1,4)=%
"RTN","DICM",96,0)
 D % K DF,DID,DINUM Q
"RTN","DICM",97,0)
 ;
"RTN","DICM",98,0)
% ; Set variables up before doing lookup w/transformed value
"RTN","DICM",99,0)
 I DIC(0)'["L" S DICR(DICR+1,8)=1
"RTN","DICM",100,0)
 E  I '$$OKTOADD^DICM0(.DIFILEI,.DINDEX,.DIFINDER) S DICR(DICR+1,8)=1
"RTN","DICM",101,0)
 I $G(DINUM)]"" S DICR(DICR+1,10)=DINUM
"RTN","DICM",102,0)
 I $D(DF) S DICR(DICR+1,9)=DF S:$G(DID)]"" DICR(DICR+1,9.1)=$G(DID(1))_U_DID
"RTN","DICM",103,0)
RS S DICR=DICR+1,DICR(DICR)=X,DICR(DICR,0)=DIC(0),DIC(0)=$TR(DIC(0),"A"),DIC(0)=$TR(DIC(0),"Q") Q
"RTN","DICM",104,0)
 ;
"RTN","DICM",105,0)
D S:$G(DICR(DICR,10))]"" DINUM=DICR(DICR,10)
"RTN","DICM",106,0)
 S (D,DF)=DICR(DICR,4) D
"RTN","DICM",107,0)
 . N T S T=$P($G(DS),U,2)
"RTN","DICM",108,0)
 . S DIC(0)=$TR(DIC(0),"M","") I T["V" S DIC(0)=$TR(DIC(0),"A","")
"RTN","DICM",109,0)
 . I D="B",T'["D",'$G(DITRANX) S DIC(0)=DIC(0)_"s"
"RTN","DICM",110,0)
 . I T["P"!(T["V")!(T["S") S DIC(0)=DIC(0)_"X"
"RTN","DICM",111,0)
 . Q
"RTN","DICM",112,0)
 I DICR(DICR,4)=DINDEX N I M I=DINDEX N DINDEX M DINDEX=I K I S DINDEX("START")=DINDEX
"RTN","DICM",113,0)
 E  N DINDEX D
"RTN","DICM",114,0)
 . S (DINDEX,DINDEX("START"))=DICR(DICR,4),DINDEX("WAY")=1
"RTN","DICM",115,0)
 . D INDEX^DICUIX(.DIFILEI,DIFLAGS,.DINDEX,"",.DIVALUE) Q
"RTN","DICM",116,0)
 I DINDEX("#")>1 S (DINDEX(1),DINDEX(1,"FROM"),DINDEX(1,"PART"))=$G(X)
"RTN","DICM",117,0)
RCR S:'$D(DIDA) DICRS=1
"RTN","DICM",118,0)
DIC ;
"RTN","DICM",119,0)
 I $D(DICR(DICR,8)) S DIC(0)=$TR(DIC(0),"L")
"RTN","DICM",120,0)
 S Y=-1 I $D(X) D  ;**22*159  WAS: I $D(X),$L(X)<31 D
"RTN","DICM",121,0)
 . N DIVAL S (DIVAL,DIVAL(1))=X N X S (X,X(1))=DIVAL
"RTN","DICM",122,0)
 . D RENUM^DIC1 K DIDA Q
"RTN","DICM",123,0)
 I $G(DICR) S:DIC(0)["L" DICR(DICR-1,6)=1 K:$D(DICR(DICR,4)) DF
"RTN","DICM",124,0)
E S D="B" Q:'$G(DICR)  ;**GFT
"RTN","DICM",125,0)
 S %=DICR,X=DICR(%),DIC(0)=DICR(%,0),DICR=%-1
"RTN","DICM",126,0)
 S:$G(DICR(%,10))]"" DINUM=DICR(%,10)
"RTN","DICM",127,0)
 S:$D(DICR(%,9)) (D,DF)=DICR(%,9) I $G(DICR(%,9.1))]"" S:$P(DICR(%,9.1),U)]"" DID(1)=$P(DICR(%,9.1),U) S DID=$P(DICR(%,9.1),U,2,999)
"RTN","DICM",128,0)
 K DICRS,DICR(%) D DO^DIC1:'$D(DO(2)) Q
"RTN","DICM",129,0)
 ;
"RTN","DICM",130,0)
NQ I $L(X)<14,X?.NP,+X=X,@("$D("_DIC_"X,0))") S Y=X D S^DIC3
"RTN","DICM",131,0)
 Q
"RTN","DICM",132,0)
 ;
"RTN","DICM",133,0)
SOUNDEX I DIC(0)["E",'$D(DICRS) W "  " D RS,SOU S DIC(0)=$TR(DIC(0),"L") D RCR Q:Y>0
"RTN","DICM",134,0)
 G R
"RTN","DICM",135,0)
 ;
"RTN","DICM",136,0)
7 S Y=-1 N % S %=$S($D(DIC("S")):DIC("S"),1:1) ;RECURSIVE CALL TO ^DIC!
"RTN","DICM",137,0)
 I $D(DS),'$D(DIC("S1")) D
"RTN","DICM",138,0)
 . S DIC("S")=DS I '% S DIC("S")=DIC("S")_" X DIC(""S1"")",DIC("S1")=%
"RTN","DICM",139,0)
 . I X]"" D
"RTN","DICM",140,0)
 . . N DIVAL S (DIVAL,DIVAL(1))=X,DIVAL(0)=1 N X S (X,X(1))=DIVAL
"RTN","DICM",141,0)
 . . N DINDEX,DIFILEI
"RTN","DICM",142,0)
 . . S DIC(0)=$TR(DIC(0),"L") D F^DIC
"RTN","DICM",143,0)
 . K DIC("S") S:$D(DIC("S1")) DIC("S")=DIC("S1") K DIC("S1")
"RTN","DICM",144,0)
 D E Q
"RTN","DICM",145,0)
 ;
"RTN","DICM",146,0)
SOU D SOU^DICM1 Q
"RTN","DICU2")
0^15^B28509022^B28019483
"RTN","DICU2",1,0)
DICU2 ;SEA/TOAD,SF/TKW-VA FileMan: Lookup Tools, Return IDs ;11MAY2011
"RTN","DICU2",2,0)
 ;;22.0;VA FileMan;**165**;Mar 30, 1999;Build 32
"RTN","DICU2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DICU2",4,0)
 ;
"RTN","DICU2",5,0)
IDS(DIFILE,DIEN,DIFLAGS,DINDEX,DICOUNT,DIDENT,DILIST,DI0NODE) ;
"RTN","DICU2",6,0)
 ;
"RTN","DICU2",7,0)
 ; ENTRY POINT--add an entry's identifiers to output
"RTN","DICU2",8,0)
 ;
"RTN","DICU2",9,0)
I1 ; setup 0-node and ID array interface, and output IEN
"RTN","DICU2",10,0)
 ;
"RTN","DICU2",11,0)
 I DIFLAGS["h" N F,N,I M F=DIFILE S N=$G(DI0NODE),I=+$G(DIEN) N DIFILE,DI0NODE,DIEN M DIFILE=F S DIEN=I S:N]"" DI0NODE=N K F,N,I
"RTN","DICU2",12,0)
 I '$D(DI0NODE) S DI0NODE=$G(@DIFILE(DIFILE)@(+DIEN,0))
"RTN","DICU2",13,0)
 N DID,DIDVAL
"RTN","DICU2",14,0)
 I DIFLAGS["P" N DINODE S DINODE=+DIEN
"RTN","DICU2",15,0)
 E  S @DILIST@(2,DICOUNT)=+DIEN
"RTN","DICU2",16,0)
 ;
"RTN","DICU2",17,0)
I1A ; output primary value (index for Lister, .01 for Finder)
"RTN","DICU2",18,0)
 ;
"RTN","DICU2",19,0)
 I DIFLAGS'["P",$D(DIDENT(-2)) D
"RTN","DICU2",20,0)
 . N DIOUT S DIOUT=$NA(@DILIST@(1,DICOUNT))
"RTN","DICU2",21,0)
 . I DIFLAGS[3 N DISUB D  Q
"RTN","DICU2",22,0)
 . . F DISUB=0:0 S DISUB=$O(DIDENT(0,-2,DISUB)) Q:'DISUB  D
"RTN","DICU2",23,0)
 . . . I DINDEX("#")'>1 D SET(0,-2,DISUB,DIOUT,.DINDEX,.DIFILE) Q
"RTN","DICU2",24,0)
 . . . N I S I=$NA(@DIOUT@(DISUB)) D SET(0,-2,DISUB,I,.DINDEX,.DIFILE)
"RTN","DICU2",25,0)
 . I $D(DIDENT(0,-2,.01)) D SET(0,-2,.01,DIOUT,"",.DIFILE)
"RTN","DICU2",26,0)
 . Q
"RTN","DICU2",27,0)
 ;
"RTN","DICU2",28,0)
I2 ; start loop: loop through output values
"RTN","DICU2",29,0)
 ;
"RTN","DICU2",30,0)
 I DIFLAGS["P" N DILENGTH S DILENGTH=$L(DINODE)
"RTN","DICU2",31,0)
 N DICODE,DICRSR,DIOUT,DISUB S DICRSR=-1
"RTN","DICU2",32,0)
 F  S DICRSR=$O(DIDENT(DICRSR)) Q:DICRSR=""!($G(DIERR))  S DID="" F  S DID=$O(DIDENT(DICRSR,DID)) Q:DID=""!($G(DIERR))  S DISUB="" F  D  Q:DISUB=""!$G(DIERR)
"RTN","DICU2",33,0)
 . I DIFLAGS'["P",DID=-2 Q
"RTN","DICU2",34,0)
 . S DISUB=$O(DIDENT(DICRSR,DID,DISUB)) Q:DISUB=""
"RTN","DICU2",35,0)
 . K DIDVAL
"RTN","DICU2",36,0)
I20 . ; output indexed field if "IX" was in FIELDS parameter
"RTN","DICU2",37,0)
 . I DID=0 D  Q
"RTN","DICU2",38,0)
 . . D SET(DICRSR,DID,DISUB,"DIDVAL",.DINDEX,.DIFILE)
"RTN","DICU2",39,0)
 . . I DIFLAGS["P" D ADD(.DIFLAGS,.DINODE,.DILENGTH,DIDVAL,DIEN,DILIST) Q
"RTN","DICU2",40,0)
 . . M @DILIST@("ID",DICOUNT,0,DISUB)=DIDVAL Q
"RTN","DICU2",41,0)
 .
"RTN","DICU2",42,0)
I3 . ; output field
"RTN","DICU2",43,0)
 . ; distinguish between computed and value fields
"RTN","DICU2",44,0)
 .
"RTN","DICU2",45,0)
 . I DID D  Q:$G(DIERR)
"RTN","DICU2",46,0)
 . . ; process fields that are not computed.
"RTN","DICU2",47,0)
 . . I $G(DIDENT(DICRSR,DID,0,"TYPE"))'="C" D
"RTN","DICU2",48,0)
 . . . D SET(DICRSR,DID,DISUB,"DIDVAL",.DINDEX,.DIFILE) Q
"RTN","DICU2",49,0)
 . .
"RTN","DICU2",50,0)
I4 . . ; computed fields
"RTN","DICU2",51,0)
 . . E  D
"RTN","DICU2",52,0)
 . . . N %,%H,%T,A,B,C,D,DFN,I,X,X1,X2,Y,Z,Z0,Z1
"RTN","DICU2",53,0)
 . . . N DA D DA^DILF(DIEN,.DA) ;M DA=DIEN S DA=$P(DIEN,",")
"RTN","DICU2",54,0)
 . . . N DIARG S DIARG="D0"
"RTN","DICU2",55,0)
 . . . N DIMAX S DIMAX=+$O(DA(""),-1)
"RTN","DICU2",56,0)
 . . . N DIDVAR F DIDVAR=1:1:DIMAX S DIARG=DIARG_",D"_DIDVAR
"RTN","DICU2",57,0)
 . . . N @DIARG F DIDVAR=0:1:DIMAX-1 S @("D"_DIDVAR)=DA(DIMAX-DIDVAR)
"RTN","DICU2",58,0)
 . . . S @("D"_DIMAX)=DA
"RTN","DICU2",59,0)
 . . . X DIDENT(DICRSR,DID,0) S DIDVAL=$G(X)
"RTN","DICU2",60,0)
 . .
"RTN","DICU2",61,0)
I5 . . ; set field into array or pack node
"RTN","DICU2",62,0)
 . .
"RTN","DICU2",63,0)
 . . I DIFLAGS'["P" M @DILIST@("ID",DICOUNT,DID)=DIDVAL
"RTN","DICU2",64,0)
 . . E  D ADD(.DIFLAGS,.DINODE,.DILENGTH,DIDVAL,DIEN,DILIST)
"RTN","DICU2",65,0)
 .
"RTN","DICU2",66,0)
I6 . ; output display-only identifier
"RTN","DICU2",67,0)
 .
"RTN","DICU2",68,0)
 . E  D
"RTN","DICU2",69,0)
 . . N %,D,DIC,X,Y,Y1
"RTN","DICU2",70,0)
 . . S D=DINDEX
"RTN","DICU2",71,0)
 . . S DIC=DIFILE(DIFILE,"O")
"RTN","DICU2",72,0)
 . . S DIC(0)=$TR(DIFLAGS,"2^fglpqtuv104")
"RTN","DICU2",73,0)
 . . M Y=DIEN S Y=$P(DIEN,",")
"RTN","DICU2",74,0)
 . . S Y1=$G(@DIFILE(DIFILE)@(+DIEN,0)),Y1=DIEN
"RTN","DICU2",75,0)
 . .
"RTN","DICU2",76,0)
I7 . . ; execute the identifier's code
"RTN","DICU2",77,0)
 . .
"RTN","DICU2",78,0)
 . . N DIX S DIX=DIDENT(DICRSR,DID,0)
"RTN","DICU2",79,0)
 . . X DIX
"RTN","DICU2",80,0)
 . . I $G(DIERR) D  Q
"RTN","DICU2",81,0)
 . . . N DICONTXT I DID="ZZZ ID" S DICONTXT="Identifier parameter"
"RTN","DICU2",82,0)
 . . . E  S DICONTXT="MUMPS Identifier"
"RTN","DICU2",83,0)
 . . . D ERR^DICF4(120,DIFILE,DIEN,"",DICONTXT)
"RTN","DICU2",84,0)
 . .
"RTN","DICU2",85,0)
I8 . . ; set output from identifier into output array or pack node
"RTN","DICU2",86,0)
 . . 
"RTN","DICU2",87,0)
 . . N DI,DILINE,DIEND S DI="" S:DIFLAGS'["P" DIEND=$O(@DILIST@("ID","WRITE",DICOUNT,"z"),-1)
"RTN","DICU2",88,0)
 . . I $O(^TMP("DIMSG",$J,""))="" S ^TMP("DIMSG",$J,1)=""
"RTN","DICU2",89,0)
 . . F  D  Q:DI=""!$G(DIERR)
"RTN","DICU2",90,0)
 . . . S DI=$O(^TMP("DIMSG",$J,DI)) Q:DI=""
"RTN","DICU2",91,0)
 . . . S DILINE=$G(^TMP("DIMSG",$J,DI))
"RTN","DICU2",92,0)
 . . . I DIFLAGS["P" D ADD(.DIFLAGS,.DINODE,.DILENGTH,DILINE,DIEN,DILIST,DI) Q
"RTN","DICU2",93,0)
 . . . S DIEND=DIEND+1,@DILIST@("ID","WRITE",DICOUNT,DIEND)=DILINE
"RTN","DICU2",94,0)
 . . . Q
"RTN","DICU2",95,0)
 . . K DIMSG,^TMP("DIMSG",$J)
"RTN","DICU2",96,0)
 ;
"RTN","DICU2",97,0)
I9 ; for packed output, set pack node into output array
"RTN","DICU2",98,0)
 ;
"RTN","DICU2",99,0)
 I '$G(DIERR),DIFLAGS["P" S @DILIST@(DICOUNT,0)=DINODE
"RTN","DICU2",100,0)
 Q
"RTN","DICU2",101,0)
 ;
"RTN","DICU2",102,0)
 ;
"RTN","DICU2",103,0)
SET(DICRSR,DIFID,DISUB,DIOUT,DINDEX,DIFILE) ; Move data to DIOUT.
"RTN","DICU2",104,0)
 N F1,F2 M F1=DIFILE N DIFILE M DIFILE=F1
"RTN","DICU2",105,0)
 S F1=$O(DIDENT(DICRSR,DIFID,DISUB,"")),F2=$O(DIDENT(DICRSR,DIFID,DISUB,F1))
"RTN","DICU2",106,0)
 F F1=F1,F2 D:F1]""
"RTN","DICU2",107,0)
 . I DIDENT(DICRSR,DIFID,DISUB,F1)["DIVAL" N DIVAL S @DINDEX(DISUB,"GET")
"RTN","DICU2",108,0)
 . N X S @("X="_DIDENT(DICRSR,DIFID,DISUB,F1))
"RTN","DICU2",109,0)
 . I $G(DIERR),DIFLAGS["h" K DIERR,^TMP("DIERR",$J) S X=DINDEX(DISUB)
"RTN","DICU2",110,0)
 . I X["""" S X=$$CONVQQ^DILIBF(X)
"RTN","DICU2",111,0)
 . I +$P(X,"E")'=X S X=""""_X_""""
"RTN","DICU2",112,0)
 . I F2="" S @(DIOUT_"="_X) Q
"RTN","DICU2",113,0)
 . S O=$NA(@DIOUT@(F1)),@(O_"="_X) Q
"RTN","DICU2",114,0)
 Q
"RTN","DICU2",115,0)
 ;
"RTN","DICU2",116,0)
TRANOUT(DISUB,DIVL) ; Execute TRANSFORM FOR DISPLAY on index value
"RTN","DICU2",117,0)
 N X S X=DIVL
"RTN","DICU2",118,0)
 N DICODE S DICODE=$G(DINDEX(DISUB,"TRANOUT"))
"RTN","DICU2",119,0)
 I DICODE]"" X DICODE
"RTN","DICU2",120,0)
 Q X
"RTN","DICU2",121,0)
 ;
"RTN","DICU2",122,0)
ADD(DIFLAGS,DINODE,DILENGTH,DINEW,DIEN,DILIST,DILCNT) ;
"RTN","DICU2",123,0)
 ;
"RTN","DICU2",124,0)
 ; for Packed output, add DINEW to DINODE, erroring if overflow
"RTN","DICU2",125,0)
 ; xform if it contains ^
"RTN","DICU2",126,0)
 ;
"RTN","DICU2",127,0)
A1 N DINEWLEN,DELIM S DINEWLEN=$L(DINEW),DELIM=$S($G(DILCNT)'>1:"^",1:"~")
"RTN","DICU2",128,0)
 S DILENGTH=DILENGTH+1+DINEWLEN
"RTN","DICU2",129,0)
 I DILENGTH>255 D ERR^DICF4(206,"","","",+DIEN) Q
"RTN","DICU2",130,0)
 I DIFLAGS'[2,DINEW[U S DIFLAGS="2^"_DIFLAGS D ENCODE(DILIST,.DINODE)
"RTN","DICU2",131,0)
 I DIFLAGS[2,DINEW[U!(DINEW["&") S DINEW=$$HTML^DILF(DINEW) Q:$G(DIERR)
"RTN","DICU2",132,0)
 S DINODE=DINODE_DELIM_DINEW
"RTN","DICU2",133,0)
 Q
"RTN","DICU2",134,0)
 ;
"RTN","DICU2",135,0)
ENCODE(DILIST,DINODE) ;
"RTN","DICU2",136,0)
 ;
"RTN","DICU2",137,0)
 ; ADD: HTML encode records already output (we found an embedded ^)
"RTN","DICU2",138,0)
 ; procedure: loop through list encoding &s
"RTN","DICU2",139,0)
 ;
"RTN","DICU2",140,0)
E1 N DILINE,DIRULE S DIRULE(1,"&")="&amp;"
"RTN","DICU2",141,0)
 N DIREC S DIREC=0 F  S DIREC=$O(@DILIST@(DIREC)) Q:'DIREC  D
"RTN","DICU2",142,0)
 . S DILINE=@DILIST@(DIREC,0) Q:DILINE'["&"
"RTN","DICU2",143,0)
 . S @DILIST@(DIREC,0)=$$TRANSL8^DILF(DILINE,.DIRULE)
"RTN","DICU2",144,0)
 I DINODE["&" S DINODE=$$TRANSL8^DILF(DINODE,.DIRULE)
"RTN","DICU2",145,0)
 Q
"RTN","DICUIX")
0^12^B19486149^B19550178
"RTN","DICUIX",1,0)
DICUIX ;SEA/TOAD,SF/TKW-FileMan: Lookup Tools, Indexes ;19APR2011
"RTN","DICUIX",2,0)
 ;;22.0;VA FileMan;**20,28,67,164,165**;Mar 30, 1999;Build 32
"RTN","DICUIX",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DICUIX",4,0)
 ;
"RTN","DICUIX",5,0)
INDEX(DIFILE,DIFLAGS,DINDEX,DIFROM,DIPART,DINUMBER,DISCREEN,DILIST,DIOUT) ;
"RTN","DICUIX",6,0)
 ;
"RTN","DICUIX",7,0)
 ; build DINDEX array data for index
"RTN","DICUIX",8,0)
 ;
"RTN","DICUIX",9,0)
I1 ; try to find Index in Index file
"RTN","DICUIX",10,0)
 ;
"RTN","DICUIX",11,0)
 N DICODE,DIGET,DILENGTH,DINODE,DISUB,DITEMP,DITEMP2,DITO,DITOIEN,DITYPE,DIWAY,DIXIEN
"RTN","DICUIX",12,0)
 S DINDEX("FLIST")="",DINDEX("AT")=1,DIFROM("IEN")=+$G(DIFROM("IEN")),DIXIEN="",DIGET=1
"RTN","DICUIX",13,0)
 S:DINDEX'="#" DIXIEN=$O(^DD("IX","BB",DIFILE,DINDEX,""))
"RTN","DICUIX",14,0)
 I 'DIXIEN D XREF(.DIFILE,.DIFLAGS,.DINDEX,.DIPART,.DIFROM) Q
"RTN","DICUIX",15,0)
 ;
"RTN","DICUIX",16,0)
I2 ; in Index file, build list of subscript data
"RTN","DICUIX",17,0)
 ;
"RTN","DICUIX",18,0)
 S DINODE=^DD("IX",DIXIEN,0)
"RTN","DICUIX",19,0)
 S DINDEX("IXTYPE")=$P(DINODE,U,4) S:DIFLAGS["4" DINDEX("IXFILE")=DIXIEN
"RTN","DICUIX",20,0)
 S DINDEX("#")=0
"RTN","DICUIX",21,0)
 S DISUB=$O(^DD("IX",DIXIEN,11.1,"AC","Z"),-1)
"RTN","DICUIX",22,0)
 I $G(DIFROM(DISUB+1)) M DIFROM("IEN")=DIFROM(DISUB+1)
"RTN","DICUIX",23,0)
 S (DISUB,DIOUT)=0 N S
"RTN","DICUIX",24,0)
 F  D  Q:'DISUB  Q:DIOUT
"RTN","DICUIX",25,0)
 . S DISUB=$O(^DD("IX",DIXIEN,11.1,"AC",DISUB)) Q:'DISUB  S S=$O(^(DISUB,0)) Q:'S
"RTN","DICUIX",26,0)
 . S DINDEX("#")=DISUB,DIGET=1
"RTN","DICUIX",27,0)
 . S DINODE=$G(^DD("IX",DIXIEN,11.1,S,0))
"RTN","DICUIX",28,0)
 . I DIFLAGS["l" N X D  S DINDEX(DISUB,"PROMPT")=X
"RTN","DICUIX",29,0)
 . . S X=$P(DINODE,U,8) Q:X]""
"RTN","DICUIX",30,0)
 . . I $P(DINODE,U,3),$P(DINODE,U,4) S X=$P($G(^DD($P(DINODE,U,3),$P(DINODE,U,4),0)),U)
"RTN","DICUIX",31,0)
 . . Q
"RTN","DICUIX",32,0)
 . S DINDEX(DISUB,"FIELD")=$P(DINODE,U,4)
"RTN","DICUIX",33,0)
 . S DINDEX(DISUB,"FILE")=$P(DINODE,U,3)
"RTN","DICUIX",34,0)
 . I $P(DINODE,U,2)["C"!(DINDEX(DISUB,"FILE")="") S DINDEX(DISUB,"FIELD")=""
"RTN","DICUIX",35,0)
 . I DINDEX(DISUB,"FILE"),DINDEX(DISUB,"FIELD") D
"RTN","DICUIX",36,0)
 . . I $G(^DD("IX",DIXIEN,11.1,S,4))]"" S DINDEX(DISUB,"TRANCODE")=^(4)
"RTN","DICUIX",37,0)
 . . I $G(^DD("IX",DIXIEN,11.1,S,2))]"" D
"RTN","DICUIX",38,0)
 . . . I $G(^DD("IX",DIXIEN,11.1,S,3))="" S DIGET=0 Q
"RTN","DICUIX",39,0)
 . . . S DINDEX(DISUB,"TRANOUT")=^DD("IX",DIXIEN,11.1,S,3),DIGET=3 Q
"RTN","DICUIX",40,0)
 . . I "KSMU"[DINDEX("IXTYPE") S DIGET=2
"RTN","DICUIX",41,0)
 . . Q
"RTN","DICUIX",42,0)
 . S DILENGTH=$P(DINODE,U,5) I 'DILENGTH S DILENGTH=30 ;GFT
"RTN","DICUIX",43,0)
 . S DIWAY=$S($P(DINODE,U,7)="B":-1,1:1)
"RTN","DICUIX",44,0)
 . D COMMON1^DICUIX2
"RTN","DICUIX",45,0)
 . Q
"RTN","DICUIX",46,0)
 I DIOUT S @DILIST@(0)="0^"_DINUMBER_"^0" D OUT^DICL Q
"RTN","DICUIX",47,0)
 D:DIFLAGS'["q" COMMON2^DICUIX2
"RTN","DICUIX",48,0)
 S DINDEX("FLIST")=DINDEX("FLIST")_"^"
"RTN","DICUIX",49,0)
 I DIFLAGS'["l",DIFLAGS'["h" Q
"RTN","DICUIX",50,0)
 N F,F1,F2,I S F=DINDEX("FLIST")
"RTN","DICUIX",51,0)
 F I=1:1:DINDEX("#") I $G(DINDEX(I,"GETEXT"))=0 S F1=$G(DINDEX(I,"FILE")),F2=$G(DINDEX(I,"FIELD")) I F1=DIFILEI,F2 D
"RTN","DICUIX",52,0)
 . S F1=$F(F,("^"_F2_"^")) Q:'F1  S F1=F1-2
"RTN","DICUIX",53,0)
 . S $E(F,(F1-$L(F2)),F1)="" Q
"RTN","DICUIX",54,0)
 S DINDEX("FLISTD")=F Q
"RTN","DICUIX",55,0)
 ;
"RTN","DICUIX",56,0)
XREF(DIFILE,DIFLAGS,DINDEX,DIPART,DIFROM) ;
"RTN","DICUIX",57,0)
 ; Index is in "IX" nodes
"RTN","DICUIX",58,0)
 ;
"RTN","DICUIX",59,0)
X1 ; Set DINDEX for search through upright file
"RTN","DICUIX",60,0)
 ;
"RTN","DICUIX",61,0)
 I DINDEX="#" D  Q
"RTN","DICUIX",62,0)
 . S DINDEX("#")=0,DINDEX(1,"FILE")=DIFILE,DINDEX(1,"ROOT")=DIFILE(DIFILE),DINDEX(1,"TYPE")="N"
"RTN","DICUIX",63,0)
 . N X S X=$S($G(DIFROM(1)):DIFROM(1),DIPART(1):DIPART(1),1:$G(DIFROM("IEN")))
"RTN","DICUIX",64,0)
 . S (DIFROM,DIFROM(1))=X S:X DIFROM("IEN")=X
"RTN","DICUIX",65,0)
 . I DIFLAGS["l"!(DIFLAGS["h") S DINDEX("FLISTD")=""
"RTN","DICUIX",66,0)
 . D:DIFLAGS'["q" COMMON2^DICUIX2 Q
"RTN","DICUIX",67,0)
 S DINDEX("#")=1,DINDEX("IXTYPE")="R"
"RTN","DICUIX",68,0)
 S DINDEX(1,"FILE")=$O(^DD(DIFILE,0,"IX",DINDEX,""))
"RTN","DICUIX",69,0)
 ;
"RTN","DICUIX",70,0)
X2 ; Build DINDEX for index in IX nodes.
"RTN","DICUIX",71,0)
 ;
"RTN","DICUIX",72,0)
 S DIOUT=0,DILENGTH=30
"RTN","DICUIX",73,0)
 S DINDEX(1,"FIELD")=""
"RTN","DICUIX",74,0)
 I DINDEX(1,"FILE") S DINDEX(1,"FIELD")=$O(^DD(DIFILE,0,"IX",DINDEX,DINDEX(1,"FILE"),""))
"RTN","DICUIX",75,0)
 I DINDEX(1,"FIELD")="",DINDEX="B" D
"RTN","DICUIX",76,0)
 . S DINDEX(1,"FILE")=DIFILE
"RTN","DICUIX",77,0)
 . S DINDEX(1,"FIELD")=.01 Q
"RTN","DICUIX",78,0)
 I DIFLAGS[3,DINDEX="B",'$D(@DIFILE(DIFILE)@("B")) D
"RTN","DICUIX",79,0)
 . D TMPB^DICUIX1(.DITEMP,DIFILE)
"RTN","DICUIX",80,0)
 . S DIFILE(DIFILE,"NO B")=DITEMP Q
"RTN","DICUIX",81,0)
 I DIFLAGS["l" S DINDEX(1,"PROMPT")=""
"RTN","DICUIX",82,0)
 I DINDEX(1,"FILE"),DINDEX(1,"FIELD") D  I DINDEX("IXTYPE")="*" K DINDEX S DINDEX="" Q
"RTN","DICUIX",83,0)
 . I DIFLAGS["l" S DINDEX(1,"PROMPT")=$P($G(^DD(DINDEX(1,"FILE"),DINDEX(1,"FIELD"),0)),U)
"RTN","DICUIX",84,0)
 . N I,X,Y
"RTN","DICUIX",85,0)
 . F I=0:0 S I=$O(^DD(DINDEX(1,"FILE"),DINDEX(1,"FIELD"),1,I)) Q:'I  S X=$G(^(I,0)) I $P(X,U,2)=DINDEX S Y=$G(^(1)) D  Q
"RTN","DICUIX",86,0)
 . . S X=$E($P(X,U,3),1,2)
"RTN","DICUIX",87,0)
 . . S DINDEX("IXTYPE")=$S(X="":"R",X="KW":"K",X="SO":"S",(X="TR")!(X="BU"):"*",X]"":X,1:"R")
"RTN","DICUIX",88,0)
 . . I "KSMU"[DINDEX("IXTYPE") S DIGET=2
"RTN","DICUIX",89,0)
 . . S DILENGTH=+$P(Y,"$E(X,1,",2)
"RTN","DICUIX",90,0)
 . . S:'DILENGTH DILENGTH=30 Q  ;!(DILENGTH>100)
"RTN","DICUIX",91,0)
 . Q
"RTN","DICUIX",92,0)
 I $G(DIFROM(2)) S DIFROM("IEN")=DIFROM(2)
"RTN","DICUIX",93,0)
 S DISUB=1,DIWAY=1,DIOUT=0
"RTN","DICUIX",94,0)
 N I,X,Y
"RTN","DICUIX",95,0)
 D COMMON1^DICUIX2
"RTN","DICUIX",96,0)
 I DIOUT S @DILIST@(0)="0^"_DINUMBER_"^0" D OUT^DICL Q
"RTN","DICUIX",97,0)
 D:DIFLAGS'["q" COMMON2^DICUIX2
"RTN","DICUIX",98,0)
 S DINDEX("FLIST")=DINDEX("FLIST")_"^"
"RTN","DICUIX",99,0)
 I DIFLAGS["l"!(DIFLAGS["h") D
"RTN","DICUIX",100,0)
 . I DIGET=2 S DINDEX("FLISTD")="^^" Q
"RTN","DICUIX",101,0)
 . S DINDEX("FLISTD")=DINDEX("FLIST") Q
"RTN","DICUIX",102,0)
 S DITEMP=$G(DIFILE(DIFILE,"NO B")) I DITEMP]"" D BLDB^DICUIX1(DIFILE(DIFILE),DITEMP)
"RTN","DICUIX",103,0)
 Q
"RTN","DICUIX",104,0)
 ;
"RTN","DICUIX",105,0)
 ;
"RTN","DIDT")
0^6^B22414014^B19912051
"RTN","DIDT",1,0)
DIDT ;SFISC/GFT-DATE/TIME UTILITY ;27JUL2010
"RTN","DIDT",2,0)
 ;;22.0;VA FileMan;**14,35,162,165**;Mar 30, 1999;Build 32
"RTN","DIDT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","DIDT",4,0)
%DT ;
"RTN","DIDT",5,0)
 I $G(DUZ("LANG"))>1,($G(^DI(.85,DUZ("LANG"),20.2))]"") X ^(20.2) Q
"RTN","DIDT",6,0)
CONT ;
"RTN","DIDT",7,0)
 K % S:$D(%DT)[0 %DT="" S:$G(DIQUIET)!($D(DDS)#2)!($D(ZTQUEUED)) %DT=$P(%DT,"E")_$P(%DT,"E",2) G NA:%DT'["A"
"RTN","DIDT",8,0)
 W !,$S($D(%DT("A")):%DT("A"),1:"DATE: "),$S($D(%DT("B")):%DT("B")_"//",1:"")
"RTN","DIDT",9,0)
 R X:$S($D(DTIME):DTIME,1:300) S:'$T X="^",DTOUT=1 G:$L(X)>39 1
"RTN","DIDT",10,0)
 I $D(%DT("B")),X="" S X=%DT("B")
"RTN","DIDT",11,0)
 I "^"[X S Y=-1 K %I,% Q
"RTN","DIDT",12,0)
NA S %(0)=X G 1:X'?.ANP,1:$P(X,"@")?15.N,1:$P(X,"@",2)?15.N,1:$L(X)>39
"RTN","DIDT",13,0)
 F %=1:1:$L(X) Q:X?.UNP  S Y=$E(X,%) I Y?1L S X=$E(X,1,%-1)_$C($A(Y)-32)_$E(X,%+1,99) ;UPPER CASE
"RTN","DIDT",14,0)
 I %DT["E",X?."?" D HELP^%DTC G B
"RTN","DIDT",15,0)
 I %DT["N",X?.N G NO
"RTN","DIDT",16,0)
 I X?1.A,(X["MID"!(X["NOON")) S X="@"_X
"RTN","DIDT",17,0)
 I X'?1"NOV".E,X?1"N".1"OW".1P.E G N^%DTC:%DT["T"!(%DT["R")&(%DT'["M") S X=$E(X,2,99),X="T"_$P(X,"OW")_$P(X,"OW",2)
"RTN","DIDT",18,0)
 I X?1.N." "1.2A!(X?1.N1":"2N." ".2A)!(X?1.N1":"2N1":"2N." ".2A) S X="T@"_X
"RTN","DIDT",19,0)
 I X?7N1"."1.N G R
"RTN","DIDT",20,0)
 I X'["@",%DT'["R" G R
"RTN","DIDT",21,0)
 I %DT'["T",%DT'["R" G NO
"RTN","DIDT",22,0)
 I %DT["M" G NO
"RTN","DIDT",23,0)
 S Y=$P(X,"@",2,9),X=$P(X,"@")
"RTN","DIDT",24,0)
 F %=2,3 S %I=$P(Y,":",%) I %I?1N.E,%I'?2N.PA G 1
"RTN","DIDT",25,0)
 S:X="" X="T" S Y=$P(Y,":")_$P(Y,":",2)_$P(Y,":",3,9),%I=Y
"RTN","DIDT",26,0)
 I Y?1.A S Y=$S(Y["MID":2400,Y["NOON":1200,1:"")
"RTN","DIDT",27,0)
T G G:Y?4N,G1:Y?6N&(%DT["S"),1:Y'?1.6N." ".1(1"AM",1"A",1"A.M",1"PM",1"P",1"P.M").P I %DT["R",Y="" G NO
"RTN","DIDT",28,0)
 S %I=$P(1_%I,+(1_Y),2) S:%I]"" Y=$P(Y,%I)
"RTN","DIDT",29,0)
 I Y?5.6N G:%DT'["S" 1 S %(3)=$E(Y,$L(Y)-1,$L(Y)),Y=$E(Y,1,$L(Y)-2) G 1:%(3)>59
"RTN","DIDT",30,0)
 I Y?1.2N G:Y'<13 1 S Y=Y_"00" S:$E(Y)=0 %I="A"
"RTN","DIDT",31,0)
 I %I["A" S Y=$S(Y=1200&'$G(%(3)):2400,Y>1159:Y-1200,1:Y)
"RTN","DIDT",32,0)
 E  I Y?1.2"0"2N G:%I["P" 1
"RTN","DIDT",33,0)
 E  I Y<1200,%I["P"!(Y<600) S Y=Y+1200 ;ASSUME PM
"RTN","DIDT",34,0)
G G 1:Y>2400,1:Y#100>59,1:('Y&('$G(%(3)))) S %(1)=$S('Y:".0000",1:Y/10000) G R
"RTN","DIDT",35,0)
G1 G 1:Y>240000!'Y,1:$E(Y,3,4)#100>59,1:$E(Y,5,6)#100>59 S %(1)=Y/1000000
"RTN","DIDT",36,0)
R I %DT["F"!(%DT["P") D TY S %(9)=%
"RTN","DIDT",37,0)
7 G 8:X'?7N1".".E&(X'?7N) S Y=$E(X,8,16),%=$E(Y_"000000",2,7)
"RTN","DIDT",38,0)
 I Y,%DT'["T"!(%DT["M") G NO
"RTN","DIDT",39,0)
 I %DT["E",(%'?.N)!(%>240000)!($E(%,3,4)>59)!($E(%,5,6)>59) G NO
"RTN","DIDT",40,0)
 S:Y %(1)=+Y S X=$E(X,4,7)_($E(X,1,3)+1700),%(7)=1
"RTN","DIDT",41,0)
 I %DT["I",'$D(%("ALPHA")) S X=$E(X,3,4)_$E(X,1,2)_$E(X,5,9)
"RTN","DIDT",42,0)
8 S %I=0,%="" I X'?.N G T^%DTC:"T+-"[$E(X),U:X["^",1:$E(X)?1P,MTH:X?3.A&(%DT["M"),X
"RTN","DIDT",43,0)
 I X?8N,X>17999999,$E(X,5,8)<1300 S X=$E(X,5,8)_$E(X,1,4),%("ALPHA")=1 ;MAY BE '200101231' FOR 2001DEC31
"RTN","DIDT",44,0)
 I %DT'["X",X\300=6!(X?2N) S (%I(1),%I(2))=0,%I(3)=X G 3
"RTN","DIDT",45,0)
 F %I=0:1 S Y=$E(X,1,2),X=$E(X,3,9) G OT:Y="" D  G:%I="" 1
"RTN","DIDT",46,0)
 . I %DT["X",%DT'["M",%I<2,'Y S %I="" Q
"RTN","DIDT",47,0)
 . S:%I=2 Y=Y_X,X=""
"RTN","DIDT",48,0)
 . I %DT["X",%I=2,$L(Y)>2,Y'>1799 S %I="" Q
"RTN","DIDT",49,0)
 . S %I(%I+1)=Y Q
"RTN","DIDT",50,0)
 ;
"RTN","DIDT",51,0)
X S Y=$E(X),X=$E(X,2,99) I Y?1N G A:%?.N,Y ;PEEL OFF CHARACTER-BY-CHARACTER
"RTN","DIDT",52,0)
 I Y?1A G A:%?.A,Y
"RTN","DIDT",53,0)
OT D:%]"" % G 1:%I>3,X:Y?1P,1:Y]"",@%I
"RTN","DIDT",54,0)
Y D % S %=Y G 1:%I>3,X
"RTN","DIDT",55,0)
A S %=%_Y G X
"RTN","DIDT",56,0)
TY S %=$H#1461,%=$H\1461*4+(%\365)+141-(%=1460) Q
"RTN","DIDT",57,0)
0 ;
"RTN","DIDT",58,0)
1 W:%DT["E"&'$D(DIER) $C(7),$S('$D(DDS):" ??",1:"") ;INPUT IS BAD!
"RTN","DIDT",59,0)
B G %DT:%DT["A",NO
"RTN","DIDT",60,0)
U S X="^",%(0)=X
"RTN","DIDT",61,0)
NO S Y=-1 G Q:%DT'["A",Q:X["^" W $C(7)," ??" G %DT
"RTN","DIDT",62,0)
2 I %DT["M" S %I(3)=%I(2),%I(2)=0 G 3
"RTN","DIDT",63,0)
 I %I(2)>31!'%I(2),%DT'["X" S %I(3)=%I(2),%I(2)=0 G 1:'%I(2)&$G(%(1)) G 3
"RTN","DIDT",64,0)
 D TY S %I(3)=% D PF^%DTC:$D(%(9)) G C
"RTN","DIDT",65,0)
3 I %I(1)>1700 S %("YF")=%I(1),%I(1)=%I(2),%I(2)=%I(3),%I(3)=%("YF") ;YEAR FIRST: ALLOW '2010-1-31'
"RTN","DIDT",66,0)
 I %I(3)?2N D  G C
"RTN","DIDT",67,0)
 . I '$D(%(9)) D TY S %(9)=%
"RTN","DIDT",68,0)
 . N A S A=$E(%(9))*100
"RTN","DIDT",69,0)
 . I $E(%(9),2,3)=%I(3) S %I(3)=A+%I(3) Q
"RTN","DIDT",70,0)
 . I %DT["P" S %I(3)=$S(%I(3)<$E(%(9),2,3):A,1:A-100)+%I(3) Q
"RTN","DIDT",71,0)
 . I %DT["F" S %I(3)=$S(%I(3)>$E(%(9),2,3):A,1:A+100)+%I(3) Q
"RTN","DIDT",72,0)
 . S %I(3)=A+%I(3)
"RTN","DIDT",73,0)
 . I %(9)-%I(3)>80 S %I(3)=%I(3)+100 Q
"RTN","DIDT",74,0)
 . I %I(3)-%(9)>20 S %I(3)=%I(3)-100
"RTN","DIDT",75,0)
 . Q
"RTN","DIDT",76,0)
 S %I(3)=%I(3)-1700 G 1:%I(3)'?3N
"RTN","DIDT",77,0)
C I %DT["I",'$D(%("ALPHA")),'$D(%("YF")),%I(2)>0 S %=%I(2),%I(2)=%I(1),%I(1)=% ;INTERNATIONAL: REVERSE MONTH/DAY
"RTN","DIDT",78,0)
 I %I(2)="00",'$G(%(7)) G 1
"RTN","DIDT",79,0)
 I %DT["M",$G(%I(2)) G 1
"RTN","DIDT",80,0)
 I %I(1)>12!(%I(1)="00") G 1
"RTN","DIDT",81,0)
 I %I(2)>28,$E("303232332323",%I(1))+28<%I(2),%I(1)-2!(%I(2)-29)!(%I(3)#4)!('(%I(3)#100)&(%I(3)+1700#400)) G 1
"RTN","DIDT",82,0)
D I %DT["M",$G(%I(2)) S %I(2)=0
"RTN","DIDT",83,0)
 D P
"RTN","DIDT",84,0)
E I $D(%(1)) S:$D(%(3)) %(1)=$E(%(1)_"000",1,5)_%(3) S Y=+(Y_%(1))
"RTN","DIDT",85,0)
 I '$E(Y,6,7),Y["." G 1
"RTN","DIDT",86,0)
 I %DT["E" S %=Y D DD W "  ("_Y_")" S Y=%
"RTN","DIDT",87,0)
 I $D(%DT(0)) S %=%DT(0),%I=$S(%["-":Y,1:-Y) D:'% Z I $S(%DT["S":%,1:%\.0001/10000)+%I>0 G 1
"RTN","DIDT",88,0)
Q S X=%(0) K %,%I,%H Q
"RTN","DIDT",89,0)
 ;
"RTN","DIDT",90,0)
Z I $P("NOW",%(0))="" S %=Y
"RTN","DIDT",91,0)
 E  D NOW^%DTC
"RTN","DIDT",92,0)
 S:%DT(0)["-" %=-% Q
"RTN","DIDT",93,0)
 ;
"RTN","DIDT",94,0)
DD I $G(DUZ("LANG"))>1 S Y=$$OUT^DIALOGU(Y,"DD") Q
"RTN","DIDT",95,0)
 Q:'Y  S Y=$S($E(Y,4,5):$E($P($T(M)," ",$E(Y,4,5)+2),1,3)_" ",1:"")_$S($E(Y,6,7):$E(Y,6,7)_", ",1:"")_($E(Y,1,3)+1700)_$S(Y[".":"."_$P(Y,".",2),1:"")
"RTN","DIDT",96,0)
 I Y["." S Y=$P(Y,".")_"@"_$E(Y_0,14,15)_":"_$E(Y_"000",16,17)_$S($E(Y,18,19):":"_$E(Y_0,18,19),1:"")
"RTN","DIDT",97,0)
 I $D(%DT)#2,%DT["S",Y["@",$P(Y,":",3)="" S Y=Y_":00"
"RTN","DIDT",98,0)
 Q
"RTN","DIDT",99,0)
 ;
"RTN","DIDT",100,0)
P S Y=%I(3)_$E(%I(1)+100,2,3)_$E(%I(2)+100,2,3) Q
"RTN","DIDT",101,0)
 ;
"RTN","DIDT",102,0)
MTH S %=X D % G:%I>3 1
"RTN","DIDT",103,0)
 S %I(2)=0
"RTN","DIDT",104,0)
 D TY S %I(3)=% D:$D(%(9)) PF^%DTC
"RTN","DIDT",105,0)
 G D
"RTN","DIDT",106,0)
% ;I %DT["I",%?3.A S %I=9 Q
"RTN","DIDT",107,0)
 I %?3.A S %=$F($T(M)," "_%) I %>0 S %=$L($E($T(M),6,%-1)," ") D:%I=1  S %("ALPHA")=1 ;ONLY MONTH IS ALPHA
"RTN","DIDT",108,0)
 . N T S T=%I(1),%I(1)=%,%=T I $D(%("ALPHA")) S %I=9
"RTN","DIDT",109,0)
 S:%<1&(%'="00")&(%I'=2) %I=9 S %I=%I+1,%I(%I)=%,%=""
"RTN","DIDT",110,0)
M ;; JANUARY FEBRUARY MARCH APRIL MAY JUNE JULY AUGUST SEPTEMBER OCTOBER NOVEMBER DECEMBER
"RTN","DIDTC")
0^13^B31993211^B31975807
"RTN","DIDTC",1,0)
DIDTC ;SFISC/XAK-DATE/TIME OPERATIONS ;4MAY2011
"RTN","DIDTC",2,0)
 ;;22.0;VA FileMan;**14,36,71,117,164,165**;Mar 30, 1999;Build 32
"RTN","DIDTC",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DIDTC",4,0)
D N %T
"RTN","DIDTC",5,0)
 I 'X1!'X2 S X="",%Y=0 Q
"RTN","DIDTC",6,0)
 S X=X1 D H S X1=%H,X=X2,X2=%Y+1 D H S X=X1-%H,%Y=%Y+1&X2
"RTN","DIDTC",7,0)
 K %H,X1,X2 Q
"RTN","DIDTC",8,0)
 ;
"RTN","DIDTC",9,0)
C N %,%T,%Y
"RTN","DIDTC",10,0)
 S X=X1,X2=$J($G(X2),0,0) I 'X S (X,%H)="" Q
"RTN","DIDTC",11,0)
 D H S %H=%H+X2 D YMD S:$P(X1,".",2) X=X_"."_$P(X1,".",2) K X1,X2 Q
"RTN","DIDTC",12,0)
S S %=%#60/100+(%#3600\60)/100+(%\3600)/100 Q
"RTN","DIDTC",13,0)
 ;
"RTN","DIDTC",14,0)
H ;called from DIG, DIP4
"RTN","DIDTC",15,0)
 I X<1410000 S (%H,%T)=0,%Y=-1 Q
"RTN","DIDTC",16,0)
 S %Y=$E(X,1,3),%M=$E(X,4,5),%D=$E(X,6,7)
"RTN","DIDTC",17,0)
 S %T=$E(X_0,9,10)*60+$E(X_"000",11,12)*60+$E(X_"00000",13,14)
"RTN","DIDTC",18,0)
TOH N DILEAP D
"RTN","DIDTC",19,0)
 . N Y S Y=%Y+1700 S:%M<3 Y=Y-1
"RTN","DIDTC",20,0)
 . S DILEAP=(Y\4)-(Y\100)+(Y\400)-446 Q
"RTN","DIDTC",21,0)
 S %H=$P("^31^59^90^120^151^181^212^243^273^304^334","^",%M)+%D
"RTN","DIDTC",22,0)
 S %=('%M!'%D),%Y=%Y-141
"RTN","DIDTC",23,0)
 S %H=(%H+(%Y*365)+DILEAP+%),%Y=$S(%:-1,1:%H+4#7)
"RTN","DIDTC",24,0)
 K %M,%D,% Q
"RTN","DIDTC",25,0)
 ;
"RTN","DIDTC",26,0)
DOW D H S Y=%Y K %H,%Y Q
"RTN","DIDTC",27,0)
 ;
"RTN","DIDTC",28,0)
DW D H S Y=%Y,X=$P("SUN^MON^TUES^WEDNES^THURS^FRI^SATUR","^",Y+1)_"DAY"
"RTN","DIDTC",29,0)
 S:Y<0 X="" Q
"RTN","DIDTC",30,0)
 ;
"RTN","DIDTC",31,0)
7 I '%H S (%,X)="" Q
"RTN","DIDTC",32,0)
 S %=(%H>21608)+(%H>94657)+%H-.1,%Y=%\365.25+141,%=%#365.25\1
"RTN","DIDTC",33,0)
 S %D=%+306#(%Y#4=0+365)#153#61#31+1,%M=%-%D\29+1
"RTN","DIDTC",34,0)
 S X=%Y_"00"+%M_"00"+%D Q
"RTN","DIDTC",35,0)
 ;
"RTN","DIDTC",36,0)
YX ;called from DIV, etc
"RTN","DIDTC",37,0)
 D YMD S Y=X_% Q:Y=""  G DD^%DT
"RTN","DIDTC",38,0)
 ;
"RTN","DIDTC",39,0)
YMD ;called from DIP5. Documented entry point for converting a date/time %H in $H format into a date (in X) and time (in %) in FileMan internal format.
"RTN","DIDTC",40,0)
 I %H[",0" S %=%H N %H S %H=%-1_",86400"
"RTN","DIDTC",41,0)
 N %D,%M,%Y D 7 S %=$P(%H,",",2) D S
"RTN","DIDTC",42,0)
 Q
"RTN","DIDTC",43,0)
 ;
"RTN","DIDTC",44,0)
 ;
"RTN","DIDTC",45,0)
T ;from %DT
"RTN","DIDTC",46,0)
 F %=1:1 S Y=$E(X,%) Q:"+-"[Y  G 1^%DT:$E("TODAY",%)'=Y
"RTN","DIDTC",47,0)
 S X=$E(X,%+1,99) G PM:Y=""
"RTN","DIDTC",48,0)
 I X?1.N1"M" S %H=$H D MONTH G D^%DT
"RTN","DIDTC",49,0)
 I +X'=X D DMW S X=%
"RTN","DIDTC",50,0)
 G:'X 1^%DT
"RTN","DIDTC",51,0)
PM S @("%H=$H"_Y_X) D TT G 1^%DT:%I(3)'?3N,D^%DT
"RTN","DIDTC",52,0)
 ;
"RTN","DIDTC",53,0)
 ;
"RTN","DIDTC",54,0)
N ;from %DT
"RTN","DIDTC",55,0)
 F %=2:1 S Y=$E(X,%) Q:"+-"[Y  G 1^%DT:$E("NOW",%)'=Y
"RTN","DIDTC",56,0)
 I Y="" S %H=$H D %H G RT
"RTN","DIDTC",57,0)
 S X=$E(X,%+1,99)
"RTN","DIDTC",58,0)
 I X?1.N1"H" S X=X*3600,%H=$H,@("X=$P(%H,"","",2)"_Y_X),%=$S(X<0:-1,1:0)+(X\86400),X=X#86400,%H=$P(%H,",")+%_","_X G RT
"RTN","DIDTC",59,0)
 I X?1.N1"'" S X=X*60,%H=$H,@("X=$P(%H,"","",2)"_Y_X),%=$S(X<0:-1,1:0)+(X\86400),X=X#86400,%H=$P(%H,",")+%_","_X G RT
"RTN","DIDTC",60,0)
 I X?1.N1"M" S %H=$H D %H,MONTH G RT1
"RTN","DIDTC",61,0)
 D DMW G 1^%DT:'% S @("%H=$H"_Y_%),%H=%H_","_$P($H,",",2) D %H
"RTN","DIDTC",62,0)
RT D TT
"RTN","DIDTC",63,0)
RT1 S %=$P(%H,",",2) D S S %=X_$S(%:%,1:.24) I %DT'["S" S %=+$E(%,1,12)
"RTN","DIDTC",64,0)
 Q:'$D(%(0))  S Y=% G E^%DT
"RTN","DIDTC",65,0)
 ;
"RTN","DIDTC",66,0)
 ;
"RTN","DIDTC",67,0)
PF ;from %DT
"RTN","DIDTC",68,0)
 S %H=$H D YMD S %(9)=X,X=%DT["F"*2-1 I @("%I(1)*100+%I(2)"_$E("> <",X+2)_"$E(%(9),4,7)") S %I(3)=%I(3)+X
"RTN","DIDTC",69,0)
 Q
"RTN","DIDTC",70,0)
 ;
"RTN","DIDTC",71,0)
 ;
"RTN","DIDTC",72,0)
MONTH ;Add months to current date
"RTN","DIDTC",73,0)
 S Y=Y_+X
"RTN","DIDTC",74,0)
 D TT
"RTN","DIDTC",75,0)
 S %=%I(1)+Y,%I(1)=%-1#12+1,%I(3)=%I(3)+(%-$S(%>0:1,1:12)\12)
"RTN","DIDTC",76,0)
 S %="31^"_($$LEAP(%I(3))+28)_"^31^30^31^30^31^31^30^31^30^31"
"RTN","DIDTC",77,0)
 I %I(2)>$P(%,U,%I(1)) S %I(2)=$P(%,U,%I(1))
"RTN","DIDTC",78,0)
 S X=%I(3)_"00"+%I(1)_"00"+%I(2)
"RTN","DIDTC",79,0)
 Q
"RTN","DIDTC",80,0)
 ;
"RTN","DIDTC",81,0)
LEAP(X) ;Return 1 if leap year
"RTN","DIDTC",82,0)
 S:X<1700 X=X+1700
"RTN","DIDTC",83,0)
 Q '(X#4)&(X#100)!'(X#400)
"RTN","DIDTC",84,0)
 ;
"RTN","DIDTC",85,0)
TT N %M,%D,%Y D 7 S %I(1)=%M,%I(2)=%D,%I(3)=%Y
"RTN","DIDTC",86,0)
 Q
"RTN","DIDTC",87,0)
 ;
"RTN","DIDTC",88,0)
NOW S %H=$H,%H=$S($P(%H,",",2):%H,1:%H-1)
"RTN","DIDTC",89,0)
 D TT S %=$P(%H,",",2) D S S %=X_$S(%:%,1:.24) Q
"RTN","DIDTC",90,0)
 ;
"RTN","DIDTC",91,0)
DMW S %=$S(X?1.N1"D":+X,X?1.N1"W":X*7,X?1.N1"M":X*30,+X=X:X,1:0)
"RTN","DIDTC",92,0)
 Q
"RTN","DIDTC",93,0)
 ;
"RTN","DIDTC",94,0)
%H I '$P(%H,",",2) S %H=%H-1 Q
"RTN","DIDTC",95,0)
 I $P(%H,",",2)<60&(%DT'["S") S $P(%H,",",2)=60
"RTN","DIDTC",96,0)
 Q
"RTN","DIDTC",97,0)
 ;
"RTN","DIDTC",98,0)
COMMA ;
"RTN","DIDTC",99,0)
 S %D=X<0 S:%D X=-X S %=$S($D(X2):+X2,1:2),X=$J(X,1,%),%=$L(X)-3-$E(23456789,%),%L=$S($D(X3):X3,1:12)
"RTN","DIDTC",100,0)
 F %=%:-3 Q:$E(X,%)=""  S X=$E(X,1,%)_","_$E(X,%+1,99)
"RTN","DIDTC",101,0)
 S:$D(X2) X=$E("$",X2["$")_X S X=$J($E("(",%D)_X_$E(" )",%D+1),%L) K %,%D,%L
"RTN","DIDTC",102,0)
 Q
"RTN","DIDTC",103,0)
 ;
"RTN","DIDTC",104,0)
 ;
"RTN","DIDTC",105,0)
 ;
"RTN","DIDTC",106,0)
HELP S DDH=$S($D(DDH):DDH,1:0),A1="Examples of Valid Dates:" D %
"RTN","DIDTC",107,0)
 I %DT["M" D  G 0
"RTN","DIDTC",108,0)
 . S A1="  "_$S(%DT["I":1.1957,1:"JAN 1957 or JAN 57")_$S(%DT'["N":" or 0157",1:"") D %
"RTN","DIDTC",109,0)
 . S A1="  T    (for this month)" D %
"RTN","DIDTC",110,0)
 . S A1="  T+3M (for 3 months in the future)" D %
"RTN","DIDTC",111,0)
 . S A1="  T-3M (for 3 months ago)" D %
"RTN","DIDTC",112,0)
 . S A1="Only month and year are accepted. You must omit the precise day." D %
"RTN","DIDTC",113,0)
 S A1="  "_$S(%DT["I":"20.1.1957",1:"JAN 20 1957 or 20 JAN 57")_" or "_$S(%DT["I":"20/1",1:"1/20")_"/57"_$S(%DT'["N":" or "_$S(%DT["I":200157,1:"012057"),1:"") D %
"RTN","DIDTC",114,0)
 S A1="  T   (for TODAY),  T+1 (for TOMORROW),  T+2,  T+7,  etc." D %
"RTN","DIDTC",115,0)
 S A1="  T-1 (for YESTERDAY),  T-3W (for 3 WEEKS AGO), etc." D %
"RTN","DIDTC",116,0)
 S A1="If the year is omitted, the computer " D  D %
"RTN","DIDTC",117,0)
 . I %DT["P" S A1=A1_"assumes a date in the PAST." Q
"RTN","DIDTC",118,0)
 . I %DT["F" S A1=A1_"assumes a date in the FUTURE." Q
"RTN","DIDTC",119,0)
 . S A1=A1_"uses CURRENT YEAR.  Two digit year" D %
"RTN","DIDTC",120,0)
 . S A1="  assumes no more than 20 years in the future, or 80 years in the past."
"RTN","DIDTC",121,0)
 . Q
"RTN","DIDTC",122,0)
 I %DT'["X" S A1="You may omit the precise day, as:  "_$S(%DT["I":1,1:"JAN,")_" 1957" D %
"RTN","DIDTC",123,0)
 I %DT'["T",%DT'["R" G 0
"RTN","DIDTC",124,0)
 S A1="If only the time is entered, the current date is assumed." D %
"RTN","DIDTC",125,0)
 S A1="Follow the date with a time, such as "_$S(%DT["I":"20.1",1:"JAN 20")_"@10, T@10AM, 10:30, etc." D %
"RTN","DIDTC",126,0)
 S A1="You may enter a time, such as NOON, MIDNIGHT or NOW." D %
"RTN","DIDTC",127,0)
 S A1="You may enter   NOW+3'  (for current date and time Plus 3 minutes" D %
"RTN","DIDTC",128,0)
 S A1="  *Note--the Apostrophe following the number of minutes)" D %
"RTN","DIDTC",129,0)
 I %DT["S" S A1="Seconds may be entered as 10:30:30 or 103030AM." D %
"RTN","DIDTC",130,0)
 I %DT["R" S A1="Time is REQUIRED in this response." D %
"RTN","DIDTC",131,0)
0 Q:'$D(%DT(0))
"RTN","DIDTC",132,0)
 S A1=" " D % S A1="Enter a date which is "_$S(%DT(0)["-":"less",1:"greater")_" than or equal to " D %
"RTN","DIDTC",133,0)
 S Y=$S(%DT(0)["-":$P(%DT(0),"-",2),1:%DT(0)) D DD^%DT:Y'["NOW"
"RTN","DIDTC",134,0)
 I '$D(DDS) W Y,"." K A1 Q
"RTN","DIDTC",135,0)
 S DDH(DDH,"T")=DDH(DDH,"T")_Y_"." K A1 Q
"RTN","DIDTC",136,0)
 ;
"RTN","DIDTC",137,0)
% I '$D(DDS) W !,"     ",A1 Q
"RTN","DIDTC",138,0)
 S DDH=DDH+1,DDH(DDH,"T")="     "_A1 Q
"RTN","DIDTC",139,0)
 Q
"RTN","DIK1")
0^11^B14766986^B14750350
"RTN","DIK1",1,0)
DIK1 ;SFISC/GFT-ACTUAL INDEXER ;9NOV2010
"RTN","DIK1",2,0)
 ;;22.0;VA FileMan;**1,10,41,146,160,165**;Mar 30, 1999;Build 32
"RTN","DIK1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DIK1",4,0)
EN N DIC D DI
"RTN","DIK1",5,0)
 D
"RTN","DIK1",6,0)
 . N DIKSV S DIKSV=DIK N DIK,DIKJ,DIFKEP
"RTN","DIK1",7,0)
 . D INDEX^DIKC(DIKSV,.DA,"","","KT")
"RTN","DIK1",8,0)
 D K G Q:'$D(@(DIK_"0)")) ;IF ZERO NODE IS THERE, RE-SET IT
"RTN","DIK1",9,0)
 S Y=^(0),DH=$S($O(^(0))'>0:0,1:$P(Y,U,4)-1),X=$P($P(Y,U,3),U,DH>0) D 3:X=DA
"RTN","DIK1",10,0)
 S ^(0)=$P(Y,U,1,2)_U_X_U_DH
"RTN","DIK1",11,0)
IDENTF I DIK?1"^DD(".NP1",",$G(DA(1)),DIK[DA(1) K ^DD(DA(1),0,"ID",DA),^("W"_DA)
"RTN","DIK1",12,0)
Q K:$G(DIKJ) ^UTILITY("DIK",DIKJ)
"RTN","DIK1",13,0)
 K DB(0),DIKJ,DIKS,DIN,DH,DU,DV,DW,DIKGP Q
"RTN","DIK1",14,0)
 ;
"RTN","DIK1",15,0)
K S X="",Y=1 I $D(DIFKEP(DA))#2,DIK="^DIC(",$D(@(DIK_DA_",0,""GL"")")) S X=^("GL"),Y="^DIC("_DA_","
"RTN","DIK1",16,0)
 I X'=Y K @(DIK_"DA)"),X,Y Q
"RTN","DIK1",17,0)
 S X=DIK_"DA,",DH=@(X_"0)") K ^(0),^("%") S Y="""%""" F  S Y=$O(@(X_Y_")")) Q:$E(Y)'="%"  S Y=""""_Y_"""" K @(X_Y_")")
"RTN","DIK1",18,0)
 S @(X_"0)")=DH K X,Y
"RTN","DIK1",19,0)
 Q
"RTN","DIK1",20,0)
 ;
"RTN","DIK1",21,0)
3 N X1
"RTN","DIK1",22,0)
 S X1=X,X=+$O(^(X1),-1)
"RTN","DIK1",23,0)
 S:X'>0 X=+$O(^(X1))
"RTN","DIK1",24,0)
 Q
"RTN","DIK1",25,0)
 ;
"RTN","DIK1",26,0)
DI S (DIC,DIN)=DIK,DH=DH(DU),DV=1 F  S DV=$O(DA(DV)) Q:DV'>0  S DU=DU+1
"RTN","DIK1",27,0)
DIN S DV=0 F  S DV=$O(^UTILITY("DIK",DIKJ,DH,DV)) Q:DV=""  D R:$G(DIKSET)!(DV-.01)
"RTN","DIK1",28,0)
DVA S DV=$O(DV(DH,DV)) I DV="" Q:$G(DIKSET)  S DV=.01 D R:$D(^UTILITY("DIK",DIKJ,DH,DV)) Q
"RTN","DIK1",29,0)
 S X=DIN_DA_","_DV(DH,DV) I @("'$D("_X_"))") G DVA
"RTN","DIK1",30,0)
 S DU(DU)=DIN,DIN=X_",",DH(DU)=DH,DH=DV(DH,DV,0),DV(DU)=DV,DU=DU+1 F X=DU:-1:1 I $D(DA(X)) S DA(X+1)=DA(X)
"RTN","DIK1",31,0)
 S DA(1)=DA,DA=0
"RTN","DIK1",32,0)
DA I '$D(DV(DH(DU-1),DV,"NOLOOP")) F  S @("DA=$O("_DIN_"DA))") Q:DA'>0  D DIN
"RTN","DIK1",33,0)
 D:$D(^UTILITY("DIK",DIKJ,"KW",DH)) KW(DH)
"RTN","DIK1",34,0)
 S DU=DU-1,DIN=DU(DU),DH=DH(DU),DV=DV(DU),DA=DA(1) K DA(1) F X=2:1 G DVA:'$D(DA(X)) S DA(X-1)=DA(X) K DA(X)
"RTN","DIK1",35,0)
 ;EXECUTE CROSS-REFERENCES
"RTN","DIK1",36,0)
R S X=^UTILITY("DIK",DIKJ,DH,DV),%=^(DV,0) I @("$D("_DIN_DA_",X))[0") Q
"RTN","DIK1",37,0)
 X % Q:X']""  S DIKS=X,DW=0
"RTN","DIK1",38,0)
XEC S DW=$O(^UTILITY("DIK",DIKJ,DH,DV,DW)) Q:DW=""  D NXEC(^(DW)) S X=DIKS G XEC
"RTN","DIK1",39,0)
 ;
"RTN","DIK1",40,0)
NXEC(DICODE) ;New variables and execute programming hook
"RTN","DIK1",41,0)
 I DICODE="D RCR"
"RTN","DIK1",42,0)
 E  I $G(DW)=99,DICODE?.E1" AUDIT"
"RTN","DIK1",43,0)
 E  N DH,DIFKEP,DIK,DIKJ,DIKS,DIKSET,DIN,DU,DV,DW,KW
"RTN","DIK1",44,0)
 X DICODE
"RTN","DIK1",45,0)
 Q
"RTN","DIK1",46,0)
RCR K Y,%RCR F %="DIKS","DIK","DW","DH","DIN","DU","DV","X","KW","DIKSET" S %RCR(%)=""
"RTN","DIK1",47,0)
 S %RCR="RR^DIK1",Y=^UTILITY("DIK",DIKJ,DH,DV,DW,0) G STORLIST^%RCR
"RTN","DIK1",48,0)
 ;
"RTN","DIK1",49,0)
RR X Y Q
"RTN","DIK1",50,0)
 ;
"RTN","DIK1",51,0)
AUDIT N %,%F,%T,%D,DIKF,DIKDA Q:DIIX=3&($D(DIKNM)!$D(DIKKS))  S %=DV N DV S DV=%
"RTN","DIK1",52,0)
 S %F=DH F %=1:1 Q:'$D(^DD(%F,0,"UP"))  S %D=%F,%F=^("UP"),DV(%)=$O(^DD(%F,"SB",%D,0)) S:DV(%)="" DV(%)=-1
"RTN","DIK1",53,0)
 S DIKDA="",DIKF="" F %=%-1:-1:1 S DIKDA=DIKDA_DA(%)_",",DIKF=DIKF_DV(%)_","
"RTN","DIK1",54,0)
 I $G(^DD(DH,DV,"AX"))]"" D NXEC(^("AX")) I '$T Q
"RTN","DIK1",55,0)
 D ADD^DIET S DIAU(DH,DV,DIKDA_DA)="^DIA("_%F_","_+Y_",",^DIA(%F,%D,0)=DIKDA_DA_U_%T_U_DIKF_DV_U_DUZ,^DIA(%F,"B",DIKDA_DA,%D)=""
"RTN","DIK1",56,0)
SET N C S (%F,C)=$P(^DD(DH,DV,0),U,2),Y=X D:Y]"" S^DIQ S @(DIAU(DH,DV,DIKDA_DA)_"DIIX)")=Y S:DIIX=2&($D(DIKNM)!$D(DIKKS)) ^(3)=Y
"RTN","DIK1",57,0)
 K DIAU I %F["P"!(%F["V")!(%F["S") S ^(DIIX+.1)=X_U_%F
"RTN","DIK1",58,0)
 Q
"RTN","DIK1",59,0)
 ;
"RTN","DIK1",60,0)
1 ;
"RTN","DIK1",61,0)
 N DIKLK
"RTN","DIK1",62,0)
 S DIKLK=DIK_DA_")" L +@DIKLK:10 K:'$T DIKLK D DI L:$D(DIKLK) -@DIKLK G Q
"RTN","DIK1",63,0)
 ;
"RTN","DIK1",64,0)
CNT ;
"RTN","DIK1",65,0)
 N DIKLK,DIKLAST S DIKLAST=$S(DA:DA,1:"")
"RTN","DIK1",66,0)
 S DU=$E(DIK,1,$L(DIK)-1),DIKLK=$S(DIK[",":DU_")",1:DU) L +@DIKLK:10 K:'$T DIKLK
"RTN","DIK1",67,0)
C I @("$O("_DIK_"DA))'>0") S $P(@(DIK_"0)"),U,4)=DCNT D:$D(^UTILITY("DIK",DIKJ,"KW",DH(1))) KW(DH(1)) K DCNT L:$D(DIKLK) -@DIKLK G Q ;**DI*22*146
"RTN","DIK1",68,0)
 S DA=$O(^(DA)) G C:$P($G(^(DA,0)),U)']"" S DIKLAST=DA,DU=1,DCNT=DCNT+1 S:DA="" DA=-1 D:(DCNT#100=0)  D DI K DB(0) G C
"RTN","DIK1",69,0)
 .I $D(IO)#2,$D(IO(0))#2,IO=IO(0),IO="" Q
"RTN","DIK1",70,0)
 .I '$D(ZTQUEUED) W "."
"RTN","DIK1",71,0)
 ;
"RTN","DIK1",72,0)
KW(FIL) ;Kill entire regular indexes
"RTN","DIK1",73,0)
 N NAM
"RTN","DIK1",74,0)
 S NAM="" F  S NAM=$O(^UTILITY("DIK",DIKJ,"KW",FIL,NAM)) Q:NAM=""  K @(DIN_""""_NAM_""")")
"RTN","DIK1",75,0)
 Q
"RTN","DINIT21")
0^7^B10884786^B10881037
"RTN","DINIT21",1,0)
DINIT21 ;SFISC/GFT-INITIALIZE VA FILEMAN ;1SEP2010
"RTN","DINIT21",2,0)
 ;;22.0;VA FileMan;**110,160,165**;Mar 30, 1999;Build 32
"RTN","DINIT21",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DINIT21",4,0)
DINITOSX G DD:'$O(^DD("OS",0)) W !!,"Do you want to change the MUMPS OPERATING SYSTEM File? NO//" R Y:60 Q:Y["^"!("Nn"[$E(Y))!('$T)
"RTN","DINIT21",5,0)
DD F I=1:1 S X=$T(DD+I),Y=$P(X," ",3,99) Q:X?.P  S D="^DD(""OS"","_$E($P(X," ",2),3,99)_")" S @D=Y
"RTN","DINIT21",6,0)
 ;;0 MUMPS OPERATING SYSTEM^.7
"RTN","DINIT21",7,0)
 ;;8,0 MSM^^127^5000^^1^63
"RTN","DINIT21",8,0)
 ;;8,1 B X
"RTN","DINIT21",9,0)
 ;;8,"SDP" O @("DIO:"_DLP) F %=0:0 U DIO R % Q:$ZA=X&($ZB>Y)!($ZA>X)  U IO W:$A(%)'=12 ! W %
"RTN","DINIT21",10,0)
 ;;8,"SDPEND" S X=$ZA,Y=$ZB
"RTN","DINIT21",11,0)
 ;;8,"XY" S $X=IOX,$Y=IOY
"RTN","DINIT21",12,0)
 ;;8,8 X ^DD("$O")
"RTN","DINIT21",13,0)
 ;;8,18 I $D(^ (X))
"RTN","DINIT21",14,0)
 ;;8,"ZS" ZR  X "S %Y=0 F  S %Y=$O(^UTILITY($J,0,%Y)) Q:%Y=""""  Q:'$D(^(%Y))  ZI ^(%Y)" ZS @X
"RTN","DINIT21",15,0)
 ;;9,0 DTM-PC^^127^5000^^1^115
"RTN","DINIT21",16,0)
 ;;9,1 B X
"RTN","DINIT21",17,0)
 ;;9,8 D:$P($ZVER,"/",2)<4 ^%VARLOG X:$P($ZVER,"/",2)'<4 ^DD("$O")
"RTN","DINIT21",18,0)
 ;;9,18 I $ZRSTATUS(X)'=""
"RTN","DINIT21",19,0)
 ;;9,"SDP" O @("DIO:"_"(""R"":"_$P(DLP,":",2,9)) F %=0:0 U DIO R % Q:$ZIOS=3  U IO W:$A(%)'=12 ! W %
"RTN","DINIT21",20,0)
 ;;9,"SDPEND" Q
"RTN","DINIT21",21,0)
 ;;9,"XY" S $X=IOX,$Y=IOY
"RTN","DINIT21",22,0)
 ;;9,"ZS" S %X="" X "S %Y=0 F  S %Y=$O(^UTILITY($J,0,%Y)) Q:%Y=""""  Q:'$D(^(%Y))  S %X=%X_$C(10)_^(%Y)" ZS @X:$E(%X,2,999999)
"RTN","DINIT21",23,0)
 ;;16,0 DSM for OpenVMS^^108^5000^^1^63
"RTN","DINIT21",24,0)
 ;;16,1 U @("$I:"_$P("NO",1,'X)_"CENABLE")
"RTN","DINIT21",25,0)
 ;;16,8 D DOLRO^%ZOSV
"RTN","DINIT21",26,0)
 ;;16,18 I $T(^@X)]""
"RTN","DINIT21",27,0)
 ;;16,"SDP" O DIO U DIO:DISCONNECT F %=0:0 U DIO R % Q:%="#$#"  U IO W:$A(%)'=12 ! W %
"RTN","DINIT21",28,0)
 ;;16,"SDPEND" W !,"#$#",! C IO
"RTN","DINIT21",29,0)
 ;;16,"XY" S $X=IOX,$Y=IOY
"RTN","DINIT21",30,0)
 ;;16,"ZS" ZR  X "S %Y=0 F  S %Y=$O(^UTILITY($J,0,%Y)) Q:%Y=""""  Q:'$D(^(%Y))  ZI ^(%Y)" ZS @X
"RTN","DINIT21",31,0)
 ;;17,0 GT.M(VAX)^^250^15000^^1^250
"RTN","DINIT21",32,0)
 ;;17,1 U @("$I:"_$P("NO",1,'X)_"CENABLE")
"RTN","DINIT21",33,0)
 ;;17,8 X ^DD("$O") ;D DOLRO^%ZOSV
"RTN","DINIT21",34,0)
 ;;17,18 I $L($T(^@X))
"RTN","DINIT21",35,0)
 ;;17,"SDP" O DIO F  U DIO R % Q:%="#$#"  U IO W:$A(%)'=12 ! W %
"RTN","DINIT21",36,0)
 ;;17,"SDPEND" W !,"#$#",! C IO
"RTN","DINIT21",37,0)
 ;;17,"XY" S $X=IOX,$Y=IOY
"RTN","DINIT21",38,0)
 ;;17,"ZS" N %,%I,%F,%S S %I=$I,%F=$P($ZRO,",")_X_".m" O %F:(NEWVERSION) U %F X "S %S=0 F  S %S=$O(^UTILITY($J,0,%S)) Q:%S=""""  Q:'$D(^(%S))  S %=^UTILITY($J,0,%S) I $E(%)'="";"" W %,!" C %F U %I
"RTN","DINIT21",39,0)
 ;;18,0 CACHE/OpenM^^250^15000^^1^250
"RTN","DINIT21",40,0)
 ;;18,1 B X
"RTN","DINIT21",41,0)
 ;;18,8 X ^DD("$O")
"RTN","DINIT21",42,0)
 ;;18,18 I $T(^@X)]""
"RTN","DINIT21",43,0)
 ;;18,"SDP" C DIO O DIO F %=0:0 U DIO R % Q:%="#$#"  U IO W %
"RTN","DINIT21",44,0)
 ;;18,"SDPEND" W !,"#$#",! C IO
"RTN","DINIT21",45,0)
 ;;18,"XY" S $Y=IOY,$X=IOX
"RTN","DINIT21",46,0)
 ;;18,"ZS" ZR  X "S %Y=0 F  S %Y=$O(^UTILITY($J,0,%Y)) Q:%Y=""""  Q:'$D(^(%Y))  ZI ^(%Y)" ZS @X
"RTN","DINIT21",47,0)
 ;;19,0 GT.M(UNIX)^^250^15000^^1^250
"RTN","DINIT21",48,0)
 ;;19,1 U @("$I:"_$P("NO",1,'X)_"CENABLE")
"RTN","DINIT21",49,0)
 ;;19,8 X ^DD("$O") ;D DOLRO^%ZOSV
"RTN","DINIT21",50,0)
 ;;19,18 I $L($T(^@X))
"RTN","DINIT21",51,0)
 ;;19,"SDP" O DIO F  U DIO R % Q:%="#$#"  U IO W:$A(%)'=12 ! W %
"RTN","DINIT21",52,0)
 ;;19,"SDPEND" W !,"#$#",! C IO
"RTN","DINIT21",53,0)
 ;;19,"XY" S $X=IOX,$Y=IOY
"RTN","DINIT21",54,0)
 ;;19,"ZS" N %,%I,%F,%S S %I=$I,%F=$P($P($P($ZRO,")"),"(",2)," ")_"/"_X_".m" O %F:(NEWVERSION) U %F X "S %S=0 F  S %S=$O(^UTILITY($J,0,%S)) Q:%S=""""  Q:'$D(^(%S))  S %=^UTILITY($J,0,%S) I $E(%)'="";"" W %,!" C %F U %I X "ZLINK X"
"RTN","DINIT21",55,0)
 ;;100,0 OTHER^^40^5000
"RTN","DINIT21",56,0)
 ;;100,1 Q
"RTN","DIPR165")
0^^B14785799^n/a
"RTN","DIPR165",1,0)
DIPR165 ;O-OIFO/GMB-Save DIDT as %DT ;4MAY2011
"RTN","DIPR165",2,0)
 ;;22.0;VA FileMan;**165**;Mar 30, 1999;Build 32
"RTN","DIPR165",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","DIPR165",4,0)
ENV ; Environmental Check
"RTN","DIPR165",5,0)
 D BMES^XPDUTL("Perform Environment Check...")
"RTN","DIPR165",6,0)
 D CHKSTOP
"RTN","DIPR165",7,0)
 D CHKOS
"RTN","DIPR165",8,0)
 D BMES^XPDUTL("Finished Environment Check.")
"RTN","DIPR165",9,0)
 Q
"RTN","DIPR165",10,0)
CHKSTOP ;
"RTN","DIPR165",11,0)
 ; Check XPDENV 0 = Loading; 1 = Installing
"RTN","DIPR165",12,0)
 Q:'XPDENV  ; Loading Distribution - No Check
"RTN","DIPR165",13,0)
 ;
"RTN","DIPR165",14,0)
 ;
"RTN","DIPR165",15,0)
INSCHK ; Do Checks During Install Only
"RTN","DIPR165",16,0)
 W $C(7)
"RTN","DIPR165",17,0)
 D MES^XPDUTL("** Although Queuing is allowed - it is HIGHLY recommended that ALL Users and")
"RTN","DIPR165",18,0)
 D MES^XPDUTL("VISTA Background jobs be STOPPED before installation of this patch.  Failure")
"RTN","DIPR165",19,0)
 D MES^XPDUTL("to do so may result in 'source routine edited' error(s). Edits will be")
"RTN","DIPR165",20,0)
 D MES^XPDUTL("lost and record(s) may be left in an inconsistent state, for example,")
"RTN","DIPR165",21,0)
 D MES^XPDUTL("not all Cross-Referencing completed; which in turn may cause FUTURE")
"RTN","DIPR165",22,0)
 D MES^XPDUTL("VistA/FileMan Hard Errors or corrupted Data. **")
"RTN","DIPR165",23,0)
 ;
"RTN","DIPR165",24,0)
TMCHK ; Check to see if TaskMan is still running
"RTN","DIPR165",25,0)
 S X=$$TM^%ZTLOAD
"RTN","DIPR165",26,0)
 I X,'$D(^%ZTSCH("WAIT")) D
"RTN","DIPR165",27,0)
 . W $C(7)
"RTN","DIPR165",28,0)
 . D BMES^XPDUTL("* Warning TaskMan Has NOT Been Stopped or Placed in a WAIT State!")
"RTN","DIPR165",29,0)
 ;
"RTN","DIPR165",30,0)
LINH ; Check to see if Logons are Inhibited
"RTN","DIPR165",31,0)
 D GETENV^%ZOSV  ; $P(Y,"^",2) = Installing Volume
"RTN","DIPR165",32,0)
 Q:$G(^%ZIS(14.5,"LOGON",$P(Y,"^",2)))
"RTN","DIPR165",33,0)
 W $C(7)
"RTN","DIPR165",34,0)
 D BMES^XPDUTL("* Warning Logons are NOT Inhibited!")
"RTN","DIPR165",35,0)
 Q
"RTN","DIPR165",36,0)
CHKOS ; Check to see if CACHE/OpenM entry exists
"RTN","DIPR165",37,0)
 D BMES^XPDUTL("I'm checking to ensure that entry 18, CACHE/OpenM,")
"RTN","DIPR165",38,0)
 D MES^XPDUTL("exists in the MUMPS OPERATING SYSTEM (#.7) file.")
"RTN","DIPR165",39,0)
 I $P($G(^DD("OS",18,0)),U,1)="CACHE/OpenM" D  Q
"RTN","DIPR165",40,0)
 . D MES^XPDUTL("...It does.")
"RTN","DIPR165",41,0)
 W $C(7)
"RTN","DIPR165",42,0)
 D MES^XPDUTL("...Error: ^DD(""OS"",18,0) should be CACHE/OpenM, but isn't.")
"RTN","DIPR165",43,0)
 D MES^XPDUTL("...Something's not right with IEN 18 of the MUMPS OPERATING SYSTEM (#.7) file.")
"RTN","DIPR165",44,0)
 D MES^XPDUTL("...Notify SD&D.")
"RTN","DIPR165",45,0)
 S XPDQUIT=2
"RTN","DIPR165",46,0)
 Q
"RTN","DIPR165",47,0)
POSTINIT ; Post-Init
"RTN","DIPR165",48,0)
 D BMES^XPDUTL("Beginning Post-Installation...")
"RTN","DIPR165",49,0)
 D BMES^XPDUTL("  I'm saving routine DIDT as %DT.")
"RTN","DIPR165",50,0)
 N SCR,%S,%D,ZTOS
"RTN","DIPR165",51,0)
 S SCR="I 1",ZTOS=$$OSNUM^ZTMGRSET,%S="DIDT",%D="%DT" D MOVE^ZTMGRSET
"RTN","DIPR165",52,0)
 D MES^XPDUTL("  I'm saving routine DIDTC as %DTC.")
"RTN","DIPR165",53,0)
 K SCR,%S,%D,ZTOS
"RTN","DIPR165",54,0)
 S SCR="I 1",ZTOS=$$OSNUM^ZTMGRSET,%S="DIDTC",%D="%DTC" D MOVE^ZTMGRSET
"RTN","DIPR165",55,0)
 D BMES^XPDUTL("  I'm checking the settings for CACHE/OpenM")
"RTN","DIPR165",56,0)
 D MES^XPDUTL("  in the MUMPS OPERATING SYSTEM (#.7) file.")
"RTN","DIPR165",57,0)
 N LINE
"RTN","DIPR165",58,0)
 S LINE=$G(^DD("OS",18,0))
"RTN","DIPR165",59,0)
 I $P(LINE,U,3,4)="250^15000",$P(LINE,U,7)=250 D
"RTN","DIPR165",60,0)
 . D MES^XPDUTL("  ...The settings are correct. No action taken.")
"RTN","DIPR165",61,0)
 E  D
"RTN","DIPR165",62,0)
 . I $P(LINE,U,3)'=250 D
"RTN","DIPR165",63,0)
 . . D MES^XPDUTL("  ...I'm changing the GLOBAL LENGTH (MAX) (#2) field from "_$S($P(LINE,U,3)="":"Null",1:$P(LINE,U,3))_" to 250.")
"RTN","DIPR165",64,0)
 . . S $P(LINE,U,3)=250
"RTN","DIPR165",65,0)
 . I $P(LINE,U,4)'=15000 D
"RTN","DIPR165",66,0)
 . . D MES^XPDUTL("  ...I'm changing the ROUTINE SIZE (MAX) (#3) field from "_$S($P(LINE,U,4)="":"Null",1:$P(LINE,U,4))_" to 15000.")
"RTN","DIPR165",67,0)
 . . S $P(LINE,U,4)=15000
"RTN","DIPR165",68,0)
 . I $P(LINE,U,7)'=250 D
"RTN","DIPR165",69,0)
 . . D MES^XPDUTL("  ...I'm changing the INDIVIDUAL SUBSCRIPT LENGTH (#7) field from "_$S($P(LINE,U,7)="":"Null",1:$P(LINE,U,7))_" to 250.")
"RTN","DIPR165",70,0)
 . . S $P(LINE,U,7)=250
"RTN","DIPR165",71,0)
 . S ^DD("OS",18,0)=LINE
"RTN","DIPR165",72,0)
 D BMES^XPDUTL("Finished Post-Installation.")
"RTN","DIPR165",73,0)
 Q
"VER")
8^22.0
"BLD",774,6)
^146
**END**
**END**
