Released TIU*1*239 SEQ #239
Extracted from mail message
**KIDS**:TIU*1.0*239^

**INSTALL NAME**
TIU*1.0*239
"BLD",7311,0)
TIU*1.0*239^TEXT INTEGRATION UTILITIES^0^3090421^y
"BLD",7311,1,0)
^^7^7^3090421^
"BLD",7311,1,1,0)
This patch adresses the following Remedy tickets:
"BLD",7311,1,2,0)
 
"BLD",7311,1,3,0)
 HD168903 - TIU documents/consults
"BLD",7311,1,4,0)
 duplicate(s): HD211236,202522,193385
"BLD",7311,1,5,0)
 HD311014 - One Progress Note on two consults
"BLD",7311,1,6,0)
 HD152076 - User Class expires
"BLD",7311,1,7,0)
 HD131840 - Addtl Signer - User Class Requiring Cosignature (error box)
"BLD",7311,4,0)
^9.64PA^^
"BLD",7311,6.3)
4
"BLD",7311,"KRN",0)
^9.67PA^779.2^20
"BLD",7311,"KRN",.4,0)
.4
"BLD",7311,"KRN",.401,0)
.401
"BLD",7311,"KRN",.402,0)
.402
"BLD",7311,"KRN",.403,0)
.403
"BLD",7311,"KRN",.5,0)
.5
"BLD",7311,"KRN",.84,0)
.84
"BLD",7311,"KRN",3.6,0)
3.6
"BLD",7311,"KRN",3.8,0)
3.8
"BLD",7311,"KRN",9.2,0)
9.2
"BLD",7311,"KRN",9.8,0)
9.8
"BLD",7311,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7311,"KRN",9.8,"NM",1,0)
TIUSRVA^^0^B24002078
"BLD",7311,"KRN",9.8,"NM",2,0)
TIUSRVP^^0^B49614327
"BLD",7311,"KRN",9.8,"NM","B","TIUSRVA",1)

"BLD",7311,"KRN",9.8,"NM","B","TIUSRVP",2)

"BLD",7311,"KRN",19,0)
19
"BLD",7311,"KRN",19.1,0)
19.1
"BLD",7311,"KRN",101,0)
101
"BLD",7311,"KRN",409.61,0)
409.61
"BLD",7311,"KRN",771,0)
771
"BLD",7311,"KRN",779.2,0)
779.2
"BLD",7311,"KRN",870,0)
870
"BLD",7311,"KRN",8989.51,0)
8989.51
"BLD",7311,"KRN",8989.52,0)
8989.52
"BLD",7311,"KRN",8994,0)
8994
"BLD",7311,"KRN","B",.4,.4)

"BLD",7311,"KRN","B",.401,.401)

"BLD",7311,"KRN","B",.402,.402)

"BLD",7311,"KRN","B",.403,.403)

"BLD",7311,"KRN","B",.5,.5)

"BLD",7311,"KRN","B",.84,.84)

"BLD",7311,"KRN","B",3.6,3.6)

"BLD",7311,"KRN","B",3.8,3.8)

"BLD",7311,"KRN","B",9.2,9.2)

"BLD",7311,"KRN","B",9.8,9.8)

"BLD",7311,"KRN","B",19,19)

"BLD",7311,"KRN","B",19.1,19.1)

"BLD",7311,"KRN","B",101,101)

"BLD",7311,"KRN","B",409.61,409.61)

"BLD",7311,"KRN","B",771,771)

"BLD",7311,"KRN","B",779.2,779.2)

"BLD",7311,"KRN","B",870,870)

"BLD",7311,"KRN","B",8989.51,8989.51)

"BLD",7311,"KRN","B",8989.52,8989.52)

"BLD",7311,"KRN","B",8994,8994)

"BLD",7311,"QUES",0)
^9.62^^
"BLD",7311,"REQB",0)
^9.611^2^2
"BLD",7311,"REQB",1,0)
TIU*1.0*184^1
"BLD",7311,"REQB",2,0)
TIU*1.0*234^1
"BLD",7311,"REQB","B","TIU*1.0*184",1)

"BLD",7311,"REQB","B","TIU*1.0*234",2)

"MBREQ")
0
"PKG",516,-1)
1^1
"PKG",516,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",516,20,0)
^9.402P^^
"PKG",516,22,0)
^9.49I^1^1
"PKG",516,22,1,0)
1.0^3000126^2970815^11712
"PKG",516,22,1,"PAH",1,0)
239^3090421
"PKG",516,22,1,"PAH",1,1,0)
^^7^7^3090421
"PKG",516,22,1,"PAH",1,1,1,0)
This patch adresses the following Remedy tickets:
"PKG",516,22,1,"PAH",1,1,2,0)
 
"PKG",516,22,1,"PAH",1,1,3,0)
 HD168903 - TIU documents/consults
"PKG",516,22,1,"PAH",1,1,4,0)
 duplicate(s): HD211236,202522,193385
"PKG",516,22,1,"PAH",1,1,5,0)
 HD311014 - One Progress Note on two consults
"PKG",516,22,1,"PAH",1,1,6,0)
 HD152076 - User Class expires
"PKG",516,22,1,"PAH",1,1,7,0)
 HD131840 - Addtl Signer - User Class Requiring Cosignature (error box)
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","TIUSRVA")
0^1^B24002078^B23503804
"RTN","TIUSRVA",1,0)
TIUSRVA ; SLC/JER,AJB - API's for Authorization ; 4/2/09 12:34pm
"RTN","TIUSRVA",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,28,47,80,100,116,152,160,178,175,157,236,234,239**;Jun 20, 1997;Build 4
"RTN","TIUSRVA",3,0)
 ;
"RTN","TIUSRVA",4,0)
 ;External reference to File ^AUPNVSIT supported by DBIA 3580
"RTN","TIUSRVA",5,0)
REQCOS(TIUY,TIUTYP,TIUDA,TIUSER,TIUDT) ; Evaluate cosignature requirement
"RTN","TIUSRVA",6,0)
 ; Initialize return value
"RTN","TIUSRVA",7,0)
 N TIUDPRM
"RTN","TIUSRVA",8,0)
 S TIUY=0
"RTN","TIUSRVA",9,0)
 I +$G(TIUTYP)'>0,'+$G(TIUDA) Q
"RTN","TIUSRVA",10,0)
 I +$G(TIUDA) S TIUTYP=+$G(^TIU(8925,+$G(TIUDA),0))
"RTN","TIUSRVA",11,0)
 S:'+$G(TIUSER) TIUSER=+$G(DUZ)
"RTN","TIUSRVA",12,0)
 ; VMP/RJT --- *239  - Make sure only date is being passed into REQCOSIG and not date/time
"RTN","TIUSRVA",13,0)
 S TIUY=+$$REQCOSIG^TIULP(TIUTYP,+$G(TIUDA),+$G(TIUSER),$P(+$G(TIUDT),"."))
"RTN","TIUSRVA",14,0)
 Q
"RTN","TIUSRVA",15,0)
URGENCY(TIUY) ; -- retrieve set values from dd for discharge summary urgency
"RTN","TIUSRVA",16,0)
 N TIUDD,TIUI,TIUX
"RTN","TIUSRVA",17,0)
 D FIELD^DID(8925,.09,"","POINTER","TIUDD")
"RTN","TIUSRVA",18,0)
 F TIUI=1:1 S TIUX=$P(TIUDD("POINTER"),";",TIUI) Q:TIUX=""   S TIUY(TIUI)=$TR(TIUX,":","^")
"RTN","TIUSRVA",19,0)
 Q
"RTN","TIUSRVA",20,0)
CANDO(TIUY,TIUDA,TIUACT) ; Boolean function to evaluate privilege
"RTN","TIUSRVA",21,0)
 N TIUPOP,TIUDPRM S TIUPOP=0
"RTN","TIUSRVA",22,0)
 ; **152** prevent editing completed [uncosigned] documents.
"RTN","TIUSRVA",23,0)
 I $P($G(^TIU(8925,TIUDA,0)),U,5)>5,(TIUACT="EDIT RECORD") S TIUY="0^ You may not edit uncosigned or completed documents" Q
"RTN","TIUSRVA",24,0)
 I $S(TIUACT["SIGN":1,TIUACT="EDIT RECORD":1,TIUACT="DELETE RECORD":1,1:0) D  Q:+TIUPOP=1
"RTN","TIUSRVA",25,0)
 . L +^TIU(8925,+TIUDA):1
"RTN","TIUSRVA",26,0)
 . E  S TIUY="0^ Another session is editing this entry.",TIUPOP=1
"RTN","TIUSRVA",27,0)
 . L -^TIU(8925,+TIUDA)
"RTN","TIUSRVA",28,0)
 ;VMP/ELR *239 -- CHANGED TIUACT["SIGN" TO TIUACT["SIGNAT" - WAS EXECUTING LINE FOR INDENTIFYING SIGNERS
"RTN","TIUSRVA",29,0)
  I TIUACT["SIGNAT",+$$NEEDCS(TIUDA) S TIUY="0^ You must name a cosigner before signing this document." Q
"RTN","TIUSRVA",30,0)
 S TIUY=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIUSRVA",31,0)
 Q
"RTN","TIUSRVA",32,0)
NEEDCS(TIUDA) ; Does user need a cosigner?
"RTN","TIUSRVA",33,0)
 N TIUD0,TIUD12,TIUY,SIGNER,COSIGNER,XTRASGNR
"RTN","TIUSRVA",34,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12))
"RTN","TIUSRVA",35,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8),XTRASGNR=0
"RTN","TIUSRVA",36,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVA",37,0)
 I +XTRASGNR S TIUY=0
"RTN","TIUSRVA",38,0)
 E  I +$$REQCOSIG^TIULP(+TIUD0,TIUDA,DUZ),(+$P(TIUD12,U,8)'>0) S TIUY=1
"RTN","TIUSRVA",39,0)
 Q +$G(TIUY)
"RTN","TIUSRVA",40,0)
USRINACT(TIUY,TIUDA) ; Is user inactive?
"RTN","TIUSRVA",41,0)
 S TIUY=+$$GET1^DIQ(200,TIUDA_",",7,"I")
"RTN","TIUSRVA",42,0)
 Q
"RTN","TIUSRVA",43,0)
AUTHSIGN(TIUY,TIUDA,TIUUSR) ; Has Author signed?
"RTN","TIUSRVA",44,0)
 ; if TIUY = 
"RTN","TIUSRVA",45,0)
 ; 0 = Author has NOT signed & TIUUSR = Expected Cosigner
"RTN","TIUSRVA",46,0)
 ; 1 = Author HAS signed or TIUUSR '= Expected Cosigner
"RTN","TIUSRVA",47,0)
 ;
"RTN","TIUSRVA",48,0)
 N TIUD12,TIUD15
"RTN","TIUSRVA",49,0)
 S TIUD12=$G(^TIU(8925,TIUDA,12)),TIUD15=$G(^(15))
"RTN","TIUSRVA",50,0)
 S TIUY=1
"RTN","TIUSRVA",51,0)
 D:$P(TIUD12,U,8)=TIUUSR  Q
"RTN","TIUSRVA",52,0)
 . S:$P(TIUD12,U,2)'=$P(TIUD15,U,2) TIUY=0
"RTN","TIUSRVA",53,0)
 Q
"RTN","TIUSRVA",54,0)
TIUVISIT(TIUY,DOCTYP,DFN,VISIT) ;  Check for a 1 time only doc
"RTN","TIUSRVA",55,0)
 ;  TIUY    =    return value
"RTN","TIUSRVA",56,0)
 ;          = 0 if can add more than one or none already exist
"RTN","TIUSRVA",57,0)
 ;          = 1 if cannot add more than one and one already exists
"RTN","TIUSRVA",58,0)
 ;  DOCTYP  =    Pointer to ^TUI(8925.1,   TIU DOCUMENT DEFINITION
"RTN","TIUSRVA",59,0)
 ;  DFN     =    Patient IEN
"RTN","TIUSRVA",60,0)
 ;  VISIT   =    Visit String "LOC;VDATE;VTYP"
"RTN","TIUSRVA",61,0)
 I $$PATCH^XPDUTL("OR*3.0*195") D
"RTN","TIUSRVA",62,0)
 . Q:($G(DOCTYP)="")!($G(DFN)="")!($G(VISIT)="")
"RTN","TIUSRVA",63,0)
 . N TIUDPRM,TIUTEST
"RTN","TIUSRVA",64,0)
 . D DOCPRM^TIULC1(DOCTYP,.TIUDPRM)
"RTN","TIUSRVA",65,0)
 . S TIUY=$S($P(TIUDPRM(0),U,10)="":1,1:$P(TIUDPRM(0),U,10))
"RTN","TIUSRVA",66,0)
 . I TIUY=1 S TIUY=0 Q
"RTN","TIUSRVA",67,0)
 . I $L(VISIT,";")=3 D
"RTN","TIUSRVA",68,0)
 . . S TIUTEST=$$EXIST^TIUEDI3(DFN,DOCTYP,VISIT)
"RTN","TIUSRVA",69,0)
 . . I TIUTEST S TIUY=1
"RTN","TIUSRVA",70,0)
 . . I 'TIUTEST S TIUY=0
"RTN","TIUSRVA",71,0)
 I '$$PATCH^XPDUTL("OR*3.0*195") D
"RTN","TIUSRVA",72,0)
 . Q:($G(DOCTYP)="")!($G(DFN)="")!($G(VISIT)="")
"RTN","TIUSRVA",73,0)
 . N TIUX3
"RTN","TIUSRVA",74,0)
 . S TIUX3=+$O(^TIU(8925.95,"B",DOCTYP,""))
"RTN","TIUSRVA",75,0)
 . S TIUY=$P($G(^TIU(8925.95,TIUX3,0)),U,10) S TIUY=$S(TIUY=0:1,1:0)
"RTN","TIUSRVA",76,0)
 . Q:'TIUY
"RTN","TIUSRVA",77,0)
 . S VISIT=((9999999-$P(VISIT,"."))_"."_$P(VISIT,".",2))
"RTN","TIUSRVA",78,0)
 . S VISIT=+$O(^AUPNVSIT("AA",DFN,VISIT,""))
"RTN","TIUSRVA",79,0)
 . S TIUY=$S($D(^TIU(8925,"AV",DFN,DOCTYP,VISIT)):0,1:1)
"RTN","TIUSRVA",80,0)
 . S TIUY=$S(TIUY=0:1,1:0)
"RTN","TIUSRVA",81,0)
 Q
"RTN","TIUSRVA",82,0)
WHATACT(TIUY,TIUDA) ; Evaluate/return whether signature or cosignature
"RTN","TIUSRVA",83,0)
 N TIUD0,TIUD12,TIUSTAT,SIGNER,COSIGNER,XTRASGNR
"RTN","TIUSRVA",84,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIUSRVA",85,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8)
"RTN","TIUSRVA",86,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVA",87,0)
 I '$G(XTRASGNR) S XTRASGNR=$$ASURG^TIUADSIG(TIUDA)
"RTN","TIUSRVA",88,0)
 S TIUSTAT=+$P(TIUD0,U,5)
"RTN","TIUSRVA",89,0)
 S TIUY=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIUSRVA",90,0)
 Q
"RTN","TIUSRVA",91,0)
CANCHCOS(TIUY,TIUDA) ; Evaluate/return whether user can change cosigner
"RTN","TIUSRVA",92,0)
 S TIUY=$$MAYCHNG^TIURA1(TIUDA)
"RTN","TIUSRVA",93,0)
 Q
"RTN","TIUSRVA",94,0)
NEEDJUST(TIUY,TIUDA) ; Is justification required for deletion?
"RTN","TIUSRVA",95,0)
 N TIUD0 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUY=0
"RTN","TIUSRVA",96,0)
 I +$P(TIUD0,U,5)'<6 S TIUY=1
"RTN","TIUSRVA",97,0)
 Q
"RTN","TIUSRVA",98,0)
GETTITLE(TIUY,TIUDA) ; Get the title from a TIU Document Record
"RTN","TIUSRVA",99,0)
 S TIUY=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVA",100,0)
 Q
"RTN","TIUSRVA",101,0)
CANATTCH(TIUY,TIUDA) ; Can this document be attached as an ID Child
"RTN","TIUSRVA",102,0)
 N TITLEDA,PARENTDA
"RTN","TIUSRVA",103,0)
 S TITLEDA=+$G(^TIU(8925,TIUDA,0))
"RTN","TIUSRVA",104,0)
 I TITLEDA'>0 S TIUY="0^Document #"_TIUDA_" does not exist." Q
"RTN","TIUSRVA",105,0)
 S PARENTDA=+$G(^TIU(8925,TIUDA,21))
"RTN","TIUSRVA",106,0)
 S TIUY=$$POSSPRNT^TIULP(TITLEDA)
"RTN","TIUSRVA",107,0)
 I +TIUY S TIUY="-1"_U_$P(TIUY,U,2) Q
"RTN","TIUSRVA",108,0)
 I +$$ISCWAD^TIULX(TITLEDA) D  Q
"RTN","TIUSRVA",109,0)
 . S TIUY="0^ CWAD Documents may not be Attached as Interdisciplinary Entries."
"RTN","TIUSRVA",110,0)
 I +$$ISA^TIULX(TITLEDA,+$$CLASS^TIUCNSLT) D  Q
"RTN","TIUSRVA",111,0)
 . S TIUY="0^ Consult Results may not be Attached as Interdisciplinary Entries."
"RTN","TIUSRVA",112,0)
 S TIUY=$$CANDO^TIULP(TIUDA,"ATTACH TO ID NOTE")
"RTN","TIUSRVA",113,0)
 I PARENTDA D  ; action must be "detach"
"RTN","TIUSRVA",114,0)
 . I 'TIUY S TIUY="0^ You may not detach this note from an interdisciplinary note." Q
"RTN","TIUSRVA",115,0)
 . S TIUY=$$CANDO^TIULP(PARENTDA,"ATTACH ID ENTRY")
"RTN","TIUSRVA",116,0)
 . I 'TIUY S TIUY="0^ You may not detach this note from its interdisciplinary note."
"RTN","TIUSRVA",117,0)
 Q
"RTN","TIUSRVA",118,0)
CANRCV(TIUY,TIUDA) ; Can this document receive an ID Child?
"RTN","TIUSRVA",119,0)
 S TIUY=$$CANDO^TIULP(TIUDA,"ATTACH ID ENTRY")
"RTN","TIUSRVA",120,0)
 Q
"RTN","TIUSRVP")
0^2^B49614327^B45548216
"RTN","TIUSRVP",1,0)
TIUSRVP ; SLC/JER - RPCs for CREATE & UPDATE ;8/16/05
"RTN","TIUSRVP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,19,28,47,89,104,100,115,109,167,113,112,175,157,184,239**;Jun 20, 1997;Build 4
"RTN","TIUSRVP",3,0)
MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF) ; New Document
"RTN","TIUSRVP",4,0)
 ; SUCCESS = (by ref) TIU DOCUMENT # (PTR to 8925)
"RTN","TIUSRVP",5,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUSRVP",6,0)
 ; DFN     = Patient (#2)
"RTN","TIUSRVP",7,0)
 ; TITLE   = TIU Document Definition (#8925.1)
"RTN","TIUSRVP",8,0)
 ; [VDT]   = Date(/Time) of Visit
"RTN","TIUSRVP",9,0)
 ; [VLOC]  = Visit Location (HOSPITAL LOCATION)
"RTN","TIUSRVP",10,0)
 ; [VSIT]  = Visit file ien (#9000010)
"RTN","TIUSRVP",11,0)
 ; [VSTR]  = Visit string (i.e., VLOC;VDT;VTYPE)
"RTN","TIUSRVP",12,0)
 ; [NOASF] = if 1=Do Not Set ASAVE cross-reference
"RTN","TIUSRVP",13,0)
 ; TIUX    = (by ref) array containing field data and document body
"RTN","TIUSRVP",14,0)
 ;
"RTN","TIUSRVP",15,0)
 N TIU,TIUDA,LDT,NEWREC
"RTN","TIUSRVP",16,0)
 S SUCCESS=0
"RTN","TIUSRVP",17,0)
 I +$G(VSIT) S VSTR=$$VSTRBLD(+VSIT)
"RTN","TIUSRVP",18,0)
 I $L($G(VSTR)) D
"RTN","TIUSRVP",19,0)
 . S VDT=$S(+$G(VDT):+$G(VDT),1:$P(VSTR,";",2))
"RTN","TIUSRVP",20,0)
 . S LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",21,0)
 . S VLOC=$S(+$G(VLOC):+$G(VLOC),1:$P(VSTR,";"))
"RTN","TIUSRVP",22,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",23,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",24,0)
 . ; Otherwise, call PATVADPT^TIULV
"RTN","TIUSRVP",25,0)
 . D PATVADPT^TIULV(.TIU,DFN,"",VSTR)
"RTN","TIUSRVP",26,0)
 I '+$G(VSIT),'$L($G(VSTR)),+$G(VDT),+$G(VLOC) D
"RTN","TIUSRVP",27,0)
 . S VDT=$G(VDT),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",28,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",29,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",30,0)
 . ; Otherwise, call MAIN^TIUVSIT
"RTN","TIUSRVP",31,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",VDT,LDT,"LAST",0,VLOC)
"RTN","TIUSRVP",32,0)
 I '+$G(TIU("VSTR")) D
"RTN","TIUSRVP",33,0)
 . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUSRVP",34,0)
 S TIU("INST")=$$DIVISION^TIULC1(+TIU("LOC"))
"RTN","TIUSRVP",35,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUSRVP",36,0)
 ;
"RTN","TIUSRVP",37,0)
 S TIUDA=$$GETREC(DFN,.TIU,TITLE,.NEWREC)
"RTN","TIUSRVP",38,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUSRVP",39,0)
 S SUCCESS=+TIUDA
"RTN","TIUSRVP",40,0)
 D STUFREC^TIUSRVP1(+TIUDA,.TIUX,DFN,,TITLE,.TIU)
"RTN","TIUSRVP",41,0)
 S:'+$G(NOASF) ^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVP",42,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",43,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",44,0)
 D SETXT0(TIUDA)
"RTN","TIUSRVP",45,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",46,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDA) Q
"RTN","TIUSRVP",47,0)
 I +$O(^TIU(8925,+TIUDA,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",48,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIUSRVP",49,0)
 E  D QUE^TIUPXAP1
"RTN","TIUSRVP",50,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",51,0)
 . D RELEASE^TIUT(TIUDA,1)
"RTN","TIUSRVP",52,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",53,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",54,0)
 Q
"RTN","TIUSRVP",55,0)
VSTRBLD(VSIT) ; Given Visit ien, build Visit-Descriptor String
"RTN","TIUSRVP",56,0)
 N TIUY,VSIT0,VLOC,VDT,VSVCAT
"RTN","TIUSRVP",57,0)
 S VSIT0=$G(^AUPNVSIT(+VSIT,0)),VDT=+$P(VSIT0,U),VLOC=+$P(VSIT0,U,22)
"RTN","TIUSRVP",58,0)
 S VSVCAT=$P(VSIT0,U,7)
"RTN","TIUSRVP",59,0)
 S TIUY=VLOC_";"_VDT_";"_VSVCAT
"RTN","TIUSRVP",60,0)
 Q TIUY
"RTN","TIUSRVP",61,0)
SETXT0(TIUDA) ; Set root node of "TEMP" WP-field
"RTN","TIUSRVP",62,0)
 N TIUC,TIUI S (TIUC,TIUI)=0
"RTN","TIUSRVP",63,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",64,0)
 . S:$D(^TIU(8925,TIUDA,"TEMP",TIUI,0)) TIUC=TIUC+1
"RTN","TIUSRVP",65,0)
 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",66,0)
 Q
"RTN","TIUSRVP",67,0)
MAKEADD(TIUDADD,TIUDA,TIUX,SUPPRESS) ; Create addendum
"RTN","TIUSRVP",68,0)
 ; For backward compatibility
"RTN","TIUSRVP",69,0)
 ; Use MAKEADD^TIUSRVP2 now, please
"RTN","TIUSRVP",70,0)
 D MAKEADD^TIUSRVP2(.TIUDADD,TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",71,0)
 Q
"RTN","TIUSRVP",72,0)
UPDATE(SUCCESS,TIUDA,TIUX,SUPPRESS) ; Update existing Document
"RTN","TIUSRVP",73,0)
 N TIU,TIUI,TIUC,TIUD0,TIUD12,TIUD14,TIUD15,TIUCPF,TITLE,PRFUNLNK,TIUY,TIUCC,TIUFLAG S TIUFLAG=0
"RTN","TIUSRVP",74,0)
 I $S(+$G(TIUDA)'>0:1,'$D(^TIU(8925,+TIUDA,0)):1,1:0) D  Q
"RTN","TIUSRVP",75,0)
 . S SUCCESS="0^ Cannot update a non-existent document..."
"RTN","TIUSRVP",76,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)>6 D  Q
"RTN","TIUSRVP",77,0)
 . S SUCCESS="0^ TIU Document #"_TIUDA_" is already signed..."
"RTN","TIUSRVP",78,0)
 I $D(TIUX("TEXT")) D
"RTN","TIUSRVP",79,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",80,0)
 . M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVP",81,0)
 . S (TIUC,TIUI)=0
"RTN","TIUSRVP",82,0)
 . F  S TIUI=$O(^TIU(8925,+TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",83,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVP",84,0)
 . I +TIUC>0 S ^TIU(8925,+TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",85,0)
 . K TIUX("TEXT")
"RTN","TIUSRVP",86,0)
 I +$O(TIUX(""))'>0 S:+$G(SUPPRESS) SUCCESS=+TIUDA Q
"RTN","TIUSRVP",87,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12)),TIUD14=$G(^(14)),TITLE=+TIUD0
"RTN","TIUSRVP",88,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP",89,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP",90,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP",91,0)
 D SETCOS^TIUSRVP2(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",92,0)
 ; Consult association changed?  If so, rollback to Active status.    VM/RJT - *239
"RTN","TIUSRVP",93,0)
 S TIUCC=$P($G(TIUD14),"^",5)
"RTN","TIUSRVP",94,0)
 I +$G(TIUX("1405"))>0,+$G(TIUCC)>0,(+$G(TIUX("1405"))'=+TIUCC) D ROLLBACK^TIUCNSLT(TIUDA) S TIUFLAG=1
"RTN","TIUSRVP",95,0)
 ; Title changed? Refile DC
"RTN","TIUSRVP",96,0)
 I +$G(TIUX(.01))>0,(+$G(TIUX(.01))'=+TIUD0) D
"RTN","TIUSRVP",97,0)
 . S TIUX(.04)=$$DOCCLASS^TIULC1(+$G(TIUX(.01)))
"RTN","TIUSRVP",98,0)
 . S TIUY=0 D ISCNSLT^TIUCNSLT(.TIUY,TITLE)
"RTN","TIUSRVP",99,0)
 . I $G(TIUY),TIUFLAG=0 D ROLLBACK^TIUCNSLT(TIUDA) ;  if changed to Non-Consult title - VMP/RJT - *239
"RTN","TIUSRVP",100,0)
 . ; If change title from PRF to nonPRF, set flg to unlink note:
"RTN","TIUSRVP",101,0)
 . I $$ISPFTTL^TIUPRFL(TITLE),'$$ISPFTTL^TIUPRFL(+$G(TIUX(.01))) S PRFUNLNK=1
"RTN","TIUSRVP",102,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS),TIUCPF)
"RTN","TIUSRVP",103,0)
 I +SUCCESS'>0 K ^TIU(8925,+TIUDA,"TEMP") Q
"RTN","TIUSRVP",104,0)
 I $G(PRFUNLNK) D UNLINK^TIUPRF1(TIUDA)
"RTN","TIUSRVP",105,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",106,0)
 I $D(^TIU(8925,+TIUDA,"TEMP")) D
"RTN","TIUSRVP",107,0)
 . K ^TIU(8925,+TIUDA,"TEXT")
"RTN","TIUSRVP",108,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",109,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",110,0)
 . S:'+$G(SUCCESS) SUCCESS=+TIUDA
"RTN","TIUSRVP",111,0)
 ; If signed, re-file /ES/
"RTN","TIUSRVP",112,0)
 S TIUD15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIUSRVP",113,0)
 I +TIUD15 D
"RTN","TIUSRVP",114,0)
 . N TIUBY,DR,DIE,DA,X,Y S TIUBY=$P(TIUD15,U,2) Q:+TIUBY'>0
"RTN","TIUSRVP",115,0)
 . S DR="1503///^S X=$$SIGNAME^TIULS("_TIUBY_");1504///^S X=$$SIGTITL^TIULS("_TIUBY_")"
"RTN","TIUSRVP",116,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIUSRVP",117,0)
 ; send alerts
"RTN","TIUSRVP",118,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",119,0)
 . I +$P(TIUD0,U,5)<5,'$D(TIUX(.05)) D UPDSTAT(TIUDA,+$G(TIUD0))
"RTN","TIUSRVP",120,0)
 . D SEND^TIUALRT(TIUDA),SENDID^TIUALRT1(TIUDA):+$G(^TIU(8925,+TIUDA,21))
"RTN","TIUSRVP",121,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",122,0)
 Q
"RTN","TIUSRVP",123,0)
SETCOS(TIUDA,TIUX,TIUD0,TIUD12) ; set cosig req
"RTN","TIUSRVP",124,0)
 ; For backward compatibility
"RTN","TIUSRVP",125,0)
 ; Use SETCOS^TIUSRVP2 now, please
"RTN","TIUSRVP",126,0)
 D SETCOS^TIUSRVP2(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",127,0)
 Q
"RTN","TIUSRVP",128,0)
UPDSTAT(DA,TITLE) ; Update status on commit
"RTN","TIUSRVP",129,0)
 N DR,DIE S DR=".05////"_$$STATUS^TIUSRVP1(DA,0,TITLE)
"RTN","TIUSRVP",130,0)
 I '+$P($G(^TIU(8925,DA,13)),U,4) S DR=DR_";1304////^S X=$$NOW^XLFDT"
"RTN","TIUSRVP",131,0)
 S DIE=8925
"RTN","TIUSRVP",132,0)
 D ^DIE
"RTN","TIUSRVP",133,0)
 Q
"RTN","TIUSRVP",134,0)
GETREC(DFN,TIU,TITLE,TIUNEW) ; Get/create document record
"RTN","TIUSRVP",135,0)
 N DA,DIC,DIE,DLAYGO,DR,X,Y,TIUDPRM,TIUFPRIV,TIUHIT,TIUSCAT
"RTN","TIUSRVP",136,0)
 S (TIUHIT,DA)=0,TIUFPRIV=1
"RTN","TIUSRVP",137,0)
 S (DIC,DLAYGO)=8925,DIC(0)="FL"
"RTN","TIUSRVP",138,0)
 S X=""""_"`"_+TITLE_"""" D ^DIC K DIC("S")
"RTN","TIUSRVP",139,0)
 I +Y'>0 Q Y_U_" Insufficient data to create a new record."
"RTN","TIUSRVP",140,0)
 S DA=+Y,TIUNEW=+$P(Y,U,3)
"RTN","TIUSRVP",141,0)
 N DIE,DR,TIUVISIT S DIE=8925
"RTN","TIUSRVP",142,0)
 S TIUVISIT=$S(+$G(TIU("VISIT")):+$G(TIU("VISIT")),1:"")
"RTN","TIUSRVP",143,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP",144,0)
 S DR=".04////"_$$DOCCLASS^TIULC1(+$P(Y,U,2))_";.13////"_TIUSCAT_";1205////"_$P($G(TIU("LOC")),U)_";1211////"_$P($G(TIU("VLOC")),U)_";1212////"_$P($G(TIU("INST")),U)
"RTN","TIUSRVP",145,0)
 D ^DIE
"RTN","TIUSRVP",146,0)
 Q +$G(DA)
"RTN","TIUSRVP",147,0)
FILE(SUCCESS,TIUDA,TIUX,SUPPRESS,TIUCPF) ; Call FM Filer & commit
"RTN","TIUSRVP",148,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUCMMTX
"RTN","TIUSRVP",149,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS=""
"RTN","TIUSRVP",150,0)
 I +$G(TIUX(1202)) S TIUX(1204)=+$G(TIUX(1202))
"RTN","TIUSRVP",151,0)
 I +$G(TIUX(1209)) S TIUX(1208)=+$G(TIUX(1209))
"RTN","TIUSRVP",152,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP",153,0)
 ;Entered By field to the Author/Dictator field
"RTN","TIUSRVP",154,0)
 I $G(TIUCPF),+$G(TIUX(1202)) S TIUX(1302)=+$G(TIUX(1202))
"RTN","TIUSRVP",155,0)
 M @FDARR=TIUX
"RTN","TIUSRVP",156,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUSRVP",157,0)
 I $D(TIUMSG)>9 S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1)) Q
"RTN","TIUSRVP",158,0)
 S SUCCESS=TIUDA
"RTN","TIUSRVP",159,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",160,0)
 . N DA
"RTN","TIUSRVP",161,0)
 . S DA=TIUDA
"RTN","TIUSRVP",162,0)
 . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVP",163,0)
 . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUSRVP",164,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUSRVP",165,0)
 Q
"RTN","TIUSRVP",166,0)
SIGN(ERR,TIUDA,TIUX) ; API for /es/
"RTN","TIUSRVP",167,0)
 ; For backward compatibility
"RTN","TIUSRVP",168,0)
 ; Use SIGN^TIUSRVP2 now, please
"RTN","TIUSRVP",169,0)
 D SIGN^TIUSRVP2(.ERR,TIUDA,.TIUX)
"RTN","TIUSRVP",170,0)
 Q
"RTN","TIUSRVP",171,0)
DELETE(ERR,TIUDA,TIURSN,OVRRIDE) ; delete document
"RTN","TIUSRVP",172,0)
 N TIUDEL,TIUD0 S ERR=0
"RTN","TIUSRVP",173,0)
 I '+$G(OVRRIDE) D  Q:+$G(TIUDEL)'>0
"RTN","TIUSRVP",174,0)
 . S TIUDEL=$$CANDO^TIULP(TIUDA,"DELETE RECORD")
"RTN","TIUSRVP",175,0)
 . I TIUDEL'>0 S ERR="89250003^"_$$EZBLD^DIALOG(89250003)
"RTN","TIUSRVP",176,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP",177,0)
 I +$P(TIUD0,U,5)'<6 D  Q
"RTN","TIUSRVP",178,0)
 . S TIURSN=$G(TIURSN,"A")
"RTN","TIUSRVP",179,0)
 . D DELTEXT^TIURB2(TIUDA,TIURSN)
"RTN","TIUSRVP",180,0)
 D DIK^TIURB2(TIUDA)
"RTN","TIUSRVP",181,0)
 D DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUSRVP",182,0)
 Q
"RTN","TIUSRVP",183,0)
LOCK(ERR,TIUDA) ; Bid for lock on a TIU Document record
"RTN","TIUSRVP",184,0)
 L +^TIU(8925,+TIUDA):1 I  S ERR=0
"RTN","TIUSRVP",185,0)
 E  S ERR="1^ Another session has this record locked."
"RTN","TIUSRVP",186,0)
 Q
"RTN","TIUSRVP",187,0)
UNLOCK(ERR,TIUDA) ; Decrement Lock on a TIU Document record
"RTN","TIUSRVP",188,0)
 L -^TIU(8925,+TIUDA) S ERR=0
"RTN","TIUSRVP",189,0)
 Q
"VER")
8.0^22.0
"BLD",7311,6)
^239
**END**
**END**
