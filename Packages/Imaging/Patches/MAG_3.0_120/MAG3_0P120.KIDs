KIDS Distribution saved on May 23, 2012@08:07:15
VistA Imaging V3.0 - Patch 120 05/23/2012 08:07AM
**KIDS**:MAG*3.0*120^

**INSTALL NAME**
MAG*3.0*120
"BLD",3463,0)
MAG*3.0*120^IMAGING^0^3120523^y
"BLD",3463,1,0)
^^18^18^3120523^
"BLD",3463,1,1,0)
Version 3.0 Patch 120 - VistARad Maintenance VII
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
Routines:
"BLD",3463,1,5,0)
MAGJEX1     new value = 73006273
"BLD",3463,1,6,0)
MAGJEX1A    new value = 74002444
"BLD",3463,1,7,0)
MAGJEX2     new value = 45090288
"BLD",3463,1,8,0)
MAGJLS3     new value = 73486963
"BLD",3463,1,9,0)
MAGJLST1    new value = 51607794
"BLD",3463,1,10,0)
MAGJMN1     new value = 106024345
"BLD",3463,1,11,0)
MAGJMN3     new value = 6661799
"BLD",3463,1,12,0)
MAGJRPT     new value = 78502597
"BLD",3463,1,13,0)
MAGJTU4V    new value = 5203794
"BLD",3463,1,14,0)
MAGJUPD1    new value = 61960961
"BLD",3463,1,15,0)
MAGJUTL2    new value = 55943912
"BLD",3463,1,16,0)
MAGJUTL3    new value = 130108028
"BLD",3463,1,17,0)
MAGJUTL4    new value = 152537255
"BLD",3463,1,18,0)
MAGJUTL5    new value = 38114169
"BLD",3463,4,0)
^9.64PA^^0
"BLD",3463,6.3)
V3.0p120Build27_T8
"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",3463,"INID")
n^n^n
"BLD",3463,"INIT")
POSTINST^MAGJMN1
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.4,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.401,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.402,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",.84,"NM",0)
^9.68A^^
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^14^14
"BLD",3463,"KRN",9.8,"NM",1,0)
MAGJEX1^^0^B73006273
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGJEX1A^^0^B74002444
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGJEX2^^0^B45090288
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGJLS3^^0^B73486963
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGJLST1^^0^B51607794
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGJMN1^^0^B106024345
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGJMN3^^0^B6661799
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGJRPT^^0^B78502597
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGJTU4V^^0^B5203794
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGJUPD1^^0^B61960961
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGJUTL2^^0^B55943912
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGJUTL3^^0^B130108028
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGJUTL4^^0^B152537255
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGJUTL5^^0^B38114169
"BLD",3463,"KRN",9.8,"NM","B","MAGJEX1",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGJEX1A",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGJEX2",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGJLS3",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGJLST1",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGJMN1",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGJMN3",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGJRPT",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGJTU4V",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGJUPD1",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGJUTL2",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGJUTL3",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGJUTL4",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGJUTL5",14)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^^
"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^^
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",771,"NM",0)
^9.68A^^
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",870,"NM",0)
^9.68A^^
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^^
"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"PRE")
MAGJMN1
"BLD",3463,"REQB",0)
^9.611^2^2
"BLD",3463,"REQB",1,0)
MAG*3.0*104^2
"BLD",3463,"REQB",2,0)
MAG*3.0*115^2
"BLD",3463,"REQB","B","MAG*3.0*104",1)

"BLD",3463,"REQB","B","MAG*3.0*115",2)

"INIT")
POSTINST^MAGJMN1
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
120^3120523^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^17^17^3120523
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 120, Test Build 8.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAGJEX1     value = 23534520
"PKG",454,22,1,"PAH",1,1,5,0)
MAGJEX1A    value = 24904344
"PKG",454,22,1,"PAH",1,1,6,0)
MAGJEX2     value = 13889635
"PKG",454,22,1,"PAH",1,1,7,0)
MAGJLS3     value = 18509439
"PKG",454,22,1,"PAH",1,1,8,0)
MAGJLST1    value = 14882477
"PKG",454,22,1,"PAH",1,1,9,0)
MAGJMN1     value = 19373467
"PKG",454,22,1,"PAH",1,1,10,0)
MAGJMN3     value = 3776166
"PKG",454,22,1,"PAH",1,1,11,0)
MAGJRPT     value = 25862262
"PKG",454,22,1,"PAH",1,1,12,0)
MAGJTU4V    value = 3585975
"PKG",454,22,1,"PAH",1,1,13,0)
MAGJUPD1    value = 19589826
"PKG",454,22,1,"PAH",1,1,14,0)
MAGJUTL2    value = 17540135
"PKG",454,22,1,"PAH",1,1,15,0)
MAGJUTL3    value = 20682689
"PKG",454,22,1,"PAH",1,1,16,0)
MAGJUTL4    value = 21304219
"PKG",454,22,1,"PAH",1,1,17,0)
MAGJUTL5    value = 16379041
"PRE")
MAGJMN1
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","MAGJEX1")
0^1^B73006273
"RTN","MAGJEX1",1,0)
MAGJEX1 ;WIRMFO/JHC - VistARad RPC calls ; 9 Sep 2011  4:05 PM
"RTN","MAGJEX1",2,0)
 ;;3.0;IMAGING;**16,22,18,65,101,115,104,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJEX1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJEX1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJEX1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJEX1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJEX1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJEX1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJEX1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJEX1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJEX1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJEX1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJEX1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJEX1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJEX1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX1",17,0)
 ;;
"RTN","MAGJEX1",18,0)
 Q
"RTN","MAGJEX1",19,0)
 ;
"RTN","MAGJEX1",20,0)
 ;
"RTN","MAGJEX1",21,0)
ERR N ERR S ERR=$$EC^%ZOSV S @MAGGRY@(0)="0^4~"_ERR
"RTN","MAGJEX1",22,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJEX1",23,0)
 Q:$Q 1  Q
"RTN","MAGJEX1",24,0)
 ;
"RTN","MAGJEX1",25,0)
 ;***** Open an exam.
"RTN","MAGJEX1",26,0)
 ; RPC: MAGJ RADCASEIMAGES
"RTN","MAGJEX1",27,0)
 ;
"RTN","MAGJEX1",28,0)
OPENCASE(MAGGRY,DATA) ;
"RTN","MAGJEX1",29,0)
 ; MAGGRY holds $NA reference to ^TMP for rpc return
"RTN","MAGJEX1",30,0)
 ;   all ref's to MAGGRY use subscript indirection
"RTN","MAGJEX1",31,0)
 ; input in DATA:
"RTN","MAGJEX1",32,0)
 ; OPEN_FLAG ^ RADFN^RADTI^RACNI^RARPT ^ PSINDGET ^ <unused> ^ USETGA
"RTN","MAGJEX1",33,0)
 ; OPEN_FLAG = 0: Open, view only
"RTN","MAGJEX1",34,0)
 ;     1: Open, lock the case for status update
"RTN","MAGJEX1",35,0)
 ;     2: Open, Reserve for Interpretation
"RTN","MAGJEX1",36,0)
 ;     VIX: Fetching metadata only; Jukebox retrieval occurs (P115 & earlier)
"RTN","MAGJEX1",37,0)
 ;     VIX-Metadata: Fetching metadata only; no JB Retrieval (P104,ff)
"RTN","MAGJEX1",38,0)
 ;     VIX-Open: Fetching metadata with JB Retrieval (P104,ff)
"RTN","MAGJEX1",39,0)
 ; RADFN^RADTI^RACNI^RARPT = Exam ID string, specifies case of interest
"RTN","MAGJEX1",40,0)
 ; PSINDGET= Presentation State indicators of interest to client
"RTN","MAGJEX1",41,0)
 ;     K/I/U for Key Image/ Interpretation/ User PS types
"RTN","MAGJEX1",42,0)
 ; USETGA   = 1: Open TGA (downsampled) file; 0: Open BIG file
"RTN","MAGJEX1",43,0)
 ; 
"RTN","MAGJEX1",44,0)
 ; Details of Reply message are below tag OPENCASZ
"RTN","MAGJEX1",45,0)
 ; 
"RTN","MAGJEX1",46,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJEX1"
"RTN","MAGJEX1",47,0)
 N RARPT,RADFN,RADTI,RACNI,RADIV
"RTN","MAGJEX1",48,0)
 N DAYCASE,CURCASE,REPLY,CT,MAGS,STARTNOD,LOCKED,DATAOUT,RADATA,RIST,MDL
"RTN","MAGJEX1",49,0)
 N IMAG,MAGXX,MAGFILE,MAGFILE1,MAGFILE2,MAGFILE3,MAGLST,MAGOBJT,MODALITY
"RTN","MAGJEX1",50,0)
 N MAGSTRT,MAGEND,CURPATHS
"RTN","MAGJEX1",51,0)
 N MIXEDUP,VIEWOK,USETGA,USELORES,IMGST,REMOTE,DIQUIET
"RTN","MAGJEX1",52,0)
 N LOGDATA,MODIF,EXCAT,RADATA2,PSIND,RACPT,RASTCAT,RASTORD,ACQSITE,ALTPATH,PROCDT
"RTN","MAGJEX1",53,0)
 N YNMAMMO,YNREVANN,PSINDGET,JBDISABLE,STANUM
"RTN","MAGJEX1",54,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJEX1",55,0)
 S (CT,MIXEDUP)=0,MODALITY="",DATAOUT="",DAYCASE="",MAGLST="MAGJOPENCASE",(ACQSITE,ALTPATH,PROCDT,STANUM)=""
"RTN","MAGJEX1",56,0)
 S VIEWOK=1
"RTN","MAGJEX1",57,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)),STARTNOD=0 K @MAGGRY  ; assign MAGGRY value
"RTN","MAGJEX1",58,0)
 S CURCASE=$P(DATA,U),RARPT=+$P(DATA,U,5),PSINDGET=+$P(DATA,U,6)
"RTN","MAGJEX1",59,0)
 S PSIND="" I PSINDGET]"" F I="K","I","U" I $F(PSINDGET,I) S PSIND(I)=""
"RTN","MAGJEX1",60,0)
 S USETGA=+$P(DATA,U,8)
"RTN","MAGJEX1",61,0)
 S RADFN=$P(DATA,U,2),RADTI=$P(DATA,U,3),RACNI=$P(DATA,U,4)
"RTN","MAGJEX1",62,0)
 I RADFN,RADTI,RACNI D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,"",.X)
"RTN","MAGJEX1",63,0)
 I 'X S REPLY="4~Request Contains Invalid Case Pointer ("_RADFN_U_RADTI_U_RACNI_U_RARPT_")." G OPENCASZ
"RTN","MAGJEX1",64,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)),RADATA2=$G(^(2))
"RTN","MAGJEX1",65,0)
 K ^TMP($J,"MAGRAEX")
"RTN","MAGJEX1",66,0)
 S RADIV=$P(RADATA2,U,5),MODIF=$P(RADATA2,U,8),RASTCAT=$P(RADATA2,U,11),RASTORD=$P(RADATA,U,15)
"RTN","MAGJEX1",67,0)
 S RARPT=+$P(RADATA,U,10),DAYCASE=$P(RADATA,U,12),RACPT=$P(RADATA,U,17)
"RTN","MAGJEX1",68,0)
 I 'RARPT!'$D(^RARPT(RARPT,2005)) S REPLY="4~This exam has no report entry for associating images; no images can be accessed." G OPENCASZ
"RTN","MAGJEX1",69,0)
 D CKINTEG^MAGJRPT(.X,RADFN,RADTI,RACNI,RARPT,RADATA)
"RTN","MAGJEX1",70,0)
 I X]"" S MIXEDUP=1,MIXEDUP("REPLY")=X ; DB corruption
"RTN","MAGJEX1",71,0)
 S REPLY="4~Attempting to open/display case #"_DAYCASE
"RTN","MAGJEX1",72,0)
 S JBDISABLE=0
"RTN","MAGJEX1",73,0)
 I CURCASE="VIX-Metadata" S JBDISABLE=1 ; metadata only, do not trigger JB fetches
"RTN","MAGJEX1",74,0)
 ;
"RTN","MAGJEX1",75,0)
 ; Note in several reply messages below the use of "2~"
"RTN","MAGJEX1",76,0)
 ;   This value triggers specific behaviors in vrad client and VIX
"RTN","MAGJEX1",77,0)
 ;     -- client displays an Information message box
"RTN","MAGJEX1",78,0)
 ;     -- VIX 'tags' the exam to refresh the file list metadata from the source
"RTN","MAGJEX1",79,0)
 ;         on any subsequent access for this exam
"RTN","MAGJEX1",80,0)
 ;    These respective behaviours are mutually appropriate for both parts of 
"RTN","MAGJEX1",81,0)
 ;    the system for all the messages involved; avoid using "2~" unless the
"RTN","MAGJEX1",82,0)
 ;    same functionality applies for any given new functionality
"RTN","MAGJEX1",83,0)
 ;
"RTN","MAGJEX1",84,0)
 S IMGST=$$JBFETCH^MAGJUTL2(RARPT,.MAGS,USETGA,JBDISABLE)  ; open only if NOT on JB
"RTN","MAGJEX1",85,0)
 I +IMGST D  G OPENCASZ  ; some images are on JB
"RTN","MAGJEX1",86,0)
 . I $D(MAGS("OFFLN")) N T,TT S T="",TT="" D
"RTN","MAGJEX1",87,0)
 . . F  S T=$O(MAGS("OFFLN",T)) Q:T=""  S TT=TT_$S(TT="":"",1:", ")_T
"RTN","MAGJEX1",88,0)
 . . S REPLY="2~Case #"_DAYCASE_"--Images for this exam are stored OFF-LINE.  To view these images, contact your Imaging Coordinator, and request mounting of the following platters: "_TT
"RTN","MAGJEX1",89,0)
 . E  I JBDISABLE S REPLY="2~Case #"_DAYCASE_"--"_+IMGST_" Images are on Jukebox."
"RTN","MAGJEX1",90,0)
 . E  S REPLY="2~Case #"_DAYCASE_"--"_+IMGST_" Images have been requested from Jukebox; try again later."
"RTN","MAGJEX1",91,0)
 I '$P(IMGST,U,2) S REPLY="2~No Images exist for Case #"_DAYCASE_"." G OPENCASZ
"RTN","MAGJEX1",92,0)
 S USELORES=+$P(IMGST,U,3)_U_$P(IMGST,U,2)
"RTN","MAGJEX1",93,0)
 S MAGSTRT=1,MAGEND=MAGS D IMGLOOP^MAGJEX1B
"RTN","MAGJEX1",94,0)
 ;
"RTN","MAGJEX1",95,0)
 I ACQSITE="" S ACQSITE=RADIV
"RTN","MAGJEX1",96,0)
 ; 
"RTN","MAGJEX1",97,0)
 ; Conditionally support revising an unlocked exam's annotations as a function
"RTN","MAGJEX1",98,0)
 ;   of exam status and credentials of (current & original) interpreter (P101).
"RTN","MAGJEX1",99,0)
 S YNREVANN=$$ZRUREVAN^MAGJUTL4(RADFN,RADTI,RACNI)
"RTN","MAGJEX1",100,0)
 ; 
"RTN","MAGJEX1",101,0)
 ; Return flag to allow display of disclaimer text if ExamType="Mammogram".
"RTN","MAGJEX1",102,0)
 ;   Note the VRad client may override based on image metadata (P101).
"RTN","MAGJEX1",103,0)
 S YNMAMMO=$$ZRUMAMMO^MAGJUTL4(RACPT)
"RTN","MAGJEX1",104,0)
 ; 
"RTN","MAGJEX1",105,0)
 ; 
"RTN","MAGJEX1",106,0)
 S REPLY="0~Images for Case #"_DAYCASE
"RTN","MAGJEX1",107,0)
 ;
"RTN","MAGJEX1",108,0)
OPENCASZ I 'CT,(REPLY["Attempting") S REPLY="4~Unable to retrieve images for Case #"_DAYCASE_"."
"RTN","MAGJEX1",109,0)
 ;
"RTN","MAGJEX1",110,0)
 ; Contents of successful reply = 4 pipe-delimited ("|") pieces:
"RTN","MAGJEX1",111,0)
 ;  1: # Image nodes ^ Reply Msg Type ~ Reply Msg display text
"RTN","MAGJEX1",112,0)
 ;  2: RADFN^RADTI^RACNI^RARPT  -->  Exam ID String
"RTN","MAGJEX1",113,0)
 ;  3: Pt Name ^ CASE # ^ Proc. Name ^ Exam Date ^ Time ^ Modality ^
"RTN","MAGJEX1",114,0)
 ;      SSN ^ <unused> ^ LOCKED Status ^ Modifier ^ Exam Status Category
"RTN","MAGJEX1",115,0)
 ;  4: Is Radiologist? ^ Alt_Path Flag ^ Acquisition Site ^ Procedure Date ^
"RTN","MAGJEX1",116,0)
 ;      Revise Annotations? ^ Mammography? ^ Station Number
"RTN","MAGJEX1",117,0)
 ;
"RTN","MAGJEX1",118,0)
 S REMOTE=+MAGJOB("REMOTE")
"RTN","MAGJEX1",119,0)
 S LOCKED=0
"RTN","MAGJEX1",120,0)
 I MIXEDUP D
"RTN","MAGJEX1",121,0)
 . N IMIX,XDFN,XPTS S VIEWOK=$S($D(MAGJOB("KEYS","MAGJ SEE BAD IMAGES")):1,1:0)
"RTN","MAGJEX1",122,0)
 . I MIXEDUP>1 D
"RTN","MAGJEX1",123,0)
 . . S XPTS="",XDFN=0 F IMIX=0:1 S XDFN=$O(MIXEDUP(XDFN)) Q:'XDFN  S XPTS=XPTS_$S(IMIX:" and ",1:" ")_$$PNAM(XDFN)
"RTN","MAGJEX1",124,0)
 . . S XPTS=$S(IMIX=1:" ",1:"s ")_XPTS
"RTN","MAGJEX1",125,0)
 . . S REPLY=(7-VIEWOK)_"~This exam is registered for "_$$PNAM(RADFN)_"; however, it is linked to images for patient"_XPTS_".  This is a serious problem--immediately report it to Radiology management and Imaging support staff!"
"RTN","MAGJEX1",126,0)
 . E  S REPLY=(7-VIEWOK)_"~"_MIXEDUP("REPLY")
"RTN","MAGJEX1",127,0)
 . I CURCASE S REPLY=REPLY_"  The exam is NOT Locked." S CURCASE=0
"RTN","MAGJEX1",128,0)
 I CT D
"RTN","MAGJEX1",129,0)
 . S RIST=$S(+MAGJOB("USER",1):1,1:0),EXCAT=""
"RTN","MAGJEX1",130,0)
 . S LOGDATA=RADFN_U_+$P(MAGS(1),U,4)_U_+MAGS_U_REMOTE ; for Img Access log
"RTN","MAGJEX1",131,0)
 . I CURCASE D
"RTN","MAGJEX1",132,0)
 . . I $G(MAGJOB("CONSOLIDATED")),'$D(MAGJOB("DIVSCRN",RADIV)) D  S CURCASE=0  Q
"RTN","MAGJEX1",133,0)
 . . . S REPLY="5~Exam is for Station #"_$$STATN(RADIV)_"; you are logged on to #"_$$STATN(DUZ(2))_".  Exam is NOT Locked."
"RTN","MAGJEX1",134,0)
 . . S XX=$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,3)
"RTN","MAGJEX1",135,0)
 . . I '$D(^RA(72,"AVC","E",XX)) D  S CURCASE=0  Q
"RTN","MAGJEX1",136,0)
 . . . D LOCKACT^MAGJEX1A(RARPT,DAYCASE,100,.RESULT) ; between reserve and now, exam may have been Taken & Updated
"RTN","MAGJEX1",137,0)
 . . . I +RESULT(1)!+RESULT(2) D LOCKACT^MAGJEX1A(RARPT,DAYCASE,101,.RESULT) ; so, cancel any lock/reserve
"RTN","MAGJEX1",138,0)
 . . . S REPLY="5~For Case #"_DAYCASE_", current Status is "_$P(^RA(72,XX,0),U)_"; Lock or Reserve NOT allowed."
"RTN","MAGJEX1",139,0)
 . . E  S EXCAT="E"
"RTN","MAGJEX1",140,0)
 . . I RIST,'USELORES D  ; lock only for Current Case, Radiologist, & Full Res images
"RTN","MAGJEX1",141,0)
 . . . ;  save data needed to later log Interpreted event
"RTN","MAGJEX1",142,0)
 . . . D LOCKACT^MAGJEX1A(RARPT,DAYCASE,CURCASE,.RESULT,.REPLY,LOGDATA)
"RTN","MAGJEX1",143,0)
 . . . S LOCKED=$S(+RESULT:1,+$P(RESULT,U,2):2,1:0)
"RTN","MAGJEX1",144,0)
 . I EXCAT="" D
"RTN","MAGJEX1",145,0)
 . . I RASTORD=9 S EXCAT="C" Q  ; Complete
"RTN","MAGJEX1",146,0)
 . . E  S EXCAT=RASTCAT
"RTN","MAGJEX1",147,0)
 . . I EXCAT="D"!(EXCAT="T") S EXCAT="I" ; just display one value meaning Interpreted
"RTN","MAGJEX1",148,0)
 . S DATAOUT=$P(RADATA,U,4)_U_DAYCASE_U_$P(RADATA,U,9)
"RTN","MAGJEX1",149,0)
 . S X=$P(RADATA,U,6),T=$L(X,"  "),X=$P(X,"  ",1,T-1)_U_$P(X,"  ",T)
"RTN","MAGJEX1",150,0)
 . S DATAOUT=DATAOUT_U_X
"RTN","MAGJEX1",151,0)
 . S DATAOUT=DATAOUT_U_MODALITY_U_$P(RADATA,U,5)_U_U_LOCKED
"RTN","MAGJEX1",152,0)
 . S DATAOUT=DATAOUT_U_MODIF_U_EXCAT_U_"|"_RIST_U_ALTPATH_U_ACQSITE_U_PROCDT_U_YNREVANN_U_YNMAMMO_U_STANUM
"RTN","MAGJEX1",153,0)
 . I USELORES D
"RTN","MAGJEX1",154,0)
 . . I +USELORES=+$P(USELORES,U,2) S X="All"
"RTN","MAGJEX1",155,0)
 . . E  S X=+USELORES_" of "_+$P(USELORES,U,2)
"RTN","MAGJEX1",156,0)
 . . I $E(REPLY,1,8)="0~Images" S REPLY="3~"
"RTN","MAGJEX1",157,0)
 . . E  S REPLY=REPLY_"  --  "
"RTN","MAGJEX1",158,0)
 . . S REPLY=REPLY_"Note: "_X_" images for Case #"_DAYCASE_" are REDUCED RESOLUTION images, using parameters set by your site Imaging Manager; to view full-resolution images, disable the Reduced Resolution option setting. Exam NOT Locked."
"RTN","MAGJEX1",159,0)
 S @MAGGRY@(STARTNOD)=CT_U_REPLY_"|"_RADFN_U_RADTI_U_RACNI_U_RARPT_"|"_DATAOUT
"RTN","MAGJEX1",160,0)
 ; if mixedup & not have keys to see images, delete image refs
"RTN","MAGJEX1",161,0)
 ;   & send only reply msg
"RTN","MAGJEX1",162,0)
 I MIXEDUP,('VIEWOK) S CT=0 K @MAGGRY S @MAGGRY@(0)=CT_U_REPLY
"RTN","MAGJEX1",163,0)
 E  S $P(@MAGGRY@(0),U)=CT+STARTNOD
"RTN","MAGJEX1",164,0)
 I CT,(LOCKED'=2),(CURCASE'["VIX") D LOG^MAGJUTL3("VR-VW",LOGDATA,$$PSETLST(RADFN,RADTI,RACNI)) ; Image access log
"RTN","MAGJEX1",165,0)
 Q
"RTN","MAGJEX1",166,0)
 ;
"RTN","MAGJEX1",167,0)
PSETLST(RADFN,RADTI,RACNI) ; Return list of Printset Case #'s for exam
"RTN","MAGJEX1",168,0)
 N I,MAGPSET,PSETLST,RAPRTSET,X
"RTN","MAGJEX1",169,0)
 S PSETLST=""  ; initialize return value
"RTN","MAGJEX1",170,0)
 I +$G(RADFN),+$G(RADTI),+$G(RACNI) D
"RTN","MAGJEX1",171,0)
 . D EN2^RAUTL20(.MAGPSET)
"RTN","MAGJEX1",172,0)
 . Q:'RAPRTSET  ; variable set by above call; stop if not a printset
"RTN","MAGJEX1",173,0)
 . S X=""
"RTN","MAGJEX1",174,0)
 . F I=0:1 S X=$O(MAGPSET(X)) Q:'X  S PSETLST=PSETLST_$S(I:U,1:"")_+MAGPSET(X)
"RTN","MAGJEX1",175,0)
 Q:$Q PSETLST Q
"RTN","MAGJEX1",176,0)
 ;
"RTN","MAGJEX1",177,0)
PNAM(X) ; return pt name for input DFN
"RTN","MAGJEX1",178,0)
 I X S X=$G(^DPT(+X,0)) I X]"" S X=$P(X,U)
"RTN","MAGJEX1",179,0)
 E  S X="UNKNOWN"
"RTN","MAGJEX1",180,0)
 Q X
"RTN","MAGJEX1",181,0)
 ;
"RTN","MAGJEX1",182,0)
STATN(X) ; get station #, else return input value
"RTN","MAGJEX1",183,0)
 N T
"RTN","MAGJEX1",184,0)
 I X]"" D GETS^DIQ(4,X,99,"","T") S T=$G(T(4,X_",",99,"E")) I T]"" S X=T
"RTN","MAGJEX1",185,0)
 Q X
"RTN","MAGJEX1",186,0)
 ;
"RTN","MAGJEX1",187,0)
END Q  ;
"RTN","MAGJEX1",188,0)
 ;
"RTN","MAGJEX1A")
0^2^B74002444
"RTN","MAGJEX1A",1,0)
MAGJEX1A ;WIRMFO/JHC - VistARad RPCs, exam locking ; 9 Sep 2011  4:05 PM
"RTN","MAGJEX1A",2,0)
 ;;3.0;IMAGING;**18,65,101,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJEX1A",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJEX1A",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX1A",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJEX1A",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJEX1A",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJEX1A",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJEX1A",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJEX1A",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJEX1A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJEX1A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJEX1A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJEX1A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJEX1A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJEX1A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX1A",17,0)
 ;;
"RTN","MAGJEX1A",18,0)
 Q
"RTN","MAGJEX1A",19,0)
 ; Entry Points:
"RTN","MAGJEX1A",20,0)
 ;   CASLOCK--RPC: Lock mgt
"RTN","MAGJEX1A",21,0)
 ;   LOCKACT--Subrtn
"RTN","MAGJEX1A",22,0)
 ;   LOCKOUT--Subrtn
"RTN","MAGJEX1A",23,0)
 ;
"RTN","MAGJEX1A",24,0)
ERR N ERR S ERR=$$EC^%ZOSV S @MAGGRY@(0)="0^4~"_ERR
"RTN","MAGJEX1A",25,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJEX1A",26,0)
 Q:$Q 1  Q
"RTN","MAGJEX1A",27,0)
 ;
"RTN","MAGJEX1A",28,0)
CASLOCK(MAGGRY,DATA) ; RPC Call: MAGJ RADCASELOCKS
"RTN","MAGJEX1A",29,0)
 ; MAGGRY holds $NA reference to ^TMP for rpc reply; all ref's to MAGGRY use ss indirection
"RTN","MAGJEX1A",30,0)
 ; input in DATA: OPEN_FLAG^RADFN^RADTI^RACNI^RARPT
"RTN","MAGJEX1A",31,0)
 ; OPEN_FLAG = 3: Reserve-to-Lock; 4: Lock-to-Reserve; 5: Lock/Take
"RTN","MAGJEX1A",32,0)
 ; RADFN^, etc--exam id
"RTN","MAGJEX1A",33,0)
 ;
"RTN","MAGJEX1A",34,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJEX1A"
"RTN","MAGJEX1A",35,0)
 N RARPT,RADFN,RADTI,RACNI,DIQUIET,CURCASE,REPLY,CT,DATAOUT,MAGLST,XX
"RTN","MAGJEX1A",36,0)
 N DAYCASE,LOCKED,RACN,RADTE,MAGS,LOGDATA,RESULT,MYLOCK,GOTLOCK,LONGACN
"RTN","MAGJEX1A",37,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJEX1A",38,0)
 S CT=0,DATAOUT=0,DAYCASE="",MAGLST="MAGJCASELOCK"
"RTN","MAGJEX1A",39,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)) K @MAGGRY  ; assign MAGGRY
"RTN","MAGJEX1A",40,0)
 S CURCASE=+$P(DATA,U)
"RTN","MAGJEX1A",41,0)
 S RADFN=$P(DATA,U,2),RADTI=$P(DATA,U,3),RACNI=$P(DATA,U,4),RARPT=+$P(DATA,U,5)
"RTN","MAGJEX1A",42,0)
 I "^3^4^5^"[(U_CURCASE_U)
"RTN","MAGJEX1A",43,0)
 E  S REPLY="4~Invalid Caselock request ("_DATA_")." G CASLOCKZ
"RTN","MAGJEX1A",44,0)
 I RADFN,RADTI,RACNI,RARPT
"RTN","MAGJEX1A",45,0)
 E  S REPLY="4~Caselock Request contains invalid Case Pointer ("_DATA_")." G CASLOCKZ
"RTN","MAGJEX1A",46,0)
 S XX=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","MAGJEX1A",47,0)
 S RACN=$P(XX,U),LONGACN=$P(XX,U,31)
"RTN","MAGJEX1A",48,0)
 S RADTE=9999999.9999-RADTI
"RTN","MAGJEX1A",49,0)
 S DAYCASE=$E(RADTE,4,7)_$E(RADTE,2,3)_"-"_RACN
"RTN","MAGJEX1A",50,0)
 I LONGACN]"" S DAYCASE=LONGACN
"RTN","MAGJEX1A",51,0)
 S X=$P(XX,U,3)
"RTN","MAGJEX1A",52,0)
 I '$D(^RA(72,"AVC","E",X)) D  G CASLOCKZ
"RTN","MAGJEX1A",53,0)
 . N STS S STS=X
"RTN","MAGJEX1A",54,0)
 . D LOCKACT(RARPT,DAYCASE,100,.RESULT) ; between reserve and now, exam may have been Taken & Updated
"RTN","MAGJEX1A",55,0)
 . I +RESULT(1)!+RESULT(2) D LOCKACT(RARPT,DAYCASE,101,.RESULT) ; so, cancel any lock/reserve
"RTN","MAGJEX1A",56,0)
 . S REPLY="5~For Case #"_DAYCASE_", current Status is "_$P(^RA(72,STS,0),U)_"; Reserve/Lock change NOT allowed."
"RTN","MAGJEX1A",57,0)
 D LOCKACT(RARPT,DAYCASE,CURCASE,.RESULT,.REPLY)
"RTN","MAGJEX1A",58,0)
 S GOTLOCK=+RESULT
"RTN","MAGJEX1A",59,0)
 D LOCKACT(RARPT,DAYCASE,100,.MYLOCK)
"RTN","MAGJEX1A",60,0)
 I GOTLOCK&+MYLOCK(1)&(CURCASE=3!(CURCASE=5)) D  ; update Image access log if got the lock
"RTN","MAGJEX1A",61,0)
 . S LOGDATA=$P(MYLOCK(2),"|",2)  ; was saved when the Reserve occurred
"RTN","MAGJEX1A",62,0)
 . I CURCASE=5 S $P(LOGDATA,U,4)=+MAGJOB("REMOTE") ; update "remote" indicator if was TAKEN
"RTN","MAGJEX1A",63,0)
 . D LOG^MAGJUTL3("VR-VW",LOGDATA,$$PSETLST^MAGJEX1(RADFN,RADTI,RACNI))
"RTN","MAGJEX1A",64,0)
 . S $P(^XTMP("MAGJ","LOCK",RARPT,1,DAYCASE),"|",2)=LOGDATA  ; save for Interp event
"RTN","MAGJEX1A",65,0)
 S DATAOUT=$S(+MYLOCK(1):1,+MYLOCK(2):2,1:0)
"RTN","MAGJEX1A",66,0)
 ;
"RTN","MAGJEX1A",67,0)
CASLOCKZ ;
"RTN","MAGJEX1A",68,0)
 S @MAGGRY@(0)=CT_U_REPLY_"|"_RADFN_U_RADTI_U_RACNI_U_RARPT_"||"_DATAOUT
"RTN","MAGJEX1A",69,0)
 Q
"RTN","MAGJEX1A",70,0)
 ;
"RTN","MAGJEX1A",71,0)
PNAM(X) ; return pt name for input DFN
"RTN","MAGJEX1A",72,0)
 I X S X=$G(^DPT(+X,0)) I X]"" S X=$P(X,U)
"RTN","MAGJEX1A",73,0)
 E  S X="UNKNOWN"
"RTN","MAGJEX1A",74,0)
 Q X
"RTN","MAGJEX1A",75,0)
 ;
"RTN","MAGJEX1A",76,0)
LOCKACT(RARPT,DAYCASE,REQUEST,RESULT,ACTREPLY,LOGDATA) ; determine if desired lock action is feasible
"RTN","MAGJEX1A",77,0)
 ; Input: RARPT, DAYCASE, REQUEST, LOGDATA
"RTN","MAGJEX1A",78,0)
 ;   REQUESTed Action:
"RTN","MAGJEX1A",79,0)
 ;     1-Lock; 2-Reserve; 3-ResToLock; 4-LockToRes; 5-TakeLock; 100-Status; 101-UNLOCK
"RTN","MAGJEX1A",80,0)
 ;     Note: 100 & 101 are special for internal use only
"RTN","MAGJEX1A",81,0)
 ;   LOGDATA--pass through for Image Access Log
"RTN","MAGJEX1A",82,0)
 ; Output: RESULT, ACTREPLY
"RTN","MAGJEX1A",83,0)
 ;  RESULT: ACTION "allowed" = LOCK^RESERVE^ResToInt^IntToRes^Take^_"|"_ImgLst
"RTN","MAGJEX1A",84,0)
 ;    these are truth values; Imglst true =~ return Image File list to client
"RTN","MAGJEX1A",85,0)
 ;  RESULT is ultimately used at tag LOCKOUT
"RTN","MAGJEX1A",86,0)
 ;  ACTREPLY --reply message for client logic/display
"RTN","MAGJEX1A",87,0)
 ;
"RTN","MAGJEX1A",88,0)
 N ACTION,LOCKLEV,MYLOCK
"RTN","MAGJEX1A",89,0)
 K RESULT S ACTION="",ACTREPLY="",RESULT="" S LOGDATA=$G(LOGDATA,"")
"RTN","MAGJEX1A",90,0)
 I '$P($G(^MAG(2006.69,1,0)),U,4) Q  ;  Status Updates not enabled
"RTN","MAGJEX1A",91,0)
 I REQUEST=100 D LOCKIN^MAGJEX1B(RARPT,.LOCKLEV,.RESULT,"STATUS") G LOCKACTZ ; Lock Status check only
"RTN","MAGJEX1A",92,0)
 S ACTION="0^0^0^0^0|0"
"RTN","MAGJEX1A",93,0)
 D LOCKIN^MAGJEX1B(RARPT,.LOCKLEV,.MYLOCK)
"RTN","MAGJEX1A",94,0)
 I REQUEST=101 D  G LOCKACT1 ; Unlock exam
"RTN","MAGJEX1A",95,0)
 . M ACTREPLY=MYLOCK ; internal use by MAGJUPD1
"RTN","MAGJEX1A",96,0)
 I 'LOCKLEV D  G LOCKACT1
"RTN","MAGJEX1A",97,0)
 . I REQUEST=1!(REQUEST=2) S $P(ACTION,"|",2)=1,ACTREPLY="5~Exam #"_DAYCASE_" is Locked by "_$P(MYLOCK(1),U,4)_"."  ; View/Cancel
"RTN","MAGJEX1A",98,0)
 . E  S ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#0"
"RTN","MAGJEX1A",99,0)
 I LOCKLEV=3 D  ; Is or Can be Reserved or Interp by me
"RTN","MAGJEX1A",100,0)
 . I MYLOCK(1) D  Q  ; Already Locked/TAKEN by me
"RTN","MAGJEX1A",101,0)
 . . I REQUEST=1 D  Q
"RTN","MAGJEX1A",102,0)
 . . . I MAGJOB("P32") S $P(ACTION,U)=1,$P(ACTION,U,2)=1,$P(ACTION,"|",2)=1,ACTREPLY="1~#"_DAYCASE_" ("_$$PNAM(RADFN)_") locked for update by "_$P(MAGJOB("USER",1),U,3)
"RTN","MAGJEX1A",103,0)
 . . . E  S $P(ACTION,U,1)=1,$P(ACTION,U,2)=+MYLOCK(2),ACTREPLY="1~Exam #"_$P(MYLOCK(1),U,6)_" already open/locked--no action taken"
"RTN","MAGJEX1A",104,0)
 . . I REQUEST=4 D  Q  ;  Remove Lock, keep Reserve
"RTN","MAGJEX1A",105,0)
 . . . S $P(ACTION,U,2)=1,$P(ACTION,U,4)=1,ACTREPLY="1~Exam unlocked, reserved"
"RTN","MAGJEX1A",106,0)
 . . E  S $P(ACTION,U,1)=1,$P(ACTION,U,2)=+MYLOCK(2),ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#1"
"RTN","MAGJEX1A",107,0)
 . E  I MYLOCK(2) D  Q  ; Already Reserved by me
"RTN","MAGJEX1A",108,0)
 . . I REQUEST=3 S $P(ACTION,U)=1,$P(ACTION,U,2)=1,$P(ACTION,U,3)=1,ACTREPLY="1~#"_DAYCASE_" ("_$$PNAM(RADFN)_") locked for update (from reserve) by "_$P(MAGJOB("USER",1),U,3)
"RTN","MAGJEX1A",109,0)
 . . E  I REQUEST=2 S $P(ACTION,U,2)=1,ACTREPLY="1~Exam #"_$P(MYLOCK(2),U,6)_" already reserved--no action taken."
"RTN","MAGJEX1A",110,0)
 . . E  S $P(ACTION,U,2)=1,ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#2"
"RTN","MAGJEX1A",111,0)
 . E  D  ; Available
"RTN","MAGJEX1A",112,0)
 . . I REQUEST=1 S $P(ACTION,U)=1,$P(ACTION,U,2)=1,$P(ACTION,"|",2)=1,ACTREPLY="1~#"_DAYCASE_" ("_$$PNAM(RADFN)_") locked for update by "_$P(MAGJOB("USER",1),U,3)
"RTN","MAGJEX1A",113,0)
 . . E  I REQUEST=2 S $P(ACTION,U,2)=1,$P(ACTION,"|",2)=1,ACTREPLY="1~Exam #"_DAYCASE_" reserved."
"RTN","MAGJEX1A",114,0)
 . . E  S ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#3"
"RTN","MAGJEX1A",115,0)
 E  I LOCKLEV=1 D  ; Reserved by other (I can Take, Except View/Take/Cancel)
"RTN","MAGJEX1A",116,0)
 . I MYLOCK(1) D  Q
"RTN","MAGJEX1A",117,0)
 . . I REQUEST=1 D  Q
"RTN","MAGJEX1A",118,0)
 . . . I MAGJOB("P32") S $P(ACTION,U)=1,$P(ACTION,"|",2)=1,ACTREPLY="1~#"_DAYCASE_" ("_$$PNAM(RADFN)_") locked for update by "_$P(MAGJOB("USER",1),U,3) ; should be impossible
"RTN","MAGJEX1A",119,0)
 . . . E  S $P(ACTION,U)=1,ACTREPLY="1~Exam #"_$P(MYLOCK(1),U,6)_" already locked; no action taken."
"RTN","MAGJEX1A",120,0)
 . . E  I REQUEST=2 S $P(ACTION,U,1)=1,ACTREPLY="1~Exam #"_$P(MYLOCK(1),U,6)_" already locked; no action taken."
"RTN","MAGJEX1A",121,0)
 . . ; <*> next line Unlocks ME, and preserves Other User's Reserve
"RTN","MAGJEX1A",122,0)
 . . E  I REQUEST=4 S $P(ACTION,U,4)=1,ACTREPLY="1~Exam unlocked; reserved by "_$P(MYLOCK(2),U,4)_"."
"RTN","MAGJEX1A",123,0)
 . . E  S $P(ACTION,U)=1,ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#5; Lock retained." ; preserve lock
"RTN","MAGJEX1A",124,0)
 . I 'MYLOCK D  Q
"RTN","MAGJEX1A",125,0)
 . . I REQUEST=1 D  Q
"RTN","MAGJEX1A",126,0)
 . . . I MAGJOB("P32") S $P(ACTION,"|",2)=1,ACTREPLY="5~Case #"_DAYCASE_" is Reserved by "_$P(MYLOCK(2),U,4)_"."
"RTN","MAGJEX1A",127,0)
 . . . E  S $P(ACTION,"|",2)=1,ACTREPLY="8~Case #"_DAYCASE_" is Reserved by "_$P(MYLOCK(2),U,4)_"."    ; #8=View/Take/Cancel"
"RTN","MAGJEX1A",128,0)
 . . E  I REQUEST=2 S $P(ACTION,"|",2)=1,ACTREPLY="5~Case #"_DAYCASE_" is Reserved by "_$P(MYLOCK(2),U,4)_"."
"RTN","MAGJEX1A",129,0)
 . . E  I REQUEST=5  S $P(ACTION,U)=1,$P(ACTION,U,5)=1,ACTREPLY="1~#"_DAYCASE_" ("_$$PNAM(RADFN)_") taken/locked for update by "_$P(MAGJOB("USER",1),U,3)
"RTN","MAGJEX1A",130,0)
 . . E  S ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#6"
"RTN","MAGJEX1A",131,0)
 E  I LOCKLEV=2 D  ; Locked by another
"RTN","MAGJEX1A",132,0)
 . I MYLOCK(2) D  Q
"RTN","MAGJEX1A",133,0)
 . . S $P(ACTION,U,3)=1,ACTREPLY="5~Case #"_DAYCASE_" is Locked (taken) by "_$P(MYLOCK(1),U,4)_"; reserve cancelled." ; View/Cancel"
"RTN","MAGJEX1A",134,0)
 . I 'MYLOCK D  Q
"RTN","MAGJEX1A",135,0)
 . . I REQUEST=1!(REQUEST=2) S $P(ACTION,"|",2)=1,ACTREPLY="5~Case #"_DAYCASE_" is Locked by "_$P(MYLOCK(1),U,4)_"."  ; View/Cancel"
"RTN","MAGJEX1A",136,0)
 . . E  S ACTREPLY="3~Invalid exam lock request ("_REQUEST_")--#8"
"RTN","MAGJEX1A",137,0)
 ;
"RTN","MAGJEX1A",138,0)
LOCKACT1 D LOCKOUT(RARPT,DAYCASE,LOCKLEV,.MYLOCK,ACTION,.RESULT,LOGDATA)
"RTN","MAGJEX1A",139,0)
 ;
"RTN","MAGJEX1A",140,0)
LOCKACTZ Q
"RTN","MAGJEX1A",141,0)
 ;
"RTN","MAGJEX1A",142,0)
 ;
"RTN","MAGJEX1A",143,0)
LOCKOUT(RARPT,DAYCASE,LOCKLEV,MYLOCK,ACTION,RESULT,LOGDATA) ; Record Locks and Clear Locks, as required
"RTN","MAGJEX1A",144,0)
 ; Precursors are logic and data from tags LOCKIN^magjex1b and LOCKACT
"RTN","MAGJEX1A",145,0)
 S RESULT="" S LOGDATA=$G(LOGDATA,"")
"RTN","MAGJEX1A",146,0)
 Q:'LOCKLEV  ; nothing to do
"RTN","MAGJEX1A",147,0)
 N ILOCK
"RTN","MAGJEX1A",148,0)
 F ILOCK=1,2 D  ; 1:Lock  2:Reserve
"RTN","MAGJEX1A",149,0)
 . I ILOCK=1&(LOCKLEV=1!(LOCKLEV=3))
"RTN","MAGJEX1A",150,0)
 . E  I ILOCK=2&(LOCKLEV=2!(LOCKLEV=3))
"RTN","MAGJEX1A",151,0)
 . E  Q
"RTN","MAGJEX1A",152,0)
 . I MYLOCK(ILOCK) D  ; NEVER change order of the logic below!
"RTN","MAGJEX1A",153,0)
 . . I '$P(ACTION,U,ILOCK) D
"RTN","MAGJEX1A",154,0)
 . . . K ^XTMP("MAGJ","LOCK",RARPT,ILOCK)
"RTN","MAGJEX1A",155,0)
 . . . S $P(RESULT,U,ILOCK)=0
"RTN","MAGJEX1A",156,0)
 . . L -^XTMP("MAGJ","LOCK",RARPT,ILOCK) ; reset lock
"RTN","MAGJEX1A",157,0)
 . ; index by DayCase manages locks for Printset Exams (>1 DayCase for one RARPT)
"RTN","MAGJEX1A",158,0)
 . ; a lock on any printset member exam effectively locks all related exams
"RTN","MAGJEX1A",159,0)
 . I +$P(ACTION,U,ILOCK),'MYLOCK(ILOCK) D
"RTN","MAGJEX1A",160,0)
 . . S ^XTMP("MAGJ","LOCK",RARPT,ILOCK,DAYCASE)=DUZ_U_$J_U_$H_U_$P(MAGJOB("USER",1),U,2,3)_U_"|"_LOGDATA
"RTN","MAGJEX1A",161,0)
 . . S ^XTMP("MAGJ","LOCK",RARPT,ILOCK)=DAYCASE
"RTN","MAGJEX1A",162,0)
 . . S $P(RESULT,U,ILOCK)=1
"RTN","MAGJEX1A",163,0)
 . I '$P(ACTION,U,ILOCK) L -^XTMP("MAGJ","LOCK",RARPT,ILOCK)  ; reset or clear lock
"RTN","MAGJEX1A",164,0)
 Q
"RTN","MAGJEX1A",165,0)
 ;
"RTN","MAGJEX1A",166,0)
END Q  ;
"RTN","MAGJEX2")
0^3^B45090288
"RTN","MAGJEX2",1,0)
MAGJEX2 ;WIRMFO/JHC - Rad. Workstation RPC calls; 9 Sep 2011  4:05 PM
"RTN","MAGJEX2",2,0)
 ;;3.0;IMAGING;**51,18,76,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJEX2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJEX2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJEX2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJEX2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJEX2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJEX2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJEX2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJEX2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJEX2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJEX2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJEX2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJEX2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJEX2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJEX2",17,0)
 ;;
"RTN","MAGJEX2",18,0)
 Q
"RTN","MAGJEX2",19,0)
 ; Subroutines for pre-fetch/ auto-route prior exams' images
"RTN","MAGJEX2",20,0)
 ; Entry Points:
"RTN","MAGJEX2",21,0)
 ;   PRIOR1  -- Pre-Fetch/Auto-route images for other related cases;
"RTN","MAGJEX2",22,0)
 ;    RPC Call: MAGJ PRIOREXAMS
"RTN","MAGJEX2",23,0)
 ;   PREFETCH -- Subroutine call via Protocol trigger
"RTN","MAGJEX2",24,0)
 ;
"RTN","MAGJEX2",25,0)
 Q
"RTN","MAGJEX2",26,0)
ERR N ERR S ERR=$$EC^%ZOSV S MAGGRY(0)="0^Server Program Error: "_ERR
"RTN","MAGJEX2",27,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJEX2",28,0)
 Q:$Q 1  Q
"RTN","MAGJEX2",29,0)
PREFETCH ; Entry point from HL7 processing, to initiate prefetch at
"RTN","MAGJEX2",30,0)
 ; time of radiology "Register Patient for Exam" function
"RTN","MAGJEX2",31,0)
 ; Do not process if the exam is being Canceled (RACANC true)
"RTN","MAGJEX2",32,0)
 ;
"RTN","MAGJEX2",33,0)
 N RET S RET=""
"RTN","MAGJEX2",34,0)
 I '$P($G(^MAG(2006.69,1,0)),U,5) G PREFQ          ; Prefetch disabled
"RTN","MAGJEX2",35,0)
 I '($G(RADFN)&$G(RADTI)&$G(RACNI)&'$G(RACANC)) G PREFQ ; Required vars
"RTN","MAGJEX2",36,0)
 D PRIOR1(.RET,"P"_U_RADFN_U_RADTI_U_RACNI)
"RTN","MAGJEX2",37,0)
PREFQ ;
"RTN","MAGJEX2",38,0)
 Q
"RTN","MAGJEX2",39,0)
 ;
"RTN","MAGJEX2",40,0)
PRIOR1(MAGGRY,DATA) ; review all exams for a patient to find "related" exams
"RTN","MAGJEX2",41,0)
 ; This ep also called as subroutine from routing software (P51)
"RTN","MAGJEX2",42,0)
 ; MAGGRY - return array of exams to PreFetch or Auto-route
"RTN","MAGJEX2",43,0)
 ; DATA:  - input params for the Current Exam
"RTN","MAGJEX2",44,0)
 ;   1) ACTION = P -- Pre-fetch Exams (from Jukebox to Magnetic Disk)
"RTN","MAGJEX2",45,0)
 ;             = A -- Auto-route priors
"RTN","MAGJEX2",46,0)
 ;   2) RADFN  = Case pointers to Rad/Nuc Med Patient file 
"RTN","MAGJEX2",47,0)
 ;   3) RADTI  =  ""        ""         ""          ""
"RTN","MAGJEX2",48,0)
 ;   4) RACNI  =  ""        ""         ""          ""
"RTN","MAGJEX2",49,0)
 ;   5) RARPT  - Case pointer to ^RARPT global
"RTN","MAGJEX2",50,0)
 ;
"RTN","MAGJEX2",51,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJEX2"
"RTN","MAGJEX2",52,0)
 K MAGGRY
"RTN","MAGJEX2",53,0)
 N RADFN,RADTI,RACNI,RARPT,RADATA
"RTN","MAGJEX2",54,0)
 N DAYCASE,DIQUIET,ACTION,CPT,HDR,MAGDFN,MAGDTI,MAGCNI,MAGRET,MAGRACNT
"RTN","MAGJEX2",55,0)
 S ACTION=$P(DATA,U)
"RTN","MAGJEX2",56,0)
 I ACTION="P"!(ACTION="A")
"RTN","MAGJEX2",57,0)
 E  S MAGGRY(0)="0^Invalid Request (Action code="_ACTION_")" G PRIOR1Z
"RTN","MAGJEX2",58,0)
 S MAGDFN=$P(DATA,U,2),MAGDTI=$P(DATA,U,3),MAGCNI=$P(DATA,U,4)
"RTN","MAGJEX2",59,0)
 I MAGDFN,MAGDTI,MAGCNI
"RTN","MAGJEX2",60,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_DATA_")" G PRIOR1Z
"RTN","MAGJEX2",61,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJEX2",62,0)
 N MAGJOB D MAGJOBNC^MAGJUTL3
"RTN","MAGJEX2",63,0)
 S HDR=$S(ACTION="P":"Pre-fetch",ACTION="A":"Auto-route",1:"???")_" Prior Exams for CASE: "
"RTN","MAGJEX2",64,0)
 I '$D(^DPT(MAGDFN,0)) S MAGGRY(0)="0^Request Contains Invalid Patient Pointer ("_MAGDFN_")" G PRIOR1Z
"RTN","MAGJEX2",65,0)
 I $D(^RADPT(MAGDFN,"DT",MAGDTI,"P",MAGCNI))
"RTN","MAGJEX2",66,0)
 E  S MAGGRY(0)="0^Request Contains Invalid Case Pointer ("_MAGCNI_")" G PRIOR1Z
"RTN","MAGJEX2",67,0)
 S MAGRACNT=0
"RTN","MAGJEX2",68,0)
 S MAGGRY(0)="0^Compiling Prior Radiology Exams"
"RTN","MAGJEX2",69,0)
 D GETEXAM2^MAGJUTL1(MAGDFN,MAGDTI,MAGCNI,"",.MAGRET) ; Current Exam only
"RTN","MAGJEX2",70,0)
 S RADFN=MAGDFN,RADTI=MAGDTI,RACNI=MAGCNI
"RTN","MAGJEX2",71,0)
 I 'MAGRET S MAGGRY(0)="0^Current Case is Not Accessible" G PRIOR1Z
"RTN","MAGJEX2",72,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)) S DAYCASE=$P(RADATA,U,12) D SVMAG2A
"RTN","MAGJEX2",73,0)
 I 'MAGGRY(0) S MAGGRY(0)="0^Current Case either has no CPT code, or has no rules defined for its CPT code." G PRIOR1Z
"RTN","MAGJEX2",74,0)
 S HDR=HDR_DAYCASE
"RTN","MAGJEX2",75,0)
 D SRCH(MAGDFN)  ;  Search prior exams for this patient
"RTN","MAGJEX2",76,0)
PRIOR1Z ;
"RTN","MAGJEX2",77,0)
 I 'MAGGRY(0) S:(MAGGRY(0)["Compiling") MAGGRY(0)="0^No Exams Found"
"RTN","MAGJEX2",78,0)
 E  I +MAGGRY(0)=1 S MAGGRY(0)="0^No Prior Exams Found" K MAGGRY(1)
"RTN","MAGJEX2",79,0)
 E  D SVMAG2B
"RTN","MAGJEX2",80,0)
 K ^TMP($J,"MAGRAEX"),^("RAE1")
"RTN","MAGJEX2",81,0)
 Q
"RTN","MAGJEX2",82,0)
 ;
"RTN","MAGJEX2",83,0)
SRCH(RADFN) ; Traverse all exams for a patient, up to limits of age & total
"RTN","MAGJEX2",84,0)
 ; numbers of exams to consider
"RTN","MAGJEX2",85,0)
 N BEGDT,LIMYRS,LIMEXAMS
"RTN","MAGJEX2",86,0)
 S LIMYRS=30,LIMEXAMS=100 ; default limit # Exams
"RTN","MAGJEX2",87,0)
 S BEGDT=($E(DT,1,3)-LIMYRS)_$E(DT,4,7)
"RTN","MAGJEX2",88,0)
 I BEGDT<2950101 S BEGDT=2950101 ; 2 yrs prior to earliest VistaPACS
"RTN","MAGJEX2",89,0)
 S MAGRACNT=1 D GETEXAM3^MAGJUTL1(RADFN,BEGDT,"",.MAGRACNT,.MAGRET,"",LIMEXAMS)
"RTN","MAGJEX2",90,0)
 I MAGRET N IDAT S IDAT=1 D
"RTN","MAGJEX2",91,0)
 . F  S IDAT=$O(^TMP($J,"MAGRAEX",IDAT)) Q:'IDAT  S RADATA=^(IDAT,1) D
"RTN","MAGJEX2",92,0)
 . . S RADTI=$P(RADATA,U,2),RACNI=$P(RADATA,U,3)
"RTN","MAGJEX2",93,0)
 . . I RADTI=MAGDTI&(RACNI=MAGCNI) Q  ; skip current case
"RTN","MAGJEX2",94,0)
 . . D SVMAG2A
"RTN","MAGJEX2",95,0)
 Q
"RTN","MAGJEX2",96,0)
 ;
"RTN","MAGJEX2",97,0)
SVMAG2A ; 2A and 2B used by subroutine at tag PRIOR1
"RTN","MAGJEX2",98,0)
 ; Find all the patient's exams whose CPT codes are related to the
"RTN","MAGJEX2",99,0)
 ; Current exam's CPT code, according to dictionary 2006.65
"RTN","MAGJEX2",100,0)
 N RAIMGTYP,X
"RTN","MAGJEX2",101,0)
 N CPT,CPT3,CPT4,CPT5,CURCPTX,CURCPTS,HIT,MAGMATCH,MAGDTH
"RTN","MAGJEX2",102,0)
 S RARPT=+$P(RADATA,U,10)
"RTN","MAGJEX2",103,0)
 I MAGGRY(0) Q:'$P(MAGGRY(1),U)           ;  Cur Case CPT not in map file
"RTN","MAGJEX2",104,0)
 I  Q:(ACTION="P")&'$D(^RARPT(RARPT,2005))  ; nothing to pre-fetch
"RTN","MAGJEX2",105,0)
 I  Q:$P(RADATA,U,15)<2          ; Cancel or Waiting
"RTN","MAGJEX2",106,0)
 ;   Note: if no images, may still want to do Auto-Disp to get Report;
"RTN","MAGJEX2",107,0)
 ;      also, Current Case should still proceed
"RTN","MAGJEX2",108,0)
 S CPT=$P(RADATA,U,17)
"RTN","MAGJEX2",109,0)
 Q:'CPT  ;  algorithm REQUIRES CPT codes be used
"RTN","MAGJEX2",110,0)
 S CPT5=CPT,CPT4=$E(CPT,1,4),CPT3=$E(CPT,1,3)
"RTN","MAGJEX2",111,0)
 S MAGMATCH="^^"
"RTN","MAGJEX2",112,0)
 I 'MAGGRY(0) D  Q:'MAGMATCH  ; No rules defined for Cur. Case's CPT
"RTN","MAGJEX2",113,0)
 . S Y=""
"RTN","MAGJEX2",114,0)
 . ;  Order of CPT5/4/3 is important for the algorithm, which
"RTN","MAGJEX2",115,0)
 . ;  uses the 1st rule found at the LOWEST level of detail defined
"RTN","MAGJEX2",116,0)
 . F X=CPT5,CPT4,CPT3 I $D(^MAG(2006.65,"B",X)) S Y=Y_$S(Y:",",1:"")_X S $P(MAGMATCH,U)=Y
"RTN","MAGJEX2",117,0)
 I CPT,MAGGRY(0) D
"RTN","MAGJEX2",118,0)
 . ; curcpts has the cpt5/4/3 list generated above for Cur. Case CPT's
"RTN","MAGJEX2",119,0)
 . S HIT=0,CURCPTS=$P(MAGGRY(1),U)
"RTN","MAGJEX2",120,0)
 . F  Q:CURCPTS=""  S CURCPTX=$O(^MAG(2006.65,"B",$P(CURCPTS,","),"")) S CURCPTS=$P(CURCPTS,",",2,9) I CURCPTX]"" D  Q:HIT  ; 1st hit only
"RTN","MAGJEX2",121,0)
 . . ;  This algorithm checks from lowest detail to most general, and acts
"RTN","MAGJEX2",122,0)
 . . ;  on the information found at the FIRST Hit only
"RTN","MAGJEX2",123,0)
 . . F CPT="CPT5","CPT4","CPT3" S CPT=@CPT I CPT]"",$D(^MAG(2006.65,CURCPTX,1,"B",CPT)) S X=$O(^(CPT,"")) D  S HIT=1 Q  ;1st hit only
"RTN","MAGJEX2",124,0)
 . . . S X=^MAG(2006.65,CURCPTX,1,X,0) S Y=$S(ACTION="A":2,1:5),X=$P(X,U,Y,Y+2)
"RTN","MAGJEX2",125,0)
 . . . I +X S MAGMATCH=CPT F I=2,3 S $P(MAGMATCH,U,I)=$P(X,U,I)
"RTN","MAGJEX2",126,0)
 ;         sample of logic file:
"RTN","MAGJEX2",127,0)
 ; ^MAG(2006.65,1,0) = 730
"RTN","MAGJEX2",128,0)
 ; ^MAG(2006.65,1,1,0) = ^12000011.01^2^2
"RTN","MAGJEX2",129,0)
 ; ^MAG(2006.65,1,1,1,0) = 730^1^40^6^1^120^10
"RTN","MAGJEX2",130,0)
 ; ^MAG(2006.65,1,1,2,0) = 732^1^40^2^1^120^4
"RTN","MAGJEX2",131,0)
 ; ^MAG(2006.65,1,1,"B",730,1) =
"RTN","MAGJEX2",132,0)
 ; ^MAG(2006.65,1,1,"B",732,2) =
"RTN","MAGJEX2",133,0)
 ; ^MAG(2006.65,"B",730,1) =
"RTN","MAGJEX2",134,0)
 ;
"RTN","MAGJEX2",135,0)
 Q:'MAGMATCH
"RTN","MAGJEX2",136,0)
 ; 1  RADFN   RADTI    RACNI   RANME   RASSN    <-- from GETEXAM
"RTN","MAGJEX2",137,0)
 ; 6  RADATE  RADTE    RACN    RAPRC   RARPT
"RTN","MAGJEX2",138,0)
 ; 11 RAST    DAYCASE  RAELOC  RASTP   RASTORD
"RTN","MAGJEX2",139,0)
 ; 16 RADTPRT RACPT    RAIMGTYP
"RTN","MAGJEX2",140,0)
 S MAGDTH=$$FMTH^XLFDT($P(RADATA,U,7),1)
"RTN","MAGJEX2",141,0)
 S X=$P(RADATA,U,18)
"RTN","MAGJEX2",142,0)
 S RAIMGTYP=$S(X]"":$O(^RA(79.2,"C",X,"")),1:X)
"RTN","MAGJEX2",143,0)
 S Y=MAGGRY(0)+1,$P(MAGGRY(0),U)=Y,MAGGRY(Y)=MAGMATCH_U_MAGDTH_U_U_$P(RADATA,U,9)_U_RAIMGTYP_U_RADFN_U_RADTI_U_RACNI_U_RARPT_U_$P(RADATA,U,12)_U_$P(RADATA,U,11)
"RTN","MAGJEX2",144,0)
 Q
"RTN","MAGJEX2",145,0)
 ;
"RTN","MAGJEX2",146,0)
SVMAG2B ; For exams whose CPTs match, select a subset that are within defined
"RTN","MAGJEX2",147,0)
 ; limits with respect to time interval & maximum # exams to retrieve
"RTN","MAGJEX2",148,0)
 ; Return MAGGRY(0) =  count ^ message
"RTN","MAGJEX2",149,0)
 ;        MAGGRY(1:N) = "M08" | RADFN ^ RADTI ^ RACNI ^ RARPT
"RTN","MAGJEX2",150,0)
 N CPT,CT,CURDAT,ICPT,IREC,GO
"RTN","MAGJEX2",151,0)
 S CURDAT=$P(MAGGRY(1),U,4)
"RTN","MAGJEX2",152,0)
 F IREC=2:1:MAGGRY(0) S X=MAGGRY(IREC),CPT=+X D  K MAGGRY(IREC)
"RTN","MAGJEX2",153,0)
 . I $P(X,U,2) S Y=CURDAT-$P(X,U,4) S:Y<0 Y=-Y I Y>$P(X,U,2) Q  ;too old
"RTN","MAGJEX2",154,0)
 . S Y=$G(GO(CPT))+1 I CPT,(Y>$P(X,U,3)) Q  ; already have enough cases
"RTN","MAGJEX2",155,0)
 . S GO(CPT)=Y,GO(CPT,Y)=X
"RTN","MAGJEX2",156,0)
 K MAGGRY
"RTN","MAGJEX2",157,0)
 I $D(GO) S CT=0,CPT="" D
"RTN","MAGJEX2",158,0)
 . F  S CPT=$O(GO(CPT)) Q:CPT=""  F ICPT=1:1:GO(CPT) D
"RTN","MAGJEX2",159,0)
 . . S CT=CT+1,X=GO(CPT,ICPT),RARPT=$P(X,U,11)
"RTN","MAGJEX2",160,0)
 . . S MAGGRY(CT)="M08^"_CPT_"|"_$P(X,U,8,11)
"RTN","MAGJEX2",161,0)
 . . I ACTION="P"!(ACTION="A") S Y=$$JBFETCH^MAGJUTL2(RARPT)  ; fetch from jukebox
"RTN","MAGJEX2",162,0)
 . S MAGGRY(0)=CT_"^"_HDR
"RTN","MAGJEX2",163,0)
 E  S MAGGRY(0)="0^No Exams Found for "_HDR
"RTN","MAGJEX2",164,0)
 Q
"RTN","MAGJEX2",165,0)
 ;
"RTN","MAGJEX2",166,0)
END ;
"RTN","MAGJLS3")
0^4^B73486963
"RTN","MAGJLS3",1,0)
MAGJLS3 ;WIRMFO/JHC - VistARad RPC calls ; 2 Jan 2012  11:46 AM
"RTN","MAGJLS3",2,0)
 ;;3.0;IMAGING;**16,22,18,101,90,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJLS3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJLS3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJLS3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJLS3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJLS3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJLS3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJLS3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJLS3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJLS3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJLS3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJLS3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJLS3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJLS3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJLS3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJLS3",17,0)
 ;;
"RTN","MAGJLS3",18,0)
 Q
"RTN","MAGJLS3",19,0)
 ; EPs:
"RTN","MAGJLS3",20,0)
 ; BLDACTV
"RTN","MAGJLS3",21,0)
 ;
"RTN","MAGJLS3",22,0)
BLDACTV(MAGGRY,DATA,MAGLST) ; get subset of Active Exams; called from MAGJLS2
"RTN","MAGJLS3",23,0)
 ;MAGGRY - Indirect Global ref of return array
"RTN","MAGJLS3",24,0)
 ;DATA: Listyp ^ Imaging Types
"RTN","MAGJLS3",25,0)
 ;Listyp = U  -- UNREAD Exams (Status Category=E)
"RTN","MAGJLS3",26,0)
 ;   = R  -- RECENT (Sts Cat's D & T)
"RTN","MAGJLS3",27,0)
 ;   = A  -- ALL Active (Cat's E, D, & T)
"RTN","MAGJLS3",28,0)
 ;   = P  -- PENDING (Cat W)
"RTN","MAGJLS3",29,0)
 ;   = N  -- Newly Interpreted Exams (No Cat.-Internal use only)
"RTN","MAGJLS3",30,0)
 ;ImgTypes = List of Imaging Types to process, or "ALL" for all
"RTN","MAGJLS3",31,0)
 ; MAGLST = $NA ref to return global; references to it use subscript indirection
"RTN","MAGJLS3",32,0)
 ; MAGLST optional: input to specify return global to use
"RTN","MAGJLS3",33,0)
 ; 
"RTN","MAGJLS3",34,0)
 ;* This subrtn can receive U/R/A/P/N (LSTREQ)-- ^_delim list of ImgTypes (IMTYPS)
"RTN","MAGJLS3",35,0)
 N RADFN,RADTI,RACNI,REMX
"RTN","MAGJLS3",36,0)
 N HDR,HDRLST,MAGIMGTY,MAGRACNT,MAGRET,LSTREQ,LISTYP,LISCAT,IMTYPS
"RTN","MAGJLS3",37,0)
 N REPLY,STAT,TYP,SORTMAG,DIQUIET,STATCHK,LASTDT,IMGSONLY,URGORD,REMONLY
"RTN","MAGJLS3",38,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJLS3",39,0)
 I $G(MAGLST)="" S MAGLST=$NA(^TMP($J,"MAGJACTIVE")) ; default loc'n if not passed in
"RTN","MAGJLS3",40,0)
 K ^TMP($J,"MAGRAEX"),@MAGLST
"RTN","MAGJLS3",41,0)
 S LSTREQ=$P(DATA,U),IMTYPS=$P(DATA,U,2,99)
"RTN","MAGJLS3",42,0)
 I LSTREQ="U"!(LSTREQ="R")!(LSTREQ="A")!(LSTREQ="P")!(LSTREQ="N")!(LSTREQ="H")
"RTN","MAGJLS3",43,0)
 E  S REPLY="0^4~Invalid Request (List Type="_LSTREQ_")" G BLDACTVZ
"RTN","MAGJLS3",44,0)
 S MAGRACNT=0
"RTN","MAGJLS3",45,0)
 S X=$G(^MAG(2006.69,1,0)),IMGSONLY=+$P(X,U,7),REMX=+$P(X,U,10) ; show only exams w/ images?
"RTN","MAGJLS3",46,0)
 S REMONLY=0
"RTN","MAGJLS3",47,0)
 I $G(MAGJOB("REMOTE")) D  ; ;show remote cache only?
"RTN","MAGJLS3",48,0)
 . Q:(LSTREQ="H")  S REMONLY=+$G(MAGJOB("REMOTESCREEN"))
"RTN","MAGJLS3",49,0)
 S X=$G(^MAG(2006.69,1,1)),URGORD=$P(X,U)
"RTN","MAGJLS3",50,0)
 S:URGORD="" URGORD="S,U,P,R" S URGORD=$TR(URGORD,",") ; "Priority" sort
"RTN","MAGJLS3",51,0)
 S HDR=$S(LSTREQ="U":"UNREAD",LSTREQ="R":"RECENT",LSTREQ="P":"PENDING",LSTREQ="A":"UNREAD and RECENT",LSTREQ="N":"NEWLY INTERP",LSTREQ="H":"HISTORY",1:"")_" Exams"_" for IMAGING TYPES: "
"RTN","MAGJLS3",52,0)
 S LISTYP=$S(LSTREQ="U":"E",LSTREQ="R":"D^T",LSTREQ="A":"E^D^T",LSTREQ="P":"W",LSTREQ="N":"",LSTREQ="H":"",1:"E")
"RTN","MAGJLS3",53,0)
 S REPLY="0^4~Compiling list of Radiology Exams (ACTIVE)."
"RTN","MAGJLS3",54,0)
 I $G(BKGPROC),(LSTREQ="R") K ^TMP($J,"NEWINT") S ^TMP($J,"NEWINT")=+$G(^XTMP("MAGJ2","RECENT",0))
"RTN","MAGJLS3",55,0)
 I LSTREQ="N" D BLDACT2 G BLDACTVZ
"RTN","MAGJLS3",56,0)
 I LSTREQ="H" D HISTBLD^MAGJLS3A G BLDACTVZ
"RTN","MAGJLS3",57,0)
 D BLDACT1
"RTN","MAGJLS3",58,0)
BLDACTVZ ;
"RTN","MAGJLS3",59,0)
 I 'MAGRACNT S:(REPLY["Compiling") REPLY="0^2~No Exams Found"
"RTN","MAGJLS3",60,0)
 E  D
"RTN","MAGJLS3",61,0)
 . I IMTYPS="ALL" S HDR=HDR_" ALL"
"RTN","MAGJLS3",62,0)
 . E  S Y="" F I=0:1 S Y=$O(HDRLST(Y)) Q:Y=""  S HDR=HDR_$S('I:"",1:", ")_Y
"RTN","MAGJLS3",63,0)
 . S REPLY=MAGRACNT_U_"1~"_HDR
"RTN","MAGJLS3",64,0)
 S @MAGLST@(0,1)=REPLY,^(2)=""
"RTN","MAGJLS3",65,0)
 K ^TMP($J,"MAGRAEX"),^("RAE1")
"RTN","MAGJLS3",66,0)
 S MAGGRY=MAGLST
"RTN","MAGJLS3",67,0)
 Q
"RTN","MAGJLS3",68,0)
BLDACT1 ; Compile exams by Status codes
"RTN","MAGJLS3",69,0)
 D BLDSTAT^MAGJLS3A
"RTN","MAGJLS3",70,0)
 F  S LISCAT=$P(LISTYP,U),LISTYP=$P(LISTYP,U,2,9) Q:LISCAT=""  D
"RTN","MAGJLS3",71,0)
 . I IMTYPS="ALL" S TYP="" D  Q
"RTN","MAGJLS3",72,0)
 . . F  S TYP=$O(STAT(LISCAT,TYP)) Q:TYP=""  D IMGTYP(LISCAT,TYP)
"RTN","MAGJLS3",73,0)
 . E  I +IMTYPS D IMGTYLST(LISCAT,IMTYPS) Q
"RTN","MAGJLS3",74,0)
 . E  S REPLY="0^4~Invalid Imaging Type"
"RTN","MAGJLS3",75,0)
 Q
"RTN","MAGJLS3",76,0)
BLDACT2 ; Add recently interpreted exams to the "Recent" compile data
"RTN","MAGJLS3",77,0)
 ; 1st, compile these into their own list
"RTN","MAGJLS3",78,0)
 N CNT,INDX,RAST,STATCHK,RECLIST,REC,X1,X2
"RTN","MAGJLS3",79,0)
 S X=$G(^XTMP("MAGJ2","RECENT",0)),INDX=+$P(X,U,2)
"RTN","MAGJLS3",80,0)
 F  S INDX=$O(^XTMP("MAGJ2","RECENT",INDX)) Q:'INDX  S X=^(INDX) D
"RTN","MAGJLS3",81,0)
 . S RADFN=$P(X,U),RADTI=$P(X,U,2),RACNI=$P(X,U,3),(RAST,STATCHK)=$P(X,U,4)
"RTN","MAGJLS3",82,0)
 . D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,0,.MAGRET)
"RTN","MAGJLS3",83,0)
 . I MAGRET D SVMAG2A()
"RTN","MAGJLS3",84,0)
 . S $P(^XTMP("MAGJ2","RECENT",0),U,2)=INDX
"RTN","MAGJLS3",85,0)
 ; copy the above records to the "RECENT" curlist
"RTN","MAGJLS3",86,0)
 S RECLIST=+$$CURLIST^MAGJLS2("LS9992")
"RTN","MAGJLS3",87,0)
 I 'RECLIST S RECLIST=+$G(^XTMP("MAGJ2","BKGND","LS9992",0))
"RTN","MAGJLS3",88,0)
 I 'RECLIST Q  ; Recent list not being compiled--skip it!
"RTN","MAGJLS3",89,0)
 F CNT=1:1:MAGRACNT S X1=@MAGLST@(CNT,1),X2=^(2) D  ; MAGLST described at BLDACTV
"RTN","MAGJLS3",90,0)
 . S REC=^XTMP("MAGJ2","LS9992",RECLIST,0,1)+1
"RTN","MAGJLS3",91,0)
 . S ^XTMP("MAGJ2","LS9992",RECLIST,REC,1)=X1,^(2)=X2
"RTN","MAGJLS3",92,0)
 . S $P(^XTMP("MAGJ2","LS9992",RECLIST,0,1),U)=REC
"RTN","MAGJLS3",93,0)
 Q
"RTN","MAGJLS3",94,0)
 ;
"RTN","MAGJLS3",95,0)
SVMAG2A(PIPE3) ;used by subroutine at tag BLDACTV
"RTN","MAGJLS3",96,0)
 ; load return array @MAGLST@(n, ...
"RTN","MAGJLS3",97,0)
 ; Note: ^TMP("MAGRAEX" is set by the subroutine Getexam2^Magjutl1
"RTN","MAGJLS3",98,0)
 ; PIPE3 optional; contains data that is passed through the system; e.g.
"RTN","MAGJLS3",99,0)
 ;   the HISTORY List receives data from the client which is augmented
"RTN","MAGJLS3",100,0)
 ;   and passed back to the client
"RTN","MAGJLS3",101,0)
 ;Set outside this subrtn:STATCHK,RAST,LSTREQ,REMONLY,BKGPROC,MAGRACNT,MAGLST
"RTN","MAGJLS3",102,0)
 ;
"RTN","MAGJLS3",103,0)
 N MAGDT,SORTDT,IMGCNT,ONL,XX,XX2,Y,RARPT,KEY,RASTCAT,Y2
"RTN","MAGJLS3",104,0)
 N REMOTE,MODALITY,DAYCASE,EXCAT,ORD,URG,URG1,PREOP,LASTSSN,CURPRIO,STATUS
"RTN","MAGJLS3",105,0)
 N REMOTE2,LRFLAG,TECH,REGDT,REGDTSRT,PTID,STATPRIORITY
"RTN","MAGJLS3",106,0)
 S PIPE3=$G(PIPE3,"")
"RTN","MAGJLS3",107,0)
 S URG="",PREOP=""   ; <*> Need below until RAO7PC1A returns URG
"RTN","MAGJLS3",108,0)
 S X=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","MAGJLS3",109,0)
 S ORD=$P(X,U,11)
"RTN","MAGJLS3",110,0)
 I ORD S Y=$G(^RAO(75.1,ORD,0)),URG=$P(Y,U,6),PREOP=$P(Y,U,12)
"RTN","MAGJLS3",111,0)
 S XX=$G(^TMP($J,"MAGRAEX",1,1)),XX2=$G(^(2))
"RTN","MAGJLS3",112,0)
 I $G(STATCHK),(STATCHK=$P(XX,U,11))
"RTN","MAGJLS3",113,0)
 E  I LSTREQ="H" S RAST=$P(XX,U,11)
"RTN","MAGJLS3",114,0)
 E  Q       ;  index '= stored status
"RTN","MAGJLS3",115,0)
 S RARPT=$P(XX,U,10),STATPRIORITY="" ; STATPRIORITY always null from the compiler (place-holder only)
"RTN","MAGJLS3",116,0)
 D IMGINFO^MAGJUTL2(RARPT,.Y)
"RTN","MAGJLS3",117,0)
 S IMGCNT=$P(Y,U),ONL=$P(Y,U,2),MAGDT=$P(Y,U,3),REMOTE=$P(Y,U,4),MODALITY=$P(Y,U,5),PLACE=$P(Y,U,6),KEY=$P(Y,U,7)
"RTN","MAGJLS3",118,0)
 S REMOTE2=REMOTE
"RTN","MAGJLS3",119,0)
 I IMGSONLY,'IMGCNT,'(LSTREQ="P") Q  ;only list exams w/ imgs, except PENDING
"RTN","MAGJLS3",120,0)
 I REMONLY,'REMOTE,'$G(BKGPROC) Q  ; only list remote exams
"RTN","MAGJLS3",121,0)
 S:PLACE PLACE=$P($G(^MAG(2006.1,PLACE,0)),U,9)
"RTN","MAGJLS3",122,0)
 I MAGDT="" S MAGDT=$P(XX,U,7)
"RTN","MAGJLS3",123,0)
 S SORTDT=MAGDT
"RTN","MAGJLS3",124,0)
 S MAGDT=$$FMTE^XLFDT(MAGDT,"5Z")
"RTN","MAGJLS3",125,0)
 S REGDTSRT=$P(XX,U,7),REGDT=$$FMTE^XLFDT(REGDTSRT,"5Z")
"RTN","MAGJLS3",126,0)
 ; XX 1 RADFN   RADTI    RACNI   RANME    RASSN  <-- from GETEXAM
"RTN","MAGJLS3",127,0)
 ;    6 RADATE  RADTE    RACN    RAPRC     RARPT
"RTN","MAGJLS3",128,0)
 ;   11 RAST    DAYCASE  RAELOC   RASTP     RASTORD
"RTN","MAGJLS3",129,0)
 ;   16 RADTPRT RACPT    IMTYPABB
"RTN","MAGJLS3",130,0)
 ;XX2 1 REQLOCABB  REQLOCNM  RdRIST  COMPLIC  RAD_DIV
"RTN","MAGJLS3",131,0)
 ;    6 SITE_CODE  RISTISME  PROCMOD  REQLOCT  REQWARD
"RTN","MAGJLS3",132,0)
 ;   11 RASTCAT   LRFLAG   TECH
"RTN","MAGJLS3",133,0)
 S:'URG URG=9  ;  request urgency default to Routine
"RTN","MAGJLS3",134,0)
 I URG=9,(PREOP]"") S URG=8  ; dummy val for Pre-Op
"RTN","MAGJLS3",135,0)
 S URG1=$S(URG=1:"Stat",URG=2:"Urg",URG=8:"PreOp",1:"Rout"),X=$E(URG1),URG1=$F(URGORD,X)-1_"-"_URG1
"RTN","MAGJLS3",136,0)
 I PREOP]"",(URG'=8) S URG1=URG1_"/Pre" ; show PreOp & another priority
"RTN","MAGJLS3",137,0)
 S SORTMAG=$S(+IMGCNT:"A",1:"B") ; sort index: has/not images
"RTN","MAGJLS3",138,0)
 S DAYCASE=$P(XX,U,12),RASTORD=$P(XX,U,15),STATUS=$P(XX,U,11),RASTCAT=$P(XX2,U,11),LRFLAG=$P(XX2,U,12),TECH=$P(XX2,U,13)
"RTN","MAGJLS3",139,0)
 S EXCAT="",CURPRIO=0
"RTN","MAGJLS3",140,0)
 I STATUS]"" D
"RTN","MAGJLS3",141,0)
 . S EXCAT=RASTCAT
"RTN","MAGJLS3",142,0)
 . I RASTORD<2!(EXCAT="W")!('IMGCNT) S CURPRIO=0 ; Cancelled/Waiting/No images: Ignore exam
"RTN","MAGJLS3",143,0)
 . E  I EXCAT="E" S CURPRIO=1  ; Examined="Current" exam
"RTN","MAGJLS3",144,0)
 . E  S CURPRIO=2  ; must be a "prior" exam
"RTN","MAGJLS3",145,0)
 . I CURPRIO,'(ONL="Y") S CURPRIO=3 ; images on jukebox
"RTN","MAGJLS3",146,0)
 . I RASTORD=9 S EXCAT="C" ; Complete
"RTN","MAGJLS3",147,0)
 . E  I EXCAT="D"!(EXCAT="T") S EXCAT="I" ; just display one value meaning Interpreted
"RTN","MAGJLS3",148,0)
 ; PTID is Initial w/ last 4 of SSN for VA (Z9999), or MRN for IHS (1.N number)
"RTN","MAGJLS3",149,0)
 ; LASTSSN is either last 4 digits of SSN, or last 4 of whatever number came in, or nil
"RTN","MAGJLS3",150,0)
 S X=$P(XX,U,5) ; SSN in VA, MRN in IHS
"RTN","MAGJLS3",151,0)
 I X?3N1"-"2N1"-"4N S LASTSSN=$P(X,"-",3),PTID=$E($P(XX,U,4))_LASTSSN
"RTN","MAGJLS3",152,0)
 E  S PTID=X D
"RTN","MAGJLS3",153,0)
 . I X?1N.N S X=10000+X,T=$L(X),LASTSSN=$E(X,T-3,T)
"RTN","MAGJLS3",154,0)
 . E  S LASTSSN=""
"RTN","MAGJLS3",155,0)
 ; build output string in Y & Y2
"RTN","MAGJLS3",156,0)
 S Y=DAYCASE_U_U_$P(XX,U,4)_U_PTID
"RTN","MAGJLS3",157,0)
 S Y=Y_U_URG1_U_$E($P(XX,U,9),1,30)_U_MAGDT_U_$E($P(XX,U,14),1,10)_U_IMGCNT
"RTN","MAGJLS3",158,0)
 S Y=Y_U_ONL_U_$E($P(XX,U,13),1,15)_U_REMOTE
"RTN","MAGJLS3",159,0)
 S Y=Y_U_SORTMAG_U_SORTDT_U_MODALITY_U_RAST_U_$$RAIMTYP(RAST)
"RTN","MAGJLS3",160,0)
 S RISTISME=$P(XX2,U,7)
"RTN","MAGJLS3",161,0)
 S Y2=$P(XX2,U,1,3)_U_LASTSSN_U_$P(XX2,U,5)_U_PLACE_U_RISTISME_U_$P(XX2,U,8,9)_U_$P(XX,U,17)_U_$P(XX2,U,10)
"RTN","MAGJLS3",162,0)
 ; add 4 "place holders" for fields that are only in the History list
"RTN","MAGJLS3",163,0)
 S Y2=Y2_U_U_U_U
"RTN","MAGJLS3",164,0)
 S Y2=Y2_U_TECH_U_REGDT_U_REGDTSRT ; p101 adds 3 new fields
"RTN","MAGJLS3",165,0)
 S Y2=Y2_U_"|"_$P(XX,U,1,3)_U_RARPT
"RTN","MAGJLS3",166,0)
 S Y2=Y2_"|"_PIPE3_"|"_EXCAT_"^^^"_MODALITY_U_$P(XX,U,17)_U_CURPRIO_U_RARPT_U_KEY_U_REMOTE2_U_LRFLAG_U_STATPRIORITY
"RTN","MAGJLS3",167,0)
 ; * Note: Keep Pipe piece 4, above, in sync with lstout^magjls2b & magjlst1 *
"RTN","MAGJLS3",168,0)
 S MAGRACNT=MAGRACNT+1
"RTN","MAGJLS3",169,0)
 S @MAGLST@(MAGRACNT,1)=Y,^(2)=Y2  ; save output for one exam
"RTN","MAGJLS3",170,0)
 I $G(BKGPROC),(LSTREQ="R") S ^TMP($J,"NEWINT",$P(XX,U,1,3))=""
"RTN","MAGJLS3",171,0)
 Q
"RTN","MAGJLS3",172,0)
 ;
"RTN","MAGJLS3",173,0)
RAIMTYP(RAST) ; return Imaging Type Abbrev for Status Code
"RTN","MAGJLS3",174,0)
 N X S X="" I RAST]"" D
"RTN","MAGJLS3",175,0)
 . S X=$G(RAIMTYP(RAST)) Q:X]""
"RTN","MAGJLS3",176,0)
 . S X=$P($G(^RA(72,RAST,0)),U,7)
"RTN","MAGJLS3",177,0)
 . I X S X=$P($G(^RA(79.2,X,0)),U,3)_"~"_X  ; abb~ien
"RTN","MAGJLS3",178,0)
 . S RAIMTYP(RAST)=X   ; save for future use
"RTN","MAGJLS3",179,0)
 Q X
"RTN","MAGJLS3",180,0)
 ;
"RTN","MAGJLS3",181,0)
IMGTYLST(LISCAT,LST) ; get exams for list of image types for input LISCAT
"RTN","MAGJLS3",182,0)
 N TYP
"RTN","MAGJLS3",183,0)
 F  Q:'(LST?1.N.E)  S TYP=+$P(LST,U),LST=$P(LST,U,2,99) D:TYP IMGTYP(LISCAT,TYP)
"RTN","MAGJLS3",184,0)
 Q
"RTN","MAGJLS3",185,0)
 ;
"RTN","MAGJLS3",186,0)
IMGTYP(LISCAT,IMGTY) ; process statuses for one Image Type for LISCAT
"RTN","MAGJLS3",187,0)
 I '$D(^RA(79.2,IMGTY,0)) S REPLY="0^4~Invalid Imaging Type" Q
"RTN","MAGJLS3",188,0)
 N LST
"RTN","MAGJLS3",189,0)
 I $D(STAT)<10 D BLDSTAT^MAGJLS3A
"RTN","MAGJLS3",190,0)
 S (STAT,LST)=""
"RTN","MAGJLS3",191,0)
 S LASTDT=$P(STAT(LISCAT),U)
"RTN","MAGJLS3",192,0)
 F  S STAT=$O(STAT(LISCAT,IMGTY,STAT)) Q:STAT=""  S LST=LST_$S(LST="":"",1:U)_STAT,HDRLST(STAT(LISCAT,IMGTY))=""
"RTN","MAGJLS3",193,0)
 I LST]"" D STATLST(LST)
"RTN","MAGJLS3",194,0)
 Q
"RTN","MAGJLS3",195,0)
 ;
"RTN","MAGJLS3",196,0)
STATLST(LST) ; get exams for a list of status codes
"RTN","MAGJLS3",197,0)
 F  Q:'(LST?1.N.E)  S STAT=+$P(LST,U),LST=$P(LST,U,2,99) D:STAT STAT(STAT)
"RTN","MAGJLS3",198,0)
 Q
"RTN","MAGJLS3",199,0)
 ;
"RTN","MAGJLS3",200,0)
STAT(RAST) ; get exams for one status code
"RTN","MAGJLS3",201,0)
 ; uses File #70) "AS" index of active exams
"RTN","MAGJLS3",202,0)
 ;
"RTN","MAGJLS3",203,0)
 N RASTP
"RTN","MAGJLS3",204,0)
 I $D(^RA(72,RAST)) S RASTP=$P(^(RAST,0),U)
"RTN","MAGJLS3",205,0)
 E  S REPLY="0^4~Invalid Exam Status" Q
"RTN","MAGJLS3",206,0)
 I '$D(^RADPT("AS",RAST)) S REPLY="0^2~No exams on file with Exam Status "_RASTP Q
"RTN","MAGJLS3",207,0)
 S RADFN=0,STATCHK=RAST
"RTN","MAGJLS3",208,0)
 F  S RADFN=$O(^RADPT("AS",RAST,RADFN)) Q:RADFN'>0  S RADTI=0 D
"RTN","MAGJLS3",209,0)
 . F  S RADTI=$O(^RADPT("AS",RAST,RADFN,RADTI)) Q:RADTI'>0!(RADTI>LASTDT)  S RACNI=0 D
"RTN","MAGJLS3",210,0)
 . . F  S RACNI=$O(^RADPT("AS",RAST,RADFN,RADTI,RACNI)) Q:RACNI'>0  D
"RTN","MAGJLS3",211,0)
 . . . D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,0,.MAGRET)
"RTN","MAGJLS3",212,0)
 . . . Q:'MAGRET  ; no exam returned
"RTN","MAGJLS3",213,0)
 . . . D SVMAG2A()
"RTN","MAGJLS3",214,0)
 Q
"RTN","MAGJLS3",215,0)
 ;
"RTN","MAGJLS3",216,0)
END Q  ; 
"RTN","MAGJLST1")
0^5^B51607794
"RTN","MAGJLST1",1,0)
MAGJLST1 ;WIRMFO/JHC - VistARad RPC calls ; 30 Dec 2011  1:36 PM
"RTN","MAGJLST1",2,0)
 ;;3.0;IMAGING;**16,22,18,65,76,101,90,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJLST1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJLST1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJLST1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJLST1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJLST1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJLST1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJLST1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJLST1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJLST1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJLST1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJLST1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJLST1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJLST1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJLST1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJLST1",17,0)
 ;;
"RTN","MAGJLST1",18,0)
 Q
"RTN","MAGJLST1",19,0)
 ;
"RTN","MAGJLST1",20,0)
 ; Subroutines for fetching Patient Exam Info
"RTN","MAGJLST1",21,0)
 ;     PTLIST -- list subset of all exams for a patient
"RTN","MAGJLST1",22,0)
 ;        RPC Call: MAGJ PTRADEXAMS
"RTN","MAGJLST1",23,0)
 ;   PTLSTALL -- list ALL exams for a patient
"RTN","MAGJLST1",24,0)
 ;        RPC Call: MAGJ PT ALL EXAMS
"RTN","MAGJLST1",25,0)
 ;    FACLIST -- get Treating Facility List for a patient
"RTN","MAGJLST1",26,0)
 ;        RPC Call: MAGJ GET TREATING LIST
"RTN","MAGJLST1",27,0)
 ; 
"RTN","MAGJLST1",28,0)
 Q
"RTN","MAGJLST1",29,0)
ERR N ERR S ERR=$$EC^%ZOSV S ^TMP($J,"RET",0)="0^4~"_ERR
"RTN","MAGJLST1",30,0)
 S MAGGRY=$NA(^TMP($J,"RET"))
"RTN","MAGJLST1",31,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJLST1",32,0)
 Q:$Q 1  Q
"RTN","MAGJLST1",33,0)
 ;
"RTN","MAGJLST1",34,0)
PTLSTALL(MAGGRY,DATA) ; List ALL exams for a patient
"RTN","MAGJLST1",35,0)
 ; MAGGRY - indirect reference to return array of exams for a patient
"RTN","MAGJLST1",36,0)
 ; DATA -- DFN ^ BEGDT ^ ONESHOT
"RTN","MAGJLST1",37,0)
 ;   --> see PTLIST comments
"RTN","MAGJLST1",38,0)
 ;  RPC is MAGJ PT ALL EXAMS
"RTN","MAGJLST1",39,0)
 N PARAM
"RTN","MAGJLST1",40,0)
 S PARAM=$P(DATA,U)_"^^^"_$P(DATA,U,2,3)
"RTN","MAGJLST1",41,0)
 D PTLIST(.MAGGRY,PARAM)
"RTN","MAGJLST1",42,0)
 Q
"RTN","MAGJLST1",43,0)
 ;
"RTN","MAGJLST1",44,0)
PTLIST(MAGGRY,DATA) ; get list of exams for a patient
"RTN","MAGJLST1",45,0)
 ; 
"RTN","MAGJLST1",46,0)
 ; MAGGRY - indirect reference to return array of exams for a patient
"RTN","MAGJLST1",47,0)
 ; DATA -- DFN ^ unused ^ unused ^ BEGDT ^ ONESHOT
"RTN","MAGJLST1",48,0)
 ;   DFN--Required; Patient's DFN
"RTN","MAGJLST1",49,0)
 ;   BEGDT--Optional; Begin date for exam fetch (see below)
"RTN","MAGJLST1",50,0)
 ;   ONESHOT--Optional; Number days back to search, return all records in one fell swoop
"RTN","MAGJLST1",51,0)
 ; Returns data in ^TMP($J,"MAGRAEX",0:n)
"RTN","MAGJLST1",52,0)
 ; RPC Call: MAGJ PTRADEXAMS
"RTN","MAGJLST1",53,0)
 ;
"RTN","MAGJLST1",54,0)
 ; Client retrieves ALL exams using multiple RPC calls to
"RTN","MAGJLST1",55,0)
 ; incrementally build the list; this is to provide all the data, but without
"RTN","MAGJLST1",56,0)
 ; incurring any long pauses to provide the info to the user.
"RTN","MAGJLST1",57,0)
 ; The algorithm fetches RAD data in one-year chunks, and repeats
"RTN","MAGJLST1",58,0)
 ; until over 20 exams have been processed, at which point the RPC reply
"RTN","MAGJLST1",59,0)
 ; is posted, along with the last date processed; this value is then used for
"RTN","MAGJLST1",60,0)
 ; a subsequent RPC call (BEGDT) to get the next chunk of the record; etc. till all done.
"RTN","MAGJLST1",61,0)
 ;  * ONESHOT overrides the incremental algorithm, returning all desired data in a single call.
"RTN","MAGJLST1",62,0)
 ;   
"RTN","MAGJLST1",63,0)
 N CNT,DFN,ISS,PATNAME,DIQUIET,MAGRACNT,MAGRET,REPLY,REMOTE
"RTN","MAGJLST1",64,0)
 N DAYCASE,DIV,EXCAT,MAGDT,XX,XX2,WHOLOCK,MODALITY,MYLOCK,PLACE,ENDLOOP
"RTN","MAGJLST1",65,0)
 N LIMEXAMS,BEGDT,SAVBEGDT,ENDDT,MORE,RDRIST,PSSN,CPT
"RTN","MAGJLST1",66,0)
 N CURPRIO,STATUS,RARPT,KEY,X2,REMOTE2,ONESHOT,LIMDAYS
"RTN","MAGJLST1",67,0)
 N IMGCNT,LRFLAG,MSG,ONL,PROCMOD,RASTCAT,RASTORD,STATPRIORITY,SNDREMOT
"RTN","MAGJLST1",68,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJLST1"
"RTN","MAGJLST1",69,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJLST1",70,0)
 S BEGDT=$P(DATA,U,4),ONESHOT=$P(DATA,U,5)
"RTN","MAGJLST1",71,0)
 K MAGGRY S DFN=+DATA
"RTN","MAGJLST1",72,0)
 S SNDREMOT=+$P($G(^MAG(2006.69,1,0)),U,11)
"RTN","MAGJLST1",73,0)
 S MAGRACNT=1,CNT=0 K ^TMP($J,"MAGRAEX"),^("MAGRAEX2")
"RTN","MAGJLST1",74,0)
 S REPLY="0^4~Compiling list of Radiology Exams."
"RTN","MAGJLST1",75,0)
 I DFN,$D(^DPT(DFN,0)) S PATNAME=$P(^(0),U) D
"RTN","MAGJLST1",76,0)
 . D PID^VADPT6 S PSSN=$S(VAERR:"Unknown",1:VA("PID"))
"RTN","MAGJLST1",77,0)
 . K VA("PID"),VA("BID"),VAERR
"RTN","MAGJLST1",78,0)
 . S ENDLOOP=0,BEGDT=$S(+BEGDT:BEGDT,1:"")
"RTN","MAGJLST1",79,0)
 . F  D  Q:'MORE  Q:ENDLOOP  S BEGDT=MORE+1
"RTN","MAGJLST1",80,0)
 . . I 'BEGDT S BEGDT=DT,X2=0
"RTN","MAGJLST1",81,0)
 . . E  S X2=-1
"RTN","MAGJLST1",82,0)
 . . S LIMDAYS=365,MORE=1
"RTN","MAGJLST1",83,0)
 . . I ONESHOT,(ONESHOT>0) S LIMDAYS=+ONESHOT
"RTN","MAGJLST1",84,0)
 . . S ENDDT=$$FMADD^XLFDT(BEGDT,X2)
"RTN","MAGJLST1",85,0)
 . . S BEGDT=$$FMADD^XLFDT(ENDDT,-LIMDAYS)
"RTN","MAGJLST1",86,0)
 . . D GETEXAM3^MAGJUTL1(DFN,BEGDT,ENDDT,.MAGRACNT,.MAGRET,.MORE)
"RTN","MAGJLST1",87,0)
 . . S ENDLOOP=(MAGRACNT>20)!+ONESHOT ; For testing only, use >8
"RTN","MAGJLST1",88,0)
 . I 'MORE S SAVBEGDT=0
"RTN","MAGJLST1",89,0)
 . E  S SAVBEGDT=MORE+1 ; adding 1 correctly inits value for subseqent call
"RTN","MAGJLST1",90,0)
 . I MAGRACNT>1 D PTLOOP
"RTN","MAGJLST1",91,0)
 E  S REPLY="0^4~Invalid Radiology Patient"
"RTN","MAGJLST1",92,0)
 I MAGRACNT<2 S:(REPLY["Compiling") REPLY="0^2~Radiology Exams for: "_PATNAME
"RTN","MAGJLST1",93,0)
 I CNT!(REPLY["2~Radiology Exams") D
"RTN","MAGJLST1",94,0)
 . I 'MORE S MSG=""
"RTN","MAGJLST1",95,0)
 . E  S MORE=$$FMTE^XLFDT(MORE) S MSG="Patient has more exams on file."
"RTN","MAGJLST1",96,0)
 . ; show SSN only if the user is a radiologist
"RTN","MAGJLST1",97,0)
 . S X=+MAGJOB("USER",1)
"RTN","MAGJLST1",98,0)
 . I '(X=12!(X=15)),(PSSN?3N1"-"2N1"-"4N) S PSSN=$E(PATNAME)_$P(PSSN,"-",3)
"RTN","MAGJLST1",99,0)
 . S PSSN=" ("_PSSN_")"
"RTN","MAGJLST1",100,0)
 . I CNT S REPLY=CNT_"^1~Radiology Exams for: "_PATNAME_PSSN_$S(MSG="":"",1:" -- "_MSG)
"RTN","MAGJLST1",101,0)
 . E  S REPLY=REPLY_$S(MSG="":"",1:" -- "_MSG)
"RTN","MAGJLST1",102,0)
 . S ^TMP($J,"MAGRAEX2",1)="^Day/Case~S3~1^Lock~~2^Procedure~~6^Modifier~~25^Image Date/Time~S1~7^Status~~8^# Img~S2~9^Onl~~10^"_$S(SNDREMOT:"RC~~12^",1:"")_"Site~~23^Mod~~15^Interp By~~20^Imaging Loc~~11^CPT~~27"
"RTN","MAGJLST1",103,0)
 S $P(REPLY,"|",2)=SAVBEGDT
"RTN","MAGJLST1",104,0)
 S ^TMP($J,"MAGRAEX2",0)=REPLY
"RTN","MAGJLST1",105,0)
 S MAGGRY=$NA(^TMP($J,"MAGRAEX2"))
"RTN","MAGJLST1",106,0)
 K ^TMP($J,"RAE1"),^("MAGRAEX")
"RTN","MAGJLST1",107,0)
 Q
"RTN","MAGJLST1",108,0)
 ;
"RTN","MAGJLST1",109,0)
PTLOOP ; loop through exam data & package it for VRAD use
"RTN","MAGJLST1",110,0)
 S ISS=0
"RTN","MAGJLST1",111,0)
 F  S ISS=$O(^TMP($J,"MAGRAEX",ISS)) Q:'ISS  S XX=^(ISS,1),XX2=^(2) D
"RTN","MAGJLST1",112,0)
 . S CNT=CNT+1,RARPT=$P(XX,U,10)
"RTN","MAGJLST1",113,0)
 . D IMGINFO^MAGJUTL2(RARPT,.Y)
"RTN","MAGJLST1",114,0)
 . S IMGCNT=$P(Y,U),ONL=$P(Y,U,2),MAGDT=$P(Y,U,3),REMOTE=$P(Y,U,4),MODALITY=$P(Y,U,5),PLACE=$P(Y,U,6),KEY=$P(Y,U,7)
"RTN","MAGJLST1",115,0)
 . S REMOTE2=REMOTE
"RTN","MAGJLST1",116,0)
 . S:PLACE PLACE=$P($G(^MAG(2006.1,PLACE,0)),U,9)
"RTN","MAGJLST1",117,0)
 . I REMOTE D
"RTN","MAGJLST1",118,0)
 . . S T="" F I=1:1:$L(REMOTE,",") S T=T_$S(T="":"",1:",")_$P($G(^MAG(2005.2,$P(REMOTE,",",I),3)),U,5)
"RTN","MAGJLST1",119,0)
 . . S REMOTE=T
"RTN","MAGJLST1",120,0)
 . S DIV="",X=$P(XX2,U,5) I X'=DUZ(2) S DIV=$$STATN(X)
"RTN","MAGJLST1",121,0)
 . I MAGDT="" S MAGDT=$P(XX,U,7)
"RTN","MAGJLST1",122,0)
 . S MAGDT=$$FMTE^XLFDT(MAGDT,"5Z")
"RTN","MAGJLST1",123,0)
 . S WHOLOCK=RARPT,MYLOCK="",DAYCASE=$P(XX,U,12)
"RTN","MAGJLST1",124,0)
 . I WHOLOCK]"" S T=$$CHKLOCK^MAGJLS2B(WHOLOCK,DAYCASE),WHOLOCK=$P(T,U),MYLOCK=$P(T,U,2)
"RTN","MAGJLST1",125,0)
 . S RDRIST=$P(XX2,U,3),PROCMOD=$P(XX2,U,8),CPT=$P(XX,U,17),RASTORD=$P(XX,U,15)
"RTN","MAGJLST1",126,0)
 . S Y=U_DAYCASE_U_WHOLOCK_U_$E($P(XX,U,9),1,26)_U_PROCMOD_U_MAGDT_U_$E($P(XX,U,14),1,16)_U_IMGCNT_U_ONL
"RTN","MAGJLST1",127,0)
 . I SNDREMOT S Y=Y_U_REMOTE
"RTN","MAGJLST1",128,0)
 . S Y=Y_U_PLACE_U_MODALITY_U_RDRIST_U_$E($P(XX,U,13),1,11)_U_CPT
"RTN","MAGJLST1",129,0)
 . S STATUS=$P(XX,U,11),EXCAT="",CURPRIO=0,RASTCAT=$P(XX2,U,11),LRFLAG=$P(XX2,U,12)
"RTN","MAGJLST1",130,0)
 . I STATUS]"" D
"RTN","MAGJLST1",131,0)
 . . S EXCAT=RASTCAT
"RTN","MAGJLST1",132,0)
 . . I RASTORD<2!(EXCAT="W")!('IMGCNT) S CURPRIO=0 ; Cancelled/Waiting/No images: Ignore exam
"RTN","MAGJLST1",133,0)
 . . E  I EXCAT="E" S CURPRIO=1  ; Examined="Current" exam
"RTN","MAGJLST1",134,0)
 . . E  S CURPRIO=2  ; must be a "prior" exam
"RTN","MAGJLST1",135,0)
 . . I CURPRIO,'(ONL="Y") S CURPRIO=3 ; images on jukebox
"RTN","MAGJLST1",136,0)
 . . I RASTORD=9 S EXCAT="C" ; Complete
"RTN","MAGJLST1",137,0)
 . . E  I EXCAT="D"!(EXCAT="T") S EXCAT="I" ; just display one value meaning Interpreted
"RTN","MAGJLST1",138,0)
 . S STATPRIORITY=0 ; in the Pt list, this is only a placeholder in next line, to sync with svmag2a, etc.
"RTN","MAGJLST1",139,0)
 . S ^TMP($J,"MAGRAEX2",ISS)=Y_"^|"_$P(XX,U,1,3)_U_RARPT_"||"_EXCAT_U_WHOLOCK_U_MYLOCK_U_MODALITY_U_CPT_U_CURPRIO_U_RARPT_U_KEY_U_REMOTE2_U_LRFLAG_U_STATPRIORITY
"RTN","MAGJLST1",140,0)
 . ; * Note: Keep Pipe-pieces in sync with svmag2a^magjls3 & lstout^magjls2b *
"RTN","MAGJLST1",141,0)
 Q
"RTN","MAGJLST1",142,0)
 ;
"RTN","MAGJLST1",143,0)
STATN(X) ; get station #, else return input value
"RTN","MAGJLST1",144,0)
 N T
"RTN","MAGJLST1",145,0)
 I X]"" D GETS^DIQ(4,X,99,"E","T") S T=$G(T(4,X_",",99,"E")) I T]"" S X=T
"RTN","MAGJLST1",146,0)
 Q X
"RTN","MAGJLST1",147,0)
 ;
"RTN","MAGJLST1",148,0)
FACLIST(MAGGRY,DATA) ; get Treating Facility List for a patient
"RTN","MAGJLST1",149,0)
 ; RPC Call: MAGJ GET TREATING LIST
"RTN","MAGJLST1",150,0)
 ; MAGGRY -- return array--supplied by TFL^VAFCTFU1
"RTN","MAGJLST1",151,0)
 ; Input: DATA -- Patient DFN
"RTN","MAGJLST1",152,0)
 ; Returns:
"RTN","MAGJLST1",153,0)
 ; Array; first entry contains result header with # lines to follow
"RTN","MAGJLST1",154,0)
 ; and reply message description.
"RTN","MAGJLST1",155,0)
 ; Entries 2:N (if any exist) contain data for each Treating facility
"RTN","MAGJLST1",156,0)
 ; up-caret delimited : A ^ B ^ C ^ D ^ E
"RTN","MAGJLST1",157,0)
 ;    A: Institution IEN of the Facility
"RTN","MAGJLST1",158,0)
 ;    B: Institution Name
"RTN","MAGJLST1",159,0)
 ;    C: Current date on record for that institution
"RTN","MAGJLST1",160,0)
 ;    D: ADT/HL7 event reason 
"RTN","MAGJLST1",161,0)
 ;    E: FACILITY TYPE
"RTN","MAGJLST1",162,0)
 ; Note--see TFL^VAFCTFU1 for further details
"RTN","MAGJLST1",163,0)
 ; 
"RTN","MAGJLST1",164,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJLST1"
"RTN","MAGJLST1",165,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJLST1",166,0)
 N DFN
"RTN","MAGJLST1",167,0)
 K MAGGRY S DFN=+$G(DATA)
"RTN","MAGJLST1",168,0)
 S REPLY="0^4~Compiling list of Treating Facilities."
"RTN","MAGJLST1",169,0)
 I DFN
"RTN","MAGJLST1",170,0)
 E  S REPLY="0^4~Invalid Radiology Patient" G FACLISTZ
"RTN","MAGJLST1",171,0)
 D TFL^VAFCTFU1(.MAGGRY,DFN)  ; ICR 2990
"RTN","MAGJLST1",172,0)
 I $D(MAGGRY)<10 S REPLY="0^4~No results available." G FACLISTZ
"RTN","MAGJLST1",173,0)
 E  I +MAGGRY(1)=-1 S REPLY="0^2~"_$P(MAGGRY(1),U,2) K MAGGRY(1) G FACLISTZ
"RTN","MAGJLST1",174,0)
 S REPLY=$O(MAGGRY(""),-1)_U_"1~Treating facilities returned"
"RTN","MAGJLST1",175,0)
FACLISTZ S MAGGRY(0)=REPLY
"RTN","MAGJLST1",176,0)
 Q
"RTN","MAGJLST1",177,0)
 ;
"RTN","MAGJLST1",178,0)
END Q  ;
"RTN","MAGJMN1")
0^6^B106024345
"RTN","MAGJMN1",1,0)
MAGJMN1 ;WIRMFO/JHC - VRad Maint functions ; 9 Sep 2011  4:05 PM
"RTN","MAGJMN1",2,0)
 ;;3.0;IMAGING;**16,9,22,18,65,76,101,90,115,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJMN1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJMN1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJMN1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJMN1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJMN1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJMN1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJMN1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJMN1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJMN1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJMN1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJMN1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJMN1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJMN1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJMN1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJMN1",17,0)
 ;;
"RTN","MAGJMN1",18,0)
ENVCHK ; "Environment Check" for KIDS Install
"RTN","MAGJMN1",19,0)
 I 'XPDENV Q  ; Proceed only if in Install phase
"RTN","MAGJMN1",20,0)
 N MAGJKIDS S MAGJKIDS=1
"RTN","MAGJMN1",21,0)
 D BGCSTOP
"RTN","MAGJMN1",22,0)
 Q
"RTN","MAGJMN1",23,0)
 ;
"RTN","MAGJMN1",24,0)
SVRLIST ;
"RTN","MAGJMN1",25,0)
 W @IOF,!!?10,"Enter/Edit VistARad Exams List Definition",!!
"RTN","MAGJMN1",26,0)
 N MAGIEN
"RTN","MAGJMN1",27,0)
 K DIC S (DIC,DLAYGO)=2006.631,DIC(0)="ALMEQ"
"RTN","MAGJMN1",28,0)
 D ^DIC I Y=-1 K DIC,DA,DR,DIE,DLAYGO Q
"RTN","MAGJMN1",29,0)
 S X=$P(@(DIC_+Y_",0)"),U,2)
"RTN","MAGJMN1",30,0)
 I X>9000 W !!,$C(7),"You may not edit System-Supplied files!" H 3 G SVRLIST
"RTN","MAGJMN1",31,0)
 S DIE=2006.631,DA=+Y,DR="[MAGJ LIST EDIT]"
"RTN","MAGJMN1",32,0)
 S MAGIEN=DA
"RTN","MAGJMN1",33,0)
 D ^DIE I '$D(DA) G SVRLIST
"RTN","MAGJMN1",34,0)
 D ENSRCH
"RTN","MAGJMN1",35,0)
 D BLDDEF(MAGIEN)
"RTN","MAGJMN1",36,0)
 S $P(^MAG(2006.631,MAGIEN,0),U,5)=$$NOW^XLFDT()
"RTN","MAGJMN1",37,0)
 W !!,"List Definition complete!" R X:2
"RTN","MAGJMN1",38,0)
 G SVRLIST
"RTN","MAGJMN1",39,0)
 Q
"RTN","MAGJMN1",40,0)
ENSRCH ; Invoke Search for 2006.631 def'n
"RTN","MAGJMN1",41,0)
 N GREF,GLIN,GO,CT,DIARI,DIC,FNOD,TNOD,NCOND,NODE0
"RTN","MAGJMN1",42,0)
 ; GREF holds indirect ref to store search logic data:
"RTN","MAGJMN1",43,0)
 ; @GREF@(3, ff -- conditional elements (fields/logic)
"RTN","MAGJMN1",44,0)
 ; @GREF@(4, ff -- composite elements (ANDed conditions)
"RTN","MAGJMN1",45,0)
 ; @GREF@(5, ff -- Human-readable search text
"RTN","MAGJMN1",46,0)
 ; GLIN holds indirect ref to retrieve search logic data from ^DIBT
"RTN","MAGJMN1",47,0)
 ; @GLIN@("DC", ff -- conditional elements
"RTN","MAGJMN1",48,0)
 ; @GLIN@("DL", ff -- composite elements
"RTN","MAGJMN1",49,0)
 ; @GLIN@("O", ff -- readable text
"RTN","MAGJMN1",50,0)
 S GREF=$NA(^MAG(2006.631,MAGIEN,"DEF"))
"RTN","MAGJMN1",51,0)
 S GO=1 I $D(@GREF@(5,1)) D  ; show current logic
"RTN","MAGJMN1",52,0)
 . W ! D DISPSRCH(GREF)
"RTN","MAGJMN1",53,0)
 . S X=$$YN("Do you want to delete or re-enter the search logic?","NO")
"RTN","MAGJMN1",54,0)
 . I X'="Y" S GO=0 Q
"RTN","MAGJMN1",55,0)
 . W !!?7,"Re-entering the search logic requires first deleting the current",!?7,"definition, then entering the new definition from scratch."
"RTN","MAGJMN1",56,0)
 . S X=$$YN("Are you sure you want to continue?","NO")
"RTN","MAGJMN1",57,0)
 . I X'="Y" S GO=0 Q
"RTN","MAGJMN1",58,0)
 I 'GO Q
"RTN","MAGJMN1",59,0)
 W !!?7,"Now enter search logic for this List.  To do this, the program"
"RTN","MAGJMN1",60,0)
 W !?7,"will prompt you just as if you were going to run a Fileman Search."
"RTN","MAGJMN1",61,0)
 W !?7,"When prompted STORE RESULTS OF SEARCH IN TEMPLATE:, answer with 'TEMP'"
"RTN","MAGJMN1",62,0)
 W !?7,"If prompted ... OK TO PURGE? NO// answer 'YES'; don't bother specifying"
"RTN","MAGJMN1",63,0)
 W !?7,"output print fields, but just RETURN through all the prompts to"
"RTN","MAGJMN1",64,0)
 W !?7,"complete the process.  The search definition will be saved as part"
"RTN","MAGJMN1",65,0)
 W !?7,"of this List definition; you will test it out by running it from "
"RTN","MAGJMN1",66,0)
 W !?7,"the workstation.  If you need to modify the search logic, you will"
"RTN","MAGJMN1",67,0)
 W !?7,"have to re-enter it in its entirety."
"RTN","MAGJMN1",68,0)
 W !!?7,"NOTES: EXAM LOCK INDICATOR will not work for search logic;"
"RTN","MAGJMN1",69,0)
 W !?14,"REMOTE CACHE INDICATOR only works for Null/Not Null logic."
"RTN","MAGJMN1",70,0)
 S DIC=2006.634 D EN^DIS  ; call Fman Search Logic routine. It will store search logic in ^DIBT
"RTN","MAGJMN1",71,0)
 ; 2006.634 is intentional--don't change this!
"RTN","MAGJMN1",72,0)
 I '$G(DIARI) W !!," Search logic NOT updated" D  Q
"RTN","MAGJMN1",73,0)
 . Q:'$D(@GREF@(5,1))  ; if no logic had existed, quit
"RTN","MAGJMN1",74,0)
 . S X=$$YN("Do you want to DELETE the search logic?","NO")
"RTN","MAGJMN1",75,0)
 . I X="Y" K @GREF@(3) K ^(4),^(5) W " -- Deleted!"
"RTN","MAGJMN1",76,0)
 K @GREF@(3) K ^(4),^(5)
"RTN","MAGJMN1",77,0)
 S GLIN=$NA(^DIBT(DIARI))  ; Copy logic to 2006.631 DEF nodes
"RTN","MAGJMN1",78,0)
 S FNOD="DC",TNOD=3,CT=0  ; "DC" data--straight copy
"RTN","MAGJMN1",79,0)
 S T=0 F  S T=$O(@GLIN@(FNOD,T)) Q:T=""  S X=^(T),CT=CT+1,@GREF@(TNOD,T)=X
"RTN","MAGJMN1",80,0)
 S @GREF@(TNOD,0)=CT
"RTN","MAGJMN1",81,0)
 S FNOD="DL",TNOD=4,CT=0  ; "DL" data--copy depends on storage scheme in DIBT:
"RTN","MAGJMN1",82,0)
 ;Zero node null -- straight copy
"RTN","MAGJMN1",83,0)
 ; Else 1) either only one condition is defined;
"RTN","MAGJMN1",84,0)
 ; or, 2) the zero-node condition is ANDed with all defined conditions
"RTN","MAGJMN1",85,0)
 ;  Case 2: Var A -- Pre-pend zero node, then dup zero node
"RTN","MAGJMN1",86,0)
 ;            Var B -- Pre-pend zero node
"RTN","MAGJMN1",87,0)
 S NCOND=+$G(@GLIN@(FNOD))
"RTN","MAGJMN1",88,0)
 I $G(@GLIN@(FNOD,0))]"" S NODE0=^(0) D
"RTN","MAGJMN1",89,0)
 . S T=0 F  S T=$O(@GLIN@(FNOD,T)) Q:T=""  S X=^(T) I X]"" S CT=CT+1,@GREF@(TNOD,CT)=NODE0_X
"RTN","MAGJMN1",90,0)
 . I CT'=NCOND S CT=CT+1,@GREF@(TNOD,CT)=NODE0_$S(CT=1:"",1:"^")
"RTN","MAGJMN1",91,0)
 E  D
"RTN","MAGJMN1",92,0)
 . S T=0 F  S T=$O(@GLIN@(FNOD,T)) Q:T=""  S X=^(T) I X]"" S CT=CT+1,@GREF@(TNOD,CT)=X
"RTN","MAGJMN1",93,0)
 S @GREF@(TNOD,0)=CT
"RTN","MAGJMN1",94,0)
 ; readable text--straight copy
"RTN","MAGJMN1",95,0)
 S TNOD=5,T=0 F  S T=$O(@GLIN@("O",T)) Q:T=""  S @GREF@(TNOD,T)=^(T,0)
"RTN","MAGJMN1",96,0)
 Q
"RTN","MAGJMN1",97,0)
 ;
"RTN","MAGJMN1",98,0)
BLDDEF(LSTID) ; build DEF nodes for Column/Sort defs
"RTN","MAGJMN1",99,0)
 N X,QX,SS,STR,LSTHDR,T,T0,T8,T6,HASCASE,XT,HASDATE,HASNIMG,HASPRIO,HASLOCK,LISTYPE
"RTN","MAGJMN1",100,0)
 S SS=0,HASCASE=0,HASDATE=0,HASNIMG=0,HASPRIO=0,HASLOCK=0
"RTN","MAGJMN1",101,0)
 S LISTYPE=$P($G(^MAG(2006.631,LSTID,0)),U,3)
"RTN","MAGJMN1",102,0)
 ; columns/hdrs: Order in T array by the Relative Column Order
"RTN","MAGJMN1",103,0)
 F  S SS=$O(^MAG(2006.631,LSTID,1,SS)) D  Q:'SS
"RTN","MAGJMN1",104,0)
 . I 'SS D  Q
"RTN","MAGJMN1",105,0)
 . . I 'HASCASE S X=1 D BLDDEF2(X)  ; Force CASE#
"RTN","MAGJMN1",106,0)
 . . I 'HASDATE S X=7 D BLDDEF2(X)  ; DATE/TIME
"RTN","MAGJMN1",107,0)
 . . I 'HASNIMG S X=9 D BLDDEF2(X)  ; NUMBER IMAGES
"RTN","MAGJMN1",108,0)
 . . Q:LISTYPE'="U"  ; force below only if for an Unread list
"RTN","MAGJMN1",109,0)
 . . I 'HASLOCK S X=2 D BLDDEF2(X)  ; EXAM LOCK IND.
"RTN","MAGJMN1",110,0)
 . . I 'HASPRIO S X=5 D BLDDEF2(X)  ; PRIORITY
"RTN","MAGJMN1",111,0)
 . E  S X=^MAG(2006.631,LSTID,1,SS,0)
"RTN","MAGJMN1",112,0)
 . D BLDDEF2(X)
"RTN","MAGJMN1",113,0)
 ; go thru T to build ordered field sequence for output columns
"RTN","MAGJMN1",114,0)
 S QX="T",STR="",LSTHDR=""
"RTN","MAGJMN1",115,0)
 F  S QX=$Q(@QX) Q:QX=""  S X=@QX D
"RTN","MAGJMN1",116,0)
 . S STR=STR_$S(STR="":"",1:U)_$P(X,U)
"RTN","MAGJMN1",117,0)
 . S LSTHDR=LSTHDR_$S(LSTHDR="":"",1:U)_$P(X,U,2)
"RTN","MAGJMN1",118,0)
 S ^MAG(2006.631,LSTID,"DEF",.5)=LSTHDR,^(1)=STR
"RTN","MAGJMN1",119,0)
 ; Sort values:
"RTN","MAGJMN1",120,0)
 S SS=0,STR=""
"RTN","MAGJMN1",121,0)
 F  S SS=$O(^MAG(2006.631,LSTID,2,SS)) Q:'SS  S X=^(SS,0) D
"RTN","MAGJMN1",122,0)
 . S X=+X_$S($P(X,U,2):"-",1:"")
"RTN","MAGJMN1",123,0)
 . S STR=STR_$S(STR="":"",1:U)_X
"RTN","MAGJMN1",124,0)
 S ^MAG(2006.631,LSTID,"DEF",2)=STR
"RTN","MAGJMN1",125,0)
 S $P(^MAG(2006.631,LSTID,"DEF",0),U)=$$NOW^XLFDT()
"RTN","MAGJMN1",126,0)
 Q
"RTN","MAGJMN1",127,0)
 ;
"RTN","MAGJMN1",128,0)
BLDDEF2(X) ;
"RTN","MAGJMN1",129,0)
 S X=+X_$S($P(X,U,2):";"_+$P(X,U,2),1:"")
"RTN","MAGJMN1",130,0)
 I 'HASCASE S HASCASE=(+X=1)
"RTN","MAGJMN1",131,0)
 I 'HASDATE S HASDATE=(+X=7)
"RTN","MAGJMN1",132,0)
 I 'HASNIMG S HASNIMG=(+X=9)
"RTN","MAGJMN1",133,0)
 I 'HASLOCK S HASLOCK=(+X=2)
"RTN","MAGJMN1",134,0)
 I 'HASPRIO S HASPRIO=(+X=5)
"RTN","MAGJMN1",135,0)
 S T0=^MAG(2006.63,+X,0),T6=+$P(T0,U,6) S:'T6 T6=99
"RTN","MAGJMN1",136,0)
 S T8=$P(T0,U,8) I T8]"" S T8="~"_T8
"RTN","MAGJMN1",137,0)
 S XT=$S($P(T0,U,3)]"":$P(T0,U,3),1:$P(T0,U,2))_T8
"RTN","MAGJMN1",138,0)
 S $P(XT,"~",3)=+X
"RTN","MAGJMN1",139,0)
 S T(T6,+X)=X_U_XT
"RTN","MAGJMN1",140,0)
 Q
"RTN","MAGJMN1",141,0)
 ;
"RTN","MAGJMN1",142,0)
POSTINST ; Patch installation inits, etc.
"RTN","MAGJMN1",143,0)
 D P120DD ; Patch 120 DD mods
"RTN","MAGJMN1",144,0)
 ; D BLDALL ; update list definitions  <*> Use any time fields are added
"RTN","MAGJMN1",145,0)
 D BGCSTRT ; re-start background compile
"RTN","MAGJMN1",146,0)
 D POST ; install message, etc.
"RTN","MAGJMN1",147,0)
 Q
"RTN","MAGJMN1",148,0)
 ;
"RTN","MAGJMN1",149,0)
BLDALL ; Create "DEF" nodes, Button labels List Def'ns
"RTN","MAGJMN1",150,0)
 ; Updates all lists after s/w update list defs are installed
"RTN","MAGJMN1",151,0)
 N SS,LSTDAT,LSTNUM,BUTTON,LSTTYP
"RTN","MAGJMN1",152,0)
 S SS=0
"RTN","MAGJMN1",153,0)
 F  S SS=$O(^MAG(2006.631,SS)) Q:'SS  S LSTDAT=$G(^(SS,0)) I LSTDAT]"" D
"RTN","MAGJMN1",154,0)
 . S LSTNUM=$P(LSTDAT,U,2),BUTTON=$P(LSTDAT,U,7),LSTTYP=$P(LSTDAT,U,3)
"RTN","MAGJMN1",155,0)
 . I LSTNUM>9900!$P(LSTDAT,U,6) D BLDDEF(SS)  ; build DEF nodes for System Lists & any Enabled lists
"RTN","MAGJMN1",156,0)
 . I BUTTON="",(LSTTYP]"") D   ; Create Button Labels if needed
"RTN","MAGJMN1",157,0)
 . . S BUTTON=$S(LSTTYP="U":"Unread #",LSTTYP="R":"Recent #",LSTTYP="A":"All Active #",LSTTYP="P":"Pending #",1:"List #")_LSTNUM
"RTN","MAGJMN1",158,0)
 . . S $P(^MAG(2006.631,SS,0),U,7)=BUTTON
"RTN","MAGJMN1",159,0)
 Q
"RTN","MAGJMN1",160,0)
 ;
"RTN","MAGJMN1",161,0)
POST ; Install msg
"RTN","MAGJMN1",162,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGJMN1",163,0)
 Q
"RTN","MAGJMN1",164,0)
 ;
"RTN","MAGJMN1",165,0)
P120DD ; DD changes for MAG VISTARAD SITE PARAMETERS, deleting deprecated fields
"RTN","MAGJMN1",166,0)
 ;
"RTN","MAGJMN1",167,0)
 W !!,"Deleting deprecated fields from MAG VISTARAD SITE PARAMETERS file ... "
"RTN","MAGJMN1",168,0)
 ; First, delete the field entries
"RTN","MAGJMN1",169,0)
 N I,REC
"RTN","MAGJMN1",170,0)
 S REC=$G(^MAG(2006.69,1,0))
"RTN","MAGJMN1",171,0)
 I REC]"" D
"RTN","MAGJMN1",172,0)
 . F I=6,12,14,15 S $P(REC,U,I)=""
"RTN","MAGJMN1",173,0)
 . S ^MAG(2006.69,1,0)=REC
"RTN","MAGJMN1",174,0)
 ;
"RTN","MAGJMN1",175,0)
 ; Then, delete the field definitions
"RTN","MAGJMN1",176,0)
 S DIK="^DD(2006.69,",DA(1)=2006.69
"RTN","MAGJMN1",177,0)
 F DA=4,5.5,10,11 D ^DIK
"RTN","MAGJMN1",178,0)
 K DIK,DA
"RTN","MAGJMN1",179,0)
 W " done! ",!
"RTN","MAGJMN1",180,0)
 Q
"RTN","MAGJMN1",181,0)
 ;
"RTN","MAGJMN1",182,0)
YN(MSG,DFLT) ; get Yes/No reply
"RTN","MAGJMN1",183,0)
 N X I $G(DFLT)="" S DFLT="N"
"RTN","MAGJMN1",184,0)
 W !
"RTN","MAGJMN1",185,0)
 S DFLT=$E(DFLT),DFLT=$S(DFLT="N":"NO",1:"YES")
"RTN","MAGJMN1",186,0)
YN1 W !,MSG_" "_DFLT_"// "
"RTN","MAGJMN1",187,0)
 R X:DTIME S:X="" X=DFLT S X=$E(X),X=$TR(X,"ynYN","YNYN")
"RTN","MAGJMN1",188,0)
 I "YN"'[X W "  ??? Enter YES or NO",! G YN1
"RTN","MAGJMN1",189,0)
 Q X
"RTN","MAGJMN1",190,0)
 ;
"RTN","MAGJMN1",191,0)
LSTINQ ; Inq/Disp list def'n
"RTN","MAGJMN1",192,0)
 N GREF,MAGIEN
"RTN","MAGJMN1",193,0)
 W !!?15,"Display VistARad Exams List Definition",!!
"RTN","MAGJMN1",194,0)
 N MAGIEN
"RTN","MAGJMN1",195,0)
 S DIC=2006.631,DIC(0)="AMEQ"
"RTN","MAGJMN1",196,0)
 D ^DIC I Y=-1 K DIC,DA,DR Q
"RTN","MAGJMN1",197,0)
 K DR S DA=+Y,MAGIEN=DA
"RTN","MAGJMN1",198,0)
 S GREF=$NA(^MAG(2006.631,MAGIEN,"DEF"))
"RTN","MAGJMN1",199,0)
 W ! D EN^DIQ
"RTN","MAGJMN1",200,0)
 R !,"Enter RETURN to display the Search Logic: ",X:DTIME W !
"RTN","MAGJMN1",201,0)
 D DISPSRCH(GREF)
"RTN","MAGJMN1",202,0)
 G LSTINQ
"RTN","MAGJMN1",203,0)
 Q
"RTN","MAGJMN1",204,0)
 ;
"RTN","MAGJMN1",205,0)
DISPSRCH(GREF) ; GREF holds indirect ref for global holding search logic data
"RTN","MAGJMN1",206,0)
 I $D(@GREF@(5,1)) W !,"List Exams where:",! D
"RTN","MAGJMN1",207,0)
 . F I=1:1 Q:'$D(@GREF@(5,I))  W !?3,^(I)
"RTN","MAGJMN1",208,0)
 E  W !?3,"NO Search Logic defined!"
"RTN","MAGJMN1",209,0)
 Q
"RTN","MAGJMN1",210,0)
 ;
"RTN","MAGJMN1",211,0)
VRSIT ;
"RTN","MAGJMN1",212,0)
 W @IOF,!!?10,"Enter/Edit VistARad Site Parameters",!!
"RTN","MAGJMN1",213,0)
 S DIC=2006.69,DIC(0)="ALMEQ"
"RTN","MAGJMN1",214,0)
 I '$D(^MAG(DIC,1)) S DLAYGO=DIC
"RTN","MAGJMN1",215,0)
 D ^DIC I Y=-1 K DIC,DA,DR,DIE,DLAYGO Q
"RTN","MAGJMN1",216,0)
 S DIE=2006.69,DA=+Y,DR=".01:20"
"RTN","MAGJMN1",217,0)
 D ^DIE
"RTN","MAGJMN1",218,0)
 K DIC,DA,DR,DIE,DLAYGO
"RTN","MAGJMN1",219,0)
 N PLACE S DA=""
"RTN","MAGJMN1",220,0)
 S PLACE=$$PLACE^MAGBAPI(+$G(DUZ(2)))
"RTN","MAGJMN1",221,0)
 S:PLACE DA=PLACE
"RTN","MAGJMN1",222,0)
 I DA D
"RTN","MAGJMN1",223,0)
 . W !!,"Editing VistARad Timeout for division #",DUZ(2),!
"RTN","MAGJMN1",224,0)
 . S DIE=2006.1,DR="123" D ^DIE
"RTN","MAGJMN1",225,0)
 K DA,DR,DIE
"RTN","MAGJMN1",226,0)
 Q
"RTN","MAGJMN1",227,0)
 ;
"RTN","MAGJMN1",228,0)
 ;+++++ OPTION: MAGJ E/E DEFAULT USER PROFILES
"RTN","MAGJMN1",229,0)
 ;
"RTN","MAGJMN1",230,0)
 ; FileMan ^DIE call to enter/edit IMAGING SITE PARAMETERS File (#2006.1),
"RTN","MAGJMN1",231,0)
 ;   fields #202: DEFAULT VISTARAD USERPREF RAD and
"RTN","MAGJMN1",232,0)
 ;          #203: DEFAULT VISTARAD USERPREF NON.
"RTN","MAGJMN1",233,0)
 ; 
"RTN","MAGJMN1",234,0)
 ; These fields point to entries in the MAGJ USER DATA File (#2006.68), and
"RTN","MAGJMN1",235,0)
 ;   allow the VistARad client to initialize new VistARad users to the settings
"RTN","MAGJMN1",236,0)
 ;   held by the appropriate default user type ("Radiologist", "Non-rad'ist").
"RTN","MAGJMN1",237,0)
 ;
"RTN","MAGJMN1",238,0)
EEPRO ;
"RTN","MAGJMN1",239,0)
 ;
"RTN","MAGJMN1",240,0)
 ;--- Get IEN of IMAGING SITE PARAMETERS File.
"RTN","MAGJMN1",241,0)
 N FIELD,SITEPIEN S SITEPIEN=+$$IMGSIT^MAGJUTL1(DUZ(2),1)
"RTN","MAGJMN1",242,0)
 F FIELD=202,203 D
"RTN","MAGJMN1",243,0)
 . ;
"RTN","MAGJMN1",244,0)
 . ;--- Report field being edited.
"RTN","MAGJMN1",245,0)
 . N PROMPT S PROMPT=$S(FIELD=202:"RADIOLOGIST",FIELD=203:"NON-RADIOLOGIST")
"RTN","MAGJMN1",246,0)
 . W !!,"Editing default "_PROMPT_" profile ...",!
"RTN","MAGJMN1",247,0)
 . N DA,DIE,DR
"RTN","MAGJMN1",248,0)
 . S DIE=2006.1,DR=FIELD,DA=SITEPIEN D ^DIE
"RTN","MAGJMN1",249,0)
 . Q
"RTN","MAGJMN1",250,0)
 Q
"RTN","MAGJMN1",251,0)
EEPREF ;
"RTN","MAGJMN1",252,0)
 W @IOF,!!?10,"Enter/Edit VistARad Prefetch Logic",!!
"RTN","MAGJMN1",253,0)
 N MAGIEN
"RTN","MAGJMN1",254,0)
 K DIC S (DIC,DLAYGO)=2006.65,DIC(0)="ALMEQ"
"RTN","MAGJMN1",255,0)
 D ^DIC I Y=-1 K DIC,DIE,DR,DLAYGO Q
"RTN","MAGJMN1",256,0)
 S DIE=2006.65,DA=+Y,DR="[MAGJ PRIOR EDIT]"
"RTN","MAGJMN1",257,0)
 S MAGIEN=DA
"RTN","MAGJMN1",258,0)
 D ^DIE I '$D(DA) G EEPREF
"RTN","MAGJMN1",259,0)
 G EEPREF
"RTN","MAGJMN1",260,0)
 Q
"RTN","MAGJMN1",261,0)
INPREF ; Inquire VRad PreFetch
"RTN","MAGJMN1",262,0)
 W @IOF,!!?10,"Inquire VistARad Prefetch Logic",!!
"RTN","MAGJMN1",263,0)
 N MAGIEN,BY,FR,TO
"RTN","MAGJMN1",264,0)
 S DIC=2006.65,DIC(0)="AMEQ"
"RTN","MAGJMN1",265,0)
 D ^DIC I Y=-1 K DIC Q
"RTN","MAGJMN1",266,0)
 S DA=+Y,(FR,TO)=$P(Y,U,2),MAGIEN=DA,L=0
"RTN","MAGJMN1",267,0)
 S BY="[MAGJ PRIOR SORT]",DIS(0)="I D0=MAGIEN"
"RTN","MAGJMN1",268,0)
 D EN^DIP
"RTN","MAGJMN1",269,0)
 R !,"Enter RETURN to continue: ",X:DTIME W !
"RTN","MAGJMN1",270,0)
 G INPREF
"RTN","MAGJMN1",271,0)
 Q
"RTN","MAGJMN1",272,0)
PRPREF ;Print VRad Prefetch
"RTN","MAGJMN1",273,0)
 N BY
"RTN","MAGJMN1",274,0)
 W !! S DIC=2006.65,L=0,BY="[MAGJ PRIOR SORT]"
"RTN","MAGJMN1",275,0)
 D EN1^DIP
"RTN","MAGJMN1",276,0)
 R !,"Enter RETURN to continue: ",X:DTIME W !
"RTN","MAGJMN1",277,0)
 Q
"RTN","MAGJMN1",278,0)
 ;
"RTN","MAGJMN1",279,0)
BGCSTOP ; Stop Background Compile program
"RTN","MAGJMN1",280,0)
 N MAGCSTRT,GO,NTRY,RETRY,X
"RTN","MAGJMN1",281,0)
 S MAGCSTRT=0,GO=1
"RTN","MAGJMN1",282,0)
 S X=$G(^MAG(2006.69,1,0))
"RTN","MAGJMN1",283,0)
 I X]"",+$P(X,U,8) D  ; Background compile switch; skip if already false
"RTN","MAGJMN1",284,0)
 . S ^MAG(2006.69,"BGSTOP")=X ; save current settings for restore later
"RTN","MAGJMN1",285,0)
 . S MAGCSTRT=1
"RTN","MAGJMN1",286,0)
 . S $P(X,U,8)=0
"RTN","MAGJMN1",287,0)
 . S ^MAG(2006.69,1,0)=X  ; disable compile
"RTN","MAGJMN1",288,0)
 . W !!,*7,"Wait for Background Compile program to stop;"
"RTN","MAGJMN1",289,0)
 . W !,"     this might take up to a few minutes."
"RTN","MAGJMN1",290,0)
 . S NTRY=60
"RTN","MAGJMN1",291,0)
 . F I=1:1:NTRY W "." L +^XTMP("MAGJ2","BKGND2","RUN"):3 I  Q  ; process maintains lock while running
"RTN","MAGJMN1",292,0)
 . I  D
"RTN","MAGJMN1",293,0)
 . . L -^XTMP("MAGJ2","BKGND2","RUN")
"RTN","MAGJMN1",294,0)
 . . W !!,"Background Compile Stopped"
"RTN","MAGJMN1",295,0)
 . . I +$G(MAGJKIDS) W "; proceeding with install.",! H 2
"RTN","MAGJMN1",296,0)
 . E  D
"RTN","MAGJMN1",297,0)
 . . S X=$$YN("Background Compile NOT Stopped -- Try again?","Y")
"RTN","MAGJMN1",298,0)
 . . S RETRY=("Y"[X),GO=0
"RTN","MAGJMN1",299,0)
 . . S ^MAG(2006.69,1,0)=^MAG(2006.69,"BGSTOP") K ^MAG(2006.69,"BGSTOP")
"RTN","MAGJMN1",300,0)
 I 'GO G BGCSTOP:RETRY
"RTN","MAGJMN1",301,0)
 I 'GO,+$G(MAGJKIDS) W !!,*7," * * * Exiting out of patch installation * * * ",! H 3 S XPDQUIT=1
"RTN","MAGJMN1",302,0)
 Q
"RTN","MAGJMN1",303,0)
BGCSTRT ; re-enable Background Compile
"RTN","MAGJMN1",304,0)
 I $D(^MAG(2006.69,"BGSTOP")) S X=^("BGSTOP") W " ... Enabling background compile ."
"RTN","MAGJMN1",305,0)
 E  Q
"RTN","MAGJMN1",306,0)
 S ^MAG(2006.69,1,0)=X
"RTN","MAGJMN1",307,0)
 K ^MAG(2006.69,"BGSTOP")
"RTN","MAGJMN1",308,0)
 W !!,"Background Compile Enabled.",! H 3
"RTN","MAGJMN1",309,0)
 Q
"RTN","MAGJMN1",310,0)
 ;
"RTN","MAGJMN1",311,0)
END ;
"RTN","MAGJMN3")
0^7^B6661799
"RTN","MAGJMN3",1,0)
MAGJMN3 ;WIRMFO/JHC - VRad Maint functions ; 9 Sep 2011  4:05 PM
"RTN","MAGJMN3",2,0)
 ;;3.0;IMAGING;**18,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJMN3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJMN3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJMN3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJMN3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJMN3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJMN3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJMN3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJMN3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJMN3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJMN3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJMN3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJMN3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJMN3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJMN3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJMN3",17,0)
 ;;
"RTN","MAGJMN3",18,0)
 Q
"RTN","MAGJMN3",19,0)
 ;
"RTN","MAGJMN3",20,0)
YN(MSG,DFLT) ; get Yes/No reply
"RTN","MAGJMN3",21,0)
 N X I $G(DFLT)="" S DFLT="N"
"RTN","MAGJMN3",22,0)
 W !
"RTN","MAGJMN3",23,0)
 S DFLT=$E(DFLT),DFLT=$S(DFLT="N":"NO",1:"YES")
"RTN","MAGJMN3",24,0)
YN1 W !,MSG_" "_DFLT_"// "
"RTN","MAGJMN3",25,0)
 R X:DTIME S:X="" X=DFLT S X=$E(X),X=$TR(X,"ynYN","YNYN")
"RTN","MAGJMN3",26,0)
 I "YN"'[X W "  ??? Enter YES or NO",! G YN1
"RTN","MAGJMN3",27,0)
 Q X
"RTN","MAGJMN3",28,0)
 ;
"RTN","MAGJMN3",29,0)
EECPT ;Enter/Edit CPT MATCHING SET
"RTN","MAGJMN3",30,0)
 W @IOF,!!?10,"** Enter/Edit VistARad RAD CPT MATCHING CPT CODE **",!!
"RTN","MAGJMN3",31,0)
 N MAGIEN
"RTN","MAGJMN3",32,0)
 K DIC S (DIC,DLAYGO)=2006.67,DIC(0)="ALMEQN"
"RTN","MAGJMN3",33,0)
 D ^DIC I Y=-1 K DIC,DIE,DR,DLAYGO Q
"RTN","MAGJMN3",34,0)
 S DIE=2006.67,DA=+Y,DR="1;3;4;5"
"RTN","MAGJMN3",35,0)
 S MAGIEN=DA
"RTN","MAGJMN3",36,0)
 D ^DIE I '$D(DA) G EECPT
"RTN","MAGJMN3",37,0)
 G EECPT
"RTN","MAGJMN3",38,0)
 Q
"RTN","MAGJMN3",39,0)
INCPT ; Inquire MAG RAD CPT MATCHING
"RTN","MAGJMN3",40,0)
 W @IOF,!!?10,"** Inquire VistARad CPT MATCHING CPT CODE **"
"RTN","MAGJMN3",41,0)
 N DATA,I,ZJ
"RTN","MAGJMN3",42,0)
INC1 W !! S DIC=2006.67,DIC(0)="AMEQ"
"RTN","MAGJMN3",43,0)
 D ^DIC I Y=-1 K DIC Q
"RTN","MAGJMN3",44,0)
 S DA=+Y,DATA=$P(Y,U,2)
"RTN","MAGJMN3",45,0)
 S DATA="CPT^"_DATA_"|"
"RTN","MAGJMN3",46,0)
 D DATADUMP^MAGJUTL4(.ZJ,DATA)
"RTN","MAGJMN3",47,0)
 W ! S T=+$G(@ZJ@(0)) F I=1:1:T S X=$G(^(I)) W !,X
"RTN","MAGJMN3",48,0)
 G INC1
"RTN","MAGJMN3",49,0)
 Q
"RTN","MAGJMN3",50,0)
PRCPT ;Print MAG RAD CPT MATCHING LOGIC
"RTN","MAGJMN3",51,0)
 N FLDS
"RTN","MAGJMN3",52,0)
 W @IOF,!!?10,"** Print VistARad CPT MATCHING CPT CODE **",!!
"RTN","MAGJMN3",53,0)
 W !! S DIC=2006.67,L=0,FLDS="[MAGJ CPT MATCH PRT]"
"RTN","MAGJMN3",54,0)
 D EN1^DIP
"RTN","MAGJMN3",55,0)
 R !,"Enter RETURN to continue: ",X:DTIME W !
"RTN","MAGJMN3",56,0)
 Q
"RTN","MAGJMN3",57,0)
 ;
"RTN","MAGJMN3",58,0)
END ;
"RTN","MAGJRPT")
0^8^B78502597
"RTN","MAGJRPT",1,0)
MAGJRPT ;WIRMFO/JHC - Display Rad reports ; 9 Sep 2011  4:05 PM
"RTN","MAGJRPT",2,0)
 ;;3.0;IMAGING;**18,101,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJRPT",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJRPT",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJRPT",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJRPT",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJRPT",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJRPT",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJRPT",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJRPT",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJRPT",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJRPT",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJRPT",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJRPT",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJRPT",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJRPT",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJRPT",17,0)
 ;;
"RTN","MAGJRPT",18,0)
 ; Subroutines for fetching Exam Info for VistaRad Workstation
"RTN","MAGJRPT",19,0)
 ;   RADRPT: Display Radiology Report -- RPC Call: MAGJ EXAM REPORT
"RTN","MAGJRPT",20,0)
 ;        ORD: Display Radiology Requisition -- RPC Call: MAGJ RADORDERDISP
"RTN","MAGJRPT",21,0)
 ;
"RTN","MAGJRPT",22,0)
 Q
"RTN","MAGJRPT",23,0)
ORD(MAGRPTY,DATA) ; Radiology Order Display
"RTN","MAGJRPT",24,0)
 ; RPC Call: MAGJ RADORDERDISP
"RTN","MAGJRPT",25,0)
 ; MAGRPTY holds indirect reference to returned data
"RTN","MAGJRPT",26,0)
 ; 
"RTN","MAGJRPT",27,0)
 S MAGRPTY=$NA(^TMP($J,"WSDAT")) K @MAGRPTY
"RTN","MAGJRPT",28,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJRPT"
"RTN","MAGJRPT",29,0)
 N RARPT,RADFN,RADTI,RACNI,RAPGE,RAX,RAOIFN
"RTN","MAGJRPT",30,0)
 N REPLY,POP,DFN,COMPLIC,XX,HDR,MAGRET,REQONLY,TMPDATA
"RTN","MAGJRPT",31,0)
 S REPLY="0^4~Attempting to display order info"
"RTN","MAGJRPT",32,0)
 D OPENDEV
"RTN","MAGJRPT",33,0)
 I POP S REPLY="0^4~Unable to open device 'IMAGING WORKSTATION'" G ORDZ
"RTN","MAGJRPT",34,0)
 S RADFN=$P(DATA,U),RADTI=$P(DATA,U,2),RACNI=$P(DATA,U,3)
"RTN","MAGJRPT",35,0)
 S RARPT=+$P(DATA,U,4),REQONLY=+$P(DATA,U,1,5)
"RTN","MAGJRPT",36,0)
 I RADFN,RADTI,RACNI
"RTN","MAGJRPT",37,0)
 E  S REPLY="0^4~Request Contains Invalid Case Pointer ("_RADFN_" "_RADTI_" "_RACNI_" "_RARPT_")." G ORDZ
"RTN","MAGJRPT",38,0)
 S RAOIFN=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),U,11)
"RTN","MAGJRPT",39,0)
 I RAOIFN,$D(^RAO(75.1,RAOIFN,0))
"RTN","MAGJRPT",40,0)
 E  S REPLY="0^2~Order Information is NOT Available for this exam." G ORDZ
"RTN","MAGJRPT",41,0)
 ; Check for Database integrity problems ONLY if Req was explicitly
"RTN","MAGJRPT",42,0)
 ; requested (No check for Auto_Display of Req, cuz Exam Open does ck)
"RTN","MAGJRPT",43,0)
 D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,"",.MAGRET)
"RTN","MAGJRPT",44,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)),XX=$G(^(2)),HDR=""
"RTN","MAGJRPT",45,0)
 S COMPLIC=$P(XX,U,4)      ;  Complications text
"RTN","MAGJRPT",46,0)
 F I=4,12,9 S HDR=HDR_$P(RADATA,U,I)_"   " ; PtName, Case #, Procedure
"RTN","MAGJRPT",47,0)
 I REQONLY D CKINTEG(.REPLY,RADFN,RADTI,RACNI,RARPT,RADATA) I REPLY]"" S REPLY="0^7~"_REPLY G ORDZ  ; Database integrity problems
"RTN","MAGJRPT",48,0)
 S TMPDATA=MAGRPTY_"~"_RADTI_"~"_RACNI
"RTN","MAGJRPT",49,0)
 S RAX="",RAPGE=0 D ^RAORD5
"RTN","MAGJRPT",50,0)
 S MAGRPTY=$P(TMPDATA,"~"),RADTI=$P(TMPDATA,"~",2),RACNI=$P(TMPDATA,"~",3)
"RTN","MAGJRPT",51,0)
 D:IO'=IO(0) ^%ZISC
"RTN","MAGJRPT",52,0)
 S @MAGRPTY@(1)="REQ: "_HDR
"RTN","MAGJRPT",53,0)
 D COMMENTS(RADFN,RADTI,RACNI,MAGRPTY,2,COMPLIC)
"RTN","MAGJRPT",54,0)
 D TIUNOTE(RARPT,MAGRPTY,10000) ; append TIU note to reply at node 10000
"RTN","MAGJRPT",55,0)
 S REPLY="1^OK"
"RTN","MAGJRPT",56,0)
 K ^TMP($J,"MAGRAEX")
"RTN","MAGJRPT",57,0)
ORDZ S @MAGRPTY@(0)=REPLY
"RTN","MAGJRPT",58,0)
 Q
"RTN","MAGJRPT",59,0)
 ;
"RTN","MAGJRPT",60,0)
COMMENTS(RADFN,RADTI,RACNI,MAGRPTY,DNODE,COMPLIC) ; add Complications & Tech Comments to output report
"RTN","MAGJRPT",61,0)
 ;  RADFN, RADTI, & RACNI identify exam
"RTN","MAGJRPT",62,0)
 ;  MAGRPTY is indirect reference wher output lines are to be stored
"RTN","MAGJRPT",63,0)
 ;  DNODE holds reference for starting node for lines of output
"RTN","MAGJRPT",64,0)
 ;  COMPLIC passes in complications data reference
"RTN","MAGJRPT",65,0)
 ;
"RTN","MAGJRPT",66,0)
 I +MAGJOB("USER",1)  ; Radiologist
"RTN","MAGJRPT",67,0)
 E  I $D(^VA(200,"ARC","T",+DUZ))  ; Rad Tech
"RTN","MAGJRPT",68,0)
 E  Q  ; Don't display for any other user type
"RTN","MAGJRPT",69,0)
 N QTMP,CT,XX S CT=0
"RTN","MAGJRPT",70,0)
 S @MAGRPTY@(DNODE)=" ",CT=CT+.01,@MAGRPTY@(DNODE+CT)="Complications: "_$S(COMPLIC:$P($G(^RA(78.1,+COMPLIC,0)),U),1:"")
"RTN","MAGJRPT",71,0)
 S X=$P(COMPLIC,"~",2)
"RTN","MAGJRPT",72,0)
 I X S CT=CT+.01,@MAGRPTY@(DNODE+CT)="   "_$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,"COMP")),U)
"RTN","MAGJRPT",73,0)
 K ^TMP($J,"RAE2") D SVTCOM^RAUTL11(RADFN,RADTI,RACNI)
"RTN","MAGJRPT",74,0)
 S QTMP="^TMP($J,""RAE2"")"
"RTN","MAGJRPT",75,0)
 F  S QTMP=$Q(@QTMP) Q:QTMP=""  Q:QTMP'["RAE2"  I QTMP["TCOM" D
"RTN","MAGJRPT",76,0)
 . S XX=@(QTMP) N HI,TXT,LINE1 S LINE1=0
"RTN","MAGJRPT",77,0)
 . F  Q:XX=""  S HI=$L(XX) S:HI>63 HI=63 F I=HI:-1:0 S:'I XX="" I HI<63!($E(XX,I)=" ") D  Q
"RTN","MAGJRPT",78,0)
 . . S TXT=$S('LINE1:"Tech Comments: ",1:"               ")_$E(XX,1,I),XX=$E(XX,I+1,999),LINE1=1
"RTN","MAGJRPT",79,0)
 . . I XX]"" F I=1:1:999 I $E(XX,I)'=" " S XX=$E(XX,I,999) Q
"RTN","MAGJRPT",80,0)
 . . S CT=CT+.01,@MAGRPTY@(DNODE+CT)=TXT
"RTN","MAGJRPT",81,0)
 K ^TMP($J,"RAE2")
"RTN","MAGJRPT",82,0)
 Q
"RTN","MAGJRPT",83,0)
 ;
"RTN","MAGJRPT",84,0)
TIUNOTE(RARPT,MAGRPTY,DNODE) ; FUT-70/IHS append Rad TIU Notes to report
"RTN","MAGJRPT",85,0)
 ; 1/2011--only works at IHS where TIU notes may exist for Radiology exams
"RTN","MAGJRPT",86,0)
 ; test for this by presence of DOCTEXT^BEHOTIU
"RTN","MAGJRPT",87,0)
 ;  RARPT--exam pointer
"RTN","MAGJRPT",88,0)
 ;  MAGRPTY--indirect reference to output file
"RTN","MAGJRPT",89,0)
 ;  DNODE--starting node for lines of output
"RTN","MAGJRPT",90,0)
 ;
"RTN","MAGJRPT",91,0)
 N CT,QTMP,TEXT,XX
"RTN","MAGJRPT",92,0)
 I RARPT,$L(MAGRPTY),DNODE,$L($T(DOCTEXT^BEHOTIU)) D
"RTN","MAGJRPT",93,0)
 . D DOCTEXT^BEHOTIU("TEXT",RARPT_";RARPT(")
"RTN","MAGJRPT",94,0)
 . I $D(TEXT) D
"RTN","MAGJRPT",95,0)
 . . S CT=0,QTMP="TEXT"
"RTN","MAGJRPT",96,0)
 . . S @MAGRPTY@(DNODE)=" "
"RTN","MAGJRPT",97,0)
 . . F  S QTMP=$Q(@QTMP) Q:QTMP=""  S XX=@(QTMP) S CT=CT+.01,@MAGRPTY@(DNODE+CT)=XX
"RTN","MAGJRPT",98,0)
 Q
"RTN","MAGJRPT",99,0)
 ;
"RTN","MAGJRPT",100,0)
OPENDEV ;
"RTN","MAGJRPT",101,0)
 N IOP,%ZIS
"RTN","MAGJRPT",102,0)
 S IOP="IMAGING WORKSTATION",%ZIS=0 D ^%ZIS
"RTN","MAGJRPT",103,0)
 I POP
"RTN","MAGJRPT",104,0)
 E  U IO
"RTN","MAGJRPT",105,0)
 Q
"RTN","MAGJRPT",106,0)
 ;
"RTN","MAGJRPT",107,0)
RADRPT(MAGRPTY,DATA) ; Display rad report; 1st must pass integrity checks
"RTN","MAGJRPT",108,0)
 ; Note: adds an additional line of output for the Report Window header
"RTN","MAGJRPT",109,0)
 ;  RPC is MAGJ EXAM REPORT
"RTN","MAGJRPT",110,0)
 ;
"RTN","MAGJRPT",111,0)
 ; MAGRPTY holds $NA reference to  return message; references to it use subscript indirection
"RTN","MAGJRPT",112,0)
 ;
"RTN","MAGJRPT",113,0)
 S MAGRPTY=$NA(^TMP($J,"MAGJRADRPT")) K @MAGRPTY
"RTN","MAGJRPT",114,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJRPT"
"RTN","MAGJRPT",115,0)
 N RARPT,RADATA,MAGDFN,MAGDTI,MAGCNI,X,MAGRET,HDR,REPLY,MAGPRC,COMPLIC,DNODE
"RTN","MAGJRPT",116,0)
 S MAGDFN=$P(DATA,U),MAGDTI=$P(DATA,U,2),MAGCNI=$P(DATA,U,3),RARPT=+$P(DATA,U,4)
"RTN","MAGJRPT",117,0)
 I '(MAGDFN&MAGDTI&MAGCNI) D  G RPTZ
"RTN","MAGJRPT",118,0)
 . S REPLY="0^4~Request Contains Invalid Case Pointer ("_MAGDFN_" "_MAGDTI_" "_MAGCNI_")."
"RTN","MAGJRPT",119,0)
 D GETEXAM2^MAGJUTL1(MAGDFN,MAGDTI,MAGCNI,"",.MAGRET)
"RTN","MAGJRPT",120,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1)),XX=$G(^(2)),HDR=""
"RTN","MAGJRPT",121,0)
 S COMPLIC=$P(XX,U,4)  ;  Complications text
"RTN","MAGJRPT",122,0)
 F I=4,12,9 S HDR=HDR_$P(RADATA,U,I)_"   "
"RTN","MAGJRPT",123,0)
 D CKINTEG(.REPLY,MAGDFN,MAGDTI,MAGCNI,RARPT,RADATA)
"RTN","MAGJRPT",124,0)
 I REPLY]"" S REPLY="0^7~"_REPLY G RPTZ  ; DB integ problem
"RTN","MAGJRPT",125,0)
 D EN3^RAO7PC3(MAGDFN_"^"_MAGDTI_"^"_MAGCNI)
"RTN","MAGJRPT",126,0)
 I '$D(^TMP($J,"RAE3")) S REPLY="0^4~No report on file." G RPTZ
"RTN","MAGJRPT",127,0)
 D COMMENTS(MAGDFN,MAGDTI,MAGCNI,MAGRPTY,2,COMPLIC)
"RTN","MAGJRPT",128,0)
 S MAGPRC=$O(^TMP($J,"RAE3",MAGDFN,MAGCNI,"")),I=0,DNODE=2
"RTN","MAGJRPT",129,0)
 F  S I=$O(^TMP($J,"RAE3",MAGDFN,MAGCNI,MAGPRC,I)) Q:'I  D
"RTN","MAGJRPT",130,0)
 . S DNODE=DNODE+1
"RTN","MAGJRPT",131,0)
 . S @MAGRPTY@(DNODE)=$G(^TMP($J,"RAE3",MAGDFN,MAGCNI,MAGPRC,I))
"RTN","MAGJRPT",132,0)
 F I=1:1:4  S DNODE=DNODE+1,@MAGRPTY@(DNODE)=$S(I'=3:"",1:"** END REPORT "_$$FMTE^XLFDT($$NOW^XLFDT,"1P")_" **")
"RTN","MAGJRPT",133,0)
 D TIUNOTE(RARPT,MAGRPTY,10000) ; append TIU note to reply at node 10000
"RTN","MAGJRPT",134,0)
 S REPLY="1^1~Radiology Report"
"RTN","MAGJRPT",135,0)
RPTZ S @MAGRPTY@(0)=REPLY
"RTN","MAGJRPT",136,0)
 I +$G(@MAGRPTY@(0)) S @MAGRPTY@(1)="RPT: "_HDR ; if a report exists, add header line to output
"RTN","MAGJRPT",137,0)
 K ^TMP($J,"MAGRAEX"),^("RAE3")
"RTN","MAGJRPT",138,0)
 Q
"RTN","MAGJRPT",139,0)
 ;
"RTN","MAGJRPT",140,0)
CKINTEG(REPLY,RADFN,RADTI,RACNI,RARPT,RADATA) ; check integrity between Exam, Report, and Image Group Headers
"RTN","MAGJRPT",141,0)
 ; This subroutine is used by other vrad programs
"RTN","MAGJRPT",142,0)
 ;
"RTN","MAGJRPT",143,0)
 N IEN,MAGIEN,MIXEDUP,X,CKDFN,CKACN
"RTN","MAGJRPT",144,0)
 S MIXEDUP=0,REPLY=""
"RTN","MAGJRPT",145,0)
 I RARPT D  G CK2:MIXEDUP
"RTN","MAGJRPT",146,0)
 . S X=$G(^RARPT(RARPT,0)),CKDFN=$P(X,U,2),CKACN=$P(X,U,4)
"RTN","MAGJRPT",147,0)
 . I CKDFN'=RADFN S MIXEDUP=1_U_+CKDFN Q
"RTN","MAGJRPT",148,0)
 . I $G(RADATA)]"" D
"RTN","MAGJRPT",149,0)
 . . I $P(RADATA,U,8)'=CKACN D
"RTN","MAGJRPT",150,0)
 . . . N MAGPSET,RAPRTSET,ACN,OK S OK=0
"RTN","MAGJRPT",151,0)
 . . . S RAPRTSET=0 D EN2^RAUTL20(.MAGPSET) I RAPRTSET D
"RTN","MAGJRPT",152,0)
 . . . . N I S I=0 F  S I=$O(MAGPSET(I)) Q:'I  I +MAGPSET(I)=CKACN S OK=1 Q
"RTN","MAGJRPT",153,0)
 . . . I 'OK S MIXEDUP=5_U_CKACN_U_$P(RADATA,U,8)
"RTN","MAGJRPT",154,0)
 I $D(^RARPT(+RARPT,2005)) S IEN=0 D  G CK2:MIXEDUP
"RTN","MAGJRPT",155,0)
 . F  S IEN=$O(^RARPT(RARPT,2005,IEN)) Q:'IEN  S MAGIEN=+$G(^(IEN,0)) D  Q:MIXEDUP
"RTN","MAGJRPT",156,0)
 . . S X=$P($G(^MAG(2005,MAGIEN,0)),U,7) I X'=RADFN S MIXEDUP=2_U_+X Q
"RTN","MAGJRPT",157,0)
 . . S X=$P($G(^MAG(2005,MAGIEN,2)),U,7) I X'=RARPT S MIXEDUP=3_U_+X Q
"RTN","MAGJRPT",158,0)
CK2 I 'MIXEDUP Q  ; no problems detected
"RTN","MAGJRPT",159,0)
 I +MIXEDUP=1!(+MIXEDUP=2) D  Q
"RTN","MAGJRPT",160,0)
 . S X=$$PNAM^MAGJEX1($P(MIXEDUP,U,2))
"RTN","MAGJRPT",161,0)
 . I +MIXEDUP=1 S REPLY="The Exam file for this exam has patient "_$$PNAM^MAGJEX1(RADFN)_"; the corresponding Report file has patient "_X_".  This is a serious problem--immediately report it to Radiology management and Imaging support!"
"RTN","MAGJRPT",162,0)
 . I +MIXEDUP=2 S REPLY="This exam is registered for "_$$PNAM^MAGJEX1(RADFN)_"; however, it is linked to images for patient "_X_".  This is a serious problem--immediately report it to Radiology management and Imaging support staff!"
"RTN","MAGJRPT",163,0)
 I +MIXEDUP=3 D  Q
"RTN","MAGJRPT",164,0)
 . N T S T=$P(MIXEDUP,U,2) S:'T T="Missing Link"
"RTN","MAGJRPT",165,0)
 . S REPLY="This exam is linked to Report entry #"_RARPT_", but some of its images may be linked to Report entry #"_T_".  This is a potentially serious problem--immediately report it to Radiology management and Imaging support staff!"
"RTN","MAGJRPT",166,0)
 I +MIXEDUP=4 D  Q
"RTN","MAGJRPT",167,0)
 . N T S T=$P(MIXEDUP,U,2) S:'T T="Missing Reference"
"RTN","MAGJRPT",168,0)
 . S X=" ("_RARPT_" and "_T_" )"
"RTN","MAGJRPT",169,0)
 . S REPLY="This exam has problems in the Radiology Report file, with two different report entries referenced"_X_".  This is a potentially serious problem--immediately report it to Radiology management and Imaging support staff!"
"RTN","MAGJRPT",170,0)
 I +MIXEDUP=5 D  Q
"RTN","MAGJRPT",171,0)
 . N T S X=$P(MIXEDUP,U,2) S:X="" X="Missing"
"RTN","MAGJRPT",172,0)
 . S T=$P(MIXEDUP,U,3) S:T="" T="Missing"
"RTN","MAGJRPT",173,0)
 . S X=" ("_X_" and "_T_") "
"RTN","MAGJRPT",174,0)
 . S REPLY="This exam has problems in the Radiology files, with two different Case Numbers referenced"_X_".  This is a potentially serious problem--immediately report it to Radiology management and Imaging support staff!"
"RTN","MAGJRPT",175,0)
 Q
"RTN","MAGJRPT",176,0)
 ;
"RTN","MAGJRPT",177,0)
ERR ;
"RTN","MAGJRPT",178,0)
 S @MAGRPTY@(0)="0^ERROR "_$$EC^%ZOSV
"RTN","MAGJRPT",179,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJRPT",180,0)
 Q:$Q 1  Q
"RTN","MAGJRPT",181,0)
END ;
"RTN","MAGJTU4V")
0^9^B5203794
"RTN","MAGJTU4V",1,0)
MAGJTU4V ;WOIFO/MAT - VERSION CONTROL (VISTARAD) ; 24 Apr 2012  7:35 PM
"RTN","MAGJTU4V",2,0)
 ;;3.0;IMAGING;**90,115,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJTU4V",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJTU4V",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJTU4V",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJTU4V",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJTU4V",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJTU4V",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJTU4V",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJTU4V",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJTU4V",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJTU4V",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJTU4V",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJTU4V",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJTU4V",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJTU4V",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJTU4V",17,0)
 ;;
"RTN","MAGJTU4V",18,0)
 ; This routine contains the version control code and data specific
"RTN","MAGJTU4V",19,0)
 ; to the VistARad application. DO NOT ADD ANYTHING ELSE!
"RTN","MAGJTU4V",20,0)
 Q
"RTN","MAGJTU4V",21,0)
 ;
"RTN","MAGJTU4V",22,0)
CLVERCT ;***** VERSION CONTROL TABLE FOR THE VistARad CLIENTS
"RTN","MAGJTU4V",23,0)
 ;;==================================================================
"RTN","MAGJTU4V",24,0)
 ;;| Version |Build|Seq #|                Comment                   |
"RTN","MAGJTU4V",25,0)
 ;;|---------+-----+------------------------------------------------|
"RTN","MAGJTU4V",26,0)
 ;;| 3.0.120 |   8 |  ?? | Jul 2012  <*> Projected Seq # & Release  |
"RTN","MAGJTU4V",27,0)
 ;;| 3.0.115 |   4 |  73 | Mar 2011                                 |
"RTN","MAGJTU4V",28,0)
 ;;| 3.0.90  |   9 |  66 | Aug 2010                                 |
"RTN","MAGJTU4V",29,0)
 ;;| 3.0.101 |  10 |  61 | Feb 2010                                 |
"RTN","MAGJTU4V",30,0)
 ;;==================================================================
"RTN","MAGJTU4V",31,0)
 ;
"RTN","MAGJTU4V",32,0)
 ; Each row of the version control table contains the version and
"RTN","MAGJTU4V",33,0)
 ; build number of a supported client. Released patches must also
"RTN","MAGJTU4V",34,0)
 ; indicate the sequential numbers.
"RTN","MAGJTU4V",35,0)
 ;
"RTN","MAGJTU4V",36,0)
 ; Sort order of the rows does not matter. However, the reversed
"RTN","MAGJTU4V",37,0)
 ; order of patch sequential numbers is recommended.
"RTN","MAGJTU4V",38,0)
 ;
"RTN","MAGJTU4V",39,0)
 Q
"RTN","MAGJTU4V",40,0)
 ;
"RTN","MAGJTU4V",41,0)
 ;***** ADDS A CLIENT-SPECIFIC WARNING (IF NECESSARY)
"RTN","MAGJTU4V",42,0)
 ;
"RTN","MAGJTU4V",43,0)
 ; .MAGBUF       Reference to a local array that the warning text
"RTN","MAGJTU4V",44,0)
 ;               is returned to. It is appended to the RPC result
"RTN","MAGJTU4V",45,0)
 ;               array by the caller (WARNING^MAGGTU41).
"RTN","MAGJTU4V",46,0)
 ;
"RTN","MAGJTU4V",47,0)
 ; CLVER         Client application version (Major.Minor.Patch.Build)
"RTN","MAGJTU4V",48,0)
 ;
"RTN","MAGJTU4V",49,0)
 ; CVRC          Version check code returned by the $$CHKVER1^MAGGTU41
"RTN","MAGJTU4V",50,0)
 ;
"RTN","MAGJTU4V",51,0)
 ; Notes
"RTN","MAGJTU4V",52,0)
 ; =====
"RTN","MAGJTU4V",53,0)
 ;
"RTN","MAGJTU4V",54,0)
 ; If the RPC result array already contains an error message that
"RTN","MAGJTU4V",55,0)
 ; will terminate the client, application, this procedure is not
"RTN","MAGJTU4V",56,0)
 ; called.
"RTN","MAGJTU4V",57,0)
 ;
"RTN","MAGJTU4V",58,0)
WARNING(MAGBUF,CLVER,CVRC) ;
"RTN","MAGJTU4V",59,0)
 Q
"RTN","MAGJUPD1")
0^10^B61960961
"RTN","MAGJUPD1",1,0)
MAGJUPD1 ;WOIFO/JHC - VistARad Update Exam Status ; 9 Sep 2011  4:05 PM
"RTN","MAGJUPD1",2,0)
 ;;3.0;IMAGING;**16,22,18,76,101,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJUPD1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJUPD1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUPD1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJUPD1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJUPD1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJUPD1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJUPD1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJUPD1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJUPD1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJUPD1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJUPD1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJUPD1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJUPD1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJUPD1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUPD1",17,0)
 ;;
"RTN","MAGJUPD1",18,0)
 Q
"RTN","MAGJUPD1",19,0)
 ; Subroutines for RPC's to update Exam Status to "Interpreted", and
"RTN","MAGJUPD1",20,0)
 ;   for "Closing" a case that is open on the DX Workstation
"RTN","MAGJUPD1",21,0)
 ;
"RTN","MAGJUPD1",22,0)
ERR N ERR S ERR=$$EC^%ZOSV S @MAGGRY@(0)="0^Server Program Error: "_ERR
"RTN","MAGJUPD1",23,0)
 D @^%ZOSF("ERRTN")
"RTN","MAGJUPD1",24,0)
 Q:$Q 1  Q
"RTN","MAGJUPD1",25,0)
 ;
"RTN","MAGJUPD1",26,0)
STATUS(MAGGRY,PARAMS,DATA) ; rpc: MAGJ RADSTATUSUPDATE
"RTN","MAGJUPD1",27,0)
 ; Update Exam Status to "Interpreted" and/or Close the exam
"RTN","MAGJUPD1",28,0)
 ; Only updates the Status if the current value is "Examined"
"RTN","MAGJUPD1",29,0)
 ; This routine defines variables needed for calling the Radiology
"RTN","MAGJUPD1",30,0)
 ; package routine UP1^RAUTL1, for filing Status updates
"RTN","MAGJUPD1",31,0)
 ;
"RTN","MAGJUPD1",32,0)
 ; PARAMS = UPDFLAG ^ RADFN ^ RADTI ^ RACNI ^ RARPT ^ UPDPSKEY
"RTN","MAGJUPD1",33,0)
 ;   UPDFLAG = 1/0 -- 1 to perform update; else no update made
"RTN","MAGJUPD1",34,0)
 ;   RARPT = ptr to Rad Exam Report file
"RTN","MAGJUPD1",35,0)
 ;   RADFN,RADTI,RACNI = pointers to Rad Patient File for the exam
"RTN","MAGJUPD1",36,0)
 ;   UPDPSKEY = 1/0 -- 1 to update Presentation State &/or Key Image data
"RTN","MAGJUPD1",37,0)
 ;                   = 2 -- update PS data with NO lock in place--Resident workflow, or Sec Key Override
"RTN","MAGJUPD1",38,0)
 ;   DATA = optional array containing prezentation state data; see SAVKPS^MAGJUPD2 for description
"RTN","MAGJUPD1",39,0)
 ;   MAGGRY = return results in @MAGGRY
"RTN","MAGJUPD1",40,0)
 ;
"RTN","MAGJUPD1",41,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJUPD1"
"RTN","MAGJUPD1",42,0)
 N RARPT,RADFN,RADTI,RACNI,RAEXT,RACNE,RADTE,RAINT,RAMDV,DIQUIET
"RTN","MAGJUPD1",43,0)
 N RAONLINE,ZTQUEUED,RAOR,RASN,RASTI,RAPRTSET,LOGDATA,RSL,TIMESTMP
"RTN","MAGJUPD1",44,0)
 N UPDPSKEY,MAGRET,MAGLST,REPLY,UPDFLAG,RADATA,RIST,MAGPSET,RACNILST,ACNLST
"RTN","MAGJUPD1",45,0)
 N PSETLST
"RTN","MAGJUPD1",46,0)
 S MAGLST="MAGJUPDATE"
"RTN","MAGJUPD1",47,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)) K @MAGGRY  ; assign MAGGRY value
"RTN","MAGJUPD1",48,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJUPD1",49,0)
 S TIMESTMP=$$NOW^XLFDT()
"RTN","MAGJUPD1",50,0)
 S UPDFLAG=$P(PARAMS,U),RADFN=$P(PARAMS,U,2),RADTI=$P(PARAMS,U,3),RACNI=$P(PARAMS,U,4),RARPT=$P(PARAMS,U,5),UPDPSKEY=+$P(PARAMS,U,6)
"RTN","MAGJUPD1",51,0)
 S REPLY="0^4~Closing case with"_$S(UPDFLAG:"",1:" NO")_" Status Update"
"RTN","MAGJUPD1",52,0)
 S RAPRTSET=0
"RTN","MAGJUPD1",53,0)
 I RADFN,RADTI,RACNI
"RTN","MAGJUPD1",54,0)
 E  S REPLY="0^4~Request Contains Invalid Case Pointer ("_RARPT_")" G STATUSZ
"RTN","MAGJUPD1",55,0)
 D GETEXAM2^MAGJUTL1(RADFN,RADTI,RACNI,0,.MAGRET)
"RTN","MAGJUPD1",56,0)
 I 'MAGRET S REPLY="0^4~Current Case Not Accessible for Updating" G STATUSZ
"RTN","MAGJUPD1",57,0)
 ; 1  RADFN   RADTI    RACNI   RANME   RASSN    <--Contents of RADATA,
"RTN","MAGJUPD1",58,0)
 ; 6  RADATE  RADTE    RACN    RAPRC   RARPT         from GETEXAM
"RTN","MAGJUPD1",59,0)
 ;11  RAST    DAYCASE  RAELOC  RASTP   RASTORD
"RTN","MAGJUPD1",60,0)
 ;16  RADTPRT
"RTN","MAGJUPD1",61,0)
 S RADATA=$G(^TMP($J,"MAGRAEX",1,1))
"RTN","MAGJUPD1",62,0)
 S RAEXT=$P(RADATA,U,12),RACNE=$P(RAEXT,"-",2),RADTE=$P(RADATA,U,7)
"RTN","MAGJUPD1",63,0)
 S RAINT=RADTI_"-"_RACNI
"RTN","MAGJUPD1",64,0)
 I UPDPSKEY=2 D  G STATUSZ ; P101 update annotations only, if authorized (Resident workflow, or Sec Key Override)
"RTN","MAGJUPD1",65,0)
 . I +MAGJOB("USER",1),'UPDFLAG,($D(DATA)>9) S REPLY="0^1~Case #"_RAEXT_" Closed; No Status Update; annotation updates performed."
"RTN","MAGJUPD1",66,0)
 . E  S UPDPSKEY=0,REPLY="0^4~Invalid request to update annotations for Case #"_RAEXT_"."
"RTN","MAGJUPD1",67,0)
 D CLOSE(.RSL,RADFN_U_RADTI_U_RACNI_U_U_1,.LOGDATA) ; unlock the case
"RTN","MAGJUPD1",68,0)
 ; proceed only if case was locked by this user
"RTN","MAGJUPD1",69,0)
 ;   if it was not Locked, then do NOT update PS, Key Images
"RTN","MAGJUPD1",70,0)
 I 'RSL S REPLY=RSL,UPDPSKEY=0 G STATUSZ
"RTN","MAGJUPD1",71,0)
 I 'UPDFLAG S REPLY="0^1~Case #"_RAEXT_" Closed; No Status Update performed" G STATUSZ
"RTN","MAGJUPD1",72,0)
 S RIST=$P(RSL,U,2) ; CLOSE reports back the type of radiologist
"RTN","MAGJUPD1",73,0)
 ; now we know this user had locked the case, & wants to do Status update
"RTN","MAGJUPD1",74,0)
 D EN2^RAUTL20(.MAGPSET)  ; get info re rad PrintSet
"RTN","MAGJUPD1",75,0)
 ; Note--above call also sets variable RAPRTSET
"RTN","MAGJUPD1",76,0)
 ;
"RTN","MAGJUPD1",77,0)
 ; IF exam is not "Examined", and not "Cancelled" and past "Waiting"
"RTN","MAGJUPD1",78,0)
 ;    then assume it has already been updated via another pathway,
"RTN","MAGJUPD1",79,0)
 ;    either as printset member (via code below--see PRTSET note...),
"RTN","MAGJUPD1",80,0)
 ;    or from a voice-dictation or terminal session by the radiologist
"RTN","MAGJUPD1",81,0)
 ;    For these cases, no warning msg is sent
"RTN","MAGJUPD1",82,0)
 ; Else, update not allowed, so give warning msg
"RTN","MAGJUPD1",83,0)
 ; Note that when the Exam was OPENed, it must have had status "Examined"
"RTN","MAGJUPD1",84,0)
 I '$D(^RA(72,"AVC","E",$P(RADATA,U,11))) D  G STATUSX:(+$P(REPLY,U,2)=1),STATUSZ  ; Current Status MUST be "Examined" Category
"RTN","MAGJUPD1",85,0)
 . I $P(RADATA,U,15)>2 D  ; assume update has otherwise been done, eg voice dictation or manual entry in Vista
"RTN","MAGJUPD1",86,0)
 . . S RACNILST=RACNI,RASTI=$P(RADATA,U,11) ; need for code at tag statusx
"RTN","MAGJUPD1",87,0)
 . . I RAPRTSET S REPLY="0^1~Printset Exams with Case #"_RAEXT_" have been updated"
"RTN","MAGJUPD1",88,0)
 . . E  S REPLY="0^1~No Update done for Case #"_RAEXT_"--current status is "_$P(RADATA,U,14)
"RTN","MAGJUPD1",89,0)
 . E  S REPLY="0^3~No Update Allowed for Case #"_RAEXT_"--current status is "_$P(RADATA,U,14)
"RTN","MAGJUPD1",90,0)
 ;
"RTN","MAGJUPD1",91,0)
 ; now ready to update exam status
"RTN","MAGJUPD1",92,0)
 S RAMDV=$P(^RADPT(RADFN,"DT",RADTI,0),U,3)
"RTN","MAGJUPD1",93,0)
 S RAMDV=$TR(^RA(79,RAMDV,.1),"YyNn","1100")
"RTN","MAGJUPD1",94,0)
 ;
"RTN","MAGJUPD1",95,0)
 ; Update interpreting radiologist field in Rad file
"RTN","MAGJUPD1",96,0)
 I RIST D  I RACNILST="" G STATUSZ
"RTN","MAGJUPD1",97,0)
 . N SAVRACNI,RTN S RACNILST=""
"RTN","MAGJUPD1",98,0)
 . ; PRTSET note: if exam is part of Rad Print-Set, then update all exams of printset
"RTN","MAGJUPD1",99,0)
 . I RAPRTSET D
"RTN","MAGJUPD1",100,0)
 . . S ACNLST="",SAVRACNI=RACNI,X=0
"RTN","MAGJUPD1",101,0)
 . . F I=0:1 S X=$O(MAGPSET(X)) Q:'X  S RACNILST=RACNILST_$S(I:U,1:"")_X S:RACNE'=+MAGPSET(X) ACNLST=ACNLST_", "_"-"_+MAGPSET(X)
"RTN","MAGJUPD1",102,0)
 . E  S RACNILST=RACNI
"RTN","MAGJUPD1",103,0)
 . F I=1:1:$L(RACNILST,U) S RACNI=$P(RACNILST,U,I) I RACNI D  I RACNILST="" Q
"RTN","MAGJUPD1",104,0)
 . . S DA(2)=RADFN,DA(1)=RADTI,DA=RACNI
"RTN","MAGJUPD1",105,0)
 . . D STUFPHY^RARIC1(DUZ,RIST,.RTN)
"RTN","MAGJUPD1",106,0)
 . . I 'RTN S REPLY="0^4~Unable to update Interpreting Radiologist: "_RTN_"." S RACNILST=""
"RTN","MAGJUPD1",107,0)
 . I RAPRTSET S RACNI=SAVRACNI
"RTN","MAGJUPD1",108,0)
 S RAONLINE=1,ZTQUEUED=1 D UP1^RAUTL1   ; Suppress msgs, do Status update
"RTN","MAGJUPD1",109,0)
 ;<*> K RAONLINE,ZTQUEUED D UP1^RAUTL1 ; <*> Testing Only: ENABLE msgs
"RTN","MAGJUPD1",110,0)
 I RAOR<0 S REPLY="0^3~Exam Status for Case #"_RAEXT_" CANNOT be updated; current status remains: "_$S($G(RASN)]"":RASN,1:"Unknown")
"RTN","MAGJUPD1",111,0)
 I  G STATUSZ
"RTN","MAGJUPD1",112,0)
 ;
"RTN","MAGJUPD1",113,0)
 S REPLY="0^1~For Case #"_$S($G(ACNLST)]"":"s ",1:"")_RAEXT_$S(RAPRTSET:ACNLST,1:"")_", Exam Status updated to "_RASN
"RTN","MAGJUPD1",114,0)
 ;
"RTN","MAGJUPD1",115,0)
STATUSX ; Newly Interpreted exam:
"RTN","MAGJUPD1",116,0)
 ; Log the Interpreted event; Printset logging includes all printset members
"RTN","MAGJUPD1",117,0)
 S PSETLST=""
"RTN","MAGJUPD1",118,0)
 I RAPRTSET S X="" D
"RTN","MAGJUPD1",119,0)
 . F I=0:1 S X=$O(MAGPSET(X)) Q:'X  S PSETLST=PSETLST_$S(I:U,1:"")_+MAGPSET(X)
"RTN","MAGJUPD1",120,0)
 D LOG^MAGJUTL3("VR-INT",LOGDATA,PSETLST)
"RTN","MAGJUPD1",121,0)
 ; Update Recent Exams List
"RTN","MAGJUPD1",122,0)
 G STATUSZ:'$P(^MAG(2006.69,1,0),U,8)  ; no bkgnd compile enabled
"RTN","MAGJUPD1",123,0)
 L +^XTMP("MAGJ2","RECENT"):5
"RTN","MAGJUPD1",124,0)
 E  G STATUSZ
"RTN","MAGJUPD1",125,0)
 N INDX F I=1:1:$L(RACNILST,U) S RACNI=$P(RACNILST,U,I) I RACNI D
"RTN","MAGJUPD1",126,0)
 . S INDX=+$G(^XTMP("MAGJ2","RECENT",0))+1,$P(^(0),U)=INDX,^(INDX)=RADFN_U_RADTI_U_RACNI_U_RASTI
"RTN","MAGJUPD1",127,0)
 L -^XTMP("MAGJ2","RECENT")
"RTN","MAGJUPD1",128,0)
STATUSZ ;
"RTN","MAGJUPD1",129,0)
 ; store PS, Key Image data
"RTN","MAGJUPD1",130,0)
 I UPDPSKEY,($D(DATA)>9) D
"RTN","MAGJUPD1",131,0)
 . D SAVKPS^MAGJUPD2(RARPT,UPDPSKEY,.DATA,.X)
"RTN","MAGJUPD1",132,0)
 . S REPLY=REPLY_$P(X,"~",2,99)
"RTN","MAGJUPD1",133,0)
 S @MAGGRY@(0)=REPLY
"RTN","MAGJUPD1",134,0)
 K ^TMP($J,"MAGRAEX"),^("RAE1")
"RTN","MAGJUPD1",135,0)
 Q
"RTN","MAGJUPD1",136,0)
 ;
"RTN","MAGJUPD1",137,0)
CLOSE(RSL,PARAMS,LOGDATA) ; Close/unlock a case
"RTN","MAGJUPD1",138,0)
 ; Input: PARAMS = DFN ^ DTI ^ CNI ^ RPT ^ UPDFLAG
"RTN","MAGJUPD1",139,0)
 ;
"RTN","MAGJUPD1",140,0)
 ;  DFN,DTI,CNI,RPT = pointers to Rad File for the exam
"RTN","MAGJUPD1",141,0)
 ;   UPDFLAG = 1/0 -- 1 indicates CLOSE was called from subroutine
"RTN","MAGJUPD1",142,0)
 ;                    STATUS, above (which has already called GETEXAM)
"RTN","MAGJUPD1",143,0)
 ;    RSL = return result of the Close
"RTN","MAGJUPD1",144,0)
 ; This subroutine may be called directly (to close a case without
"RTN","MAGJUPD1",145,0)
 ; doing a status update), or is called from tag STATUS, above, when
"RTN","MAGJUPD1",146,0)
 ; also doing a status update
"RTN","MAGJUPD1",147,0)
 ;
"RTN","MAGJUPD1",148,0)
 N $ETRAP,$ESTACK S $ETRAP="D ERR^MAGJUPD1"
"RTN","MAGJUPD1",149,0)
 N RPT,DFN,DTI,CNI,MAGRET,REPLY,RARPT,UPDFLAG,RIST,DAYCASE,NLOCKS,MYLOCK
"RTN","MAGJUPD1",150,0)
 S DFN=$P(PARAMS,U),DTI=$P(PARAMS,U,2),CNI=$P(PARAMS,U,3),RPT=$P(PARAMS,U,4),UPDFLAG=$P(PARAMS,U,5)
"RTN","MAGJUPD1",151,0)
 S LOGDATA=""
"RTN","MAGJUPD1",152,0)
 I $P($G(^MAG(2006.69,1,0)),U,4)
"RTN","MAGJUPD1",153,0)
 E  S REPLY=$S(UPDFLAG:"0^3~Updates not allowed at this site--no action taken",1:"") G CLOSEZ   ;   Status Update NOT Enabled
"RTN","MAGJUPD1",154,0)
 S RIST=+MAGJOB("USER",1) I RIST
"RTN","MAGJUPD1",155,0)
 E  S REPLY=$S(UPDFLAG:"0^3~Update allowed only by a radiologist--no action taken",1:"") G CLOSEZ  ; need only unlock a radiologist
"RTN","MAGJUPD1",156,0)
 I DFN,DTI,CNI
"RTN","MAGJUPD1",157,0)
 E  S REPLY="0^4~Request Contains Invalid Case Pointer ("_RPT_")--no action taken" G CLOSEZ
"RTN","MAGJUPD1",158,0)
 ;
"RTN","MAGJUPD1",159,0)
 I 'UPDFLAG N RADATA D  I 'MAGRET G CLOSEZ
"RTN","MAGJUPD1",160,0)
 . D GETEXAM2^MAGJUTL1(DFN,DTI,CNI,0,.MAGRET)
"RTN","MAGJUPD1",161,0)
 . I 'MAGRET S REPLY="0^4~No Current Case accessible to close--no action taken"
"RTN","MAGJUPD1",162,0)
 . E  S RADATA=$G(^TMP($J,"MAGRAEX",1,1))
"RTN","MAGJUPD1",163,0)
 S RARPT=$P(RADATA,U,10),DAYCASE=$P(RADATA,U,12)
"RTN","MAGJUPD1",164,0)
 I RARPT,DAYCASE
"RTN","MAGJUPD1",165,0)
 E  S REPLY="0^4~Current Case not accessible to close--no action taken" G CLOSEZ
"RTN","MAGJUPD1",166,0)
 ;
"RTN","MAGJUPD1",167,0)
 D LOCKACT^MAGJEX1A(RARPT,DAYCASE,101,,.MYLOCK)
"RTN","MAGJUPD1",168,0)
 S LOGDATA=$P(MYLOCK(1),"|",2)
"RTN","MAGJUPD1",169,0)
 I 'MYLOCK(1) S X=$P(MYLOCK(1),U,4) D  S LOGDATA="" G CLOSEZ
"RTN","MAGJUPD1",170,0)
 . I UPDFLAG S REPLY="0^1~Case #"_DAYCASE_$S(X]"":" locked by "_X,1:" not locked by "_$P(MAGJOB("USER",1),U,2))_"--No Status update performed"
"RTN","MAGJUPD1",171,0)
 . E  S REPLY="0^1~ "  ; case wasn't opened by this R'ist; nothing to do
"RTN","MAGJUPD1",172,0)
 ;
"RTN","MAGJUPD1",173,0)
 I UPDFLAG S REPLY=1_U_RIST
"RTN","MAGJUPD1",174,0)
 E  S REPLY="0^1~Case #"_DAYCASE_$S(+MYLOCK(1):" unlocked",+MYLOCK(2):" reserve cancelled",1:" closed")_"--No Status Update performed."
"RTN","MAGJUPD1",175,0)
CLOSEZ S RSL=REPLY
"RTN","MAGJUPD1",176,0)
 Q
"RTN","MAGJUPD1",177,0)
 ;
"RTN","MAGJUPD1",178,0)
END Q  ;
"RTN","MAGJUTL2")
0^11^B55943912
"RTN","MAGJUTL2",1,0)
MAGJUTL2 ;WIRMFO/JHC - VistRad subroutines for RPC calls ; 9 Sep 2011  4:05 PM
"RTN","MAGJUTL2",2,0)
 ;;3.0;IMAGING;**18,65,76,104,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJUTL2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJUTL2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJUTL2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJUTL2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJUTL2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJUTL2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJUTL2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJUTL2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJUTL2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJUTL2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJUTL2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJUTL2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJUTL2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL2",17,0)
 ;;
"RTN","MAGJUTL2",18,0)
 Q
"RTN","MAGJUTL2",19,0)
IMGINFO(RARPT,RET) ; Fetch info from Image File for input RARPT:
"RTN","MAGJUTL2",20,0)
 ; Input: RARPT: Rad Report pointer
"RTN","MAGJUTL2",21,0)
 ; RET contents delimited by ^:
"RTN","MAGJUTL2",22,0)
 ;   CT = # of images for case
"RTN","MAGJUTL2",23,0)
 ;   ONL = Image Storage status (Y=On Magnetic disk, N=Jukebox
"RTN","MAGJUTL2",24,0)
 ;             "n/a"  for not available, e.g., film only)
"RTN","MAGJUTL2",25,0)
 ;             note -- if last image in group is Online, considers ALL online
"RTN","MAGJUTL2",26,0)
 ;   MAGDT = Date/Time of Image Capture
"RTN","MAGJUTL2",27,0)
 ;   REMOTE = 1/0 to Indicate images were remotely cached
"RTN","MAGJUTL2",28,0)
 ;   MODALITY = Modality abbrev
"RTN","MAGJUTL2",29,0)
 ;   PLACE = Image storage PLace (ptr to 2006.1 entry)
"RTN","MAGJUTL2",30,0)
 ;   KEY = 1/0 ind. Key Images exist for this exam
"RTN","MAGJUTL2",31,0)
 ; 
"RTN","MAGJUTL2",32,0)
 N IRPT,MAGIEN,MAGIEN2,ONLCHK,NETLOC,STIEN
"RTN","MAGJUTL2",33,0)
 N CT,ONL,MAGDT,REMOTE,MODALITY,PLACE,REMCHK,KEY,TDT
"RTN","MAGJUTL2",34,0)
 S CT="",ONL="",MAGDT="",RET="",REMOTE="",MODALITY="",PLACE="",KEY=0 ; init return vars
"RTN","MAGJUTL2",35,0)
 G IMGINFQ:'RARPT G IMGINFQ:'$D(^RARPT(RARPT,2005,0))
"RTN","MAGJUTL2",36,0)
 S STIEN=$$STUDYID^MAGJUPD2("",RARPT,1)
"RTN","MAGJUTL2",37,0)
 I STIEN S T=$O(^MAG(2005,STIEN,205,0)) I T S KEY=1
"RTN","MAGJUTL2",38,0)
 S IRPT=0 F  S IRPT=$O(^RARPT(RARPT,2005,IRPT)) Q:'IRPT  S MAGIEN=$P(^(IRPT,0),U) D
"RTN","MAGJUTL2",39,0)
 . Q:'$D(^MAG(2005,MAGIEN,0))
"RTN","MAGJUTL2",40,0)
 . S TDT=$P($G(^MAG(2005,MAGIEN,100)),U,6) S:TDT="" TDT=$P($G(^(2)),U)
"RTN","MAGJUTL2",41,0)
 . I TDT S MAGDT=$S(MAGDT="":TDT,TDT<MAGDT:TDT,1:MAGDT)
"RTN","MAGJUTL2",42,0)
 . I $O(^MAG(2005,MAGIEN,1,0)) S CT=CT+$P(^(0),U,4),Y=$P(^(0),U,3),MAGIEN2=$P($G(^(Y,0)),U) S:(MAGIEN2]"") ONLCHK=$$ONLCHK(MAGIEN2),REMCHK=$$REMOTE(MAGIEN2) ; last image in group
"RTN","MAGJUTL2",43,0)
 . E  S CT=CT+1,ONLCHK=$$ONLCHK(MAGIEN),REMCHK=$$REMOTE(MAGIEN)
"RTN","MAGJUTL2",44,0)
 . S ONL=$S(ONL="":+ONLCHK,+ONL:+ONLCHK,1:0) ; NOT Online if ANY img is 0
"RTN","MAGJUTL2",45,0)
 . S REMOTE=$S(REMOTE="":REMCHK,+REMOTE:REMCHK,1:0) ; NOT Remote if ANY img is 0
"RTN","MAGJUTL2",46,0)
 . S X=$P(ONLCHK,U,3)
"RTN","MAGJUTL2",47,0)
 . I MODALITY="" S MODALITY=X
"RTN","MAGJUTL2",48,0)
 . E  I MODALITY'[X S MODALITY=MODALITY_","_X
"RTN","MAGJUTL2",49,0)
 . I PLACE="" S PLACE=$P(ONLCHK,U,4)
"RTN","MAGJUTL2",50,0)
 I MODALITY["," S MODALITY=$$MULTMDL(MODALITY,",")
"RTN","MAGJUTL2",51,0)
IMGINFQ S ONL=$S(+ONL:"Y",ONL="":"n/a",1:"N")
"RTN","MAGJUTL2",52,0)
 S RET=CT_U_ONL_U_MAGDT_U_REMOTE_U_MODALITY_U_PLACE_U_KEY
"RTN","MAGJUTL2",53,0)
 Q
"RTN","MAGJUTL2",54,0)
 ;
"RTN","MAGJUTL2",55,0)
MULTMDL(MDLS,DLM) ; return multiple modality codes in a preferred sequence for HP lookups
"RTN","MAGJUTL2",56,0)
 ; input: MDLS: list of modality codes, delimited by DLM
"RTN","MAGJUTL2",57,0)
 ; return: "normalized" list delimited by DLM
"RTN","MAGJUTL2",58,0)
 ;
"RTN","MAGJUTL2",59,0)
 ; The variable STR contains a list of codes, each paired with a numeric
"RTN","MAGJUTL2",60,0)
 ; priority value--lower number is higher priority.  The input MDLS sequence is
"RTN","MAGJUTL2",61,0)
 ; re-sorted according to the priorities; equivalent priorities are resolved
"RTN","MAGJUTL2",62,0)
 ; by alphabetic value; "unknown" input codes are give arbitrary value 6
"RTN","MAGJUTL2",63,0)
 ;
"RTN","MAGJUTL2",64,0)
 I $L(MDLS,DLM)>1 D
"RTN","MAGJUTL2",65,0)
 . N I,MD,ORD,STR,T,X
"RTN","MAGJUTL2",66,0)
 . S STR="1^CT|1^MG|1^RF|1^XA|2^MR|3^CR|4^DX|4^BDUS|4^BI|4^BMD|4^DF|4^DS|4^EC|4^MA|4^NM|4^PT|4^RG|4^ST|4^US|4^XC|5^ECG|5^IO|5^IVUS|5^PX|6^DG|6^TG|6^SC|6^VL|7^ES|7^FID|7^GM|7^HD|7^LS|7^XRAY|8^DOC|8^HC|8^OT|8^REG|8^SC|9^KO|9^PR|9^SEG|9^SR|"
"RTN","MAGJUTL2",67,0)
 . F I=1:1 S X=$P(STR,"|",I) Q:X=""  S MD($P(X,U,2))=+X
"RTN","MAGJUTL2",68,0)
 . F I=1:1:$L(MDLS,DLM) S T=$P(MDLS,DLM,I) S ORD=$S($D(MD(T)):MD(T),1:6) S MDLS(ORD,T)=T  ; assign "6" to any undefined code
"RTN","MAGJUTL2",69,0)
 . S MDLS="" S X="MDLS(0)" F I=1:1 S X=$Q(@X) Q:X=""  S MDLS=MDLS_DLM_@X
"RTN","MAGJUTL2",70,0)
 . S MDLS=$E(MDLS,2,99)
"RTN","MAGJUTL2",71,0)
 Q MDLS
"RTN","MAGJUTL2",72,0)
 ;
"RTN","MAGJUTL2",73,0)
ONLCHK(MAGIEN,USETGA) ;
"RTN","MAGJUTL2",74,0)
 ; Input: MAGIEN: Image pointer
"RTN","MAGJUTL2",75,0)
 ;        USETGA: 1/0 -- if 1, forces return of TGA (not .big) file
"RTN","MAGJUTL2",76,0)
 ;Return: ^-delimited pieces:
"RTN","MAGJUTL2",77,0)
 ;  1 - 1/0 for Full-Res image on Mag. Disk that is Online
"RTN","MAGJUTL2",78,0)
 ;  2 - File type (BIG/FULL)
"RTN","MAGJUTL2",79,0)
 ;  3 - Modality
"RTN","MAGJUTL2",80,0)
 ;  4 - Place
"RTN","MAGJUTL2",81,0)
 ;  5 - DFN
"RTN","MAGJUTL2",82,0)
 ;  6 - File Name IFF this image is stored Off-Line (else null)
"RTN","MAGJUTL2",83,0)
 ;  7 - USETGA * as calculated in the logic below
"RTN","MAGJUTL2",84,0)
 ;  8 - PROCDT  = Img Processing DtTime
"RTN","MAGJUTL2",85,0)
 ;  9 - ACQSITE = Acquisition site code
"RTN","MAGJUTL2",86,0)
 ; 10 - STANUM  = Station Number where Magnetic Network Loc'n exists
"RTN","MAGJUTL2",87,0)
 ; * USETGA is set to False (0) if a low-resolution image (TGA) is
"RTN","MAGJUTL2",88,0)
 ;    requested, but none exists; calling routine would call by ref.
"RTN","MAGJUTL2",89,0)
 ;
"RTN","MAGJUTL2",90,0)
 N BIG,X,NOD,MAG0,MODALITY,RET,PLACE,DFN,FILNAM,MAG2,PROCDT,ACQSITE,MAG100,STANUM
"RTN","MAGJUTL2",91,0)
 S USETGA=+$G(USETGA) ; Defaults to Full-Resolution image if not defined
"RTN","MAGJUTL2",92,0)
 S RET="",MODALITY="",PLACE="",ACQSITE="",STANUM=""
"RTN","MAGJUTL2",93,0)
 S MAG0=^MAG(2005,MAGIEN,0),BIG=$D(^("FBIG")),NOD=$S(BIG:^("FBIG"),1:MAG0)
"RTN","MAGJUTL2",94,0)
 S MAG2=^MAG(2005,MAGIEN,2),PROCDT=$P(MAG2,U)
"RTN","MAGJUTL2",95,0)
 S MAG100=$G(^MAG(2005,MAGIEN,100)),ACQSITE=$P(MAG100,U,3)
"RTN","MAGJUTL2",96,0)
 I USETGA D
"RTN","MAGJUTL2",97,0)
 . I 'BIG S USETGA=0 ; reply no low-res image available
"RTN","MAGJUTL2",98,0)
 . I BIG S NOD=MAG0,BIG=0 ; enable correct logic inside this subroutine
"RTN","MAGJUTL2",99,0)
 S MODALITY=$P(MAG0,U,8),DFN=$P(MAG0,U,7)
"RTN","MAGJUTL2",100,0)
 I BIG S X=+$P(NOD,U)  ; $p 1 is Magnetic Disk/Volume (.big)
"RTN","MAGJUTL2",101,0)
 E  S X=+$P(NOD,U,3)   ; $p 3 is Magnetic Disk/Volume (.tga)
"RTN","MAGJUTL2",102,0)
 I X D
"RTN","MAGJUTL2",103,0)
 . I '$D(NETLOC(X)) S NETLOC(X)=+$P(^MAG(2005.2,X,0),U,6)_U_$P(^(0),U,10)_U_$$STANUM(X)
"RTN","MAGJUTL2",104,0)
 . S RET=+NETLOC(X),PLACE=$P(NETLOC(X),U,2),STANUM=$P(NETLOC(X),U,3) ; NETLOC is global to this subrtn
"RTN","MAGJUTL2",105,0)
 . S FILNAM=""
"RTN","MAGJUTL2",106,0)
 E  D
"RTN","MAGJUTL2",107,0)
 . S RET=0,FILNAM=$P(MAG0,U,2)
"RTN","MAGJUTL2",108,0)
 . S T=$S(BIG:$P(NOD,U,2),1:$P(NOD,U,5))
"RTN","MAGJUTL2",109,0)
 . I T S PLACE=$P(^MAG(2005.2,T,0),U,10)
"RTN","MAGJUTL2",110,0)
 S RET=RET_U_$S(BIG:"BIG",1:"FULL")_U_MODALITY_U_PLACE_U_DFN_U_FILNAM_U_USETGA_U_PROCDT_U_ACQSITE_U_STANUM
"RTN","MAGJUTL2",111,0)
 Q RET
"RTN","MAGJUTL2",112,0)
 ;
"RTN","MAGJUTL2",113,0)
REMOTE(MAGIEN) ;Return list of remote  Cache Locations
"RTN","MAGJUTL2",114,0)
 ;  else, return "" if none
"RTN","MAGJUTL2",115,0)
 N RET,LOC
"RTN","MAGJUTL2",116,0)
 S RET=""
"RTN","MAGJUTL2",117,0)
 I $D(^MAG(2005,MAGIEN,4,"LOC")) S LOC=0 D
"RTN","MAGJUTL2",118,0)
 . F  S LOC=$O(^MAG(2005,MAGIEN,4,"LOC",LOC)) Q:'LOC  S RET=RET_$S(RET="":"",1:",")_LOC
"RTN","MAGJUTL2",119,0)
 Q RET
"RTN","MAGJUTL2",120,0)
 ;
"RTN","MAGJUTL2",121,0)
STANUM(NETLOC) ; Return Station Number for input Network Location
"RTN","MAGJUTL2",122,0)
 N X,STANUM
"RTN","MAGJUTL2",123,0)
 S STANUM=""
"RTN","MAGJUTL2",124,0)
 I +$G(NETLOC) D
"RTN","MAGJUTL2",125,0)
 . S X=$P($G(^MAG(2005.2,NETLOC,0)),"^",10)
"RTN","MAGJUTL2",126,0)
 . I X S STANUM=$$GETSNUM^MAGDQR21(X)
"RTN","MAGJUTL2",127,0)
 Q STANUM
"RTN","MAGJUTL2",128,0)
 ;
"RTN","MAGJUTL2",129,0)
IMGINF2(RARPT,RET,USETGA) ; Fetch info from Image File for input RARPT:
"RTN","MAGJUTL2",130,0)
 ; Input: RARPT: Rad Report pointer
"RTN","MAGJUTL2",131,0)
 ;        RET: see below
"RTN","MAGJUTL2",132,0)
 ;        USETGA: 1/0 -- if 1, forces return of TGA (not .big) file
"RTN","MAGJUTL2",133,0)
 ; RET holds array of return values:
"RTN","MAGJUTL2",134,0)
 ; RET = # Images stored for the case
"RTN","MAGJUTL2",135,0)
 ;   RET(1:n) = ^-delimited pieces:
"RTN","MAGJUTL2",136,0)
 ;  1 - 1/0 for Full-Res image on Mag. Disk that is Online
"RTN","MAGJUTL2",137,0)
 ;  2 - FULL/BIG
"RTN","MAGJUTL2",138,0)
 ;  3 - Modality
"RTN","MAGJUTL2",139,0)
 ;  4 - Image IEN
"RTN","MAGJUTL2",140,0)
 ;  5 - Station #
"RTN","MAGJUTL2",141,0)
 ;  6 - Routed-to Locations (IENs)
"RTN","MAGJUTL2",142,0)
 ;  7 - PLACE
"RTN","MAGJUTL2",143,0)
 ;  8 - DFN
"RTN","MAGJUTL2",144,0)
 ;  9 - FileName (if OffLine)
"RTN","MAGJUTL2",145,0)
 ; 10 - PS_Indicator -- 1=Image is on Magnetic Disk
"RTN","MAGJUTL2",146,0)
 ;   
"RTN","MAGJUTL2",147,0)
 ; * This subroutine may be called by other VistARad routines
"RTN","MAGJUTL2",148,0)
 ;
"RTN","MAGJUTL2",149,0)
 N BIG,IMG,MAGIEN,MAGIEN2,MAGPTR,NETLOC
"RTN","MAGJUTL2",150,0)
 K RET S RET=0
"RTN","MAGJUTL2",151,0)
 S USETGA=+$G(USETGA) ; Defaults to Full-Resolution image if not defined
"RTN","MAGJUTL2",152,0)
 G IMGINF2Q:'RARPT S IMG=0
"RTN","MAGJUTL2",153,0)
 F  S IMG=$O(^RARPT(RARPT,2005,IMG)) Q:'IMG  S MAGIEN=$P(^(IMG,0),U) D
"RTN","MAGJUTL2",154,0)
 . ; use group multiple structure when present
"RTN","MAGJUTL2",155,0)
 . Q:'$D(^MAG(2005,MAGIEN,0))  S MAGPTR=0
"RTN","MAGJUTL2",156,0)
 . I '$O(^MAG(2005,MAGIEN,1,MAGPTR)) D  Q
"RTN","MAGJUTL2",157,0)
 . . S T=$$ONLCHK(MAGIEN,USETGA)
"RTN","MAGJUTL2",158,0)
 . . S RET=RET+1,RET(RET)=$P(T,U,1,3)_U_MAGIEN_U_$P(T,U,10)_U_$$REMOTE(MAGIEN)_U_$P(T,U,4,7)_U_$$PSIND(MAGIEN)_U_$P(T,U,8)_U_$P(T,U,9)
"RTN","MAGJUTL2",159,0)
 . E  F  S MAGPTR=$O(^MAG(2005,MAGIEN,1,MAGPTR)) Q:'MAGPTR  S MAGIEN2=$P(^(MAGPTR,0),U) D
"RTN","MAGJUTL2",160,0)
 . . S T=$$ONLCHK(MAGIEN2,USETGA)
"RTN","MAGJUTL2",161,0)
 . . S RET=RET+1,RET(RET)=$P(T,U,1,3)_U_MAGIEN2_U_$P(T,U,10)_U_$$REMOTE(MAGIEN2)_U_$P(T,U,4,7)_U_$$PSIND(MAGIEN2)_U_$P(T,U,8)_U_$P(T,U,9)
"RTN","MAGJUTL2",162,0)
IMGINF2Q ;
"RTN","MAGJUTL2",163,0)
 Q
"RTN","MAGJUTL2",164,0)
 ;
"RTN","MAGJUTL2",165,0)
PSIND(MAGIEN) ; return Presentation State Indicator(s) for image
"RTN","MAGJUTL2",166,0)
 ; K=Key Image PStype; I=Interpretation PStyp; U=User PStyp
"RTN","MAGJUTL2",167,0)
 N RSL,IEN,X
"RTN","MAGJUTL2",168,0)
 S RSL="",IEN=0
"RTN","MAGJUTL2",169,0)
 I $D(^MAG(2005,MAGIEN,210,IEN)) F  S IEN=$O(^MAG(2005,MAGIEN,210,IEN)) Q:'IEN  S X=$P(^(IEN,0),U,2) Q:RSL[X  S RSL=RSL_$S(RSL="":"",1:",")_X
"RTN","MAGJUTL2",170,0)
 Q:$Q RSL Q
"RTN","MAGJUTL2",171,0)
 ;
"RTN","MAGJUTL2",172,0)
JBFETCH(RARPT,MAGS,USETGA,NOFETCH) ; fetch this case's images from Jukebox, if necessary
"RTN","MAGJUTL2",173,0)
 ; Input: RARPT: Rad Report pointer
"RTN","MAGJUTL2",174,0)
 ;        MAGS: see below
"RTN","MAGJUTL2",175,0)
 ;        USETGA: 1/0 -- if 1, forces return of TGA (not .big) file
"RTN","MAGJUTL2",176,0)
 ;        NOFETCH: 1/0 -- if 1, metadata get only so do NOT issue Jukebox retrieve
"RTN","MAGJUTL2",177,0)
 ; This is a function that returns a string containing:
"RTN","MAGJUTL2",178,0)
 ;   # Images fetched from JB ^ Total # Images for Case ^ # Low Res Imgs
"RTN","MAGJUTL2",179,0)
 ; The MAGS array will be returned to the calling
"RTN","MAGJUTL2",180,0)
 ; routine if MAGS is provided as an input parameter
"RTN","MAGJUTL2",181,0)
 ;   MAGS is populated by call to IMGINF2.
"RTN","MAGJUTL2",182,0)
 ;   IF any images are stored OffLine, then this node is set here:
"RTN","MAGJUTL2",183,0)
 ;     MAGS("OFFLN",JBOFFLN)=""  JBOFFLN = Platter ID from file 2006.033
"RTN","MAGJUTL2",184,0)
 ;
"RTN","MAGJUTL2",185,0)
 ; * This function may be called by other VistARad routines
"RTN","MAGJUTL2",186,0)
 ;
"RTN","MAGJUTL2",187,0)
 N MAGIEN,FETCH,IMAG,FILNAM,JBOFFLN,LORESCT
"RTN","MAGJUTL2",188,0)
 S USETGA=+$G(USETGA) ; Defaults to Full-Resolution image if not defined
"RTN","MAGJUTL2",189,0)
 S NOFETCH=+$G(NOFETCH)
"RTN","MAGJUTL2",190,0)
 S FETCH=0,LORESCT=0
"RTN","MAGJUTL2",191,0)
 D IMGINF2(RARPT,.MAGS,USETGA)
"RTN","MAGJUTL2",192,0)
 I MAGS F IMAG=1:1:MAGS S X=MAGS(IMAG) D
"RTN","MAGJUTL2",193,0)
 . I USETGA S LORESCT=LORESCT+$P(X,U,10)
"RTN","MAGJUTL2",194,0)
 . I '+X D  ; Call params below depend on Consolidated Site status
"RTN","MAGJUTL2",195,0)
 . . S FETCH=FETCH+1
"RTN","MAGJUTL2",196,0)
 . . Q:NOFETCH  ; need the count of images on JB, but not retrieving them
"RTN","MAGJUTL2",197,0)
 . . S FILNAM=$P(X,U,9)
"RTN","MAGJUTL2",198,0)
 . . I FILNAM]"",$D(^MAGQUEUE(2006.033,"B",FILNAM)) S T=$O(^(FILNAM,"")) S JBOFFLN=$P($G(^MAGQUEUE(2006.033,T,0)),U,2),MAGS("OFFLN",JBOFFLN)="" Q  ; OffLine Image
"RTN","MAGJUTL2",199,0)
 . . I '$G(MAGJOB("CONSOLIDATED")) S X=$$JBTOHD^MAGBAPI($P(X,U,4)_"^"_$P(X,U,2)) ; pre-consolidation vs
"RTN","MAGJUTL2",200,0)
 . . E  S X=$$JBTOHD^MAGBAPI($P(X,U,4)_"^"_$P(X,U,2),$P(X,U,7))
"RTN","MAGJUTL2",201,0)
JBFETCHQ Q FETCH_U_MAGS_U_LORESCT
"RTN","MAGJUTL2",202,0)
 ;
"RTN","MAGJUTL2",203,0)
END Q  ;
"RTN","MAGJUTL3")
0^12^B130108028
"RTN","MAGJUTL3",1,0)
MAGJUTL3 ;WIRMFO/JHC - VistARad subrtns & RPCs ; 20 Sep 2011  1:50 PM
"RTN","MAGJUTL3",2,0)
 ;;3.0;IMAGING;**16,9,22,18,65,76,101,90,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJUTL3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJUTL3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJUTL3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJUTL3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJUTL3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJUTL3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJUTL3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJUTL3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJUTL3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJUTL3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJUTL3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJUTL3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJUTL3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL3",17,0)
 ;;
"RTN","MAGJUTL3",18,0)
 Q
"RTN","MAGJUTL3",19,0)
 ;RPC Entry points:
"RTN","MAGJUTL3",20,0)
 ; LISTINF--Custom list info
"RTN","MAGJUTL3",21,0)
 ; LOGOFF--update session file
"RTN","MAGJUTL3",22,0)
 ; CACHEQ--init session data
"RTN","MAGJUTL3",23,0)
 ; PINF1--Patient info
"RTN","MAGJUTL3",24,0)
 ; USERINF2--P18 inits for the session
"RTN","MAGJUTL3",25,0)
 ;Subrtn EPs:
"RTN","MAGJUTL3",26,0)
 ; LOG--Upd image access log
"RTN","MAGJUTL3",27,0)
 ; MAGJOBNC--inits for non-client sessions
"RTN","MAGJUTL3",28,0)
 ; USERKEYS--user key info
"RTN","MAGJUTL3",29,0)
 ; USERINF--user info
"RTN","MAGJUTL3",30,0)
 ;
"RTN","MAGJUTL3",31,0)
LISTINF(MAGGRY) ; RPC: MAGJ CUSTOM LISTS
"RTN","MAGJUTL3",32,0)
 ;  get Exam List data
"RTN","MAGJUTL3",33,0)
 ; Return in ^TMP($J,"MAGJLSTINF",0:N)
"RTN","MAGJUTL3",34,0)
 ;     0)= # Entries below (0:n)
"RTN","MAGJUTL3",35,0)
 ;   1:n)= Button Label^List #^Button Hints^List Type
"RTN","MAGJUTL3",36,0)
 ;
"RTN","MAGJUTL3",37,0)
 ; MAGGRY holds $NA ref to ^TMP for return message
"RTN","MAGJUTL3",38,0)
 ;   all refs to MAGGRY use SS indirection
"RTN","MAGJUTL3",39,0)
 ;
"RTN","MAGJUTL3",40,0)
 ; GLB has $NA ref to ^MAG(2006.631), Custom Lists
"RTN","MAGJUTL3",41,0)
 ;   refs to GLB use SS indirection to get data from this file
"RTN","MAGJUTL3",42,0)
 ;
"RTN","MAGJUTL3",43,0)
 S X="ERR1^MAGJUTL3",@^%ZOSF("TRAP")
"RTN","MAGJUTL3",44,0)
 N D0,GLB,INF,MAGLST,NAM,T
"RTN","MAGJUTL3",45,0)
 S MAGLST="MAGJLSTINF"
"RTN","MAGJUTL3",46,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)) K @MAGGRY S @MAGGRY@(0)=0
"RTN","MAGJUTL3",47,0)
 S GLB=$NA(^MAG(2006.631)),NAM=""
"RTN","MAGJUTL3",48,0)
 F  S NAM=$O(@GLB@("B",NAM)) Q:NAM=""  S D0="" D
"RTN","MAGJUTL3",49,0)
 . S D0=$O(@GLB@("B",NAM,D0)) Q:'D0  D
"RTN","MAGJUTL3",50,0)
 . . S X=$G(@GLB@(D0,0)) Q:($P(X,U,2)>9000)!'$P(X,U,6)  ; List Active & User-defined
"RTN","MAGJUTL3",51,0)
 . . S INF="" F I=1:1 S T=$P("7^2^1^3",U,I) Q:T=""  S Y=$P(X,U,T) Q:Y=""  S $P(INF,U,I)=Y
"RTN","MAGJUTL3",52,0)
 . . Q:T'=""  ; req'd fields not all there
"RTN","MAGJUTL3",53,0)
 . . S T=@MAGGRY@(0)+1,^(0)=T,^(T)=INF ; add entry to reply
"RTN","MAGJUTL3",54,0)
 Q
"RTN","MAGJUTL3",55,0)
 ;
"RTN","MAGJUTL3",56,0)
LOG(ACTION,LOGDATA,PSETLST) ; Log exam access
"RTN","MAGJUTL3",57,0)
 ;  ACTION --- Action code string passed in (e.g. VR-VW for vrad view)
"RTN","MAGJUTL3",58,0)
 ;  LOGDATA - ^-delimited fields--see code immediately below
"RTN","MAGJUTL3",59,0)
 ;  PSETLST -- For Printset exams, has list of Rad Case Numbers included
"RTN","MAGJUTL3",60,0)
 ;  
"RTN","MAGJUTL3",61,0)
 N PTCT,TXT,RADFN,MAGIEN,NIMGS,REMOTE,PRTSET
"RTN","MAGJUTL3",62,0)
 S RADFN=$P(LOGDATA,U),MAGIEN=$P(LOGDATA,U,2),NIMGS=$P(LOGDATA,U,3),REMOTE=$P(LOGDATA,U,4)
"RTN","MAGJUTL3",63,0)
 ;
"RTN","MAGJUTL3",64,0)
 ; For Printset, append string to TXT
"RTN","MAGJUTL3",65,0)
 ;   string= "|VR-PRINTSET~"_CaseNum_~x~y   ; x = nth; y = total PrtSet members
"RTN","MAGJUTL3",66,0)
 ;   
"RTN","MAGJUTL3",67,0)
 S PSETLST=$G(PSETLST)
"RTN","MAGJUTL3",68,0)
 S PRTSET=$L(PSETLST,U)
"RTN","MAGJUTL3",69,0)
 I PRTSET>1 D
"RTN","MAGJUTL3",70,0)
 . N I F I=1:1:PRTSET S PRTSET(I)="VR-PRINTSET~"_$P(PSETLST,U,I)_"~"_I_"~"_PRTSET
"RTN","MAGJUTL3",71,0)
 I ACTION="" S ACTION="UNKNOWN"  ; Should never happen
"RTN","MAGJUTL3",72,0)
 S PTCT=RADFN'=$G(MAGJOB("LASTPT",ACTION))
"RTN","MAGJUTL3",73,0)
 I PTCT S MAGJOB("LASTPT",ACTION)=RADFN
"RTN","MAGJUTL3",74,0)
 S TXT=ACTION_U_RADFN_U_MAGIEN_U_U_U_NIMGS
"RTN","MAGJUTL3",75,0)
 S TXT=TXT_U_PTCT_U_$S(+MAGJOB("USER",1):1,1:0)_U_REMOTE
"RTN","MAGJUTL3",76,0)
 ;
"RTN","MAGJUTL3",77,0)
 ;=== Log to Imaging Windows Sessions file (#2006.82).
"RTN","MAGJUTL3",78,0)
 ;  for PRTSET members 2 to N (prevent double-counting):
"RTN","MAGJUTL3",79,0)
 ;    set NIMGS = 0
"RTN","MAGJUTL3",80,0)
 ;    set PTCT to FALSE
"RTN","MAGJUTL3",81,0)
 ;
"RTN","MAGJUTL3",82,0)
 I PRTSET>1 N I F I=1:1:PRTSET D
"RTN","MAGJUTL3",83,0)
 . I I>1 S $P(TXT,U,6)=0,$P(TXT,U,7)=0
"RTN","MAGJUTL3",84,0)
 . D ACTION^MAGGTAU(TXT_"|"_PRTSET(I),1)
"RTN","MAGJUTL3",85,0)
 E  D ACTION^MAGGTAU(TXT,1)
"RTN","MAGJUTL3",86,0)
 ;
"RTN","MAGJUTL3",87,0)
 ;=== Log to Mag Log
"RTN","MAGJUTL3",88,0)
 ;  For Printset, add string to new Param-7 prior to calling ENTRY...
"RTN","MAGJUTL3",89,0)
 ;    string= s/a above, but no pipe char.
"RTN","MAGJUTL3",90,0)
 ;    for PRTSET members 2 to N set NIMGS = 0 to not double-count
"RTN","MAGJUTL3",91,0)
 ;
"RTN","MAGJUTL3",92,0)
 I REMOTE S ACTION=ACTION_"/REM"
"RTN","MAGJUTL3",93,0)
 I PRTSET>1 N I F I=1:1:PRTSET D
"RTN","MAGJUTL3",94,0)
 . I I>1 S NIMGS=0
"RTN","MAGJUTL3",95,0)
 . D ENTRY^MAGLOG(ACTION,+DUZ,MAGIEN,"VRAD:"_MAGJOB("VRVERSION"),RADFN,NIMGS,PRTSET(I))
"RTN","MAGJUTL3",96,0)
 E  D ENTRY^MAGLOG(ACTION,+DUZ,MAGIEN,"VRAD:"_MAGJOB("VRVERSION"),RADFN,NIMGS)
"RTN","MAGJUTL3",97,0)
 Q
"RTN","MAGJUTL3",98,0)
 ;
"RTN","MAGJUTL3",99,0)
LOGOFF(MAGGRY,DATA) ; RPC: MAGJ LOGOFF
"RTN","MAGJUTL3",100,0)
 ;
"RTN","MAGJUTL3",101,0)
 ;=== Update Imaging Windows Sessions file: logoff time & session entry closed.
"RTN","MAGJUTL3",102,0)
 D LOGOFF^MAGGTAU(.MAGGRY)
"RTN","MAGJUTL3",103,0)
 Q
"RTN","MAGJUTL3",104,0)
 ;
"RTN","MAGJUTL3",105,0)
CACHEQ(MAGGRY,DATA) ; RPC: MAGJ CACHELOCATION
"RTN","MAGJUTL3",106,0)
 ; some logon inits & get alternate paths for Remote Reading
"RTN","MAGJUTL3",107,0)
 ; input in DATA:
"RTN","MAGJUTL3",108,0)
 ;  - WSLOC   = WS Loc'n
"RTN","MAGJUTL3",109,0)
 ;  - VRADVER = Client Vs -- p32 ONLY
"RTN","MAGJUTL3",110,0)
 ;  - OSVER   = Client OS Vs -- p32 ONLY
"RTN","MAGJUTL3",111,0)
 ; Return in ^TMP($J,"MAGJCACHE",0:N) (@MAGGRY)
"RTN","MAGJUTL3",112,0)
 ;     0)= # Entries below (0:n)
"RTN","MAGJUTL3",113,0)
 ;   1:n)= PhysName^Subdirectory^HashFlag^Username^Password^AltPath_IEN
"RTN","MAGJUTL3",114,0)
 ;
"RTN","MAGJUTL3",115,0)
 ; MAGGRY holds $NA reference to ^TMP for return message
"RTN","MAGJUTL3",116,0)
 ;   refs to MAGGRY use SS indirection
"RTN","MAGJUTL3",117,0)
 ;
"RTN","MAGJUTL3",118,0)
 ; Also builds local array:  p32/p18 compatibility: Some of this is moved to userinf2 below
"RTN","MAGJUTL3",119,0)
 ;  MAGJOB("LOC",NetworkLocnIEN)=Site Abbrev
"RTN","MAGJUTL3",120,0)
 ;     ("REMOTE")=1/0  (T/F for "User is Remote")
"RTN","MAGJUTL3",121,0)
 ;     ("REMOTESCREEN")=0/1  (init User-switchable Remote Screening--P18 use only)
"RTN","MAGJUTL3",122,0)
 ;     ("WSLOC")=WS Loc'n String
"RTN","MAGJUTL3",123,0)
 ;     ("WSLOCTYP")=WS Loc'n Type
"RTN","MAGJUTL3",124,0)
 ;     ("WSNAME")=WS ID
"RTN","MAGJUTL3",125,0)
 ;     ("VRVERSION")=VRAD Vs
"RTN","MAGJUTL3",126,0)
 ;     ("OSVER")=O/S Vs
"RTN","MAGJUTL3",127,0)
 ;     ("ALTPATH")=1/0 ^ 1/0 (T/F Alt Paths are defined 
"RTN","MAGJUTL3",128,0)
 ;               ^ Alt Paths Enabled/Disabled for most recent exam)
"RTN","MAGJUTL3",129,0)
 ;
"RTN","MAGJUTL3",130,0)
 S X="ERR1^MAGJUTL3",@^%ZOSF("TRAP")
"RTN","MAGJUTL3",131,0)
 ;
"RTN","MAGJUTL3",132,0)
 N I,MAGLST,REPLY,TMP,WSLOC,XX,VRADVER,OSVER,DIQUIET,ALTIEN
"RTN","MAGJUTL3",133,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJUTL3",134,0)
 S REPLY=0,MAGLST="MAGJCACHE"
"RTN","MAGJUTL3",135,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)) K @MAGGRY
"RTN","MAGJUTL3",136,0)
 S WSLOC=$$UPCASE($P(DATA,U)),VRADVER=$P(DATA,U,2),OSVER=$P(DATA,U,3)
"RTN","MAGJUTL3",137,0)
 I '$D(MAGJOB("OSVER")) D  ; ID p32 initialization
"RTN","MAGJUTL3",138,0)
 . S MAGJOB("OSVER")=$S(OSVER]"":OSVER,1:"UNK")
"RTN","MAGJUTL3",139,0)
 . S MAGJOB("VRVERSION")=$S(VRADVER]"":VRADVER,1:"UNK")
"RTN","MAGJUTL3",140,0)
 . D MAGJOB ; p32 init of VRAD
"RTN","MAGJUTL3",141,0)
 ; get alt paths location info
"RTN","MAGJUTL3",142,0)
 S MAGJOB("WSLOC")=WSLOC,MAGJOB("REMOTE")=0
"RTN","MAGJUTL3",143,0)
 S MAGJOB("REMOTESCREEN")=+$P($G(^MAG(2006.69,1,0)),U,10)
"RTN","MAGJUTL3",144,0)
 I WSLOC]"" D
"RTN","MAGJUTL3",145,0)
 . S X=$P($G(^MAG(2006.1,+MAGJOB("SITEP"),0)),U,9)
"RTN","MAGJUTL3",146,0)
 . I X]"",(X'=WSLOC) S MAGJOB("REMOTE")=1
"RTN","MAGJUTL3",147,0)
 . E  Q
"RTN","MAGJUTL3",148,0)
 . D LIST^MAGBRTLD(WSLOC,.TMP)
"RTN","MAGJUTL3",149,0)
 . I TMP S REPLY=TMP,MAGJOB("ALTPATH")=$G(MAGJOB("ALTPATH"),"1^1") F I=1:1:TMP D
"RTN","MAGJUTL3",150,0)
 . . S ALTIEN=$P(TMP(I),U,7)
"RTN","MAGJUTL3",151,0)
 . . S XX=$P(TMP(I),U,1,5),X=$P(XX,U,3),$P(XX,U,3)=$S(X="Y":1,1:0)
"RTN","MAGJUTL3",152,0)
 . . S X=$P(XX,U,4),$P(XX,U,4)=$P(XX,U,5),$P(XX,U,5)=X,$P(XX,U,6)=ALTIEN
"RTN","MAGJUTL3",153,0)
 . . S @MAGGRY@(I)=XX,MAGJOB("LOC",ALTIEN)=$P(TMP(I),U,6)
"RTN","MAGJUTL3",154,0)
 I '$D(MAGJOB("ALTPATH")) S MAGJOB("ALTPATH")="0^0"
"RTN","MAGJUTL3",155,0)
 S @MAGGRY@(0)=REPLY
"RTN","MAGJUTL3",156,0)
CACHEQZ Q
"RTN","MAGJUTL3",157,0)
 ;
"RTN","MAGJUTL3",158,0)
MAGJOBNC ; EP for Prefetch/Bkgnd calls (NOT a Vrad Client)
"RTN","MAGJUTL3",159,0)
 N NOTCLIEN S NOTCLIEN=1
"RTN","MAGJUTL3",160,0)
 D MAGJOB
"RTN","MAGJUTL3",161,0)
 Q
"RTN","MAGJUTL3",162,0)
 ;
"RTN","MAGJUTL3",163,0)
MAGJOB ; Init magjob array
"RTN","MAGJUTL3",164,0)
 N T,RIST
"RTN","MAGJUTL3",165,0)
 I $G(MAGJOB("VRVERSION")) S X=MAGJOB("VRVERSION")
"RTN","MAGJUTL3",166,0)
 E  S X="" ; non-client processes assume post-P32 logic
"RTN","MAGJUTL3",167,0)
 S MAGJOB("P32")=(X="3.0.41.17") ; P32 Client?
"RTN","MAGJUTL3",168,0)
 I MAGJOB("P32") D P32STOP^MAGJUTL5(.X) S MAGJOB("P32STOP")=X  ; STOP support when P76 releases
"RTN","MAGJUTL3",169,0)
 D USERKEYS
"RTN","MAGJUTL3",170,0)
 S MAGJOB("CONSOLIDATED")=($G(^MAG(2006.1,"CONSOLIDATED"))="YES")
"RTN","MAGJUTL3",171,0)
 S MAGJOB("SITEP")=$$IMGSIT^MAGJUTL1(DUZ(2),1)  ; Site Param ien
"RTN","MAGJUTL3",172,0)
 S RIST="" F X="S","R" I $D(^VA(200,"ARC",X,DUZ)) S RIST=X Q
"RTN","MAGJUTL3",173,0)
 S RIST=$S(RIST="S":15,RIST="R":12,1:0) ; Staff/Resident/Non rist
"RTN","MAGJUTL3",174,0)
 S MAGJOB("USER",1)=RIST_U_$$USERINF(+DUZ,".01;1") ; RIST_Type^NAME^INI
"RTN","MAGJUTL3",175,0)
 S X=$P($G(IO("CLNM")),"."),MAGJOB("WSNAME")=$S(X]"":X,1:"VistaradWS")
"RTN","MAGJUTL3",176,0)
 K MAGJOB("DIVSCRN") I MAGJOB("CONSOLIDATED") D
"RTN","MAGJUTL3",177,0)
 . ; include logon DIV, other DIVs to screen Unread Lists & Locking
"RTN","MAGJUTL3",178,0)
 . I $G(DUZ(2))]"" S MAGJOB("DIVSCRN",DUZ(2))=""
"RTN","MAGJUTL3",179,0)
 . S DIV=""
"RTN","MAGJUTL3",180,0)
 . I DUZ(2)'=$P(MAGJOB("SITEP"),U,3) D  ; Assoc DIV
"RTN","MAGJUTL3",181,0)
 . . S IEN=$O(^MAG(2006.1,+MAGJOB("SITEP"),"INSTS","B",DUZ(2),0))
"RTN","MAGJUTL3",182,0)
 . . I IEN F  S DIV=$O(^MAG(2006.1,+MAGJOB("SITEP"),"INSTS",IEN,201,"B",DIV)) Q:'DIV  S MAGJOB("DIVSCRN",DIV)=""
"RTN","MAGJUTL3",183,0)
 . E  D  ; Parent DIV
"RTN","MAGJUTL3",184,0)
 . . F  S DIV=$O(^MAG(2006.1,+MAGJOB("SITEP"),201,"B",DIV)) Q:'DIV  S MAGJOB("DIVSCRN",DIV)=""
"RTN","MAGJUTL3",185,0)
 S MAGJOB("WSLOCTYP")=$S(+MAGJOB("USER",1):"RAD",1:"Non-Rad") ; USer is Rist/Not
"RTN","MAGJUTL3",186,0)
 I '$D(MAGJOB("WRKSIEN")) D
"RTN","MAGJUTL3",187,0)
 . Q:+$G(NOTCLIEN)  ; proceed only if Vrad Client is attached
"RTN","MAGJUTL3",188,0)
 . S X=MAGJOB("WSNAME")
"RTN","MAGJUTL3",189,0)
 . S $P(X,U,4)=MAGJOB("WSLOCTYP")
"RTN","MAGJUTL3",190,0)
 . S $P(X,U,8)=1                     ; StartupMode=Normal.
"RTN","MAGJUTL3",191,0)
 . S $P(X,U,9)=MAGJOB("OSVER")
"RTN","MAGJUTL3",192,0)
 . S $P(X,U,10)=MAGJOB("VRVERSION")
"RTN","MAGJUTL3",193,0)
 . S $P(X,U,17)=MAGJOB("VRBLDDTTM")
"RTN","MAGJUTL3",194,0)
 . D UPD^MAGGTAU(.Y,X)
"RTN","MAGJUTL3",195,0)
 . D REMLOCK^MAGJEX1B ; put here to only run 1x/ login
"RTN","MAGJUTL3",196,0)
 Q
"RTN","MAGJUTL3",197,0)
 ;
"RTN","MAGJUTL3",198,0)
USERINF(DUZ,FLDS) ; get data from user file
"RTN","MAGJUTL3",199,0)
 I FLDS=""!'DUZ Q ""
"RTN","MAGJUTL3",200,0)
 N I,RSL,T S RSL=""
"RTN","MAGJUTL3",201,0)
 D GETS^DIQ(200,+DUZ,FLDS,"E","T")
"RTN","MAGJUTL3",202,0)
 S T=+DUZ_","
"RTN","MAGJUTL3",203,0)
 F I=1:1:$L(FLDS,";") S RSL=RSL_$S(RSL="":"",1:U)_T(200,T,$P(FLDS,";",I),"E")
"RTN","MAGJUTL3",204,0)
 Q RSL
"RTN","MAGJUTL3",205,0)
 ;
"RTN","MAGJUTL3",206,0)
USERKEYS ; Store Security Keys in MagJob
"RTN","MAGJUTL3",207,0)
 N I,X,Y
"RTN","MAGJUTL3",208,0)
 N MAGKS ; keys to send to XUS KEY CHECK
"RTN","MAGJUTL3",209,0)
 N MAGKG ; returned
"RTN","MAGJUTL3",210,0)
 K MAGJOB("KEYS")
"RTN","MAGJUTL3",211,0)
 S X="MAGJ",I=0
"RTN","MAGJUTL3",212,0)
 F  S X=$O(^XUSEC(X)) Q:$E(X,1,4)'="MAGJ"  D
"RTN","MAGJUTL3",213,0)
 . S I=I+1,MAGKS(I)=X
"RTN","MAGJUTL3",214,0)
 I '$D(MAGKS) Q
"RTN","MAGJUTL3",215,0)
 D OWNSKEY^XUSRB(.MAGKG,.MAGKS)
"RTN","MAGJUTL3",216,0)
 S I=0 F  S I=$O(MAGKG(I)) Q:'I  I MAGKG(I) S MAGJOB("KEYS",MAGKS(I))=""
"RTN","MAGJUTL3",217,0)
 Q
"RTN","MAGJUTL3",218,0)
 ;
"RTN","MAGJUTL3",219,0)
PINF1(MAGGRY,MAGDFN) ;RPC Call MAGJ PT INFO -- Get pt info
"RTN","MAGJUTL3",220,0)
 S X="ERR3^MAGJUTL3",@^%ZOSF("TRAP")
"RTN","MAGJUTL3",221,0)
 D INFO^MAGGTPT1(.MAGGRY,MAGDFN_"^1") ; 1=Don't log to session file
"RTN","MAGJUTL3",222,0)
 Q
"RTN","MAGJUTL3",223,0)
 ; 
"RTN","MAGJUTL3",224,0)
 ;+++++ INITIALIZE SESSION (VERSION CHK, DISPLAY RES CHK, COLLECT USER INFO).
"RTN","MAGJUTL3",225,0)
 ; RPC: MAGJ USER2
"RTN","MAGJUTL3",226,0)
 ; 
"RTN","MAGJUTL3",227,0)
 ; MAGGRY      Reference to a variable naming the global to store returned data
"RTN","MAGJUTL3",228,0)
 ; 
"RTN","MAGJUTL3",229,0)
 ; DATA        Information about the client and its workstation.
"RTN","MAGJUTL3",230,0)
 ;               ^01: MAMMORES -- Screen resolution of main viewer display:
"RTN","MAGJUTL3",231,0)
 ; 
"RTN","MAGJUTL3",232,0)
 ;                       format is X_"x"_Y_","_ColorType (e.g., 2048x2580,GRAY)
"RTN","MAGJUTL3",233,0)
 ;                       where X,Y are resolutions & ColorType={GRAY, COLOR}.
"RTN","MAGJUTL3",234,0)
 ;                
"RTN","MAGJUTL3",235,0)
 ;               ^02: Client Vs ....... Client software version for checking.
"RTN","MAGJUTL3",236,0)
 ;               ^03: Client O/S Vs ... Client OS version for logging.
"RTN","MAGJUTL3",237,0)
 ;               ^04: ClientBuildDayTime ..... for logging.
"RTN","MAGJUTL3",238,0)
 ;
"RTN","MAGJUTL3",239,0)
 ; Return Values
"RTN","MAGJUTL3",240,0)
 ; =============
"RTN","MAGJUTL3",241,0)
 ; 
"RTN","MAGJUTL3",242,0)
 ; ^(0)
"RTN","MAGJUTL3",243,0)
 ;     |01
"RTN","MAGJUTL3",244,0)
 ;        ^01: 1/0 -- Success/Fail flag for version check.
"RTN","MAGJUTL3",245,0)
 ;        ^02: 
"RTN","MAGJUTL3",246,0)
 ;            ~01: code ... 4=fail.
"RTN","MAGJUTL3",247,0)
 ;            ~02: Msg .... Message to display if fail.
"RTN","MAGJUTL3",248,0)
 ;     |02
"RTN","MAGJUTL3",249,0)
 ;        ^01: DUZ
"RTN","MAGJUTL3",250,0)
 ;        ^02: NAME
"RTN","MAGJUTL3",251,0)
 ;        ^03: INITIALS
"RTN","MAGJUTL3",252,0)
 ;        ^04: REQFLAG .... 1/0 Enable/Disable Requisition for non-rad staff
"RTN","MAGJUTL3",253,0)
 ;        ^05: SVERSION ... VistARad Server Version
"RTN","MAGJUTL3",254,0)
 ;        ---- Patch MAG*3*101 ----
"RTN","MAGJUTL3",255,0)
 ;        ^06: DICTPREF ... 1/0 ENA DICT PREF-YES ALL LOCKED (File 2006.69,13)
"RTN","MAGJUTL3",256,0)
 ;        ---- Patch MAG*3*90 ----
"RTN","MAGJUTL3",257,0)
 ;        ^07: SSN
"RTN","MAGJUTL3",258,0)
 ;        ^08: UserLocalStationNumber
"RTN","MAGJUTL3",259,0)
 ;        ^09: LocalPrimaryDivision
"RTN","MAGJUTL3",260,0)
 ;        ^10: PrimarySiteStationNumber
"RTN","MAGJUTL3",261,0)
 ;        ^11: SiteServiceURL
"RTN","MAGJUTL3",262,0)
 ;        ^12: SiteCode       
"RTN","MAGJUTL3",263,0)
 ; ^(1)
"RTN","MAGJUTL3",264,0)
 ;     ^01: UserName ... Network UserName
"RTN","MAGJUTL3",265,0)
 ;     ^02: PSW ........ Network Password
"RTN","MAGJUTL3",266,0)
 ;     ^03: UserType ... 3=Staff R'ist, 2=Resident R'ist, 1=Rad Tech, 0=Non-Rad
"RTN","MAGJUTL3",267,0)
 ;     ^04: SYSADMIN ... 1/0 1=user has System User privileges
"RTN","MAGJUTL3",268,0)
 ;     ^05: Production account? 1/0 1=yes
"RTN","MAGJUTL3",269,0)
 ;
"RTN","MAGJUTL3",270,0)
 ; ^(2:N)   Security Keys
"RTN","MAGJUTL3",271,0)
 ; ^(N+1:M) Mammography display message data
"RTN","MAGJUTL3",272,0)
 ;
"RTN","MAGJUTL3",273,0)
USERINF2(MAGGRY,DATA) ; RPC: MAGJ USER2--get user info
"RTN","MAGJUTL3",274,0)
 S X="ERR2^MAGJUTL3",@^%ZOSF("TRAP")
"RTN","MAGJUTL3",275,0)
 K MAGGRY S MAGGRY(0)="",MAGGRY(1)=""
"RTN","MAGJUTL3",276,0)
 I +$G(DUZ)=0 S MAGGRY(0)="0^4~DUZ Undefined, Null or Zero|" Q
"RTN","MAGJUTL3",277,0)
 N I,J,K,Y,REQFLAG,VRADVER,OSVER,RADTECH,PLACE,REPLY,DICTPREF,MAMMORES,ICNT,MSG
"RTN","MAGJUTL3",278,0)
 S MAMMORES=$P(DATA,U),VRADVER=$P(DATA,U,2),OSVER=$P(DATA,U,3)
"RTN","MAGJUTL3",279,0)
 D CHKVER^MAGJUTL5(.REPLY,VRADVER,.PLACE,.SVERSION)
"RTN","MAGJUTL3",280,0)
 I 'REPLY S MAGGRY(0)=REPLY_"|^^^^",MAGGRY(1)="^^^" G USERIN2Z ; Version check or PLACE failed
"RTN","MAGJUTL3",281,0)
 S RADTECH=""
"RTN","MAGJUTL3",282,0)
 S MAGJOB("OSVER")=$S(OSVER]"":OSVER,1:"UNK")   ; IDs P18 initialization; cf cacheq ep above
"RTN","MAGJUTL3",283,0)
 S MAGJOB("VRVERSION")=$S(VRADVER]"":VRADVER,1:"UNK")
"RTN","MAGJUTL3",284,0)
 S MAGJOB("VRBLDDTTM")=$P(DATA,U,4)
"RTN","MAGJUTL3",285,0)
 S MAGJOB("VSVERSION")=SVERSION
"RTN","MAGJUTL3",286,0)
 D MAGJOB
"RTN","MAGJUTL3",287,0)
 ;
"RTN","MAGJUTL3",288,0)
 ;=== Enable/Disable Requisition if not a radiology user
"RTN","MAGJUTL3",289,0)
 S REQFLAG=1
"RTN","MAGJUTL3",290,0)
 I 'MAGJOB("USER",1) D  ; not a rist
"RTN","MAGJUTL3",291,0)
 . I $D(^VA(200,"ARC","T",+DUZ)) S RADTECH=1 Q  ; Rad Tech OK
"RTN","MAGJUTL3",292,0)
 . S X=+$P($G(^MAG(2006.69,1,0)),U,16)
"RTN","MAGJUTL3",293,0)
 . I X S REQFLAG=0 ; Disable Req
"RTN","MAGJUTL3",294,0)
 S DICTPREF=+$P($G(^MAG(2006.69,1,0)),U,17)
"RTN","MAGJUTL3",295,0)
 S MAGGRY(0)=REPLY_"|"_DUZ_U_$$GET1^DIQ(200,DUZ_",",.01)_U_$$GET1^DIQ(200,DUZ_",",1)_U_REQFLAG_U_SVERSION_U_DICTPREF
"RTN","MAGJUTL3",296,0)
 ;
"RTN","MAGJUTL3",297,0)
 ;=== Add "^"-pieces 7:12 for ViX (MAG*3*90).
"RTN","MAGJUTL3",298,0)
 S MAGGRY(0)=MAGGRY(0)_U_$$GET1^DIQ(200,DUZ_",",9) ;...SSN
"RTN","MAGJUTL3",299,0)
 S MAGGRY(0)=MAGGRY(0)_U_$$GET1^DIQ(4,DUZ(2),99,"E") ;.UserLocalStationNumber
"RTN","MAGJUTL3",300,0)
 S MAGGRY(0)=MAGGRY(0)_U_$P($$SITE^VASITE(),U,3) ;.......LocalPrimaryDivision
"RTN","MAGJUTL3",301,0)
 S MAGGRY(0)=MAGGRY(0)_U_$P($$SITE^VASITE(),U,3) ;.....PrimarySiteStationNumber
"RTN","MAGJUTL3",302,0)
 ;
"RTN","MAGJUTL3",303,0)
 ;=== Lookup SiteServiceURL.
"RTN","MAGJUTL3",304,0)
 N SSUNC,VIXPTR
"RTN","MAGJUTL3",305,0)
 S VIXPTR=$P($G(^MAG(2006.1,+MAGJOB("SITEP"),"NET")),"^",5)
"RTN","MAGJUTL3",306,0)
 ;
"RTN","MAGJUTL3",307,0)
 ;=== Return UNC only if OpStatus is 'online'.
"RTN","MAGJUTL3",308,0)
 I VIXPTR,+$P($G(^MAG(2005.2,VIXPTR,0)),"^",6) D
"RTN","MAGJUTL3",309,0)
 . S SSUNC=$P($G(^MAG(2005.2,VIXPTR,0)),"^",2)
"RTN","MAGJUTL3",310,0)
 S MAGGRY(0)=MAGGRY(0)_U_$G(SSUNC) ;...................SiteServiceURL
"RTN","MAGJUTL3",311,0)
 S MAGGRY(0)=MAGGRY(0)_U_$P(MAGJOB("SITEP"),U,2) ;.....SiteCode
"RTN","MAGJUTL3",312,0)
 ;
"RTN","MAGJUTL3",313,0)
 ;=== Network UserName and PSW
"RTN","MAGJUTL3",314,0)
 S MAGGRY(1)=$P($G(^MAG(2006.1,PLACE,"NET")),U,1,2)
"RTN","MAGJUTL3",315,0)
 S X=+MAGJOB("USER",1),X=$S(X=15:3,X=12:2,+RADTECH:1,1:0)
"RTN","MAGJUTL3",316,0)
 S MAGGRY(1)=MAGGRY(1)_U_X_U_$D(MAGJOB("KEYS","MAGJ SYSTEM USER"))
"RTN","MAGJUTL3",317,0)
 S MAGGRY(1)=MAGGRY(1)_U_$S($L($T(PROD^XUPROD)):+$$PROD^XUPROD,1:0)
"RTN","MAGJUTL3",318,0)
 S MAGGRY(2)="*KEYS",X="" F ICNT=3:1 S X=$O(MAGJOB("KEYS",X)) Q:X=""  S MAGGRY(ICNT)=X
"RTN","MAGJUTL3",319,0)
 S MAGGRY(ICNT)="*END"
"RTN","MAGJUTL3",320,0)
 S ICNT=ICNT+1,MAGGRY(ICNT)="*MAMMO"
"RTN","MAGJUTL3",321,0)
 S MSG=$$MAMMOCHK(MAMMORES)
"RTN","MAGJUTL3",322,0)
 I MSG]"" S ICNT=ICNT+1,MAGGRY(ICNT)=MSG
"RTN","MAGJUTL3",323,0)
 S ICNT=ICNT+1,MAGGRY(ICNT)="*END"
"RTN","MAGJUTL3",324,0)
USERIN2Z Q
"RTN","MAGJUTL3",325,0)
 ;
"RTN","MAGJUTL3",326,0)
MAMMOCHK(X) ; return true if the screen resolution is 5 megapixels, and grayscale
"RTN","MAGJUTL3",327,0)
 ; note--as of 4/09 there is only one size display for mammo interpretation
"RTN","MAGJUTL3",328,0)
 ; and the resolution is 2048x2560, or 5,242,880 pixels; the algorithm allows 
"RTN","MAGJUTL3",329,0)
 ; a little wiggle room, but excludes a 6MP display.  Can update when real life changes
"RTN","MAGJUTL3",330,0)
 N T,XX,YY,RES,MSG
"RTN","MAGJUTL3",331,0)
 S X=$$UPCASE(X)
"RTN","MAGJUTL3",332,0)
 S T=0
"RTN","MAGJUTL3",333,0)
 I X?4N1"X"4N1","4.5A D
"RTN","MAGJUTL3",334,0)
 . S XX=+X,YY=+$P(X,"X",2),C=$P(X,",",2)
"RTN","MAGJUTL3",335,0)
 . S RES=XX*YY I RES>5000000,(RES<5314800) S T=1 ; resolution OK
"RTN","MAGJUTL3",336,0)
 . I T S T=(C="GRAY") ; and, is grayscale
"RTN","MAGJUTL3",337,0)
 I T S MSG="Primary diagnostic interpretation of mammography images may only be performed on medical devices that are cleared for that intended use, and that use display hardware conforming to technical specifications set by the FDA."
"RTN","MAGJUTL3",338,0)
 E  S MSG="This device does not conform to technical specifications set by the FDA for primary diagnostic interpretation of mammography images."
"RTN","MAGJUTL3",339,0)
 Q:$Q MSG Q
"RTN","MAGJUTL3",340,0)
 ;
"RTN","MAGJUTL3",341,0)
UPCASE(X) ; strip spaces, and cx to uppercase
"RTN","MAGJUTL3",342,0)
 Q $TR(X,"abcdefghijklmnopqrstuvwxyz ","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","MAGJUTL3",343,0)
 ;
"RTN","MAGJUTL3",344,0)
ERR1 N ERR S ERR=$$EC^%ZOSV S @MAGGRY@(0)="0^4~"_ERR G ERR
"RTN","MAGJUTL3",345,0)
ERR2 N ERR S ERR=$$EC^%ZOSV S MAGGRY(0)="0^4~"_ERR G ERR
"RTN","MAGJUTL3",346,0)
ERR3 N ERR S ERR=$$EC^%ZOSV S MAGGRY="0^4~"_ERR
"RTN","MAGJUTL3",347,0)
ERR D @^%ZOSF("ERRTN")
"RTN","MAGJUTL3",348,0)
 Q:$Q 1  Q
"RTN","MAGJUTL3",349,0)
 ;
"RTN","MAGJUTL3",350,0)
END Q  ; 
"RTN","MAGJUTL4")
0^13^B152537255
"RTN","MAGJUTL4",1,0)
MAGJUTL4 ;WIRMFO/JHC - VistARad subroutines for RPC calls ; 9 Sep 2011  4:05 PM
"RTN","MAGJUTL4",2,0)
 ;;3.0;IMAGING;**18,76,101,90,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJUTL4",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJUTL4",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL4",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJUTL4",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJUTL4",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJUTL4",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJUTL4",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJUTL4",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJUTL4",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJUTL4",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJUTL4",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJUTL4",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJUTL4",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJUTL4",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL4",17,0)
 ;;
"RTN","MAGJUTL4",18,0)
 Q
"RTN","MAGJUTL4",19,0)
 ;
"RTN","MAGJUTL4",20,0)
 ;***** Return matching CPT's based on grouping criteria.
"RTN","MAGJUTL4",21,0)
 ; RPC: MAGJ CPTMATCH
"RTN","MAGJUTL4",22,0)
 ;
"RTN","MAGJUTL4",23,0)
CPTGRP(MAGGRY,DATA) ;
"RTN","MAGJUTL4",24,0)
 ; FOR INPUT cpt code, return matching cpt's based on grouping criteria:
"RTN","MAGJUTL4",25,0)
 ; INPUT in DATA: CPT Code ^ Criteria
"RTN","MAGJUTL4",26,0)
 ; Criteria:
"RTN","MAGJUTL4",27,0)
 ;   1=Matching cpt
"RTN","MAGJUTL4",28,0)
 ;   2=Body Part
"RTN","MAGJUTL4",29,0)
 ;   3=Body Part & Modality
"RTN","MAGJUTL4",30,0)
 ;  10=Same CPT (used to return short description only)
"RTN","MAGJUTL4",31,0)
 ; Return: List of CPTs with Short Name:  CPT ^ Short Name
"RTN","MAGJUTL4",32,0)
 ; MAGGRY holds $NA reference to ^TMP for rpc return
"RTN","MAGJUTL4",33,0)
 ;   all ref's to MAGGRY use subscript indirection
"RTN","MAGJUTL4",34,0)
 ;
"RTN","MAGJUTL4",35,0)
 N $ETRAP,$ESTACK S $ETRAP="G ERR1^MAGJUTL4"
"RTN","MAGJUTL4",36,0)
 N REPLY,DIQUIET,CPT,CRIT,CT,MAGLST,NOD,NODLST
"RTN","MAGJUTL4",37,0)
 N MATCHGRP,INDXLST,AND,RET,CPTGLB,CPTIN,CPTIEN,TCPT,CPTFILIEN,CPTFILDAT,IEN
"RTN","MAGJUTL4",38,0)
 ;
"RTN","MAGJUTL4",39,0)
 ; <*> Issue: Unable get specific body part for some non-specific CPTs (e.g., 75774-ANGIO SELECT EA ADD VESSEL-S)
"RTN","MAGJUTL4",40,0)
 ;         --> For these, could just return matching CPTs (or equivalent CPT?)
"RTN","MAGJUTL4",41,0)
 ;
"RTN","MAGJUTL4",42,0)
 ; Produce List of cptiens for each INDX of interest
"RTN","MAGJUTL4",43,0)
 ; AND with next list of cptiens; repeat until no more INDXs
"RTN","MAGJUTL4",44,0)
 ; build output list of CPT codes (w/ short names [optional])
"RTN","MAGJUTL4",45,0)
 ; 
"RTN","MAGJUTL4",46,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJUTL4",47,0)
 S CT=0,MAGLST="MAGJCPT"
"RTN","MAGJUTL4",48,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,MAGLST)) K @MAGGRY  ; assign MAGGRY value
"RTN","MAGJUTL4",49,0)
 S CPTIN=$P(DATA,U),CRIT=$P(DATA,U,2),CPTIEN=""
"RTN","MAGJUTL4",50,0)
 S REPLY="0^Getting matching CPT info."
"RTN","MAGJUTL4",51,0)
 S:'CRIT CRIT=1 ; default equivalent
"RTN","MAGJUTL4",52,0)
 I '(CRIT=1!(CRIT=2)!(CRIT=3)!(CRIT=10)) S REPLY="0^Invalid cpt lookup criteria ("_DATA_")." G CPTGRPZ
"RTN","MAGJUTL4",53,0)
 I CPTIN="" S REPLY="0^Invalid CPT code ("_DATA_")." G CPTGRPZ
"RTN","MAGJUTL4",54,0)
 S CPTFILDAT=$$CPT^ICPTCOD(CPTIN)
"RTN","MAGJUTL4",55,0)
 I +CPTFILDAT=-1 S CPTFILDAT=""
"RTN","MAGJUTL4",56,0)
 S CPTFILIEN=$P(CPTFILDAT,U)
"RTN","MAGJUTL4",57,0)
 S CPTGLB=$NA(^MAG(2006.67))
"RTN","MAGJUTL4",58,0)
 I CPTFILIEN S CPTIEN=$O(@CPTGLB@("B",CPTFILIEN,""))
"RTN","MAGJUTL4",59,0)
 I 'CPTIEN D  G CPTGRPZ
"RTN","MAGJUTL4",60,0)
 . ; if no entry in CPTGLB, return same CPT
"RTN","MAGJUTL4",61,0)
 . S CT=CT+1,@MAGGRY@(CT)=CPTIN_U_$P(CPTFILDAT,U,3)
"RTN","MAGJUTL4",62,0)
 . I CPTFILIEN S REPLY=CT_U_"1~ "_CT_" CPT name returned for "_CPTIN
"RTN","MAGJUTL4",63,0)
 . E  S REPLY=CT_U_"1~ "_CT_" record returned--no value found for "_CPTIN
"RTN","MAGJUTL4",64,0)
 S X=@CPTGLB@(CPTIEN,0),MATCHGRP=+$P(X,U,4)
"RTN","MAGJUTL4",65,0)
 ;CPTMATCH^BODYPART^MDL
"RTN","MAGJUTL4",66,0)
 I CRIT=2!(CRIT=3) D
"RTN","MAGJUTL4",67,0)
 . S X=0 F  S X=$O(@CPTGLB@(CPTIEN,1,"B",X)) Q:'X  D GETCPTS("BODYPART",X,"",.RET)
"RTN","MAGJUTL4",68,0)
 . I CRIT=3 D
"RTN","MAGJUTL4",69,0)
 . . M AND=RET K RET S X=0
"RTN","MAGJUTL4",70,0)
 . . F  S X=$O(@CPTGLB@(CPTIEN,2,"B",X)) Q:'X  D GETCPTS("MDL",X,.AND,.RET)
"RTN","MAGJUTL4",71,0)
 I CRIT=1 D
"RTN","MAGJUTL4",72,0)
 . I MATCHGRP,(MATCHGRP'=CPTIEN) S RET(MATCHGRP)="" D GETCPTS("CPTMATCH",MATCHGRP,"",.RET)
"RTN","MAGJUTL4",73,0)
 . D GETCPTS("CPTMATCH",CPTIEN,"",.RET)
"RTN","MAGJUTL4",74,0)
 I CRIT=10 ; fall through answers this!
"RTN","MAGJUTL4",75,0)
 I '$D(RET(CPTIEN)) S RET(CPTIEN)="" ; always report back input cpt
"RTN","MAGJUTL4",76,0)
 S IEN=0 F  S IEN=$O(RET(IEN)) Q:'IEN  D
"RTN","MAGJUTL4",77,0)
 . N LIN S X=$G(@CPTGLB@(IEN,0))
"RTN","MAGJUTL4",78,0)
 . Q:'(X]"")  S TCPT=$P(X,U),LIN=$P($$CPT^ICPTCOD(TCPT),U,2,3)
"RTN","MAGJUTL4",79,0)
 . S CT=CT+1,@MAGGRY@(CT)=LIN
"RTN","MAGJUTL4",80,0)
 S REPLY=CT_U_"1~ "_CT_" CPT Matches returned for "_CPTIN
"RTN","MAGJUTL4",81,0)
CPTGRPZ ;
"RTN","MAGJUTL4",82,0)
 S @MAGGRY@(0)=REPLY
"RTN","MAGJUTL4",83,0)
 Q
"RTN","MAGJUTL4",84,0)
 ;
"RTN","MAGJUTL4",85,0)
GETCPTS(INDEX,VALUE,AND,OUT) ; return a list of CPTIENS in OUT
"RTN","MAGJUTL4",86,0)
 ; if array AND is defined, reply only values contained in AND &  the index
"RTN","MAGJUTL4",87,0)
 N X,GLBREF,CPTIEN
"RTN","MAGJUTL4",88,0)
 S GLBREF=$NA(@CPTGLB@(INDEX,VALUE))
"RTN","MAGJUTL4",89,0)
 S CPTIEN=0
"RTN","MAGJUTL4",90,0)
 I $D(AND)>9 D
"RTN","MAGJUTL4",91,0)
 . F  S CPTIEN=$O(AND(CPTIEN)) Q:CPTIEN=""  I $D(@GLBREF@(CPTIEN)) S OUT(CPTIEN)=""
"RTN","MAGJUTL4",92,0)
 E  F  S CPTIEN=$O(@GLBREF@(CPTIEN)) Q:'CPTIEN  D
"RTN","MAGJUTL4",93,0)
 . S OUT(CPTIEN)=""
"RTN","MAGJUTL4",94,0)
 Q
"RTN","MAGJUTL4",95,0)
 ;
"RTN","MAGJUTL4",96,0)
BODPART(CPTIEN,DLM) ; return DLM-delimited list of body part values for this CPT
"RTN","MAGJUTL4",97,0)
 I +$G(CPTIEN)
"RTN","MAGJUTL4",98,0)
 E  Q ""
"RTN","MAGJUTL4",99,0)
 N LIST,CPTGLB S LIST=""
"RTN","MAGJUTL4",100,0)
 S DLM=$E($G(DLM))
"RTN","MAGJUTL4",101,0)
 I DLM="" S DLM="^"
"RTN","MAGJUTL4",102,0)
 S CPTGLB=$NA(^MAG(2006.67))
"RTN","MAGJUTL4",103,0)
 S NOD=0
"RTN","MAGJUTL4",104,0)
 F  S NOD=$O(@CPTGLB@(CPTIEN,1,NOD)) Q:'NOD  S X=$P(^(NOD,0),U) I X]"" S LIST=LIST_DLM_X
"RTN","MAGJUTL4",105,0)
 Q:$Q $E(LIST,2,999)  Q
"RTN","MAGJUTL4",106,0)
 ;
"RTN","MAGJUTL4",107,0)
MDLLST(CPTIEN,DLM) ; return DLM-delimited list of modality values for this CPT
"RTN","MAGJUTL4",108,0)
 I +$G(CPTIEN)
"RTN","MAGJUTL4",109,0)
 E  Q ""
"RTN","MAGJUTL4",110,0)
 N LIST,CPTGLB S LIST=""
"RTN","MAGJUTL4",111,0)
 S DLM=$E($G(DLM))
"RTN","MAGJUTL4",112,0)
 I DLM="" S DLM="^"
"RTN","MAGJUTL4",113,0)
 S CPTGLB=$NA(^MAG(2006.67))
"RTN","MAGJUTL4",114,0)
 S NOD=0
"RTN","MAGJUTL4",115,0)
 F  S NOD=$O(@CPTGLB@(CPTIEN,2,NOD)) Q:'NOD  S X=$P(^(NOD,0),U) I X]"" S LIST=LIST_DLM_X
"RTN","MAGJUTL4",116,0)
 Q:$Q $E(LIST,2,999)  Q
"RTN","MAGJUTL4",117,0)
 ;
"RTN","MAGJUTL4",118,0)
 ;***** Returns server data to display in new "Image Display" window (P101.31).
"RTN","MAGJUTL4",119,0)
 ; RPC: MAGJ MAGDATADUMP
"RTN","MAGJUTL4",120,0)
 ;
"RTN","MAGJUTL4",121,0)
 ;  DATA         REQUEST ^ PARAM1 | PARAM2
"RTN","MAGJUTL4",122,0)
 ;
"RTN","MAGJUTL4",123,0)
 ;  ..... REQUEST determines format:
"RTN","MAGJUTL4",124,0)
 ;
"RTN","MAGJUTL4",125,0)
 ;  ^01:  REQUEST           Literal string: [ CPT, FLDS, GLB ]
"RTN","MAGJUTL4",126,0)
 ;
"RTN","MAGJUTL4",127,0)
 ;  ^02:  if REQUEST="CPT":
"RTN","MAGJUTL4",128,0)
 ;
"RTN","MAGJUTL4",129,0)
 ;        |01:  PARAM1      CPT Code
"RTN","MAGJUTL4",130,0)
 ;        |02:  [PARAM2]    ""
"RTN","MAGJUTL4",131,0)
 ;
"RTN","MAGJUTL4",132,0)
 ;  ^02:  if REQUEST="FLDS" or "GLB":
"RTN","MAGJUTL4",133,0)
 ;
"RTN","MAGJUTL4",134,0)
 ;        |01:  [PARAM1]    FileMan GETS^DIQ Flags (only if REQUEST="FLDS") *OR*
"RTN","MAGJUTL4",135,0)
 ;        |02:  PARAM2      ImageIEN or Case_ID_String
"RTN","MAGJUTL4",136,0)
 ;
"RTN","MAGJUTL4",137,0)
 ;  Return Values:
"RTN","MAGJUTL4",138,0)
 ;        0:N lines to display (Internal Imaging or CPT Match data).
"RTN","MAGJUTL4",139,0)
 ;
"RTN","MAGJUTL4",140,0)
DATADUMP(MAGGRY,DATA) ;
"RTN","MAGJUTL4",141,0)
 ;
"RTN","MAGJUTL4",142,0)
 ; Initialize. <*> Do NOT change name of EP
"RTN","MAGJUTL4",143,0)
 ;   Also called as subroutine from INCPT^MAGJMN3
"RTN","MAGJUTL4",144,0)
 ;   
"RTN","MAGJUTL4",145,0)
 N $ETRAP,$ESTACK S $ETRAP="G ERR1^MAGJUTL4"
"RTN","MAGJUTL4",146,0)
 N CT,CPT,CPTFILIEN,CPTNAM,DIQUIET,IMGIEN,INVALID,PARAM1,PARAM2,REQUEST
"RTN","MAGJUTL4",147,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJUTL4",148,0)
 K MAGGRY S MAGGRY=$NA(^TMP($J,"MAGJDATA")) K @MAGGRY
"RTN","MAGJUTL4",149,0)
 ;
"RTN","MAGJUTL4",150,0)
 ; Validate input.
"RTN","MAGJUTL4",151,0)
 S INVALID=$$DDMPVLD8()
"RTN","MAGJUTL4",152,0)
 ;
"RTN","MAGJUTL4",153,0)
 ; Process then Exit, REPLYing with data or error code.
"RTN","MAGJUTL4",154,0)
 I 'INVALID D
"RTN","MAGJUTL4",155,0)
 . D DDMPROCS S REPLY=CT_U_"1~ "_CT_" lines of text returned for "_DATA
"RTN","MAGJUTL4",156,0)
 . M @MAGGRY=XMM K XMM
"RTN","MAGJUTL4",157,0)
 E  S REPLY="0^Invalid image data request: "_""""_DATA_""""_" (ck"_INVALID_")."
"RTN","MAGJUTL4",158,0)
 S @MAGGRY@(0)=REPLY
"RTN","MAGJUTL4",159,0)
 Q
"RTN","MAGJUTL4",160,0)
 ;
"RTN","MAGJUTL4",161,0)
 ;+++++ Process according to REQUEST. Called by DATADUMP.
"RTN","MAGJUTL4",162,0)
 ; 
"RTN","MAGJUTL4",163,0)
 ; Calls: GETS^MAGGTSYS, MAG^MAGGTSY1.
"RTN","MAGJUTL4",164,0)
 ;
"RTN","MAGJUTL4",165,0)
 ; Local array MM structures multiple calls' output for centralized processing.
"RTN","MAGJUTL4",166,0)
 ; The array is re-subscripted by converting "," to "." allowing a single MERGE
"RTN","MAGJUTL4",167,0)
 ; to the broker output global.
"RTN","MAGJUTL4",168,0)
 ;   
"RTN","MAGJUTL4",169,0)
 ;   MM(.1:.99) ... Header information.
"RTN","MAGJUTL4",170,0)
 ;   MM(1) ........ CPT (similar) match(es).
"RTN","MAGJUTL4",171,0)
 ;   MM(2) ........ CPT (BodyPart and Modality) match(es).
"RTN","MAGJUTL4",172,0)
 ;   MM(3) ........ FLDS output data.
"RTN","MAGJUTL4",173,0)
 ;   MM(4) ........ GLB output data.
"RTN","MAGJUTL4",174,0)
 ;
"RTN","MAGJUTL4",175,0)
DDMPROCS ;
"RTN","MAGJUTL4",176,0)
 ;
"RTN","MAGJUTL4",177,0)
 ; Initialize.
"RTN","MAGJUTL4",178,0)
 S REPLY="0^Retrieving imaging internal data ..."
"RTN","MAGJUTL4",179,0)
 ;
"RTN","MAGJUTL4",180,0)
 ; Process. CPT request via MAG RAD CPT MATCHING File (#2006.67).
"RTN","MAGJUTL4",181,0)
 I REQUEST="CPT" D DDMPRCPT(CPTFILIEN)
"RTN","MAGJUTL4",182,0)
 I REQUEST="FLDS" D GETS^MAGGTSYS(.M,IMGIEN,PARAM1) M MM(3)=@M K M
"RTN","MAGJUTL4",183,0)
 I REQUEST="GLB" D MAG^MAGGTSY2(.M,IMGIEN) M MM(4)=@M K M
"RTN","MAGJUTL4",184,0)
 ;
"RTN","MAGJUTL4",185,0)
 ; Re-subscript array MM into XMM to simplify MERGE to broker output global.
"RTN","MAGJUTL4",186,0)
 S CT=0,MMX=$NA(MM(0))
"RTN","MAGJUTL4",187,0)
 F  S MMX=$Q(@MMX) Q:MMX=""  S CT=CT+1,XMM(CT)=@MMX
"RTN","MAGJUTL4",188,0)
 K MM,MMX
"RTN","MAGJUTL4",189,0)
 Q
"RTN","MAGJUTL4",190,0)
 ;
"RTN","MAGJUTL4",191,0)
 ;+++++ Process a CPT request. Called by DDMPROCS
"RTN","MAGJUTL4",192,0)
 ;
"RTN","MAGJUTL4",193,0)
 ; Calls CPT^ICPTCOD for CPT Description.
"RTN","MAGJUTL4",194,0)
 ;
"RTN","MAGJUTL4",195,0)
DDMPRCPT(CPTFILIEN) ; 
"RTN","MAGJUTL4",196,0)
 ;
"RTN","MAGJUTL4",197,0)
 ; Initialize.
"RTN","MAGJUTL4",198,0)
 N FN,FN1,NDX,NOD,SS,X
"RTN","MAGJUTL4",199,0)
 ;
"RTN","MAGJUTL4",200,0)
 ; Set section headers.
"RTN","MAGJUTL4",201,0)
 S MM(.1)="Input CPT Code ........... "_CPT_"  ("_CPTNAM_")"
"RTN","MAGJUTL4",202,0)
 S MM(.2)="          Body Part(s) ... "
"RTN","MAGJUTL4",203,0)
 S MM(.3)="          Modality(s) .... "
"RTN","MAGJUTL4",204,0)
 ;
"RTN","MAGJUTL4",205,0)
 ; Set primary CPT bodyPart & modality.
"RTN","MAGJUTL4",206,0)
 S FN=2006.67,FN1=2006.671,NDX=$O(^MAG(FN,"B",CPTFILIEN,""))
"RTN","MAGJUTL4",207,0)
 S NOD=$NA(^MAG(FN,NDX,0)) F  S NOD=$Q(@NOD) Q:$QS(NOD,2)>NDX  I $QS(NOD,4)="B" D
"RTN","MAGJUTL4",208,0)
 . I $QS(NOD,3)=1 S MM(.2)=MM(.2)_$G(^MAG(FN1,$QS(NOD,5),0))_"; "
"RTN","MAGJUTL4",209,0)
 . I $QS(NOD,3)=2 S MM(.3)=MM(.3)_$P($G(^RAMIS(73.1,$QS(NOD,5),0)),U)_"; "
"RTN","MAGJUTL4",210,0)
 . Q
"RTN","MAGJUTL4",211,0)
 ;
"RTN","MAGJUTL4",212,0)
 ; Strip dangling concatenators.
"RTN","MAGJUTL4",213,0)
 F SS=.2,.3 S MM(SS)=$$ZRUPUNCT(MM(SS),"; ","")
"RTN","MAGJUTL4",214,0)
 ;
"RTN","MAGJUTL4",215,0)
 ; Fetch CPTs matching on CPT.
"RTN","MAGJUTL4",216,0)
 D CPTGRP(.M,CPT_"^1") M MM(1)=@M K M
"RTN","MAGJUTL4",217,0)
 S MM(1,0)=$P(MM(1,0),"~ ",2)
"RTN","MAGJUTL4",218,0)
 S MM(1,0)=$J(+$P(MM(1,0)," "),3)_" matching CPT(s) via Similar CPT:"
"RTN","MAGJUTL4",219,0)
 ;
"RTN","MAGJUTL4",220,0)
 ; Fetch CPTs matching on BodyPart & Modality.
"RTN","MAGJUTL4",221,0)
 D CPTGRP(.M,CPT_"^3") M MM(2)=@M K M
"RTN","MAGJUTL4",222,0)
 S MM(2,0)=$P(MM(2,0),"~ ",2)
"RTN","MAGJUTL4",223,0)
 S MM(2,0)=$J(+$P(MM(2,0)," "),3)_" matching CPT(s) via BODY PART and MODALITY:"
"RTN","MAGJUTL4",224,0)
 ;
"RTN","MAGJUTL4",225,0)
 ; Re-format. [Not modular -- should provide for leaving as-is.]
"RTN","MAGJUTL4",226,0)
 S MMX=$NA(MM(.99)) F  S MMX=$Q(@MMX) Q:MMX=""  I @MMX["^" S @MMX="     "_$TR(@MMX,"^"," ")
"RTN","MAGJUTL4",227,0)
 Q
"RTN","MAGJUTL4",228,0)
 ;
"RTN","MAGJUTL4",229,0)
 ;+++++ Validate. Called by DATADUMP.
"RTN","MAGJUTL4",230,0)
 ;
"RTN","MAGJUTL4",231,0)
DDMPVLD8() ;
"RTN","MAGJUTL4",232,0)
 ;
"RTN","MAGJUTL4",233,0)
 ; ... DATA string format or exit invalid (code 1).
"RTN","MAGJUTL4",234,0)
 Q:'$D(DATA) 1
"RTN","MAGJUTL4",235,0)
 Q:DATA="" 1
"RTN","MAGJUTL4",236,0)
 Q:DATA'["^"!(DATA'["|") 1
"RTN","MAGJUTL4",237,0)
 ;
"RTN","MAGJUTL4",238,0)
 ; Initialize.
"RTN","MAGJUTL4",239,0)
 N GO,RACNI,RADFN,RADTI,RARPT S REPLY="0^Validating input parameters ..."
"RTN","MAGJUTL4",240,0)
 S REQUEST=$P(DATA,U),PARAM1=$P($P(DATA,U,2),"|"),PARAM2=$P(DATA,"|",2)
"RTN","MAGJUTL4",241,0)
 ;
"RTN","MAGJUTL4",242,0)
 ; ... DATA string's REQUEST piece or exit (invalid: code 2).
"RTN","MAGJUTL4",243,0)
 Q:"^CPT^FLDS^GLB^"'[(U_REQUEST_U) 2
"RTN","MAGJUTL4",244,0)
 ;
"RTN","MAGJUTL4",245,0)
 ; ... PARAM1 if REQUEST="CPT" or exit (invalid: code 3).
"RTN","MAGJUTL4",246,0)
 I REQUEST="CPT" D  I 'GO Q 3
"RTN","MAGJUTL4",247,0)
 . S GO=PARAM1]"" Q:'GO
"RTN","MAGJUTL4",248,0)
 . S X=$$CPT^ICPTCOD(PARAM1),CPTFILIEN=$P(X,U),CPT=$P(X,U,2),CPTNAM=$P(X,U,3)
"RTN","MAGJUTL4",249,0)
 . I CPTFILIEN,$D(^MAG(2006.67,"B",CPTFILIEN))
"RTN","MAGJUTL4",250,0)
 . E  S GO=0
"RTN","MAGJUTL4",251,0)
 ;
"RTN","MAGJUTL4",252,0)
 ; ... PARAM1 if REQUEST="FLDS" or re-set to null. External call will set defaults.
"RTN","MAGJUTL4",253,0)
 ; .......... only validate format of FileMan flags.
"RTN","MAGJUTL4",254,0)
 I REQUEST="FLDS"&(PARAM1'?1U.U) S PARAM1=""
"RTN","MAGJUTL4",255,0)
 ; 
"RTN","MAGJUTL4",256,0)
 ; ... PARAM2 if REQUEST=("FLDS" or "GLB") or exit (invalid: code 4).
"RTN","MAGJUTL4",257,0)
 I REQUEST="FLDS"!(REQUEST="GLB") S IMGIEN="" D  Q:IMGIEN="" 4
"RTN","MAGJUTL4",258,0)
 . ;
"RTN","MAGJUTL4",259,0)
 . ; Case 1: PARAM2 holds IMGIEN.
"RTN","MAGJUTL4",260,0)
 . I PARAM2?1N.N,$D(^MAG(2005,PARAM2)) S IMGIEN=PARAM2 Q
"RTN","MAGJUTL4",261,0)
 . ;
"RTN","MAGJUTL4",262,0)
 . ; Case 2: PARAM2 holds RARPT in piece 4, set IMGIEN via back-pointer in File #74.
"RTN","MAGJUTL4",263,0)
 . I $L(PARAM2,U)=4 S RARPT=$P(PARAM2,U,4),IMGIEN=$O(^RARPT(RARPT,2005,"B",""))
"RTN","MAGJUTL4",264,0)
 . I IMGIEN'="",$D(^MAG(2005,IMGIEN)) Q
"RTN","MAGJUTL4",265,0)
 . ;
"RTN","MAGJUTL4",266,0)
 . ; Case 3: PARAM2 holds RADFN^RADTI^RACNI in pieces 1:3.
"RTN","MAGJUTL4",267,0)
 . S RADFN=+PARAM2,RADTI=$P(PARAM2,U,2),RACNI=$P(PARAM2,U,3)
"RTN","MAGJUTL4",268,0)
 . I RADFN,RADTI,RACNI D
"RTN","MAGJUTL4",269,0)
 . . S RARPT=$P(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0),U,17)
"RTN","MAGJUTL4",270,0)
 . . I RARPT'="",$D(^RARPT(RARPT,2005,"B"))>1 S IMGIEN=$O(^RARPT(RARPT,2005,"B",""))
"RTN","MAGJUTL4",271,0)
 Q 0
"RTN","MAGJUTL4",272,0)
 ;
"RTN","MAGJUTL4",273,0)
 ;***** Check Exam Status.
"RTN","MAGJUTL4",274,0)
 ; RPC: MAGJ RADSTATUSCHECK
"RTN","MAGJUTL4",275,0)
 ;
"RTN","MAGJUTL4",276,0)
STATCHK(MAGGRY,DATA) ;
"RTN","MAGJUTL4",277,0)
 ; This may also be accessed by subroutine call. <*> do not change name of EP
"RTN","MAGJUTL4",278,0)
 ; Exam Status check RPC and subroutine: determine if the exam has been Tech-Verified (at least).
"RTN","MAGJUTL4",279,0)
 ; Images are assumed to be verified if Exam Status is Examined, or higher status.
"RTN","MAGJUTL4",280,0)
 ;       ; Input in DATA: RADFN^RADTI^RACNI^RARPT
"RTN","MAGJUTL4",281,0)
 ;   Input is either RADFN, RADTI, and RACNI; or, RARPT only may be input in piece 4
"RTN","MAGJUTL4",282,0)
 ;   Return: Code^Text
"RTN","MAGJUTL4",283,0)
 ;    0 = Problem, or exam was cancelled
"RTN","MAGJUTL4",284,0)
 ;    1 = Not yet verified
"RTN","MAGJUTL4",285,0)
 ;    2 = Tech Verified
"RTN","MAGJUTL4",286,0)
 ;    3 = Radiologist Verified
"RTN","MAGJUTL4",287,0)
 ;    4 = User is a Radiology professional--always allow access
"RTN","MAGJUTL4",288,0)
 ;
"RTN","MAGJUTL4",289,0)
 N $ETRAP,$ESTACK S $ETRAP="G ERR3^MAGJUTL4"
"RTN","MAGJUTL4",290,0)
 N REPLY,STATUS,ORDER,VCAT,STOUT
"RTN","MAGJUTL4",291,0)
 N DIQUIET,RARPT,RADFN,RADTI,RACNI
"RTN","MAGJUTL4",292,0)
 S DIQUIET=1 D DT^DICRW
"RTN","MAGJUTL4",293,0)
 S RADFN=$P(DATA,U),RADTI=$P(DATA,U,2),RACNI=$P(DATA,U,3),RARPT=$P(DATA,U,4)
"RTN","MAGJUTL4",294,0)
 S STOUT="",REPLY="0^Getting image verification status."
"RTN","MAGJUTL4",295,0)
 I RADFN,RADTI,RACNI
"RTN","MAGJUTL4",296,0)
 E  I RARPT D RPT2DPT(RARPT,.X) I X S RADFN=+X,RADTI=$P(X,U,2),RACNI=$P(X,U,3) I RADFN,RADTI,RACNI
"RTN","MAGJUTL4",297,0)
 E  S REPLY="0^Image Verification Status request contains invalid case pointer ("_DATA_")" G STATCHKZ
"RTN","MAGJUTL4",298,0)
 S STATUS=$P($G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0)),U,3)
"RTN","MAGJUTL4",299,0)
 I STATUS="" S REPLY="0^Image Verification Status request error--no Exam Status is defined for ("_DATA_")" G STATCHKZ
"RTN","MAGJUTL4",300,0)
 S VCAT=$P(^RA(72,STATUS,0),U,9),ORDER=$P(^(0),U,3)
"RTN","MAGJUTL4",301,0)
 I VCAT]"" D  G STATCHK2:STOUT
"RTN","MAGJUTL4",302,0)
 . I "EDT"[VCAT S STOUT=$S(VCAT="E":2,1:3) ; Examined or Interpreted
"RTN","MAGJUTL4",303,0)
 . E  I VCAT="W" S STOUT=1 ; Not yet Verified
"RTN","MAGJUTL4",304,0)
 I ORDER=9 S STOUT=3  ; Completed exam
"RTN","MAGJUTL4",305,0)
 E  I ORDER=0 S REPLY="0^Exam Cancelled"
"RTN","MAGJUTL4",306,0)
 E  I ORDER=1 S STOUT=1  ; Waiting for exam
"RTN","MAGJUTL4",307,0)
STATCHK2 ;
"RTN","MAGJUTL4",308,0)
 I STOUT<2 D
"RTN","MAGJUTL4",309,0)
 . F X="S","R","T" I $D(^VA(200,"ARC",X,DUZ)) S STOUT=4 Q  ; Radiologist or Tech -- OK to access
"RTN","MAGJUTL4",310,0)
STATCHKZ ;
"RTN","MAGJUTL4",311,0)
 I STOUT S REPLY=STOUT_U_$S(STOUT=1:"Images not yet verified",STOUT=2:"Images verified by Technologist",STOUT=3:"Images interpreted by Radiologist",STOUT=4:"Radiology professional--OK to view images.",1:"")
"RTN","MAGJUTL4",312,0)
 S MAGGRY=REPLY
"RTN","MAGJUTL4",313,0)
 Q
"RTN","MAGJUTL4",314,0)
 ;
"RTN","MAGJUTL4",315,0)
 ;***** User set/clear flag to show/not show remote exams only.
"RTN","MAGJUTL4",316,0)
 ; RPC: MAGJ REMOTESCREEN
"RTN","MAGJUTL4",317,0)
 ;
"RTN","MAGJUTL4",318,0)
REMSCRN(MAGGRY,DATA) ;
"RTN","MAGJUTL4",319,0)
 ; Input in DATA: 1/0 1=show remote only; 0=show all exams
"RTN","MAGJUTL4",320,0)
 ; Return: Reply^Code~msg
"RTN","MAGJUTL4",321,0)
 ;    Reply -- 0=Problem; 1=Success
"RTN","MAGJUTL4",322,0)
 ;    Code -- 4=Error; 1=ok
"RTN","MAGJUTL4",323,0)
 ;    msg -- display text if error
"RTN","MAGJUTL4",324,0)
 ;
"RTN","MAGJUTL4",325,0)
 N $ETRAP,$ESTACK S $ETRAP="G ERR3^MAGJUTL4"
"RTN","MAGJUTL4",326,0)
 N REPLY
"RTN","MAGJUTL4",327,0)
 N DIQUIET S DIQUIET=1 D DT^DICRW
"RTN","MAGJUTL4",328,0)
 I $D(DATA),(DATA=0!(DATA=1))
"RTN","MAGJUTL4",329,0)
 E  S REPLY="0^4~REMOTESCREEN request has invalid parameter ("_$G(DATA)_")" G REMSCRNZ
"RTN","MAGJUTL4",330,0)
 S MAGJOB("REMOTESCREEN")=DATA,REPLY="1^1~"_DATA
"RTN","MAGJUTL4",331,0)
REMSCRNZ ;
"RTN","MAGJUTL4",332,0)
 S MAGGRY=REPLY
"RTN","MAGJUTL4",333,0)
 Q
"RTN","MAGJUTL4",334,0)
 ;
"RTN","MAGJUTL4",335,0)
RPT2DPT(RARPT,RET) ; Input RARPT. Return RET containing exam ss values for ^RADPT
"RTN","MAGJUTL4",336,0)
 ;
"RTN","MAGJUTL4",337,0)
 N DFN,DTI,CNI S (DFN,DTI,CNI)=""
"RTN","MAGJUTL4",338,0)
 I RARPT?1N.N,$D(^RARPT(RARPT)) S X=$G(^(RARPT,0)) I X]"" D
"RTN","MAGJUTL4",339,0)
 . S X=$P(X,U)
"RTN","MAGJUTL4",340,0)
 . S X=$O(^RADPT("ADC",X,0)) I X S DFN=X,DTI=$O(^(X,0)),CNI=$O(^(DTI,0))
"RTN","MAGJUTL4",341,0)
 . S RET=DFN_U_DTI_U_CNI
"RTN","MAGJUTL4",342,0)
 E  S RET=""
"RTN","MAGJUTL4",343,0)
 Q
"RTN","MAGJUTL4",344,0)
 ;
"RTN","MAGJUTL4",345,0)
ERR1 N ERR S ERR=$$EC^%ZOSV S @MAGGRY@(0)="0^4~"_ERR G ERR
"RTN","MAGJUTL4",346,0)
ERR3 N ERR S ERR=$$EC^%ZOSV S MAGGRY="0^4~"_ERR
"RTN","MAGJUTL4",347,0)
ERR D @^%ZOSF("ERRTN")
"RTN","MAGJUTL4",348,0)
 Q:$Q 1  Q
"RTN","MAGJUTL4",349,0)
 ;
"RTN","MAGJUTL4",350,0)
END Q  ;
"RTN","MAGJUTL4",351,0)
 ;
"RTN","MAGJUTL4",352,0)
 ;***** Identify if mammogram via CPT Code. Called by OPENCASE^MAGJEX1.
"RTN","MAGJUTL4",353,0)
 ;
"RTN","MAGJUTL4",354,0)
 ; Calls ZRUMDLST, $$CPT^ICPTCOD (which may return "-1^NO SUCH ENTRY").
"RTN","MAGJUTL4",355,0)
 ;
"RTN","MAGJUTL4",356,0)
 ; CPT     CPT Code
"RTN","MAGJUTL4",357,0)
 ;
"RTN","MAGJUTL4",358,0)
 ; Return Value:
"RTN","MAGJUTL4",359,0)
 ;      0  NOT a mammogram.
"RTN","MAGJUTL4",360,0)
 ;      1  IS  a mammogram.
"RTN","MAGJUTL4",361,0)
 ;
"RTN","MAGJUTL4",362,0)
ZRUMAMMO(CPT) ;
"RTN","MAGJUTL4",363,0)
 N CPTCATIEN,YN S YN=0
"RTN","MAGJUTL4",364,0)
 S CPTCATIEN=$P($$CPT^ICPTCOD(CPT),U,4) Q:CPTCATIEN="" YN Q:+CPTCATIEN<0 YN
"RTN","MAGJUTL4",365,0)
 ;
"RTN","MAGJUTL4",366,0)
 ; Criterion (1A): CPT Category (cf., ^DIC(81.1,240,0)=BREAST MAMMOGRAPHY^s^4^77051^77059^C).
"RTN","MAGJUTL4",367,0)
 I $P(^DIC(81.1,CPTCATIEN,0),U)="BREAST MAMMOGRAPHY" S YN=1 D
"RTN","MAGJUTL4",368,0)
 . ;
"RTN","MAGJUTL4",369,0)
 . ; Criterion (1B): CPT "Modality" (using MAGS array's modalities via ZRUMDLST).
"RTN","MAGJUTL4",370,0)
 . N MODALITY
"RTN","MAGJUTL4",371,0)
 . D ZRUMDLST(.MAGS) I '$D(MAGMDLST) S YN=1 Q
"RTN","MAGJUTL4",372,0)
 . F MODALITY="MR","OCT","US" S:$D(MAGMDLST(MODALITY)) YN=0
"RTN","MAGJUTL4",373,0)
 ;
"RTN","MAGJUTL4",374,0)
 ; Criterion (2) -- Deprecated mammography CPTs.
"RTN","MAGJUTL4",375,0)
 E  D
"RTN","MAGJUTL4",376,0)
 . N CPTMAM F CPTMAM=76082,76083,76085:1:76092 I CPT=CPTMAM S YN=1 Q
"RTN","MAGJUTL4",377,0)
 Q YN
"RTN","MAGJUTL4",378,0)
 ;
"RTN","MAGJUTL4",379,0)
 ;+++++ Array any unique MAGS' piece 3 modalities. Called by ZRUMAMMO.
"RTN","MAGJUTL4",380,0)
 ;
"RTN","MAGJUTL4",381,0)
 ; .MAGS      Array of individual image data (cf. JBFETCH^MAGJUTL2).
"RTN","MAGJUTL4",382,0)
 ; 
"RTN","MAGJUTL4",383,0)
 ; Sets array MAGMDLST(modality).
"RTN","MAGJUTL4",384,0)
 ; 
"RTN","MAGJUTL4",385,0)
ZRUMDLST(MAGS) ;
"RTN","MAGJUTL4",386,0)
 K MAGMDLST
"RTN","MAGJUTL4",387,0)
 I $D(MAGS),MAGS N MD0,X F X=1:1:MAGS D
"RTN","MAGJUTL4",388,0)
 . S MD0=$P(MAGS(X),U,3) I MD0'="",'$D(MAGMDLST(MD0)) S MAGMDLST(MD0)=""
"RTN","MAGJUTL4",389,0)
 Q
"RTN","MAGJUTL4",390,0)
 ;
"RTN","MAGJUTL4",391,0)
 ;+++++ Strip IN's trailing elements & append REPL.
"RTN","MAGJUTL4",392,0)
 ;
"RTN","MAGJUTL4",393,0)
 ; IN       String to operate on.
"RTN","MAGJUTL4",394,0)
 ; REPL     String to place at right end.
"RTN","MAGJUTL4",395,0)
 ; STRIP    String to remove from right end.
"RTN","MAGJUTL4",396,0)
 ;
"RTN","MAGJUTL4",397,0)
 ; Returns:
"RTN","MAGJUTL4",398,0)
 ;      IN_REPL
"RTN","MAGJUTL4",399,0)
 ;
"RTN","MAGJUTL4",400,0)
ZRUPUNCT(IN,STRIP,REPL) ;
"RTN","MAGJUTL4",401,0)
 Q:'$D(IN)!('$D(STRIP))!('$D(REPL))  F  Q:STRIP'[$E(IN,$L(IN))  S IN=$E(IN,1,$L(IN)-1)
"RTN","MAGJUTL4",402,0)
 Q IN_REPL
"RTN","MAGJUTL4",403,0)
 ;
"RTN","MAGJUTL4",404,0)
 ; ***** Query to modify existing annotations. Called by OPENCASE^MAGJEX1
"RTN","MAGJUTL4",405,0)
 ; 
"RTN","MAGJUTL4",406,0)
 ; DUZ      Kernel internal user identifier.
"RTN","MAGJUTL4",407,0)
 ; RACNI    RAD/NUC Med Patient File (#70) Case Number Index
"RTN","MAGJUTL4",408,0)
 ; RADFN    "                              Patient DFN
"RTN","MAGJUTL4",409,0)
 ; RADTI    "                              Study Internal Date
"RTN","MAGJUTL4",410,0)
 ; 
"RTN","MAGJUTL4",411,0)
 ; Return Value:
"RTN","MAGJUTL4",412,0)
 ;      0   NOT authorized to annotate.
"RTN","MAGJUTL4",413,0)
 ;      1   AUTHORIZED     "".
"RTN","MAGJUTL4",414,0)
 ; 
"RTN","MAGJUTL4",415,0)
ZRUREVAN(RADFN,RADTI,RACNI) ;
"RTN","MAGJUTL4",416,0)
 ;
"RTN","MAGJUTL4",417,0)
 ; Initialize. Exit if RAxxx pointers fail.
"RTN","MAGJUTL4",418,0)
 N EXAMSTAT,EXMSTSPT,RADNOD,RIST1,RIST2,YN
"RTN","MAGJUTL4",419,0)
 S YN=0,RADNOD=$G(^RADPT(RADFN,"DT",RADTI,"P",RACNI,0))
"RTN","MAGJUTL4",420,0)
 Q:RADNOD="" YN
"RTN","MAGJUTL4",421,0)
 ;
"RTN","MAGJUTL4",422,0)
 ; Collect data about ...
"RTN","MAGJUTL4",423,0)
 S RIST1=$P(RADNOD,U,12) ; .. PRIMARY INTERPRETING RESIDENT [12P:200]
"RTN","MAGJUTL4",424,0)
 S RIST2=$P(RADNOD,U,15) ; .. PRIMARY INTERPRETING STAFF [15P:200]
"RTN","MAGJUTL4",425,0)
 S EXMSTSPT=$P(RADNOD,U,3) ;. EXAM STATUS [3P:72]
"RTN","MAGJUTL4",426,0)
 S EXAMSTAT=$P($G(^RA(72,EXMSTSPT,0)),U,9) ; VISTARAD CATEGORY (#9)
"RTN","MAGJUTL4",427,0)
 ;
"RTN","MAGJUTL4",428,0)
 I EXAMSTAT="D"!(EXAMSTAT="T") D
"RTN","MAGJUTL4",429,0)
 . ;
"RTN","MAGJUTL4",430,0)
 . ; 'Yes' if CurrentUser=Primary Interpreting Radiologist.
"RTN","MAGJUTL4",431,0)
 . I DUZ=RIST1!(DUZ=RIST2) S YN=1
"RTN","MAGJUTL4",432,0)
 . E  I RIST1'="",$D(^VA(200,"ARC","S",+DUZ)) S YN=1 ; 'Yes' if (Primary Interpreting Radiologist is Resident) & (CurrentUser is Staff)
"RTN","MAGJUTL4",433,0)
 . Q
"RTN","MAGJUTL4",434,0)
 Q YN
"RTN","MAGJUTL5")
0^14^B38114169
"RTN","MAGJUTL5",1,0)
MAGJUTL5 ;WOIFO/JHC - VistARad RPCs ; 24 Apr 2012  7:35 PM
"RTN","MAGJUTL5",2,0)
 ;;3.0;IMAGING;**65,76,101,90,115,104,120**;Mar 19, 2002;Build 27;May 23, 2012
"RTN","MAGJUTL5",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGJUTL5",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL5",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGJUTL5",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGJUTL5",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGJUTL5",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGJUTL5",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGJUTL5",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGJUTL5",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGJUTL5",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGJUTL5",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGJUTL5",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGJUTL5",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGJUTL5",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGJUTL5",17,0)
 ;;
"RTN","MAGJUTL5",18,0)
 Q
"RTN","MAGJUTL5",19,0)
 ; adapted from MAGGTU4
"RTN","MAGJUTL5",20,0)
GETVER(SVRVER,SVRTVER,ALLOWCL,VIXVER) ;
"RTN","MAGJUTL5",21,0)
 ; The Server Version SVRVER is hardcoded to match the Client
"RTN","MAGJUTL5",22,0)
 ; so this Routine must be edited/distributed with a new Client
"RTN","MAGJUTL5",23,0)
 ; released Client will have the T version that the server expects
"RTN","MAGJUTL5",24,0)
 ;
"RTN","MAGJUTL5",25,0)
 ;--- Synchronize the below information with that in MAGJTU4V.
"RTN","MAGJUTL5",26,0)
 ;
"RTN","MAGJUTL5",27,0)
 S SVRVER="3.0.120",SVRTVER=8  ; <*> Edit this line for each patch/T-version
"RTN","MAGJUTL5",28,0)
 ;
"RTN","MAGJUTL5",29,0)
 S ALLOWCL="|3.0.115|"  ; back-compatible with P115 client
"RTN","MAGJUTL5",30,0)
 ;
"RTN","MAGJUTL5",31,0)
 S VIXVER=""
"RTN","MAGJUTL5",32,0)
 ; VIX may present versions different from vrad Client/Server versions; this would
"RTN","MAGJUTL5",33,0)
 ; happen if M-only changes are made to vrad Server code as part of a VIX patch
"RTN","MAGJUTL5",34,0)
 ; to support updated VIX-related functionality. VIXVERS contains the version numbers
"RTN","MAGJUTL5",35,0)
 ; that are to be supported in this fashion; related M changes need to be back-compatible
"RTN","MAGJUTL5",36,0)
 ; with prior vrad versions' behavior in the interface
"RTN","MAGJUTL5",37,0)
 N T,VIXVERS
"RTN","MAGJUTL5",38,0)
 S VIXVERS="|3.0.104|" ; keep compatible with P115 & P90  <*> edit as needed for patches
"RTN","MAGJUTL5",39,0)
 S T=$G(MAGJOB("VIX"))
"RTN","MAGJUTL5",40,0)
 I T,VIXVERS[("|"_T_"|") S ALLOWCL=ALLOWCL_T_"|",VIXVER=T
"RTN","MAGJUTL5",41,0)
 Q
"RTN","MAGJUTL5",42,0)
 ;
"RTN","MAGJUTL5",43,0)
CHKVER(MAGRY,CLVER,PLC,SVERSION) ;
"RTN","MAGJUTL5",44,0)
 ; Input CLVER is the version of the Client
"RTN","MAGJUTL5",45,0)
 ;    format: Major.Minor.Patch.Build# [|VIX] -- eg 3.0.115.4|VIX
"RTN","MAGJUTL5",46,0)
 ;       Build # = T-version; VIX string only appears if a VIX session
"RTN","MAGJUTL5",47,0)
 ; 3 possible return codes in MAGRY:
"RTN","MAGJUTL5",48,0)
 ;   2^n~msg : Client displays a message and continues
"RTN","MAGJUTL5",49,0)
 ;   1^1~msg : Client continues without displaying a message
"RTN","MAGJUTL5",50,0)
 ;   0^n~msg : Client displays a message then Aborts
"RTN","MAGJUTL5",51,0)
 ; PLC returns 2006.1 pointer
"RTN","MAGJUTL5",52,0)
 ;
"RTN","MAGJUTL5",53,0)
 S CLVER=$G(CLVER),PLC="",MAGRY=""
"RTN","MAGJUTL5",54,0)
 N SV,ST,CV,CT,CP,ALLOWV,TESTFLAG,SVSTAT,VIXVER
"RTN","MAGJUTL5",55,0)
 ; SVERSION = Full Server Version -> (3.0.18.132 or 3.0.18); test has 4, release has 3 parts
"RTN","MAGJUTL5",56,0)
 ; SV = Server Version -> (3.0.18); only 1st 3 parts
"RTN","MAGJUTL5",57,0)
 ; ST = Server T Version -> defined to always match client part-4
"RTN","MAGJUTL5",58,0)
 ; CV = Client Version, w/out build #
"RTN","MAGJUTL5",59,0)
 ; CT = Client T Version alone
"RTN","MAGJUTL5",60,0)
 ; CP = Client Patch alone
"RTN","MAGJUTL5",61,0)
 ; ALLOWV = Hard coded string of allowed clients for this KIDS.
"RTN","MAGJUTL5",62,0)
 ; TESTFLAG = 1/0  -- 1=Test vs of server code; 0=Release vs
"RTN","MAGJUTL5",63,0)
 ;   get VIX version if a VIX session
"RTN","MAGJUTL5",64,0)
 I $P(CLVER,"|",2)["VIX" S MAGJOB("VIX")=$P(CLVER,"|")  ; VIX facade version
"RTN","MAGJUTL5",65,0)
 ;
"RTN","MAGJUTL5",66,0)
 I $G(DUZ(2)) S PLC=$$PLACE^MAGBAPI(DUZ(2))
"RTN","MAGJUTL5",67,0)
 ;  Quit if we don't have a valid DUZ(2) or valid PLACE: ^MAG(2006.1,PLC)
"RTN","MAGJUTL5",68,0)
 I 'PLC S MAGRY="0^4~Error verifying Imaging Site (Place) -- Contact Imaging support." Q
"RTN","MAGJUTL5",69,0)
 ;
"RTN","MAGJUTL5",70,0)
 D GETVER(.SV,.ST,.ALLOWV,.VIXVER)
"RTN","MAGJUTL5",71,0)
 S CLVER=$P(CLVER,"|")
"RTN","MAGJUTL5",72,0)
 S CV=$P(CLVER,".",1,3),CT=+$P(CLVER,".",4),CP=+$P(CLVER,".",3)
"RTN","MAGJUTL5",73,0)
 ;
"RTN","MAGJUTL5",74,0)
 D VERSTAT(.SVSTAT,SV)
"RTN","MAGJUTL5",75,0)
 I 'SVSTAT S MAGRY=SVSTAT Q  ; KIDS status for this version indeterminate
"RTN","MAGJUTL5",76,0)
 S TESTFLAG=(+SVSTAT=1)
"RTN","MAGJUTL5",77,0)
 S SVERSION=SV
"RTN","MAGJUTL5",78,0)
 I TESTFLAG S SVERSION=SV_"."_ST
"RTN","MAGJUTL5",79,0)
 ; Check Version differences:
"RTN","MAGJUTL5",80,0)
 I (CV'=SV) D  Q
"RTN","MAGJUTL5",81,0)
 . I '(ALLOWV[("|"_CV_"|")) D  Q
"RTN","MAGJUTL5",82,0)
 . . S MAGRY="0^4~VistARad Workstation software version "_CLVER_" is not compatible with the VistA server version "_SVERSION_".  Contact Imaging support. (CNA)"
"RTN","MAGJUTL5",83,0)
 . ; Warn the Client (unless VIX), allow to continue
"RTN","MAGJUTL5",84,0)
 . I TESTFLAG S MAGRY="2^3~VistARad Workstation software version "_CLVER_" is running with VistA server TEST Version "_SVERSION_" --  VistARad will Continue, but contact Imaging Support if problems occur. (Pdif)"
"RTN","MAGJUTL5",85,0)
 . E  I VIXVER]"" S MAGRY="1^1~VIX software vs. "_CLVER_" is running with VistA server vs. "_SVERSION_". (VIXdif)"
"RTN","MAGJUTL5",86,0)
 . E  S MAGRY="2^3~VistARad Workstation software version "_CLVER_" is running with VistA server Version "_SVERSION_" --  VistARad will Continue, but contact Imaging Support to install Released Version. (RPdif)"
"RTN","MAGJUTL5",87,0)
 . Q
"RTN","MAGJUTL5",88,0)
 ; Versions are the Same: If T versions are not, warn the Client if needed.
"RTN","MAGJUTL5",89,0)
 ; Released Client (of any version) will have the T version that the server
"RTN","MAGJUTL5",90,0)
 ; expects, and no warning will be displayed.
"RTN","MAGJUTL5",91,0)
 I CT,(CT'=ST) D  Q
"RTN","MAGJUTL5",92,0)
 . I TESTFLAG S MAGRY="2^3~VistARad Workstation software vs. "_CLVER_" is running with VistA server TEST vs. "_SVERSION_" --  VistARad will Continue, but contact Imaging Support " D
"RTN","MAGJUTL5",93,0)
 . . I CT<ST S MAGRY=MAGRY_"to install updated client software.  (Tdif-1)"
"RTN","MAGJUTL5",94,0)
 . . E  S MAGRY=MAGRY_"to update the Server software.  (Tdif-2)"
"RTN","MAGJUTL5",95,0)
 . E  S MAGRY="2^3~VistARad Workstation software vs. "_CLVER_" is running with VistA server vs. "_SVERSION_" --  VistARad will Continue, but contact Imaging Support to install Released Version. (RVdif)"
"RTN","MAGJUTL5",96,0)
 . Q
"RTN","MAGJUTL5",97,0)
 ; Client and Server Versions are the same
"RTN","MAGJUTL5",98,0)
 S MAGRY="1^1~Version Check OK. Server: "_SVERSION_" Client: "_CLVER Q
"RTN","MAGJUTL5",99,0)
 Q
"RTN","MAGJUTL5",100,0)
 ;
"RTN","MAGJUTL5",101,0)
P32STOP(RET) ; logic to indicate P32 should no longer function, once the RELEASED P76 is installed
"RTN","MAGJUTL5",102,0)
 ; This is invoked from magjutl3, P76 version, if a P32 client is launched
"RTN","MAGJUTL5",103,0)
 ; RET=1/0 ^ text -- 0 = OK to run P32; 1 = Not OK
"RTN","MAGJUTL5",104,0)
 N SV,ST,ALLOWV,SVSTAT,RELEASED
"RTN","MAGJUTL5",105,0)
 S RET="0^P32 supported" ; init return to allow p32 to function
"RTN","MAGJUTL5",106,0)
 D GETVER(.SV,.ST,.ALLOWV)
"RTN","MAGJUTL5",107,0)
 D VERSTAT(.SVSTAT,SV)
"RTN","MAGJUTL5",108,0)
 I 'SVSTAT S RET="0^Error, but on side of caution, allow running." Q  ; KIDS status for this version indeterminate
"RTN","MAGJUTL5",109,0)
 S RELEASED=(+SVSTAT=2)
"RTN","MAGJUTL5",110,0)
 I RELEASED!(SV'="3.0.76") S RET="1^P32 support over"  ; don't allow P32 to function
"RTN","MAGJUTL5",111,0)
 Q
"RTN","MAGJUTL5",112,0)
 ;
"RTN","MAGJUTL5",113,0)
VERSTAT(MAGRY,MAGVER) ;
"RTN","MAGJUTL5",114,0)
 ; Returns the status of an Imaging Version
"RTN","MAGJUTL5",115,0)
 ; Input:
"RTN","MAGJUTL5",116,0)
 ;   MAGVER - Version number in format  MAG*3.0*59 or 3.0.59
"RTN","MAGJUTL5",117,0)
 ; Return: MAGRY = 0/1/2 -- see below; 0: abort; else, OK to proceed
"RTN","MAGJUTL5",118,0)
 ;
"RTN","MAGJUTL5",119,0)
 N VERI,TVER,MAGERR
"RTN","MAGJUTL5",120,0)
 I +MAGVER S MAGVER="MAG*"_$P(MAGVER,".",1,2)_"*"_$P(MAGVER,".",3)
"RTN","MAGJUTL5",121,0)
 S VERI=$$FIND1^DIC(9.6,"","O",MAGVER,"","","MAGERR")
"RTN","MAGJUTL5",122,0)
 I 'VERI S MAGRY="0^4~There is No KIDs Install record."
"RTN","MAGJUTL5",123,0)
 E  D
"RTN","MAGJUTL5",124,0)
 . S TVER=$$GET1^DIQ(9.6,VERI_",","ALPHA/BETA TESTING")
"RTN","MAGJUTL5",125,0)
 . I TVER="YES" S MAGRY="1^Alpha/Beta Version"
"RTN","MAGJUTL5",126,0)
 . E  I TVER="NO" S MAGRY="2^Released Version"
"RTN","MAGJUTL5",127,0)
 . E  S MAGRY="0^4~KIDs Install Status is unknown--contact Customer Support."
"RTN","MAGJUTL5",128,0)
 Q       ;
"RTN","MAGJUTL5",129,0)
END ;
"VER")
8.0^22.0
**END**
**END**
