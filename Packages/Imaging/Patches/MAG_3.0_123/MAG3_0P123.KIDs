KIDS Distribution saved on Jul 24, 2012@17:11:19
VistA Imaging V3.0 - Patch 123 - 07/24/2012 17:11PM
**KIDS**:MAG*3.0*123^

**INSTALL NAME**
MAG*3.0*123
"BLD",3463,0)
MAG*3.0*123^IMAGING^0^3120724^y
"BLD",3463,1,0)
^^30^30^3120724^
"BLD",3463,1,1,0)
Version 3.0 Patch 123 - IHS Patient Identifier
"BLD",3463,1,2,0)
 
"BLD",3463,1,3,0)
 
"BLD",3463,1,4,0)
Routines:
"BLD",3463,1,5,0)
MAG7RS      new value = 63369541
"BLD",3463,1,6,0)
MAGDCCS     new value = 66427733
"BLD",3463,1,7,0)
MAGDCCS2    new value = 18217795
"BLD",3463,1,8,0)
MAGDCCSD    new value = 10038347
"BLD",3463,1,9,0)
MAGDHLS     new value = 74934022
"BLD",3463,1,10,0)
MAGDIR81    new value = 83085338
"BLD",3463,1,11,0)
MAGDIR8A    new value = 36721014
"BLD",3463,1,12,0)
MAGDLB1     new value = 55699904
"BLD",3463,1,13,0)
MAGDLB12    new value = 22962820
"BLD",3463,1,14,0)
MAGDLB9     new value = 9624068
"BLD",3463,1,15,0)
MAGDLBAA    new value = 20043797
"BLD",3463,1,16,0)
MAGDQR03    new value = 166761513
"BLD",3463,1,17,0)
MAGDQR04    new value = 78024448
"BLD",3463,1,18,0)
MAGDQR21    new value = 160483069
"BLD",3463,1,19,0)
MAGDRA1     new value = 21556631
"BLD",3463,1,20,0)
MAGDRA2     new value = 31366232
"BLD",3463,1,21,0)
MAGDRAHL    new value = 8412113
"BLD",3463,1,22,0)
MAGDRPC3    new value = 57972489
"BLD",3463,1,23,0)
MAGDRPC9    new value = 55813118
"BLD",3463,1,24,0)
MAGDRPCA    new value = 93958807
"BLD",3463,1,25,0)
MAGDTR05    new value = 48114402
"BLD",3463,1,26,0)
MAGIP123    new value = 4047569
"BLD",3463,1,27,0)
MAGSPID     new value = 3966944
"BLD",3463,1,28,0)
 
"BLD",3463,1,29,0)
Please note that routine MAGIP123 is deleted after the KIDS Build is
"BLD",3463,1,30,0)
installed.
"BLD",3463,4,0)
^9.64PA^2006.563^1
"BLD",3463,6.3)
V3.0p123Build67_T7
"BLD",3463,4,2006.563,0)
2006.563
"BLD",3463,4,2006.563,2,0)
^9.641^2006.563^1
"BLD",3463,4,2006.563,2,2006.563,0)
DICOM GATEWAY PARAMETER  (File-top level)
"BLD",3463,4,2006.563,2,2006.563,1,0)
^9.6411^202^1
"BLD",3463,4,2006.563,2,2006.563,1,202,0)
AGENCY
"BLD",3463,4,2006.563,222)
y^y^p^^^^n^^n
"BLD",3463,4,2006.563,224)

"BLD",3463,4,"APDD",2006.563,2006.563)

"BLD",3463,4,"APDD",2006.563,2006.563)

"BLD",3463,4,"APDD",2006.563,2006.563,202)

"BLD",3463,4,"B",2006.563,2006.563)

"BLD",3463,"ABNS",0)
^9.66A^^
"BLD",3463,"ABPKG")
n^n^G.IMAGING DEVELOPMENT TEAM@DOMAIN.EXT
"BLD",3463,"INID")
n^y^n
"BLD",3463,"INIT")
POST^MAGIP123
"BLD",3463,"KRN",0)
^9.67PA^8994^19
"BLD",3463,"KRN",.4,0)
.4
"BLD",3463,"KRN",.4,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.401,0)
.401
"BLD",3463,"KRN",.401,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.402,0)
.402
"BLD",3463,"KRN",.402,"NM",0)
^9.68A^^
"BLD",3463,"KRN",.403,0)
.403
"BLD",3463,"KRN",.5,0)
.5
"BLD",3463,"KRN",.84,0)
.84
"BLD",3463,"KRN",.84,"NM",0)
^9.68A^^
"BLD",3463,"KRN",3.6,0)
3.6
"BLD",3463,"KRN",3.8,0)
3.8
"BLD",3463,"KRN",9.2,0)
9.2
"BLD",3463,"KRN",9.8,0)
9.8
"BLD",3463,"KRN",9.8,"NM",0)
^9.68A^22^22
"BLD",3463,"KRN",9.8,"NM",1,0)
MAG7RS^^0^B63369541
"BLD",3463,"KRN",9.8,"NM",2,0)
MAGDCCS^^0^B66427733
"BLD",3463,"KRN",9.8,"NM",3,0)
MAGDCCS2^^0^B18217795
"BLD",3463,"KRN",9.8,"NM",4,0)
MAGDCCSD^^0^B10038347
"BLD",3463,"KRN",9.8,"NM",5,0)
MAGDHLS^^0^B74934022
"BLD",3463,"KRN",9.8,"NM",6,0)
MAGDIR81^^0^B83085338
"BLD",3463,"KRN",9.8,"NM",7,0)
MAGDIR8A^^0^B36721014
"BLD",3463,"KRN",9.8,"NM",8,0)
MAGDLB1^^0^B55699904
"BLD",3463,"KRN",9.8,"NM",9,0)
MAGDLB12^^0^B22962820
"BLD",3463,"KRN",9.8,"NM",10,0)
MAGDLB9^^0^B9624068
"BLD",3463,"KRN",9.8,"NM",11,0)
MAGDLBAA^^0^B20043797
"BLD",3463,"KRN",9.8,"NM",12,0)
MAGDQR03^^0^B166761513
"BLD",3463,"KRN",9.8,"NM",13,0)
MAGDQR04^^0^B78024448
"BLD",3463,"KRN",9.8,"NM",14,0)
MAGDQR21^^0^B160483069
"BLD",3463,"KRN",9.8,"NM",15,0)
MAGDRA1^^0^B21556631
"BLD",3463,"KRN",9.8,"NM",16,0)
MAGDRA2^^0^B31366232
"BLD",3463,"KRN",9.8,"NM",17,0)
MAGDRAHL^^0^B8412113
"BLD",3463,"KRN",9.8,"NM",18,0)
MAGDRPC3^^0^B57972489
"BLD",3463,"KRN",9.8,"NM",19,0)
MAGDRPC9^^0^B55813118
"BLD",3463,"KRN",9.8,"NM",20,0)
MAGDRPCA^^0^B93958807
"BLD",3463,"KRN",9.8,"NM",21,0)
MAGDTR05^^0^B48114402
"BLD",3463,"KRN",9.8,"NM",22,0)
MAGSPID^^0^B3966944
"BLD",3463,"KRN",9.8,"NM","B","MAG7RS",1)

"BLD",3463,"KRN",9.8,"NM","B","MAGDCCS",2)

"BLD",3463,"KRN",9.8,"NM","B","MAGDCCS2",3)

"BLD",3463,"KRN",9.8,"NM","B","MAGDCCSD",4)

"BLD",3463,"KRN",9.8,"NM","B","MAGDHLS",5)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR81",6)

"BLD",3463,"KRN",9.8,"NM","B","MAGDIR8A",7)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB1",8)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB12",9)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLB9",10)

"BLD",3463,"KRN",9.8,"NM","B","MAGDLBAA",11)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR03",12)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR04",13)

"BLD",3463,"KRN",9.8,"NM","B","MAGDQR21",14)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRA1",15)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRA2",16)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRAHL",17)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC3",18)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPC9",19)

"BLD",3463,"KRN",9.8,"NM","B","MAGDRPCA",20)

"BLD",3463,"KRN",9.8,"NM","B","MAGDTR05",21)

"BLD",3463,"KRN",9.8,"NM","B","MAGSPID",22)

"BLD",3463,"KRN",19,0)
19
"BLD",3463,"KRN",19,"NM",0)
^9.68A^^
"BLD",3463,"KRN",19.1,0)
19.1
"BLD",3463,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",3463,"KRN",101,0)
101
"BLD",3463,"KRN",101,"NM",0)
^9.68A^^
"BLD",3463,"KRN",409.61,0)
409.61
"BLD",3463,"KRN",771,0)
771
"BLD",3463,"KRN",771,"NM",0)
^9.68A^^
"BLD",3463,"KRN",870,0)
870
"BLD",3463,"KRN",870,"NM",0)
^9.68A^^
"BLD",3463,"KRN",8989.51,0)
8989.51
"BLD",3463,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",3463,"KRN",8989.52,0)
8989.52
"BLD",3463,"KRN",8994,0)
8994
"BLD",3463,"KRN",8994,"NM",0)
^9.68A^^
"BLD",3463,"KRN","B",.4,.4)

"BLD",3463,"KRN","B",.401,.401)

"BLD",3463,"KRN","B",.402,.402)

"BLD",3463,"KRN","B",.403,.403)

"BLD",3463,"KRN","B",.5,.5)

"BLD",3463,"KRN","B",.84,.84)

"BLD",3463,"KRN","B",3.6,3.6)

"BLD",3463,"KRN","B",3.8,3.8)

"BLD",3463,"KRN","B",9.2,9.2)

"BLD",3463,"KRN","B",9.8,9.8)

"BLD",3463,"KRN","B",19,19)

"BLD",3463,"KRN","B",19.1,19.1)

"BLD",3463,"KRN","B",101,101)

"BLD",3463,"KRN","B",409.61,409.61)

"BLD",3463,"KRN","B",771,771)

"BLD",3463,"KRN","B",870,870)

"BLD",3463,"KRN","B",8989.51,8989.51)

"BLD",3463,"KRN","B",8989.52,8989.52)

"BLD",3463,"KRN","B",8994,8994)

"BLD",3463,"REQB",0)
^9.611^2^2
"BLD",3463,"REQB",1,0)
MAG*3.0*122^2
"BLD",3463,"REQB",2,0)
MAG*3.0*99^2
"BLD",3463,"REQB","B","MAG*3.0*122",1)

"BLD",3463,"REQB","B","MAG*3.0*99",2)

"FIA",2006.563)
DICOM GATEWAY PARAMETER
"FIA",2006.563,0)
^MAGDICOM(2006.563,
"FIA",2006.563,0,0)
2006.563
"FIA",2006.563,0,1)
y^y^p^^^^n^^n
"FIA",2006.563,0,10)

"FIA",2006.563,0,11)

"FIA",2006.563,0,"RLRO")

"FIA",2006.563,2006.563)
1
"FIA",2006.563,2006.563,202)

"INIT")
POST^MAGIP123
"MBREQ")
0
"PKG",454,-1)
1^1
"PKG",454,0)
IMAGING^MAG^Imaging Release History
"PKG",454,22,0)
^9.49I^1^1
"PKG",454,22,1,0)
3.0^3020328^3020328^.5
"PKG",454,22,1,"PAH",1,0)
123^3120724^.5
"PKG",454,22,1,"PAH",1,1,0)
^9.49011^29^29^3120724
"PKG",454,22,1,"PAH",1,1,1,0)
Routines for Patch 123, Test Build 7.
"PKG",454,22,1,"PAH",1,1,2,0)
 
"PKG",454,22,1,"PAH",1,1,3,0)
Routines:
"PKG",454,22,1,"PAH",1,1,4,0)
MAG7RS      value = 13135219
"PKG",454,22,1,"PAH",1,1,5,0)
MAGDCCS     value = 14748319
"PKG",454,22,1,"PAH",1,1,6,0)
MAGDCCS2    value = 7524490
"PKG",454,22,1,"PAH",1,1,7,0)
MAGDCCSD    value = 5307168
"PKG",454,22,1,"PAH",1,1,8,0)
MAGDHLS     value = 14585928
"PKG",454,22,1,"PAH",1,1,9,0)
MAGDIR81    value = 17859818
"PKG",454,22,1,"PAH",1,1,10,0)
MAGDIR8A    value = 10581895
"PKG",454,22,1,"PAH",1,1,11,0)
MAGDLB1     value = 12766001
"PKG",454,22,1,"PAH",1,1,12,0)
MAGDLB12    value = 8198942
"PKG",454,22,1,"PAH",1,1,13,0)
MAGDLB9     value = 4969298
"PKG",454,22,1,"PAH",1,1,14,0)
MAGDLBAA    value = 8118057
"PKG",454,22,1,"PAH",1,1,15,0)
MAGDQR03    value = 18464598
"PKG",454,22,1,"PAH",1,1,16,0)
MAGDQR04    value = 15569898
"PKG",454,22,1,"PAH",1,1,17,0)
MAGDQR21    value = 23288835
"PKG",454,22,1,"PAH",1,1,18,0)
MAGDRA1     value = 8062807
"PKG",454,22,1,"PAH",1,1,19,0)
MAGDRA2     value = 9317212
"PKG",454,22,1,"PAH",1,1,20,0)
MAGDRAHL    value = 4631070
"PKG",454,22,1,"PAH",1,1,21,0)
MAGDRPC3    value = 13904592
"PKG",454,22,1,"PAH",1,1,22,0)
MAGDRPC9    value = 13063850
"PKG",454,22,1,"PAH",1,1,23,0)
MAGDRPCA    value = 18609605
"PKG",454,22,1,"PAH",1,1,24,0)
MAGDTR05    value = 12846226
"PKG",454,22,1,"PAH",1,1,25,0)
MAGIP123    value = 2905275
"PKG",454,22,1,"PAH",1,1,26,0)
MAGSPID     value = 2839275
"PKG",454,22,1,"PAH",1,1,27,0)
 
"PKG",454,22,1,"PAH",1,1,28,0)
Please note that routine MAGIP123 is deleted after the KIDS Build is
"PKG",454,22,1,"PAH",1,1,29,0)
installed.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
23
"RTN","MAG7RS")
0^1^B63369541
"RTN","MAG7RS",1,0)
MAG7RS ;WOIFO/PMK,MLH,SAF - copy radiology message from HLSDATA to ^MAGDHL7 - add segment data ; 30 Jun 2004  4:32 PM
"RTN","MAG7RS",2,0)
 ;;3.0;IMAGING;**11,40,30,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAG7RS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAG7RS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAG7RS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAG7RS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAG7RS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAG7RS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAG7RS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAG7RS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAG7RS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAG7RS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAG7RS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAG7RS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAG7RS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAG7RS",17,0)
 ;;
"RTN","MAG7RS",18,0)
 ;
"RTN","MAG7RS",19,0)
PIDADD ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",20,0)
 ; Add PID info for DICOM Gateway.
"RTN","MAG7RS",21,0)
 ; Uses multi-tier array structure MAG7WRK produced by call to MAG7UP.
"RTN","MAG7RS",22,0)
 ;
"RTN","MAG7RS",23,0)
 N DIQUIET ; -------------- FileMan verbose/silent variable
"RTN","MAG7RS",24,0)
 N IXPID ; ---------------- index to PID segment in MAG7WRK array
"RTN","MAG7RS",25,0)
 N VADM,VAPA ; ------------ VADPT return arrays
"RTN","MAG7RS",26,0)
 N STATNUMB ; ------------- STATION NUMBER of primary site
"RTN","MAG7RS",27,0)
 ;
"RTN","MAG7RS",28,0)
 ; ====================================================
"RTN","MAG7RS",29,0)
 ; Get patient DFN and retrieve demo data.
"RTN","MAG7RS",30,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",31,0)
 S DFN=MAG7WRK(IXPID,3,1,1,1) I 'DFN Q
"RTN","MAG7RS",32,0)
 ;
"RTN","MAG7RS",33,0)
 ; ================================================
"RTN","MAG7RS",34,0)
 ; load demo information into HL7 PID segment
"RTN","MAG7RS",35,0)
 S DIQUIET=1
"RTN","MAG7RS",36,0)
 D DEM^VADPT ; demo into VADM()
"RTN","MAG7RS",37,0)
 I '$G(VAERR),VADM(3)]"" D
"RTN","MAG7RS",38,0)
 . S MAG7WRK(IXPID,7,1,1,1)=$P(VADM(3),"^")+17000000 ; DOB
"RTN","MAG7RS",39,0)
 . Q
"RTN","MAG7RS",40,0)
 I $$ISIHS^MAGSPID() D
"RTN","MAG7RS",41,0)
 . S STATNUMB=$P($$SITE^VASITE(),"^",3)
"RTN","MAG7RS",42,0)
 . S MAG7WRK(IXPID,2,1,1,1)=STATNUMB_"-"_DFN
"RTN","MAG7RS",43,0)
 . S MAG7WRK(IXPID,2,1,2,1)=""
"RTN","MAG7RS",44,0)
 . S MAG7WRK(IXPID,2,1,3,1)=""
"RTN","MAG7RS",45,0)
 . S MAG7WRK(IXPID,2,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")
"RTN","MAG7RS",46,0)
 . S MAG7WRK(IXPID,2,1,5,1)="PI"
"RTN","MAG7RS",47,0)
 . ;
"RTN","MAG7RS",48,0)
 . K MAG7WRK(IXPID,3)
"RTN","MAG7RS",49,0)
 . S MAG7WRK(IXPID,3)=VA("PID")_"^^^USIHS^MR"
"RTN","MAG7RS",50,0)
 . S MAG7WRK(IXPID,3,1,1,1)=VA("PID")
"RTN","MAG7RS",51,0)
 . S MAG7WRK(IXPID,3,1,1)=VA("PID")
"RTN","MAG7RS",52,0)
 . S MAG7WRK(IXPID,3,1,1,1)=VA("PID")
"RTN","MAG7RS",53,0)
 . S MAG7WRK(IXPID,3,1,4)="USIHS"
"RTN","MAG7RS",54,0)
 . S MAG7WRK(IXPID,3,1,4,1)="USIHS"
"RTN","MAG7RS",55,0)
 . S MAG7WRK(IXPID,3,1,5)="MR"
"RTN","MAG7RS",56,0)
 . S MAG7WRK(IXPID,3,1,5,1)="MR"
"RTN","MAG7RS",57,0)
 . Q 
"RTN","MAG7RS",58,0)
 ;
"RTN","MAG7RS",59,0)
 ; ================================================
"RTN","MAG7RS",60,0)
 ; load address information into HL7 PID segment
"RTN","MAG7RS",61,0)
 S DIQUIET=1
"RTN","MAG7RS",62,0)
 D ADD^VADPT ; address & phone into VAPA()
"RTN","MAG7RS",63,0)
 I '$G(VAERR) D
"RTN","MAG7RS",64,0)
 . S MAG7WRK(IXPID,10,1,2,1)=$P(VADM(8),"^",2) ; race
"RTN","MAG7RS",65,0)
 . S MAG7WRK(IXPID,11,1,1,1)=VAPA(1) ; street address 1st line
"RTN","MAG7RS",66,0)
 . S MAG7WRK(IXPID,11,1,2,1)=VAPA(2)_$S(VAPA(3)="":"",1:", "_VAPA(3)) ; lns 2-3
"RTN","MAG7RS",67,0)
 . S MAG7WRK(IXPID,11,1,3,1)=VAPA(4) ; city
"RTN","MAG7RS",68,0)
 . S MAG7WRK(IXPID,11,1,4,1)=VAPA(5) ; 2-letter state
"RTN","MAG7RS",69,0)
 . S MAG7WRK(IXPID,11,1,5,1)=VAPA(6) ; ZIP
"RTN","MAG7RS",70,0)
 . ; phone
"RTN","MAG7RS",71,0)
 . S MAG7WRK(IXPID,13,1,1,1)=VAPA(8)
"RTN","MAG7RS",72,0)
 . S MAG7WRK(IXPID,13,1,2,1)="PRN" ; phone
"RTN","MAG7RS",73,0)
 . Q
"RTN","MAG7RS",74,0)
 Q
"RTN","MAG7RS",75,0)
 ;
"RTN","MAG7RS",76,0)
ADDVSDG ; SUBROUTINE - called by ADDDTA^MAGDHL7
"RTN","MAG7RS",77,0)
 ; Add visit and diagnosis info for DICOM Gateway.
"RTN","MAG7RS",78,0)
 ;
"RTN","MAG7RS",79,0)
 N DIQUIET ; ------ FileMan verbose/silent variable
"RTN","MAG7RS",80,0)
 N I,IX,IX1 ; ----- scratch index vars
"RTN","MAG7RS",81,0)
 N IXPID,IXPV1 ; -- indices to PID, PV1 segs in MAG7WRK array
"RTN","MAG7RS",82,0)
 N IXDG1,IXOBR ; -- indices to DG1, OBR segs in MAG7WRK array
"RTN","MAG7RS",83,0)
 N IXVAEL ; ------- index of entries in VAEL()
"RTN","MAG7RS",84,0)
 N VAIN,VAEL ; ---- VADPT return arrays
"RTN","MAG7RS",85,0)
 N MAGPHYNM ; ----- physician name
"RTN","MAG7RS",86,0)
 N ELCODE ; ------- eligibility code
"RTN","MAG7RS",87,0)
 ;
"RTN","MAG7RS",88,0)
 ; ====================================================
"RTN","MAG7RS",89,0)
 ; Get patient DFN and retrieve inpatient data.
"RTN","MAG7RS",90,0)
 S IXPID=$O(MAG7WRK("B","PID","")) I 'IXPID Q
"RTN","MAG7RS",91,0)
 S DFN=MAG7WRK(IXPID,3,1,1,1) I 'DFN Q
"RTN","MAG7RS",92,0)
 S DIQUIET=1
"RTN","MAG7RS",93,0)
 D INP^VADPT Q:VAERR  ; inpatient data in VAIN()
"RTN","MAG7RS",94,0)
 D ELIG^VADPT Q:VAERR  ; eligibility data in VAEL()
"RTN","MAG7RS",95,0)
 D PV1ADD($S($G(VAIN(1))]"":"IN",1:"OUT"))
"RTN","MAG7RS",96,0)
 ; add pregnancy status and modalities if not already part of order
"RTN","MAG7RS",97,0)
 ; message
"RTN","MAG7RS",98,0)
 I $G(MAG7WRK(1,9,1,1,1))="ORM" D
"RTN","MAG7RS",99,0)
 . S IXOBR=$O(MAG7WRK("B","OBR",""))
"RTN","MAG7RS",100,0)
 . I IXOBR D PV1RAD ; pregnancy status & modality info from Radiology
"RTN","MAG7RS",101,0)
 . Q
"RTN","MAG7RS",102,0)
 Q
"RTN","MAG7RS",103,0)
 ;
"RTN","MAG7RS",104,0)
PV1ADD(XPTSTA) ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",105,0)
 ; Get the index of the PV1 segment - create one for the order message
"RTN","MAG7RS",106,0)
 ; if we need to.
"RTN","MAG7RS",107,0)
 ; 
"RTN","MAG7RS",108,0)
 ; input:  XPTSTA        patient status { IN | OUT }
"RTN","MAG7RS",109,0)
 ; 
"RTN","MAG7RS",110,0)
 ; Expects:  VAEL()      eligibility array from ELIG^VADPT
"RTN","MAG7RS",111,0)
 ;           VAIN()      inpatient data array from INP^VADPT
"RTN","MAG7RS",112,0)
 ;
"RTN","MAG7RS",113,0)
 N FSTAT ; -- status flag returned by MAG7UDR
"RTN","MAG7RS",114,0)
 N IXSEG ; -- segment index in message
"RTN","MAG7RS",115,0)
 N IXPRED ; -- index to predecessor segment
"RTN","MAG7RS",116,0)
 N IXSUCC ; -- index to successor segment
"RTN","MAG7RS",117,0)
 ;
"RTN","MAG7RS",118,0)
 S IXPV1=$O(MAG7WRK("B","PV1",""))
"RTN","MAG7RS",119,0)
 I 'IXPV1 Q:MAG7WRK(1,9,1,1,1)'="ORM"  D
"RTN","MAG7RS",120,0)
 . S (IXSEG,IXPRED)=$O(MAG7WRK("B","PID","")) Q:'IXSEG
"RTN","MAG7RS",121,0)
 . F  S IXSEG=$O(MAG7WRK(IXSEG)) Q:"^PD1^NTE^"'[("^"_$G(MAG7WRK(IXSEG,0))_"^")  S IXPRED=IXSEG
"RTN","MAG7RS",122,0)
 . S IXSUCC=$O(MAG7WRK(IXPRED)),IXPV1=$S(IXSUCC:IXPRED+IXSUCC/2,1:IXPRED+1)
"RTN","MAG7RS",123,0)
 . S MAG7WRK(IXPV1,0)="PV1"
"RTN","MAG7RS",124,0)
 . Q
"RTN","MAG7RS",125,0)
 ;
"RTN","MAG7RS",126,0)
 ; pt status
"RTN","MAG7RS",127,0)
 I XPTSTA="OUT" D  ; if op, just status for now
"RTN","MAG7RS",128,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="O"
"RTN","MAG7RS",129,0)
 . Q
"RTN","MAG7RS",130,0)
 E  I XPTSTA'="IN" D  ; not applicable 
"RTN","MAG7RS",131,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="N"
"RTN","MAG7RS",132,0)
 . Q
"RTN","MAG7RS",133,0)
 E  D  ; get visit information too
"RTN","MAG7RS",134,0)
 . S MAG7WRK(IXPV1,2,1,1,1)="I" ; -- class - always inpatient
"RTN","MAG7RS",135,0)
 . ; location
"RTN","MAG7RS",136,0)
 . ;    point of care <--- ward -- needs to be a triplet for Pete's DICOM msg
"RTN","MAG7RS",137,0)
 . S MAG7WRK(IXPV1,3,1,1,1)=$P(VAIN(4),U)
"RTN","MAG7RS",138,0)
 . S MAG7WRK(IXPV1,3,1,1,2)=$P(VAIN(4),U,2)
"RTN","MAG7RS",139,0)
 . S MAG7WRK(IXPV1,3,1,1,3)="VISTA42"
"RTN","MAG7RS",140,0)
 . S MAG7WRK(IXPV1,3,1,2,1)=$P(VAIN(5),"-") ; -------- room
"RTN","MAG7RS",141,0)
 . S MAG7WRK(IXPV1,3,1,3,1)=$P(VAIN(5),"-",2) ; ------ bed
"RTN","MAG7RS",142,0)
 . ; add segment for admitting dx to ADT and ORM messages
"RTN","MAG7RS",143,0)
 . I $G(VAIN(9))]"" D DG1DGADM^MAG7RSD
"RTN","MAG7RS",144,0)
 . Q
"RTN","MAG7RS",145,0)
 ;
"RTN","MAG7RS",146,0)
 ; add PV1 fields and ROL segments for the attending and referring DRs
"RTN","MAG7RS",147,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,7)),"ATT") ; attending DR
"RTN","MAG7RS",148,0)
 I $G(MAG7WRK(IXPV1,7,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",149,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,7,1)),"AT")
"RTN","MAG7RS",150,0)
 . Q
"RTN","MAG7RS",151,0)
 S FSTAT=$$PRCTADD^MAG7UDR($NA(MAG7WRK(IXPV1,8)),"REF") ; referring DR
"RTN","MAG7RS",152,0)
 I $G(MAG7WRK(IXPV1,8,1,1,1)),$G(MAG7WRK(1,9,1,1,1))="ADT" D
"RTN","MAG7RS",153,0)
 . D ROLADD^MAG7RSR($NA(MAG7WRK(IXPV1,8,1)),"RP")
"RTN","MAG7RS",154,0)
 . Q
"RTN","MAG7RS",155,0)
 I $D(VAEL) D  ; add VIP flag if applicable and not yet present
"RTN","MAG7RS",156,0)
 . S VAEL(1,0)=VAEL(1) ; for easy array navigation
"RTN","MAG7RS",157,0)
 . S IXVAEL=""
"RTN","MAG7RS",158,0)
 . F  Q:$D(IXPV1(16))  S IXVAEL=$O(VAEL(1,IXVAEL)) Q:IXVAEL=""  D
"RTN","MAG7RS",159,0)
 . . S ELCODE=$P($G(VAEL(1,IXVAEL)),"^")
"RTN","MAG7RS",160,0)
 . . I "^6^15^"[("^"_ELCODE_"^") S IXPV1(16,1,1,1,1)=ELCODE
"RTN","MAG7RS",161,0)
 . . Q
"RTN","MAG7RS",162,0)
 . Q
"RTN","MAG7RS",163,0)
 Q
"RTN","MAG7RS",164,0)
 ;
"RTN","MAG7RS",165,0)
PV1RAD ; SUBROUTINE - called by ADDVSDG
"RTN","MAG7RS",166,0)
 ; Add "pregnant" to Ambulatory Status if patient is pregnant.
"RTN","MAG7RS",167,0)
 ; Add modalities to Diagnostic Service Section ID.
"RTN","MAG7RS",168,0)
 ; 
"RTN","MAG7RS",169,0)
 ; Expects:  MAG7WRK()     HL7 message array
"RTN","MAG7RS",170,0)
 ;           IXOBR         Index of OBR segment on MAG7WRK()
"RTN","MAG7RS",171,0)
 ;           IXPV1         Index of PV1 segment on MAG7WRK()
"RTN","MAG7RS",172,0)
 ;           
"RTN","MAG7RS",173,0)
 N RADPT2 ; ------- FileMan date of rad order
"RTN","MAG7RS",174,0)
 N RADPT3 ; ------- index of order under date on Rad/NM pt file
"RTN","MAG7RS",175,0)
 N RADPT0 ; ------- data for order on Rad/NM pt file
"RTN","MAG7RS",176,0)
 N RAOIEN ; ------- index of order on Rad/NM order file
"RTN","MAG7RS",177,0)
 N RAO0 ; --------- data for order on Rad/NM order file
"RTN","MAG7RS",178,0)
 N PROCIEN ; ------ ien of procedure on Rad/NM procedure file
"RTN","MAG7RS",179,0)
 N PROCMOD ; ------ ien of modality on Rad/NM procedure file
"RTN","MAG7RS",180,0)
 N MODIEN ; ------- ien of modality on modality defined terms file
"RTN","MAG7RS",181,0)
 N MODTERM ; ------ term for the modality
"RTN","MAG7RS",182,0)
 N PREGSTAT ; ----- pregnancy status on order
"RTN","MAG7RS",183,0)
 N REPIX ; -------- repetition index
"RTN","MAG7RS",184,0)
 N EDTA ; --------- element data
"RTN","MAG7RS",185,0)
 N AAMBMSG ; ------ ambulatory status array (from message data)
"RTN","MAG7RS",186,0)
 N AMODMSG ; ------ modality array (from message data)
"RTN","MAG7RS",187,0)
 ;
"RTN","MAG7RS",188,0)
 ; get data from Rad/NM pt and order files
"RTN","MAG7RS",189,0)
 S RADPT2=$P(MAG7WRK(IXOBR,3,1,1,1),"-")
"RTN","MAG7RS",190,0)
 S RADPT3=$P(MAG7WRK(IXOBR,3,1,1,1),"-",2)
"RTN","MAG7RS",191,0)
 S RADPT0=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAG7RS",192,0)
 S RAOIEN=$P(RADPT0,"^",11) ; IEN for ^RAO(75.1)
"RTN","MAG7RS",193,0)
 S RAO0="" I RAOIEN S RAO0=$G(^RAO(75.1,RAOIEN,0))
"RTN","MAG7RS",194,0)
 ;
"RTN","MAG7RS",195,0)
 ; add "pregnant" to ambulatory status if needed
"RTN","MAG7RS",196,0)
 ;   get data from message
"RTN","MAG7RS",197,0)
 S REPIX=""
"RTN","MAG7RS",198,0)
 F  S REPIX=$O(MAG7WRK(IXPV1,15,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",199,0)
 . S EDTA=$G(MAG7WRK(IXPV1,15,REPIX,1,1)) I EDTA]"" S AAMBMSG(EDTA)=""
"RTN","MAG7RS",200,0)
 . Q
"RTN","MAG7RS",201,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",202,0)
 S PREGSTAT=$P(RAO0,"^",13) I PREGSTAT="" S PREGSTAT="u"
"RTN","MAG7RS",203,0)
 I '$D(AAMBMSG("B6")),PREGSTAT="y" D
"RTN","MAG7RS",204,0)
 . S MAG7WRK(IXPV1,15,$O(MAG7WRK(IXPV1,15," "),-1)+1,1,1)="B6"
"RTN","MAG7RS",205,0)
 . Q
"RTN","MAG7RS",206,0)
 ;
"RTN","MAG7RS",207,0)
 ; add modalities to Diagnostic Service Section ID
"RTN","MAG7RS",208,0)
 ;   get data from message
"RTN","MAG7RS",209,0)
 F  S REPIX=$O(MAG7WRK(IXOBR,24,REPIX)) Q:'REPIX  D
"RTN","MAG7RS",210,0)
 . S EDTA=$G(MAG7WRK(IXOBR,24,REPIX,1,1)) I EDTA]"" S AMODMSG(EDTA)=""
"RTN","MAG7RS",211,0)
 . Q
"RTN","MAG7RS",212,0)
 ;   get data from Radiology and add to message if needed and not present
"RTN","MAG7RS",213,0)
 S PROCIEN=$P(RADPT0,U,2)
"RTN","MAG7RS",214,0)
 I PROCIEN D
"RTN","MAG7RS",215,0)
 . S PROCMOD=0
"RTN","MAG7RS",216,0)
 . F  S PROCMOD=$O(^RAMIS(71,PROCIEN,"MDL",PROCMOD)) Q:'PROCMOD  D
"RTN","MAG7RS",217,0)
 . . S MODIEN=$P($G(^RAMIS(71,PROCIEN,"MDL",PROCMOD,0)),U)
"RTN","MAG7RS",218,0)
 . . I MODIEN,$D(^RAMIS(73.1,MODIEN,0)) D
"RTN","MAG7RS",219,0)
 . . . S MODTERM=$P($G(^RAMIS(73.1,MODIEN,0)),U)
"RTN","MAG7RS",220,0)
 . . . I MODTERM]"",'$D(AMODMSG(MODTERM)) D
"RTN","MAG7RS",221,0)
 . . . . S MAG7WRK(IXOBR,24,$O(MAG7WRK(IXOBR,24," "),-1)+1,1,1)=MODTERM
"RTN","MAG7RS",222,0)
 . . . . Q
"RTN","MAG7RS",223,0)
 . . . Q
"RTN","MAG7RS",224,0)
 . . Q
"RTN","MAG7RS",225,0)
 . Q
"RTN","MAG7RS",226,0)
 Q
"RTN","MAGDCCS")
0^2^B66427733
"RTN","MAGDCCS",1,0)
MAGDCCS ;WOIFO/MLH/JSL/SAF - DICOM Correct - Clinical Specialties ; 13 Feb 2012 1:13 PM
"RTN","MAGDCCS",2,0)
 ;;3.0;IMAGING;**10,11,85,54,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDCCS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDCCS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDCCS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDCCS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDCCS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDCCS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDCCS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDCCS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDCCS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDCCS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDCCS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDCCS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDCCS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS",17,0)
 ;;
"RTN","MAGDCCS",18,0)
 Q
"RTN","MAGDCCS",19,0)
 ;
"RTN","MAGDCCS",20,0)
L ;Loop thru the entire file for entries that need processing
"RTN","MAGDCCS",21,0)
 ;The "F" xref is set for unique Study UIDs. The entry setting this xref
"RTN","MAGDCCS",22,0)
 ;will also have a "RLATE" node with all the Xray images associated with
"RTN","MAGDCCS",23,0)
 ;that unique Study UID.
"RTN","MAGDCCS",24,0)
 N ANS,ANSR,CASENO,COMNT1,DATA,DATA1,DATA2,DATE,FILE,FIRST,FIRSTS
"RTN","MAGDCCS",25,0)
 N MACHID,MAGDY,MAGDIEN,MAGIEN,MAGTYPE,MSG,START,STOP
"RTN","MAGDCCS",26,0)
 N MOD,MODEL,NEWCAS,NEWDFN,NEWDTI,NEWDTIM,NEWMUL,NEWNME,NEWPID,NEWPIEN,NEWPROC
"RTN","MAGDCCS",27,0)
 N OK,OOUT,OUT,PAT,PID,PP,PREV,PREVS,REASON,STUDYUID,WHY,MAGFIX
"RTN","MAGDCCS",28,0)
 N KFIXALL ; --- does user hold MAGDFIX ALL key
"RTN","MAGDCCS",29,0)
 N GWLOC ; -- gateway site
"RTN","MAGDCCS",30,0)
 ;
"RTN","MAGDCCS",31,0)
 S KFIXALL=$$SECKEY^MAGDLB12()
"RTN","MAGDCCS",32,0)
 I '$D(^MAGD(2006.575,"F")) W !,"Nothing to process!" Q
"RTN","MAGDCCS",33,0)
 S (OOUT,OUT,PREV,FIRST)=0
"RTN","MAGDCCS",34,0)
 S GWLOC=0
"RTN","MAGDCCS",35,0)
 F  S GWLOC=$O(^MAGD(2006.575,"F",GWLOC)) Q:'GWLOC  D
"RTN","MAGDCCS",36,0)
 . S SUID=""
"RTN","MAGDCCS",37,0)
 . F  S SUID=$O(^MAGD(2006.575,"F",GWLOC,SUID)) Q:SUID=""!(OOUT)  D
"RTN","MAGDCCS",38,0)
 . . S MAGIEN=$O(^MAGD(2006.575,"F",GWLOC,SUID,0)) Q:'MAGIEN
"RTN","MAGDCCS",39,0)
 . . ; if no main failed image rec, there's a xref prob, so bail
"RTN","MAGDCCS",40,0)
 . . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q  ; clean up xref
"RTN","MAGDCCS",41,0)
 . . . K ^MAGD(2006.575,"F",GWLOC,SUID,MAGIEN)
"RTN","MAGDCCS",42,0)
 . . . Q
"RTN","MAGDCCS",43,0)
 . . ;Only process clinical specialties images... radiology and medicine images done by other rtns.
"RTN","MAGDCCS",44,0)
 . . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),"^") I MAGTYPE'="CON" Q
"RTN","MAGDCCS",45,0)
 . . I $D(^MAGD(2006.575,MAGIEN,"FIXD")),$P(^MAGD(2006.575,MAGIEN,"FIXD"),"^") Q
"RTN","MAGDCCS",46,0)
 . . I 'FIRST S PREV=MAGIEN,PREVS=SUID,FIRST=MAGIEN
"RTN","MAGDCCS",47,0)
 . . D SET
"RTN","MAGDCCS",48,0)
 . . Q
"RTN","MAGDCCS",49,0)
 . Q
"RTN","MAGDCCS",50,0)
 Q
"RTN","MAGDCCS",51,0)
 ;
"RTN","MAGDCCS",52,0)
DISPLAY ;
"RTN","MAGDCCS",53,0)
 S OUT=0
"RTN","MAGDCCS",54,0)
 W !,"**************Processing entry**********"
"RTN","MAGDCCS",55,0)
 W !!,?2,"PATIENT: ",PAT,?50,$$PIDLABEL^MAGSPID(),PID,!,"Request/Consultation #: ",CASENO
"RTN","MAGDCCS",56,0)
 W !,?2,"Equipment: ",MOD,?50,"Model: ",MODEL
"RTN","MAGDCCS",57,0)
 W !,?2,"Date Processed: ",DATE,?50,"Problem with: ",REASON
"RTN","MAGDCCS",58,0)
 W !,?2,"Comment: ",COMNT1
"RTN","MAGDCCS",59,0)
 W !,?2,"Correcting file on server ID: ",MACHID,!,?5,FILE
"RTN","MAGDCCS",60,0)
 S MSG="Do you want to Correct this entry? "
"RTN","MAGDCCS",61,0)
 Q
"RTN","MAGDCCS",62,0)
 ;
"RTN","MAGDCCS",63,0)
NEWCASE ;
"RTN","MAGDCCS",64,0)
 S NEWDFN=$P(MAGDY,"^"),NEWNME=$P(MAGDY,"^",2),NEWPID=$P(MAGDY,"^",3)
"RTN","MAGDCCS",65,0)
 S NEWCAS=$P(MAGDY,"^",4),NEWPROC=$P(MAGDY,"^",5),NEWDTI=$P(MAGDY,"^",6)
"RTN","MAGDCCS",66,0)
 S NEWMUL=$P(MAGDY,"^",7),NEWPIEN=$P(MAGDY,"^",8),PP=$P(MAGDY,"^",9)
"RTN","MAGDCCS",67,0)
 Q
"RTN","MAGDCCS",68,0)
 ;
"RTN","MAGDCCS",69,0)
ASK() ;
"RTN","MAGDCCS",70,0)
 N ANS,ASK
"RTN","MAGDCCS",71,0)
ASK1 S ASK="Y/N/D/Q"
"RTN","MAGDCCS",72,0)
 I $G(PREV)'=$G(MAGIEN),MAGTYPE="CON" S ASK=ASK_"/P"
"RTN","MAGDCCS",73,0)
 W !,$G(MSG),"("_ASK_")// " R ANS:600
"RTN","MAGDCCS",74,0)
 I '$T!(ANS["^") Q "^"
"RTN","MAGDCCS",75,0)
 I ANS="" Q "N"
"RTN","MAGDCCS",76,0)
 I "YNDPQyndpq"'[$E(ANS) D  G ASK1
"RTN","MAGDCCS",77,0)
 . W !,"Please respond with one of the following codes."
"RTN","MAGDCCS",78,0)
 . W !,"Legend: Y=yes, N=no, D=delete, P=Previous entry, and Q=quit",!
"RTN","MAGDCCS",79,0)
 . Q
"RTN","MAGDCCS",80,0)
 S ANS=$TR(ANS,"yndpq","YNDPQ")
"RTN","MAGDCCS",81,0)
 Q $E(ANS)
"RTN","MAGDCCS",82,0)
 ;
"RTN","MAGDCCS",83,0)
CHK ;remove any punctuation before doing comparison on SSN
"RTN","MAGDCCS",84,0)
 ;stop on 1st check.
"RTN","MAGDCCS",85,0)
 N OLD,I
"RTN","MAGDCCS",86,0)
 S OLD="" F I=1:1:$L(PID) I $E(PID,I)?1AN S OLD=OLD_$E(PID,I)
"RTN","MAGDCCS",87,0)
 I NEWPID'=OLD D  Q
"RTN","MAGDCCS",88,0)
 . S MSG=$$PIDLABEL^MAGSPID()_"s do not match. Update? "
"RTN","MAGDCCS",89,0)
 I NEWNME'=PAT D  Q
"RTN","MAGDCCS",90,0)
 . S MSG="Patient names do not match. Update? "
"RTN","MAGDCCS",91,0)
 ;Finally the problem is with the case number...either no longer in "C"
"RTN","MAGDCCS",92,0)
 ;xref or invalid number provided
"RTN","MAGDCCS",93,0)
 S MSG="Accession number different. Update? "
"RTN","MAGDCCS",94,0)
 Q
"RTN","MAGDCCS",95,0)
 ;
"RTN","MAGDCCS",96,0)
NEWDIS ;
"RTN","MAGDCCS",97,0)
 W !,?2,"****Please review the following: *****"
"RTN","MAGDCCS",98,0)
 W !,?2,"Previous name: ",PAT,!,?2,"     New name: ",NEWNME
"RTN","MAGDCCS",99,0)
 W !,?2,"Previous ",$$PIDLABEL^MAGSPID(),": ",PID,!,?2,"     New ",$$PIDLABEL^MAGSPID(),": ",NEWPID
"RTN","MAGDCCS",100,0)
 W !,?2,"Previous request/consultation #: ",CASENO,!,?2,"     New request/consultation #: ",NEWCAS
"RTN","MAGDCCS",101,0)
 ; Variable PP already has text message about being part of printset.
"RTN","MAGDCCS",102,0)
 Q
"RTN","MAGDCCS",103,0)
 ;
"RTN","MAGDCCS",104,0)
UPDT ;
"RTN","MAGDCCS",105,0)
 N GWLOC ; -- gateway location
"RTN","MAGDCCS",106,0)
 N % ; ------ var for FM utility call
"RTN","MAGDCCS",107,0)
 W !,"Will change the following: " D NEWDIS
"RTN","MAGDCCS",108,0)
 W !,"Are you sure you want to correct this entry? " S %=2 D YN^DICN
"RTN","MAGDCCS",109,0)
 I %=-1!(%=2) S OUT=1 Q
"RTN","MAGDCCS",110,0)
 W !,"Updating the file."
"RTN","MAGDCCS",111,0)
 S NEWDTIM=$TR(NEWDTI,"0123456789","9876543210")
"RTN","MAGDCCS",112,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")="1^"_NEWDFN_"^"_NEWNME_"^"_NEWPID_"^"_NEWCAS_"^"_NEWDTI_"^"_NEWMUL_"^"_NEWDTIM W "."
"RTN","MAGDCCS",113,0)
 S ^MAGD(2006.575,MAGIEN,"FIXPR")=NEWPIEN_"^"_NEWPROC W "."
"RTN","MAGDCCS",114,0)
 ;Same as ^radpt(newdfn,"DT",newdti,"P",newmul,0) & ^RAMIS(71,newpien,0)
"RTN","MAGDCCS",115,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDCCS",116,0)
 S MACHID=$S(MACHID="":"A",1:MACHID) ; server ID
"RTN","MAGDCCS",117,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="" W "."
"RTN","MAGDCCS",118,0)
 E  W !,"Gateway place not defined on image entry "_MAGIEN_", continuing.."
"RTN","MAGDCCS",119,0)
 ;Xref to loop & process entries; processing will be minimal.
"RTN","MAGDCCS",120,0)
 S MAGFIX(MAGIEN)="F"
"RTN","MAGDCCS",121,0)
 Q
"RTN","MAGDCCS",122,0)
 ;
"RTN","MAGDCCS",123,0)
SETDEL ;Entry to be deleted
"RTN","MAGDCCS",124,0)
 N GWLOC ; -- gateway location
"RTN","MAGDCCS",125,0)
 D LOGERR I ANS="^" S OUT=1 Q
"RTN","MAGDCCS",126,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDCCS",127,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="D" W "."
"RTN","MAGDCCS",128,0)
 E  W !,"Gateway place not defined on image entry "_MAGIEN_", continuing.."
"RTN","MAGDCCS",129,0)
 S $P(^MAGD(2006.575,MAGIEN,0),"^",6)="1"
"RTN","MAGDCCS",130,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")=1
"RTN","MAGDCCS",131,0)
 S MAGFIX(MAGIEN)="D"
"RTN","MAGDCCS",132,0)
 Q
"RTN","MAGDCCS",133,0)
 ;
"RTN","MAGDCCS",134,0)
LOGERR ;Need to record error
"RTN","MAGDCCS",135,0)
 N DIR,DIRUT,DTOUT,ENTRY,I,MAGERR,MAGOUT,NOW,WHY,WHO,X,Y
"RTN","MAGDCCS",136,0)
 W !! F I=1:1:80 W "*"
"RTN","MAGDCCS",137,0)
 W !,"*** Will log in error log (file 2006.599). ****"
"RTN","MAGDCCS",138,0)
 S NOW=$$NOW^XLFDT()
"RTN","MAGDCCS",139,0)
 S DIR(0)="F^3:30"
"RTN","MAGDCCS",140,0)
 S DIR("A")="Reason for deletion"
"RTN","MAGDCCS",141,0)
 S DIR("A",1)="Please enter a reason for deleting."
"RTN","MAGDCCS",142,0)
 S DIR("A",2)="For example: TEST PATIENT"
"RTN","MAGDCCS",143,0)
 D ^DIR
"RTN","MAGDCCS",144,0)
 I $D(DIRUT)!($D(DTOUT))!(Y="") D  S ANS="^" Q
"RTN","MAGDCCS",145,0)
 . W !,"Can not delete if a reason is not provided."
"RTN","MAGDCCS",146,0)
 . Q
"RTN","MAGDCCS",147,0)
 S WHY=Y,WHO=$G(DUZ)
"RTN","MAGDCCS",148,0)
 I WHO D 
"RTN","MAGDCCS",149,0)
 . D GETS^DIQ(200,DUZ,".01","E","MAGOUT","MAGERR")
"RTN","MAGDCCS",150,0)
 . Q:$D(MAGERR("DIERR"))
"RTN","MAGDCCS",151,0)
 . S WHO=$G(MAGOUT(200,DUZ_",",.01,"E"))
"RTN","MAGDCCS",152,0)
 I WHO="" S WHO="UNKNOWN"
"RTN","MAGDCCS",153,0)
 I '$D(^MAGD(2006.599,0)) D
"RTN","MAGDCCS",154,0)
 . S ^MAGD(2006.599,0)="Dicom Error Log^2006.599^^"
"RTN","MAGDCCS",155,0)
 . Q
"RTN","MAGDCCS",156,0)
 S ENTRY=$P(^MAGD(2006.599,0),"^",3)+1
"RTN","MAGDCCS",157,0)
 S $P(^MAGD(2006.599,0),"^",3)=ENTRY
"RTN","MAGDCCS",158,0)
 S $P(^MAGD(2006.599,0),"^",4)=$P(^MAGD(2006.599,0),"^",4)+1
"RTN","MAGDCCS",159,0)
 S ^MAGD(2006.599,ENTRY,0)=NOW_"^"_WHY_"^"_FILE_"^"_MODEL
"RTN","MAGDCCS",160,0)
 S ^MAGD(2006.599,ENTRY,1)=WHO_"^"_PAT_"^"_PID_"^"_CASENO_"^"_MACHID
"RTN","MAGDCCS",161,0)
 S ^MAGD(2006.599,"B",NOW,ENTRY)=""
"RTN","MAGDCCS",162,0)
 Q
"RTN","MAGDCCS",163,0)
 ;
"RTN","MAGDCCS",164,0)
SET ;
"RTN","MAGDCCS",165,0)
 S MAGTYPE=$P(^MAGD(2006.575,MAGIEN,"TYPE"),"^")
"RTN","MAGDCCS",166,0)
 Q:$P($G(^MAGD(2006.575,MAGIEN,"FIXD")),"^")    ;Already fixed.
"RTN","MAGDCCS",167,0)
 ;Only process Clinical Specialties images...radiology & medicine images done by other rtns.
"RTN","MAGDCCS",168,0)
 I $E(MAGTYPE,1,3)'="CON" Q
"RTN","MAGDCCS",169,0)
 S DATA=^MAGD(2006.575,MAGIEN,0)
"RTN","MAGDCCS",170,0)
 S FILE=$P(^MAGD(2006.575,MAGIEN,0),"^")
"RTN","MAGDCCS",171,0)
 S DATA1=^MAGD(2006.575,MAGIEN,1)    ;Case no. info
"RTN","MAGDCCS",172,0)
 S DATA2=$G(^MAGD(2006.575,MAGIEN,"AMFG"))    ;Modality info
"RTN","MAGDCCS",173,0)
 S PAT=$P(DATA,"^",4),PID=$P(DATA,"^",3),REASON=$P(DATA,"^",2)
"RTN","MAGDCCS",174,0)
 S MOD=$P(DATA2,"^"),MODEL=$P(DATA2,"^",6)
"RTN","MAGDCCS",175,0)
 S CASENO=$P(DATA1,"^",2),MACHID=$P(DATA1,"^",4)
"RTN","MAGDCCS",176,0)
 S Y=$P(DATA1,"^",3) X ^DD("DD") S DATE=Y
"RTN","MAGDCCS",177,0)
 S COMNT1=$G(^MAGD(2006.575,MAGIEN,"ACSTXT")) ;1st line comment.
"RTN","MAGDCCS",178,0)
 S MACHID=$P(DATA1,"^",4)
"RTN","MAGDCCS",179,0)
 S ANS="" D DISPLAY S ANS=$$ASK
"RTN","MAGDCCS",180,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDCCS",181,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDCCS",182,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDCCS",183,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDCCS",184,0)
 Q:OUT
"RTN","MAGDCCS",185,0)
 K MAGDY W !," Lookup by case number or patient name"
"RTN","MAGDCCS",186,0)
 ;
"RTN","MAGDCCS",187,0)
LOOK ;
"RTN","MAGDCCS",188,0)
 D EN^MAGDCCS2 Q:'$D(MAGDY)  Q:MAGDY'[""
"RTN","MAGDCCS",189,0)
 D NEWCASE,CHK,NEWDIS S ANS=$$ASK
"RTN","MAGDCCS",190,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDCCS",191,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDCCS",192,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDCCS",193,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDCCS",194,0)
 Q:OUT
"RTN","MAGDCCS",195,0)
 D UPDT
"RTN","MAGDCCS",196,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDCCS",197,0)
 D SETMAG
"RTN","MAGDCCS",198,0)
 Q
"RTN","MAGDCCS",199,0)
 ;
"RTN","MAGDCCS",200,0)
DATELOOP(START,STOP) ;Loop thru the "AD" cross reference
"RTN","MAGDCCS",201,0)
 N MAGIEN,SUID,THEDT,FIRST,OOUT,MAGFIX
"RTN","MAGDCCS",202,0)
 S THEDT=START-.1,(OOUT,FIRST)=0
"RTN","MAGDCCS",203,0)
 F  S THEDT=$O(^MAGD(2006.575,"AD",THEDT)) Q:'THEDT!(THEDT>STOP)!(OOUT)  D
"RTN","MAGDCCS",204,0)
 . S MAGIEN=0
"RTN","MAGDCCS",205,0)
 . F  S MAGIEN=$O(^MAGD(2006.575,"AD",THEDT,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGDCCS",206,0)
 . . I '$D(^MAGD(2006.575,MAGIEN,0)) K ^MAGD(2006.575,"AD",THEDT,MAGIEN)
"RTN","MAGDCCS",207,0)
 . . I $D(^MAGD(2006.575,MAGIEN,"TYPE")),$E($P(^MAGD(2006.575,MAGIEN,"TYPE"),"^"),1,3)'="CON" Q
"RTN","MAGDCCS",208,0)
 . . I 'FIRST S PREV=MAGIEN,FIRST=1
"RTN","MAGDCCS",209,0)
 . . D SET
"RTN","MAGDCCS",210,0)
 . . Q
"RTN","MAGDCCS",211,0)
 . Q
"RTN","MAGDCCS",212,0)
 Q
"RTN","MAGDCCS",213,0)
 ;
"RTN","MAGDCCS",214,0)
SETPREV ;
"RTN","MAGDCCS",215,0)
 S PREV=MAGIEN,PREVS=$G(SUID)
"RTN","MAGDCCS",216,0)
 Q
"RTN","MAGDCCS",217,0)
 ;
"RTN","MAGDCCS",218,0)
SETMAG ;
"RTN","MAGDCCS",219,0)
 S FIRST=MAGIEN,FIRSTS=$G(SUID),MAGIEN=PREV,SUID=$G(PREVS)
"RTN","MAGDCCS",220,0)
 S PREV=FIRST,PREVS=FIRSTS
"RTN","MAGDCCS",221,0)
 Q
"RTN","MAGDCCS",222,0)
 ;
"RTN","MAGDCCS",223,0)
CHKPREV ;
"RTN","MAGDCCS",224,0)
 S OUT=1 N STATUS
"RTN","MAGDCCS",225,0)
 I '$D(MAGFIX(PREV)) D SETMAG G SET
"RTN","MAGDCCS",226,0)
 S STATUS=$S($G(MAGFIX(PREV))="D":"deleted",1:"corrected")
"RTN","MAGDCCS",227,0)
 W !,"Previous entry has been "_STATUS_".",$C(7)
"RTN","MAGDCCS",228,0)
 G SET
"RTN","MAGDCCS",229,0)
 Q
"RTN","MAGDCCS2")
0^3^B18217795
"RTN","MAGDCCS2",1,0)
MAGDCCS2 ;WOIFO/MLH/JSL/SAF - DICOM Correct - Clinical Specialties - subroutines ; 13 Nov 2007 1:40 PM
"RTN","MAGDCCS2",2,0)
 ;;3.0;IMAGING;**10,11,30,54,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDCCS2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDCCS2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDCCS2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDCCS2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDCCS2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDCCS2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDCCS2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDCCS2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDCCS2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDCCS2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDCCS2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDCCS2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDCCS2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCS2",17,0)
 ;;
"RTN","MAGDCCS2",18,0)
 Q
"RTN","MAGDCCS2",19,0)
 ; Routine to create the MAGDY variable needed by MAGDCCS routine when
"RTN","MAGDCCS2",20,0)
 ; manually correcting DICOM FIX files. 
"RTN","MAGDCCS2",21,0)
EN ;
"RTN","MAGDCCS2",22,0)
 ; MAGDY variable to be created during this execution.
"RTN","MAGDCCS2",23,0)
 N D,DIC,DUOUT,DZ,MAGBEG,MAGEND,MAGDFN,MAGOUT,MAGX,MAGXX,INFO,MAGNME,MAGPID,Y
"RTN","MAGDCCS2",24,0)
 S MAGBEG=1070101,MAGEND=$$DT^XLFDT
"RTN","MAGDCCS2",25,0)
 W !,"*** Select a request/consult with whose ***"
"RTN","MAGDCCS2",26,0)
 W !,"***  TIU note to associate this image   ***"
"RTN","MAGDCCS2",27,0)
 S DIC="^GMR(123,",DIC(0)="AENZ"
"RTN","MAGDCCS2",28,0)
 S DIC("A")="Enter patient or request/consultation: "
"RTN","MAGDCCS2",29,0)
 S D="F",DZ="??"
"RTN","MAGDCCS2",30,0)
 S DIC("W")="W ""  REQ/CON #"",Y"
"RTN","MAGDCCS2",31,0)
 S DIC("W")=DIC("W")_",""  "",$$GET1^DIQ(123,Y,1)" ; TO SERVICE
"RTN","MAGDCCS2",32,0)
 S DIC("W")=DIC("W")_",""  "",$$GET1^DIQ(123,Y,.02)" ; PATIENT NAME
"RTN","MAGDCCS2",33,0)
 ;
"RTN","MAGDCCS2",34,0)
 D IX^DIC
"RTN","MAGDCCS2",35,0)
 Q:$D(DUOUT)
"RTN","MAGDCCS2",36,0)
 Q:'$D(Y(0))  ; 
"RTN","MAGDCCS2",37,0)
 I "^DISCONTINUED^CANCELLED^"[("^"_$$GET1^DIQ(123,+Y,8)_"^") D  Q
"RTN","MAGDCCS2",38,0)
 . W !!,"This consult has been cancelled and cannot be selected." H 2
"RTN","MAGDCCS2",39,0)
 . Q
"RTN","MAGDCCS2",40,0)
 S (MAGDFN,MAGX)=$P(Y(0),U,2)_"~"_Y
"RTN","MAGDCCS2",41,0)
 ;
"RTN","MAGDCCS2",42,0)
 D ONE ; Lookup was on req/con number and successful
"RTN","MAGDCCS2",43,0)
 Q
"RTN","MAGDCCS2",44,0)
 ;
"RTN","MAGDCCS2",45,0)
PTINFO() ;
"RTN","MAGDCCS2",46,0)
 N INFO,MAGOUT,MAGERR
"RTN","MAGDCCS2",47,0)
 I '$D(MAGDFN) Q ""
"RTN","MAGDCCS2",48,0)
 I $$ISIHS^MAGSPID() D  Q INFO  ;P123 - MOD for IHS patients with multiple chart numbers (i.e. Chawktaw)
"RTN","MAGDCCS2",49,0)
 . N DFN S DFN=MAGDFN,INFO="" D DEM^VADPT
"RTN","MAGDCCS2",50,0)
 . I $G(VA("PID"))'="" S INFO=$G(VADM(1))_"^"_$TR(VA("PID"),"-")
"RTN","MAGDCCS2",51,0)
 . Q
"RTN","MAGDCCS2",52,0)
 D GETS^DIQ(2,MAGDFN,".01;.09","E","MAGOUT","MAGERR")
"RTN","MAGDCCS2",53,0)
 I $D(MAGERR) Q ""
"RTN","MAGDCCS2",54,0)
 I $D(MAGOUT) D  Q INFO
"RTN","MAGDCCS2",55,0)
 . S INFO=$G(MAGOUT(2,MAGDFN_",",.01,"E"))
"RTN","MAGDCCS2",56,0)
 . S INFO=INFO_"^"_$G(MAGOUT(2,MAGDFN_",",.09,"E"))
"RTN","MAGDCCS2",57,0)
 Q ""
"RTN","MAGDCCS2",58,0)
 ;
"RTN","MAGDCCS2",59,0)
ONE ; Process the single entry that was selected.
"RTN","MAGDCCS2",60,0)
 ; MAGDFN,MAGX variables expected from EN
"RTN","MAGDCCS2",61,0)
 I 'MAGDFN,'+MAGX Q
"RTN","MAGDCCS2",62,0)
 N BEG,CASE,CDATE,CS,DATA,END,FLDS,INFO,MAGCASE,MAGCNI,MAGDATE,MAGDTI
"RTN","MAGDCCS2",63,0)
 N MAGEXST,MAGLOC,MAGNME,MAGOUT,MAGPIEN,MAGPRC,MAGPSET,MAGPST,MAGRPT
"RTN","MAGDCCS2",64,0)
 N PP,PSET,RAENTRY,RAMEMLOW,RAPRTSET,RIEN,STAT,X,X1,X2,XX
"RTN","MAGDCCS2",65,0)
 N RARPT,RADFN,RADTI,RACNI ;<--Variables needed for EN1^RAUTL20
"RTN","MAGDCCS2",66,0)
 ; RAUTL20 used to retrieve if case is part of a print set.
"RTN","MAGDCCS2",67,0)
 N MAGRCARY ; array of req/con data from file 123
"RTN","MAGDCCS2",68,0)
 N MAGIENS  ; internal entry number for MAGRCARY
"RTN","MAGDCCS2",69,0)
 ;
"RTN","MAGDCCS2",70,0)
 S MAGDFN=$P(MAGX,"~"),INFO=$$PTINFO
"RTN","MAGDCCS2",71,0)
 S MAGNME=$P(INFO,"^"),MAGPID=$P(INFO,"^",2)
"RTN","MAGDCCS2",72,0)
 S MAGCASE=$P($P(MAGX,"~",2),U)
"RTN","MAGDCCS2",73,0)
 S (MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAGLOC,MAGDATE,MAGEXST,MAGPST)=""
"RTN","MAGDCCS2",74,0)
 K MAGRCARY D GETS^DIQ(123,MAGCASE,"*","EI","MAGRCARY")
"RTN","MAGDCCS2",75,0)
 ;
"RTN","MAGDCCS2",76,0)
 S MAGIENS=$O(MAGRCARY(123,""))
"RTN","MAGDCCS2",77,0)
 S MAGPRC=MAGRCARY(123,MAGIENS,4,"E") ; procedure
"RTN","MAGDCCS2",78,0)
 S MAGLOC=MAGRCARY(123,MAGIENS,1,"E") ; to service
"RTN","MAGDCCS2",79,0)
 S MAGDATE=MAGRCARY(123,MAGIENS,.01,"E") ; request date
"RTN","MAGDCCS2",80,0)
 S MAGPST=MAGRCARY(123,MAGIENS,8,"E") ; procedure status
"RTN","MAGDCCS2",81,0)
 W !,"PATIENT: ",MAGNME,?51,$$PIDLABEL^MAGSPID(),": ",MAGPID
"RTN","MAGDCCS2",82,0)
 W !,"Req/Con No.",?13,"Procedure",?38,"To Service",?58,"Req Date"
"RTN","MAGDCCS2",83,0)
 W !,"-----------",?13,"---------",?38,"----------------",?58,"--------"
"RTN","MAGDCCS2",84,0)
 W !,MAGCASE,?13,MAGPRC,?38,MAGLOC,?58,MAGDATE
"RTN","MAGDCCS2",85,0)
 W !,"Exam status: ",MAGEXST," "," ",$G(MAGPST)
"RTN","MAGDCCS2",86,0)
 D MAGDY
"RTN","MAGDCCS2",87,0)
 Q
"RTN","MAGDCCS2",88,0)
 ;
"RTN","MAGDCCS2",89,0)
MAGDY ;
"RTN","MAGDCCS2",90,0)
 K MAGDY
"RTN","MAGDCCS2",91,0)
 S MAGDY=MAGDFN_"^"_MAGNME_"^"_MAGPID_"^"_"GMRC-"_MAGCASE_"^"_MAGPRC_"^"_MAGDTI
"RTN","MAGDCCS2",92,0)
 S MAGDY=MAGDY_"^"_MAGCNI_"^"_MAGPIEN_"^"_$G(MAGPST)_"^"
"RTN","MAGDCCS2",93,0)
 K MAGNME,MAGPID,MAGCASE,MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAPST
"RTN","MAGDCCS2",94,0)
 Q
"RTN","MAGDCCSD")
0^4^B10038347
"RTN","MAGDCCSD",1,0)
MAGDCCSD ;WOIFO/MLH/JSL/SAF - DICOM Correct - Clinical Specialties - Driver ; 01/30/2004  17:14
"RTN","MAGDCCSD",2,0)
 ;;3.0;IMAGING;**10,11,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDCCSD",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDCCSD",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCSD",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDCCSD",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDCCSD",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDCCSD",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDCCSD",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDCCSD",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDCCSD",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDCCSD",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDCCSD",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDCCSD",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDCCSD",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDCCSD",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDCCSD",17,0)
 ;;
"RTN","MAGDCCSD",18,0)
 Q
"RTN","MAGDCCSD",19,0)
EN() ;Start looping either by patient or loop thru Study uid
"RTN","MAGDCCSD",20,0)
 N DIR,X,Y
"RTN","MAGDCCSD",21,0)
 S DIR(0)="S^P:Patient;L:Loop thru file;D:Specify a Date Range"
"RTN","MAGDCCSD",22,0)
 S DIR("A")="Update entries by"
"RTN","MAGDCCSD",23,0)
 D ^DIR
"RTN","MAGDCCSD",24,0)
 Q Y
"RTN","MAGDCCSD",25,0)
 ;
"RTN","MAGDCCSD",26,0)
START ;
"RTN","MAGDCCSD",27,0)
 N MAGSORT,MAGIEN,PREV,START,STOP,X,Y
"RTN","MAGDCCSD",28,0)
 N KFIXALL ; -- does user hold MAGDFIX ALL key
"RTN","MAGDCCSD",29,0)
 ;
"RTN","MAGDCCSD",30,0)
 S KFIXALL=$$SECKEY^MAGDLB12()
"RTN","MAGDCCSD",31,0)
 S MAGSORT=$$EN Q:MAGSORT["^"
"RTN","MAGDCCSD",32,0)
 I MAGSORT="P" D  G EXIT
"RTN","MAGDCCSD",33,0)
 . L +^MAGD(2006.575,"D"):1E9 D SRT^MAGDCCSS S MAGIEN=$$SELECT L -^MAGD(2006.575,"D"):1E9 Q:MAGIEN<1
"RTN","MAGDCCSD",34,0)
 . I 'KFIXALL,$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)'=$G(DUZ(2)) D  Q
"RTN","MAGDCCSD",35,0)
 . . W !,"The entry selected was not captured on your site's gateway."
"RTN","MAGDCCSD",36,0)
 . . W !,"You are not authorized to correct another site's entries."
"RTN","MAGDCCSD",37,0)
 . . Q
"RTN","MAGDCCSD",38,0)
 . I $D(^MAGD(2006.575,MAGIEN,"TYPE")),$P(^("TYPE"),"^")'="CON" D  Q
"RTN","MAGDCCSD",39,0)
 . . W !,"Only Clinical Specialties images may be fixed using this option."
"RTN","MAGDCCSD",40,0)
 . . Q
"RTN","MAGDCCSD",41,0)
 . S PREV=MAGIEN D SET^MAGDCCS
"RTN","MAGDCCSD",42,0)
 . Q
"RTN","MAGDCCSD",43,0)
 I MAGSORT="D" D  G EXIT
"RTN","MAGDCCSD",44,0)
 . D SRTDT^MAGDCCSS
"RTN","MAGDCCSD",45,0)
 . D ASKDT^MAGDCCSS
"RTN","MAGDCCSD",46,0)
 . I '$D(STR)!'($D(STP)) Q
"RTN","MAGDCCSD",47,0)
 . S START=STR,STOP=STP K STR,STP
"RTN","MAGDCCSD",48,0)
 . D DATELOOP^MAGDCCS(START,STOP)
"RTN","MAGDCCSD",49,0)
 . Q
"RTN","MAGDCCSD",50,0)
 E  D
"RTN","MAGDCCSD",51,0)
 . D L^MAGDCCS
"RTN","MAGDCCSD",52,0)
 . Q
"RTN","MAGDCCSD",53,0)
EXIT ;
"RTN","MAGDCCSD",54,0)
 K ANS,ANSR,CASENO,COMNT1,DATA,DATA1,DATA2,DATE,FILE,FIRST,FIRSTS,I,MACHID,MAGDY
"RTN","MAGDCCSD",55,0)
 K MAGDIEN,MAGCSE,MAGERR,MAGFIX,MAGDTPRT,MAGTYPE,MAGDTPRT,MAGSTP,MSG
"RTN","MAGDCCSD",56,0)
 K MOD,MODEL,NEWCAS,NEWDFN,NEWDTI,NEWDTIM,NEWMUL,NEWNME,NEWPIEN,NEWPROC
"RTN","MAGDCCSD",57,0)
 K NEWPID,OK,OOUT,OUT,PAT,PID,PREV,PREVS,REASON,STUDYUID,SUID,WHY
"RTN","MAGDCCSD",58,0)
 Q
"RTN","MAGDCCSD",59,0)
SELECT() ;
"RTN","MAGDCCSD",60,0)
 N DIC,D,X,Y
"RTN","MAGDCCSD",61,0)
 S DIC="^MAGD(2006.575,",D="D",DIC(0)="AEQ"
"RTN","MAGDCCSD",62,0)
 D MIX^DIC1
"RTN","MAGDCCSD",63,0)
 Q +Y
"RTN","MAGDCCSD",64,0)
SLDATE() ;
"RTN","MAGDCCSD",65,0)
 N DIC,D,X,Y
"RTN","MAGDCCSD",66,0)
 S DIC="^MAGD(2006.575,",D="AD",DIC(0)="AE"
"RTN","MAGDCCSD",67,0)
 D MIX^DIC1
"RTN","MAGDCCSD",68,0)
 Q +Y
"RTN","MAGDHLS")
0^5^B74934022
"RTN","MAGDHLS",1,0)
MAGDHLS ;WOIFO/MLH/JSL/SAF - IHE-based ADT interface for PACS - segments ; 23 Jul 2009 8:15 AM
"RTN","MAGDHLS",2,0)
 ;;3.0;IMAGING;**49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDHLS",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDHLS",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDHLS",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDHLS",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDHLS",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDHLS",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDHLS",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDHLS",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDHLS",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDHLS",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDHLS",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDHLS",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDHLS",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDHLS",17,0)
 ;;
"RTN","MAGDHLS",18,0)
 Q
"RTN","MAGDHLS",19,0)
 ;
"RTN","MAGDHLS",20,0)
 ; It is always expected that the HL7 environment variables will have
"RTN","MAGDHLS",21,0)
 ; been initialized by a call to INIT^HLFNC2 for the appropriate event
"RTN","MAGDHLS",22,0)
 ; driver protocol.
"RTN","MAGDHLS",23,0)
 ; 
"RTN","MAGDHLS",24,0)
AL1(XDFN,XYMSG) ; patient allergies
"RTN","MAGDHLS",25,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",26,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",27,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",28,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",29,0)
 ; 
"RTN","MAGDHLS",30,0)
 N DFN ; ------ internal entry number on ^DPT
"RTN","MAGDHLS",31,0)
 N IXAL ; ----- allergy index (on GMRAL array)
"RTN","MAGDHLS",32,0)
 N SETID ; ---- index of the AL1 segment on this message
"RTN","MAGDHLS",33,0)
 N ALDTA ; ---- allergy data
"RTN","MAGDHLS",34,0)
 N IXREAC ; --- reaction index
"RTN","MAGDHLS",35,0)
 N REPIX ; ---- field repetition index
"RTN","MAGDHLS",36,0)
 N VA,VADPT ; - Return arrays from DEM^VADPT containing patient demographics
"RTN","MAGDHLS",37,0)
 ;
"RTN","MAGDHLS",38,0)
 D DEM^VADPT
"RTN","MAGDHLS",39,0)
 ;
"RTN","MAGDHLS",40,0)
 K YSEGA
"RTN","MAGDHLS",41,0)
 S DFN=XDFN D ^GMRADPT ; get patient's allergies
"RTN","MAGDHLS",42,0)
 S IXAL=0
"RTN","MAGDHLS",43,0)
 F SETID=1:1 S IXAL=$O(GMRAL(IXAL)) Q:'IXAL  D
"RTN","MAGDHLS",44,0)
 . S ALDTA=$G(GMRAL(IXAL))
"RTN","MAGDHLS",45,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",46,0)
 . S @XYMSG@(SEGIX,0)="AL1"
"RTN","MAGDHLS",47,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",48,0)
 . S @XYMSG@(SEGIX,2,1,1,1)=$P(ALDTA,U,7) ; type
"RTN","MAGDHLS",49,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$P(ALDTA,U,2) ; description
"RTN","MAGDHLS",50,0)
 . S IXREAC=0
"RTN","MAGDHLS",51,0)
 . F REPIX=1:1 S IXREAC=$O(GMRAL(IXAL,"S",IXREAC)) Q:'IXREAC  D
"RTN","MAGDHLS",52,0)
 . . S @XYMSG@(SEGIX,5,REPIX,1,1)=$P($G(GMRAL(IXAL,"S",IXREAC)),";",1) ; reaction
"RTN","MAGDHLS",53,0)
 . . Q
"RTN","MAGDHLS",54,0)
 . Q
"RTN","MAGDHLS",55,0)
 Q 0
"RTN","MAGDHLS",56,0)
 ;
"RTN","MAGDHLS",57,0)
DG1(XDFN,XYMSG) ; FUNCTION - diagnosis
"RTN","MAGDHLS",58,0)
 ; input:  XDFN      internal entry number of the patient on global ^DPT
"RTN","MAGDHLS",59,0)
 ;         XYMSG     name of array to which to add message elts
"RTN","MAGDHLS",60,0)
 ; output: @XYMSG    input array plus new subtree containing EVN elts
"RTN","MAGDHLS",61,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",62,0)
 ;
"RTN","MAGDHLS",63,0)
 N DFN ; ----- internal entry number on ^DPT
"RTN","MAGDHLS",64,0)
 N VAIP ; ---- inpatient episode data array
"RTN","MAGDHLS",65,0)
 N SETID ; --- segment index for diagnoses
"RTN","MAGDHLS",66,0)
 N APROB ; --- problem list array
"RTN","MAGDHLS",67,0)
 N PROBIX ; -- problem list index
"RTN","MAGDHLS",68,0)
 ;
"RTN","MAGDHLS",69,0)
 S SETID=0 ; segment increment base
"RTN","MAGDHLS",70,0)
 S DFN=XDFN D IN5^VADPT ; get patient's inpatient episode data
"RTN","MAGDHLS",71,0)
 I $G(VAIP(9))'="" D  ; is there a diag assoc'd w/the latest movement?
"RTN","MAGDHLS",72,0)
 . ; yes, populate data for the DG1 segment
"RTN","MAGDHLS",73,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",74,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",75,0)
 . ; populate element leaves
"RTN","MAGDHLS",76,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",77,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",78,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E(VAIP(9),1,249) ; diagnosis text
"RTN","MAGDHLS",79,0)
 . ; either admitting or working diagnosis
"RTN","MAGDHLS",80,0)
 . S @XYMSG@(SEGIX,6,1,1,1)=$S($P($G(VAIP(2)),"^",1)=1:"A",1:"W")
"RTN","MAGDHLS",81,0)
 . Q
"RTN","MAGDHLS",82,0)
 ;
"RTN","MAGDHLS",83,0)
 ; get patient's active problem list
"RTN","MAGDHLS",84,0)
 D ACTIVE^GMPLUTL(XDFN,.APROB) ; DBIA #928
"RTN","MAGDHLS",85,0)
 S PROBIX=0
"RTN","MAGDHLS",86,0)
 F  S PROBIX=$O(APROB(PROBIX)) Q:'PROBIX  D
"RTN","MAGDHLS",87,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",88,0)
 . S @XYMSG@(SEGIX,0)="DG1" ; segment ID
"RTN","MAGDHLS",89,0)
 . ; populate element leaves
"RTN","MAGDHLS",90,0)
 . S SETID=SETID+1
"RTN","MAGDHLS",91,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",92,0)
 . S @XYMSG@(SEGIX,3,1,2,1)=$E($P(APROB(PROBIX,1),"^",2),1,249) ; problem text
"RTN","MAGDHLS",93,0)
 . S @XYMSG@(SEGIX,6,1,1,1)="W" ; working diagnosis
"RTN","MAGDHLS",94,0)
 . Q
"RTN","MAGDHLS",95,0)
 ;
"RTN","MAGDHLS",96,0)
 Q 0
"RTN","MAGDHLS",97,0)
 ;
"RTN","MAGDHLS",98,0)
EVN(XEVENT,XEVNRDT,XEVNODT,XYMSG) ; FUNCTION - event
"RTN","MAGDHLS",99,0)
 ; input:  XEVENT   trigger event code
"RTN","MAGDHLS",100,0)
 ;         XEVNRDT  date/time the event was recorded (FM format)
"RTN","MAGDHLS",101,0)
 ;         XEVNODT  date/time the event occurred (FM format)
"RTN","MAGDHLS",102,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",103,0)
 ; output: @XYMSG   input array plus new subtree containing EVN elts
"RTN","MAGDHLS",104,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",105,0)
 ; 
"RTN","MAGDHLS",106,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",107,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",108,0)
 N FLDIX ; ---- field index on @XYMSG
"RTN","MAGDHLS",109,0)
 ;
"RTN","MAGDHLS",110,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",111,0)
 S @XYMSG@(SEGIX,0)="EVN"
"RTN","MAGDHLS",112,0)
 ; populate trigger event code and dates into element leaves
"RTN","MAGDHLS",113,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XEVENT
"RTN","MAGDHLS",114,0)
 S @XYMSG@(SEGIX,2,1,1,1)=$$FMTHL7^XLFDT(XEVNRDT)
"RTN","MAGDHLS",115,0)
 S @XYMSG@(SEGIX,6,1,1,1)=$$FMTHL7^XLFDT(XEVNODT)
"RTN","MAGDHLS",116,0)
 F FLDIX=2,6 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,FLDIX,1,1,1)))
"RTN","MAGDHLS",117,0)
 Q 0
"RTN","MAGDHLS",118,0)
 ;
"RTN","MAGDHLS",119,0)
MRG(XMRGICN,XYMSG) ; FUNCTION - merge ICNs
"RTN","MAGDHLS",120,0)
 ; input:  XMRGICN   DFN being merged from
"RTN","MAGDHLS",121,0)
 ;         XYMSG     name of array to which to add MRG segment
"RTN","MAGDHLS",122,0)
 ; output: @XYMSG    input array plus new subtree containing MRG elts
"RTN","MAGDHLS",123,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",124,0)
 ;         
"RTN","MAGDHLS",125,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",126,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",127,0)
 ;
"RTN","MAGDHLS",128,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",129,0)
 S @XYMSG@(SEGIX,0)="MRG"
"RTN","MAGDHLS",130,0)
 ; populate ICN info into element leaves
"RTN","MAGDHLS",131,0)
 S @XYMSG@(SEGIX,1,1,1,1)=XMRGICN
"RTN","MAGDHLS",132,0)
 S @XYMSG@(SEGIX,1,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",133,0)
 S @XYMSG@(SEGIX,1,1,5,1)="NI"
"RTN","MAGDHLS",134,0)
 Q 0
"RTN","MAGDHLS",135,0)
 ;
"RTN","MAGDHLS",136,0)
OBXADT(XDFN,XYMSG) G OBXADT^MAGDHLSO ; FUNCTION - patient height/weight
"RTN","MAGDHLS",137,0)
 ;
"RTN","MAGDHLS",138,0)
PID(XDFN,XYMSG) ; FUNCTION - patient ID/demo
"RTN","MAGDHLS",139,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",140,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",141,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",142,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",143,0)
 ;
"RTN","MAGDHLS",144,0)
 N PIDARY ; --- array for segment to be returned by VistA HL7 fcn
"RTN","MAGDHLS",145,0)
 N HL ; ------- array containing delims, etc. expected by VistA HL7 fcn
"RTN","MAGDHLS",146,0)
 N MSGDMY ; --- dummy array of scalar message lines for parser
"RTN","MAGDHLS",147,0)
 N I ; -------- loop counter
"RTN","MAGDHLS",148,0)
 N IX,IX1,IX2,IX3,IX4 ; dummy indices
"RTN","MAGDHLS",149,0)
 N SEGIX ; ---- segment index on @XYMSG
"RTN","MAGDHLS",150,0)
 N NUL ; ------ null return from called function
"RTN","MAGDHLS",151,0)
 N MSGTREE ; -- tree of message elements to be returned by $$PARSE^MAG7UP
"RTN","MAGDHLS",152,0)
 N STATNUMB ; - station number
"RTN","MAGDHLS",153,0)
 N STAT ; ----- status return from function calls
"RTN","MAGDHLS",154,0)
 N PTICN ; ---- patient integration control number
"RTN","MAGDHLS",155,0)
 N DFN ; ---- patient internal entry number (needed for VADPT call)
"RTN","MAGDHLS",156,0)
 ;
"RTN","MAGDHLS",157,0)
 S HL("ECH")=HLECH,HL("FS")=HLFS,HL("Q")=HLQ
"RTN","MAGDHLS",158,0)
 S STATNUMB=$P($$SITE^VASITE(),"^",3) ; station number
"RTN","MAGDHLS",159,0)
 ;S STATNUMB=$E($P($$NS^XUAF4($$KSP^XUPARAM("INST")),U,2),1,3) ; station number
"RTN","MAGDHLS",160,0)
 ; does pt have a national ICN?
"RTN","MAGDHLS",161,0)
 I $L($T(IFLOCAL^MPIF001)) I $$IFLOCAL^MPIF001(XDFN)'=1 D   ;p123 - ICN is local, not national
"RTN","MAGDHLS",162,0)
 . S PTICN=$$GETICN^MPIF001(XDFN) ; ICR #2701
"RTN","MAGDHLS",163,0)
 . K:+PTICN<0 PTICN ; no ICN exists
"RTN","MAGDHLS",164,0)
 . Q
"RTN","MAGDHLS",165,0)
 ; build a dummy message including MSH, PID
"RTN","MAGDHLS",166,0)
 ; (MSH required for $$PARSE^MAG7UP to work)
"RTN","MAGDHLS",167,0)
 S MSGDMY(1)="MSH"_HLFS_HLECH
"RTN","MAGDHLS",168,0)
 S MSGDMY(2)=$$EN^VAFHLPID(XDFN,"5,7,8,10BN,11,19,22B"),IX=0 ; DBIA #263
"RTN","MAGDHLS",169,0)
 S NUL=$$PARSE^MAG7UP("MSGDMY","MSGTREE") ; parse the message
"RTN","MAGDHLS",170,0)
 S DFN=XDFN D PID^VADPT  ;Get patient Identifiers in VA array
"RTN","MAGDHLS",171,0)
 ; purge patient identifiers PID-2 thru PID-4
"RTN","MAGDHLS",172,0)
 F IX=2,3,4 K MSGTREE(2,IX)
"RTN","MAGDHLS",173,0)
 ; assign station number-dfn to PID-2
"RTN","MAGDHLS",174,0)
 S MSGTREE(2,2,1,1,1)=STATNUMB_"-"_XDFN
"RTN","MAGDHLS",175,0)
 S MSGTREE(2,2,1,2,1)=""
"RTN","MAGDHLS",176,0)
 S MSGTREE(2,2,1,3,1)=""
"RTN","MAGDHLS",177,0)
 S MSGTREE(2,2,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",178,0)
 S MSGTREE(2,2,1,5,1)="PI"
"RTN","MAGDHLS",179,0)
 ; assign HRN or social security number to PID-3
"RTN","MAGDHLS",180,0)
 S MSGTREE(2,3,1,1,1)=$S($$ISIHS^MAGSPID():VA("PID"),1:$G(MSGTREE(2,19,1,1,1)))  ;P123
"RTN","MAGDHLS",181,0)
 S MSGTREE(2,3,1,2,1)=""
"RTN","MAGDHLS",182,0)
 S MSGTREE(2,3,1,3,1)=""
"RTN","MAGDHLS",183,0)
 S MSGTREE(2,3,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",184,0)
 S MSGTREE(2,3,1,5,1)="NI"
"RTN","MAGDHLS",185,0)
 D:$D(PTICN)  ; use nat'l ICN (if available) as the alternate pt id in PID-4
"RTN","MAGDHLS",186,0)
 . S MSGTREE(2,4,1,1,1)=PTICN
"RTN","MAGDHLS",187,0)
 . S MSGTREE(2,4,1,2,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",188,0)
 . S MSGTREE(2,4,1,3,1)="" ; no checksum (included in ICN)
"RTN","MAGDHLS",189,0)
 . S MSGTREE(2,4,1,4,1)=$S($$ISIHS^MAGSPID():"USIHS",1:"USVHA")  ;P123
"RTN","MAGDHLS",190,0)
 . S MSGTREE(2,4,1,5,1)="NI"
"RTN","MAGDHLS",191,0)
 . Q
"RTN","MAGDHLS",192,0)
 ; strip suffix, if any, off race and ethnicity codes
"RTN","MAGDHLS",193,0)
 F IX1=10,22 D
"RTN","MAGDHLS",194,0)
 . S:$G(MSGTREE(2,IX1,1,1,1))["-" MSGTREE(2,IX1,1,1,1)=$P(MSGTREE(2,IX1,1,1,1),"-",1,2)
"RTN","MAGDHLS",195,0)
 . Q
"RTN","MAGDHLS",196,0)
 ; insert PID subtree into passed-in element array
"RTN","MAGDHLS",197,0)
 ; this code eliminates values on intermediate (i.e., non-leaf) nodes
"RTN","MAGDHLS",198,0)
 S SEGIX=$O(@XYMSG@(" "),-1)+1
"RTN","MAGDHLS",199,0)
 S @XYMSG@(SEGIX,0)="PID" ; segment tag
"RTN","MAGDHLS",200,0)
 S IX1=0 F  S IX1=$O(MSGTREE(2,IX1)) Q:'IX1  D
"RTN","MAGDHLS",201,0)
 . S IX2=0 F  S IX2=$O(MSGTREE(2,IX1,IX2)) Q:'IX2  D
"RTN","MAGDHLS",202,0)
 . . S IX3=0 F  S IX3=$O(MSGTREE(2,IX1,IX2,IX3)) Q:'IX3  D
"RTN","MAGDHLS",203,0)
 . . . S IX4=0 F  S IX4=$O(MSGTREE(2,IX1,IX2,IX3,IX4)) Q:'IX4  D
"RTN","MAGDHLS",204,0)
 . . . . S @XYMSG@(SEGIX,IX1,IX2,IX3,IX4)=MSGTREE(2,IX1,IX2,IX3,IX4)
"RTN","MAGDHLS",205,0)
 . . . . Q
"RTN","MAGDHLS",206,0)
 . . . Q
"RTN","MAGDHLS",207,0)
 . . Q
"RTN","MAGDHLS",208,0)
 . Q
"RTN","MAGDHLS",209,0)
 S STAT=$$STRIP0^MAG7UD($NA(@XYMSG@(SEGIX,7,1,1,1))) ; strip 0's off DOB
"RTN","MAGDHLS",210,0)
 Q 0
"RTN","MAGDHLS",211,0)
 ;
"RTN","MAGDHLS",212,0)
PV1(XDFN,XEVN,XEVNDT,XYMSG) G PV1^MAGDHLSV ; FUNCTION - patient visit
"RTN","MAGDHLS",213,0)
 ;
"RTN","MAGDHLS",214,0)
ROL(XDFN,XYMSG) ; FUNCTION role (for physicians) - propagate from PV1
"RTN","MAGDHLS",215,0)
 ; assumes PV1 segment is already populated
"RTN","MAGDHLS",216,0)
 ; 
"RTN","MAGDHLS",217,0)
 ; input:  XDFN      internal entry number of the pt on gbl ^DPT
"RTN","MAGDHLS",218,0)
 ;         XYMSG    name of array to which to add message elts
"RTN","MAGDHLS",219,0)
 ; output: @XYMSG    input array plus new subtree containing PID elts
"RTN","MAGDHLS",220,0)
 ;         function return   0 (success) always
"RTN","MAGDHLS",221,0)
 ;
"RTN","MAGDHLS",222,0)
 N PRCTYP ; -- type of practitioner
"RTN","MAGDHLS",223,0)
 N NUL ; ----- null return from called function
"RTN","MAGDHLS",224,0)
 N SETID ; --- sequential index of ROL seg(s) in this message
"RTN","MAGDHLS",225,0)
 N PV1IX ; --- index of PV1 segment in message array
"RTN","MAGDHLS",226,0)
 N PHYSELT ; - element index of attending / referring physician on PV1 segment
"RTN","MAGDHLS",227,0)
 N I ; ------- scratch loop counter
"RTN","MAGDHLS",228,0)
 ;
"RTN","MAGDHLS",229,0)
 S DFN=XDFN,SETID=0
"RTN","MAGDHLS",230,0)
 S PV1IX="",I=0 F  S I=$O(@XYMSG@(I)) Q:'I  I @XYMSG@(I,0)="PV1" S PV1IX=I Q
"RTN","MAGDHLS",231,0)
 Q:'PV1IX  ; no physicians to propagate
"RTN","MAGDHLS",232,0)
 F PRCTYP="ATT","REF" D
"RTN","MAGDHLS",233,0)
 . S PHYSELT=$S(PRCTYP="ATT":7,1:8) Q:'$D(@XYMSG@(PV1IX,PHYSELT))
"RTN","MAGDHLS",234,0)
 . S SEGIX=$O(@XYMSG@(" "),-1)+1,SETID=SETID+1
"RTN","MAGDHLS",235,0)
 . S @XYMSG@(SEGIX,0)="ROL"
"RTN","MAGDHLS",236,0)
 . S @XYMSG@(SEGIX,1,1,1,1)=SETID
"RTN","MAGDHLS",237,0)
 . S @XYMSG@(SEGIX,2,1,1,1)="UP" ; receiver should always update
"RTN","MAGDHLS",238,0)
 . S @XYMSG@(SEGIX,3,1,1,1)=$S(PRCTYP="ATT":"AT",1:"RP")
"RTN","MAGDHLS",239,0)
 . M @XYMSG@(SEGIX,4)=@XYMSG@(PV1IX,PHYSELT)
"RTN","MAGDHLS",240,0)
 . S NUL=$$NPFON^MAG7UFO($NA(@XYMSG@(SEGIX,12)),$G(@XYMSG@(SEGIX,4,1,1,1)))
"RTN","MAGDHLS",241,0)
 . Q
"RTN","MAGDHLS",242,0)
 Q 0
"RTN","MAGDIR81")
0^6^B83085338
"RTN","MAGDIR81",1,0)
MAGDIR81 ;WOIFO/PMK/JSL/SAF - Read a DICOM image file ; 25 Feb 2008 11:06 AM
"RTN","MAGDIR81",2,0)
 ;;3.0;IMAGING;**11,30,51,50,46,54,53,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDIR81",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDIR81",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR81",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR81",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR81",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR81",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR81",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR81",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR81",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR81",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR81",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR81",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR81",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR81",17,0)
 ;;
"RTN","MAGDIR81",18,0)
 ; M2MB server
"RTN","MAGDIR81",19,0)
 ;
"RTN","MAGDIR81",20,0)
 ; This routine is invoked by the ^MAGDIR8 for the "STORE1/STORE2"
"RTN","MAGDIR81",21,0)
 ; REQUEST items when there is an image to be stored into the database.
"RTN","MAGDIR81",22,0)
 ; It adds it to the ^MAG global with appropriate pointers to the
"RTN","MAGDIR81",23,0)
 ; "parent data files".
"RTN","MAGDIR81",24,0)
 ;
"RTN","MAGDIR81",25,0)
ENTRY ; process one image
"RTN","MAGDIR81",26,0)
 N MEDATA ;--- medicine pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",27,0)
 N FILEDATA ;- array of data to be passed between routines
"RTN","MAGDIR81",28,0)
 N FIRSTDCM ;- patient first name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",29,0)
 N GMRCIEN ;-- internal entry number of consult/procedure request
"RTN","MAGDIR81",30,0)
 N IMPORTER ;- flag set by a gateway that is running the IMPORTER app
"RTN","MAGDIR81",31,0)
 N LASTDCM ;-- patient last name from the image header (ie, PNAMEDCM)
"RTN","MAGDIR81",32,0)
 N MEDIA ;---- source of DICOM object for Importer (D=disk, T=transmission)
"RTN","MAGDIR81",33,0)
 N MAGGP ;---- image's group pointer in ^MAG(2005)
"RTN","MAGDIR81",34,0)
 N MAGIEN ;--- pointer to the entry for the image in ^MAG(2005)
"RTN","MAGDIR81",35,0)
 N MIDCM ;---- patient middle initial from the image header (PNAMEDCM)
"RTN","MAGDIR81",36,0)
 N OLDPATH ;-- original path for imported images (set by Importer)
"RTN","MAGDIR81",37,0)
 N ORIGINDX ;- origin index (file 2005, field 45)
"RTN","MAGDIR81",38,0)
 N PNAMEVAH ;- patient name from VADM(1)
"RTN","MAGDIR81",39,0)
 N PROCDESC ;- procedure description (VA's name)
"RTN","MAGDIR81",40,0)
 N RADATA ;--- radiology pkg patient & study data (set in ^MAGDIR8A)
"RTN","MAGDIR81",41,0)
 N VADM ;----- array of demographic variables filled in by DEM^VADPT
"RTN","MAGDIR81",42,0)
 N I,MAG0,MAG1,MAG2,QUIT,X
"RTN","MAGDIR81",43,0)
 ;
"RTN","MAGDIR81",44,0)
 N ACNUMB,ARG2,CASENUMB,EMAIL,FROMPATH,IMAGEUID,IMAGNAME,IMAGNUMB,IMGSVC
"RTN","MAGDIR81",45,0)
 N INSTLOC,INSTNAME,LASTIMG,LOCATION,MACHID,MFGR,MODALITY,MODEL,MODPARMS
"RTN","MAGDIR81",46,0)
 N MULTFRAM,PID,PNAMEDCM,ROUTRULE,SERINUMB,SERIEUID,SOPCLASS,STAMP,STATUS
"RTN","MAGDIR81",47,0)
 N STUDYDAT,STUDYTIM,STUDYDAT,STUDYTIM,STUDYUID,SYSTITLE
"RTN","MAGDIR81",48,0)
 ;
"RTN","MAGDIR81",49,0)
 S STATUS=$P(ARGS,"|",1),LOCATION=$P(ARGS,"|",2)
"RTN","MAGDIR81",50,0)
 S MACHID=$P(ARGS,"|",3),IMGSVC=$P(ARGS,"|",4)
"RTN","MAGDIR81",51,0)
 S INSTNAME=$P(ARGS,"|",5),FROMPATH=$P(ARGS,"|",6)
"RTN","MAGDIR81",52,0)
 S PID=$P(ARGS,"|",7),PNAMEDCM=$P(ARGS,"|",8)
"RTN","MAGDIR81",53,0)
 S CASENUMB=$P(ARGS,"|",9),ACNUMB=$P(ARGS,"|",10)
"RTN","MAGDIR81",54,0)
 S STUDYDAT=$P(ARGS,"|",11),STUDYTIM=$P(ARGS,"|",12)
"RTN","MAGDIR81",55,0)
 S IMPORTER=$P(ARGS,"|",13),MODALITY=$P(ARGS,"|",14)
"RTN","MAGDIR81",56,0)
 S IMAGNAME=$P(ARGS,"|",15),MODPARMS=$P(ARGS,"|",16)
"RTN","MAGDIR81",57,0)
 S SERINUMB=$P(ARGS,"|",17),IMAGNUMB=$P(ARGS,"|",18)
"RTN","MAGDIR81",58,0)
 S INSTLOC=$P(ARGS,"|",19),MULTFRAM=$P(ARGS,"|",20)
"RTN","MAGDIR81",59,0)
 S SYSTITLE=$P(ARGS,"|",21),EMAIL=$P(ARGS,"|",22)
"RTN","MAGDIR81",60,0)
 S IREQUEST=IREQUEST+1,OPCODE=$P(REQUEST(IREQUEST),"|")
"RTN","MAGDIR81",61,0)
 I OPCODE'="STORE2" D  Q
"RTN","MAGDIR81",62,0)
 . D RESULT^MAGDIR8("STORE","-101 Expecting STORE2, got """_OPCODE_"""")
"RTN","MAGDIR81",63,0)
 . Q
"RTN","MAGDIR81",64,0)
 S ARG2=$P(REQUEST(IREQUEST),"|",2,999)
"RTN","MAGDIR81",65,0)
 S STUDYUID=$P(ARG2,"|",1),SERIEUID=$P(ARG2,"|",2)
"RTN","MAGDIR81",66,0)
 S IMAGEUID=$P(ARG2,"|",3),SOPCLASS=$P(ARG2,"|",4)
"RTN","MAGDIR81",67,0)
 S LASTIMG=$P(ARG2,"|",5),ROUTRULE=$P(ARG2,"|",6)
"RTN","MAGDIR81",68,0)
 S MFGR=$P(ARG2,"|",7),MODEL=$P(ARG2,"|",8)
"RTN","MAGDIR81",69,0)
 S STAMP=$P(ARG2,"|",9),ORIGINDX=$P(ARG2,"|",10)
"RTN","MAGDIR81",70,0)
 S MEDIA=$P(ARG2,"|",11),OLDPATH=$P(ARG2,"|",12)
"RTN","MAGDIR81",71,0)
 ;
"RTN","MAGDIR81",72,0)
 ; get a pointer to the image, if it is already on file
"RTN","MAGDIR81",73,0)
 S MAGIEN=$O(^MAG(2005,"P",IMAGEUID,0))
"RTN","MAGDIR81",74,0)
 ;
"RTN","MAGDIR81",75,0)
 ; the following line will have to be adjusted for DICOM SR
"RTN","MAGDIR81",76,0)
 S FILEDATA("TYPE")=$O(^MAG(2005.83,"B","IMAGE",""))
"RTN","MAGDIR81",77,0)
 ;
"RTN","MAGDIR81",78,0)
 I MULTFRAM,MAGIEN D  ; subsequent image of a multiframe object
"RTN","MAGDIR81",79,0)
 . D MULTFRAM ; require both MULTFRAM and MAGIEN to be non-zero
"RTN","MAGDIR81",80,0)
 . Q
"RTN","MAGDIR81",81,0)
 E  D  Q:ERRCODE  ; new image
"RTN","MAGDIR81",82,0)
 . S ERRCODE=$$NEWIMAGE()
"RTN","MAGDIR81",83,0)
 . I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",84,0)
 . . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",85,0)
 . . Q
"RTN","MAGDIR81",86,0)
 . Q
"RTN","MAGDIR81",87,0)
 ;
"RTN","MAGDIR81",88,0)
 ;create the image pointer
"RTN","MAGDIR81",89,0)
 I MODPARMS="<DICOM>" D  ; store DICOM image type in VistA
"RTN","MAGDIR81",90,0)
 . S FILEDATA("OBJECT TYPE")=100 ; DICOM image type
"RTN","MAGDIR81",91,0)
 . S FILEDATA("EXTENSION")="EXT^DCM" ; specify the DICOM file extension
"RTN","MAGDIR81",92,0)
 . Q
"RTN","MAGDIR81",93,0)
 E  D  ; convert DICOM image type to TGA and store it in VistA
"RTN","MAGDIR81",94,0)
 . S FILEDATA("OBJECT TYPE")=3 ; XRAY image type
"RTN","MAGDIR81",95,0)
 . S FILEDATA("EXTENSION")="EXT^TGA" ; specify the TGA file extension
"RTN","MAGDIR81",96,0)
 . Q
"RTN","MAGDIR81",97,0)
 S FILEDATA("ABSTRACT")="ABS^STUFFONLY" ; specify the abstract net loc
"RTN","MAGDIR81",98,0)
 ;
"RTN","MAGDIR81",99,0)
 S ERRCODE=$$IMAGE^MAGDIR9B ; create the ^MAG(2005) entry for the image
"RTN","MAGDIR81",100,0)
 I ERRCODE D  ; error - abort image processing
"RTN","MAGDIR81",101,0)
 . D ERROR^MAGDIR8("STORE",ERRCODE,.MSG,$T(+0))
"RTN","MAGDIR81",102,0)
 . Q
"RTN","MAGDIR81",103,0)
 E  D  ; no error
"RTN","MAGDIR81",104,0)
 . S X="0|"_RETURN
"RTN","MAGDIR81",105,0)
 . ; save pname, pid, dob, age, and sex from DEM^VADPT for gateway
"RTN","MAGDIR81",106,0)
 . F I=1:1:5 S X=X_"|"_VADM(I)
"RTN","MAGDIR81",107,0)
 . I $T(GETICN^MPIF001)'="" S X=X_"|"_$$GETICN^MPIF001(DFN) ; save ICN value
"RTN","MAGDIR81",108,0)
 . E  S X=X_"|"  ;P123 - for sites that have not implemented the MPI package
"RTN","MAGDIR81",109,0)
 . D RESULT^MAGDIR8("STORE",X)
"RTN","MAGDIR81",110,0)
 . Q
"RTN","MAGDIR81",111,0)
 Q
"RTN","MAGDIR81",112,0)
 ;
"RTN","MAGDIR81",113,0)
NEWIMAGE() ; processing for a new image
"RTN","MAGDIR81",114,0)
 N ERRORMSG ;- error message causing processing to stop
"RTN","MAGDIR81",115,0)
 N PIDCHECK ;- return value of from $$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",116,0)
 ;
"RTN","MAGDIR81",117,0)
 I MAGIEN D  I $L(ERRORMSG) Q ERRORMSG
"RTN","MAGDIR81",118,0)
 . N I,X
"RTN","MAGDIR81",119,0)
 . K MSG S I=0
"RTN","MAGDIR81",120,0)
 . I IMAGEUID=$$GETUID(MACHID) D  ; same image as last one
"RTN","MAGDIR81",121,0)
 . . ; process the image again, after software crash
"RTN","MAGDIR81",122,0)
 . . ; If the software crashed processing the first image, it might
"RTN","MAGDIR81",123,0)
 . . ; delete the image without ever writing it to the file server.
"RTN","MAGDIR81",124,0)
 . . ; Now, the image processing software has a second chance.
"RTN","MAGDIR81",125,0)
 . . S I=I+1,MSG(I)="Reprocessing image """_FROMPATH_""""
"RTN","MAGDIR81",126,0)
 . . S I=I+1,MSG(I)="which is partially in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",127,0)
 . . D ERROR^MAGDIR8("STORE","1 Image partially in the database",.MSG,$T(+0))
"RTN","MAGDIR81",128,0)
 . . S ERRORMSG="" ; this is not an error!
"RTN","MAGDIR81",129,0)
 . . Q
"RTN","MAGDIR81",130,0)
 . E  D  ; don't accept images with duplicate UIDs
"RTN","MAGDIR81",131,0)
 . . S I=I+1,MSG(I)="Image """_FROMPATH_""""
"RTN","MAGDIR81",132,0)
 . . S I=I+1,MSG(I)="is already in the database (#"_MAGIEN_") for"
"RTN","MAGDIR81",133,0)
 . . S ERRORMSG="-1 Image already in database"
"RTN","MAGDIR81",134,0)
 . . Q
"RTN","MAGDIR81",135,0)
 . S X=$P($G(^MAG(2005,MAGIEN,2)),"^",1)
"RTN","MAGDIR81",136,0)
 . S X=$S(X:$$FMTE^XLFDT(X,1),1:"<no date known>")
"RTN","MAGDIR81",137,0)
 . S I=I+1,MSG(I)=""""_$P($G(^MAG(2005,MAGIEN,0)),"^")_""""
"RTN","MAGDIR81",138,0)
 . S I=I+1,MSG(I)="Entered into VistA database on "_X
"RTN","MAGDIR81",139,0)
 . S I=I+1,MSG(I)="UID = "_IMAGEUID
"RTN","MAGDIR81",140,0)
 . Q
"RTN","MAGDIR81",141,0)
 ;
"RTN","MAGDIR81",142,0)
 D SAVEUID(MACHID,IMAGEUID) ; record the UID of the image being processed
"RTN","MAGDIR81",143,0)
 ;
"RTN","MAGDIR81",144,0)
 ; lookup the study by ACNUMB/CASENUMB, get DFN, and double-check PID
"RTN","MAGDIR81",145,0)
 S ERRCODE=$$LOOKUP Q:ERRCODE ERRCODE
"RTN","MAGDIR81",146,0)
 ;
"RTN","MAGDIR81",147,0)
 S PIDCHECK=$$PIDCHECK^MAGDIR8A()
"RTN","MAGDIR81",148,0)
 I PIDCHECK D  Q "-2 Image Association Problem" ; didn't find the study
"RTN","MAGDIR81",149,0)
 . N CASETEXT,COLUMNS,MFGR,MODEL,MODIEN,OFFSET,ROWS
"RTN","MAGDIR81",150,0)
 . ; formulate error message
"RTN","MAGDIR81",151,0)
 . K MSG
"RTN","MAGDIR81",152,0)
 . S MSG(1)=PIDCHECK
"RTN","MAGDIR81",153,0)
 . S (ROWS,COLUMNS,OFFSET,MODIEN,MFGR,MODEL,CASETEXT)=""
"RTN","MAGDIR81",154,0)
 . I 'IMPORTER D
"RTN","MAGDIR81",155,0)
 . . D MOVE^MAGDLBAA
"RTN","MAGDIR81",156,0)
 . . Q
"RTN","MAGDIR81",157,0)
 . E  D
"RTN","MAGDIR81",158,0)
 . . D STORE^MAGDIR8R ; record miss-matched image
"RTN","MAGDIR81",159,0)
 . . Q
"RTN","MAGDIR81",160,0)
 . Q
"RTN","MAGDIR81",161,0)
 ; create the group pointer
"RTN","MAGDIR81",162,0)
 I IMGSVC="RAD" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",163,0)
 . S ERRCODE=$$GROUP^MAGDIR9A
"RTN","MAGDIR81",164,0)
 . Q
"RTN","MAGDIR81",165,0)
 E  I IMGSVC="CON" D  Q:ERRCODE ERRCODE
"RTN","MAGDIR81",166,0)
 . S ERRCODE=$$GROUP^MAGDIR9E
"RTN","MAGDIR81",167,0)
 . Q
"RTN","MAGDIR81",168,0)
 E  D  Q 3  ; undefined imaging service - same as error #4 in LOOKUP
"RTN","MAGDIR81",169,0)
 . K MSG
"RTN","MAGDIR81",170,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",171,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",172,0)
 . Q
"RTN","MAGDIR81",173,0)
 ; delete import reconciliation entry
"RTN","MAGDIR81",174,0)
 I IMPORTER,$L(OLDPATH) Q $$DELETE^MAGDIR8R(IMAGEUID,MACHID,OLDPATH)
"RTN","MAGDIR81",175,0)
 Q 0
"RTN","MAGDIR81",176,0)
 ;
"RTN","MAGDIR81",177,0)
SAVEUID(MACHID,UID) ; record the UID of the image being processed
"RTN","MAGDIR81",178,0)
 N D0,X
"RTN","MAGDIR81",179,0)
 S D0=$O(^MAGD(2006.5715,"B",MACHID,"")) D:'D0
"RTN","MAGDIR81",180,0)
 . L +^MAGD(2006.5715):1E9 ; Background process MUST wait
"RTN","MAGDIR81",181,0)
 . S D0=$O(^MAGD(2006.5715," "),-1)+1
"RTN","MAGDIR81",182,0)
 . S X=$G(^MAGD(2006.5715,0))
"RTN","MAGDIR81",183,0)
 . S $P(X,"^",1,2)="CURRENT IMAGE^2006.5715"
"RTN","MAGDIR81",184,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDIR81",185,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1
"RTN","MAGDIR81",186,0)
 . S ^MAGD(2006.5715,0)=X
"RTN","MAGDIR81",187,0)
 . S ^MAGD(2006.5715,D0,0)=MACHID
"RTN","MAGDIR81",188,0)
 . S ^MAGD(2006.5715,"B",MACHID,D0)=""
"RTN","MAGDIR81",189,0)
 . L -^MAGD(2006.5715)
"RTN","MAGDIR81",190,0)
 . Q
"RTN","MAGDIR81",191,0)
 S $P(^MAGD(2006.5715,D0,0),"^",2)=UID
"RTN","MAGDIR81",192,0)
 Q
"RTN","MAGDIR81",193,0)
 ;
"RTN","MAGDIR81",194,0)
GETUID(MACHID) ; lookup the UID of the last image processed
"RTN","MAGDIR81",195,0)
 N D0
"RTN","MAGDIR81",196,0)
 S D0=+$O(^MAGD(2006.5715,"B",MACHID,""))
"RTN","MAGDIR81",197,0)
 Q $P($G(^MAGD(2006.5715,D0,0)),"^",2)
"RTN","MAGDIR81",198,0)
 ;
"RTN","MAGDIR81",199,0)
MULTFRAM ; Handle additional images in a multiframe object
"RTN","MAGDIR81",200,0)
 ; Get the information from the first image for the additional ones
"RTN","MAGDIR81",201,0)
 ;
"RTN","MAGDIR81",202,0)
 N DIQUIET,INAME,MAG0,MAG40,MAG100,MAGPACS
"RTN","MAGDIR81",203,0)
 N SOPCLASP ; pointer to SOP Class file (#2006.532)
"RTN","MAGDIR81",204,0)
 S MAG0=^MAG(2005,MAGIEN,0),MAG1=$G(^(1)),MAG2=$G(^(2))
"RTN","MAGDIR81",205,0)
 S MAG40=$G(^MAG(2005,MAGIEN,40)),MAG100=$G(^(100))
"RTN","MAGDIR81",206,0)
 S MAGPACS=$G(^MAG(2005,MAGIEN,"PACS"))
"RTN","MAGDIR81",207,0)
 S INAME=$P(MAG0,"^",1) ; field .01
"RTN","MAGDIR81",208,0)
 S PNAMEVAH=$P(INAME,"  ",1),DCMPID=$P(INAME,"  ",2)
"RTN","MAGDIR81",209,0)
 S DFN=$P(MAG0,"^",7) ; field 5
"RTN","MAGDIR81",210,0)
 S MAGGP=$P(MAG0,"^",10) ; field 14
"RTN","MAGDIR81",211,0)
 S DATETIME=$P(MAG2,"^",5) ; field 15
"RTN","MAGDIR81",212,0)
 S FILEDATA("MODALITY")=MODALITY
"RTN","MAGDIR81",213,0)
 S FILEDATA("PARENT FILE")=$P(MAG2,"^",6) ; field 16
"RTN","MAGDIR81",214,0)
 S FILEDATA("PARENT IEN")=$P(MAG2,"^",7) ; field 17
"RTN","MAGDIR81",215,0)
 S FILEDATA("PARENT FILE PTR")=$P(MAG2,"^",8) ; field 18
"RTN","MAGDIR81",216,0)
 S FILEDATA("RAD REPORT")=$P(MAGPACS,"^",2) ; field 61
"RTN","MAGDIR81",217,0)
 S FILEDATA("RAD PROC PTR")=$P(MAGPACS,"^",3) ; field 62
"RTN","MAGDIR81",218,0)
 S FILEDATA("PACKAGE")=$P(MAG40,"^",1) ; field 40
"RTN","MAGDIR81",219,0)
 ; field 41 is not needed
"RTN","MAGDIR81",220,0)
 S FILEDATA("TYPE")=$P(MAG40,"^",3) ; field 42
"RTN","MAGDIR81",221,0)
 S FILEDATA("PROC/EVENT")=$P(MAG40,"^",4) ; field 43
"RTN","MAGDIR81",222,0)
 S FILEDATA("SPEC/SUBSPEC")=$P(MAG40,"^",5) ; field 44
"RTN","MAGDIR81",223,0)
 S FILEDATA("ACQUISITION DEVICE")=$P(MAG100,"^",4) ; field 107
"RTN","MAGDIR81",224,0)
 ; get the SOP Class pointer (file 2005, field 251)
"RTN","MAGDIR81",225,0)
 S SOPCLASP=$O(^MAG(2006.532,"B",SOPCLASS,""))
"RTN","MAGDIR81",226,0)
 S FILEDATA("SOP CLASS POINTER")=SOPCLASP
"RTN","MAGDIR81",227,0)
 S PROCDESC=$P(MAG2,"^",4) ; field 10
"RTN","MAGDIR81",228,0)
 ; S X="" F  S X=$O(FILEDATA(X)) Q:X=""  I FILEDATA(X)="" K FILEDATA(X)
"RTN","MAGDIR81",229,0)
 I PROCDESC?.E1" (#".N1")" S PROCDESC=$P(PROCDESC," (#")
"RTN","MAGDIR81",230,0)
 ; lookup patient in VistA database - needed to build VADM array
"RTN","MAGDIR81",231,0)
 S DIQUIET=1 D DEM^VADPT
"RTN","MAGDIR81",232,0)
 Q
"RTN","MAGDIR81",233,0)
 ;
"RTN","MAGDIR81",234,0)
LOOKUP() ; lookup the patient/study using cross-reference
"RTN","MAGDIR81",235,0)
 I IMGSVC="RAD" D
"RTN","MAGDIR81",236,0)
 . D RADLKUP^MAGDIR8A
"RTN","MAGDIR81",237,0)
 . Q
"RTN","MAGDIR81",238,0)
 E  I IMGSVC="CON" D
"RTN","MAGDIR81",239,0)
 . S ACNUMB=CASENUMB
"RTN","MAGDIR81",240,0)
 . D CONLKUP^MAGDIR8A
"RTN","MAGDIR81",241,0)
 . Q
"RTN","MAGDIR81",242,0)
 E  D  Q 4 ; undefined imaging service - same as error #3 in NEWIMAGE
"RTN","MAGDIR81",243,0)
 . K MSG
"RTN","MAGDIR81",244,0)
 . S MSG(1)="Undefined Imaging Service: "_IMGSVC
"RTN","MAGDIR81",245,0)
 . D ERROR^MAGDIRVE($T(+0),"DICOM IMAGE PROCESSING ERROR",.MSG)
"RTN","MAGDIR81",246,0)
 . Q
"RTN","MAGDIR81",247,0)
 Q 0
"RTN","MAGDIR8A")
0^7^B36721014
"RTN","MAGDIR8A",1,0)
MAGDIR8A ;WOIFO/PMK/JSL/SAF - Read a DICOM image file ; 03/08/2005  07:02
"RTN","MAGDIR8A",2,0)
 ;;3.0;IMAGING;**11,51,49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDIR8A",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDIR8A",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8A",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDIR8A",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDIR8A",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDIR8A",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDIR8A",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDIR8A",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDIR8A",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDIR8A",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDIR8A",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDIR8A",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDIR8A",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDIR8A",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDIR8A",17,0)
 ;;
"RTN","MAGDIR8A",18,0)
 ;
"RTN","MAGDIR8A",19,0)
 ; M2MB server
"RTN","MAGDIR8A",20,0)
 ;
"RTN","MAGDIR8A",21,0)
 ; Lookup the patient/study in the imaging service's database
"RTN","MAGDIR8A",22,0)
 ; Different entry points are invoked from LOOKUP^MAGDIR81
"RTN","MAGDIR8A",23,0)
 ;
"RTN","MAGDIR8A",24,0)
RADLKUP ; Radiology patient/study lookup -- called by ^MAGDIR81
"RTN","MAGDIR8A",25,0)
 ; (also invoked by ^MAGDEXC4, ^MAGDFND4 and ^MAGDIW1)
"RTN","MAGDIR8A",26,0)
 ;
"RTN","MAGDIR8A",27,0)
 ; returns RADATA array DFN, DATETIME, and PROCDESC
"RTN","MAGDIR8A",28,0)
 ;
"RTN","MAGDIR8A",29,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDIR8A",30,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDIR8A",31,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDIR8A",32,0)
 N PROCIEN ;-- radiology procedure ien in ^RAMIS(71)
"RTN","MAGDIR8A",33,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDIR8A",34,0)
 N RADPT1 ;--- first level subscript in ^RADPT
"RTN","MAGDIR8A",35,0)
 N RADPT2 ;--- second level subscript in ^RADPT (after "DT")
"RTN","MAGDIR8A",36,0)
 N RADPT3 ;--- third level subscript in ^RADPT (after "P")
"RTN","MAGDIR8A",37,0)
 N I,LIST,VARIABLE,X,Z
"RTN","MAGDIR8A",38,0)
 ;
"RTN","MAGDIR8A",39,0)
 ; find the patient/study in ^RARPT using the Radiology Case Number
"RTN","MAGDIR8A",40,0)
 K RADATA ; kill returned array of Radiology Package data
"RTN","MAGDIR8A",41,0)
 D RADLKUP1
"RTN","MAGDIR8A",42,0)
 S LIST="RADPT1^RADPT2^RADPT3^PROCIEN^CPTCODE^CPTNAME^Z^EXAMSTS"
"RTN","MAGDIR8A",43,0)
 F I=1:1:$L(LIST,"^") D
"RTN","MAGDIR8A",44,0)
 . S VARIABLE=$P(LIST,"^",I)
"RTN","MAGDIR8A",45,0)
 . S RADATA(VARIABLE)=$G(@VARIABLE)
"RTN","MAGDIR8A",46,0)
 . Q
"RTN","MAGDIR8A",47,0)
 Q
"RTN","MAGDIR8A",48,0)
 ;
"RTN","MAGDIR8A",49,0)
RADLKUP1 ; not an entry point
"RTN","MAGDIR8A",50,0)
 N LIST
"RTN","MAGDIR8A",51,0)
 Q:CASENUMB=""    ;LB 12/16/98
"RTN","MAGDIR8A",52,0)
 S X=$$ACCFIND^RAAPI(CASENUMB,.LIST)
"RTN","MAGDIR8A",53,0)
 Q:X'=1  S X=LIST(1) ; two conditions, no accession number & duplicate
"RTN","MAGDIR8A",54,0)
 S RADPT1=$P(X,"^",1),RADPT2=$P(X,"^",2),RADPT3=$P(X,"^",3)
"RTN","MAGDIR8A",55,0)
 I '$D(^RADPT(RADPT1,0)) Q  ; no patient demographics file pointer
"RTN","MAGDIR8A",56,0)
 ; get patient demographics file pointer
"RTN","MAGDIR8A",57,0)
 S X=^RADPT(RADPT1,0),DFN=$P(X,"^")
"RTN","MAGDIR8A",58,0)
 I '$D(^RADPT(RADPT1,"DT",RADPT2,0)) Q  ; no datetime level
"RTN","MAGDIR8A",59,0)
 ; get date and time of examination
"RTN","MAGDIR8A",60,0)
 S DATETIME=$P($G(^RADPT(RADPT1,"DT",RADPT2,0)),"^",1)
"RTN","MAGDIR8A",61,0)
 ; get case info
"RTN","MAGDIR8A",62,0)
 S X=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDIR8A",63,0)
 S PROCIEN=$P(X,"^",2),EXAMSTS=$P(X,"^",3)
"RTN","MAGDIR8A",64,0)
 I EXAMSTS S EXAMSTS=$$GET1^DIQ(72,EXAMSTS,.01)
"RTN","MAGDIR8A",65,0)
 S (PROCDESC,CPTNAME,CPTCODE)=""
"RTN","MAGDIR8A",66,0)
 I 'PROCIEN Q  ; need PROCIEN to do lookup in ^RAMIS
"RTN","MAGDIR8A",67,0)
 S Z=$G(^RAMIS(71,PROCIEN,0))
"RTN","MAGDIR8A",68,0)
 S PROCDESC=$P(Z,"^"),CPTCODE=$P(Z,"^",9)
"RTN","MAGDIR8A",69,0)
 S CPTNAME=PROCDESC ; approximate value since ^ICPT is not translated
"RTN","MAGDIR8A",70,0)
 Q
"RTN","MAGDIR8A",71,0)
 ;
"RTN","MAGDIR8A",72,0)
CONLKUP ; CPRS Consult/Procedure patient/study lookup -- called by ^MAGDIR81
"RTN","MAGDIR8A",73,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDIR8A",74,0)
 N CONPROC,Z
"RTN","MAGDIR8A",75,0)
 I ACNUMB'?1"GMRC-".1N.N Q
"RTN","MAGDIR8A",76,0)
 S GMRCIEN=$P(ACNUMB,"-",2)
"RTN","MAGDIR8A",77,0)
 S DFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDIR8A",78,0)
 I DFN="" Q  ; no patient demographics file pointer
"RTN","MAGDIR8A",79,0)
 S EXAMSTS=$$GET1^DIQ(123,GMRCIEN,8) ; check for cancelled exam
"RTN","MAGDIR8A",80,0)
 I EXAMSTS="CANCELLED" S RADATA("EXAMSTS")=EXAMSTS Q
"RTN","MAGDIR8A",81,0)
 S PROCDESC=$$GET1^DIQ(123,GMRCIEN,1)
"RTN","MAGDIR8A",82,0)
 S Z=$$GET1^DIQ(123,GMRCIEN,13,"I") ; request type
"RTN","MAGDIR8A",83,0)
 S CONPROC=$S(Z="C":"CONSULT",Z="P":"PROCEDURE",1:"UNKNOWN")
"RTN","MAGDIR8A",84,0)
 Q
"RTN","MAGDIR8A",85,0)
 ;
"RTN","MAGDIR8A",86,0)
PIDCHECK() ; compare VistA patient ID with DICOM patient ID
"RTN","MAGDIR8A",87,0)
 N CHECK ;---- patient demographic comparison check value
"RTN","MAGDIR8A",88,0)
 N FIRSTVAH ;- patient first name from VADM(1)
"RTN","MAGDIR8A",89,0)
 N IDDCM ;---- patient id, w/o punctuation, from image header
"RTN","MAGDIR8A",90,0)
 N IDVAH ;---- patient id from VADM(2)
"RTN","MAGDIR8A",91,0)
 N LASTVAH ;-- patient last name from VADM(1)
"RTN","MAGDIR8A",92,0)
 N MIVAH ;---- patient middle initial from VADM(1)
"RTN","MAGDIR8A",93,0)
 N DIQUIET,I,VA,VAERR,X,Y
"RTN","MAGDIR8A",94,0)
 ;
"RTN","MAGDIR8A",95,0)
 S X=PNAMEDCM X ^%ZOSF("UPPERCASE") S PNAMEDCM=Y
"RTN","MAGDIR8A",96,0)
 ; parse the DICOM patient name (2 formats)
"RTN","MAGDIR8A",97,0)
 I PNAMEDCM["^" D  ; DICOM format patient name
"RTN","MAGDIR8A",98,0)
 . S LASTDCM=$P(PNAMEDCM,"^"),FIRSTDCM=$P(PNAMEDCM,"^",2)
"RTN","MAGDIR8A",99,0)
 . S MIDCM=$P(PNAMEDCM,"^",3)
"RTN","MAGDIR8A",100,0)
 . Q
"RTN","MAGDIR8A",101,0)
 E  I PNAMEDCM["," D  ; ACR-NEMA format patient name
"RTN","MAGDIR8A",102,0)
 . F  Q:'$F(PNAMEDCM,", ")  D  ; remove blanks after last name comma
"RTN","MAGDIR8A",103,0)
 . . S PNAMEDCM=$P(PNAMEDCM,", ")_","_$P(PNAMEDCM,", ",2,999)
"RTN","MAGDIR8A",104,0)
 . . Q
"RTN","MAGDIR8A",105,0)
 . S LASTDCM=$P(PNAMEDCM,","),FIRSTDCM=$P(PNAMEDCM,",",2)
"RTN","MAGDIR8A",106,0)
 . S MIDCM=$S(PNAMEDCM[",":$P(FIRSTDCM,",",2),1:$P(FIRSTDCM," ",2,999))
"RTN","MAGDIR8A",107,0)
 . Q
"RTN","MAGDIR8A",108,0)
 E  D  ; patient name in "last first mi" order with space delimiters
"RTN","MAGDIR8A",109,0)
 . S LASTDCM=$P(PNAMEDCM," "),FIRSTDCM=$P(PNAMEDCM," ",2)
"RTN","MAGDIR8A",110,0)
 . S MIDCM=$P(PNAMEDCM," ",3)
"RTN","MAGDIR8A",111,0)
 . Q
"RTN","MAGDIR8A",112,0)
 S FIRSTDCM=$S(FIRSTDCM[",":$P(FIRSTDCM,","),1:$P(FIRSTDCM," "))
"RTN","MAGDIR8A",113,0)
 ; only check the first part of the name
"RTN","MAGDIR8A",114,0)
 ; remove dashes and atypical punctuation from the DICOM PID
"RTN","MAGDIR8A",115,0)
 S IDDCM="" F I=1:1:$L(PID) I $E(PID,I)?1AN S IDDCM=IDDCM_$E(PID,I)
"RTN","MAGDIR8A",116,0)
 ;
"RTN","MAGDIR8A",117,0)
 I CASENUMB="" Q "-1,NO CASE #"
"RTN","MAGDIR8A",118,0)
 I '$G(DFN) Q "-2,BAD CASE #"
"RTN","MAGDIR8A",119,0)
 I $G(RADATA("EXAMSTS"))="CANCELLED" Q "-3,CANCELLED"
"RTN","MAGDIR8A",120,0)
 ;
"RTN","MAGDIR8A",121,0)
 ; lookup patient in VistA database
"RTN","MAGDIR8A",122,0)
 S DIQUIET=1 D DEM^MAGSPID($G(INSTLOC)) ; P123
"RTN","MAGDIR8A",123,0)
 S PNAMEVAH=VADM(1)
"RTN","MAGDIR8A",124,0)
 S LASTVAH=$P(PNAMEVAH,","),FIRSTVAH=$P(PNAMEVAH,",",2)
"RTN","MAGDIR8A",125,0)
 S MIVAH=$TR($P(FIRSTVAH," ",2,999),"."),FIRSTVAH=$P(FIRSTVAH," ")
"RTN","MAGDIR8A",126,0)
 I $$ISIHS^MAGSPID() S (IDVAH,DCMPID)=VA("PID")  ; P123 proper VA/IHS PID
"RTN","MAGDIR8A",127,0)
 E  S IDVAH=$P(VADM(2),"^"),DCMPID=$P(VADM(2),"^",2)
"RTN","MAGDIR8A",128,0)
 ;
"RTN","MAGDIR8A",129,0)
 ; compare the values - allow a single transposition in the patient name,
"RTN","MAGDIR8A",130,0)
 ; but require exact patient id values (i.e., social security numbers)
"RTN","MAGDIR8A",131,0)
 S CHECK=(5*$$COMPARE(LASTDCM,LASTVAH))
"RTN","MAGDIR8A",132,0)
 S CHECK=CHECK+(5*$$COMPARE($E(FIRSTDCM,1,6),$E(FIRSTVAH,1,6)))
"RTN","MAGDIR8A",133,0)
 S CHECK=CHECK+(1*$$COMPARE(MIDCM,MIVAH))
"RTN","MAGDIR8A",134,0)
 S CHECK=CHECK+(5*(IDDCM=IDVAH)) ; patient id requires an exact match
"RTN","MAGDIR8A",135,0)
 I CHECK<14.5 Q "-4,PID ERROR" ; require an "almost exact" match
"RTN","MAGDIR8A",136,0)
 Q 0  ; correct patient
"RTN","MAGDIR8A",137,0)
 ;
"RTN","MAGDIR8A",138,0)
COMPARE(A,B) ; pattern match checker
"RTN","MAGDIR8A",139,0)
 Q:A=B 1 ; exact match
"RTN","MAGDIR8A",140,0)
 Q:A="" 0 Q:B="" 0 ; don't count missing data
"RTN","MAGDIR8A",141,0)
 ; calculate fractional value for pattern match
"RTN","MAGDIR8A",142,0)
 N I,LENGTH,MATCH
"RTN","MAGDIR8A",143,0)
 S MATCH=0,LENGTH=$S($L(B)>$L(A):$L(B),1:$L(A))
"RTN","MAGDIR8A",144,0)
 F I=1:1:LENGTH D
"RTN","MAGDIR8A",145,0)
 . I $E(A,I)=$E(B,I) S MATCH=MATCH+1
"RTN","MAGDIR8A",146,0)
 . E  I $E(A,I)=$E(B,I-1) S MATCH=MATCH+.25
"RTN","MAGDIR8A",147,0)
 . E  I $E(A,I)=$E(B,I+1) S MATCH=MATCH+.25
"RTN","MAGDIR8A",148,0)
 . E  I $E(A,I-1)=$E(B,I) S MATCH=MATCH+.25
"RTN","MAGDIR8A",149,0)
 . E  I $E(A,I+1)=$E(B,I) S MATCH=MATCH+.25
"RTN","MAGDIR8A",150,0)
 . Q
"RTN","MAGDIR8A",151,0)
 Q MATCH/LENGTH ; return fractional pattern match value
"RTN","MAGDLB1")
0^8^B55699904
"RTN","MAGDLB1",1,0)
MAGDLB1 ;WOIFO/LB/JSL/SAF - Routine to fix failed DICOM entries ; 05/18/2007 11:23
"RTN","MAGDLB1",2,0)
 ;;3.0;IMAGING;**11,30,54,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDLB1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDLB1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB1",17,0)
 ;;
"RTN","MAGDLB1",18,0)
 Q
"RTN","MAGDLB1",19,0)
 ;
"RTN","MAGDLB1",20,0)
DISPLAY ;
"RTN","MAGDLB1",21,0)
 S OUT=0
"RTN","MAGDLB1",22,0)
 W !,"**************Processing entry**********"
"RTN","MAGDLB1",23,0)
 W !!?2,"PATIENT: ",PAT,?50,$$PIDLABEL^MAGSPID(),": ",PID,!,"RADIOLOGY CASE #: ",CASENO  ;;P123
"RTN","MAGDLB1",24,0)
 W !?2,"Equipment: ",MOD,?50,"Model: ",MODEL
"RTN","MAGDLB1",25,0)
 W !?2,"Date Processed: ",DATE,?50,"Problem with: ",REASON
"RTN","MAGDLB1",26,0)
 W !?2,"Comment: ",COMNT1
"RTN","MAGDLB1",27,0)
 W !?2,"Correcting file on Image gateway server ID: ",MACHID,!?5,FILE
"RTN","MAGDLB1",28,0)
 S MSG="Do you want to Correct this entry? "
"RTN","MAGDLB1",29,0)
 Q
"RTN","MAGDLB1",30,0)
 ;
"RTN","MAGDLB1",31,0)
NEWCASE ;
"RTN","MAGDLB1",32,0)
 S NEWDFN=$P(MAGDY,"^"),NEWNME=$P(MAGDY,"^",2),NEWPID=$P(MAGDY,"^",3)
"RTN","MAGDLB1",33,0)
 S NEWCAS=$P(MAGDY,"^",4),NEWPROC=$P(MAGDY,"^",5),NEWDTI=$P(MAGDY,"^",6)
"RTN","MAGDLB1",34,0)
 S NEWMUL=$P(MAGDY,"^",7),NEWPIEN=$P(MAGDY,"^",8),PP=$P(MAGDY,"^",9)
"RTN","MAGDLB1",35,0)
 Q
"RTN","MAGDLB1",36,0)
 ;
"RTN","MAGDLB1",37,0)
ASK() ;
"RTN","MAGDLB1",38,0)
 N ANS,ASK
"RTN","MAGDLB1",39,0)
 ;
"RTN","MAGDLB1",40,0)
ASK1 S ASK="Y/N/D/Q"
"RTN","MAGDLB1",41,0)
 I $G(PREV)'=$G(MAGIEN),MAGTYPE="RAD" S ASK=ASK_"/P"
"RTN","MAGDLB1",42,0)
 W !,$G(MSG),"("_ASK_")// " R ANS:600
"RTN","MAGDLB1",43,0)
 I '$T!(ANS["^") Q "^"
"RTN","MAGDLB1",44,0)
 I ANS="" Q "N"
"RTN","MAGDLB1",45,0)
 I "YNDPQyndpq"'[$E(ANS) D  G ASK1
"RTN","MAGDLB1",46,0)
 . W !,"Please respond with one of the following codes."
"RTN","MAGDLB1",47,0)
 . W !,"Legend: Y=yes, N=no, D=delete, P=Previous entry, and Q=quit",!
"RTN","MAGDLB1",48,0)
 S ANS=$TR(ANS,"yndpq","YNDPQ")
"RTN","MAGDLB1",49,0)
 Q $E(ANS)
"RTN","MAGDLB1",50,0)
 ;
"RTN","MAGDLB1",51,0)
CHK ;remove any punctuation before doing comparison on SSN
"RTN","MAGDLB1",52,0)
 ;stop on 1st check.
"RTN","MAGDLB1",53,0)
 N OLD,I
"RTN","MAGDLB1",54,0)
 S OLD="" F I=1:1:$L(PID) I $E(PID,I)?1AN S OLD=OLD_$E(PID,I)
"RTN","MAGDLB1",55,0)
 I NEWPID'=OLD D  Q
"RTN","MAGDLB1",56,0)
 . I $$ISIHS^MAGSPID() S MSG="Patient ID numbers do not match. Update? " Q  ;P123
"RTN","MAGDLB1",57,0)
 . S MSG="Social Security numbers do not match. Update? "
"RTN","MAGDLB1",58,0)
 I NEWNME'=PAT D  Q
"RTN","MAGDLB1",59,0)
 . S MSG="Patient names do not match. Update? "
"RTN","MAGDLB1",60,0)
 ;Finally the problem is with the case number...either no longer in "C"
"RTN","MAGDLB1",61,0)
 ;xref or invalid number provided
"RTN","MAGDLB1",62,0)
 S MSG="Radiology case number different. Update? "
"RTN","MAGDLB1",63,0)
 Q
"RTN","MAGDLB1",64,0)
 ;
"RTN","MAGDLB1",65,0)
NEWDIS ;
"RTN","MAGDLB1",66,0)
 W !?2,"****Please review the following: *****"
"RTN","MAGDLB1",67,0)
 W !?2,"Previous name: ",PAT,!?2,"     New name: ",NEWNME
"RTN","MAGDLB1",68,0)
 W !?2,"Previous ",$$PIDLABEL^MAGSPID(),": ",PID,!?2,"     New ",$$PIDLABEL^MAGSPID(),": ",NEWPID  ;P123
"RTN","MAGDLB1",69,0)
 W !?2,"Previous case #: ",CASENO,!?2,"     New case #: ",NEWCAS
"RTN","MAGDLB1",70,0)
 I $L($G(PP)) W !?15,"Case number selected: ",PP
"RTN","MAGDLB1",71,0)
 ; Variable PP already has text message about being part of printset.
"RTN","MAGDLB1",72,0)
 Q
"RTN","MAGDLB1",73,0)
 ;
"RTN","MAGDLB1",74,0)
UPDT ;
"RTN","MAGDLB1",75,0)
 N GWLOC ; -- gateway location
"RTN","MAGDLB1",76,0)
 N % ; ------ utility variable for FM calls
"RTN","MAGDLB1",77,0)
 W !,"Will change the following: " D NEWDIS
"RTN","MAGDLB1",78,0)
 W !,"Are you sure you want to correct this entry? " S %=2 D YN^DICN
"RTN","MAGDLB1",79,0)
 I %=-1!(%=2) S OUT=1 Q
"RTN","MAGDLB1",80,0)
 W !,"Updating the file."
"RTN","MAGDLB1",81,0)
 S NEWDTIM=$TR(NEWDTI,"0123456789","9876543210")
"RTN","MAGDLB1",82,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")="1^"_NEWDFN_"^"_NEWNME_"^"_NEWPID_"^"_NEWCAS_"^"_NEWDTI_"^"_NEWMUL_"^"_NEWDTIM W "."
"RTN","MAGDLB1",83,0)
 S ^MAGD(2006.575,MAGIEN,"FIXPR")=NEWPIEN_"^"_NEWPROC W "."
"RTN","MAGDLB1",84,0)
 ;Same as ^radpt(newdfn,"DT",newdti,"P",newmul,0) & ^RAMIS(71,newpien,0)
"RTN","MAGDLB1",85,0)
 S MACHID=$S(MACHID="":"A",1:MACHID) ; server ID
"RTN","MAGDLB1",86,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDLB1",87,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="" W "."
"RTN","MAGDLB1",88,0)
 E  W !,"Gateway place not defined on image entry "_MAGIEN_", continuing.."
"RTN","MAGDLB1",89,0)
 ;Xref to loop & process entries; processing will be minimal.
"RTN","MAGDLB1",90,0)
 S MAGFIX(MAGIEN)="F"
"RTN","MAGDLB1",91,0)
 Q
"RTN","MAGDLB1",92,0)
 ;
"RTN","MAGDLB1",93,0)
SETDEL ;Entry to be deleted
"RTN","MAGDLB1",94,0)
 N GWLOC ; -- gateway location
"RTN","MAGDLB1",95,0)
 D LOGERR I ANS="^" S OUT=1 Q
"RTN","MAGDLB1",96,0)
 S GWLOC=$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)
"RTN","MAGDLB1",97,0)
 I GWLOC S ^MAGD(2006.575,"AFX",GWLOC,MACHID,MAGIEN)="D" W "."
"RTN","MAGDLB1",98,0)
 E  W !,"Gateway place not defined on this image entry "_MAGIEN_", continuing.."
"RTN","MAGDLB1",99,0)
 S $P(^MAGD(2006.575,MAGIEN,0),"^",6)="1"
"RTN","MAGDLB1",100,0)
 S ^MAGD(2006.575,MAGIEN,"FIXD")=1
"RTN","MAGDLB1",101,0)
 S MAGFIX(MAGIEN)="D"
"RTN","MAGDLB1",102,0)
 Q
"RTN","MAGDLB1",103,0)
 ;
"RTN","MAGDLB1",104,0)
LOGERR ;Need to record error
"RTN","MAGDLB1",105,0)
 N DIR,DIRUT,DTOUT,ENTRY,I,MAGERR,MAGOUT,NOW,WHY,WHO,X,Y
"RTN","MAGDLB1",106,0)
 W !! F I=1:1:80 W "*"
"RTN","MAGDLB1",107,0)
 W !,"*** Will log in error log (file 2006.599). ****"
"RTN","MAGDLB1",108,0)
 S NOW=$$NOW^XLFDT()
"RTN","MAGDLB1",109,0)
 S DIR(0)="F^3:30"
"RTN","MAGDLB1",110,0)
 S DIR("A")="Reason for deletion"
"RTN","MAGDLB1",111,0)
 S DIR("A",1)="Please enter a reason for deleting."
"RTN","MAGDLB1",112,0)
 S DIR("A",2)="For example: TEST PATIENT"
"RTN","MAGDLB1",113,0)
 D ^DIR
"RTN","MAGDLB1",114,0)
 I $D(DIRUT)!($D(DTOUT))!(Y="") D  S ANS="^" Q
"RTN","MAGDLB1",115,0)
 . W !,"Can not delete if a reason is not provided."
"RTN","MAGDLB1",116,0)
 . Q
"RTN","MAGDLB1",117,0)
 S WHY=Y,WHO=$G(DUZ)
"RTN","MAGDLB1",118,0)
 I WHO D 
"RTN","MAGDLB1",119,0)
 . D GETS^DIQ(200,DUZ,".01","E","MAGOUT","MAGERR")
"RTN","MAGDLB1",120,0)
 . Q:$D(MAGERR("DIERR"))
"RTN","MAGDLB1",121,0)
 . S WHO=$G(MAGOUT(200,DUZ_",",.01,"E"))
"RTN","MAGDLB1",122,0)
 I WHO="" S WHO="UNKNOWN"
"RTN","MAGDLB1",123,0)
 I '$D(^MAGD(2006.599,0)) D
"RTN","MAGDLB1",124,0)
 . S ^MAGD(2006.599,0)="Dicom Error Log^2006.599^^"
"RTN","MAGDLB1",125,0)
 . Q
"RTN","MAGDLB1",126,0)
 S ENTRY=$P(^MAGD(2006.599,0),"^",3)+1
"RTN","MAGDLB1",127,0)
 S $P(^MAGD(2006.599,0),"^",3)=ENTRY
"RTN","MAGDLB1",128,0)
 S $P(^MAGD(2006.599,0),"^",4)=$P(^MAGD(2006.599,0),"^",4)+1
"RTN","MAGDLB1",129,0)
 S ^MAGD(2006.599,ENTRY,0)=NOW_"^"_WHY_"^"_FILE_"^"_MODEL
"RTN","MAGDLB1",130,0)
 S ^MAGD(2006.599,ENTRY,1)=WHO_"^"_PAT_"^"_PID_"^"_CASENO_"^"_MACHID
"RTN","MAGDLB1",131,0)
 S ^MAGD(2006.599,"B",NOW,ENTRY)=""
"RTN","MAGDLB1",132,0)
 Q
"RTN","MAGDLB1",133,0)
 ;
"RTN","MAGDLB1",134,0)
SET ;
"RTN","MAGDLB1",135,0)
 S MAGTYPE=$P(^MAGD(2006.575,MAGIEN,"TYPE"),"^")
"RTN","MAGDLB1",136,0)
 Q:$P($G(^MAGD(2006.575,MAGIEN,"FIXD")),"^")  ; Already fixed.
"RTN","MAGDLB1",137,0)
 ; Only process Radiology images...medicine images done by other rtns.
"RTN","MAGDLB1",138,0)
 I MAGTYPE'["RAD" Q
"RTN","MAGDLB1",139,0)
 S DATA=^MAGD(2006.575,MAGIEN,0)
"RTN","MAGDLB1",140,0)
 S FILE=$P(^MAGD(2006.575,MAGIEN,0),"^")
"RTN","MAGDLB1",141,0)
 S DATA1=^MAGD(2006.575,MAGIEN,1) ; Case no. info
"RTN","MAGDLB1",142,0)
 S DATA2=$G(^MAGD(2006.575,MAGIEN,"AMFG")) ; Modality info
"RTN","MAGDLB1",143,0)
 S PAT=$P(DATA,"^",4),PID=$P(DATA,"^",3),REASON=$P(DATA,"^",2)
"RTN","MAGDLB1",144,0)
 S MOD=$P(DATA2,"^"),MODEL=$P(DATA2,"^",6)
"RTN","MAGDLB1",145,0)
 S CASENO=$P(DATA1,"^",2),MACHID=$P(DATA1,"^",4)
"RTN","MAGDLB1",146,0)
 S Y=$P(DATA1,"^",3) X ^DD("DD") S DATE=Y
"RTN","MAGDLB1",147,0)
 S COMNT1=$G(^MAGD(2006.575,MAGIEN,"ACSTXT")) ; 1st line comment.
"RTN","MAGDLB1",148,0)
 S MACHID=$P(DATA1,"^",4),GWLOC=$P(DATA2,"^",9)
"RTN","MAGDLB1",149,0)
 S ANS="" D DISPLAY S ANS=$$ASK
"RTN","MAGDLB1",150,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDLB1",151,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDLB1",152,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",153,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDLB1",154,0)
 Q:OUT
"RTN","MAGDLB1",155,0)
 K MAGDY W !," Lookup by case number or patient name"
"RTN","MAGDLB1",156,0)
 ;
"RTN","MAGDLB1",157,0)
 ; Fall Through intended
"RTN","MAGDLB1",158,0)
LOOK ;
"RTN","MAGDLB1",159,0)
 ;D ^MAGDLB2 Q:'$D(MAGDY)  Q:MAGDY'[""
"RTN","MAGDLB1",160,0)
 D EN^MAGDRA2 Q:'$D(MAGDY)  Q:MAGDY'[""
"RTN","MAGDLB1",161,0)
 D NEWCASE,CHK,NEWDIS S ANS=$$ASK
"RTN","MAGDLB1",162,0)
 I ANS="Q"!(ANS["^") S (OOUT,OUT)=1 D SETPREV Q
"RTN","MAGDLB1",163,0)
 I ANS="D" D SETDEL,SETPREV Q
"RTN","MAGDLB1",164,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",165,0)
 I ANS="N" S OUT=1 D SETPREV Q
"RTN","MAGDLB1",166,0)
 Q:OUT
"RTN","MAGDLB1",167,0)
 D UPDT
"RTN","MAGDLB1",168,0)
 I ANS="P" D CHKPREV Q
"RTN","MAGDLB1",169,0)
 D SETMAG
"RTN","MAGDLB1",170,0)
 Q
"RTN","MAGDLB1",171,0)
 ;
"RTN","MAGDLB1",172,0)
DATELOOP(START,STOP) ;Loop thru the "AD" cross reference
"RTN","MAGDLB1",173,0)
 N MAGIEN,SUID,THEDT,FIRST,OOUT,MAGFIX,MDV
"RTN","MAGDLB1",174,0)
 S KFIXALL=$$SECKEY^MAGDLB12
"RTN","MAGDLB1",175,0)
 S THEDT=START-.1,(OOUT,FIRST)=0
"RTN","MAGDLB1",176,0)
 F  S THEDT=$O(^MAGD(2006.575,"AD",THEDT)) Q:'THEDT!(THEDT>STOP)!(OOUT)  D
"RTN","MAGDLB1",177,0)
 . S MAGIEN=0
"RTN","MAGDLB1",178,0)
 . F  S MAGIEN=$O(^MAGD(2006.575,"AD",THEDT,MAGIEN)) Q:'MAGIEN  D
"RTN","MAGDLB1",179,0)
 . . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDLB1",180,0)
 . . . K ^MAGD(2006.575,"AD",THEDT,MAGIEN)
"RTN","MAGDLB1",181,0)
 . . . Q
"RTN","MAGDLB1",182,0)
 . . I $P($G(^MAGD(2006.575,MAGIEN,"TYPE")),U,1)'["RAD" Q
"RTN","MAGDLB1",183,0)
 . . ; No security key, or gateway site other than this site
"RTN","MAGDLB1",184,0)
 . . I 'KFIXALL,$P($G(^MAGD(2006.575,MAGIEN,1)),U,5)'=$G(DUZ(2)) Q
"RTN","MAGDLB1",185,0)
 . . I 'FIRST S PREV=MAGIEN,FIRST=1
"RTN","MAGDLB1",186,0)
 . . D SET
"RTN","MAGDLB1",187,0)
 . . Q
"RTN","MAGDLB1",188,0)
 . Q
"RTN","MAGDLB1",189,0)
 Q
"RTN","MAGDLB1",190,0)
 ;
"RTN","MAGDLB1",191,0)
SETPREV ;
"RTN","MAGDLB1",192,0)
 S PREV=MAGIEN,PREVS=$G(SUID)
"RTN","MAGDLB1",193,0)
 Q
"RTN","MAGDLB1",194,0)
 ;
"RTN","MAGDLB1",195,0)
SETMAG ;
"RTN","MAGDLB1",196,0)
 S FIRST=MAGIEN,FIRSTS=$G(SUID),MAGIEN=PREV,SUID=$G(PREVS)
"RTN","MAGDLB1",197,0)
 S PREV=FIRST,PREVS=FIRSTS
"RTN","MAGDLB1",198,0)
 Q
"RTN","MAGDLB1",199,0)
 ;
"RTN","MAGDLB1",200,0)
CHKPREV ;
"RTN","MAGDLB1",201,0)
 S OUT=1 N STATUS
"RTN","MAGDLB1",202,0)
 I '$D(MAGFIX(PREV)) D SETMAG G SET
"RTN","MAGDLB1",203,0)
 S STATUS=$S($G(MAGFIX(PREV))="D":"deleted",1:"corrected")
"RTN","MAGDLB1",204,0)
 W !,"Previous entry has been "_STATUS_".",$C(7)
"RTN","MAGDLB1",205,0)
 G SET
"RTN","MAGDLB1",206,0)
 Q
"RTN","MAGDLB1",207,0)
 ;
"RTN","MAGDLB1",208,0)
NAME(ENTRY) ;SITE NAME
"RTN","MAGDLB1",209,0)
 N NAME,MAGOUT,MAGERR
"RTN","MAGDLB1",210,0)
 I '$G(ENTRY) Q ""
"RTN","MAGDLB1",211,0)
 D GETS^DIQ(4,ENTRY,".01","E","MAGOUT","MAGERR")
"RTN","MAGDLB1",212,0)
 I $D(MAGERR("DIERR")) Q ""
"RTN","MAGDLB1",213,0)
 S NAME=$G(MAGOUT(4,ENTRY_",",.01,"E"))
"RTN","MAGDLB1",214,0)
 Q NAME
"RTN","MAGDLB1",215,0)
 ;
"RTN","MAGDLB12")
0^9^B22962820
"RTN","MAGDLB12",1,0)
MAGDLB12 ;WOIFO/LB,MLH/JSL/SAF - Routine to fix failed DICOM entries  ; 04/25/2005  07:46
"RTN","MAGDLB12",2,0)
 ;;3.0;IMAGING;**11,51,20,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDLB12",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDLB12",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB12",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB12",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB12",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB12",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB12",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB12",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB12",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB12",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB12",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB12",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB12",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB12",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB12",17,0)
 ;;
"RTN","MAGDLB12",18,0)
 Q
"RTN","MAGDLB12",19,0)
LOOP ;
"RTN","MAGDLB12",20,0)
 N ANS,ANSR,CASENO,COMNT1,DATA,DATA1,DATA2,DATE,FILE,FIRST,FIRSTS
"RTN","MAGDLB12",21,0)
 N MACHID,MAGDY,MAGDIEN,MAGIEN,MAGTYPE,MSG,START,STOP,SUID
"RTN","MAGDLB12",22,0)
 N MOD,MODEL,NEWCAS,NEWDFN,NEWDTI,NEWDTIM,NEWMUL,NEWNME,NEWPIEN,NEWPROC
"RTN","MAGDLB12",23,0)
 N NEWPID,OK,OOUT,OUT,PAT,PID,PP,PREV,PREVS,REASON,SITE,STUDYUID,WHY,MAGFIX
"RTN","MAGDLB12",24,0)
 N KFIXALL ; -- does user hold MAGDFIX ALL security key?
"RTN","MAGDLB12",25,0)
 ;
"RTN","MAGDLB12",26,0)
 S KFIXALL=$$SECKEY()
"RTN","MAGDLB12",27,0)
 S (OOUT,OUT,PREV,FIRST)=0
"RTN","MAGDLB12",28,0)
 ; select a site - bail if no images to correct or no site selected
"RTN","MAGDLB12",29,0)
 S STAT=$$SITE(.SITE) Q:'SITE
"RTN","MAGDLB12",30,0)
 S SUID=0
"RTN","MAGDLB12",31,0)
 F  S SUID=$O(^MAGD(2006.575,"F",SITE,SUID)) Q:SUID=""!(OOUT)  D
"RTN","MAGDLB12",32,0)
 . S MAGIEN=$O(^MAGD(2006.575,"F",SITE,SUID,0)) Q:'MAGIEN
"RTN","MAGDLB12",33,0)
 . ; if image isn't on file, clean up xrefs
"RTN","MAGDLB12",34,0)
 . I '$D(^MAGD(2006.575,MAGIEN,0)) D  Q
"RTN","MAGDLB12",35,0)
 . . K ^MAGD(2006.575,"F",SITE,SUID,MAGIEN)
"RTN","MAGDLB12",36,0)
 . . Q
"RTN","MAGDLB12",37,0)
 . ; if gateway site isn't the user's site, bail unless the user holds
"RTN","MAGDLB12",38,0)
 . ; the MAGDFIX ALL security key
"RTN","MAGDLB12",39,0)
 . I $P($G(^MAGD(2006.575,MAGIEN,1)),U,5)'=DUZ(2),'KFIXALL Q
"RTN","MAGDLB12",40,0)
 . ;Only process Radiology images...medicine images done by other rtns.
"RTN","MAGDLB12",41,0)
 . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),"^") I MAGTYPE'["RAD" Q
"RTN","MAGDLB12",42,0)
 . I $D(^MAGD(2006.575,MAGIEN,"FIXD")),$P(^MAGD(2006.575,MAGIEN,"FIXD"),"^") Q
"RTN","MAGDLB12",43,0)
 . I 'FIRST S PREV=MAGIEN,PREVS=SUID,FIRST=MAGIEN
"RTN","MAGDLB12",44,0)
 . D SET^MAGDLB1
"RTN","MAGDLB12",45,0)
 . Q
"RTN","MAGDLB12",46,0)
 Q
"RTN","MAGDLB12",47,0)
SITE(XSITE) ; select a site for which to process entries
"RTN","MAGDLB12",48,0)
 ; input:        none
"RTN","MAGDLB12",49,0)
 ; output:   .XSITE   site number for which to process entries
"RTN","MAGDLB12",50,0)
 ; 
"RTN","MAGDLB12",51,0)
 ; return:   0 always
"RTN","MAGDLB12",52,0)
 ; 
"RTN","MAGDLB12",53,0)
 N CNT,KFIXALL,RESULT,SITES
"RTN","MAGDLB12",54,0)
 S (CNT,XSITE)=0 F  S XSITE=$O(^MAGD(2006.575,"F",XSITE)) Q:'XSITE  D
"RTN","MAGDLB12",55,0)
 . Q:'$$FIND1^DIC(4,"","","`"_XSITE)
"RTN","MAGDLB12",56,0)
 . S CNT=CNT+1,SITES(CNT)=XSITE
"RTN","MAGDLB12",57,0)
 . Q
"RTN","MAGDLB12",58,0)
 Q:'CNT 0
"RTN","MAGDLB12",59,0)
 ;
"RTN","MAGDLB12",60,0)
 S KFIXALL=$$SECKEY I '$$MDIV S KFIXALL=1
"RTN","MAGDLB12",61,0)
 ; If not multi-division set the KFIXALL - site should be able to correct any entry
"RTN","MAGDLB12",62,0)
 I KFIXALL D FIX(.SITES,CNT) Q 0
"RTN","MAGDLB12",63,0)
 I $D(DUZ(2)) D  Q 0
"RTN","MAGDLB12",64,0)
 . S XSITE=DUZ(2)
"RTN","MAGDLB12",65,0)
 . I '$D(^MAGD(2006.575,"F",XSITE)) W !,"No entries for division "_$$GET1^DIQ(4,+XSITE,".01","E")
"RTN","MAGDLB12",66,0)
 . Q
"RTN","MAGDLB12",67,0)
 D LKUSR(.RESULT,DUZ)
"RTN","MAGDLB12",68,0)
 I '$D(RESULT(0)) Q 0
"RTN","MAGDLB12",69,0)
 I $P(RESULT(0),"^")=0 W !,$P(RESULT,"^",2) Q 0
"RTN","MAGDLB12",70,0)
 ;
"RTN","MAGDLB12",71,0)
 N EN,II,NSITE,MAGSITE,X
"RTN","MAGDLB12",72,0)
 S (CNT,XSITE)=0
"RTN","MAGDLB12",73,0)
 S X=0 F  S X=$O(SITES(X)) Q:'X  S II=$G(SITES(X)) I II S NSITE(II)=""
"RTN","MAGDLB12",74,0)
 S II=0
"RTN","MAGDLB12",75,0)
 F  S II=$O(RESULT(II)) Q:'II  S EN=$G(RESULT(II)) I $D(NSITE(EN)) S CNT=CNT+1,MAGSITE(CNT)=EN
"RTN","MAGDLB12",76,0)
 I 'CNT Q 0 ;no matches
"RTN","MAGDLB12",77,0)
 I CNT=1 S XSITE=$G(MAGSITE(1)) Q 0
"RTN","MAGDLB12",78,0)
 D FIX(.MAGSITE,CNT) ; select a SITE to fix
"RTN","MAGDLB12",79,0)
 Q 0
"RTN","MAGDLB12",80,0)
 ;
"RTN","MAGDLB12",81,0)
FIX(SITES,CNT) ;SUBROUTINE - Prepare to fix the entries for the user's division entries.        
"RTN","MAGDLB12",82,0)
 ; Multiple divisions have images to be corrected and user has appropriate security key.
"RTN","MAGDLB12",83,0)
 N DIR,I,Y,X
"RTN","MAGDLB12",84,0)
 I 'CNT Q
"RTN","MAGDLB12",85,0)
 I CNT=1 S SITE=$G(SITES(CNT)) Q
"RTN","MAGDLB12",86,0)
 S I=0 F  S I=$O(SITES(I)) Q:'I  D
"RTN","MAGDLB12",87,0)
 . W !,I,") ",$G(SITES(I)),"  ",$$GET1^DIQ(4,+$G(SITES(I)),".01","E")
"RTN","MAGDLB12",88,0)
 . Q
"RTN","MAGDLB12",89,0)
 F  D  Q:Y'>CNT
"RTN","MAGDLB12",90,0)
 . S DIR(0)="N:1:"_CNT
"RTN","MAGDLB12",91,0)
 . S DIR("A",1)="There are images to be corrected for multiple divisions."
"RTN","MAGDLB12",92,0)
 . S DIR("A")="Select by number (1-"_CNT_")"
"RTN","MAGDLB12",93,0)
 . D ^DIR
"RTN","MAGDLB12",94,0)
 . W:Y>CNT " ??"
"RTN","MAGDLB12",95,0)
 . Q
"RTN","MAGDLB12",96,0)
 S:Y SITE=$G(SITES(+Y))
"RTN","MAGDLB12",97,0)
 Q
"RTN","MAGDLB12",98,0)
 ;
"RTN","MAGDLB12",99,0)
SECKEY() ;
"RTN","MAGDLB12",100,0)
 N MAGKY,MAGRSLT
"RTN","MAGDLB12",101,0)
 I '$D(DUZ) Q 0
"RTN","MAGDLB12",102,0)
 S MAGKY("MAGDFIX ALL")="MAGDFIX ALL"
"RTN","MAGDLB12",103,0)
 D OWNSKEY^XUSRB(.MAGRSLT,.MAGKY)
"RTN","MAGDLB12",104,0)
 I +$G(MAGRSLT("MAGDFIX ALL")) Q 1
"RTN","MAGDLB12",105,0)
 Q 0
"RTN","MAGDLB12",106,0)
 ;
"RTN","MAGDLB12",107,0)
MDIV() ;Multi-divisional flag
"RTN","MAGDLB12",108,0)
 N CNT,I
"RTN","MAGDLB12",109,0)
 S (CNT,I)=0
"RTN","MAGDLB12",110,0)
 F  S I=$O(^MAG(2006.1,I)) Q:'I  S CNT=CNT+1
"RTN","MAGDLB12",111,0)
 I CNT>1 Q 1
"RTN","MAGDLB12",112,0)
 Q 0
"RTN","MAGDLB12",113,0)
 ;
"RTN","MAGDLB12",114,0)
LKUSR(RESULT,USER) ;
"RTN","MAGDLB12",115,0)
 ;RETURNS: 0^Message for failure
"RTN","MAGDLB12",116,0)
 ;         IENs for Institution file entry^
"RTN","MAGDLB12",117,0)
 ; If the user has more than one division and more than one match in the Imaging Site
"RTN","MAGDLB12",118,0)
 ; Parameter file, then it returns the 1st matching division entry in the New Person file.
"RTN","MAGDLB12",119,0)
 I $D(DUZ(2)) S RESULT(0)="1^Number of entries",RESULT(DUZ(2))=DUZ(2) Q
"RTN","MAGDLB12",120,0)
 N MAGARRAY,CNT,MAGERR,MAGOUT,MAGDV,MAGX
"RTN","MAGDLB12",121,0)
 S RESULT(0)="0^Your division entry is not part of the Imaging Site Parameter."
"RTN","MAGDLB12",122,0)
 D GETS^DIQ(200,USER,"16*","I","MAGOUT")
"RTN","MAGDLB12",123,0)
 ;MAGOUT(200.02,"institution entry,duz,",.01,"I")=institution entry
"RTN","MAGDLB12",124,0)
 I $D(MAGOUT)=0 Q
"RTN","MAGDLB12",125,0)
 S MAGX="",CNT=0
"RTN","MAGDLB12",126,0)
 F  S MAGX=$O(MAGOUT(200.02,MAGX)) Q:MAGX=""  D
"RTN","MAGDLB12",127,0)
 . S MAGDV=$P(MAGX,",") I $D(^MAG(2006.1,"B",MAGDV)) S CNT=CNT+1,MAGARRAY(CNT)=MAGDV
"RTN","MAGDLB12",128,0)
 . Q
"RTN","MAGDLB12",129,0)
 I 'CNT Q
"RTN","MAGDLB12",130,0)
 S CNT=0
"RTN","MAGDLB12",131,0)
 S X=0 F  S X=$O(MAGARRAY(X)) Q:'X  S CNT=CNT+1,RESULT(X)=$P(MAGARRAY(X),"^")
"RTN","MAGDLB12",132,0)
 S RESULT(0)=CNT_"^Number of entries"
"RTN","MAGDLB12",133,0)
 ; Get the 1st institution, the calling routine should check for keys.
"RTN","MAGDLB12",134,0)
 Q
"RTN","MAGDLB12",135,0)
 ;
"RTN","MAGDLB9")
0^10^B9624068
"RTN","MAGDLB9",1,0)
MAGDLB9 ;WOIFO/LB/JSL/SAF - DICOM correct entries ; 01/30/2004  17:14
"RTN","MAGDLB9",2,0)
 ;;3.0;IMAGING;**11,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDLB9",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDLB9",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB9",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLB9",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLB9",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLB9",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLB9",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLB9",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLB9",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLB9",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLB9",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLB9",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLB9",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLB9",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLB9",17,0)
 ;;
"RTN","MAGDLB9",18,0)
 Q
"RTN","MAGDLB9",19,0)
EN() ;Start looping either by patient or loop thru Study uid
"RTN","MAGDLB9",20,0)
 N DIR,X,Y
"RTN","MAGDLB9",21,0)
 S DIR(0)="S^P:Patient;L:Loop thru file;D:Specify a Date Range"
"RTN","MAGDLB9",22,0)
 S DIR("A")="Update entries by"
"RTN","MAGDLB9",23,0)
 D ^DIR
"RTN","MAGDLB9",24,0)
 Q Y
"RTN","MAGDLB9",25,0)
 ;
"RTN","MAGDLB9",26,0)
START ;
"RTN","MAGDLB9",27,0)
 N KFIXALL,MAGSORT,MAGIEN,PREV,START,STOP,X,Y
"RTN","MAGDLB9",28,0)
 N MAGTYPE ; -- type of image
"RTN","MAGDLB9",29,0)
 S MAGSORT=$$EN Q:MAGSORT["^"
"RTN","MAGDLB9",30,0)
 S KFIXALL=$$SECKEY^MAGDLB12()
"RTN","MAGDLB9",31,0)
 I MAGSORT="P" D  G EXIT
"RTN","MAGDLB9",32,0)
 . D SRT^MAGDLBSR S MAGIEN=$$SELECT Q:MAGIEN<1
"RTN","MAGDLB9",33,0)
 . I 'KFIXALL,$P($G(^MAGD(2006.575,MAGIEN,1)),"^",5)'=$G(DUZ(2)) D  Q
"RTN","MAGDLB9",34,0)
 . . W !,"The entry selected was not captured on your site's gateway."
"RTN","MAGDLB9",35,0)
 . . W !,"You are not authorized to correct another site's entries."
"RTN","MAGDLB9",36,0)
 . . Q
"RTN","MAGDLB9",37,0)
 . S MAGTYPE=$P($G(^MAGD(2006.575,MAGIEN,"TYPE")),U)
"RTN","MAGDLB9",38,0)
 . I "^CON^MED^"[(U_MAGTYPE_U) D  Q
"RTN","MAGDLB9",39,0)
 . . W !,"Use the MAGD FIX "
"RTN","MAGDLB9",40,0)
 . . W $S(MAGTYPE="MED":"MEDICINE",1:"CLINSPEC")
"RTN","MAGDLB9",41,0)
 . . W " menu option to correct this entry."
"RTN","MAGDLB9",42,0)
 . . Q
"RTN","MAGDLB9",43,0)
 . S PREV=MAGIEN D SET^MAGDLB1
"RTN","MAGDLB9",44,0)
 I MAGSORT="D" D  G EXIT
"RTN","MAGDLB9",45,0)
 . D SRTDT^MAGDLBSR
"RTN","MAGDLB9",46,0)
 . D ASKDT^MAGDLBSR
"RTN","MAGDLB9",47,0)
 . I '$D(STR)!('$D(STP)) Q
"RTN","MAGDLB9",48,0)
 . S START=STR,STOP=STP K STR,STP
"RTN","MAGDLB9",49,0)
 . D DATELOOP^MAGDLB1(START,STOP)
"RTN","MAGDLB9",50,0)
 E  D LOOP^MAGDLB12
"RTN","MAGDLB9",51,0)
EXIT ;
"RTN","MAGDLB9",52,0)
 K ANS,ANSR,CASENO,COMNT1,DATA,DATA1,DATA2,DATE,FILE,FIRST,FIRSTS,I,MACHID,MAGDY
"RTN","MAGDLB9",53,0)
 K MAGDIEN,MAGCSE,MAGERR,MAGFIX,MAGDTPRT,MAGTYPE,MAGDTPRT,MAGSTP,MSG
"RTN","MAGDLB9",54,0)
 K MOD,MODEL,NEWCAS,NEWDFN,NEWDTI,NEWDTIM,NEWMUL,NEWNME,NEWPIEN,NEWPROC
"RTN","MAGDLB9",55,0)
 K NEWPID,OK,OOUT,OUT,PAT,PID,PREV,PREVS,REASON,STUDYUID,SUID,WHY
"RTN","MAGDLB9",56,0)
 Q
"RTN","MAGDLB9",57,0)
SELECT() ;
"RTN","MAGDLB9",58,0)
 N DIC,D,X,Y
"RTN","MAGDLB9",59,0)
 S DIC="^MAGD(2006.575,",D="D",DIC(0)="AE"
"RTN","MAGDLB9",60,0)
 D MIX^DIC1
"RTN","MAGDLB9",61,0)
 Q +Y
"RTN","MAGDLB9",62,0)
SLDATE() ;
"RTN","MAGDLB9",63,0)
 N DIC,D,X,Y
"RTN","MAGDLB9",64,0)
 S DIC="^MAGD(2006.575,",D="AD",DIC(0)="AE"
"RTN","MAGDLB9",65,0)
 D MIX^DIC1
"RTN","MAGDLB9",66,0)
 Q +Y
"RTN","MAGDLBAA")
0^11^B20043797
"RTN","MAGDLBAA",1,0)
MAGDLBAA ;WOIFO/LB/JSL/SAF - Routine to move failed dicom images to ^MAG(2006.575 ; 05/18/2007 11:23
"RTN","MAGDLBAA",2,0)
 ;;3.0;IMAGING;**11,51,54,53,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDLBAA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDLBAA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBAA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDLBAA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDLBAA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDLBAA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDLBAA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDLBAA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDLBAA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDLBAA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDLBAA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDLBAA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDLBAA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDLBAA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDLBAA",17,0)
 ;;
"RTN","MAGDLBAA",18,0)
 Q
"RTN","MAGDLBAA",19,0)
MOVE ;called from MAGDIR1 to move entries not matching Radiology case #.
"RTN","MAGDLBAA",20,0)
 ;Not done thru FM because the system should be independent.
"RTN","MAGDLBAA",21,0)
 ;These variable are needed to be defined before using this routine:
"RTN","MAGDLBAA",22,0)
 ;PIDCHECK, FIRSTDCM, IMGSVC, MIDCM, MACHID,ACNUMB, CASENUMB, PNAMEDCM, PID
"RTN","MAGDLBAA",23,0)
 ;MODALITY, CASETEXT
"RTN","MAGDLBAA",24,0)
 N DATE,REASON,ENTRY,IEN,NIEN,ORIG,DCMPNME,CASE,CASENUM,PATIENT,RESULT
"RTN","MAGDLBAA",25,0)
 S DATE=$$NOW^XLFDT()\1,RESULT=0
"RTN","MAGDLBAA",26,0)
 ;
"RTN","MAGDLBAA",27,0)
 ; if the entry already exists in file 2006.575, skip it
"RTN","MAGDLBAA",28,0)
 S MACHID=$G(MACHID,"A")
"RTN","MAGDLBAA",29,0)
 I $$EXIST(.RESULT,FROMPATH,MACHID,LOCATION) D  Q
"RTN","MAGDLBAA",30,0)
 . D REMOAFX(.RESULT,MACHID,LOCATION,STUDYUID)
"RTN","MAGDLBAA",31,0)
 . Q
"RTN","MAGDLBAA",32,0)
 ;
"RTN","MAGDLBAA",33,0)
 ;ADD ENTRY
"RTN","MAGDLBAA",34,0)
 L +^MAGD(2006.575,0):1E9 ; Background process MUST wait
"RTN","MAGDLBAA",35,0)
 S X=$G(^MAGD(2006.575,0))
"RTN","MAGDLBAA",36,0)
 S $P(X,"^",1,2)="DICOM FAILED IMAGES^2006.575"
"RTN","MAGDLBAA",37,0)
 S IEN=$O(^MAGD(2006.575," "),-1)+1,$P(X,"^",3)=IEN
"RTN","MAGDLBAA",38,0)
 S $P(X,"^",4)=$P(X,"^",4)+1 ; # entries
"RTN","MAGDLBAA",39,0)
 S ^MAGD(2006.575,0)=X
"RTN","MAGDLBAA",40,0)
 ;
"RTN","MAGDLBAA",41,0)
 S REASON=$P(PIDCHECK,",",2)
"RTN","MAGDLBAA",42,0)
 S PATIENT=LASTDCM_","_FIRSTDCM_$S($L(MIDCM)>0:" "_MIDCM,1:"")
"RTN","MAGDLBAA",43,0)
 ; PNAMEDCM usually contains an "^" between last & first name
"RTN","MAGDLBAA",44,0)
 ; CHANGE ^ TO ~
"RTN","MAGDLBAA",45,0)
 S CASE=$TR(ACNUMB,"^","~"),CASENUM=$TR(CASENUMB,"^","~")
"RTN","MAGDLBAA",46,0)
 S DCMPNME=$TR(PNAMEDCM,"^","~")
"RTN","MAGDLBAA",47,0)
 S ^MAGD(2006.575,IEN,0)=FROMPATH_"^"_REASON_"^"_PID_"^"_PATIENT_"^"_DCMPNME
"RTN","MAGDLBAA",48,0)
 S ^MAGD(2006.575,IEN,1)=CASE_"^"_CASENUM_"^"_DATE_"^"_MACHID_"^"_LOCATION
"RTN","MAGDLBAA",49,0)
 S ^MAGD(2006.575,IEN,"AIUID")=$G(IMAGEUID)
"RTN","MAGDLBAA",50,0)
 S ^MAGD(2006.575,IEN,"ASUID")=STUDYUID
"RTN","MAGDLBAA",51,0)
 ;MOD for IHS multiple Chart ID (i.e. Chawktaw)
"RTN","MAGDLBAA",52,0)
 S ^MAGD(2006.575,IEN,"AMFG")=$G(INSTNAME)_"^"_$G(ROWS)_"^"_$G(COLUMNS)_"^"_$G(OFFSET)_"^"_$G(MODIEN)_"^"_$G(MODALITY)_"^"_$$UP^MAGDFCNV($G(MFGR))_"^"_$$UP^MAGDFCNV($G(MODEL))_"^"_INSTLOC ;P123
"RTN","MAGDLBAA",53,0)
 S ^MAGD(2006.575,IEN,"ACSTXT")=$G(CASETEXT)
"RTN","MAGDLBAA",54,0)
 ; Image type can be RAD, MEDICINE, SURGERY, etc.
"RTN","MAGDLBAA",55,0)
 S ^MAGD(2006.575,IEN,"TYPE")=$G(IMGSVC)
"RTN","MAGDLBAA",56,0)
 ;Setting xrefs
"RTN","MAGDLBAA",57,0)
 S ^MAGD(2006.575,"B",FROMPATH,IEN)=""
"RTN","MAGDLBAA",58,0)
 ; Clean up---no longer need this cross reference
"RTN","MAGDLBAA",59,0)
 K ^MAGD(2006.575,"D") ; Used for Consults only
"RTN","MAGDLBAA",60,0)
 L -^MAGD(2006.575,0)
"RTN","MAGDLBAA",61,0)
 ;
"RTN","MAGDLBAA",62,0)
 ;The following xref ("F") will be set on the 1st entry having a unique
"RTN","MAGDLBAA",63,0)
 ;STUDYUID. The remaining entries with the same # will be added
"RTN","MAGDLBAA",64,0)
 ;to the RELATED IMAGES multiple field for the entry that set the
"RTN","MAGDLBAA",65,0)
 ;F xref.
"RTN","MAGDLBAA",66,0)
 S ORIG=0
"RTN","MAGDLBAA",67,0)
 I '$D(^MAGD(2006.575,"F",LOCATION,STUDYUID)) D  Q  ; Quit if 1st entry
"RTN","MAGDLBAA",68,0)
 . S ^MAGD(2006.575,"F",LOCATION,STUDYUID,IEN)=""
"RTN","MAGDLBAA",69,0)
 . Q
"RTN","MAGDLBAA",70,0)
 S ORIG=$O(^MAGD(2006.575,"F",LOCATION,STUDYUID,0))
"RTN","MAGDLBAA",71,0)
 Q:'ORIG
"RTN","MAGDLBAA",72,0)
 I ORIG'=IEN D
"RTN","MAGDLBAA",73,0)
 . I '$D(^MAGD(2006.575,ORIG,"RLATE",0)) D
"RTN","MAGDLBAA",74,0)
 . . S ^MAGD(2006.575,ORIG,"RLATE",0)="^2006.57526PA^^"
"RTN","MAGDLBAA",75,0)
 . S NIEN=$P(^MAGD(2006.575,ORIG,"RLATE",0),"^",3),NIEN=NIEN+1
"RTN","MAGDLBAA",76,0)
 . S $P(^MAGD(2006.575,ORIG,"RLATE",0),"^",3)=NIEN ; #next ien entry
"RTN","MAGDLBAA",77,0)
 . S $P(^MAGD(2006.575,ORIG,"RLATE",0),"^",4)=$P(^MAGD(2006.575,ORIG,"RLATE",0),"^",4)+1 ; #record for multiple field
"RTN","MAGDLBAA",78,0)
 . S ^MAGD(2006.575,ORIG,"RLATE",NIEN,0)=IEN
"RTN","MAGDLBAA",79,0)
 . S ^MAGD(2006.575,ORIG,"RLATE","B",IEN,NIEN)=""
"RTN","MAGDLBAA",80,0)
 . Q
"RTN","MAGDLBAA",81,0)
 Q
"RTN","MAGDLBAA",82,0)
 ;
"RTN","MAGDLBAA",83,0)
EXIST(RESULT,PATH,MACHINE,SITE) ; if it exist don't add it.
"RTN","MAGDLBAA",84,0)
 N IEN,NODE1
"RTN","MAGDLBAA",85,0)
 S RESULT=0
"RTN","MAGDLBAA",86,0)
 I $D(^MAGD(2006.575,"B",PATH)) D
"RTN","MAGDLBAA",87,0)
 . S IEN=$O(^MAGD(2006.575,"B",PATH,"")) I 'IEN S RESULT=0 Q
"RTN","MAGDLBAA",88,0)
 . I '$D(^MAGD(2006.575,+IEN)) S RESULT=0 Q
"RTN","MAGDLBAA",89,0)
 . S NODE1=$G(^MAGD(2006.575,IEN,1))
"RTN","MAGDLBAA",90,0)
 . I $P(NODE1,"^",4)'=MACHINE S RESULT=0 Q
"RTN","MAGDLBAA",91,0)
 . I $P(NODE1,"^",5)'=SITE S RESULT=0 Q
"RTN","MAGDLBAA",92,0)
 . S RESULT=IEN
"RTN","MAGDLBAA",93,0)
 . Q
"RTN","MAGDLBAA",94,0)
 Q RESULT
"RTN","MAGDLBAA",95,0)
REMOAFX(IEN,MACHINE,SITE,STUDY) ; Remove AFX cross reference.
"RTN","MAGDLBAA",96,0)
 N PENTRY
"RTN","MAGDLBAA",97,0)
 ;IEN is the result of the call to line tag EXIST.
"RTN","MAGDLBAA",98,0)
 ; The AFX cross reference governs what needs processing.
"RTN","MAGDLBAA",99,0)
 I $D(^MAGD(2006.575,"AFX",SITE,MACHINE,IEN)) D  Q
"RTN","MAGDLBAA",100,0)
 . S $P(^MAGD(2006.575,IEN,"FIXD"),"^")=0
"RTN","MAGDLBAA",101,0)
 . K ^MAGD(2006.575,"AFX",SITE,MACHINE,IEN)
"RTN","MAGDLBAA",102,0)
 . Q
"RTN","MAGDLBAA",103,0)
 ;may be a child entry check the 'F' cross reference to find the parent.
"RTN","MAGDLBAA",104,0)
 S PENTRY=$O(^MAGD(2006.575,"F",SITE,STUDY,0))
"RTN","MAGDLBAA",105,0)
 Q:'$D(^MAGD(2006.575,+PENTRY,0))
"RTN","MAGDLBAA",106,0)
 ;is it a child entry check the multiple 'b' cross reference
"RTN","MAGDLBAA",107,0)
 I $D(^MAGD(2006.575,PENTRY,"RELATE",0)),$D(^MAGD(2006.575,PENTRY,"B",IEN)) D
"RTN","MAGDLBAA",108,0)
 . I $D(^MAGD(2006.575,"AFX",SITE,MACHINE,PENTRY)) D
"RTN","MAGDLBAA",109,0)
 . . K ^MAGD(2006.575,"AFX",SITE,MACHINE,PENTRY)
"RTN","MAGDLBAA",110,0)
 . . S $P(^MAGD(2006.575,PENTRY,"FIXD"),"^")=0
"RTN","MAGDLBAA",111,0)
 . . Q
"RTN","MAGDLBAA",112,0)
 Q
"RTN","MAGDQR03")
0^12^B166761513
"RTN","MAGDQR03",1,0)
MAGDQR03 ;WOIFO/EdM/JSL/SAF - Imaging RPCs for Query/Retrieve ; 17 Feb 2010 11:18 AM
"RTN","MAGDQR03",2,0)
 ;;3.0;IMAGING;**51,54,66,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDQR03",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDQR03",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR03",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR03",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR03",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR03",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR03",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR03",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR03",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR03",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR03",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR03",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR03",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR03",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR03",17,0)
 ;;
"RTN","MAGDQR03",18,0)
 Q
"RTN","MAGDQR03",19,0)
 ;
"RTN","MAGDQR03",20,0)
 ; When RESULT^MAGDQR03 is called, the following input parameters
"RTN","MAGDQR03",21,0)
 ; should be properly defined:
"RTN","MAGDQR03",22,0)
 ;   TYPE   = R(adiology) or C(onsult)
"RTN","MAGDQR03",23,0)
 ;   RESULT = pointer into results global (#2006.5732)
"RTN","MAGDQR03",24,0)
 ;   MAGIEN = pointer into the Image File (#2005)
"RTN","MAGDQR03",25,0)
 ;   MAGDFN = pointer into the Patient File (#2)
"RTN","MAGDQR03",26,0)
 ;   MAGRORD = second level pointer into the Rad/Nuc Med Patient File (#70)
"RTN","MAGDQR03",27,0)
 ;             (Radiology orders only)
"RTN","MAGDQR03",28,0)
 ;   MAGINTERP = third level pointer into the Rad/Nuc Med Patient File (#70)
"RTN","MAGDQR03",29,0)
 ;             (Radiology orders only) 
"RTN","MAGDQR03",30,0)
 ; 
"RTN","MAGDQR03",31,0)
 ; This routine contains code to calculate values for DICOM Tags
"RTN","MAGDQR03",32,0)
 ; that can be derived from those two pointers.
"RTN","MAGDQR03",33,0)
 ; All other DICOM Tags are computed in MAGDQR06.
"RTN","MAGDQR03",34,0)
 ; (This routine does the things that are the same for all images.
"RTN","MAGDQR03",35,0)
 ; MAGDQR06 differentiates between Radiology, Consults, and anything else.)
"RTN","MAGDQR03",36,0)
 ;
"RTN","MAGDQR03",37,0)
RESULT(TYPE,RESULT,MAGIEN,MAGDFN,MAGRORD,MAGINTERP) ;
"RTN","MAGDQR03",38,0)
 ; validate input parameters
"RTN","MAGDQR03",39,0)
 I "^R^C^"'[("^"_TYPE_"^") D ERR^MAGDQR01("Study type (radiology/consult) not defined") Q
"RTN","MAGDQR03",40,0)
 I '$G(RESULT) D ERR^MAGDQR01("Invalid query result set "_RESULT_" specified") Q
"RTN","MAGDQR03",41,0)
 I $D(MAGIEN),$D(^MAG(2005,MAGIEN))
"RTN","MAGDQR03",42,0)
 E  D ERR^MAGDQR01("Invalid image ID "_MAGIEN_" specified for result") Q
"RTN","MAGDQR03",43,0)
 I $D(MAGDFN),$D(^DPT(MAGDFN))
"RTN","MAGDQR03",44,0)
 E  D ERR^MAGDQR01("Invalid patient ID "_MAGDFN_" specified for result") Q
"RTN","MAGDQR03",45,0)
 I TYPE="R",'$G(MAGRORD) D  Q
"RTN","MAGDQR03",46,0)
 . D ERR^MAGDQR01("Invalid Radiology order number "_MAGRORD_" specified")
"RTN","MAGDQR03",47,0)
 . Q
"RTN","MAGDQR03",48,0)
 I TYPE="R",'$G(MAGINTERP) D  Q
"RTN","MAGDQR03",49,0)
 . D ERR^MAGDQR01("Invalid Radiology interpretation "_MAGINTERP_" specified")
"RTN","MAGDQR03",50,0)
 . Q
"RTN","MAGDQR03",51,0)
 ;
"RTN","MAGDQR03",52,0)
 N E,L,OK,V,X,T
"RTN","MAGDQR03",53,0)
 N SENSEMP ; ----- sensitive/employee flag
"RTN","MAGDQR03",54,0)
 N ACCESSION ; --- accession number
"RTN","MAGDQR03",55,0)
 S SENSEMP=0,OK=1
"RTN","MAGDQR03",56,0)
 ;
"RTN","MAGDQR03",57,0)
 ; new specs for sens/emp patients 3/20/09 - data will be picked up, but scrubbed
"RTN","MAGDQR03",58,0)
 ;
"RTN","MAGDQR03",59,0)
 S SENSEMP=SENSEMP+($$EMPL^DGSEC4(MAGDFN)=1) ; IA #3646
"RTN","MAGDQR03",60,0)
 S SENSEMP=SENSEMP+($P($G(^DGSL(38.1,MAGDFN,0)),"^",2)=1) ; IA #767
"RTN","MAGDQR03",61,0)
 S SENSEMP=0 ; sensitive/employee data suppression to be suspended as of Jan 2010
"RTN","MAGDQR03",62,0)
 ; increment (static) dummy Study Instance UID if sensitive/employee
"RTN","MAGDQR03",63,0)
 S:SENSEMP ^("DUMMY SIUID")=^TMP("MAG",$J,"DICOMQR","DUMMY SIUID")+1
"RTN","MAGDQR03",64,0)
 ;
"RTN","MAGDQR03",65,0)
 ; calculate accession number here 2/17/10, moved from Q0080050^MAGDQR06
"RTN","MAGDQR03",66,0)
 ;
"RTN","MAGDQR03",67,0)
 D:TYPE="R"
"RTN","MAGDQR03",68,0)
 . S X=$P($G(^RADPT(MAGDFN,"DT",MAGRORD,"P",MAGINTERP,0)),"^",17) ; IA # 1172
"RTN","MAGDQR03",69,0)
 . S ACCESSION=$P($G(^RARPT(+X,0)),"^",1) ; IA # 1171
"RTN","MAGDQR03",70,0)
 . Q
"RTN","MAGDQR03",71,0)
 D:TYPE="C"
"RTN","MAGDQR03",72,0)
 . N R2,TIUNUM,CONSIX
"RTN","MAGDQR03",73,0)
 . S R2=$G(^MAG(2005,MAGIEN,2)) Q:R2=""
"RTN","MAGDQR03",74,0)
 . I $P(R2,"^",6)=2006.5839 D  Q
"RTN","MAGDQR03",75,0)
 . . S CONSIX=$P(R2,"^",7)
"RTN","MAGDQR03",76,0)
 . . S ACCESSION="GMRC-"_CONSIX
"RTN","MAGDQR03",77,0)
 . . Q
"RTN","MAGDQR03",78,0)
 . I $P(R2,"^",6)=8925 D  Q
"RTN","MAGDQR03",79,0)
 . . S TIUNUM=$P(R2,"^",7) Q:'TIUNUM
"RTN","MAGDQR03",80,0)
 . . S CONSIX=$P($G(^TIU(8925,TIUNUM,14)),"^",5)
"RTN","MAGDQR03",81,0)
 . . S:$P(CONSIX,";",2)="GMR(123," ACCESSION="GMRC-"_$P(CONSIX,";",1)
"RTN","MAGDQR03",82,0)
 . . Q
"RTN","MAGDQR03",83,0)
 . Q
"RTN","MAGDQR03",84,0)
 ;
"RTN","MAGDQR03",85,0)
 ; retrieve element values, indicate unsupported elements
"RTN","MAGDQR03",86,0)
 S T="" F  S T=$O(REQ(T)) Q:T=""  D
"RTN","MAGDQR03",87,0)
 . S L=$TR(T,",")
"RTN","MAGDQR03",88,0)
 . S E=$TR($E(L,1),"0123456789abcdef","QRSTUVWXYZABCDEF")
"RTN","MAGDQR03",89,0)
 . S $E(L,1)=E S:L'?8UN L=""
"RTN","MAGDQR03",90,0)
 . I L'="",$T(@L)'="" D @L S V(T)=$G(V(T)) Q
"RTN","MAGDQR03",91,0)
 . ; unsupported tag <> fatal error
"RTN","MAGDQR03",92,0)
 . D ERR^MAGDQR01("Cannot calculate value for tag: """_T_""".") S ERROR=0
"RTN","MAGDQR03",93,0)
 . Q
"RTN","MAGDQR03",94,0)
 ;
"RTN","MAGDQR03",95,0)
 I ERROR D ERRSAV^MAGDQR01 S FATAL=1 Q
"RTN","MAGDQR03",96,0)
 ;
"RTN","MAGDQR03",97,0)
 Q:'OK  ; don't return result on key mismatch
"RTN","MAGDQR03",98,0)
 ;
"RTN","MAGDQR03",99,0)
 D  Q:'OK  ; There must be a valid Study Instance UID
"RTN","MAGDQR03",100,0)
 . N V,T
"RTN","MAGDQR03",101,0)
 . S T="0020,000D" D Q020000D
"RTN","MAGDQR03",102,0)
 . S OK=(V(T)'="")
"RTN","MAGDQR03",103,0)
 . Q
"RTN","MAGDQR03",104,0)
 ;
"RTN","MAGDQR03",105,0)
 S ^("RESULTSET")=^TMP("MAG",$J,"DICOMQR","RESULTSET")+1
"RTN","MAGDQR03",106,0)
 D
"RTN","MAGDQR03",107,0)
 . N RSLTHDR,R1,V1,V2,VAL
"RTN","MAGDQR03",108,0)
 . S RSLTHDR="0000,0902^Result # "_^TMP("MAG",$J,"DICOMQR","RESULTSET")
"RTN","MAGDQR03",109,0)
 . S R1=$O(^MAGDQR(2006.5732,RESULT,1," "),-1)+1
"RTN","MAGDQR03",110,0)
 . S ^MAGDQR(2006.5732,RESULT,1,R1,0)=RSLTHDR
"RTN","MAGDQR03",111,0)
 . S VAL=$G(^MAG(2005,MAGIEN,2))\1
"RTN","MAGDQR03",112,0)
 . S ^TMP("MAG",$J,"QR",99,VAL_" "_MAGDFN,R1)=MAGIEN
"RTN","MAGDQR03",113,0)
 . S T="" F  S T=$O(V(T)) Q:T=""  D
"RTN","MAGDQR03",114,0)
 . . S VAL=$G(V(T))
"RTN","MAGDQR03",115,0)
 . . S V1="" F  S V1=$O(V(T,V1)) Q:V1=""  D
"RTN","MAGDQR03",116,0)
 . . . Q:$G(V(T,V1))=""
"RTN","MAGDQR03",117,0)
 . . . S:VAL'="" VAL=VAL_"\" S VAL=VAL_V(T,V1)
"RTN","MAGDQR03",118,0)
 . . . Q
"RTN","MAGDQR03",119,0)
 . . S R1=R1+1,^MAGDQR(2006.5732,RESULT,1,R1,0)=T_"^"_VAL
"RTN","MAGDQR03",120,0)
 . . S ^MAGDQR(2006.5732,RESULT,1,"B",T,R1)=""
"RTN","MAGDQR03",121,0)
 . . Q:$D(V(T))<10
"RTN","MAGDQR03",122,0)
 . . S V1="" F  S V1=$O(V(T,V1)) Q:V1=""  D
"RTN","MAGDQR03",123,0)
 . . . S V2="" F  S V2=$O(V(T,V1,V2)) Q:V2=""  D
"RTN","MAGDQR03",124,0)
 . . . . S VAL=$G(V(T,V1,V2)) Q:VAL=""
"RTN","MAGDQR03",125,0)
 . . . . S R1=R1+1,^MAGDQR(2006.5732,RESULT,1,R1,0)=T_"^"_VAL
"RTN","MAGDQR03",126,0)
 . . . . S ^MAGDQR(2006.5732,RESULT,1,"B",T,R1)=""
"RTN","MAGDQR03",127,0)
 . . . . Q
"RTN","MAGDQR03",128,0)
 . . . Q
"RTN","MAGDQR03",129,0)
 . . Q
"RTN","MAGDQR03",130,0)
 . Q
"RTN","MAGDQR03",131,0)
 Q
"RTN","MAGDQR03",132,0)
 ;
"RTN","MAGDQR03",133,0)
COMPARE(TAG,ACTUAL) N LOC,TMP,WILD
"RTN","MAGDQR03",134,0)
 Q:'$G(REQ(TAG)) 1
"RTN","MAGDQR03",135,0)
 S WILD=$G(REQ(TAG,1)) Q:WILD="" 0
"RTN","MAGDQR03",136,0)
 Q:$G(ACTUAL)="" 0
"RTN","MAGDQR03",137,0)
 S LOC(ACTUAL)=""
"RTN","MAGDQR03",138,0)
 Q $$MATCHD(WILD,"LOC(LOOP)","TMP(LOOP)")
"RTN","MAGDQR03",139,0)
 ;
"RTN","MAGDQR03",140,0)
MATCH1(X,Y) N I,M
"RTN","MAGDQR03",141,0)
 F  Q:X=""  Q:Y=""  D
"RTN","MAGDQR03",142,0)
 . I $E(X,1)=$E(Y,1) S X=$E(X,2,$L(X)),Y=$E(Y,2,$L(Y)) Q
"RTN","MAGDQR03",143,0)
 . I $E(Y,1)="?" S X=$E(X,2,$L(X)),Y=$E(Y,2,$L(Y)) Q
"RTN","MAGDQR03",144,0)
 . I $E(Y,1)="*" D  Q:M
"RTN","MAGDQR03",145,0)
 . . I Y="*" S (X,Y)="",M=1 Q
"RTN","MAGDQR03",146,0)
 . . S Y=$E(Y,2,$L(Y)),M=0
"RTN","MAGDQR03",147,0)
 . . F I=1:1:$L(X) I $$MATCH1($E(X,I,$L(X)),Y) S M=1,X=$E(X,I,$L(X)) Q
"RTN","MAGDQR03",148,0)
 . . Q
"RTN","MAGDQR03",149,0)
 . S X="!",Y=""
"RTN","MAGDQR03",150,0)
 . Q
"RTN","MAGDQR03",151,0)
 S:$TR(Y,"*")="" Y="" Q:X'="" 0 Q:Y'="" 0
"RTN","MAGDQR03",152,0)
 Q 1
"RTN","MAGDQR03",153,0)
 ;
"RTN","MAGDQR03",154,0)
MATCHD(WILDCARD,STRUCTUR,FOUND) N C,LOOP,L1,L9,SEEK,X,Y
"RTN","MAGDQR03",155,0)
 ;  -- Scans a structure,
"RTN","MAGDQR03",156,0)
 ;     reports entries in @STRUCTUR that match WILDCARD;
"RTN","MAGDQR03",157,0)
 ;     the result is reported in local array @FOUND
"RTN","MAGDQR03",158,0)
 S C=0
"RTN","MAGDQR03",159,0)
 S L1=$P($P(WILDCARD,"?",1),"*",1),L9=L1_"~"
"RTN","MAGDQR03",160,0)
 I L1=WILDCARD D  Q C
"RTN","MAGDQR03",161,0)
 . S LOOP=L1
"RTN","MAGDQR03",162,0)
 . I $D(@STRUCTUR) S @FOUND="",C=C+1 Q
"RTN","MAGDQR03",163,0)
 . Q
"RTN","MAGDQR03",164,0)
 S LOOP=L1 F  D  S LOOP=$O(@STRUCTUR) Q:LOOP=""  Q:LOOP]]L9
"RTN","MAGDQR03",165,0)
 . Q:LOOP=""  Q:'$D(@STRUCTUR)
"RTN","MAGDQR03",166,0)
 . Q:'$$MATCH1(LOOP,WILDCARD)
"RTN","MAGDQR03",167,0)
 . S @FOUND="",C=C+1
"RTN","MAGDQR03",168,0)
 . Q
"RTN","MAGDQR03",169,0)
 Q C
"RTN","MAGDQR03",170,0)
 ;
"RTN","MAGDQR03",171,0)
Q0080018 ;U Image Instance UID
"RTN","MAGDQR03",172,0)
 ; sensitive/employee?
"RTN","MAGDQR03",173,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",174,0)
 . S V(T)="1.2.840.113754.2.1.3.1.1.1.1.66."_$G(^TMP("MAG",$J,"DICOMQR","DUMMY SIUID"))
"RTN","MAGDQR03",175,0)
 . Q
"RTN","MAGDQR03",176,0)
 ; no
"RTN","MAGDQR03",177,0)
 N SOPUID
"RTN","MAGDQR03",178,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",179,0)
 S V(T)=$P($G(^MAG(2005,MAGIEN,"PACS")),"^",1)
"RTN","MAGDQR03",180,0)
 S SOPUID=$P($G(^MAG(2005,MAGIEN,"SOP")),"^",2)
"RTN","MAGDQR03",181,0)
 S:SOPUID'="" V(T)=SOPUID
"RTN","MAGDQR03",182,0)
 Q
"RTN","MAGDQR03",183,0)
 ;
"RTN","MAGDQR03",184,0)
Q0080020 ;R Study Date
"RTN","MAGDQR03",185,0)
 ; sensitive/employee?
"RTN","MAGDQR03",186,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",187,0)
 . N I,REQDT S I=$O(REQ(T,"")) S:I REQDT=$TR($P($G(REQ(T,I)),"-",1),"*")
"RTN","MAGDQR03",188,0)
 . S V(T)=$S($G(REQDT)?8N:REQDT,1:$$DT^XLFDT+17000000)
"RTN","MAGDQR03",189,0)
 . Q
"RTN","MAGDQR03",190,0)
 ; no
"RTN","MAGDQR03",191,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",192,0)
 S V(T)=$P($G(^MAG(2005,MAGIEN,2)),"^",5)\1+17000000
"RTN","MAGDQR03",193,0)
 Q
"RTN","MAGDQR03",194,0)
 ;
"RTN","MAGDQR03",195,0)
Q0080030 ;R  Study Time
"RTN","MAGDQR03",196,0)
 ; sensitive/employee?
"RTN","MAGDQR03",197,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",198,0)
 . N I,REQTM S I=$O(REQ(T,"")) S:I REQTM=$TR($P($G(REQ(T,I)),"-",1),"*")
"RTN","MAGDQR03",199,0)
 . S V(T)=$S($G(REQTM)?6N:REQTM,1:$E($P($$NOW^XLFDT,".",2)_"000000",1,6))
"RTN","MAGDQR03",200,0)
 . Q
"RTN","MAGDQR03",201,0)
 ; no
"RTN","MAGDQR03",202,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",203,0)
 S V(T)=$TR($J("."_$P($P($G(^MAG(2005,MAGIEN,2)),"^",5),".",2)*1E6,6)," ",0)
"RTN","MAGDQR03",204,0)
 Q
"RTN","MAGDQR03",205,0)
 ;
"RTN","MAGDQR03",206,0)
Q0080050 D Q0080050^MAGDQR06 ;R  Accession Number
"RTN","MAGDQR03",207,0)
 Q
"RTN","MAGDQR03",208,0)
 ;
"RTN","MAGDQR03",209,0)
Q0100010 ;R  Patient's Name
"RTN","MAGDQR03",210,0)
 ; No IA needed, PIMS 5.3
"RTN","MAGDQR03",211,0)
 S V(T)=$S('SENSEMP:$P($G(^DPT(MAGDFN,0)),"^",1),1:"IMAGPATIENT,SENSITIVE")
"RTN","MAGDQR03",212,0)
 S V(T)=$$VA2DCM^MAGDQR01(V(T))
"RTN","MAGDQR03",213,0)
 Q
"RTN","MAGDQR03",214,0)
 ;
"RTN","MAGDQR03",215,0)
Q0100020 ;R  Patient ID
"RTN","MAGDQR03",216,0)
 ; No IA needed, PIMS 5.3
"RTN","MAGDQR03",217,0)
 S V(T)=$S('SENSEMP:$P($G(^DPT(MAGDFN,0)),"^",9),1:"000001234")
"RTN","MAGDQR03",218,0)
 Q
"RTN","MAGDQR03",219,0)
 ;
"RTN","MAGDQR03",220,0)
Q0200010 D Q0200010^MAGDQR06 ;R  Study ID
"RTN","MAGDQR03",221,0)
 Q
"RTN","MAGDQR03",222,0)
 ;
"RTN","MAGDQR03",223,0)
Q020000D ;U  Study Instance UID
"RTN","MAGDQR03",224,0)
 ; sensitive/employee?
"RTN","MAGDQR03",225,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",226,0)
 . S V(T)="1.2.840.113754.2.1.3.1.1.66."_$G(^TMP("MAG",$J,"DICOMQR","DUMMY SIUID"))
"RTN","MAGDQR03",227,0)
 . Q
"RTN","MAGDQR03",228,0)
 ; no
"RTN","MAGDQR03",229,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",230,0)
 N PARENT
"RTN","MAGDQR03",231,0)
 S PARENT=$P($G(^MAG(2005,MAGIEN,0)),"^",10)
"RTN","MAGDQR03",232,0)
 S:'PARENT PARENT=MAGIEN
"RTN","MAGDQR03",233,0)
 S V(T)=$P($G(^MAG(2005,PARENT,"PACS")),"^",1)
"RTN","MAGDQR03",234,0)
 Q
"RTN","MAGDQR03",235,0)
 ;
"RTN","MAGDQR03",236,0)
Q020000E ;U  Series Instance UID
"RTN","MAGDQR03",237,0)
 ; sensitive/employee?
"RTN","MAGDQR03",238,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",239,0)
 . S V(T)="1.2.840.113754.2.1.3.1.1.1.66."_$G(^TMP("MAG",$J,"DICOMQR","DUMMY SIUID"))
"RTN","MAGDQR03",240,0)
 . Q
"RTN","MAGDQR03",241,0)
 ; no
"RTN","MAGDQR03",242,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",243,0)
 S V(T)=$P($G(^MAG(2005,MAGIEN,"SERIESUID")),"^",1)
"RTN","MAGDQR03",244,0)
 Q
"RTN","MAGDQR03",245,0)
 ;
"RTN","MAGDQR03",246,0)
Q0080052 ;O  Query Level
"RTN","MAGDQR03",247,0)
 N I
"RTN","MAGDQR03",248,0)
 S I=$O(REQ(T,"")),V(T)=""
"RTN","MAGDQR03",249,0)
 S:I V(T)=$G(REQ(T,I))
"RTN","MAGDQR03",250,0)
 Q
"RTN","MAGDQR03",251,0)
 ;
"RTN","MAGDQR03",252,0)
Q0080061 ;O  Modalities in Study
"RTN","MAGDQR03",253,0)
 ; sensitive/employee?
"RTN","MAGDQR03",254,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",255,0)
 . N I
"RTN","MAGDQR03",256,0)
 . S I=$O(REQ(T,""))
"RTN","MAGDQR03",257,0)
 . S V(T)="OT" I I,$G(REQ(T,I))]"" S V(T)=REQ(T,I)
"RTN","MAGDQR03",258,0)
 . Q
"RTN","MAGDQR03",259,0)
 ; no
"RTN","MAGDQR03",260,0)
 N ANY,I1,I2,LIST,MOD,P1,P2,R,TMP
"RTN","MAGDQR03",261,0)
 I MAGIEN="" S V(T)="" Q
"RTN","MAGDQR03",262,0)
 ;
"RTN","MAGDQR03",263,0)
 S I1="" F  S I1=$O(REQ(T,I1)) Q:I1=""  D
"RTN","MAGDQR03",264,0)
 . S R=$TR(REQ(T,I1),"/","\")
"RTN","MAGDQR03",265,0)
 . F I2=1:1:$L(R,"\") S X=$P(R,"\",I2) S:X'="" LIST(X)=1
"RTN","MAGDQR03",266,0)
 . Q
"RTN","MAGDQR03",267,0)
 ;
"RTN","MAGDQR03",268,0)
 S X=$P($G(^MAG(2005,MAGIEN,0)),"^",8) S:$E(X,1,4)="RAD " X=$E(X,5,$L(X))
"RTN","MAGDQR03",269,0)
 S:X'="" MOD(X)=""
"RTN","MAGDQR03",270,0)
 S R="",P1=0 F  S P1=$O(^MAG(2005,MAGIEN,1,P1)) Q:'P1  D
"RTN","MAGDQR03",271,0)
 . S P2=+$G(^MAG(2005,MAGIEN,1,P1,0)) Q:'P2
"RTN","MAGDQR03",272,0)
 . S X=$P($G(^MAG(2005,P2,0)),"^",8)
"RTN","MAGDQR03",273,0)
 . S:$E(X,1,4)="RAD " X=$E(X,5,$L(X))
"RTN","MAGDQR03",274,0)
 . S:X'="" MOD(X)=""
"RTN","MAGDQR03",275,0)
 . Q
"RTN","MAGDQR03",276,0)
 S R="",ANY=0,X="" F  S X=$O(MOD(X)) Q:X=""  D
"RTN","MAGDQR03",277,0)
 . D  ; filter out consult-related noise
"RTN","MAGDQR03",278,0)
 . . Q:$E(X,1,7)="CONSULT"  Q:X="CON/PROC"
"RTN","MAGDQR03",279,0)
 . . S:R'="" R=R_"," S R=R_X
"RTN","MAGDQR03",280,0)
 . . Q
"RTN","MAGDQR03",281,0)
 . I $O(LIST(""))="" S ANY=1 Q
"RTN","MAGDQR03",282,0)
 . S I1="" F  S I1=$O(LIST(I1)) Q:I1=""  D  Q:ANY
"RTN","MAGDQR03",283,0)
 . . S:$$MATCHD(X,"LIST(LOOP)","TMP(LOOP)") ANY=1
"RTN","MAGDQR03",284,0)
 . . Q
"RTN","MAGDQR03",285,0)
 . Q
"RTN","MAGDQR03",286,0)
 S V(T)=R
"RTN","MAGDQR03",287,0)
 S:'ANY OK=0
"RTN","MAGDQR03",288,0)
 Q
"RTN","MAGDQR03",289,0)
 ;
"RTN","MAGDQR03",290,0)
Q0080062 D Q0080062^MAGDQR06 ;O  SOP Classes in Study
"RTN","MAGDQR03",291,0)
 Q
"RTN","MAGDQR03",292,0)
 ;
"RTN","MAGDQR03",293,0)
Q0080090 D Q0080090^MAGDQR06 ;O  Referring Physician's Name
"RTN","MAGDQR03",294,0)
 Q
"RTN","MAGDQR03",295,0)
 ;
"RTN","MAGDQR03",296,0)
Q0081030 D Q0081030^MAGDQR06 ;O  Study Description
"RTN","MAGDQR03",297,0)
 Q
"RTN","MAGDQR03",298,0)
 ;
"RTN","MAGDQR03",299,0)
Q0081032 ;O  Procedure Code Sequence
"RTN","MAGDQR03",300,0)
 Q
"RTN","MAGDQR03",301,0)
 ;
"RTN","MAGDQR03",302,0)
Q0080100 D Q0080100^MAGDQR06 ;O  >Code Value
"RTN","MAGDQR03",303,0)
 Q
"RTN","MAGDQR03",304,0)
 ;
"RTN","MAGDQR03",305,0)
Q0080102 ;O  >Coding Scheme Designator
"RTN","MAGDQR03",306,0)
 S V("0008,1030",1,T)="C4"
"RTN","MAGDQR03",307,0)
 Q
"RTN","MAGDQR03",308,0)
 ;
"RTN","MAGDQR03",309,0)
Q0080103 ;O  >Coding Scheme Version
"RTN","MAGDQR03",310,0)
 S V("0008,1030",1,T)=4
"RTN","MAGDQR03",311,0)
 Q
"RTN","MAGDQR03",312,0)
 ;
"RTN","MAGDQR03",313,0)
Q0080104 D Q0080104^MAGDQR06 ;O  >Code Meaning
"RTN","MAGDQR03",314,0)
 Q
"RTN","MAGDQR03",315,0)
 ;
"RTN","MAGDQR03",316,0)
Q0081060 D Q0081060^MAGDQR06 ;O  Name of Physician(s) Reading Study
"RTN","MAGDQR03",317,0)
 Q
"RTN","MAGDQR03",318,0)
 ;
"RTN","MAGDQR03",319,0)
Q0081080 D Q0081080^MAGDQR06 ;O  Admitting Diagnosis Description
"RTN","MAGDQR03",320,0)
 Q
"RTN","MAGDQR03",321,0)
 ;
"RTN","MAGDQR03",322,0)
Q0100021 ;O  Issuer of Patient ID
"RTN","MAGDQR03",323,0)
 S V(T)="USSSA"
"RTN","MAGDQR03",324,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",325,0)
 Q
"RTN","MAGDQR03",326,0)
 ;
"RTN","MAGDQR03",327,0)
Q0100030 ;O  Patient's Birth Date
"RTN","MAGDQR03",328,0)
 ; sensitive/employee?
"RTN","MAGDQR03",329,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",330,0)
 . N I,REQDT S I=$O(REQ(T,"")) S:I REQDT=$TR($P($G(REQ(T,I)),"-",1),"*")
"RTN","MAGDQR03",331,0)
 . S V(T)=$S($G(REQDT)?8N:REQDT,1:$$DT^XLFDT+17000000)
"RTN","MAGDQR03",332,0)
 . Q
"RTN","MAGDQR03",333,0)
 ; no
"RTN","MAGDQR03",334,0)
 S V(T)=$P($G(^DPT(MAGDFN,0)),"^",3)\1+17000000
"RTN","MAGDQR03",335,0)
 I $E(V(T),5,6)="00" S V(T)="" ; invalid month for DICOM
"RTN","MAGDQR03",336,0)
 I $E(V(T),7,8)="00" S V(T)="" ; invalid year for DICOM
"RTN","MAGDQR03",337,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",338,0)
 Q
"RTN","MAGDQR03",339,0)
 ;
"RTN","MAGDQR03",340,0)
Q0100032 ;O  Patient's Birth Time
"RTN","MAGDQR03",341,0)
 ; sensitive/employee?
"RTN","MAGDQR03",342,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",343,0)
 . N I,REQTM S I=$O(REQ(T,"")) S:I REQTM=$TR($P($G(REQ(T,I)),"-",1),"*")
"RTN","MAGDQR03",344,0)
 . S V(T)=$S($G(REQTM)?6N:REQTM,1:$E($P($$NOW^XLFDT,".",2)_"000000",1,6))
"RTN","MAGDQR03",345,0)
 . Q
"RTN","MAGDQR03",346,0)
 ; no
"RTN","MAGDQR03",347,0)
 S V(T)=$TR($J("."_$P($P($G(^DPT(MAGDFN,0)),"^",3),".",2)*1E6,6)," ",0)
"RTN","MAGDQR03",348,0)
 S:V(T)="000000" V(T)="" ; no time on file
"RTN","MAGDQR03",349,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",350,0)
 Q
"RTN","MAGDQR03",351,0)
 ;
"RTN","MAGDQR03",352,0)
Q0100040 ;O  Patient's Sex
"RTN","MAGDQR03",353,0)
 ; sensitive/employee?
"RTN","MAGDQR03",354,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",355,0)
 . N I S I=$O(REQ(T,"")) S V(T)=$S(I:$S($G(REQ(T,I))]"":REQ(T,I),1:"O"),1:"O")
"RTN","MAGDQR03",356,0)
 . Q
"RTN","MAGDQR03",357,0)
 ; no
"RTN","MAGDQR03",358,0)
 S V(T)=$P($G(^DPT(MAGDFN,0)),"^",2)
"RTN","MAGDQR03",359,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",360,0)
 Q
"RTN","MAGDQR03",361,0)
 ;
"RTN","MAGDQR03",362,0)
Q0101000 ;O  Other Patient IDs
"RTN","MAGDQR03",363,0)
 ; sensitive/employee?
"RTN","MAGDQR03",364,0)
 I SENSEMP S V(T)="000001234" Q  ; yes, scrub
"RTN","MAGDQR03",365,0)
 ; no
"RTN","MAGDQR03",366,0)
 N DFN,I,VA,VADPT
"RTN","MAGDQR03",367,0)
 S DFN=MAGDFN D DEM^VADPT
"RTN","MAGDQR03",368,0)
 S X=$P(^DPT(DFN,0),"^",9) S:X'="" DFN(X)=""
"RTN","MAGDQR03",369,0)
 S:$G(VA("PID"))'="" DFN(VA("PID"))=""
"RTN","MAGDQR03",370,0)
 S:$G(VA("BID"))'="" DFN(VA("BID"))=""
"RTN","MAGDQR03",371,0)
 I $T(GETICN^MPIF001)'="" S X=$$GETICN^MPIF001(DFN) S:+X DFN(X)=""
"RTN","MAGDQR03",372,0)
 S I=0,X="" F  S X=$O(DFN(X)) Q:X=""  S I=I+1,V(T,I)=X
"RTN","MAGDQR03",373,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",374,0)
 Q
"RTN","MAGDQR03",375,0)
 ;
"RTN","MAGDQR03",376,0)
Q0101001 ;O  Other Patient Names
"RTN","MAGDQR03",377,0)
 ; sensitive/employee?
"RTN","MAGDQR03",378,0)
 I SENSEMP S V(T)="IMAGPATIENT,SENSITIVE" Q  ; yes, scrub
"RTN","MAGDQR03",379,0)
 ; no
"RTN","MAGDQR03",380,0)
 N D1,I
"RTN","MAGDQR03",381,0)
 S (I,D1)=0 F  S D1=$O(^DPT(MAGDFN,0.01,D1)) Q:'D1  D
"RTN","MAGDQR03",382,0)
 . S X=$P($G(^DPT(MAGDFN,0.01,D1,0)),"^",1)
"RTN","MAGDQR03",383,0)
 . S:X'="" I=I+1,V(T,I)=X
"RTN","MAGDQR03",384,0)
 . Q
"RTN","MAGDQR03",385,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",386,0)
 Q
"RTN","MAGDQR03",387,0)
 ;
"RTN","MAGDQR03",388,0)
Q0101010 ;O  Patient's Age
"RTN","MAGDQR03",389,0)
 ; sensitive/employee?
"RTN","MAGDQR03",390,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",391,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",392,0)
 . Q
"RTN","MAGDQR03",393,0)
 ; no
"RTN","MAGDQR03",394,0)
 N DOB,FROM,YEARS
"RTN","MAGDQR03",395,0)
 S DOB=$P($G(^DPT(MAGDFN,0)),"^",3)
"RTN","MAGDQR03",396,0)
 S FROM=$P($G(^DPT(MAGDFN,.35)),"^",1) S:'FROM FROM=DT
"RTN","MAGDQR03",397,0)
 S YEARS=$E(FROM,1,3)-$E(DOB,1,3)
"RTN","MAGDQR03",398,0)
 S:$E(FROM,4,7)<$E(DOB,4,7) YEARS=YEARS-1
"RTN","MAGDQR03",399,0)
 S V(T)=($P($J(YEARS/1000,0,3),".",2))_"Y"
"RTN","MAGDQR03",400,0)
 ;;;S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",401,0)
 Q
"RTN","MAGDQR03",402,0)
 ;
"RTN","MAGDQR03",403,0)
Q0101020 ;O  Patient's Size
"RTN","MAGDQR03",404,0)
 ; sensitive/employee?
"RTN","MAGDQR03",405,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",406,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",407,0)
 . Q
"RTN","MAGDQR03",408,0)
 ; no
"RTN","MAGDQR03",409,0)
 S V(T)=$P($G(^DPT(MAGDFN,57)),"^",1) ; height in cm - field not populated
"RTN","MAGDQR03",410,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",411,0)
 Q
"RTN","MAGDQR03",412,0)
 ;
"RTN","MAGDQR03",413,0)
Q0101030 ;O  Patient's Weight
"RTN","MAGDQR03",414,0)
 ; sensitive/employee?
"RTN","MAGDQR03",415,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",416,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",417,0)
 . Q
"RTN","MAGDQR03",418,0)
 ; no
"RTN","MAGDQR03",419,0)
 S V(T)=$P($G(^DPT(MAGDFN,57)),"^",2) ; weight in kg - field not populated
"RTN","MAGDQR03",420,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",421,0)
 Q
"RTN","MAGDQR03",422,0)
 ;
"RTN","MAGDQR03",423,0)
Q0102160 ;O  Ethnic Group
"RTN","MAGDQR03",424,0)
 ; sensitive/employee?
"RTN","MAGDQR03",425,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",426,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",427,0)
 . Q
"RTN","MAGDQR03",428,0)
 ; no
"RTN","MAGDQR03",429,0)
 S V(T)=$P($G(^DPT(MAGDFN,0)),"^",6)
"RTN","MAGDQR03",430,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",431,0)
 Q
"RTN","MAGDQR03",432,0)
 ;
"RTN","MAGDQR03",433,0)
Q0102180 ;O  Occupation
"RTN","MAGDQR03",434,0)
 ; sensitive/employee?
"RTN","MAGDQR03",435,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",436,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",437,0)
 . Q
"RTN","MAGDQR03",438,0)
 ; no
"RTN","MAGDQR03",439,0)
 S V(T)=$P($G(^DPT(MAGDFN,0)),"^",7)
"RTN","MAGDQR03",440,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",441,0)
 Q
"RTN","MAGDQR03",442,0)
 ;
"RTN","MAGDQR03",443,0)
Q01021B0 D Q01021B0^MAGDQR06 ;O  Additional Patient History
"RTN","MAGDQR03",444,0)
 Q
"RTN","MAGDQR03",445,0)
 ;
"RTN","MAGDQR03",446,0)
Q0104000 D Q0104000^MAGDQR06 ;O  Patient Comments
"RTN","MAGDQR03",447,0)
 Q
"RTN","MAGDQR03",448,0)
 ;
"RTN","MAGDQR03",449,0)
Q0201206 ;O  Number of Study Related Series
"RTN","MAGDQR03",450,0)
 ; sensitive/employee?
"RTN","MAGDQR03",451,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",452,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",453,0)
 . Q
"RTN","MAGDQR03",454,0)
 ; no
"RTN","MAGDQR03",455,0)
 N N,S,UID
"RTN","MAGDQR03",456,0)
 S UID=$G(V("0020,000D")),N=0
"RTN","MAGDQR03",457,0)
 I UID'=""  S S="" F  S S=$O(^MAG(2005,"P",UID,S)) Q:S=""  S N=N+1
"RTN","MAGDQR03",458,0)
 S V(T)=N
"RTN","MAGDQR03",459,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",460,0)
 Q
"RTN","MAGDQR03",461,0)
 ;
"RTN","MAGDQR03",462,0)
Q0201208 ;O  Number of Study Related Instances
"RTN","MAGDQR03",463,0)
 ; sensitive/employee?
"RTN","MAGDQR03",464,0)
 I SENSEMP D  Q  ; yes, scrub
"RTN","MAGDQR03",465,0)
 . N I S I=$O(REQ(T,"")) S:I V(T)=$S($G(REQ(T,I))]"":REQ(T,I),1:"")
"RTN","MAGDQR03",466,0)
 . Q
"RTN","MAGDQR03",467,0)
 ; no
"RTN","MAGDQR03",468,0)
 N N,P1,P2,S,UID
"RTN","MAGDQR03",469,0)
 S UID=$G(V("0020,000D")),N=0
"RTN","MAGDQR03",470,0)
 I UID'=""  S S="" F  S S=$O(^MAG(2005,"P",UID,S)) Q:S=""  D
"RTN","MAGDQR03",471,0)
 . S P1=0 F  S P1=$O(^MAG(2005,S,1,P1)) Q:'P1  D
"RTN","MAGDQR03",472,0)
 . . S P2=+$G(^MAG(2005,S,1,P1,0)) Q:'P2
"RTN","MAGDQR03",473,0)
 . . S N=N+1
"RTN","MAGDQR03",474,0)
 . . Q
"RTN","MAGDQR03",475,0)
 . Q
"RTN","MAGDQR03",476,0)
 S V(T)=N
"RTN","MAGDQR03",477,0)
 S:'$$COMPARE(T,V(T)) OK=0
"RTN","MAGDQR03",478,0)
 Q
"RTN","MAGDQR03",479,0)
 ;
"RTN","MAGDQR03",480,0)
U008010C D U008010C^MAGDQR06 ;O  Interpretation Author
"RTN","MAGDQR03",481,0)
 Q
"RTN","MAGDQR03",482,0)
 ;
"RTN","MAGDQR04")
0^13^B78024448
"RTN","MAGDQR04",1,0)
MAGDQR04 ;WOIFO/EdM/JSL/SAF - Imaging RPCs for Query/Retrieve ; 08 Aug 2008 9:26 AM
"RTN","MAGDQR04",2,0)
 ;;3.0;IMAGING;**51,54,66,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDQR04",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDQR04",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR04",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR04",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR04",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR04",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR04",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR04",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR04",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR04",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR04",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR04",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR04",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR04",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR04",17,0)
 ;;
"RTN","MAGDQR04",18,0)
 Q
"RTN","MAGDQR04",19,0)
 ;
"RTN","MAGDQR04",20,0)
STUDY(OUT,UID,PRMUID) ; RPC = MAG STUDY UID QUERY
"RTN","MAGDQR04",21,0)
 N D1,F1,F2,F3,F4,F5,F6,IMAGE,N,NET,PASS,PAT,PAT0,SERIES,USER,X
"RTN","MAGDQR04",22,0)
 I $G(UID)="" S OUT(1)="-1,No UID specified." Q
"RTN","MAGDQR04",23,0)
 I UID'?1.64(1N,1".") S OUT(1)="-2,Invalid UID format: """_UID_"""." Q
"RTN","MAGDQR04",24,0)
 S PRMUID=$G(PRMUID) S:($L(PRMUID)'=1)!(123'[PRMUID) PRMUID=0
"RTN","MAGDQR04",25,0)
 S N=1,PAT=""
"RTN","MAGDQR04",26,0)
 S SERIES="" F  S SERIES=$O(^MAG(2005,"P",UID,SERIES)) Q:SERIES=""  D
"RTN","MAGDQR04",27,0)
 . S X=$G(^MAG(2005,SERIES,0))
"RTN","MAGDQR04",28,0)
 . S PAT0=$P(X,"^",7) D:PAT0
"RTN","MAGDQR04",29,0)
 . . I PAT="" S PAT=PAT0 Q
"RTN","MAGDQR04",30,0)
 . . Q:PRMUID=1
"RTN","MAGDQR04",31,0)
 . . S:PAT'=PAT0 PAT=-1
"RTN","MAGDQR04",32,0)
 . . Q
"RTN","MAGDQR04",33,0)
 . I $P(X,"^",10) D VALID(SERIES) Q
"RTN","MAGDQR04",34,0)
 . S D1=0 F  S D1=$O(^MAG(2005,SERIES,1,D1)) Q:'D1  D
"RTN","MAGDQR04",35,0)
 . . S IMAGE=+$G(^MAG(2005,SERIES,1,D1,0)) D:IMAGE VALID(IMAGE)
"RTN","MAGDQR04",36,0)
 . . Q
"RTN","MAGDQR04",37,0)
 . Q
"RTN","MAGDQR04",38,0)
 I PAT<0 S OUT(1)="-13,Duplicate Study UID" Q
"RTN","MAGDQR04",39,0)
 S SERIES="" F  S SERIES=$O(^MAG(2005,"SERIESUID",UID,SERIES)) Q:SERIES=""  D
"RTN","MAGDQR04",40,0)
 . I $P($G(^MAG(2005,SERIES,0)),"^",10) D VALID(SERIES) Q
"RTN","MAGDQR04",41,0)
 . S D1=0 F  S D1=$O(^MAG(2005,SERIES,1,D1)) Q:'D1  D
"RTN","MAGDQR04",42,0)
 . . S IMAGE=+$G(^MAG(2005,SERIES,1,D1,0)) D:IMAGE VALID(IMAGE)
"RTN","MAGDQR04",43,0)
 . . Q
"RTN","MAGDQR04",44,0)
 . Q
"RTN","MAGDQR04",45,0)
 S X=" image" S:N'=2 X=X_"s" S X=X_" found"
"RTN","MAGDQR04",46,0)
 S OUT(1)=(N-1)_X
"RTN","MAGDQR04",47,0)
 Q
"RTN","MAGDQR04",48,0)
 ;
"RTN","MAGDQR04",49,0)
VALID(IMAGE) N T,UID,UNIQ
"RTN","MAGDQR04",50,0)
 N DATE,Q,T1,T2,T3
"RTN","MAGDQR04",51,0)
 D CHK^MAGGSQI(.X,IMAGE) I +$G(X(0))'=1 D  Q
"RTN","MAGDQR04",52,0)
 . S N=N+1,OUT(N)=IMAGE_"^-13,Questionable Integrity"
"RTN","MAGDQR04",53,0)
 . Q
"RTN","MAGDQR04",54,0)
 S UNIQ=0,UID=$P($G(^MAG(2005,IMAGE,"PACS")),"^",1) D:UID'=""
"RTN","MAGDQR04",55,0)
 . S T="" F  S T=$O(^MAG(2005,"P",UID,T)) Q:T=""  D
"RTN","MAGDQR04",56,0)
 . . S UNIQ=UNIQ+1
"RTN","MAGDQR04",57,0)
 . . S DATE($G(^MAG(2005,T,2))\1_" ",T)=""
"RTN","MAGDQR04",58,0)
 . . Q
"RTN","MAGDQR04",59,0)
 . Q
"RTN","MAGDQR04",60,0)
 S Q=0 I UNIQ>1 D  Q:Q
"RTN","MAGDQR04",61,0)
 . Q:PRMUID=1
"RTN","MAGDQR04",62,0)
 . I PRMUID=0 S Q=1,N=N+1,OUT(N)=IMAGE_"^-14,Multiple images with UID="""_UID_"""." Q
"RTN","MAGDQR04",63,0)
 . S DATE=$O(DATE(""),-PRMUID*2+5) S:DATE="" DATE="?"
"RTN","MAGDQR04",64,0)
 . S:'$D(DATE(DATE,IMAGE)) Q=1
"RTN","MAGDQR04",65,0)
 . Q
"RTN","MAGDQR04",66,0)
 S NET=$P($G(^MAG(2005,IMAGE,0)),"^",3),(USER,PASS)=""
"RTN","MAGDQR04",67,0)
 I NET S X=$G(^MAG(2005.2,NET,2)),USER=$P(X,"^",1),PASS=$P(X,"^",2)
"RTN","MAGDQR04",68,0)
 D FILEFIND^MAGDFB(IMAGE,"FULL",0,0,.F1,.F2,.F3)
"RTN","MAGDQR04",69,0)
 D FILEFIND^MAGDFB(IMAGE,"BIG",0,0,.T1,.T2,.T3)
"RTN","MAGDQR04",70,0)
 S:T2'<0 F2=T2
"RTN","MAGDQR04",71,0)
 D FILEFIND^MAGDFB(IMAGE,"TEXT",0,0,.F4,.F5,.F6)
"RTN","MAGDQR04",72,0)
 S N=N+1,OUT(N)=IMAGE_"^"_F2_"^"_USER_"^"_PASS_"^"_F5
"RTN","MAGDQR04",73,0)
 Q
"RTN","MAGDQR04",74,0)
 ;
"RTN","MAGDQR04",75,0)
INFO(OUT,IMAGE) ; RPC = MAG IMAGE CURRENT INFO
"RTN","MAGDQR04",76,0)
 ;
"RTN","MAGDQR04",77,0)
 ; 0008,0018  SOP Instance UID (Create new one, if needed)
"RTN","MAGDQR04",78,0)
 ; 0008,0020  Study Date
"RTN","MAGDQR04",79,0)
 ; 0008,0050  Accession Number
"RTN","MAGDQR04",80,0)
 ; 0008,0060  Modality
"RTN","MAGDQR04",81,0)
 ; 0008,0090  Referring Physician's Name
"RTN","MAGDQR04",82,0)
 ; 0008,1030  Study Description (may be VA procedure name)
"RTN","MAGDQR04",83,0)
 ; 0008,1050  Performing (attending) Physician
"RTN","MAGDQR04",84,0)
 ; 0010,0010  Patient Name
"RTN","MAGDQR04",85,0)
 ; 0010,0020  Patient ID
"RTN","MAGDQR04",86,0)
 ; 0010,0030  Patient's Birth Date
"RTN","MAGDQR04",87,0)
 ; 0010,0040  Patient's Sex
"RTN","MAGDQR04",88,0)
 ; 0010,1000  Other Patient IDs (= ICN, Integration Control Number)
"RTN","MAGDQR04",89,0)
 ; 0010,1040  Address
"RTN","MAGDQR04",90,0)
 ; 0010,2160  Ethnic Group
"RTN","MAGDQR04",91,0)
 ; 0010,2000  Medical Alerts
"RTN","MAGDQR04",92,0)
 ; 0020,000D  Study Instance UID
"RTN","MAGDQR04",93,0)
 ; 0020,000E  Series Instance UID
"RTN","MAGDQR04",94,0)
 ; 0020,000D  Study Instance UID
"RTN","MAGDQR04",95,0)
 ; 0032,1032  Requesting Physician
"RTN","MAGDQR04",96,0)
 ; 0032,1033  Requesting Service
"RTN","MAGDQR04",97,0)
 ; 0032,1060  Requested Procedure Description (CPT name)
"RTN","MAGDQR04",98,0)
 ; 0032,1064  Requested Procedure Code Sequence
"RTN","MAGDQR04",99,0)
 ; 0008,0100  > Code Value (CPT code)
"RTN","MAGDQR04",100,0)
 ; 0008,0102  > Coding Scheme Designator ("C4")
"RTN","MAGDQR04",101,0)
 ; 0008,0104  > Code Meaning (CPT name)
"RTN","MAGDQR04",102,0)
 ; 0038,0300  Current Patient Location (ward)
"RTN","MAGDQR04",103,0)
 ; 0032,1020  Scheduled Study Location
"RTN","MAGDQR04",104,0)
 ;
"RTN","MAGDQR04",105,0)
 N ACN,ATP,CPT,D0,D1,D2,D3,DFN,ERR,I,IT,MO,N,P,PDT,PP,REQP,RFP,RQL,T,TAG,UID,V,WRD,X
"RTN","MAGDQR04",106,0)
 I '$G(IMAGE) S OUT(1)="-1,No Image Specified." Q
"RTN","MAGDQR04",107,0)
 I '$D(^MAG(2005,IMAGE)) S OUT(1)="-2,No Such Image ("_IMAGE_")." Q
"RTN","MAGDQR04",108,0)
 ;
"RTN","MAGDQR04",109,0)
 S X=$G(^MAG(2005,IMAGE,0)),P=$P(X,"^",10)
"RTN","MAGDQR04",110,0)
 S TAG("0008,1030")=$$STYDESC^MAGUE001(IMAGE,.ERR) ; Study Description
"RTN","MAGDQR04",111,0)
 S DFN=$P(X,"^",7) D:DFN
"RTN","MAGDQR04",112,0)
 . N VA,VADM,VAPA,VAERR,DOB,TOB ; return arrays from VADPT
"RTN","MAGDQR04",113,0)
 . N I ; scratch loop array
"RTN","MAGDQR04",114,0)
 . D DEM^VADPT ; populate standard patient data array VADM()
"RTN","MAGDQR04",115,0)
 . S TAG("0010,0010")=$G(VADM(1)) ; Patient Name
"RTN","MAGDQR04",116,0)
 . S TAG("0010,0020")=$S($$ISIHS^MAGSPID():$G(VA("PID")),1:VADM(2)) ; Patient ID (HRN or SSN) - P123
"RTN","MAGDQR04",117,0)
 . S DOB=$G(VADM(3))\1+17000000 ; Patient's Birth Date
"RTN","MAGDQR04",118,0)
 . ; make sure month and year are DICOM valid
"RTN","MAGDQR04",119,0)
 . S TAG("0010,0030")=$S($E(DOB,5,6)="00":"",$E(DOB,7,8)="00":"",1:DOB)
"RTN","MAGDQR04",120,0)
 . ; Patient's Birth Time [probably always blank]
"RTN","MAGDQR04",121,0)
 . S TAG("0010,0032")=$S(VADM(3)[".":$TR($J("."_$P($G(VADM(3)),".",2)*1E6,6)," ",0),1:"")
"RTN","MAGDQR04",122,0)
 . S TAG("0010,2160")=$G(VADM(8)) ; Patient's Race
"RTN","MAGDQR04",123,0)
 . S TAG("0010,0040")=$P($G(VADM(5)),"^",1) ; Patient's Sex
"RTN","MAGDQR04",124,0)
 . S X=$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(DFN),1:"-1^NO MPI")  ;P123
"RTN","MAGDQR04",125,0)
 . S TAG("0010,1000")=$S(X<0:$E(TAG("0010,0010"),1)_$E(TAG("0010,0020"),6,99),1:X) ; Other Patient ID
"RTN","MAGDQR04",126,0)
 . D ADD^VADPT ; populate patient address array
"RTN","MAGDQR04",127,0)
 . F I=1,2,3,4,6 S $P(TAG("0010,1040"),"^",I)=$G(VAPA(I))
"RTN","MAGDQR04",128,0)
 . S $P(TAG("0010,1040"),"^",5)=$P($G(VAPA(5)),"^",2)
"RTN","MAGDQR04",129,0)
 . Q
"RTN","MAGDQR04",130,0)
 ;
"RTN","MAGDQR04",131,0)
 S:P TAG("0008,0018")=$$QRNEWUID^MAGDRPC9(IMAGE)
"RTN","MAGDQR04",132,0)
 ;
"RTN","MAGDQR04",133,0)
 S TAG("0020,000D")=$P($G(^MAG(2005,$S(P:+P,1:IMAGE),"PACS")),"^",1)
"RTN","MAGDQR04",134,0)
 S X=$P($G(^MAG(2005,IMAGE,"SERIESUID")),"^",1)
"RTN","MAGDQR04",135,0)
 S:X'="" TAG("0020,000E")=X
"RTN","MAGDQR04",136,0)
 ;
"RTN","MAGDQR04",137,0)
 ; The following references to ^RADPT are allowed according to IA # 1172
"RTN","MAGDQR04",138,0)
 S X=$G(^MAG(2005,IMAGE,2)),ACN="" D:$P(X,"^",6)=74
"RTN","MAGDQR04",139,0)
 . N P5,P7
"RTN","MAGDQR04",140,0)
 . S P5=$P(X,"^",5),P7=$P(X,"^",7),X=$G(^RARPT(+P7,0))
"RTN","MAGDQR04",141,0)
 . S D0=$P(X,"^",2),D1=9999999.9999=$P(X,"^",3),ACN=$P(X,"^",1)
"RTN","MAGDQR04",142,0)
 . Q
"RTN","MAGDQR04",143,0)
 S IT=0
"RTN","MAGDQR04",144,0)
 I ACN'="" S D0="" F  S D0=$O(^RADPT("ADC",ACN,D0)) Q:D0=""  D
"RTN","MAGDQR04",145,0)
 . S D1="" F  S D1=$O(^RADPT("ADC",ACN,D0,D1)) Q:D1=""  D
"RTN","MAGDQR04",146,0)
 . . N M1,VAIN,VAINDT
"RTN","MAGDQR04",147,0)
 . . S IT=IT+1,TAG("0008,0020",IT)=9999999.9999-D1\1+17000000 ; Study Date
"RTN","MAGDQR04",148,0)
 . . S VAINDT=9999999.9999-D1 D INP^VADPT ; Supported reference
"RTN","MAGDQR04",149,0)
 . . S:$G(VAIN(2))'="" RFP(VAIN(2))="" ; Referring Physician's Name
"RTN","MAGDQR04",150,0)
 . . S:$G(VAIN(4))'="" RFP(VAIN(4))="" ; Current Ward
"RTN","MAGDQR04",151,0)
 . . S:$G(VAIN(11))'="" ATP(VAIN(11))="" ; Performing (attending) Physician
"RTN","MAGDQR04",152,0)
 . . S D2="" F  S D2=$O(^RADPT("ADC",ACN,D0,D1,D2)) Q:D2=""  D
"RTN","MAGDQR04",153,0)
 . . . S X=$G(^RADPT(D0,"DT",D1,"P",D2,0))
"RTN","MAGDQR04",154,0)
 . . . S P=$P(X,"^",2) D:P
"RTN","MAGDQR04",155,0)
 . . . . S M1=0 F  S M1=$O(^RAMIS(71,+P,"MDL",M1)) Q:'M1  D  ; IA # 1174
"RTN","MAGDQR04",156,0)
 . . . . . S V=$P($G(^RAMIS(71,+P,"MDL",M1,0)),"^",1) Q:'V  ; IA # 1174
"RTN","MAGDQR04",157,0)
 . . . . . S V=$P($G(^RAMIS(73.1,+V,0)),"^",1) S:V'="" MO(V)="" ; IA # 1174
"RTN","MAGDQR04",158,0)
 . . . . . Q
"RTN","MAGDQR04",159,0)
 . . . . S V=$P($G(^RAMIS(71,+P,0)),"^",9) S:V CPT(+V)="" ; IA # 1174
"RTN","MAGDQR04",160,0)
 . . . . Q
"RTN","MAGDQR04",161,0)
 . . . S P=$P(X,"^",14) D:P
"RTN","MAGDQR04",162,0)
 . . . . S V=$P($G(^VA(200,+P,0)),"^",1)
"RTN","MAGDQR04",163,0)
 . . . . S:V'="" REQP(V)=""
"RTN","MAGDQR04",164,0)
 . . . . Q
"RTN","MAGDQR04",165,0)
 . . . S P=$P(X,"^",17) D:P
"RTN","MAGDQR04",166,0)
 . . . . S X=$G(^RARPT(+P,0)) Q:X=""  ; IA # 1171
"RTN","MAGDQR04",167,0)
 . . . . S V=$P(X,"^",1) S:V'="" ACN(V)=""
"RTN","MAGDQR04",168,0)
 . . . . Q
"RTN","MAGDQR04",169,0)
 . . . S P=$P(X,"^",22) D:P
"RTN","MAGDQR04",170,0)
 . . . . S X=$G(^SC(+P,0)) Q:X=""  ; IA # 10040
"RTN","MAGDQR04",171,0)
 . . . . S V=$P(X,"^",1) S:V'="" RQL(V)=""
"RTN","MAGDQR04",172,0)
 . . . . Q
"RTN","MAGDQR04",173,0)
 . . . S P=0,D3=0 F  S D3=$O(^RADPT(D0,"P",D1,"DT",D2,"H",D3)) Q:'D3  D
"RTN","MAGDQR04",174,0)
 . . . . S X=$G(^RADPT(D0,"P",D1,"DT",D2,"H",D3,0)) Q:X=""
"RTN","MAGDQR04",175,0)
 . . . . S P=P+1,TAG("0010,2000  "_$J(P,5))=X
"RTN","MAGDQR04",176,0)
 . . . . Q
"RTN","MAGDQR04",177,0)
 . . . Q
"RTN","MAGDQR04",178,0)
 . . Q
"RTN","MAGDQR04",179,0)
 . Q
"RTN","MAGDQR04",180,0)
 S V="" F  S V=$O(ACN(V)) Q:V=""  D
"RTN","MAGDQR04",181,0)
 . S IT=IT+1,TAG("0008,0050",IT)=V ; Accession Number
"RTN","MAGDQR04",182,0)
 . Q
"RTN","MAGDQR04",183,0)
 S V="" F  S V=$O(WRD(V)) Q:V=""  D
"RTN","MAGDQR04",184,0)
 . S IT=IT+1,TAG("0038,0300",IT)=$P(V,"^",2) ; Current Patient Location
"RTN","MAGDQR04",185,0)
 . Q
"RTN","MAGDQR04",186,0)
 S V="" F  S V=$O(RFP(V)) Q:V=""  D
"RTN","MAGDQR04",187,0)
 . S IT=IT+1,TAG("0008,0090",IT)=$P(V,"^",2) ; Referring Physician's Name
"RTN","MAGDQR04",188,0)
 . Q
"RTN","MAGDQR04",189,0)
 S V="" F  S V=$O(ATP(V)) Q:V=""  D
"RTN","MAGDQR04",190,0)
 . S IT=IT+1,TAG("0008,1050",IT)=$P(V,"^",2) ; Performing (attending) Physician
"RTN","MAGDQR04",191,0)
 . Q
"RTN","MAGDQR04",192,0)
 S V="" F  S V=$O(RQL(V)) Q:V=""  D
"RTN","MAGDQR04",193,0)
 . S IT=IT+1,TAG("0032,1033",IT)=V ; Requesting Service
"RTN","MAGDQR04",194,0)
 . Q
"RTN","MAGDQR04",195,0)
 S V="" F  S V=$O(MO(V)) Q:V=""  D
"RTN","MAGDQR04",196,0)
 . S IT=IT+1,TAG("0008,0060",IT)=V ; Modality
"RTN","MAGDQR04",197,0)
 . Q
"RTN","MAGDQR04",198,0)
 S V="" F  S V=$O(REQP(V)) Q:V=""  D
"RTN","MAGDQR04",199,0)
 . S IT=IT+1,TAG("0032,1032",IT)=V ; Requesting Physician
"RTN","MAGDQR04",200,0)
 . Q
"RTN","MAGDQR04",201,0)
 S V="" F  S V=$O(CPT(V)) Q:V=""  D
"RTN","MAGDQR04",202,0)
 . S X=$$CPT^ICPTCOD(V) ; IA # 1995, supported reference
"RTN","MAGDQR04",203,0)
 . Q:$P(X,"^",2)=""
"RTN","MAGDQR04",204,0)
 . S IT=IT+1
"RTN","MAGDQR04",205,0)
 . S TAG("0032,1064 0008,0100",IT)=$P(X,"^",2) ; CPT Code
"RTN","MAGDQR04",206,0)
 . S TAG("0032,1064 0008,0104",IT)=$P(X,"^",3) ; Code Meaning
"RTN","MAGDQR04",207,0)
 . S TAG("0032,1060",IT)=$P(X,"^",3) ; Requested Procedure Description
"RTN","MAGDQR04",208,0)
 . S TAG("0032,1064 0008,0102",IT)="C4" ; Coding Scheme Designator
"RTN","MAGDQR04",209,0)
 . Q
"RTN","MAGDQR04",210,0)
 ;
"RTN","MAGDQR04",211,0)
 S V=$P($G(^MAG(2005,IMAGE,100)),"^",3) D:V=""
"RTN","MAGDQR04",212,0)
 . ; Find Acquisition site when not filled in in Image File
"RTN","MAGDQR04",213,0)
 . N D0,LOC,N
"RTN","MAGDQR04",214,0)
 . S (N,D0,LOC)=0 F  S D0=$O(^MAG(2006.1,D0)) Q:'D0  D
"RTN","MAGDQR04",215,0)
 . . S N=N+1,LOC=$P($G(^MAG(2006.1,D0,0)),"^",1)
"RTN","MAGDQR04",216,0)
 . . Q
"RTN","MAGDQR04",217,0)
 . Q:N>2  ; Too many to choose from...
"RTN","MAGDQR04",218,0)
 . S:LOC V=LOC
"RTN","MAGDQR04",219,0)
 . Q
"RTN","MAGDQR04",220,0)
 S:V'="" TAG("0032,1020")=V ; Acquisition Site
"RTN","MAGDQR04",221,0)
 ;
"RTN","MAGDQR04",222,0)
 ; return names in DICOM format
"RTN","MAGDQR04",223,0)
 S:$G(TAG("0010,0010"))'="" TAG("0010,0010")=$$VA2DCM^MAGDQR01(TAG("0010,0010"))
"RTN","MAGDQR04",224,0)
 F I="0008,0090","0008,1050","0032,1032" D
"RTN","MAGDQR04",225,0)
 . N J S J=""
"RTN","MAGDQR04",226,0)
 . F  S J=$O(TAG(I,J)) Q:'J  D
"RTN","MAGDQR04",227,0)
 . . S:$G(TAG(I,J))'="" TAG(I,J)=$$VA2DCM^MAGDQR01(TAG(I,J))
"RTN","MAGDQR04",228,0)
 . . Q
"RTN","MAGDQR04",229,0)
 . Q
"RTN","MAGDQR04",230,0)
 ;
"RTN","MAGDQR04",231,0)
 S N=1,T="" F  S T=$O(TAG(T)) Q:T=""  D
"RTN","MAGDQR04",232,0)
 . S V=""
"RTN","MAGDQR04",233,0)
 . S:$D(TAG(T))#2 V=TAG(T)
"RTN","MAGDQR04",234,0)
 . S I="" F  S I=$O(TAG(T,I)) Q:I=""  S:V'="" V=V_"\" S V=V_TAG(T,I)
"RTN","MAGDQR04",235,0)
 . S:V'="" N=N+1,OUT(N)=T_"^"_V
"RTN","MAGDQR04",236,0)
 . Q
"RTN","MAGDQR04",237,0)
 ;
"RTN","MAGDQR04",238,0)
 S OUT(1)=(N-1)_" data fields returned."
"RTN","MAGDQR04",239,0)
 Q
"RTN","MAGDQR04",240,0)
 ;
"RTN","MAGDQR04",241,0)
CLEAN(OUT) ; RPC = MAG DICOM QUERY CLEANUP
"RTN","MAGDQR04",242,0)
 N D0,H,N,STAMP
"RTN","MAGDQR04",243,0)
 L +^MAGDQR(2006.5732,0):1E6 ; Background task MUST wait
"RTN","MAGDQR04",244,0)
 S D0=0 F  S D0=$O(^MAGDQR(2006.5732,D0)) Q:'D0  D
"RTN","MAGDQR04",245,0)
 . S X=$G(^MAGDQR(2006.5732,D0,0)),STAMP=$P(X,"^",3)
"RTN","MAGDQR04",246,0)
 . Q:$$FMDIFF^XLFDT(DT,STAMP,1)<5
"RTN","MAGDQR04",247,0)
 . K ^MAGDQR(2006.5732,D0)
"RTN","MAGDQR04",248,0)
 . K ^MAGDQR(2006.5732,"B",D0)
"RTN","MAGDQR04",249,0)
 . Q
"RTN","MAGDQR04",250,0)
 S (D0,N,H)=0 F  S D0=$O(^MAGDQR(2006.5732,D0)) Q:'D0  S N=N+1,H=D0
"RTN","MAGDQR04",251,0)
 S X="DICOM QUERY RETRIEVE RESULT^2006.5732^"_H_"^"_N
"RTN","MAGDQR04",252,0)
 S ^MAGDQR(2006.5732,0)=X
"RTN","MAGDQR04",253,0)
 L -^MAGDQR(2006.5732,0)
"RTN","MAGDQR04",254,0)
 Q
"RTN","MAGDQR04",255,0)
 ;
"RTN","MAGDQR21")
0^14^B160483069
"RTN","MAGDQR21",1,0)
MAGDQR21 ;WOIFO/EdM,NST,MLH,JSL,SAF - RPCs for Query/Retrieve SetUp ; 09 May 2011 4:27 PM
"RTN","MAGDQR21",2,0)
 ;;3.0;IMAGING;**83,104,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDQR21",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDQR21",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR21",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDQR21",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDQR21",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDQR21",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDQR21",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDQR21",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDQR21",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDQR21",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDQR21",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDQR21",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDQR21",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDQR21",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDQR21",17,0)
 ;;
"RTN","MAGDQR21",18,0)
 Q
"RTN","MAGDQR21",19,0)
 ;
"RTN","MAGDQR21",20,0)
GET(OUT,DEST,GATEWAY) ; RPC = MAG GET DICOM DEST
"RTN","MAGDQR21",21,0)
 N D0,D1,N,OK,X
"RTN","MAGDQR21",22,0)
 I $G(DEST)="" D  Q
"RTN","MAGDQR21",23,0)
 . S N=1
"RTN","MAGDQR21",24,0)
 . S X="" F  S X=$O(^MAG(2006.587,"B",X)) Q:X=""  S N=N+1,OUT(N)="B^"_X
"RTN","MAGDQR21",25,0)
 . S X="" F  S X=$O(^MAG(2006.587,"D",X)) Q:X=""  S N=N+1,OUT(N)="D^"_X
"RTN","MAGDQR21",26,0)
 . S OUT(1)=N
"RTN","MAGDQR21",27,0)
 . Q
"RTN","MAGDQR21",28,0)
 ;
"RTN","MAGDQR21",29,0)
 S GATEWAY=$G(GATEWAY) S:GATEWAY="--All DICOM Gateways--" GATEWAY=""
"RTN","MAGDQR21",30,0)
 S D0=0,OK=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D  Q:OK
"RTN","MAGDQR21",31,0)
 . S X=$G(^MAG(2006.587,D0,0))
"RTN","MAGDQR21",32,0)
 . Q:$P(X,"^",1)'=DEST
"RTN","MAGDQR21",33,0)
 . I GATEWAY'="",$P(X,"^",5)'=GATEWAY Q
"RTN","MAGDQR21",34,0)
 . S OK=1,N=6
"RTN","MAGDQR21",35,0)
 . S OUT(2)="2^"_$P(X,"^",2)
"RTN","MAGDQR21",36,0)
 . S OUT(3)="3^"_$P(X,"^",3)
"RTN","MAGDQR21",37,0)
 . S OUT(4)="4^"_$P(X,"^",4)
"RTN","MAGDQR21",38,0)
 . S OUT(5)="5^"_$P(X,"^",6)
"RTN","MAGDQR21",39,0)
 . S OUT(6)="6^"_$P(X,"^",7)
"RTN","MAGDQR21",40,0)
 . S D1=0 F  S D1=$O(^MAG(2006.587,D0,1,D1)) Q:'D1  D
"RTN","MAGDQR21",41,0)
 . . S X=$G(^MAG(2006.587,D0,1,D1,0)) Q:$P(X,"^",1)=""
"RTN","MAGDQR21",42,0)
 . . S N=N+1,OUT(N)=X
"RTN","MAGDQR21",43,0)
 . . Q
"RTN","MAGDQR21",44,0)
 . Q
"RTN","MAGDQR21",45,0)
 S OUT(1)=N
"RTN","MAGDQR21",46,0)
 Q
"RTN","MAGDQR21",47,0)
 ;
"RTN","MAGDQR21",48,0)
SET(OUT,DATA,DEST,GATEWAY) ; RPC = MAG SET DICOM DEST
"RTN","MAGDQR21",49,0)
 N D0,D1,I,N,P,Q,O1,O5,O7,OK,T,X
"RTN","MAGDQR21",50,0)
 I $G(DEST)="" S OUT="-1,No Destination Specified." Q
"RTN","MAGDQR21",51,0)
 ;
"RTN","MAGDQR21",52,0)
 S I="" F  S I=$O(DATA(I)) Q:I=""  D
"RTN","MAGDQR21",53,0)
 . S T=DATA(I) Q:T'["^"
"RTN","MAGDQR21",54,0)
 . I +T=2 S P(2)=$P(T,"^",2) Q
"RTN","MAGDQR21",55,0)
 . I +T=3 S P(3)=$P(T,"^",2) Q
"RTN","MAGDQR21",56,0)
 . I +T=4 S P(4)=$P(T,"^",2) Q
"RTN","MAGDQR21",57,0)
 . I +T=5 S P(6)=$P(T,"^",2) Q
"RTN","MAGDQR21",58,0)
 . I +T=6 S P(7)=$P(T,"^",2) Q
"RTN","MAGDQR21",59,0)
 . S Q($P(T,"^",1))=(+$P(T,"^",2))_"^"_(+$P(T,"^",3))
"RTN","MAGDQR21",60,0)
 . Q
"RTN","MAGDQR21",61,0)
 ;
"RTN","MAGDQR21",62,0)
 S OUT=0
"RTN","MAGDQR21",63,0)
 S GATEWAY=$G(GATEWAY) S:GATEWAY="--All DICOM Gateways--" GATEWAY=""
"RTN","MAGDQR21",64,0)
 S D0=0,OK=0 F  S D0=$O(^MAG(2006.587,D0)) Q:'D0  D  Q:OK
"RTN","MAGDQR21",65,0)
 . S X=$G(^MAG(2006.587,D0,0)),O1=$P(X,"^",1),O5=$P(X,"^",5),O7=$P(X,"^",7)
"RTN","MAGDQR21",66,0)
 . Q:O1'=DEST
"RTN","MAGDQR21",67,0)
 . I GATEWAY'="",O5'=GATEWAY Q
"RTN","MAGDQR21",68,0)
 . S:GATEWAY'="" OK=1 S OUT=OUT+1
"RTN","MAGDQR21",69,0)
 . I O1'="",O5'="",O7'="" K ^MAG(2006.587,"C",O1,O7,O5,D0)
"RTN","MAGDQR21",70,0)
 . I O5'="",O7'="" K ^MAG(2006.587,"D",O5,O7,D0)
"RTN","MAGDQR21",71,0)
 . S I="" F  S I=$O(P(I)) Q:I=""  S:P(I)'="" $P(X,"^",I)=P(I)
"RTN","MAGDQR21",72,0)
 . S:$G(P(7))'="" O7=P(7)
"RTN","MAGDQR21",73,0)
 . S ^MAG(2006.587,D0,0)=X
"RTN","MAGDQR21",74,0)
 . I O1'="",O5'="",O7'="" S ^MAG(2006.587,"C",O1,O7,O5,D0)=""
"RTN","MAGDQR21",75,0)
 . I O5'="",O7'="" S ^MAG(2006.587,"D",O5,O7,D0)=""
"RTN","MAGDQR21",76,0)
 . K ^MAG(2006.587,D0,1)
"RTN","MAGDQR21",77,0)
 . S D1=0,I="" F  S I=$O(Q(I)) Q:I=""  D
"RTN","MAGDQR21",78,0)
 . . S D1=D1+1,^MAG(2006.587,D0,1,D1,0)=I_"^"_Q(I)
"RTN","MAGDQR21",79,0)
 . . S ^MAG(2006.587,D0,1,"B",I,D1)=""
"RTN","MAGDQR21",80,0)
 . . Q
"RTN","MAGDQR21",81,0)
 . S:D1 ^MAG(2006.587,D0,1,0)="^2006.5871SA^"_D1_"^"_D1
"RTN","MAGDQR21",82,0)
 . Q
"RTN","MAGDQR21",83,0)
 Q
"RTN","MAGDQR21",84,0)
 ;
"RTN","MAGDQR21",85,0)
TMPOUT(NAME) N X
"RTN","MAGDQR21",86,0)
 S X=$$RTRNFMT^XWBLIB("GLOBAL ARRAY",1)
"RTN","MAGDQR21",87,0)
 S X=$NA(^TMP("MAG",$J,NAME))
"RTN","MAGDQR21",88,0)
 K @X
"RTN","MAGDQR21",89,0)
 Q X
"RTN","MAGDQR21",90,0)
 ;
"RTN","MAGDQR21",91,0)
STUDY1(OUT,STUDIES) ; RPC = MAG DOD GET STUDIES UID
"RTN","MAGDQR21",92,0)
 N I,N,STUDY,UID
"RTN","MAGDQR21",93,0)
 S N=1 S OUT=$$TMPOUT("STUDY")
"RTN","MAGDQR21",94,0)
 S UID=$G(STUDIES) S:UID'="" STUDY(UID)=""
"RTN","MAGDQR21",95,0)
 S I="" F  S I=$O(STUDIES(I)) Q:I=""  S UID=$G(STUDIES(I)) S:UID'="" STUDY(UID)=""
"RTN","MAGDQR21",96,0)
 S UID="" F  S UID=$O(STUDY(UID)) Q:UID=""  D STUDY(UID)
"RTN","MAGDQR21",97,0)
 S @OUT@(1)=N-1
"RTN","MAGDQR21",98,0)
 Q
"RTN","MAGDQR21",99,0)
 ;
"RTN","MAGDQR21",100,0)
STUDY2(OUT,GROUPS,REQDFN,IMGLESS) ; RPC = MAG DOD GET STUDIES IEN
"RTN","MAGDQR21",101,0)
 ; CR, 5-28-09
"RTN","MAGDQR21",102,0)
 ; IMGLESS is a new flag to speed up queries: if=1 (true), just get study-level 
"RTN","MAGDQR21",103,0)
 ; data, if null or zero get everything. This new flag is optional.
"RTN","MAGDQR21",104,0)
 N I0,I,N,P0,STUDY,UID
"RTN","MAGDQR21",105,0)
 S REQDFN=$G(REQDFN),IMGLESS=$G(IMGLESS)
"RTN","MAGDQR21",106,0)
 S N=1 S OUT=$$TMPOUT("STUDY")
"RTN","MAGDQR21",107,0)
 S I0=$G(GROUPS) D  S I="" F  S I=$O(GROUPS(I)) Q:I=""  S I0=$G(GROUPS(I)) D
"RTN","MAGDQR21",108,0)
 . Q:'I0
"RTN","MAGDQR21",109,0)
 . F  S P0=$P($G(^MAG(2005,+I0,0)),"^",10) Q:'P0  S I0=P0
"RTN","MAGDQR21",110,0)
 . S UID=$P($G(^MAG(2005,+I0,"PACS")),"^",1) S:UID="" UID="?"
"RTN","MAGDQR21",111,0)
 . S STUDY(UID,I0)=""
"RTN","MAGDQR21",112,0)
 . Q
"RTN","MAGDQR21",113,0)
 S UID="" F  S UID=$O(STUDY(UID)) Q:UID=""  D
"RTN","MAGDQR21",114,0)
 . I UID="?" D  Q
"RTN","MAGDQR21",115,0)
 . . S I0=""
"RTN","MAGDQR21",116,0)
 . . F  S I0=$O(STUDY(UID,I0)) Q:I0=""  D STUDY("",I0,REQDFN,IMGLESS)
"RTN","MAGDQR21",117,0)
 . . Q
"RTN","MAGDQR21",118,0)
 . D STUDY(UID,"",REQDFN,IMGLESS)  ; UID is not "?"
"RTN","MAGDQR21",119,0)
 . Q
"RTN","MAGDQR21",120,0)
 S @OUT@(1)=N-1
"RTN","MAGDQR21",121,0)
 Q
"RTN","MAGDQR21",122,0)
 ;
"RTN","MAGDQR21",123,0)
STUDY(UID,IEN,REQDFN,IMGLESS) ;
"RTN","MAGDQR21",124,0)
 N D0,D1,DFN,F1,F2,F3,I0,IMGCNT,IMGINFO,MAGR0,OBJGRP,OVRDDFN,PAT,QINTEG,STUDY,STUMO,X
"RTN","MAGDQR21",125,0)
 N SERIESARRAY ; array of series numbers for this study
"RTN","MAGDQR21",126,0)
 N TOTIMAGES ; total number of images for all series in this study
"RTN","MAGDQR21",127,0)
 N PATCOUNT ; array of patients having studies with the requested study instance UID
"RTN","MAGDQR21",128,0)
 ;
"RTN","MAGDQR21",129,0)
 S N=N+1,@OUT@(N)="NEXT_STUDY|"_UID_"|"_IEN
"RTN","MAGDQR21",130,0)
 I UID'="" S D0="" F  S D0=$O(^MAG(2005,"P",UID,D0)) Q:D0=""  D
"RTN","MAGDQR21",131,0)
 . S:'$P($G(^MAG(2005,D0,0)),"^",10) STUDY(D0)="" ; Get only image IEN
"RTN","MAGDQR21",132,0)
 . Q
"RTN","MAGDQR21",133,0)
 D:$G(IEN)
"RTN","MAGDQR21",134,0)
 . S:'$P($G(^MAG(2005,IEN,0)),"^",10) STUDY(IEN)="" ; Get only image IEN
"RTN","MAGDQR21",135,0)
 . Q
"RTN","MAGDQR21",136,0)
 Q:'$O(STUDY(""))
"RTN","MAGDQR21",137,0)
 S TOTIMAGES=0
"RTN","MAGDQR21",138,0)
 S D0="" F  S D0=$O(STUDY(D0)) Q:D0=""  D
"RTN","MAGDQR21",139,0)
 . S DFN=+$P($G(^MAG(2005,D0,0)),"^",7),PATCOUNT(DFN)=""
"RTN","MAGDQR21",140,0)
 . D  ; add to patient array unless single pt was requested and this isn't that pt
"RTN","MAGDQR21",141,0)
 . . I REQDFN'=DFN Q
"RTN","MAGDQR21",142,0)
 . . S:'$D(^MAG(2005,D0,1)) TOTIMAGES=TOTIMAGES+1 ; a single image (e.g., photo ID), not a group
"RTN","MAGDQR21",143,0)
 . . S PAT(DFN,D0)=""
"RTN","MAGDQR21",144,0)
 . . Q
"RTN","MAGDQR21",145,0)
 . S D1=0 F  S D1=$O(^MAG(2005,D0,1,D1)) Q:'D1  D
"RTN","MAGDQR21",146,0)
 . . S I0=+$G(^MAG(2005,D0,1,D1,0)) Q:'I0
"RTN","MAGDQR21",147,0)
 . . S DFN=+$P($G(^MAG(2005,I0,0)),"^",7),PATCOUNT(DFN)=""  ; Group DFN
"RTN","MAGDQR21",148,0)
 . . D  ; increment image count unless single pt was requested and this isn't that pt
"RTN","MAGDQR21",149,0)
 . . . I REQDFN'=DFN Q
"RTN","MAGDQR21",150,0)
 . . . S TOTIMAGES=TOTIMAGES+1
"RTN","MAGDQR21",151,0)
 . . . Q
"RTN","MAGDQR21",152,0)
 . . Q
"RTN","MAGDQR21",153,0)
 . Q
"RTN","MAGDQR21",154,0)
 ;
"RTN","MAGDQR21",155,0)
 S PAT=0,DFN="" F  S DFN=$O(PATCOUNT(DFN)) Q:DFN=""  S PATCOUNT=$G(PATCOUNT)+1
"RTN","MAGDQR21",156,0)
 I PATCOUNT>1 D  Q:'REQDFN  Q:'$D(PAT(REQDFN))
"RTN","MAGDQR21",157,0)
 . ; duplicate study instance UID?
"RTN","MAGDQR21",158,0)
 . S N=N+1,@OUT@(N)="STUDY_ERR|"_UID_"|"_PATCOUNT_" different patients"
"RTN","MAGDQR21",159,0)
 . Q
"RTN","MAGDQR21",160,0)
 ;
"RTN","MAGDQR21",161,0)
 S:UID'="" N=N+1,@OUT@(N)="STUDY_UID|"_UID
"RTN","MAGDQR21",162,0)
 S I0=$O(PAT(REQDFN,""))
"RTN","MAGDQR21",163,0)
 I 'I0 S N=N+1,@OUT@(N)="STUDY_ERR|"_UID_"|Matching study not found for patient "_REQDFN Q
"RTN","MAGDQR21",164,0)
 S OBJGRP=$$ONEGROUP(I0) ; get the first image IEN for group/image I0
"RTN","MAGDQR21",165,0)
 S N=N+1,@OUT@(N)="STUDY_IEN|"_I0_"|"_TOTIMAGES_"|"_OBJGRP_"|"_$$CPTCODE(I0)_"|"_$$GETSITE1(OBJGRP)
"RTN","MAGDQR21",166,0)
 ;
"RTN","MAGDQR21",167,0)
 ; check integrity of study record, bail out unless DFN is specified
"RTN","MAGDQR21",168,0)
 ; and matches study DFN (VA internal use only!)
"RTN","MAGDQR21",169,0)
 D CHK^MAGGSQI(.X,I0) S QINTEG='$G(X(0)) D:QINTEG
"RTN","MAGDQR21",170,0)
 . S @OUT@(N)=@OUT@(N)_"|"_$P($G(X(0)),"^",2)
"RTN","MAGDQR21",171,0)
 . Q
"RTN","MAGDQR21",172,0)
 ; override QI check only if image DFN = DFN specified in call
"RTN","MAGDQR21",173,0)
 ; (VA internal only!)
"RTN","MAGDQR21",174,0)
 I QINTEG Q:'REQDFN  Q:$P($G(^MAG(2005,I0,0)),"^",7)'=REQDFN
"RTN","MAGDQR21",175,0)
 ;
"RTN","MAGDQR21",176,0)
 S N=N+1,@OUT@(N)="STUDY_PAT|"_REQDFN_"|"_$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(REQDFN),1:"-1^NO MPI")_"|"_$P($G(^DPT(REQDFN,0)),"^",1)
"RTN","MAGDQR21",177,0)
 ;
"RTN","MAGDQR21",178,0)
 ; CR, 5-28-09
"RTN","MAGDQR21",179,0)
 ; For study-level data stop here without additional checks 
"RTN","MAGDQR21",180,0)
 Q:IMGLESS=1
"RTN","MAGDQR21",181,0)
 ;end of check above
"RTN","MAGDQR21",182,0)
 ;
"RTN","MAGDQR21",183,0)
 S D0="" F  S D0=$O(PAT(REQDFN,D0)) Q:D0=""  D
"RTN","MAGDQR21",184,0)
 . N ANY,I,INUM,SERID,SERIES,SNUM,STS,TMP,U1
"RTN","MAGDQR21",185,0)
 . K ^TMP("MAG",$J,"S")
"RTN","MAGDQR21",186,0)
 . K ^TMP("MAG",$J,"M")
"RTN","MAGDQR21",187,0)
 . D  ; retrieve info for either single or group image
"RTN","MAGDQR21",188,0)
 . . I $D(^MAG(2005,D0,1)) D  Q  ; image is part of a group
"RTN","MAGDQR21",189,0)
 . . . ; allow return of info if DFN defined
"RTN","MAGDQR21",190,0)
 . . . D GROUP^MAGGTIG(.TMP,D0,REQDFN)
"RTN","MAGDQR21",191,0)
 . . . Q
"RTN","MAGDQR21",192,0)
 . . D  ; DEFAULT - image is a single
"RTN","MAGDQR21",193,0)
 . . . N X
"RTN","MAGDQR21",194,0)
 . . . D IMAGEINF^MAGGTU3(.X,D0,REQDFN)
"RTN","MAGDQR21",195,0)
 . . . S TMP=$NA(^TMP("MAGGTIG",$J))
"RTN","MAGDQR21",196,0)
 . . . K @TMP S @TMP@(0)="1^1",@TMP@(1)=X(0)
"RTN","MAGDQR21",197,0)
 . . . Q
"RTN","MAGDQR21",198,0)
 . . Q
"RTN","MAGDQR21",199,0)
 . D:$E($G(TMP),1,5)="^TMP("
"RTN","MAGDQR21",200,0)
 . . N D,G,M,P,X
"RTN","MAGDQR21",201,0)
 . . K @TMP@(0)
"RTN","MAGDQR21",202,0)
 . . S I="" F  S I=$O(@TMP@(I)) Q:I=""  D
"RTN","MAGDQR21",203,0)
 . . . S X=$G(@TMP@(I)),D=$P(X,"^",2) Q:'D
"RTN","MAGDQR21",204,0)
 . . . ; Only if those two pieces really aren't used:
"RTN","MAGDQR21",205,0)
 . . . ;;S $P(X,"^",3)=""
"RTN","MAGDQR21",206,0)
 . . . ;;S $P(X,"^",4)=""
"RTN","MAGDQR21",207,0)
 . . . S ^TMP("MAG",$J,"S",D)=X
"RTN","MAGDQR21",208,0)
 . . . S X=$G(^MAG(2005,D,0)),G=+$P(X,"^",10)
"RTN","MAGDQR21",209,0)
 . . . S M=$P(X,"^",8) S:$E(M,1,4)="RAD " M=$E(M,5,$L(M)) Q:M=""
"RTN","MAGDQR21",210,0)
 . . . S G=$P($G(^MAG(2005,G,2)),"^",6),P=$P($G(^MAG(2005,D,2)),"^",6)
"RTN","MAGDQR21",211,0)
 . . . I P'=74,G'=74 Q
"RTN","MAGDQR21",212,0)
 . . . S ^TMP("MAG",$J,"M",1,D)=M,STUMO(M)=""
"RTN","MAGDQR21",213,0)
 . . . S G=$G(^MAG(2005,D,"SERIESUID"))
"RTN","MAGDQR21",214,0)
 . . . S:G'="" ^TMP("MAG",$J,"M",2,G,M)=""
"RTN","MAGDQR21",215,0)
 . . . Q
"RTN","MAGDQR21",216,0)
 . . Q
"RTN","MAGDQR21",217,0)
 . S (ANY,D1)=0 F  S D1=$O(^MAG(2005,D0,1,D1)) Q:'D1  D
"RTN","MAGDQR21",218,0)
 . . S X=$G(^MAG(2005,D0,1,D1,0)),I0=+X Q:'I0
"RTN","MAGDQR21",219,0)
 . . S ANY=1,I0=+X,SNUM=$P(X,"^",2),INUM=$P(X,"^",3)
"RTN","MAGDQR21",220,0)
 . . S U1=$G(^MAG(2005,I0,"SERIESUID"))
"RTN","MAGDQR21",221,0)
 . . S:SNUM="" SNUM="?" S:INUM="" INUM="?" S:U1="" U1="?"
"RTN","MAGDQR21",222,0)
 . . S SERIES(U1_"_"_SNUM,INUM,I0)="",SERID(U1_"_"_SNUM,U1)=""
"RTN","MAGDQR21",223,0)
 . . Q
"RTN","MAGDQR21",224,0)
 . D:'ANY
"RTN","MAGDQR21",225,0)
 . . S U1=$G(^MAG(2005,D0,"SERIESUID")) S:U1="" U1="?"
"RTN","MAGDQR21",226,0)
 . . S SERIES(U1_"_1",1,D0)="",SERID(U1_"_1",U1)=""
"RTN","MAGDQR21",227,0)
 . . Q
"RTN","MAGDQR21",228,0)
 . S SNUM="" F  S SNUM=$O(SERIES(SNUM)) Q:SNUM=""  D
"RTN","MAGDQR21",229,0)
 . . ; refresh temp image index
"RTN","MAGDQR21",230,0)
 . . N MAGTI S MAGTI=0 ; temp image index
"RTN","MAGDQR21",231,0)
 . . K ^TMP("MAG",$J,"TI")
"RTN","MAGDQR21",232,0)
 . . ;
"RTN","MAGDQR21",233,0)
 . . ; seek qualifying images (no QI or matching known DFN)
"RTN","MAGDQR21",234,0)
 . . S INUM="" F  S INUM=$O(SERIES(SNUM,INUM)) Q:INUM=""  D
"RTN","MAGDQR21",235,0)
 . . . S I0="" F  S I0=$O(SERIES(SNUM,INUM,I0)) Q:I0=""  D
"RTN","MAGDQR21",236,0)
 . . . . ; if dup study instance UID, purge image info and bail out
"RTN","MAGDQR21",237,0)
 . . . . ; unless pt is specified and this image is for that pt
"RTN","MAGDQR21",238,0)
 . . . . S MAGR0=$G(^MAG(2005,I0,0))
"RTN","MAGDQR21",239,0)
 . . . . I REQDFN,$P(MAGR0,"^",7)'=REQDFN K ^TMP("MAG",$J,"S",I0) Q
"RTN","MAGDQR21",240,0)
 . . . . ;
"RTN","MAGDQR21",241,0)
 . . . . S X=$P($G(^MAG(2005,I0,"PACS")),"^",1)
"RTN","MAGDQR21",242,0)
 . . . . S MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="NEXT_IMAGE"
"RTN","MAGDQR21",243,0)
 . . . . S:X'="" MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="IMAGE_UID|"_X
"RTN","MAGDQR21",244,0)
 . . . . S MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="IMAGE_IEN|"_I0
"RTN","MAGDQR21",245,0)
 . . . . S X=$P(MAGR0,"^",10)
"RTN","MAGDQR21",246,0)
 . . . . S:X MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="GROUP_IEN|"_X
"RTN","MAGDQR21",247,0)
 . . . . ; QI check - override only if DFN specified in call
"RTN","MAGDQR21",248,0)
 . . . . ; (VA internal only!)
"RTN","MAGDQR21",249,0)
 . . . . D CHK^MAGGSQI(.X,I0) I '$G(X(0)) D  Q:'REQDFN
"RTN","MAGDQR21",250,0)
 . . . . . S MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="IMAGE_ERR|"_$P($G(X(0)),"^",2)
"RTN","MAGDQR21",251,0)
 . . . . . Q
"RTN","MAGDQR21",252,0)
 . . . . ;
"RTN","MAGDQR21",253,0)
 . . . . S:INUM'="?" MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="IMAGE_NUMBER|"_INUM
"RTN","MAGDQR21",254,0)
 . . . . S IMGINFO=$G(^TMP("MAG",$J,"S",I0)) K ^TMP("MAG",$J,"S",I0)
"RTN","MAGDQR21",255,0)
 . . . . ; Get Site image parameters IEN from 16^ piece of IMGINFO
"RTN","MAGDQR21",256,0)
 . . . . S:IMGINFO'="" MAGTI=MAGTI+1,^TMP("MAG",$J,"TI",MAGTI)="IMAGE_INFO|"_IMGINFO_"|"_$$GETSNUM($P(IMGINFO,"^",16))
"RTN","MAGDQR21",257,0)
 . . . . Q
"RTN","MAGDQR21",258,0)
 . . . Q
"RTN","MAGDQR21",259,0)
 . . D:$D(^TMP("MAG",$J,"TI"))  ; qualifying images were found
"RTN","MAGDQR21",260,0)
 . . . S U1="" F  S U1=$O(SERID(SNUM,U1)) Q:U1=""  D
"RTN","MAGDQR21",261,0)
 . . . . N M,X
"RTN","MAGDQR21",262,0)
 . . . . S N=N+1,@OUT@(N)="NEXT_SERIES"
"RTN","MAGDQR21",263,0)
 . . . . S:U1'="?" N=N+1,@OUT@(N)="SERIES_UID|"_U1
"RTN","MAGDQR21",264,0)
 . . . . S N=N+1,@OUT@(N)="SERIES_IEN|"_D0
"RTN","MAGDQR21",265,0)
 . . . . ; Officially, there can be only one modality per series,
"RTN","MAGDQR21",266,0)
 . . . . ; so stop when the first modality is found...
"RTN","MAGDQR21",267,0)
 . . . . S X="",M="" F  S M=$O(^TMP("MAG",$J,"M",2,U1,M)) Q:M=""  D  Q:X'=""
"RTN","MAGDQR21",268,0)
 . . . . . S X=$S(X'="":"\",1:"")_M
"RTN","MAGDQR21",269,0)
 . . . . . Q
"RTN","MAGDQR21",270,0)
 . . . . S:X'="" N=N+1,@OUT@(N)="SERIES_MODALITY|"_X
"RTN","MAGDQR21",271,0)
 . . . . Q
"RTN","MAGDQR21",272,0)
 . . . D:SNUM'="?"  ; assign the series number
"RTN","MAGDQR21",273,0)
 . . . . N SERIESNUM
"RTN","MAGDQR21",274,0)
 . . . . D  ; - get series no from study itself if possible, else generate
"RTN","MAGDQR21",275,0)
 . . . . . N SERIESTEST,SGN
"RTN","MAGDQR21",276,0)
 . . . . . S SERIESTEST=$P(SNUM,"_",2)
"RTN","MAGDQR21",277,0)
 . . . . . Q:"+-1234567890"'[$E(SERIESTEST,1)  ; invalid number
"RTN","MAGDQR21",278,0)
 . . . . . S:"+-"[$E(SERIESTEST,1) SGN=$E(SERIESTEST,1)
"RTN","MAGDQR21",279,0)
 . . . . . S:$D(SGN) SERIESTEST=$E(SERIESTEST,2,$L(SERIESTEST))
"RTN","MAGDQR21",280,0)
 . . . . . Q:SERIESTEST'?1.12N
"RTN","MAGDQR21",281,0)
 . . . . . S SERIESTEST=$G(SGN)_SERIESTEST
"RTN","MAGDQR21",282,0)
 . . . . . Q:$D(SERIESARRAY(SERIESTEST))
"RTN","MAGDQR21",283,0)
 . . . . . S SERIESNUM=SERIESTEST
"RTN","MAGDQR21",284,0)
 . . . . . Q
"RTN","MAGDQR21",285,0)
 . . . . D:'$D(SERIESNUM)  ; still need to generate
"RTN","MAGDQR21",286,0)
 . . . . . F SERIESNUM=1:1 Q:'$D(SERIESARRAY(SERIESNUM))
"RTN","MAGDQR21",287,0)
 . . . . . Q
"RTN","MAGDQR21",288,0)
 . . . . S N=N+1,@OUT@(N)="SERIES_NUMBER|"_SERIESNUM
"RTN","MAGDQR21",289,0)
 . . . . S SERIESARRAY(SERIESNUM)=""
"RTN","MAGDQR21",290,0)
 . . . . Q
"RTN","MAGDQR21",291,0)
 . . . S MAGTI=""
"RTN","MAGDQR21",292,0)
 . . . F  S MAGTI=$O(^TMP("MAG",$J,"TI",MAGTI)) Q:'MAGTI  D
"RTN","MAGDQR21",293,0)
 . . . . S N=N+1,@OUT@(N)=^TMP("MAG",$J,"TI",MAGTI)
"RTN","MAGDQR21",294,0)
 . . . . Q
"RTN","MAGDQR21",295,0)
 . . . K ^TMP("MAG",$J,"TI")
"RTN","MAGDQR21",296,0)
 . . . Q
"RTN","MAGDQR21",297,0)
 . . Q
"RTN","MAGDQR21",298,0)
 . S I="" F  S I=$O(^TMP("MAG",$J,"S",I)) Q:I=""  D
"RTN","MAGDQR21",299,0)
 . . S N=N+1,@OUT@(N)="UNUSED_GROUP_INFO|"_^TMP("MAG",$J,"S",I)
"RTN","MAGDQR21",300,0)
 . . Q
"RTN","MAGDQR21",301,0)
 . K ^TMP("MAG",$J,"S")
"RTN","MAGDQR21",302,0)
 . K ^TMP("MAG",$J,"M")
"RTN","MAGDQR21",303,0)
 . Q
"RTN","MAGDQR21",304,0)
 D  ; list all modalities
"RTN","MAGDQR21",305,0)
 . N M,X
"RTN","MAGDQR21",306,0)
 . S X="",M="" F  S M=$O(STUMO(M)) Q:M=""  S X=X_$S(X'="":",",1:"")_M
"RTN","MAGDQR21",307,0)
 . S:X'="" N=N+1,@OUT@(N)="STUDY_MODALITY|"_X
"RTN","MAGDQR21",308,0)
 . Q
"RTN","MAGDQR21",309,0)
 Q
"RTN","MAGDQR21",310,0)
 ;
"RTN","MAGDQR21",311,0)
ONEGROUP(GROUP) ; Get the first IMAGE_IEN for this group
"RTN","MAGDQR21",312,0)
 N D1,IMGIEN
"RTN","MAGDQR21",313,0)
 I '$D(^MAG(2005,GROUP,1)) Q GROUP ; a single image (e.g., photo ID), not a group
"RTN","MAGDQR21",314,0)
 S IMGIEN=""
"RTN","MAGDQR21",315,0)
 S D1=$O(^MAG(2005,GROUP,1,0))
"RTN","MAGDQR21",316,0)
 I D1>0 S IMGIEN=+$G(^MAG(2005,GROUP,1,D1,0))
"RTN","MAGDQR21",317,0)
 I IMGIEN'>0 S IMGIEN="0^Error 1 - First Image not available"
"RTN","MAGDQR21",318,0)
 Q IMGIEN
"RTN","MAGDQR21",319,0)
 ;
"RTN","MAGDQR21",320,0)
CPTCODE(MAGIEN) ; Returns CPT code by IEN (image pointer) in IMAGE file (#2005) 
"RTN","MAGDQR21",321,0)
 ; MAGIEN = IEN in IMAGE file (#2005)
"RTN","MAGDQR21",322,0)
 N RAIEN,CPTCODE
"RTN","MAGDQR21",323,0)
 S RAIEN=+$$GET1^DIQ(2005,MAGIEN,62,"I")  ; Get PACS PROCEDURE field #62
"RTN","MAGDQR21",324,0)
 S CPTCODE=$P($G(^RAMIS(71,RAIEN,0)),"^",9) ; IA # 1174  get CPT Code
"RTN","MAGDQR21",325,0)
 Q:CPTCODE="" ""  ; quit with empty code
"RTN","MAGDQR21",326,0)
 S CPTCODE=$$CPT^ICPTCOD(CPTCODE) ; IA # 1995, supported reference
"RTN","MAGDQR21",327,0)
 Q $P(CPTCODE,"^",2) ; Return the code
"RTN","MAGDQR21",328,0)
 ;
"RTN","MAGDQR21",329,0)
GETSITE1(MAGIEN) ; Returns STATION NUMBER where the image is stored
"RTN","MAGDQR21",330,0)
 ; MAGIEN = IEN in IMAGE file (#2005)
"RTN","MAGDQR21",331,0)
 N MAGNODE,TMP,NLOCIEN,PLC
"RTN","MAGDQR21",332,0)
 N SITEIEN,SITENUM
"RTN","MAGDQR21",333,0)
 I MAGIEN'>0 Q ""
"RTN","MAGDQR21",334,0)
 D:'$D(MAGJOB("NETPLC")) NETPLCS^MAGGTU6 ; Initialize MAGJOB("NETPLC")
"RTN","MAGDQR21",335,0)
 S MAGNODE=$$NODE^MAGGI11(MAGIEN)
"RTN","MAGDQR21",336,0)
 I MAGNODE="" Q ""
"RTN","MAGDQR21",337,0)
 S TMP=$G(@MAGNODE@(0))
"RTN","MAGDQR21",338,0)
 S NLOCIEN=+$S($P(TMP,U,3):$P(TMP,U,3),1:$P(TMP,U,5)) ; Get IEN in NETWORK LOCATION file (#2005.2)
"RTN","MAGDQR21",339,0)
 S PLC=$P($G(MAGJOB("NETPLC",NLOCIEN)),U,1)     ; Imaging Site Parameters IEN
"RTN","MAGDQR21",340,0)
 Q $$GETSNUM(PLC)  ; Return STATION NUMBER
"RTN","MAGDQR21",341,0)
 ;
"RTN","MAGDQR21",342,0)
GETSNUM(MAGPLC) ; Returns STATION NUMBER by Image Site Parameters IEN
"RTN","MAGDQR21",343,0)
 ; MAGPLC - IEN in IMAGING SITE PARAMETERS file (#2006.1)
"RTN","MAGDQR21",344,0)
 I MAGPLC'>0 Q ""
"RTN","MAGDQR21",345,0)
 N SITEIEN,SITENUM
"RTN","MAGDQR21",346,0)
 S SITEIEN=$P($G(^MAG(2006.1,MAGPLC,0)),U,1)    ; Get Station IEN in INSTITUTION file (#4)
"RTN","MAGDQR21",347,0)
 Q:SITEIEN="" ""  ; if SITE IEN is not defined return blank
"RTN","MAGDQR21",348,0)
 S SITENUM=$P($$NS^XUAF4(SITEIEN),U,2)      ; IA #2171  Get Station Number
"RTN","MAGDQR21",349,0)
 Q SITENUM
"RTN","MAGDRA1")
0^15^B21556631
"RTN","MAGDRA1",1,0)
MAGDRA1 ;WOIFO/LB,JSL,SAF -Routine for DICOM fix ; 09/15/2004  13:34
"RTN","MAGDRA1",2,0)
 ;;3.0;IMAGING;**10,11,30,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRA1",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRA1",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA1",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRA1",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRA1",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRA1",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRA1",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRA1",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRA1",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRA1",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRA1",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRA1",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRA1",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRA1",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA1",17,0)
 ;;
"RTN","MAGDRA1",18,0)
 Q
"RTN","MAGDRA1",19,0)
LOOP ;Loop thru ^TMP($J,"RAE1" global
"RTN","MAGDRA1",20,0)
 ;MAGDFN should exist.
"RTN","MAGDRA1",21,0)
 ;MAGNME,MAGPID may exist.
"RTN","MAGDRA1",22,0)
 Q:'$D(^TMP($J,"RAE1"))!('$D(MAGDFN))
"RTN","MAGDRA1",23,0)
 N CCASE,CASE,CDATE,CODE,DATA,DATE,ENTRY,ENTRIES,ERR,ESTAT,INDEX
"RTN","MAGDRA1",24,0)
 N LOC,MAGCASE,MAGCNI,MAGCPT,MAGDTI,MAGPIEN,MAGPRC,MAGPSET,MAGPST
"RTN","MAGDRA1",25,0)
 N OUT,OLDCNI,OLDDT,OLDENTRY,PROC,PSET,PTINFO,RARPT,RADTI,RACNI,RADFN
"RTN","MAGDRA1",26,0)
 N RAMELOW,RAPRTSET,REIN,STAT,X,Y
"RTN","MAGDRA1",27,0)
 S (ENTRY,ENTRIES,OLDDT)=0
"RTN","MAGDRA1",28,0)
 F  S ENTRY=$O(^TMP($J,"RAE1",MAGDFN,ENTRY)) Q:'ENTRY!$G(OUT)  D
"RTN","MAGDRA1",29,0)
 . S DATA=^TMP($J,"RAE1",MAGDFN,ENTRY),ENTRIES=ENTRIES+1
"RTN","MAGDRA1",30,0)
 . S DATE=$P(ENTRY,"-"),CDATE=9999999.9999-DATE
"RTN","MAGDRA1",31,0)
 . S DATE=$TR($$FMTE^XLFDT(CDATE,"2FD")," ","0")
"RTN","MAGDRA1",32,0)
 . S PROC=$P(DATA,"^"),CASE=$P(DATA,"^",2),STAT=$P(DATA,"^",6)
"RTN","MAGDRA1",33,0)
 . S ESTAT=$P(STAT,"~",2),LOC=$P(DATA,"^",7)
"RTN","MAGDRA1",34,0)
 . S RARPT=$P(DATA,"^",5)
"RTN","MAGDRA1",35,0)
 . S RADTI=$P(ENTRY,"-"),RACNI=$P(ENTRY,"-",2),RADFN=MAGDFN
"RTN","MAGDRA1",36,0)
 . S MAGCASE=$$LCASE^MAGDRA2(CDATE,CASE)
"RTN","MAGDRA1",37,0)
 . ;Above radiology variables needed for EN1^RAULT20
"RTN","MAGDRA1",38,0)
 . K RAMELOW,RAPRTSET
"RTN","MAGDRA1",39,0)
 . D EN1^RAUTL20
"RTN","MAGDRA1",40,0)
 . S (PSET,MAGPSET)=""
"RTN","MAGDRA1",41,0)
 . I OLDDT'=RADTI S OLDCNI=""
"RTN","MAGDRA1",42,0)
 . S PSET=$S(RAMEMLOW:"+",RAPRTSET:".",1:"")
"RTN","MAGDRA1",43,0)
 . I PSET="+" S OLDCNI=RACNI
"RTN","MAGDRA1",44,0)
 . I PSET=".",OLDCNI D
"RTN","MAGDRA1",45,0)
 . . N OLDENTRY S OLDENTRY=$P(ENTRY,"-")_"-"_OLDCNI
"RTN","MAGDRA1",46,0)
 . . I $D(^TMP($J,"RAE1",MAGDFN,OLDENTRY)) D
"RTN","MAGDRA1",47,0)
 . . . S MAGCASE=$P(^TMP($J,"RAE1",MAGDFN,OLDENTRY),"^",2)
"RTN","MAGDRA1",48,0)
 . . . S CDATE=$P(ENTRY,"-")
"RTN","MAGDRA1",49,0)
 . . . S CDATE=9999999.9999-CDATE,RADTI=$P(OLDENTRY,"-"),RACNI=OLDCNI
"RTN","MAGDRA1",50,0)
 . . . S MAGCASE=$$LCASE^MAGDRA2(CDATE,MAGCASE)
"RTN","MAGDRA1",51,0)
 . . . S MAGPSET=CASE_" is part of this printset."
"RTN","MAGDRA1",52,0)
 . . . Q
"RTN","MAGDRA1",53,0)
 . . Q
"RTN","MAGDRA1",54,0)
 . I '$D(MAGNME)!'($D(MAGPID)) D
"RTN","MAGDRA1",55,0)
 . . S PTINFO=$$PTINFO^MAGDRA2
"RTN","MAGDRA1",56,0)
 . . S MAGNME=$P(PTINFO,"^"),MAGPID=$P(PTINFO,"^",2) ;P123
"RTN","MAGDRA1",57,0)
 . . Q
"RTN","MAGDRA1",58,0)
 . S INDEX(ENTRIES)=PROC_"^"_$G(MAGPSET)_"^"_RADTI_"^"_RACNI_"^"_MAGCASE
"RTN","MAGDRA1",59,0)
 . ; Radiology procedure^Printset^Inverse radiology date/time^Radioloty multiple^radiology case number
"RTN","MAGDRA1",60,0)
 . D PRT S OLDDT=RADTI
"RTN","MAGDRA1",61,0)
 . Q
"RTN","MAGDRA1",62,0)
 D:'$G(OUT) SEL I +X,$D(INDEX(+X)) D SET
"RTN","MAGDRA1",63,0)
 K OUT
"RTN","MAGDRA1",64,0)
 Q
"RTN","MAGDRA1",65,0)
PRT ;
"RTN","MAGDRA1",66,0)
 S (X,Y)=0
"RTN","MAGDRA1",67,0)
 I ENTRIES=1 D HEAD
"RTN","MAGDRA1",68,0)
 I $Y+6>IOSL D HEAD
"RTN","MAGDRA1",69,0)
 W !?1,ENTRIES,?5,PSET,?6,CASE_$$IMG^MAGDRA2(RARPT),?12,$E(PROC,1,28)
"RTN","MAGDRA1",70,0)
 W ?41,DATE,?52,$E(ESTAT,1,12),?67,$E(LOC,1,12) Q:ENTRIES#15
"RTN","MAGDRA1",71,0)
 D SEL
"RTN","MAGDRA1",72,0)
 Q
"RTN","MAGDRA1",73,0)
HEAD ;
"RTN","MAGDRA1",74,0)
 W @IOF,"Patient: ",MAGNME,?50,$$PIDLABEL^MAGSPID(),": ",MAGPID ;P123
"RTN","MAGDRA1",75,0)
 W !!,?3,"Case #",?12,"Procedure",?41,"Exam Date",?52,"Status of"
"RTN","MAGDRA1",76,0)
 W "Exam",?69,"Imaging Loc"
"RTN","MAGDRA1",77,0)
 W !?3,"--------",?12,"-------------",?41,"---------"
"RTN","MAGDRA1",78,0)
 W ?52,"--------------",?67,"-----------"
"RTN","MAGDRA1",79,0)
 Q
"RTN","MAGDRA1",80,0)
SEL ;
"RTN","MAGDRA1",81,0)
 N DIR ; -- array for FileMan prompt data
"RTN","MAGDRA1",82,0)
 S DIR(0)="NAO^1:"_ENTRIES
"RTN","MAGDRA1",83,0)
 S DIR("?",1)="Enter a number between 1 and "_ENTRIES
"RTN","MAGDRA1",84,0)
 S DIR("?")="corresponding to a single exam you wish to select."
"RTN","MAGDRA1",85,0)
 S DIR("A",1)="'i' next to a case number denotes images collected on study."
"RTN","MAGDRA1",86,0)
 S DIR("A")="Select an exam: "
"RTN","MAGDRA1",87,0)
 D ^DIR
"RTN","MAGDRA1",88,0)
 I '$D(DTOUT),'$D(DUOUT) ; didn't time out or uparrow out
"RTN","MAGDRA1",89,0)
 E  S OUT=1 Q
"RTN","MAGDRA1",90,0)
 I Y,$D(INDEX(Y)) D CHECK I 'Y G SEL
"RTN","MAGDRA1",91,0)
 I Y S Y=INDEX(Y) S OUT=1
"RTN","MAGDRA1",92,0)
 Q
"RTN","MAGDRA1",93,0)
SET ;
"RTN","MAGDRA1",94,0)
 S DATA=Y K Y
"RTN","MAGDRA1",95,0)
 S MAGCASE=$P(INDEX(+X),"^",5)
"RTN","MAGDRA1",96,0)
 S MAGPRC=$P(INDEX(+X),"^"),MAGPIEN=$$PROC^MAGDRA2(MAGPRC)
"RTN","MAGDRA1",97,0)
 S MAGDTI=$P(INDEX(+X),"^",3)
"RTN","MAGDRA1",98,0)
 S MAGPST=$P(INDEX(+X),"^",2)
"RTN","MAGDRA1",99,0)
 S MAGCNI=$P(INDEX(+X),"^",4)
"RTN","MAGDRA1",100,0)
 D MAGDY^MAGDRA2
"RTN","MAGDRA1",101,0)
 Q
"RTN","MAGDRA1",102,0)
CHECK ;
"RTN","MAGDRA1",103,0)
 ;Check to see if the entry still exists.
"RTN","MAGDRA1",104,0)
 N RADTI,CNI
"RTN","MAGDRA1",105,0)
 Q:'MAGDFN
"RTN","MAGDRA1",106,0)
 S RADTI=$P(INDEX(Y),"^",3),CNI=$P(INDEX(Y),"^",4)
"RTN","MAGDRA1",107,0)
 I '$D(^RADPT(MAGDFN,"DT",RADTI,"P",CNI)) D
"RTN","MAGDRA1",108,0)
 . S Y=""
"RTN","MAGDRA1",109,0)
 . W !,"There is a database problem with the entry selected.",!
"RTN","MAGDRA1",110,0)
 . Q
"RTN","MAGDRA1",111,0)
 I $P(INDEX(Y),"^")="" D
"RTN","MAGDRA1",112,0)
 . S Y=""
"RTN","MAGDRA1",113,0)
 . W !,"There are no procedures for the entry selected.",!
"RTN","MAGDRA1",114,0)
 Q
"RTN","MAGDRA2")
0^16^B31366232
"RTN","MAGDRA2",1,0)
MAGDRA2 ;WOIFO/LB,JSL,SAF - Routine for DICOM fix ; 13 Jul 2011 10:22 AM
"RTN","MAGDRA2",2,0)
 ;;3.0;IMAGING;**10,11,51,54,49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRA2",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRA2",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA2",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRA2",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRA2",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRA2",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRA2",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRA2",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRA2",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRA2",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRA2",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRA2",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRA2",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRA2",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRA2",17,0)
 ;;
"RTN","MAGDRA2",18,0)
 Q
"RTN","MAGDRA2",19,0)
 ; Routine to create the MAGDY variable needed by MAGDLB1 routine when
"RTN","MAGDRA2",20,0)
 ; manually correcting DICOM FIX files.
"RTN","MAGDRA2",21,0)
EN ;
"RTN","MAGDRA2",22,0)
 ; MAGDY variable to be created during this execution.
"RTN","MAGDRA2",23,0)
 N MAGBEG,MAGEND,MAGDFN,MAGOUT,MAGX,MAGXX,INFO,MAGNME,MAGPID
"RTN","MAGDRA2",24,0)
 S MAGBEG=1070101,MAGEND=$$DT^XLFDT
"RTN","MAGDRA2",25,0)
READ ;
"RTN","MAGDRA2",26,0)
 S (MAGDFN,MAGX)=$$READ^MAGDRA3
"RTN","MAGDRA2",27,0)
 Q:MAGX="^"
"RTN","MAGDRA2",28,0)
 S MAGDFN=+MAGDFN
"RTN","MAGDRA2",29,0)
 I 'MAGDFN W !,"Entry not found, enter a ""^"" to quit." G READ
"RTN","MAGDRA2",30,0)
 ;
"RTN","MAGDRA2",31,0)
 I MAGX["~" G ONE  ;Lookup was on case number and successful
"RTN","MAGDRA2",32,0)
 S MAGXX=$$FIND1^DIC(70,"","","`"_MAGDFN)   ;Radiology patient
"RTN","MAGDRA2",33,0)
 ;
"RTN","MAGDRA2",34,0)
 I MAGDFN=MAGXX D
"RTN","MAGDRA2",35,0)
 . S INFO=$$PTINFO Q:$D(MAGERR)
"RTN","MAGDRA2",36,0)
 . S MAGNME=$P(INFO,"^"),MAGPID=$P(INFO,"^",2)
"RTN","MAGDRA2",37,0)
 . K ^TMP($J,"RAE1")  ;Re-established by EN1^RA07PC1 -DBIA available
"RTN","MAGDRA2",38,0)
 . ; Set the beginning and ending date.
"RTN","MAGDRA2",39,0)
 . D EN1^RAO7PC1(MAGDFN,MAGBEG,MAGEND,500)
"RTN","MAGDRA2",40,0)
 . D:$D(^TMP($J,"RAE1")) LOOP^MAGDRA1
"RTN","MAGDRA2",41,0)
 . Q
"RTN","MAGDRA2",42,0)
 E  D  G:MAGX'="^" READ
"RTN","MAGDRA2",43,0)
 . W !,"No Radiology information found for the supplied answer.",$C(7)
"RTN","MAGDRA2",44,0)
 . Q
"RTN","MAGDRA2",45,0)
 Q
"RTN","MAGDRA2",46,0)
 ;
"RTN","MAGDRA2",47,0)
PTINFO() ;
"RTN","MAGDRA2",48,0)
 N INFO,MAGOUT
"RTN","MAGDRA2",49,0)
 I '$D(MAGDFN) Q ""
"RTN","MAGDRA2",50,0)
 I $$ISIHS^MAGSPID() D  Q INFO  ;P123 - MOD for IHS patients with Health Record Numbers (i.e. Chawktaw)
"RTN","MAGDRA2",51,0)
 . N DFN S DFN=MAGDFN,INFO="" D DEM^VADPT
"RTN","MAGDRA2",52,0)
 . I $G(VA("PID"))'="" S INFO=$G(VADM(1))_"^"_$TR(VA("PID"),"-")
"RTN","MAGDRA2",53,0)
 . E  S INFO=$G(VADM(1))_"^"_$P($G(VADM(2)),"^")
"RTN","MAGDRA2",54,0)
 . Q
"RTN","MAGDRA2",55,0)
 D GETS^DIQ(2,MAGDFN,".01;.09","E","MAGOUT","MAGERR")
"RTN","MAGDRA2",56,0)
 I $D(MAGERR) Q ""
"RTN","MAGDRA2",57,0)
 I $D(MAGOUT) D  Q INFO
"RTN","MAGDRA2",58,0)
 . S INFO=$G(MAGOUT(2,MAGDFN_",",.01,"E"))
"RTN","MAGDRA2",59,0)
 . S INFO=INFO_"^"_$G(MAGOUT(2,MAGDFN_",",.09,"E"))
"RTN","MAGDRA2",60,0)
 . Q
"RTN","MAGDRA2",61,0)
 Q ""
"RTN","MAGDRA2",62,0)
 ;
"RTN","MAGDRA2",63,0)
LCASE(MAGDT,MAGCASE) ; return the accession number
"RTN","MAGDRA2",64,0)
 N ACNUMB,ARESULT
"RTN","MAGDRA2",65,0)
 S ACNUMB=$TR($TR($$FMTE^XLFDT(MAGDT,"2FD")," ","0"),"/","")_"-"_MAGCASE
"RTN","MAGDRA2",66,0)
 I $$USESSAN^RAHLRU1(),$$ACCFIND^RAAPI(ACNUMB,.ARESULT)>0 D  ; ICR 5600
"RTN","MAGDRA2",67,0)
 . ; lookup site-specific accession number
"RTN","MAGDRA2",68,0)
 . N ACNUMB1,RADFN,RADTI,RACNI
"RTN","MAGDRA2",69,0)
 . S RADFN=$P(ARESULT(1),"^",1),RADTI=$P(ARESULT(1),"^",2)
"RTN","MAGDRA2",70,0)
 . S RACNI=$P(ARESULT(1),"^",3)
"RTN","MAGDRA2",71,0)
 . S ACNUMB1=$$GET1^DIQ(70.03,(RACNI_","_RADTI_","_RADFN),31)
"RTN","MAGDRA2",72,0)
 . I ACNUMB1'="" S ACNUMB=ACNUMB1
"RTN","MAGDRA2",73,0)
 . Q
"RTN","MAGDRA2",74,0)
 Q ACNUMB
"RTN","MAGDRA2",75,0)
 ;
"RTN","MAGDRA2",76,0)
IMG(MAGRPT) ;
"RTN","MAGDRA2",77,0)
 N INFO,MAGOUT,MAGERR
"RTN","MAGDRA2",78,0)
 I 'MAGRPT Q ""
"RTN","MAGDRA2",79,0)
 D GETS^DIQ(74,MAGRPT,"2005*","I","MAGOUT","MAGERR")
"RTN","MAGDRA2",80,0)
 I $D(MAGERR) Q ""
"RTN","MAGDRA2",81,0)
 I $D(MAGOUT(74.02005)) Q " i"
"RTN","MAGDRA2",82,0)
 Q ""
"RTN","MAGDRA2",83,0)
 ;
"RTN","MAGDRA2",84,0)
PROC(MAGPRC) ;
"RTN","MAGDRA2",85,0)
 Q $$FIND1^DIC(71,,"XB",MAGPRC)
"RTN","MAGDRA2",86,0)
 ;
"RTN","MAGDRA2",87,0)
ONE ;
"RTN","MAGDRA2",88,0)
 ;MAGDFN,MAGX variables expected from EN
"RTN","MAGDRA2",89,0)
 I 'MAGDFN,'+MAGX Q
"RTN","MAGDRA2",90,0)
 N BEG,CASE,CDATE,CS,DATA,END,FLDS,INFO,MAGCASE,MAGCNI,MAGDATE,MAGDTI
"RTN","MAGDRA2",91,0)
 N MAGEXST,MAGLOC,MAGNME,MAGOUT,MAGPIEN,MAGPRC,MAGPSET,MAGPST,MAGRPT
"RTN","MAGDRA2",92,0)
 N PP,PSET,RAENTRY,RAMEMLOW,RAPRTSET,RIEN,STAT,X,X1,X2,XX
"RTN","MAGDRA2",93,0)
 N RARPT,RADFN,RADTI,RACNI ;<--Variables needed for EN1^RAUTL20
"RTN","MAGDRA2",94,0)
 ; RAUTL20 used to retrieve if case is part of a print set.
"RTN","MAGDRA2",95,0)
 S MAGDFN=$P(MAGX,"~"),INFO=$$PTINFO
"RTN","MAGDRA2",96,0)
 S MAGNME=$P(INFO,"^"),MAGPID=$P(INFO,"^",2)
"RTN","MAGDRA2",97,0)
 S RIEN=$P(MAGX,"~",2)_","_$P(MAGX,"~",1)
"RTN","MAGDRA2",98,0)
 S BEG=9999999.9999-$P(MAGX,"~",2),END=$$FMADD^XLFDT(BEG,2)
"RTN","MAGDRA2",99,0)
 K ^TMP($J,"RAE1")
"RTN","MAGDRA2",100,0)
 D EN1^RAO7PC1(MAGDFN,BEG,END,20)
"RTN","MAGDRA2",101,0)
 S RAENTRY=$P(MAGX,"~",2)_"-"_$P(MAGX,"~",3)
"RTN","MAGDRA2",102,0)
 Q:'$D(^TMP($J,"RAE1"))
"RTN","MAGDRA2",103,0)
 Q:'$D(^TMP($J,"RAE1",MAGDFN,RAENTRY))
"RTN","MAGDRA2",104,0)
 S DATA=^TMP($J,"RAE1",MAGDFN,RAENTRY)
"RTN","MAGDRA2",105,0)
 S MAGDATE=$P(RAENTRY,"-"),CDATE=9999999.9999-MAGDATE
"RTN","MAGDRA2",106,0)
 S MAGDATE=$TR($$FMTE^XLFDT(CDATE,"2FD")," ","0")
"RTN","MAGDRA2",107,0)
 S MAGPRC=$P(DATA,"^"),CASE=$P(DATA,"^",2),STAT=$P(DATA,"^",6)
"RTN","MAGDRA2",108,0)
 S MAGEXST=$P(STAT,"~",2),MAGLOC=$P(DATA,"^",7)
"RTN","MAGDRA2",109,0)
 S (MAGRPT,RARPT)=$P(DATA,"^",5)
"RTN","MAGDRA2",110,0)
 S (MAGDTI,RADTI)=$P(RAENTRY,"-")
"RTN","MAGDRA2",111,0)
 S (MAGCNI,RACNI)=$P(RAENTRY,"-",2),RADFN=MAGDFN
"RTN","MAGDRA2",112,0)
 S MAGCASE=$$LCASE(CDATE,CASE),MAGPIEN=$$PROC(MAGPRC)
"RTN","MAGDRA2",113,0)
 ; RADTI, RADFN, RACNI variables needed for EN1^RAUTL20
"RTN","MAGDRA2",114,0)
 D EN1^RAUTL20
"RTN","MAGDRA2",115,0)
 S (PSET,MAGPSET)=""
"RTN","MAGDRA2",116,0)
 S PSET=$S(RAMEMLOW:"+",RAPRTSET:".",1:"")
"RTN","MAGDRA2",117,0)
 I PSET=".",RACNI>1 D
"RTN","MAGDRA2",118,0)
 . N OLDENTRY S OLDENTRY=$P(RAENTRY,"-")_"-"
"RTN","MAGDRA2",119,0)
 . S OLDENTRY=$O(^TMP($J,"RAE1",MAGDFN,OLDENTRY)) I $L(OLDENTRY) D
"RTN","MAGDRA2",120,0)
 . . S MAGCASE=$P(^TMP($J,"RAE1",MAGDFN,OLDENTRY),"^",2)
"RTN","MAGDRA2",121,0)
 . . S CDATE=$P(RAENTRY,"-")
"RTN","MAGDRA2",122,0)
 . . S CDATE=9999999.9999-CDATE
"RTN","MAGDRA2",123,0)
 . . S MAGCASE=$$LCASE^MAGDRA2(CDATE,MAGCASE),RACNI=$P(OLDENTRY,"-",2)
"RTN","MAGDRA2",124,0)
 . . S MAGPST=CASE_" is part of this printset."
"RTN","MAGDRA2",125,0)
 . . Q
"RTN","MAGDRA2",126,0)
 . Q
"RTN","MAGDRA2",127,0)
 I $D(RAPRTSET) S PP=$S(MAGCNI>1:".",MAGCNI=1:"+",1:"")
"RTN","MAGDRA2",128,0)
 S MAGCNI=RACNI
"RTN","MAGDRA2",129,0)
 W !,"PATIENT: ",MAGNME,?51,$$PIDLABEL^MAGSPID(),": ",MAGPID
"RTN","MAGDRA2",130,0)
 W !,"Case No.",?15,"Procedure",?42,"Location",?64,"Exam Date"
"RTN","MAGDRA2",131,0)
 W !,"________",?15,"_________",?42,"________________",?64,"________"
"RTN","MAGDRA2",132,0)
 W !,$G(PP),CASE,$$IMG(MAGRPT),?15,MAGPRC,?42,MAGLOC,?64,MAGDATE
"RTN","MAGDRA2",133,0)
 W !,"Exam status: ",MAGEXST," "," ",$G(MAGPST)
"RTN","MAGDRA2",134,0)
 D MAGDY
"RTN","MAGDRA2",135,0)
 Q
"RTN","MAGDRA2",136,0)
 ;
"RTN","MAGDRA2",137,0)
MAGDY ;
"RTN","MAGDRA2",138,0)
 S MAGDY=MAGDFN_"^"_MAGNME_"^"_MAGPID_"^"_MAGCASE_"^"_MAGPRC_"^"_MAGDTI
"RTN","MAGDRA2",139,0)
 S MAGDY=MAGDY_"^"_MAGCNI_"^"_MAGPIEN_"^"_$G(MAGPST)_"^"
"RTN","MAGDRA2",140,0)
 K MAGNME,MAGPID,MAGCASE,MAGPRC,MAGDTI,MAGCNI,MAGPIEN,MAPST
"RTN","MAGDRA2",141,0)
 Q
"RTN","MAGDRA2",142,0)
 ;
"RTN","MAGDRAHL")
0^17^B8412113
"RTN","MAGDRAHL",1,0)
MAGDRAHL ;WOIFO/PMK,SAF - Program to read a DICOM file ; 21 Oct 2010 3:01 PM
"RTN","MAGDRAHL",2,0)
 ;;3.0;IMAGING;**49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRAHL",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRAHL",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRAHL",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRAHL",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRAHL",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRAHL",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRAHL",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRAHL",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRAHL",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRAHL",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRAHL",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRAHL",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRAHL",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRAHL",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRAHL",17,0)
 ;;
"RTN","MAGDRAHL",18,0)
 ; This routine is invoked by RAHLR to create the HL7 ZDS segment with
"RTN","MAGDRAHL",19,0)
 ; the Study Instance UID
"RTN","MAGDRAHL",20,0)
 ;
"RTN","MAGDRAHL",21,0)
 ; The following code creates a DICOM Study Instance UID from three
"RTN","MAGDRAHL",22,0)
 ; Radiology Package variables: RADTI, RACNI, and ACNUMB
"RTN","MAGDRAHL",23,0)
 ; Input:
"RTN","MAGDRAHL",24,0)
 ;   RADTI -- internal subscript for the study in RADPT - reverse date/time  
"RTN","MAGDRAHL",25,0)
 ;   RACNI -- internal subscript for the study in RADPT - counter
"RTN","MAGDRAHL",26,0)
 ;   ACNUMB - external identifier for the study - [site number -] date-case number
"RTN","MAGDRAHL",27,0)
 ;   
"RTN","MAGDRAHL",28,0)
STUDYUID(RADTI,RACNI,ACNUMB) ; return the Study Instance UID
"RTN","MAGDRAHL",29,0)
 N FLAG ;----- Flag to prevent multiple dots in a row or leading zeroes
"RTN","MAGDRAHL",30,0)
 N I ;-------- Loop counter
"RTN","MAGDRAHL",31,0)
 N RAW ;----- "Raw" STUDYUID
"RTN","MAGDRAHL",32,0)
 N STATNUMB ;- Station number
"RTN","MAGDRAHL",33,0)
 N STUDYUID ;- Resulting unique identifier
"RTN","MAGDRAHL",34,0)
 ;
"RTN","MAGDRAHL",35,0)
 S STATNUMB=$P($$SITE^VASITE(),"^",3) ; station number
"RTN","MAGDRAHL",36,0)
 ;S STATNUMB=$E($P($$NS^XUAF4($$KSP^XUPARAM("INST")),U,2),1,3) ; station number
"RTN","MAGDRAHL",37,0)
 S RAW=^MAGD(2006.15,1,"UID ROOT")_".1.4."_STATNUMB_"."_RADTI_"."_RACNI_"."_ACNUMB
"RTN","MAGDRAHL",38,0)
 S STUDYUID="",FLAG=0 F I=1:1:$L(RAW) D
"RTN","MAGDRAHL",39,0)
 . N E
"RTN","MAGDRAHL",40,0)
 . S E=$E(RAW,I) S:E'?1AN E="."
"RTN","MAGDRAHL",41,0)
 . I "123456789"[E S STUDYUID=STUDYUID_E,FLAG=1 Q
"RTN","MAGDRAHL",42,0)
 . I E="0" S:$E(RAW,I+1)'?1AN FLAG=1 S:FLAG STUDYUID=STUDYUID_E Q
"RTN","MAGDRAHL",43,0)
 . I E?1U S STUDYUID=STUDYUID_($A(E)),FLAG=1 Q
"RTN","MAGDRAHL",44,0)
 . I E?1L S STUDYUID=STUDYUID_($A(E)-32),FLAG=1 Q
"RTN","MAGDRAHL",45,0)
 . I E="." S:FLAG STUDYUID=STUDYUID_E S FLAG=0 Q
"RTN","MAGDRAHL",46,0)
 . Q
"RTN","MAGDRAHL",47,0)
 ; No trailing dots either
"RTN","MAGDRAHL",48,0)
 F  Q:$E(STUDYUID,$L(STUDYUID))'="."  S STUDYUID=$E(STUDYUID,1,$L(STUDYUID)-1)
"RTN","MAGDRAHL",49,0)
 I $L(STUDYUID)>64 S $EC=",U13-STUDY UID too long,"
"RTN","MAGDRAHL",50,0)
 Q STUDYUID
"RTN","MAGDRAHL",51,0)
 ;
"RTN","MAGDRAHL",52,0)
ZDS(STUDYUID) ; returns the ZDS segment
"RTN","MAGDRAHL",53,0)
 N HLECH1 ;--- HL7 component separator
"RTN","MAGDRAHL",54,0)
 S HLECH1=$E(HLECH) ; HL7 component separator
"RTN","MAGDRAHL",55,0)
 I $L(STUDYUID)>64 S $EC=",U13-STUDY UID too long,"
"RTN","MAGDRAHL",56,0)
 Q "ZDS"_HLFS_STUDYUID_HLECH1_"VISTA"_HLECH1_"Application"_HLECH1_"DICOM"
"RTN","MAGDRPC3")
0^18^B57972489
"RTN","MAGDRPC3",1,0)
MAGDRPC3 ;WOIFO/EdM,SAF - Imaging RPCs ; 04 Jan 2011 8:37 AM
"RTN","MAGDRPC3",2,0)
 ;;3.0;IMAGING;**11,30,51,50,85,54,49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRPC3",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRPC3",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC3",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC3",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC3",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC3",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC3",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC3",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC3",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC3",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC3",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC3",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC3",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC3",17,0)
 ;;
"RTN","MAGDRPC3",18,0)
 Q
"RTN","MAGDRPC3",19,0)
 ;
"RTN","MAGDRPC3",20,0)
RADLKUP(OUT,CASENUMB,STUDYDAT) ; RPC = MAG DICOM LOOKUP RAD STUDY
"RTN","MAGDRPC3",21,0)
 ; Radiology patient/study lookup
"RTN","MAGDRPC3",22,0)
 ; STUDYDAT is a vestigial input parameter, it is not used
"RTN","MAGDRPC3",23,0)
 N ACCNUM ;--- Accession Number
"RTN","MAGDRPC3",24,0)
 N CPTCODE ;-- CPT code for the procedure
"RTN","MAGDRPC3",25,0)
 N CPTNAME ;-- CPT name for the procedure
"RTN","MAGDRPC3",26,0)
 N DATETIME ;- Timestamp
"RTN","MAGDRPC3",27,0)
 N DIVISION ;- pointer to INSTITUTION file (#4)
"RTN","MAGDRPC3",28,0)
 N EXAMSTS ;-- Exam status (don't post images to CANCELLED exams)
"RTN","MAGDRPC3",29,0)
 N PROCDESC ;- Procedure description
"RTN","MAGDRPC3",30,0)
 N PROCIEN ;-- radiology procedure ien in ^RAMIS(71)
"RTN","MAGDRPC3",31,0)
 N RAA ;------ array for returned value
"RTN","MAGDRPC3",32,0)
 N RAIX ;----- cross reference subscript for case number lookup
"RTN","MAGDRPC3",33,0)
 N RADPT1 ;--- first level subscript in ^RADPT
"RTN","MAGDRPC3",34,0)
 N RADPT2 ;--- second level subscript in ^RADPT (after "DT")
"RTN","MAGDRPC3",35,0)
 N RADPT3 ;--- third level subscript in ^RADPT (after "P")
"RTN","MAGDRPC3",36,0)
 N D1,I,LIST,X,Z
"RTN","MAGDRPC3",37,0)
 ;
"RTN","MAGDRPC3",38,0)
 ; find the patient/study in ^RADPT using the Radiology Case Number
"RTN","MAGDRPC3",39,0)
 K OUT
"RTN","MAGDRPC3",40,0)
 ;
"RTN","MAGDRPC3",41,0)
 I $G(CASENUMB)="" S OUT(1)="-1,No Case Number Specified" Q
"RTN","MAGDRPC3",42,0)
 ;
"RTN","MAGDRPC3",43,0)
 S X=$$ACCFIND^RAAPI(CASENUMB,.RAA) ; IA 5020
"RTN","MAGDRPC3",44,0)
 ;
"RTN","MAGDRPC3",45,0)
 I X<0 S OUT(1)="-2,Error in Accession Number Lookup: <<"_X_">>" Q
"RTN","MAGDRPC3",46,0)
 ;
"RTN","MAGDRPC3",47,0)
 S RADPT1=$P(RAA(1),"^",1),RADPT2=$P(RAA(1),"^",2),RADPT3=$P(RAA(1),"^",3)
"RTN","MAGDRPC3",48,0)
 ;
"RTN","MAGDRPC3",49,0)
 I RADPT1="" S OUT(1)="-3,Null RADPT1 entry returned by $$ACCFIND^RAAPI" Q
"RTN","MAGDRPC3",50,0)
 I RADPT2="" S OUT(1)="-4,Null RADPT2 entry returned by $$ACCFIND^RAAPI" Q
"RTN","MAGDRPC3",51,0)
 I RADPT3="" S OUT(1)="-5,Null RADPT3 entry returned by $$ACCFIND^RAAPI" Q
"RTN","MAGDRPC3",52,0)
 ;
"RTN","MAGDRPC3",53,0)
 I '$D(^RADPT(RADPT1,0)) S OUT(1)="-6,No patient demographics file pointer" Q
"RTN","MAGDRPC3",54,0)
 ;
"RTN","MAGDRPC3",55,0)
 ; get patient demographics file pointer
"RTN","MAGDRPC3",56,0)
 S DFN=$P(^RADPT(RADPT1,0),"^",1)
"RTN","MAGDRPC3",57,0)
 ;
"RTN","MAGDRPC3",58,0)
 I '$D(^RADPT(RADPT1,"DT",RADPT2,0)) S OUT(1)="-7,No date/time level" Q
"RTN","MAGDRPC3",59,0)
 ;
"RTN","MAGDRPC3",60,0)
 ; get date and time of examination
"RTN","MAGDRPC3",61,0)
 S DATETIME=$P($G(^RADPT(RADPT1,"DT",RADPT2,0)),"^",1)
"RTN","MAGDRPC3",62,0)
 ; get case info
"RTN","MAGDRPC3",63,0)
 ;
"RTN","MAGDRPC3",64,0)
 I '$D(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0)) S OUT(1)="-8,No study level" Q
"RTN","MAGDRPC3",65,0)
 ;
"RTN","MAGDRPC3",66,0)
 S X=^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0)
"RTN","MAGDRPC3",67,0)
 S Z=$P(X,"^",17) I Z S Z=$$ACCRPT^RAAPI(Z,.RAA) S ACCNUM=RAA(1)
"RTN","MAGDRPC3",68,0)
 S PROCIEN=$P(X,"^",2),EXAMSTS=$P(X,"^",3)
"RTN","MAGDRPC3",69,0)
 S:EXAMSTS EXAMSTS=$$GET1^DIQ(72,EXAMSTS,.01)
"RTN","MAGDRPC3",70,0)
 S (PROCDESC,CPTNAME,CPTCODE)=""
"RTN","MAGDRPC3",71,0)
 ;
"RTN","MAGDRPC3",72,0)
 ; need PROCIEN to do lookup in ^RAMIS
"RTN","MAGDRPC3",73,0)
 I 'PROCIEN S OUT(1)="-9,No procedure identifier" Q
"RTN","MAGDRPC3",74,0)
 ;
"RTN","MAGDRPC3",75,0)
 S Z=$G(^RAMIS(71,PROCIEN,0))
"RTN","MAGDRPC3",76,0)
 S PROCDESC=$P(Z,"^",1),CPTCODE=$P(Z,"^",9)
"RTN","MAGDRPC3",77,0)
 S CPTNAME=$P($$CPT^ICPTCOD(+CPTCODE),"^",3) ; IA 1995
"RTN","MAGDRPC3",78,0)
 S:CPTNAME="" CPTNAME=PROCDESC
"RTN","MAGDRPC3",79,0)
 S OUT(2)=$G(RADPT1)
"RTN","MAGDRPC3",80,0)
 S OUT(3)=$G(RADPT2)
"RTN","MAGDRPC3",81,0)
 S OUT(4)=$G(RADPT3)
"RTN","MAGDRPC3",82,0)
 S OUT(5)=$G(PROCIEN)
"RTN","MAGDRPC3",83,0)
 S OUT(6)=$G(CPTCODE)
"RTN","MAGDRPC3",84,0)
 S OUT(7)=$G(CPTNAME)
"RTN","MAGDRPC3",85,0)
 S OUT(8)=$G(Z)
"RTN","MAGDRPC3",86,0)
 S OUT(9)=$G(EXAMSTS)
"RTN","MAGDRPC3",87,0)
 S OUT(10)=$G(DFN)
"RTN","MAGDRPC3",88,0)
 S OUT(11)=$G(DATETIME)
"RTN","MAGDRPC3",89,0)
 S OUT(12)=$G(PROCDESC)
"RTN","MAGDRPC3",90,0)
 S X=""
"RTN","MAGDRPC3",91,0)
 I $G(PROCIEN) S D1=0 F  S D1=$O(^RAMIS(71,PROCIEN,"MDL",D1)) Q:'D1  D
"RTN","MAGDRPC3",92,0)
 . S Z=+$P($G(^RAMIS(71,PROCIEN,"MDL",D1,0)),"^",1) Q:'Z
"RTN","MAGDRPC3",93,0)
 . S Z=$P($G(^RAMIS(73.1,Z,0)),"^",1) Q:Z=""
"RTN","MAGDRPC3",94,0)
 . S:X'="" X=X_"," S X=X_Z
"RTN","MAGDRPC3",95,0)
 . Q
"RTN","MAGDRPC3",96,0)
 S OUT(13)=X ; List of Modality-codes
"RTN","MAGDRPC3",97,0)
 S X="" I $G(RADPT1),$G(RADPT2) S X=$G(^RADPT(RADPT1,"DT",RADPT2,0))
"RTN","MAGDRPC3",98,0)
 S DIVISION=$P(X,"^",3) ; pointer to INSTITUION file (#4) for division
"RTN","MAGDRPC3",99,0)
 S OUT(14)=$S($$ISIHS^MAGSPID():$P($$SITE^VASITE(),"^",3),1:$E($$GET1^DIQ(4,DIVISION,99),1,3)) ; station number, exclusive of any modifiers
"RTN","MAGDRPC3",100,0)
 ; Patient's pregnancy status at the time of the exam
"RTN","MAGDRPC3",101,0)
 S X="" I $G(DFN),$G(RADPT2),$G(RADPT3) S X=$G(^RADPT(DFN,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC3",102,0)
 S OUT(15)=$P($G(^RAO(75.1,+$P(X,"^",11),0)),"^",13)
"RTN","MAGDRPC3",103,0)
 S OUT(16)=$G(ACCNUM)
"RTN","MAGDRPC3",104,0)
 S OUT(1)=1 ; OK
"RTN","MAGDRPC3",105,0)
 Q
"RTN","MAGDRPC3",106,0)
 ;
"RTN","MAGDRPC3",107,0)
QUEUE(OUT,IMAGE,APPNAM,LOCATION,ACCNUM,REASON,EMAIL,PRIOR,JBTOHD) ; RPC = MAG DICOM QUEUE IMAGE
"RTN","MAGDRPC3",108,0)
 ; Add the DICOM study send image request to the queue
"RTN","MAGDRPC3",109,0)
 N COUNT,D0,D1,DFN,LOG,OK,PROBLEM,TYPE,X
"RTN","MAGDRPC3",110,0)
 ;
"RTN","MAGDRPC3",111,0)
 I '$G(IMAGE) S OUT="-1,No Image specified" Q
"RTN","MAGDRPC3",112,0)
 I $G(APPNAM)="" S OUT="-2,No Destination specified" Q
"RTN","MAGDRPC3",113,0)
 I '$G(LOCATION) S OUT="-3,No Origin specified" Q
"RTN","MAGDRPC3",114,0)
 S PRIOR=+$G(PRIOR) S:'PRIOR PRIOR=500
"RTN","MAGDRPC3",115,0)
 S JBTOHD=$S($G(JBTOHD):1,1:0)
"RTN","MAGDRPC3",116,0)
 ;
"RTN","MAGDRPC3",117,0)
 S X=$G(^MAG(2005,IMAGE,0))
"RTN","MAGDRPC3",118,0)
 S TYPE=+$P(X,"^",6),DFN=$P(X,"^",7)
"RTN","MAGDRPC3",119,0)
 I " 0 11 3 100 "'[(" "_TYPE_" ") D  Q
"RTN","MAGDRPC3",120,0)
 . S OUT="-4,Cannot Queue Image Object Type """_TYPE_"""."
"RTN","MAGDRPC3",121,0)
 . Q
"RTN","MAGDRPC3",122,0)
 ;
"RTN","MAGDRPC3",123,0)
 L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC3",124,0)
 S P=$P($G(^MAG(2005,IMAGE,0)),"^",10),P=$S(P:P,1:IMAGE)
"RTN","MAGDRPC3",125,0)
 S STUID=$P($G(^MAG(2005,P,"PACS")),"^",1) S:STUID="" STUID="?"
"RTN","MAGDRPC3",126,0)
 S OK=0,D0="" F  S D0=$O(^MAGDOUTP(2006.574,"STUDY",STUID,D0)) Q:'D0  D  Q:OK
"RTN","MAGDRPC3",127,0)
 . Q:'$D(^MAGDOUTP(2006.574,"STS",LOCATION,PRIOR,"WAITING",D0))
"RTN","MAGDRPC3",128,0)
 . Q:$P($G(^MAGDOUTP(2006.574,D0,0)),"^",1)'=APPNAM
"RTN","MAGDRPC3",129,0)
 . S OK=D0
"RTN","MAGDRPC3",130,0)
 . Q
"RTN","MAGDRPC3",131,0)
 S D0=OK D:'D0
"RTN","MAGDRPC3",132,0)
 . S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC3",133,0)
 . S $P(X,"^",1,2)="DICOM IMAGE OUTPUT FILE^2006.574"
"RTN","MAGDRPC3",134,0)
 . S D0=$O(^MAGDOUTP(2006.574," "),-1)+1 ; Next number
"RTN","MAGDRPC3",135,0)
 . S $P(X,"^",3)=D0
"RTN","MAGDRPC3",136,0)
 . S $P(X,"^",4)=$P(X,"^",4)+1 ; Total count
"RTN","MAGDRPC3",137,0)
 . S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC3",138,0)
 . ;
"RTN","MAGDRPC3",139,0)
 . S ^MAGDOUTP(2006.574,D0,0)=APPNAM_"^"_P_"^"_$G(ACCNUM)_"^"_LOCATION_"^"_PRIOR_"^"_JBTOHD
"RTN","MAGDRPC3",140,0)
 . S ^MAGDOUTP(2006.574,D0,2)=STUID
"RTN","MAGDRPC3",141,0)
 . S ^MAGDOUTP(2006.574,"STUDY",STUID,D0)=""
"RTN","MAGDRPC3",142,0)
 . Q
"RTN","MAGDRPC3",143,0)
 L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC3",144,0)
 ;
"RTN","MAGDRPC3",145,0)
 S COUNT=0,PROBLEM=3
"RTN","MAGDRPC3",146,0)
 I (TYPE=3)!(TYPE=100) D  ; Single XRAY or DICOM image
"RTN","MAGDRPC3",147,0)
 . S COUNT=COUNT+$$ENQUEUE(IMAGE,D0,PRIOR)
"RTN","MAGDRPC3",148,0)
 . Q
"RTN","MAGDRPC3",149,0)
 I TYPE=11 D  ; Process all the images in an XRAY group
"RTN","MAGDRPC3",150,0)
 . S D1=0 F  S D1=$O(^MAG(2005,IMAGE,1,D1)) Q:'D1  D
"RTN","MAGDRPC3",151,0)
 . . S COUNT=COUNT+$$ENQUEUE($P($G(^MAG(2005,IMAGE,1,D1,0)),"^",1),D0,PRIOR)
"RTN","MAGDRPC3",152,0)
 . . Q
"RTN","MAGDRPC3",153,0)
 . Q
"RTN","MAGDRPC3",154,0)
 ;
"RTN","MAGDRPC3",155,0)
 S LOG="DICOM transmit to "_APPNAM_" for reason "_REASON
"RTN","MAGDRPC3",156,0)
 D:COUNT ENTRY^MAGLOG($C(REASON+64),DUZ,IMAGE,"DICOM Gateway",DFN,COUNT,LOG)
"RTN","MAGDRPC3",157,0)
 D:PROBLEM>3
"RTN","MAGDRPC3",158,0)
 . N XMERR,XMID,XMSUB,XMY,XMZ
"RTN","MAGDRPC3",159,0)
 . S PROBLEM(1)="Error while queueing image for Transmission:"
"RTN","MAGDRPC3",160,0)
 . S PROBLEM(2)=LOG
"RTN","MAGDRPC3",161,0)
 . S PROBLEM(3)=" "
"RTN","MAGDRPC3",162,0)
 . ; --- send MailMan message...
"RTN","MAGDRPC3",163,0)
 . S XMID=$G(DUZ) S:'XMID XMID=.5
"RTN","MAGDRPC3",164,0)
 . S XMY(XMID)=""
"RTN","MAGDRPC3",165,0)
 . S:$G(EMAIL)'="" XMY(EMAIL)=""
"RTN","MAGDRPC3",166,0)
 . S XMSUB=$E("Cannot transmit image(s) to "_APPNAM,1,63)
"RTN","MAGDRPC3",167,0)
 . D SENDMSG^XMXAPI(XMID,XMSUB,"PROBLEM",.XMY,,.XMZ,)
"RTN","MAGDRPC3",168,0)
 . Q:'$G(XMERR)
"RTN","MAGDRPC3",169,0)
 . M XMERR=^TMP("XMERR",$J) S $EC=",U13-Cannot send MailMan message,"
"RTN","MAGDRPC3",170,0)
 . Q
"RTN","MAGDRPC3",171,0)
 S OUT=1
"RTN","MAGDRPC3",172,0)
 Q
"RTN","MAGDRPC3",173,0)
 ;
"RTN","MAGDRPC3",174,0)
ENQUEUE(IMAGE,D0,PRIOR) ; Add an image to the DICOM send image request queue sub-file
"RTN","MAGDRPC3",175,0)
 Q:'IMAGE 0
"RTN","MAGDRPC3",176,0)
 N D1,I,OLD,X
"RTN","MAGDRPC3",177,0)
 D CHK^MAGGSQI(.X,IMAGE) I +$G(X(0))'=1 D  Q 0
"RTN","MAGDRPC3",178,0)
 . S PROBLEM=PROBLEM+1,PROBLEM(PROBLEM)=" "
"RTN","MAGDRPC3",179,0)
 . S PROBLEM=PROBLEM+1,PROBLEM(PROBLEM)="Image # "_IMAGE_":"
"RTN","MAGDRPC3",180,0)
 . S I="" F  S I=$O(X(I)) Q:I=""  S PROBLEM=PROBLEM+1,PROBLEM(PROBLEM)=X(I)
"RTN","MAGDRPC3",181,0)
 . Q
"RTN","MAGDRPC3",182,0)
 ;
"RTN","MAGDRPC3",183,0)
 ; Enter each image at most once in each transmission request
"RTN","MAGDRPC3",184,0)
 S (D1,OLD)=0 F  S D1=$O(^MAGDOUTP(2006.574,D0,1,D1)) Q:'D1  D  Q:OLD
"RTN","MAGDRPC3",185,0)
 . S:$P($G(^MAGDOUTP(2006.574,D0,1,D1,0)),"^",1)=IMAGE OLD=1
"RTN","MAGDRPC3",186,0)
 . Q
"RTN","MAGDRPC3",187,0)
 Q:OLD 1
"RTN","MAGDRPC3",188,0)
 ;
"RTN","MAGDRPC3",189,0)
 L +^MAGDOUTP(2006.574,D0,1,0):1E9 ; Background Process MUST wait
"RTN","MAGDRPC3",190,0)
 S X=$G(^MAGDOUTP(2006.574,D0,1,0))
"RTN","MAGDRPC3",191,0)
 S $P(X,"^",1,2)="^2006.5744"
"RTN","MAGDRPC3",192,0)
 S D1=$O(^MAGDOUTP(2006.574,D0,1," "),-1)+1,$P(X,"^",3)=D1
"RTN","MAGDRPC3",193,0)
 S $P(X,"^",4)=$P(X,"^",4)+1,OUT=$P(X,"^",4)
"RTN","MAGDRPC3",194,0)
 S ^MAGDOUTP(2006.574,D0,1,0)=X
"RTN","MAGDRPC3",195,0)
 S ^MAGDOUTP(2006.574,D0,1,D1,0)=IMAGE_"^WAITING^"_$H
"RTN","MAGDRPC3",196,0)
 S ^MAGDOUTP(2006.574,"STS",LOCATION,PRIOR,"WAITING",D0,D1)=""
"RTN","MAGDRPC3",197,0)
 L -^MAGDOUTP(2006.574,D0,1,0)
"RTN","MAGDRPC3",198,0)
 Q 1
"RTN","MAGDRPC3",199,0)
 ;
"RTN","MAGDRPC3",200,0)
FIND(DATE,CASE,NUM) ; ADC x-reference (Radiology patient file)
"RTN","MAGDRPC3",201,0)
 N X
"RTN","MAGDRPC3",202,0)
 Q:'$G(DATE) 0
"RTN","MAGDRPC3",203,0)
 S X=DATE S:$G(NUM) X=$$FMADD^XLFDT(DATE,NUM) Q:X<1 0
"RTN","MAGDRPC3",204,0)
 Q $O(^RADPT("ADC",$$MMDDYY(X)_"-"_CASE,""))
"RTN","MAGDRPC3",205,0)
 ;
"RTN","MAGDRPC3",206,0)
MMDDYY(DAY) ; YYYMMDD --> MMDDYY
"RTN","MAGDRPC3",207,0)
 I DAY'?7N Q 0
"RTN","MAGDRPC3",208,0)
 Q $E(DAY,4,7)_$E(DAY,2,3)
"RTN","MAGDRPC3",209,0)
 ;
"RTN","MAGDRPC9")
0^19^B55813118
"RTN","MAGDRPC9",1,0)
MAGDRPC9 ;WOIFO/EdM/JSL/SAF - Imaging RPCs ; 11 Feb 2008 12:36 PM
"RTN","MAGDRPC9",2,0)
 ;;3.0;IMAGING;**50,54,53,49,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRPC9",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRPC9",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC9",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPC9",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPC9",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPC9",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPC9",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPC9",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPC9",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPC9",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPC9",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPC9",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPC9",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPC9",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPC9",17,0)
 ;;
"RTN","MAGDRPC9",18,0)
 Q
"RTN","MAGDRPC9",19,0)
 ;
"RTN","MAGDRPC9",20,0)
UIDROOT(OUT) ; RPC = MAG DICOM GET UID ROOT
"RTN","MAGDRPC9",21,0)
 S OUT=$G(^MAGD(2006.15,1,"UID ROOT"))
"RTN","MAGDRPC9",22,0)
 Q
"RTN","MAGDRPC9",23,0)
 ;
"RTN","MAGDRPC9",24,0)
NEWUID(OUT,OLD,NEW,IMAGE) ; RPC = MAG NEW SOP INSTANCE UID
"RTN","MAGDRPC9",25,0)
 N D0,L,X
"RTN","MAGDRPC9",26,0)
 S IMAGE=+$G(IMAGE),OLD=$G(OLD)
"RTN","MAGDRPC9",27,0)
 S:$G(NEW)="" NEW=OLD
"RTN","MAGDRPC9",28,0)
 S D0=0 S:OLD'="" D0=$O(^MAG(2005,"P",OLD,""))
"RTN","MAGDRPC9",29,0)
 I IMAGE,D0,IMAGE'=D0 S OUT="-1,UID cannot belong to multiple images ("_IMAGE_"/"_D0_")" Q
"RTN","MAGDRPC9",30,0)
 I IMAGE,'D0 S D0=IMAGE
"RTN","MAGDRPC9",31,0)
 I 'D0 S OUT="-2,Cannot find image with UID "_OLD Q
"RTN","MAGDRPC9",32,0)
 S OUT=$P($G(^MAG(2005,D0,"SOP")),"^",2) Q:OUT'=""
"RTN","MAGDRPC9",33,0)
 S L=$L(NEW,".")-1,X=$P(NEW,".",L+1),L=$P(NEW,".",1,L)_"."
"RTN","MAGDRPC9",34,0)
 L +^MAG(2005,"P"):1E9 ; Background process MUST wait
"RTN","MAGDRPC9",35,0)
 S OUT="" F  D  Q:OUT'=""
"RTN","MAGDRPC9",36,0)
 . S OUT=L_X
"RTN","MAGDRPC9",37,0)
 . I $L(OUT)>64 S OUT="-3,Cannot use "_NEW_" to create valid UID" Q
"RTN","MAGDRPC9",38,0)
 . I $D(^MAG(2005,"P",OUT)) S OUT="",X=X+1 Q
"RTN","MAGDRPC9",39,0)
 . S $P(^MAG(2005,D0,"SOP"),"^",2)=OUT
"RTN","MAGDRPC9",40,0)
 . S ^MAG(2005,"P",OUT,D0)=1
"RTN","MAGDRPC9",41,0)
 . Q
"RTN","MAGDRPC9",42,0)
 L -^MAG(2005,"P")
"RTN","MAGDRPC9",43,0)
 Q
"RTN","MAGDRPC9",44,0)
 ;
"RTN","MAGDRPC9",45,0)
QRNEWUID(IMAGE) ; Get updated UID for Query/Retrieve
"RTN","MAGDRPC9",46,0)
 N DATE,DH,FAIL,I,OLD,OUT,NEW,LASTUID,NEXTUID,TIME,X,Y
"RTN","MAGDRPC9",47,0)
 S IMAGE=+$G(IMAGE)
"RTN","MAGDRPC9",48,0)
 S NEW=$P($G(^MAG(2005,IMAGE,"SOP")),"^",2)
"RTN","MAGDRPC9",49,0)
 Q:NEW'="" NEW  ; There already is a new UID
"RTN","MAGDRPC9",50,0)
 ; Generate the next UID using date/time and counter
"RTN","MAGDRPC9",51,0)
 L +^MAGDICOM(2006.563,1,"MACHINE ID"):1E9 ; Background process must wait
"RTN","MAGDRPC9",52,0)
 S LASTUID=$G(^MAGDICOM(2006.563,1,"LAST UID"))
"RTN","MAGDRPC9",53,0)
 ; Can't use D NOW^XLFDT to set DH because it is incorrect at midnight
"RTN","MAGDRPC9",54,0)
 S DH=$H,X=$$HTFM^XLFDT(DH,1),DATE=X+17000000
"RTN","MAGDRPC9",55,0)
 S X=$P(DH,",",2) D
"RTN","MAGDRPC9",56,0)
 . N H,M,S
"RTN","MAGDRPC9",57,0)
 . S H=X\3600,M=X\60#60,S=X#60
"RTN","MAGDRPC9",58,0)
 . S TIME=H*100+M*100+S
"RTN","MAGDRPC9",59,0)
 . Q
"RTN","MAGDRPC9",60,0)
 S NEXTUID=$G(^MAGD(2006.15,1,"UID ROOT"))
"RTN","MAGDRPC9",61,0)
 I NEXTUID="" S $EC=",13:No UID Root defined - Run INIT^MAGDRUID," ; Fatal Error
"RTN","MAGDRPC9",62,0)
 ; UID type = 7, Machine ID = 0
"RTN","MAGDRPC9",63,0)
 S NEXTUID=NEXTUID_".1.7."_(+$G(DUZ(2)))_".0."_DATE_"."_TIME_".0"
"RTN","MAGDRPC9",64,0)
 ; Remove leading 0s from UID components
"RTN","MAGDRPC9",65,0)
 F I=1:1:$L(NEXTUID,".") S $P(NEXTUID,".",I)=+$P(NEXTUID,".",I)
"RTN","MAGDRPC9",66,0)
 I $P(NEXTUID,".",1,10)=$P(LASTUID,".",1,10) D
"RTN","MAGDRPC9",67,0)
 . S NEXTUID=LASTUID
"RTN","MAGDRPC9",68,0)
 . S $P(NEXTUID,".",11)=$P(NEXTUID,".",11)+1
"RTN","MAGDRPC9",69,0)
 . Q
"RTN","MAGDRPC9",70,0)
 S ^MAGDICOM(2006.563,1,"LAST UID")=NEXTUID
"RTN","MAGDRPC9",71,0)
 L -^MAGDICOM(2006.563,1,"MACHINE ID")
"RTN","MAGDRPC9",72,0)
 S OLD=$P($G(^MAG(2005,IMAGE,"PACS")),"^",1)
"RTN","MAGDRPC9",73,0)
 D NEWUID(.OUT,OLD,NEXTUID,IMAGE) ; Store the new UID with the image
"RTN","MAGDRPC9",74,0)
 Q OUT
"RTN","MAGDRPC9",75,0)
 ;
"RTN","MAGDRPC9",76,0)
NEXT(OUT,SEED,DIR) ; RPC = MAG RAD GET NEXT RPT BY DATE
"RTN","MAGDRPC9",77,0)
 N D2,DFN,EXAMDATE,NAME
"RTN","MAGDRPC9",78,0)
 ;
"RTN","MAGDRPC9",79,0)
 ; ^RADPT(DFN,"DT",D1,"P",D2,0) = Data, $P(17) = pointer to report
"RTN","MAGDRPC9",80,0)
 ; ^RADPT("AR",9999999.9999-D1,DFN,D1)="" ; IA # 65
"RTN","MAGDRPC9",81,0)
 ;
"RTN","MAGDRPC9",82,0)
 ; OUT = report_pointer ^ ExamDate ^ Patient ^ D2
"RTN","MAGDRPC9",83,0)
 ;
"RTN","MAGDRPC9",84,0)
 S SEED=$G(SEED),DIR=$S($G(DIR)<0:-1,1:1) ; default is ascending order
"RTN","MAGDRPC9",85,0)
 S EXAMDATE=$P(SEED,"^",1),DFN=$P(SEED,"^",2),D2=$P(SEED,"^",3)
"RTN","MAGDRPC9",86,0)
 S OUT=0 F  D  Q:OUT
"RTN","MAGDRPC9",87,0)
 . I EXAMDATE="" S EXAMDATE=$O(^RADPT("AR",""),DIR),DFN="" ; IA # 65
"RTN","MAGDRPC9",88,0)
 . I EXAMDATE="" S OUT=-1 Q
"RTN","MAGDRPC9",89,0)
 . I DFN="" S DFN=$O(^RADPT("AR",EXAMDATE,""),DIR) ; IA # 65
"RTN","MAGDRPC9",90,0)
 . I DFN="" S EXAMDATE=$O(^RADPT("AR",EXAMDATE),DIR),D2="" Q  ; IA # 65
"RTN","MAGDRPC9",91,0)
 . S:'D2 D2=$S(DIR>0:0,1:" ")
"RTN","MAGDRPC9",92,0)
 . S D2=$O(^RADPT(DFN,"DT",9999999.9999-EXAMDATE,"P",D2),DIR) ; IA # 1172
"RTN","MAGDRPC9",93,0)
 . I 'D2 D  Q
"RTN","MAGDRPC9",94,0)
 . . S DFN=$O(^RADPT("AR",EXAMDATE,DFN),DIR),D2="" ; IA # 65
"RTN","MAGDRPC9",95,0)
 . . I 'DFN D
"RTN","MAGDRPC9",96,0)
 . . . S EXAMDATE=$O(^RADPT("AR",EXAMDATE),DIR),DFN="" ; IA # 65
"RTN","MAGDRPC9",97,0)
 . . . I EXAMDATE="" S OUT=-1
"RTN","MAGDRPC9",98,0)
 . . . Q
"RTN","MAGDRPC9",99,0)
 . . Q
"RTN","MAGDRPC9",100,0)
 . S OUT=$P($G(^RADPT(DFN,"DT",9999999.9999-EXAMDATE,"P",D2,0)),"^",17) ; IA # 1172
"RTN","MAGDRPC9",101,0)
 . S:OUT OUT=OUT_"^"_EXAMDATE_"^"_DFN_"^"_D2
"RTN","MAGDRPC9",102,0)
 . Q
"RTN","MAGDRPC9",103,0)
 Q
"RTN","MAGDRPC9",104,0)
 ;
"RTN","MAGDRPC9",105,0)
NXTPTRPT(OUT,DFN,RARPT1,DIR) ; RPC = MAG RAD GET NEXT RPT BY PT
"RTN","MAGDRPC9",106,0)
 S DFN=$G(DFN)
"RTN","MAGDRPC9",107,0)
 I 'DFN S OUT="-1,Patient DFN not passed" Q
"RTN","MAGDRPC9",108,0)
 I '$D(^RARPT("C",DFN)) S OUT="-2,Patient does not have any radiology reports" Q  ; IA # 2442
"RTN","MAGDRPC9",109,0)
 S RARPT1=$G(RARPT1),DIR=$S($G(DIR)<0:-1,1:1) ; default is ascending order
"RTN","MAGDRPC9",110,0)
 S OUT=$O(^RARPT("C",DFN,RARPT1),DIR) ; IA # 2442
"RTN","MAGDRPC9",111,0)
 Q
"RTN","MAGDRPC9",112,0)
 ;
"RTN","MAGDRPC9",113,0)
GETICN(OUT,DFN) ; RPC = MAG DICOM GET ICN
"RTN","MAGDRPC9",114,0)
 S OUT=$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(DFN),1:"-1^NO MPI") ;P123
"RTN","MAGDRPC9",115,0)
 Q
"RTN","MAGDRPC9",116,0)
 ;
"RTN","MAGDRPC9",117,0)
CLEAN ; Overflow from MAGDRPC4
"RTN","MAGDRPC9",118,0)
 N STUID
"RTN","MAGDRPC9",119,0)
 S S0=$P(SENT(I),"^",1),S1=$P(SENT(I),"^",2)
"RTN","MAGDRPC9",120,0)
 Q:'$D(^MAGDOUTP(2006.574,S0,1,S1))
"RTN","MAGDRPC9",121,0)
 L +^MAGDOUTP(2006.574,S0,1,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC9",122,0)
 S X=$G(^MAGDOUTP(2006.574,S0,0)),LOC=$P(X,"^",4),PRI=+$P(X,"^",5)
"RTN","MAGDRPC9",123,0)
 S STS=$P($G(^MAGDOUTP(2006.574,S0,1,S1,0)),"^",2)
"RTN","MAGDRPC9",124,0)
 K ^MAGDOUTP(2006.574,S0,1,S1)
"RTN","MAGDRPC9",125,0)
 I LOC'="",STS'="" K ^MAGDOUTP(2006.574,"STS",LOC,PRI,STS,S0,S1)
"RTN","MAGDRPC9",126,0)
 S X=$G(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC9",127,0)
 S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC9",128,0)
 S ^MAGDOUTP(2006.574,S0,1,0)=X
"RTN","MAGDRPC9",129,0)
 L -^MAGDOUTP(2006.574,S0,1,0)
"RTN","MAGDRPC9",130,0)
 Q:$O(^MAGDOUTP(2006.574,S0,1,0))
"RTN","MAGDRPC9",131,0)
 L +^MAGDOUTP(2006.574,0):1E9 ; Background process MUST wait
"RTN","MAGDRPC9",132,0)
 S STUID=$G(^MAGDOUTP(2006.574,S0,2))
"RTN","MAGDRPC9",133,0)
 K ^MAGDOUTP(2006.574,S0)
"RTN","MAGDRPC9",134,0)
 K:STUID'="" ^MAGDOUTP(2006.574,"STUDY",STUID)
"RTN","MAGDRPC9",135,0)
 S X=$G(^MAGDOUTP(2006.574,0))
"RTN","MAGDRPC9",136,0)
 S $P(X,"^",4)=$P(X,"^",4)-1
"RTN","MAGDRPC9",137,0)
 S ^MAGDOUTP(2006.574,0)=X
"RTN","MAGDRPC9",138,0)
 L -^MAGDOUTP(2006.574,0)
"RTN","MAGDRPC9",139,0)
 Q
"RTN","MAGDRPC9",140,0)
 ;
"RTN","MAGDRPC9",141,0)
IENLOOK ; Overflow from MAGDRPC4
"RTN","MAGDRPC9",142,0)
 ; lookup image by the IEN
"RTN","MAGDRPC9",143,0)
 N ACNUMB,D0,DFN,GROUPIEN,MODIFIER,P,PROCNAME,STUDYDAT,X,Y
"RTN","MAGDRPC9",144,0)
 S NUMBER=+$P(NUMBER,"`",2)
"RTN","MAGDRPC9",145,0)
 ; patient safety checks
"RTN","MAGDRPC9",146,0)
 D CHK^MAGGSQI(.X,NUMBER) I +$G(X(0))'=1 D  Q
"RTN","MAGDRPC9",147,0)
 . S OUT(1)="-9,"_$P(X(0),"^",2,999)
"RTN","MAGDRPC9",148,0)
 . Q
"RTN","MAGDRPC9",149,0)
 S GROUPIEN=$P($G(^MAG(2005,NUMBER,0)),"^",10)
"RTN","MAGDRPC9",150,0)
 I GROUPIEN D CHK^MAGGSQI(.X,GROUPIEN) I +$G(X(0))'=1 D  Q
"RTN","MAGDRPC9",151,0)
 . S OUT(1)="-10,Group #"_GROUPIEN_": "_$P(X(0),"^",2,999)
"RTN","MAGDRPC9",152,0)
 . Q
"RTN","MAGDRPC9",153,0)
 ;
"RTN","MAGDRPC9",154,0)
 S X=$G(^MAG(2005,NUMBER,2)),P=$P(X,"^",6),D0=$P(X,"^",7)
"RTN","MAGDRPC9",155,0)
 I 'P!'D0 D  ; get parent from group
"RTN","MAGDRPC9",156,0)
 . S:GROUPIEN X=$G(^MAG(2005,GROUPIEN,2)),P=$P(X,"^",6),D0=$P(X,"^",7)
"RTN","MAGDRPC9",157,0)
 . Q
"RTN","MAGDRPC9",158,0)
 ;
"RTN","MAGDRPC9",159,0)
 S OUT(2)=P_"^"_D0_"^"_NUMBER_"^" ; result w/o Accession Number
"RTN","MAGDRPC9",160,0)
 I 'P!'D0 S OUT(1)="-6,Warning - Parent file entry is not present - no Accession Number."
"RTN","MAGDRPC9",161,0)
 E  I P=74 D
"RTN","MAGDRPC9",162,0)
 . N DATETIME,I,INFO,PROC,RADPT0,RADPT1,RADPT2,RADPT3,RARPT0
"RTN","MAGDRPC9",163,0)
 . S X=$$ACCRPT^RAAPI(D0,.INFO)
"RTN","MAGDRPC9",164,0)
 . I X<0 S OUT(1)="-11,Radiology Problem: "_X Q
"RTN","MAGDRPC9",165,0)
 . S ACNUMB=INFO(1)
"RTN","MAGDRPC9",166,0)
 . S RARPT0=$G(^RARPT(D0,0)) ; IA # 1171
"RTN","MAGDRPC9",167,0)
 . S RADPT1=$P(RARPT0,"^",2),DATETIME=$P(RARPT0,"^",3)
"RTN","MAGDRPC9",168,0)
 . S RADPT2=9999999.9999-DATETIME,RADPT3=1
"RTN","MAGDRPC9",169,0)
 . S RADPT0=$G(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,0))
"RTN","MAGDRPC9",170,0)
 . S PROCNAME=$$GET1^DIQ(71,$P(RADPT0,"^",2),.01)
"RTN","MAGDRPC9",171,0)
 . S STUDYDAT=17000000+(DATETIME\1)
"RTN","MAGDRPC9",172,0)
 . S MODIFIER=""
"RTN","MAGDRPC9",173,0)
 . S I=0 F  S I=$O(^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,"M",I)) Q:'I  D
"RTN","MAGDRPC9",174,0)
 . . S X=^RADPT(RADPT1,"DT",RADPT2,"P",RADPT3,"M",I,0)
"RTN","MAGDRPC9",175,0)
 . . S:I>1 MODIFIER=MODIFIER_", " S MODIFIER=MODIFIER_$$GET1^DIQ(71.2,X,.01)
"RTN","MAGDRPC9",176,0)
 . . Q
"RTN","MAGDRPC9",177,0)
 . S X=P_"^"_D0_"^"_NUMBER_"^"_ACNUMB_"^"_STUDYDAT_"^"_PROCNAME_"^"_MODIFIER
"RTN","MAGDRPC9",178,0)
 . S OUT(1)=1,OUT(2)=X
"RTN","MAGDRPC9",179,0)
 . Q
"RTN","MAGDRPC9",180,0)
 E  I P=8925 D
"RTN","MAGDRPC9",181,0)
 . N GMRCIEN
"RTN","MAGDRPC9",182,0)
 . ; get pointer from TIU to consult request
"RTN","MAGDRPC9",183,0)
 . S X=$$GET1^DIQ(8925,D0,1405,"I") ; IA ???
"RTN","MAGDRPC9",184,0)
 . I $P(X,";",2)="GMR(123," D
"RTN","MAGDRPC9",185,0)
 . . S GMRCIEN=$P(X,";"),ACNUMB="GMRC-"_GMRCIEN
"RTN","MAGDRPC9",186,0)
 . . S STUDYDAT=17000000+($$GET1^DIQ(123,GMRCIEN,.01,"I")\1)
"RTN","MAGDRPC9",187,0)
 . . S PROCNAME=$$GET1^DIQ(123,GMRCIEN,1) ; TO SERVICE
"RTN","MAGDRPC9",188,0)
 . . S MODIFIER=$$GET1^DIQ(123,GMRCIEN,4) ; PROCEDURE
"RTN","MAGDRPC9",189,0)
 . . S X=P_"^"_D0_"^"_NUMBER_"^"_ACNUMB_"^"_STUDYDAT_"^"_PROCNAME_"^"_MODIFIER
"RTN","MAGDRPC9",190,0)
 . . S OUT(1)=1,OUT(2)=X
"RTN","MAGDRPC9",191,0)
 . . Q
"RTN","MAGDRPC9",192,0)
 . E  S OUT(1)="-8,Problem with parent file "_P_", internal entry number "_D0_" - no Accession Number."
"RTN","MAGDRPC9",193,0)
 . Q
"RTN","MAGDRPC9",194,0)
 E  S OUT(1)="-7,Parent file "_P_" not yet supported - no Accession Number."
"RTN","MAGDRPC9",195,0)
 Q
"RTN","MAGDRPCA")
0^20^B93958807
"RTN","MAGDRPCA",1,0)
MAGDRPCA ;WOIFO/PMK/MLS/SG/JSL/SAF - Imaging RPCs for Importer ; 02 Nov 2009 8:47 AM
"RTN","MAGDRPCA",2,0)
 ;;3.0;IMAGING;**53,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDRPCA",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDRPCA",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPCA",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDRPCA",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDRPCA",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDRPCA",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDRPCA",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDRPCA",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDRPCA",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDRPCA",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDRPCA",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDRPCA",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDRPCA",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDRPCA",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDRPCA",17,0)
 ;;
"RTN","MAGDRPCA",18,0)
 Q
"RTN","MAGDRPCA",19,0)
 ;
"RTN","MAGDRPCA",20,0)
CHECKUID(OUT,UIDLIST,LEVEL) ; RPC = MAG DICOM IMPORTER CHECK UIDS
"RTN","MAGDRPCA",21,0)
 N COUNT,DUPCOUNT,DUPUID,ERROR,I,MAG0,MAGIEN,OBJECT
"RTN","MAGDRPCA",22,0)
 I '$D(UIDLIST) S OUT(1)="-1,A list of UIDs must be supplied." Q
"RTN","MAGDRPCA",23,0)
 I '$D(LEVEL) S OUT(1)="-2,Study or SOP Instance level must be specified." Q
"RTN","MAGDRPCA",24,0)
 I LEVEL'="STUDY",LEVEL'="SOP" D  Q
"RTN","MAGDRPCA",25,0)
 . S OUT(1)="-3,Level must be either ""STUDY"" or ""SOP -- """
"RTN","MAGDRPCA",26,0)
 . S OUT(1)=OUT(1)_"the value """_LEVEL_""" was specified."
"RTN","MAGDRPCA",27,0)
 . Q
"RTN","MAGDRPCA",28,0)
 S COUNT=$G(UIDLIST(1)),ERROR=0
"RTN","MAGDRPCA",29,0)
 I COUNT'>0 S OUT(1)="-4,Count of UIDs in list must be greater than zero." Q
"RTN","MAGDRPCA",30,0)
 F I=2:1:COUNT+1 S UID=UIDLIST(I) D
"RTN","MAGDRPCA",31,0)
 . S MAGIEN=$O(^MAG(2005,"P",UID,""))
"RTN","MAGDRPCA",32,0)
 . I MAGIEN D
"RTN","MAGDRPCA",33,0)
 . . S MAG0=$G(^MAG(2005,MAGIEN,0)),OBJECT=$P(MAG0,"^",6),DFN=$P(MAG0,"^",7)
"RTN","MAGDRPCA",34,0)
 . . I LEVEL="STUDY" D  ; Study Instance UID
"RTN","MAGDRPCA",35,0)
 . . . I OBJECT'=11 D  Q
"RTN","MAGDRPCA",36,0)
 . . . . S OUT(I)="-5,Study Instance UID not pointing to an XRAY Group -- "
"RTN","MAGDRPCA",37,0)
 . . . . S OUT(I)=OUT(I)_"MAGIEN = "_MAGIEN,ERROR=ERROR+1
"RTN","MAGDRPCA",38,0)
 . . . . Q
"RTN","MAGDRPCA",39,0)
 . . . S OUT(I)=$$LOOKUP1(MAGIEN)_"^"_$$DUPUID(LEVEL,UID)
"RTN","MAGDRPCA",40,0)
 . . . Q
"RTN","MAGDRPCA",41,0)
 . . E  D  ; SOP Instance UID
"RTN","MAGDRPCA",42,0)
 . . . I OBJECT'=3,OBJECT'=100 D  Q
"RTN","MAGDRPCA",43,0)
 . . . . S OUT(I)="-6,SOP Instance UID not pointing to an XRAY or a DICOM object -- "
"RTN","MAGDRPCA",44,0)
 . . . . S OUT(I)=OUT(I)_"MAGIEN = "_MAGIEN,ERROR=ERROR+1
"RTN","MAGDRPCA",45,0)
 . . . . Q
"RTN","MAGDRPCA",46,0)
 . . . S OUT(I)=$$LOOKUP1(MAGIEN)_"^"_$$DUPUID(LEVEL,UID)
"RTN","MAGDRPCA",47,0)
 . . . Q
"RTN","MAGDRPCA",48,0)
 . . Q
"RTN","MAGDRPCA",49,0)
 . E  S OUT(I)=""
"RTN","MAGDRPCA",50,0)
 . Q
"RTN","MAGDRPCA",51,0)
 I ERROR>1 S OUT(1)="-100,There were "_ERROR_" database inconsistency errors detected.  Look at returned data."
"RTN","MAGDRPCA",52,0)
 E  I ERROR=1 S OUT(1)="-100,A database inconsistency error was detected. Look at returned data."
"RTN","MAGDRPCA",53,0)
 E  S OUT(1)=COUNT
"RTN","MAGDRPCA",54,0)
 Q
"RTN","MAGDRPCA",55,0)
 ;
"RTN","MAGDRPCA",56,0)
DUPUID(LEVEL,UID) ; return a list of ^MAG(2005) entries with dup uids
"RTN","MAGDRPCA",57,0)
 N COUNT,DFN,DUPUID,I,MAG0,MAG2,MAGIEN,PARENT,RETURN,XREF,XREFLIST
"RTN","MAGDRPCA",58,0)
 S MAGIEN=""
"RTN","MAGDRPCA",59,0)
 F  S MAGIEN=$O(^MAG(2005,"P",UID,MAGIEN)) Q:MAGIEN=""  D
"RTN","MAGDRPCA",60,0)
 . S MAG0=$G(^MAG(2005,MAGIEN,0)),DFN=$P(MAG0,"^",7)
"RTN","MAGDRPCA",61,0)
 . S MAG2=$G(^MAG(2005,MAGIEN,2))
"RTN","MAGDRPCA",62,0)
 . S PARENT="" F I=6,7,8,10 S PARENT=PARENT_"^"_$P(MAG2,"^",I)
"RTN","MAGDRPCA",63,0)
 . S DUPUID(MAGIEN)=DFN_PARENT
"RTN","MAGDRPCA",64,0)
 . S XREFLIST(DFN_PARENT,MAGIEN)=""
"RTN","MAGDRPCA",65,0)
 . Q
"RTN","MAGDRPCA",66,0)
 . ; remove duplicate Study UIDs for different groups for the same study
"RTN","MAGDRPCA",67,0)
 I LEVEL="STUDY" D
"RTN","MAGDRPCA",68,0)
 . S COUNT=0,XREF=""
"RTN","MAGDRPCA",69,0)
 . F  S XREF=$O(XREFLIST(XREF)) Q:XREF=""  S COUNT=COUNT+1
"RTN","MAGDRPCA",70,0)
 . I COUNT=1 K DUPUID
"RTN","MAGDRPCA",71,0)
 . Q
"RTN","MAGDRPCA",72,0)
 S COUNT=0,(MAGIEN,RETURN)=""
"RTN","MAGDRPCA",73,0)
 F  S MAGIEN=$O(DUPUID(MAGIEN)) Q:MAGIEN=""  D
"RTN","MAGDRPCA",74,0)
 . S RETURN=RETURN_"^"_MAGIEN,COUNT=COUNT+1
"RTN","MAGDRPCA",75,0)
 . Q
"RTN","MAGDRPCA",76,0)
 Q COUNT_RETURN
"RTN","MAGDRPCA",77,0)
 ;
"RTN","MAGDRPCA",78,0)
LOOKUP(OUT,MAGIEN) ; RPC = MAG DICOM IMPORTER LOOKUP
"RTN","MAGDRPCA",79,0)
 S OUT=$$LOOKUP1(MAGIEN)
"RTN","MAGDRPCA",80,0)
 Q
"RTN","MAGDRPCA",81,0)
 ;
"RTN","MAGDRPCA",82,0)
LOOKUP1(MAGIEN) ; patient and accession number lookup
"RTN","MAGDRPCA",83,0)
 N DFN,I,MAG0,MAG2,NUMBER,OUT,TMP,VADM,X
"RTN","MAGDRPCA",84,0)
 S MAG0=$G(^MAG(2005,MAGIEN,0)),MAG2=$G(^(2))
"RTN","MAGDRPCA",85,0)
 S DFN=+$P(MAG0,"^",7)
"RTN","MAGDRPCA",86,0)
 D  ; Protect variables that are referenced by the DEM^VADPT
"RTN","MAGDRPCA",87,0)
 . N A,I,J,K,K1,NC,NF,NQ,T,VAHOW,VAPTYP,VAROOT,X
"RTN","MAGDRPCA",88,0)
 . D DEM^VADPT  ; Supported IA (#10061)
"RTN","MAGDRPCA",89,0)
 . Q
"RTN","MAGDRPCA",90,0)
 S X="^"_DFN ; piece 1 is for an error message
"RTN","MAGDRPCA",91,0)
 S X=X_"^"_VADM(1) ; patient name
"RTN","MAGDRPCA",92,0)
 S X=X_"^"_VA("PID") ; patient id
"RTN","MAGDRPCA",93,0)
 S TMP=$S(VADM(3)>0:17000000+VADM(3),1:"-1,Invalid date of birth")
"RTN","MAGDRPCA",94,0)
 S X=X_"^"_TMP ; Patient DOB
"RTN","MAGDRPCA",95,0)
 S X=X_"^"_$P(VADM(5),"^",1) ; patient sex
"RTN","MAGDRPCA",96,0)
 ; $$GETICN^MPIF001 can return error code and message separated
"RTN","MAGDRPCA",97,0)
 ; by "^". If this happens, the "^" is replaced by comma.
"RTN","MAGDRPCA",98,0)
 S TMP=$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(DFN),1:"-1^NO MPI") ; Supported IA (#2701)
"RTN","MAGDRPCA",99,0)
 S X=X_"^"_$TR(TMP,"^",",") ; ICN
"RTN","MAGDRPCA",100,0)
 I $P(MAG2,"^",6)=2006.5839 D  ; temporary consult association
"RTN","MAGDRPCA",101,0)
 . N ACNUMB,GMRCIEN,MODIFIER,PROCNAME,STUDYDAT
"RTN","MAGDRPCA",102,0)
 . S GMRCIEN=$P(MAG2,"^",7),ACNUMB="GMRC-"_GMRCIEN
"RTN","MAGDRPCA",103,0)
 . S TMP=$$GET1^DIQ(123,GMRCIEN,.01,"I")\1
"RTN","MAGDRPCA",104,0)
 . S STUDYDAT=$S(TMP>0:17000000+TMP,1:"-1,Invalid study date")
"RTN","MAGDRPCA",105,0)
 . S PROCNAME=$$GET1^DIQ(123,GMRCIEN,1) ; TO SERVICE
"RTN","MAGDRPCA",106,0)
 . S MODIFIER=$$GET1^DIQ(123,GMRCIEN,4) ; PROCEDURE
"RTN","MAGDRPCA",107,0)
 . S X=X_"^"_ACNUMB_"^"_STUDYDAT_"^"_PROCNAME_"^"_MODIFIER
"RTN","MAGDRPCA",108,0)
 . Q
"RTN","MAGDRPCA",109,0)
 E  D  ; regular association
"RTN","MAGDRPCA",110,0)
 . S NUMBER="`"_MAGIEN D IENLOOK^MAGDRPC9 ; lookup accession number
"RTN","MAGDRPCA",111,0)
 . I OUT(1)<0 S X=OUT(1)_" detected in IENLOOK^MAGDRPC9"
"RTN","MAGDRPCA",112,0)
 . E  S X=X_"^"_$P(OUT(2),"^",4,7) ; accession number, study date, procedure
"RTN","MAGDRPCA",113,0)
 . Q
"RTN","MAGDRPCA",114,0)
 Q X
"RTN","MAGDRPCA",115,0)
 ;
"RTN","MAGDRPCA",116,0)
 ;
"RTN","MAGDRPCA",117,0)
 ;
"RTN","MAGDRPCA",118,0)
GETDFN(OUT,ICN) ; RPC = MAG DICOM GET DFN
"RTN","MAGDRPCA",119,0)
 S OUT=$S($T(GETDFN^MPIF001)'="":$$GETDFN^MPIF001(ICN),1:"-1^NO MPI") ; Supported IA (#2701)
"RTN","MAGDRPCA",120,0)
 Q
"RTN","MAGDRPCA",121,0)
 ;
"RTN","MAGDRPCA",122,0)
 ;
"RTN","MAGDRPCA",123,0)
 ;
"RTN","MAGDRPCA",124,0)
ACNUMB(OUT,ACNUMB) ; RPC = MAG DICOM GET RAD INFO BY ACN
"RTN","MAGDRPCA",125,0)
 N RADFN,RADTI,LIST,STATUS
"RTN","MAGDRPCA",126,0)
 I $T(ACCFIND^RAAPI)'="" D  ; requires RA*5.0*47
"RTN","MAGDRPCA",127,0)
 . S STATUS=$$ACCFIND^RAAPI(ACNUMB,.LIST) ; Private IA (#5020) 
"RTN","MAGDRPCA",128,0)
 . Q
"RTN","MAGDRPCA",129,0)
 E  D  ; before RA*5.0*47
"RTN","MAGDRPCA",130,0)
 . S STATUS=$$ACCFIND(ACNUMB,.LIST)
"RTN","MAGDRPCA",131,0)
 . Q
"RTN","MAGDRPCA",132,0)
 I STATUS<0 S OUT=STATUS Q
"RTN","MAGDRPCA",133,0)
 S OUT=STATUS_"^"_LIST(1)
"RTN","MAGDRPCA",134,0)
 ; add the imaging location as 5th piece of the results
"RTN","MAGDRPCA",135,0)
 S RADFN=$P(LIST(1),"^",1),RADTI=$P(LIST(1),"^",2)
"RTN","MAGDRPCA",136,0)
 S OUT=OUT_"^"_$$GET1^DIQ(79.1,$P(^RADPT(RADFN,"DT",RADTI,0),"^",4),.01)
"RTN","MAGDRPCA",137,0)
 Q
"RTN","MAGDRPCA",138,0)
 ;
"RTN","MAGDRPCA",139,0)
ACCFIND(Y,RAA) ; borrowed from RA*5.0*47
"RTN","MAGDRPCA",140,0)
 ;
"RTN","MAGDRPCA",141,0)
 ;input : Y=the accession number in either a 'sss-mmddyy-xxxxx' or
"RTN","MAGDRPCA",142,0)
 ;          'mmddyy-xxxxx' format
"RTN","MAGDRPCA",143,0)
 ;      : RAA(n)=the array used to return the data in the following
"RTN","MAGDRPCA",144,0)
 ;               format RADFN_^_RADTI_^_RACNI
"RTN","MAGDRPCA",145,0)
 ;
"RTN","MAGDRPCA",146,0)
 ;return: n>0 successful, else n<0... 'n' is the number of array
"RTN","MAGDRPCA",147,0)
 ;        elements when successful. When unsuccessful (n<0) 'n' is
"RTN","MAGDRPCA",148,0)
 ;        a specific error dialog which is returned along with the
"RTN","MAGDRPCA",149,0)
 ;        invalid accession number.
"RTN","MAGDRPCA",150,0)
 ;
"RTN","MAGDRPCA",151,0)
 ;        Examples:
"RTN","MAGDRPCA",152,0)
 ;        -1^"invalid site accession number format"^accession #
"RTN","MAGDRPCA",153,0)
 ;        -2^"invalid accession number format"^accession #
"RTN","MAGDRPCA",154,0)
 ;        -3^"no data associated with this accession number"^accession #
"RTN","MAGDRPCA",155,0)
 ;
"RTN","MAGDRPCA",156,0)
 I $L(Y,"-")=3 Q:Y'?3N1"-"6N1"-"1.5N "-1^invalid site accession number format^"_Y
"RTN","MAGDRPCA",157,0)
 I $L(Y,"-")=2 Q:Y'?6N1"-"1.5N "-2^invalid accession number format^"_Y
"RTN","MAGDRPCA",158,0)
 N X S X=$S($L(Y,"-")=3:$NA(^RADPT("ADC1")),1:$NA(^RADPT("ADC"))) ; Private IA (#1172)
"RTN","MAGDRPCA",159,0)
 Q:$O(@X@(Y,0))'>0 "-3^no data associated with this accession number^"_Y
"RTN","MAGDRPCA",160,0)
 N RADFN,RADTI,RACNI,Z S:$D(U)#2=0 U="^"
"RTN","MAGDRPCA",161,0)
 S (RADFN,Z)=0 F  S RADFN=$O(@X@(Y,RADFN)) Q:'RADFN  D
"RTN","MAGDRPCA",162,0)
 . S RADTI=0 F  S RADTI=$O(@X@(Y,RADFN,RADTI)) Q:'RADTI  D
"RTN","MAGDRPCA",163,0)
 . . S RACNI=0 F  S RACNI=$O(@X@(Y,RADFN,RADTI,RACNI)) Q:'RACNI  D
"RTN","MAGDRPCA",164,0)
 . . . S Z=Z+1,RAA(Z)=RADFN_U_RADTI_U_RACNI
"RTN","MAGDRPCA",165,0)
 . . . Q
"RTN","MAGDRPCA",166,0)
 . . Q
"RTN","MAGDRPCA",167,0)
 . Q
"RTN","MAGDRPCA",168,0)
 Q Z ;success
"RTN","MAGDRPCA",169,0)
 ;
"RTN","MAGDRPCA",170,0)
 ;
"RTN","MAGDRPCA",171,0)
 ;
"RTN","MAGDRPCA",172,0)
DELETE(OUT,IMAGEUID,MACHID,FILEPATH) ; RPC = MAG DICOM IMPORTER DELETE
"RTN","MAGDRPCA",173,0)
 S OUT=$$DELETE^MAGDIR8R(IMAGEUID,MACHID,FILEPATH)
"RTN","MAGDRPCA",174,0)
 Q
"RTN","MAGDRPCA",175,0)
 ;
"RTN","MAGDRPCA",176,0)
 ;***** RETURNS THE LIST OF RADIOLOGY PROCEDURES
"RTN","MAGDRPCA",177,0)
 ; RPC: MAG DICOM RADIOLOGY PROCEDURES
"RTN","MAGDRPCA",178,0)
 ;
"RTN","MAGDRPCA",179,0)
 ; .ARRAY        Reference to a local variable where results
"RTN","MAGDRPCA",180,0)
 ;               are returned to.
"RTN","MAGDRPCA",181,0)
 ;
"RTN","MAGDRPCA",182,0)
 ; DIV           IEN of a record in the INSTITUTION file (#4)
"RTN","MAGDRPCA",183,0)
 ;
"RTN","MAGDRPCA",184,0)
PROC(ARRAY,DIV) ;
"RTN","MAGDRPCA",185,0)
 N IMAGTYPE      ; IEN of the imaging type (file #79.2)
"RTN","MAGDRPCA",186,0)
 N INACTDAT      ; Inactivation date of the procedure
"RTN","MAGDRPCA",187,0)
 N OMLDAT        ; Outside imaging location data (file #2006.5759)
"RTN","MAGDRPCA",188,0)
 N OMLIEN        ; IEN in OUTSIDE IMAGING LOCATION file (#2006.5759)
"RTN","MAGDRPCA",189,0)
 N RADPROC       ; Radiology procedure data (file #71)
"RTN","MAGDRPCA",190,0)
 N TODAY         ; today's date in Fileman format
"RTN","MAGDRPCA",191,0)
 ;
"RTN","MAGDRPCA",192,0)
 N BUF,ERROR,IEN,Z
"RTN","MAGDRPCA",193,0)
 K ARRAY
"RTN","MAGDRPCA",194,0)
 ;
"RTN","MAGDRPCA",195,0)
 ;--- Validate parameters
"RTN","MAGDRPCA",196,0)
 S DIV=$G(DIV)
"RTN","MAGDRPCA",197,0)
 I (DIV'>0)!(DIV'=+DIV)  D  Q
"RTN","MAGDRPCA",198,0)
 . S ARRAY(1)="-1,Invalid Institution IEN: '"_DIV_"'."
"RTN","MAGDRPCA",199,0)
 . Q
"RTN","MAGDRPCA",200,0)
 I $D(^DIC(4,DIV))<10  D  Q
"RTN","MAGDRPCA",201,0)
 . S ARRAY(1)="-2,Institution with IEN="_DIV_" does not exist."
"RTN","MAGDRPCA",202,0)
 . Q
"RTN","MAGDRPCA",203,0)
 ;
"RTN","MAGDRPCA",204,0)
 S ERROR=$$DISPLAY^MAGDAIRG(0)
"RTN","MAGDRPCA",205,0)
 I ERROR=-1 D  Q
"RTN","MAGDRPCA",206,0)
 . S ARRAY(1)="-3,""No Credit"" entries must be added to the IMAGING LOCATIONS file (#79.1)"
"RTN","MAGDRPCA",207,0)
 . S ARRAY(2)=""
"RTN","MAGDRPCA",208,0)
 . S ARRAY(3)="Use the IMPORTER MENU option CHECK OUTSIDE IMAGING LOCATION FILE"
"RTN","MAGDRPCA",209,0)
 . S ARRAY(4)="on the VistA system to correct the problem."
"RTN","MAGDRPCA",210,0)
 . Q
"RTN","MAGDRPCA",211,0)
 I ERROR=-2 D  Q
"RTN","MAGDRPCA",212,0)
 . S ARRAY(1)="-4,Entries must be added to the OUTSIDE IMAGING LOCATIONS file (#2006.5759)"
"RTN","MAGDRPCA",213,0)
 . S ARRAY(2)=""
"RTN","MAGDRPCA",214,0)
 . S ARRAY(3)="Use the IMPORTER MENU option BUILD OUTSIDE IMAGING LOCATION FILE"
"RTN","MAGDRPCA",215,0)
 . S ARRAY(4)="on the VistA system to correct the problem."
"RTN","MAGDRPCA",216,0)
 . Q
"RTN","MAGDRPCA",217,0)
 I ERROR'=0 D  Q
"RTN","MAGDRPCA",218,0)
 . S ARRAY(1)="-5,Unexpected error #"_ERROR_" returned by $$DISPLAY^MAGDAIRG(0)"
"RTN","MAGDRPCA",219,0)
 . Q
"RTN","MAGDRPCA",220,0)
 ;
"RTN","MAGDRPCA",221,0)
 S (ARRAY(1),IEN)=0,TODAY=$$DT^XLFDT()
"RTN","MAGDRPCA",222,0)
 F  S IEN=$O(^RAMIS(71,IEN))  Q:'IEN  D  ; Private IA (#1174) 
"RTN","MAGDRPCA",223,0)
 . S RADPROC=^RAMIS(71,IEN,0),IMAGTYPE=+$P(RADPROC,U,12)
"RTN","MAGDRPCA",224,0)
 . ;--- Get outside imaging location associated
"RTN","MAGDRPCA",225,0)
 . ;--- with the imaging type of the procedure
"RTN","MAGDRPCA",226,0)
 . S OMLIEN=$O(^MAGD(2006.5759,"D",DIV,IMAGTYPE,""))  Q:'OMLIEN
"RTN","MAGDRPCA",227,0)
 . S OMLDAT=$G(^MAGD(2006.5759,OMLIEN,0))
"RTN","MAGDRPCA",228,0)
 . Q:$P(OMLDAT,U,4)'=DIV  ; Has to be in the same Division
"RTN","MAGDRPCA",229,0)
 . ;--- Prepare the procedure descriptor
"RTN","MAGDRPCA",230,0)
 . S BUF=$P(RADPROC,U)_U_IEN      ; Procedure Name and IEN
"RTN","MAGDRPCA",231,0)
 . S $P(BUF,U,3)=$P(RADPROC,U,6)  ; Type of Procedure
"RTN","MAGDRPCA",232,0)
 . S $P(BUF,U,4)=$P(RADPROC,U,9)  ; CPT Code (file #81)
"RTN","MAGDRPCA",233,0)
 . S $P(BUF,U,5)=IMAGTYPE         ; Type of Imaging (file #79.2)
"RTN","MAGDRPCA",234,0)
 . S INACTDAT=$P($G(^RAMIS(71,IEN,"I")),U)
"RTN","MAGDRPCA",235,0)
 . I INACTDAT,INACTDAT<TODAY Q    ; ignore inactive procedures
"RTN","MAGDRPCA",236,0)
 . S $P(BUF,U,6)=INACTDAT         ; Inactivation Date
"RTN","MAGDRPCA",237,0)
 . S $P(BUF,U,7)=$P(OMLDAT,U)     ; Imaging Location (file #79.1)
"RTN","MAGDRPCA",238,0)
 . S Z=$P(OMLDAT,U,3)
"RTN","MAGDRPCA",239,0)
 . S $P(BUF,U,8)=Z                ; Hospital Location (file #44) - IEN
"RTN","MAGDRPCA",240,0)
 . S $P(BUF,U,9)=$$GET1^DIQ(44,Z,.01) ; Hospital Location (file #44) - NAME
"RTN","MAGDRPCA",241,0)
 . ;--- Add the descriptor to the result array
"RTN","MAGDRPCA",242,0)
 . S ARRAY(1)=ARRAY(1)+1,ARRAY(ARRAY(1)+1)=BUF
"RTN","MAGDRPCA",243,0)
 . Q
"RTN","MAGDRPCA",244,0)
 Q
"RTN","MAGDRPCA",245,0)
 ;
"RTN","MAGDRPCA",246,0)
 ;***** RETURNS THE LIST OF RADIOLOGY PROCEDURE MODIFIERS
"RTN","MAGDRPCA",247,0)
 ; RPC: MAG DICOM RADIOLOGY MODIFIERS
"RTN","MAGDRPCA",248,0)
 ;
"RTN","MAGDRPCA",249,0)
 ; .ARRAY        Reference to a local variable where results
"RTN","MAGDRPCA",250,0)
 ;               are returned to.
"RTN","MAGDRPCA",251,0)
 ;
"RTN","MAGDRPCA",252,0)
MOD(ARRAY) ;
"RTN","MAGDRPCA",253,0)
 N IEN           ; IEN in the PROCEDURE MODIFIERS file (#71.2)
"RTN","MAGDRPCA",254,0)
 N IEN2          ; IEN in the TYPE OF IMAGING subfile (#71.23)
"RTN","MAGDRPCA",255,0)
 N IMAGTYPE      ; Imaging type (#79.2)
"RTN","MAGDRPCA",256,0)
 N MODIFIER      ; Radiology procedure modifier name (71.2,.01)
"RTN","MAGDRPCA",257,0)
 N PROCMOD       ; Radiology procedure modifier data
"RTN","MAGDRPCA",258,0)
 ;
"RTN","MAGDRPCA",259,0)
 K ARRAY
"RTN","MAGDRPCA",260,0)
 ;
"RTN","MAGDRPCA",261,0)
 S (ARRAY(1),IEN)=0
"RTN","MAGDRPCA",262,0)
 F  S IEN=$O(^RAMIS(71.2,IEN))  Q:'IEN  D  ; Private IA (#4197) 
"RTN","MAGDRPCA",263,0)
 . S PROCMOD=^RAMIS(71.2,IEN,0),MODIFIER=$P(PROCMOD,U)
"RTN","MAGDRPCA",264,0)
 . S IEN2=0
"RTN","MAGDRPCA",265,0)
 . F  S IEN2=$O(^RAMIS(71.2,IEN,1,IEN2))  Q:'IEN2  D
"RTN","MAGDRPCA",266,0)
 . . S IMAGTYPE=+$G(^RAMIS(71.2,IEN,1,IEN2,0))  Q:'IMAGTYPE
"RTN","MAGDRPCA",267,0)
 . . S ARRAY(1)=ARRAY(1)+1
"RTN","MAGDRPCA",268,0)
 . . S ARRAY(ARRAY(1)+1)=MODIFIER_U_IEN_U_IMAGTYPE
"RTN","MAGDRPCA",269,0)
 . . Q
"RTN","MAGDRPCA",270,0)
 . Q
"RTN","MAGDRPCA",271,0)
 Q
"RTN","MAGDTR05")
0^21^B48114402
"RTN","MAGDTR05",1,0)
MAGDTR05 ;WOIFO/PMK/JSL/SAF - Read a DICOM image file ; 25 Sep 2008 10:53 AM
"RTN","MAGDTR05",2,0)
 ;;3.0;IMAGING;**46,54,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGDTR05",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGDTR05",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR05",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGDTR05",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGDTR05",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGDTR05",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGDTR05",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGDTR05",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGDTR05",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGDTR05",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGDTR05",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGDTR05",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGDTR05",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGDTR05",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGDTR05",17,0)
 ;;
"RTN","MAGDTR05",18,0)
LOOKUP(OUT,STATNUMB,ISPECIDX,IPROCS,STARTING,DUZREAD,DUZREAD2,LOCKTIME,STATLIST) ; RPC = MAG DICOM CON UNREADLIST GET
"RTN","MAGDTR05",19,0)
 ; entry point to lookup entries in file
"RTN","MAGDTR05",20,0)
 ; 
"RTN","MAGDTR05",21,0)
 ; OUT ------- Return array
"RTN","MAGDTR05",22,0)
 ; STATNUMB -- Acquisition Station Number
"RTN","MAGDTR05",23,0)
 ; ISPECIDX -- Index to Specialties (2005.84)
"RTN","MAGDTR05",24,0)
 ; IPROCS ---- Indexes to Procedures (2005.85) - this is a comma-delimited list
"RTN","MAGDTR05",25,0)
 ; STARTING -- Fileman date/time to begin sequential search
"RTN","MAGDTR05",26,0)
 ; DUZREAD --- User's DUZ at the Reading Site
"RTN","MAGDTR05",27,0)
 ; DUZREAD2 -- DIC(4) pointer to Reading Site
"RTN","MAGDTR05",28,0)
 ; LOCKTIME -- timeout value for LOCKTIME
"RTN","MAGDTR05",29,0)
 ; STATLIST -- status of entry (C, L, R, U, or W, in any combination)
"RTN","MAGDTR05",30,0)
 ; 
"RTN","MAGDTR05",31,0)
 N ACQSITE ;- site index in Unread List
"RTN","MAGDTR05",32,0)
 N ISTATUS ;-- counter to the status in STATLIST
"RTN","MAGDTR05",33,0)
 N IPROC ;---- counter to IPROCS
"RTN","MAGDTR05",34,0)
 N IPROCIDX ;- index to procedures (2005.85)
"RTN","MAGDTR05",35,0)
 N TIMESTMP ;- last activity date/time for the entry
"RTN","MAGDTR05",36,0)
 N SITENAME ;- name of acquisition site
"RTN","MAGDTR05",37,0)
 N STATUS1 ;-- one status out of the STATLIST
"RTN","MAGDTR05",38,0)
 N UNREAD ;--- pointer to entry in unread list
"RTN","MAGDTR05",39,0)
 ;
"RTN","MAGDTR05",40,0)
 S DUZREAD=$G(DUZREAD,0),DUZREAD2=$G(DUZREAD2,0),LOCKTIME=$G(LOCKTIME,0)
"RTN","MAGDTR05",41,0)
 S STATLIST=$$UP^MAGDFCNV($G(STATLIST))
"RTN","MAGDTR05",42,0)
 I STATLIST="" S STATLIST="CDLRUW" ; default to all STATUS values
"RTN","MAGDTR05",43,0)
 ;
"RTN","MAGDTR05",44,0)
 S ACQSITE=$$ACQSITE^MAGDTR06(STATNUMB)
"RTN","MAGDTR05",45,0)
 I ACQSITE<0  S OUT="-1, ACQUISITION STATION NUMBER "_STATNUMB_" IS NOT DEFINED IN FILE 4" Q
"RTN","MAGDTR05",46,0)
 S SITENAME=$P(ACQSITE,"^",2),ACQSITE=$P(ACQSITE,"^",1)
"RTN","MAGDTR05",47,0)
 ;
"RTN","MAGDTR05",48,0)
 I LOCKTIME,DUZREAD2 D UNLOCKER ; automatically unlock timed out studies
"RTN","MAGDTR05",49,0)
 ;
"RTN","MAGDTR05",50,0)
 K OUT
"RTN","MAGDTR05",51,0)
 I STARTING=0 D  ; loop through the STATUS index because it is faster
"RTN","MAGDTR05",52,0)
 . S STATLIST=$TR(STATLIST,"D") ; remove the DELETED status from STATLIST
"RTN","MAGDTR05",53,0)
 . F ISTATUS=1:1:$L(STATLIST) S STATUS1=$E(STATLIST,ISTATUS) D
"RTN","MAGDTR05",54,0)
 . . F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",55,0)
 . . . S UNREAD=""
"RTN","MAGDTR05",56,0)
 . . . F  S UNREAD=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,STATUS1,UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",57,0)
 . . . . D LOOKUP1(UNREAD)
"RTN","MAGDTR05",58,0)
 . . . . Q
"RTN","MAGDTR05",59,0)
 . . . Q
"RTN","MAGDTR05",60,0)
 . . Q
"RTN","MAGDTR05",61,0)
 . Q
"RTN","MAGDTR05",62,0)
 E  D  ; retrieve just the latest events
"RTN","MAGDTR05",63,0)
 . F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",64,0)
 . . S TIMESTMP=STARTING ; reinitialize the starting date & time for each index to procedures
"RTN","MAGDTR05",65,0)
 . . F  S TIMESTMP=$O(^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,TIMESTMP)) Q:TIMESTMP=""  D
"RTN","MAGDTR05",66,0)
 . . . S UNREAD=""
"RTN","MAGDTR05",67,0)
 . . . F  S UNREAD=$O(^MAG(2006.5849,"AC",ACQSITE,ISPECIDX,IPROCIDX,TIMESTMP,UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",68,0)
 . . . . D LOOKUP1(UNREAD)
"RTN","MAGDTR05",69,0)
 . . . . Q
"RTN","MAGDTR05",70,0)
 . . . Q
"RTN","MAGDTR05",71,0)
 . . Q
"RTN","MAGDTR05",72,0)
 . Q
"RTN","MAGDTR05",73,0)
 Q
"RTN","MAGDTR05",74,0)
 ;
"RTN","MAGDTR05",75,0)
LOOKUP1(UNREAD) ; retrieve one entry from the unread list
"RTN","MAGDTR05",76,0)
 N GMRCIEN
"RTN","MAGDTR05",77,0)
 N DFN
"RTN","MAGDTR05",78,0)
 N VADM
"RTN","MAGDTR05",79,0)
 N ICN
"RTN","MAGDTR05",80,0)
 N IFCSITE,IFCIEN,IFCSITEA,IFCRTIME,IFCLTIME,IFCETIME
"RTN","MAGDTR05",81,0)
 N LISTDATA ;- read/unread list data
"RTN","MAGDTR05",82,0)
 N QUIT
"RTN","MAGDTR05",83,0)
 N READER
"RTN","MAGDTR05",84,0)
 N SHORTID
"RTN","MAGDTR05",85,0)
 N STATUS
"RTN","MAGDTR05",86,0)
 N VA,VADM,VAERR
"RTN","MAGDTR05",87,0)
 N VIPSTS ; VIP status
"RTN","MAGDTR05",88,0)
 N I,LAST,X,Z
"RTN","MAGDTR05",89,0)
 ;
"RTN","MAGDTR05",90,0)
 S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR05",91,0)
 S STATUS=$P(LISTDATA,"^",11) ; status
"RTN","MAGDTR05",92,0)
 Q:STATLIST'[STATUS  ; skip the entry if it is not the right STATUS
"RTN","MAGDTR05",93,0)
 ;
"RTN","MAGDTR05",94,0)
 S GMRCIEN=$P(LISTDATA,"^",1)
"RTN","MAGDTR05",95,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; Routing Facility
"RTN","MAGDTR05",96,0)
 ;
"RTN","MAGDTR05",97,0)
 ; check if this consult can it be displayed to the reader
"RTN","MAGDTR05",98,0)
 S QUIT=0
"RTN","MAGDTR05",99,0)
 I DUZREAD D  Q:QUIT
"RTN","MAGDTR05",100,0)
 . I IFCSITE D  Q:QUIT  ; IFC reading site
"RTN","MAGDTR05",101,0)
 . . I IFCSITE'=DUZREAD2 S QUIT=1
"RTN","MAGDTR05",102,0)
 . . Q
"RTN","MAGDTR05",103,0)
 . I STATUS="W" S QUIT=2 Q
"RTN","MAGDTR05",104,0)
 . I STATUS="L" D  Q:QUIT
"RTN","MAGDTR05",105,0)
 . . S READER=$P(LISTDATA,"^",15) ; reader
"RTN","MAGDTR05",106,0)
 . . I READER,READER'=DUZREAD S QUIT=3
"RTN","MAGDTR05",107,0)
 . . Q
"RTN","MAGDTR05",108,0)
 . Q
"RTN","MAGDTR05",109,0)
 ;
"RTN","MAGDTR05",110,0)
 ; acquisition site identification
"RTN","MAGDTR05",111,0)
 S Z=UNREAD_"|"_GMRCIEN_"|"_STATNUMB_"|"_SITENAME
"RTN","MAGDTR05",112,0)
 ; patient information
"RTN","MAGDTR05",113,0)
 S DFN=$$GET1^DIQ(123,GMRCIEN,.02,"I")
"RTN","MAGDTR05",114,0)
 D DEM^VADPT,PTSEC^DGSEC4(.VIPSTS,DFN)
"RTN","MAGDTR05",115,0)
 S ICN=$S($T(GETICN^MPIF001)'="":$$GETICN^MPIF001(DFN),1:"-1^NO MPI")  ;p123
"RTN","MAGDTR05",116,0)
 S X=$TR(VA("PID"),"-",""),SHORTID=$E(VADM(1),1)_$E(X,$L(X)-3,$L(X)) ;P123
"RTN","MAGDTR05",117,0)
 S Z=Z_"|"_VADM(1)_"|"_VA("PID")_"|"_ICN_"|"_SHORTID ;P123
"RTN","MAGDTR05",118,0)
 S Z=Z_"|"_VIPSTS(1) ; VIP status
"RTN","MAGDTR05",119,0)
 S Z=Z_"|"_$P(^MAG(2005.84,ISPECIDX,0),"^",1)_"|"_$P(^MAG(2005.84,ISPECIDX,2),"^",1)
"RTN","MAGDTR05",120,0)
 S Z=Z_"|"_$P(^MAG(2005.85,IPROCIDX,0),"^",1)_"|"_$P(^MAG(2005.85,IPROCIDX,2),"^",1)
"RTN","MAGDTR05",121,0)
 ; time stamps and image acquisition statistics
"RTN","MAGDTR05",122,0)
 S Z=Z_"|"_$P(LISTDATA,"^",7) ; time of first image
"RTN","MAGDTR05",123,0)
 S Z=Z_"|"_$P(LISTDATA,"^",8) ; time of last image
"RTN","MAGDTR05",124,0)
 S Z=Z_"|"_$P(LISTDATA,"^",9) ; time of last activity
"RTN","MAGDTR05",125,0)
 S Z=Z_"|"_(+$P(LISTDATA,"^",10)) ; #images
"RTN","MAGDTR05",126,0)
 S Z=Z_"|"_STATUS
"RTN","MAGDTR05",127,0)
 S Z=Z_"|"_$$GET1^DIQ(123,GMRCIEN,13,"I") ; consult/procedure flag
"RTN","MAGDTR05",128,0)
 S Z=Z_"|"_$P($$GET1^DIQ(123,GMRCIEN,5)," - ",2) ; GMRC urgency
"RTN","MAGDTR05",129,0)
 ;
"RTN","MAGDTR05",130,0)
 ; get inter-facility consult data
"RTN","MAGDTR05",131,0)
 S IFCSITE=$$GET1^DIQ(123,GMRCIEN,.07,"I") ; Routing Facility
"RTN","MAGDTR05",132,0)
 I IFCSITE D  ; inter-facility consult
"RTN","MAGDTR05",133,0)
 . S IFCIEN=$$GET1^DIQ(123,GMRCIEN,.06,"I") ; remote consult file entry
"RTN","MAGDTR05",134,0)
 . ; get IFC site abbreviation
"RTN","MAGDTR05",135,0)
 . S I=$O(^MAG(2006.19,"D",IFCSITE,""))
"RTN","MAGDTR05",136,0)
 . S IFCSITEA=$S(I:$P($G(^MAG(2006.19,I,0)),"^",4),1:"?")
"RTN","MAGDTR05",137,0)
 . S IFCLTIME=$P(LISTDATA,"^",5),IFCRTIME=$P(LISTDATA,"^",6)
"RTN","MAGDTR05",138,0)
 . I IFCLTIME,IFCRTIME S IFCETIME=$$FMDIFF^XLFDT(IFCRTIME,IFCLTIME,2)
"RTN","MAGDTR05",139,0)
 . E  S IFCETIME=""
"RTN","MAGDTR05",140,0)
 . Q
"RTN","MAGDTR05",141,0)
 E  D  ; local consult
"RTN","MAGDTR05",142,0)
 . S (IFCIEN,IFCSITEA,IFCRTIME,IFCLTIME,IFCETIME)=""
"RTN","MAGDTR05",143,0)
 . Q
"RTN","MAGDTR05",144,0)
 S Z=Z_"|"_IFCSITE_"|"_IFCSITEA_"|"_IFCIEN
"RTN","MAGDTR05",145,0)
 S Z=Z_"|"_IFCLTIME_"|"_IFCRTIME_"|"_IFCETIME
"RTN","MAGDTR05",146,0)
 F I=12:1:16 S Z=Z_"|"_$P(LISTDATA,"^",I) ; reader identification
"RTN","MAGDTR05",147,0)
 S Z=Z_"|"_$P(LISTDATA,"^",17) ; start of reading
"RTN","MAGDTR05",148,0)
 S Z=Z_"|"_$P(LISTDATA,"^",18) ; end of reading
"RTN","MAGDTR05",149,0)
 S LAST=$G(OUT(1),1) ; first element in the array is the counter
"RTN","MAGDTR05",150,0)
 S LAST=LAST+1,OUT(LAST)=Z,OUT(1)=LAST
"RTN","MAGDTR05",151,0)
 Q
"RTN","MAGDTR05",152,0)
 ;
"RTN","MAGDTR05",153,0)
UNLOCKER ; automatically unlock any timed out studies
"RTN","MAGDTR05",154,0)
 N GMRCIEN
"RTN","MAGDTR05",155,0)
 N IFCSITE
"RTN","MAGDTR05",156,0)
 N SECONDS ;-- date/time in seconds
"RTN","MAGDTR05",157,0)
 N STATUS
"RTN","MAGDTR05",158,0)
 N UNLOCKTM ;- earliest date/time for a lock (FM format)
"RTN","MAGDTR05",159,0)
 N UNREAD ;--- pointer to entry in unread list
"RTN","MAGDTR05",160,0)
 N X
"RTN","MAGDTR05",161,0)
 ;
"RTN","MAGDTR05",162,0)
 ; calculate the earliest automatic unlock date/time
"RTN","MAGDTR05",163,0)
 S SECONDS=86400*$H+$P($H,",",2)-(60*LOCKTIME)
"RTN","MAGDTR05",164,0)
 ; convert to FM format
"RTN","MAGDTR05",165,0)
 S UNLOCKTM=$$HTFM^XLFDT((SECONDS\86400)_","_(SECONDS#86400),0)
"RTN","MAGDTR05",166,0)
 ;
"RTN","MAGDTR05",167,0)
 ; traverse the "lock list" and unlock those that have timed out
"RTN","MAGDTR05",168,0)
 F IPROC=1:1:$L(IPROCS,",") S IPROCIDX=$P(IPROCS,",",IPROC) D
"RTN","MAGDTR05",169,0)
 . S UNREAD=""
"RTN","MAGDTR05",170,0)
 . F  S UNREAD=$O(^MAG(2006.5849,"D",ACQSITE,ISPECIDX,IPROCIDX,"L",UNREAD)) Q:UNREAD=""  D
"RTN","MAGDTR05",171,0)
 . . S LISTDATA=$G(^MAG(2006.5849,UNREAD,0))
"RTN","MAGDTR05",172,0)
 . . ; check for a lock timeout
"RTN","MAGDTR05",173,0)
 . . I $P(LISTDATA,"^",17)<UNLOCKTM D  ; lock timeout
"RTN","MAGDTR05",174,0)
 . . . ; only unlock studies that are to be done at the reading site
"RTN","MAGDTR05",175,0)
 . . . I DUZREAD2=$P(LISTDATA,"^",16) D UNLOCK^MAGDTR04(UNREAD,.STATUS)
"RTN","MAGDTR05",176,0)
 . . . Q
"RTN","MAGDTR05",177,0)
 . . Q
"RTN","MAGDTR05",178,0)
 . Q
"RTN","MAGDTR05",179,0)
 Q
"RTN","MAGIP123")
0^^B4047569
"RTN","MAGIP123",1,0)
MAGIP123 ;WOIFO/JSL/JSL/SAF - INSTALL CODE FOR MAG*3.0*123 ; 08 Nov 2010 3:17 PM
"RTN","MAGIP123",2,0)
 ;;3.0;IMAGING;**123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGIP123",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGIP123",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP123",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGIP123",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGIP123",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGIP123",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGIP123",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGIP123",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGIP123",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGIP123",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGIP123",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGIP123",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGIP123",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGIP123",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGIP123",17,0)
 ;;
"RTN","MAGIP123",18,0)
 Q
"RTN","MAGIP123",19,0)
 ;
"RTN","MAGIP123",20,0)
 ;+++++ INSTALLATION ERROR HANDLING
"RTN","MAGIP123",21,0)
ERROR ;
"RTN","MAGIP123",22,0)
 S:$D(XPDNM) XPDABORT=1
"RTN","MAGIP123",23,0)
 ;--- Display the messages and store them to the INSTALL file
"RTN","MAGIP123",24,0)
 D DUMP^MAGUERR1(),ABTMSG^MAGKIDS()
"RTN","MAGIP123",25,0)
 Q
"RTN","MAGIP123",26,0)
 ;
"RTN","MAGIP123",27,0)
 ;***** POST-INSTALL CODE
"RTN","MAGIP123",28,0)
POST ;
"RTN","MAGIP123",29,0)
 ;P123
"RTN","MAGIP123",30,0)
 D REMTASK^MAGQE4,STTASK^MAGQE4
"RTN","MAGIP123",31,0)
 D BMES^XPDUTL("Post Install Mail Message: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","MAGIP123",32,0)
 D INS^MAGQBUT4(XPDNM,DUZ,$$NOW^XLFDT,XPDA)
"RTN","MAGIP123",33,0)
 Q
"RTN","MAGIP123",34,0)
 ;
"RTN","MAGSPID")
0^22^B3966944
"RTN","MAGSPID",1,0)
MAGSPID ;WOIFO/SF,JSL,DAC - PATIENT DATA UTILITIES ; 07 Jun 2012 12:00 PM
"RTN","MAGSPID",2,0)
 ;;3.0;IMAGING;**122,123**;Mar 19, 2002;Build 67;Jul 24, 2012
"RTN","MAGSPID",3,0)
 ;; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","MAGSPID",4,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSPID",5,0)
 ;; | Property of the US Government.                                |
"RTN","MAGSPID",6,0)
 ;; | No permission to copy or redistribute this software is given. |
"RTN","MAGSPID",7,0)
 ;; | Use of unreleased versions of this software requires the user |
"RTN","MAGSPID",8,0)
 ;; | to execute a written test agreement with the VistA Imaging    |
"RTN","MAGSPID",9,0)
 ;; | Development Office of the Department of Veterans Affairs,     |
"RTN","MAGSPID",10,0)
 ;; | telephone (301) 734-0100.                                     |
"RTN","MAGSPID",11,0)
 ;; | The Food and Drug Administration classifies this software as  |
"RTN","MAGSPID",12,0)
 ;; | a medical device.  As such, it may not be changed in any way. |
"RTN","MAGSPID",13,0)
 ;; | Modifications to this software may result in an adulterated   |
"RTN","MAGSPID",14,0)
 ;; | medical device under 21CFR820, the use of which is considered |
"RTN","MAGSPID",15,0)
 ;; | to be a violation of US Federal Statutes.                     |
"RTN","MAGSPID",16,0)
 ;; +---------------------------------------------------------------+
"RTN","MAGSPID",17,0)
 ;;
"RTN","MAGSPID",18,0)
 Q
"RTN","MAGSPID",19,0)
 ; This routine is used on both VistA and the DICOM Gateway
"RTN","MAGSPID",20,0)
PIDLABEL() ;
"RTN","MAGSPID",21,0)
 Q $S($$ISIHS():"HRN",1:"SSN")
"RTN","MAGSPID",22,0)
 ;
"RTN","MAGSPID",23,0)
DEM(LOC) ;For IHS, call DEM^VADPT but reset DUZ(2) to the instrument division
"RTN","MAGSPID",24,0)
 ;this is because in IHS, patients have different chart numbers in each division
"RTN","MAGSPID",25,0)
 ;this procedure can only be called on VistA or RPMs.  It cannot be called on a DICOM GW
"RTN","MAGSPID",26,0)
 I $G(LOC)="" S LOC=DUZ(2)
"RTN","MAGSPID",27,0)
 S TMPDUZ2=DUZ(2),DUZ(2)=LOC
"RTN","MAGSPID",28,0)
 D DEM^VADPT ; Supported IA (#10061)
"RTN","MAGSPID",29,0)
 S DUZ(2)=TMPDUZ2 K TMPDUZ2
"RTN","MAGSPID",30,0)
 Q
"RTN","MAGSPID",31,0)
 ;
"RTN","MAGSPID",32,0)
ISIHS() ;Is this IHS site? (P123)
"RTN","MAGSPID",33,0)
 ; This function is used on both VistA and the DICOM gateway
"RTN","MAGSPID",34,0)
 ; In VistA DUZ("AG") will be used to determine if a site is an IHS site
"RTN","MAGSPID",35,0)
 ; On the DICOM gateway the DICOM GATEWAY PARAMETER (#2006.563) file will be checked
"RTN","MAGSPID",36,0)
 Q $S($G(DUZ("AG"))="I":1,$G(^MAGDICOM(2006.563,1,"AGENCY"))="I":1,1:0)
"VER")
8.0^22.0
"^DD",2006.563,2006.563,202,0)
AGENCY^S^V:VA;I:IHS;^AGENCY;1^Q
"^DD",2006.563,2006.563,202,3)
Which agency does the DICOM Gateway reside in?
"^DD",2006.563,2006.563,202,21,0)
^.001^1^1^3120608^^^
"^DD",2006.563,2006.563,202,21,1,0)
Identifies which agency the DICOM Gateway resides in. 
"^DD",2006.563,2006.563,202,"DT")
3120608
**END**
**END**
