Released ECX*3*142 SEQ #130
Extracted from mail message
**KIDS**:ECX*3.0*142^

**INSTALL NAME**
ECX*3.0*142
"BLD",9204,0)
ECX*3.0*142^DSS EXTRACTS^0^3130110^y
"BLD",9204,1,0)
^^12^12^3121213^
"BLD",9204,1,1,0)
Patch ECX*3.0*142 addresses three different issues:
"BLD",9204,1,2,0)
 
"BLD",9204,1,3,0)
        1.  IVP Source Audit Report is displaying test patients.
"BLD",9204,1,4,0)
 
"BLD",9204,1,5,0)
  
"BLD",9204,1,6,0)
        2.  After editing DSS Clinic Stop Codes routine (ECXSCLD) does
"BLD",9204,1,7,0)
            not prompt for another clinic but returns to the prior menu.
"BLD",9204,1,8,0)
 
"BLD",9204,1,9,0)
 
"BLD",9204,1,10,0)
 
"BLD",9204,1,11,0)
        3.  Worksheets for DSS Clinic Stops [ECXSCLOAD] option does not
"BLD",9204,1,12,0)
            display edit to Inactive Clinics.
"BLD",9204,4,0)
^9.64PA^^
"BLD",9204,6.3)
3
"BLD",9204,"KRN",0)
^9.67PA^779.2^20
"BLD",9204,"KRN",.4,0)
.4
"BLD",9204,"KRN",.401,0)
.401
"BLD",9204,"KRN",.402,0)
.402
"BLD",9204,"KRN",.403,0)
.403
"BLD",9204,"KRN",.5,0)
.5
"BLD",9204,"KRN",.84,0)
.84
"BLD",9204,"KRN",3.6,0)
3.6
"BLD",9204,"KRN",3.8,0)
3.8
"BLD",9204,"KRN",9.2,0)
9.2
"BLD",9204,"KRN",9.8,0)
9.8
"BLD",9204,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9204,"KRN",9.8,"NM",1,0)
ECXSCLD^^0^B204371648
"BLD",9204,"KRN",9.8,"NM",2,0)
ECXPHAA^^0^B44653526
"BLD",9204,"KRN",9.8,"NM","B","ECXPHAA",2)

"BLD",9204,"KRN",9.8,"NM","B","ECXSCLD",1)

"BLD",9204,"KRN",19,0)
19
"BLD",9204,"KRN",19.1,0)
19.1
"BLD",9204,"KRN",101,0)
101
"BLD",9204,"KRN",409.61,0)
409.61
"BLD",9204,"KRN",771,0)
771
"BLD",9204,"KRN",779.2,0)
779.2
"BLD",9204,"KRN",870,0)
870
"BLD",9204,"KRN",8989.51,0)
8989.51
"BLD",9204,"KRN",8989.52,0)
8989.52
"BLD",9204,"KRN",8994,0)
8994
"BLD",9204,"KRN","B",.4,.4)

"BLD",9204,"KRN","B",.401,.401)

"BLD",9204,"KRN","B",.402,.402)

"BLD",9204,"KRN","B",.403,.403)

"BLD",9204,"KRN","B",.5,.5)

"BLD",9204,"KRN","B",.84,.84)

"BLD",9204,"KRN","B",3.6,3.6)

"BLD",9204,"KRN","B",3.8,3.8)

"BLD",9204,"KRN","B",9.2,9.2)

"BLD",9204,"KRN","B",9.8,9.8)

"BLD",9204,"KRN","B",19,19)

"BLD",9204,"KRN","B",19.1,19.1)

"BLD",9204,"KRN","B",101,101)

"BLD",9204,"KRN","B",409.61,409.61)

"BLD",9204,"KRN","B",771,771)

"BLD",9204,"KRN","B",779.2,779.2)

"BLD",9204,"KRN","B",870,870)

"BLD",9204,"KRN","B",8989.51,8989.51)

"BLD",9204,"KRN","B",8989.52,8989.52)

"BLD",9204,"KRN","B",8994,8994)

"BLD",9204,"QDEF")
^^^^NO^^^^^^YES
"BLD",9204,"QUES",0)
^9.62^^
"BLD",9204,"REQB",0)
^9.611^2^2
"BLD",9204,"REQB",1,0)
ECX*3.0*136^2
"BLD",9204,"REQB",2,0)
ECX*3.0*92^2
"BLD",9204,"REQB","B","ECX*3.0*136",1)

"BLD",9204,"REQB","B","ECX*3.0*92",2)

"MBREQ")
0
"PKG",535,-1)
1^1
"PKG",535,0)
DSS EXTRACTS^ECX
"PKG",535,20,0)
^9.402P^^
"PKG",535,22,0)
^9.49I^1^1
"PKG",535,22,1,0)
3.0^2971222^3000224^66481
"PKG",535,22,1,"PAH",1,0)
142^3130110
"PKG",535,22,1,"PAH",1,1,0)
^^12^12^3130110
"PKG",535,22,1,"PAH",1,1,1,0)
Patch ECX*3.0*142 addresses three different issues:
"PKG",535,22,1,"PAH",1,1,2,0)
 
"PKG",535,22,1,"PAH",1,1,3,0)
        1.  IVP Source Audit Report is displaying test patients.
"PKG",535,22,1,"PAH",1,1,4,0)
 
"PKG",535,22,1,"PAH",1,1,5,0)
  
"PKG",535,22,1,"PAH",1,1,6,0)
        2.  After editing DSS Clinic Stop Codes routine (ECXSCLD) does
"PKG",535,22,1,"PAH",1,1,7,0)
            not prompt for another clinic but returns to the prior menu.
"PKG",535,22,1,"PAH",1,1,8,0)
 
"PKG",535,22,1,"PAH",1,1,9,0)
 
"PKG",535,22,1,"PAH",1,1,10,0)
 
"PKG",535,22,1,"PAH",1,1,11,0)
        3.  Worksheets for DSS Clinic Stops [ECXSCLOAD] option does not
"PKG",535,22,1,"PAH",1,1,12,0)
            display edit to Inactive Clinics.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ECXPHAA")
0^2^B44653526^B42962189
"RTN","ECXPHAA",1,0)
ECXPHAA ;ALB/JRC Pharmacy DSS Extract UDP/IVP Source Audit Report ; 1/8/13 2:42pm
"RTN","ECXPHAA",2,0)
 ;;3.0;DSS EXTRACTS;**92,142**;Dec 22, 1997;Build 3
"RTN","ECXPHAA",3,0)
 ;
"RTN","ECXPHAA",4,0)
EN ;entry point from option
"RTN","ECXPHAA",5,0)
 N SCRNARR,STOP,REPORT,DIVISION,SDATE,EDATE,X,TMP
"RTN","ECXPHAA",6,0)
 S SCRNARR="^TMP($J,""ECXPHAA"")",STOP=0
"RTN","ECXPHAA",7,0)
 K @SCRNARR
"RTN","ECXPHAA",8,0)
 S STOP=0
"RTN","ECXPHAA",9,0)
 ;Select report
"RTN","ECXPHAA",10,0)
 D REPORT  Q:STOP
"RTN","ECXPHAA",11,0)
 ;Select division
"RTN","ECXPHAA",12,0)
 D DIVISION  Q:STOP
"RTN","ECXPHAA",13,0)
 ;Select date range
"RTN","ECXPHAA",14,0)
 D DATES  Q:STOP
"RTN","ECXPHAA",15,0)
 ;Queue Report
"RTN","ECXPHAA",16,0)
 N ZTDESC,ZTIO,ZTSAVE
"RTN","ECXPHAA",17,0)
 F X="REPORT","SDATE","EDATE","STOP" S ZTSAVE(X)=""
"RTN","ECXPHAA",18,0)
 S ZTSAVE("SCRNARR")=""
"RTN","ECXPHAA",19,0)
 S TMP=$$OREF^DILF(SCRNARR)
"RTN","ECXPHAA",20,0)
 S ZTSAVE(TMP)=""
"RTN","ECXPHAA",21,0)
 I $D(@SCRNARR)#2 S ZTSAVE(SCRNARR)=""
"RTN","ECXPHAA",22,0)
 S ZTIO=""
"RTN","ECXPHAA",23,0)
 S ZTDESC="DSS UDP/IVP Source Audit Report"
"RTN","ECXPHAA",24,0)
 D EN^XUTMDEVQ("EN1^ECXPHAA",ZTDESC,.ZTSAVE)
"RTN","ECXPHAA",25,0)
 Q
"RTN","ECXPHAA",26,0)
 ;
"RTN","ECXPHAA",27,0)
EN1 ;Init variables
"RTN","ECXPHAA",28,0)
 N PAGE,LN,SUB
"RTN","ECXPHAA",29,0)
 S SUB="",PAGE=0
"RTN","ECXPHAA",30,0)
 D HEADER I STOP D EXIT Q
"RTN","ECXPHAA",31,0)
 S SUB=$S(REPORT=1:"GETUDATA",REPORT=2:"GETIDATA",1:"")
"RTN","ECXPHAA",32,0)
 D @SUB I STOP D EXIT Q
"RTN","ECXPHAA",33,0)
 I '$O(^TMP($J,"ECXPHAA",0)) D  Q
"RTN","ECXPHAA",34,0)
 .W !
"RTN","ECXPHAA",35,0)
 .W !,"************************************************************"
"RTN","ECXPHAA",36,0)
 .W !,"*  NOTHING TO REPORT FOR PHARMACY "_$S(REPORT=1:"UDP",REPORT=2:"IVP",1:"")_" SOURCE AUDIT REPORT  *"
"RTN","ECXPHAA",37,0)
 .W !,"************************************************************"
"RTN","ECXPHAA",38,0)
 .D WAIT
"RTN","ECXPHAA",39,0)
 .D EXIT
"RTN","ECXPHAA",40,0)
 D DETAIL I STOP D EXIT Q
"RTN","ECXPHAA",41,0)
EXIT K @SCRNARR Q
"RTN","ECXPHAA",42,0)
 ;
"RTN","ECXPHAA",43,0)
REPORT ;Select report
"RTN","ECXPHAA",44,0)
 N DIR,DIRUT,DUOUT
"RTN","ECXPHAA",45,0)
 ;Prepare choices
"RTN","ECXPHAA",46,0)
 S DIR(0)="S^1:UDP;2:IVP"
"RTN","ECXPHAA",47,0)
 S DIR("A")="Select Source Audit Report"
"RTN","ECXPHAA",48,0)
 D ^DIR
"RTN","ECXPHAA",49,0)
 I $D(DIRUT)!$D(DUOUT) S STOP=1 Q
"RTN","ECXPHAA",50,0)
 S REPORT=Y
"RTN","ECXPHAA",51,0)
 Q
"RTN","ECXPHAA",52,0)
 ;
"RTN","ECXPHAA",53,0)
DIVISION ;Prompt for division
"RTN","ECXPHAA",54,0)
 ; Set Divisions into screen array (prompt is one/many/all)
"RTN","ECXPHAA",55,0)
 ;Input  : SCRNARR - Screen array full global reference
"RTN","ECXPHAA",56,0)
 ;Output : 1 = OK     0 = User abort/timeout
"RTN","ECXPHAA",57,0)
 ;         @SCRNARR@("DIVISION") = User pick all divisions ?
"RTN","ECXPHAA",58,0)
 ;           1 = Yes (all)     0 = No
"RTN","ECXPHAA",59,0)
 ;         @SCRNARR@("DIVISION",PtrDiv) = Division name
"RTN","ECXPHAA",60,0)
 ;Note   : @SCRNARR@("DIVISION") is initialized (KILLed) on input
"RTN","ECXPHAA",61,0)
 ;       : @SCRNARR@("DIVISION",PtrDiv) is only set when the user
"RTN","ECXPHAA",62,0)
 ;         picked individual divisions (i.e. didn't pick all)
"RTN","ECXPHAA",63,0)
 ;
"RTN","ECXPHAA",64,0)
 ;Declare variables
"RTN","ECXPHAA",65,0)
 N VAUTD,Y,DIV,FAC
"RTN","ECXPHAA",66,0)
 ;Get division selection
"RTN","ECXPHAA",67,0)
 D DIVISION^VAUTOMA
"RTN","ECXPHAA",68,0)
 I Y<0 S STOP=1 Q
"RTN","ECXPHAA",69,0)
 M @SCRNARR@("DIVISION")=VAUTD
"RTN","ECXPHAA",70,0)
 I VAUTD=0 D
"RTN","ECXPHAA",71,0)
 .S DIV=0 F  S DIV=$O(VAUTD(DIV)) Q:DIV'>0  S FAC=$$GETDIV^ECXDEPT(DIV) S @SCRNARR@("DIVISION",FAC)=""
"RTN","ECXPHAA",72,0)
 Q
"RTN","ECXPHAA",73,0)
 ;
"RTN","ECXPHAA",74,0)
DATES ;Prompt for start date
"RTN","ECXPHAA",75,0)
 N DIR,DIRUT,X,Y
"RTN","ECXPHAA",76,0)
 S DIR(0)="D^:NOW:EX"
"RTN","ECXPHAA",77,0)
 S DIR("A")="Enter Report Start Date"
"RTN","ECXPHAA",78,0)
 S DIR("B")=$$FMTE^XLFDT($$NOW^XLFDT,"1D")
"RTN","ECXPHAA",79,0)
 D ^DIR
"RTN","ECXPHAA",80,0)
 I $D(DIRUT) S STOP=1 Q
"RTN","ECXPHAA",81,0)
 S SDATE=Y
"RTN","ECXPHAA",82,0)
 ;Prompt for end date
"RTN","ECXPHAA",83,0)
 K DIR,DIRUT,X,Y
"RTN","ECXPHAA",84,0)
 S DIR(0)="D^:NOW:EX"
"RTN","ECXPHAA",85,0)
 S DIR("A")="Enter Report End Date"
"RTN","ECXPHAA",86,0)
 S DIR("B")=$$FMTE^XLFDT($$NOW^XLFDT,"1D")
"RTN","ECXPHAA",87,0)
 D ^DIR
"RTN","ECXPHAA",88,0)
 I $D(DIRUT) S STOP=1 Q
"RTN","ECXPHAA",89,0)
 S EDATE=Y
"RTN","ECXPHAA",90,0)
 Q
"RTN","ECXPHAA",91,0)
 ;
"RTN","ECXPHAA",92,0)
HEADER ;Print header
"RTN","ECXPHAA",93,0)
 S PAGE=$G(PAGE)+1,$P(LN,"=",80)=""
"RTN","ECXPHAA",94,0)
 W @IOF
"RTN","ECXPHAA",95,0)
 W !,$S(REPORT=1:"UDP",REPORT=2:"IVP",1:"")_" Source Audit Report",?70,"PAGE: "_PAGE
"RTN","ECXPHAA",96,0)
 W !!,"Run Date:   "_$$FMTE^XLFDT(DT)
"RTN","ECXPHAA",97,0)
 W !!,"Start Date: "_$$FMTE^XLFDT(SDATE)
"RTN","ECXPHAA",98,0)
 W !,"End Date:   "_$$FMTE^XLFDT(EDATE)
"RTN","ECXPHAA",99,0)
 W !!,?1,"Division",?24,"Date",?39,"Record Count"
"RTN","ECXPHAA",100,0)
 W !,LN
"RTN","ECXPHAA",101,0)
 Q
"RTN","ECXPHAA",102,0)
 ;
"RTN","ECXPHAA",103,0)
GETIDATA ;Get data from pharmacy IVP intermediate files
"RTN","ECXPHAA",104,0)
 ;Init variables
"RTN","ECXPHAA",105,0)
 N DATE,FILE,DFN,ERROR,ON,DA,ECPAT,EC
"RTN","ECXPHAA",106,0)
 S DATE=SDATE-.1,EDATE=EDATE+.999,FILE=728.113
"RTN","ECXPHAA",107,0)
 F  S DATE=$O(^ECX(FILE,"A",DATE)) Q:'DATE!(DATE>EDATE)  D  Q:STOP
"RTN","ECXPHAA",108,0)
 .S DFN=0 F  S DFN=$O(^ECX(FILE,"A",DATE,DFN)) Q:'DFN  D  Q:STOP
"RTN","ECXPHAA",109,0)
 ..;Filter out test patients or bad records
"RTN","ECXPHAA",110,0)
 ..;patch 142--corrected to not display test patients
"RTN","ECXPHAA",111,0)
 ..S ERROR=$$PAT^ECXNUT(DFN) Q:ERROR
"RTN","ECXPHAA",112,0)
 ..S ON=0 F  S ON=$O(^ECX(FILE,"A",DATE,DFN,ON)) Q:'ON  D  Q:STOP
"RTN","ECXPHAA",113,0)
 ...S DA=0 F  S DA=$O(^ECX(FILE,"A",DATE,DFN,ON,DA)) Q:'DA!(STOP)  D  Q:STOP
"RTN","ECXPHAA",114,0)
 ....I $D(^ECX(728.113,DA,0)) S EC=^(0) D  Q:STOP
"RTN","ECXPHAA",115,0)
 .....;get inpatient data if exist
"RTN","ECXPHAA",116,0)
 .....N X,STATUS,MOVEMENT,ADMIT,SPECIAL,WARD,DIVISION,CLINIC
"RTN","ECXPHAA",117,0)
 .....N DIC,DIQ,DR,ECXDIC,DA
"RTN","ECXPHAA",118,0)
 .....S (X,STATUS,MOVEMENT,ADMIT,SPECIAL,WARD,DIVISION,CLINIC)=""
"RTN","ECXPHAA",119,0)
 .....S X=$$INP^ECXUTL2(DFN,DATE),STATUS=$P(X,U,1)
"RTN","ECXPHAA",120,0)
 .....I STATUS="I" D  Q:STOP
"RTN","ECXPHAA",121,0)
 ......S WARD=$P(X,U,9),DIVISION=$$GETDIV^ECXDEPT($P(WARD,";",2))
"RTN","ECXPHAA",122,0)
 .....I STATUS="O" D  Q:STOP
"RTN","ECXPHAA",123,0)
 ......;Get division from  outpatient location file 44
"RTN","ECXPHAA",124,0)
 ......S CLINIC=+$P(EC,U,13)
"RTN","ECXPHAA",125,0)
 ......S DIC="^SC(",DIQ(0)="I",DIQ="ECXDIC",DR="3",DA=CLINIC
"RTN","ECXPHAA",126,0)
 ......D EN^DIQ1
"RTN","ECXPHAA",127,0)
 ......S DIVISION=$$RADDIV^ECXDEPT(+$G(ECXDIC(44,CLINIC,3,"I")))
"RTN","ECXPHAA",128,0)
 ......S DIVISION=$S(DIVISION'="":DIVISION,1:"UNKNOWN")
"RTN","ECXPHAA",129,0)
 .....;Save in temp global and filter division
"RTN","ECXPHAA",130,0)
 .....I '@SCRNARR@("DIVISION")=1&'($D(@SCRNARR@("DIVISION",DIVISION))) Q
"RTN","ECXPHAA",131,0)
 .....S ^TMP($J,"ECXPHAA",$P(DATE,".",1),DIVISION)=$G(^TMP($J,"ECXPHAA",$P(DATE,".",1),DIVISION))+1
"RTN","ECXPHAA",132,0)
 Q
"RTN","ECXPHAA",133,0)
 ;
"RTN","ECXPHAA",134,0)
GETUDATA ;Get unit dose data from intermediate file 728.904
"RTN","ECXPHAA",135,0)
 ;Init variables
"RTN","ECXPHAA",136,0)
 N DATE,FILE,RECORD,DATA,DFN,ERROR,ON,WARD,DIVISION,X,STATUS,DIC,DIQ,DR,DA,ECPAT,CLINIC,CNT,FACILITY,L
"RTN","ECXPHAA",137,0)
 S DATE=SDATE-.1,EDATE=EDATE+.999,STOP=0
"RTN","ECXPHAA",138,0)
 S FILE=728.904
"RTN","ECXPHAA",139,0)
 F  S DATE=$O(^ECX(FILE,"A",DATE)) Q:'DATE!(DATE>EDATE)  D  Q:STOP
"RTN","ECXPHAA",140,0)
 .S RECORD=0 F  S RECORD=$O(^ECX(FILE,"A",DATE,RECORD)) Q:'RECORD  D  Q:STOP
"RTN","ECXPHAA",141,0)
 ..S DATA=$G(^ECX(FILE,RECORD,0)),DFN=$P(DATA,U,2)
"RTN","ECXPHAA",142,0)
 ..;Filter out test patients or bad records
"RTN","ECXPHAA",143,0)
 ..;patch 142-corrected to not display test patients
"RTN","ECXPHAA",144,0)
 ..S ERROR=$$PAT^ECXNUT(DFN) Q:ERROR
"RTN","ECXPHAA",145,0)
 ..S ON=$P(DATA,U,10),WARD=$P(DATA,U,6)
"RTN","ECXPHAA",146,0)
 ..S DIVISION=$$GETDIV^ECXDEPT($P($G(^DIC(42,+WARD,0)),U,11))
"RTN","ECXPHAA",147,0)
 ..S FACILITY=$P($G(^DIC(42,+WARD,0)),U,11)
"RTN","ECXPHAA",148,0)
 ..S X=$$INP^ECXUTL2(DFN,DATE),STATUS=$P(X,U,1)
"RTN","ECXPHAA",149,0)
 ..I STATUS="O"&(ON) D  Q:STOP
"RTN","ECXPHAA",150,0)
 ...;Get division from  outpatient location from file 44
"RTN","ECXPHAA",151,0)
 ...S DIC=55,DIQ(0)="I",DIQ="ECXDIC",DR="62",DR(55.06)="130",DA=DFN
"RTN","ECXPHAA",152,0)
 ...S DA(55.06)=+ON D EN^DIQ1
"RTN","ECXPHAA",153,0)
 ...S CLINIC=+$G(ECXDIC(55.06,DFN,130,"I"))
"RTN","ECXPHAA",154,0)
 ...S DIVISION=$$RADDIV^ECXDEPT($G(ECXDIC(44,CLINIC,3,"I")))
"RTN","ECXPHAA",155,0)
 ...S DIVISION=$S(DIVISION'="":DIVISION,1:"UNKNOWN")
"RTN","ECXPHAA",156,0)
 ..;Save in temp global and filter division
"RTN","ECXPHAA",157,0)
 ..I '@SCRNARR@("DIVISION")=1&'($D(@SCRNARR@("DIVISION",DIVISION))) Q
"RTN","ECXPHAA",158,0)
 ..S ^TMP($J,"ECXPHAA",$P(DATE,".",1),DIVISION)=$G(^TMP($J,"ECXPHAA",$P(DATE,".",1),DIVISION))+1
"RTN","ECXPHAA",159,0)
 Q
"RTN","ECXPHAA",160,0)
 ;
"RTN","ECXPHAA",161,0)
DETAIL ;Print report
"RTN","ECXPHAA",162,0)
 ;Init variables
"RTN","ECXPHAA",163,0)
 N DATE,DIV,CNT
"RTN","ECXPHAA",164,0)
 S (DATE,CNT)=0,DIV=""
"RTN","ECXPHAA",165,0)
 F  S DATE=$O(^TMP($J,"ECXPHAA",DATE)) Q:'DATE!(STOP)  F  S DIV=$O(^TMP($J,"ECXPHAA",DATE,DIV)) Q:DIV=""  S CNT=^(DIV) W !,?1,DIV,?20,$$FMTE^XLFDT(DATE),?45,CNT I $Y>(IOSL-5) D WAIT Q:STOP  D HEADER
"RTN","ECXPHAA",166,0)
 Q
"RTN","ECXPHAA",167,0)
 ;
"RTN","ECXPHAA",168,0)
WAIT ;End of page logic
"RTN","ECXPHAA",169,0)
 ;Input   ; None
"RTN","ECXPHAA",170,0)
 ;Output  ; STOP - Flag indicating if printing should continue
"RTN","ECXPHAA",171,0)
 ;                 1 = Stop     0 = Continue
"RTN","ECXPHAA",172,0)
 ;
"RTN","ECXPHAA",173,0)
 S STOP=0
"RTN","ECXPHAA",174,0)
 ;CRT - Prompt for continue
"RTN","ECXPHAA",175,0)
 I $E(IOST,1,2)="C-"&(IOSL'>24) D  Q
"RTN","ECXPHAA",176,0)
 .F  Q:$Y>(IOSL-3)  W !
"RTN","ECXPHAA",177,0)
 .N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ECXPHAA",178,0)
 .S DIR(0)="E"
"RTN","ECXPHAA",179,0)
 .D ^DIR
"RTN","ECXPHAA",180,0)
 .S STOP=$S(Y'=1:1,1:0)
"RTN","ECXPHAA",181,0)
 ;Background task - check taskman
"RTN","ECXPHAA",182,0)
 S STOP=$$S^%ZTLOAD()
"RTN","ECXPHAA",183,0)
 I STOP D
"RTN","ECXPHAA",184,0)
 .W !,"*********************************************"
"RTN","ECXPHAA",185,0)
 .W !,"*  PRINTING OF REPORT STOPPED AS REQUESTED  *"
"RTN","ECXPHAA",186,0)
 .W !,"*********************************************"
"RTN","ECXPHAA",187,0)
 Q
"RTN","ECXSCLD")
0^1^B204371648^B200358220
"RTN","ECXSCLD",1,0)
ECXSCLD ;BIR/DMA,CML-Enter, Print and Edit Entries in 728.44 ; 1/10/13 9:55am
"RTN","ECXSCLD",2,0)
 ;;3.0;DSS EXTRACTS;**2,8,24,30,71,80,105,112,120,126,132,136,142**;Dec 22, 1997;Build 3
"RTN","ECXSCLD",3,0)
EN ;entry point from option
"RTN","ECXSCLD",4,0)
 ;load entries
"RTN","ECXSCLD",5,0)
 W !!,"This option creates local entries in the DSS CLINIC AND STOP CODES"
"RTN","ECXSCLD",6,0)
 W !,"file (#728.44)."
"RTN","ECXSCLD",7,0)
 I '$D(^ECX(728.44)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",8,0)
 W !!,"It also compares file #728.44 to the HOSPITAL LOCATION file (#44) to see"
"RTN","ECXSCLD",9,0)
 W !,"if there are any differences since the last time the file was reviewed."
"RTN","ECXSCLD",10,0)
 W !!,"Any differences or new entries will cause an UNREVIEWED CLINICS report"
"RTN","ECXSCLD",11,0)
 W !,"to automatically print.",!
"RTN","ECXSCLD",12,0)
 D SELECT^ECXSCLD
"RTN","ECXSCLD",13,0)
 Q
"RTN","ECXSCLD",14,0)
START ; entry point
"RTN","ECXSCLD",15,0)
 N ZTREQ
"RTN","ECXSCLD",16,0)
 S EC=0 F  S EC=$O(^SC(EC)) Q:'EC  D FIX(EC)
"RTN","ECXSCLD",17,0)
 K DIK S DIK="^ECX(728.44,",DIK(1)=".01^B" D ENALL^DIK
"RTN","ECXSCLD",18,0)
 ;print 'unreviewed clinics' report
"RTN","ECXSCLD",19,0)
 S ECALL="U" D SPRINT^ECXSCLD
"RTN","ECXSCLD",20,0)
 S ZTREQ="@"
"RTN","ECXSCLD",21,0)
 Q
"RTN","ECXSCLD",22,0)
 ;
"RTN","ECXSCLD",23,0)
FIX(EC) ;
"RTN","ECXSCLD",24,0)
 ; synchronize files #44 and #728.44.
"RTN","ECXSCLD",25,0)
 ; differences are placed in ^XTMP("ECX UNREVIEWED CLINICS")
"RTN","ECXSCLD",26,0)
 S EC=$G(EC)
"RTN","ECXSCLD",27,0)
 I '$D(^SC(EC,0)) Q
"RTN","ECXSCLD",28,0)
 N ECD,DAT
"RTN","ECXSCLD",29,0)
 S ECD=^SC(EC,0),DAT=$G(^SC(EC,"I"))
"RTN","ECXSCLD",30,0)
 I $P(ECD,U,3)'="C" Q
"RTN","ECXSCLD",31,0)
 ; get stop codes and default style for feeder key
"RTN","ECXSCLD",32,0)
 ; 1 if no credit stop code - 5 if credit stop code exists
"RTN","ECXSCLD",33,0)
 K ECD2,ECS2,ECDNEW,ECDDIF,ECSCSIGN I $D(^ECX(728.44,EC,0)) S (ECD2,ECDDIF)=^(0),ECSCSIGN=""
"RTN","ECXSCLD",34,0)
 I $D(ECD2) F ECS=2,3,4,5 D
"RTN","ECXSCLD",35,0)
 .S (ECS2(ECS),X)=$P(ECD2,U,ECS)
"RTN","ECXSCLD",36,0)
 .K DIC,Y S DIC=40.7,DIC(0)="MXZ" D ^DIC
"RTN","ECXSCLD",37,0)
 .I +$G(Y)>0 S $P(ECS2(ECS),U,2)=$P(^DIC(40.7,+Y,0),U,3)
"RTN","ECXSCLD",38,0)
 S ID=+DAT,RD=$P(DAT,U,2)
"RTN","ECXSCLD",39,0)
 ;ECXINAC=0 - patch 142 removed variable, no longer used
"RTN","ECXSCLD",40,0)
 ;change in clinic inactivation for existing entry 
"RTN","ECXSCLD",41,0)
 I $D(ECD2) D
"RTN","ECXSCLD",42,0)
 .;don't include already old inactivated clinics in report
"RTN","ECXSCLD",43,0)
 .;patch 142-inactive clinic updates to show per Busn Owner
"RTN","ECXSCLD",44,0)
 .;I ID,ID'>DT I ('RD)!(RD>DT) I $P(ECD2,U,10)=ID S ECXINAC=1
"RTN","ECXSCLD",45,0)
 .I ID,ID'>DT I ('RD)!(RD>DT) I $P(ECD2,U,10)'=ID D
"RTN","ECXSCLD",46,0)
 ..S $P(ECD2,U,7)="",$P(ECD2,U,10)=ID,ECSCSIGN="*"
"RTN","ECXSCLD",47,0)
 .I ID,RD,(RD'>DT) I $P(ECD2,U,10) D
"RTN","ECXSCLD",48,0)
 ..S $P(ECD2,U,7)="",$P(ECD2,U,10)="",ECSCSIGN="r"
"RTN","ECXSCLD",49,0)
 .I ID,(ID>DT) I $P(ECD2,U,10) D
"RTN","ECXSCLD",50,0)
 ..S $P(ECD2,U,7)="",$P(ECD2,U,10)="",ECSCSIGN="!"
"RTN","ECXSCLD",51,0)
 .I 'ID,$P(ECD2,U,10) D
"RTN","ECXSCLD",52,0)
 ..S $P(ECD2,U,7)="",$P(ECD2,U,10)="",ECSCSIGN="!"
"RTN","ECXSCLD",53,0)
 .S ECDDIF=ECD2
"RTN","ECXSCLD",54,0)
 ;setup for stops
"RTN","ECXSCLD",55,0)
 F ECS=7,18 S ECP=+$P(ECD,U,ECS),ECS(ECS)=$P($G(^DIC(40.7,ECP,0)),U,2)_U_$P($G(^DIC(40.7,ECP,0)),U,3)
"RTN","ECXSCLD",56,0)
 S ECDF=$S($P(ECS(18),U)]"":5,1:1) S:$P(ECD,U,17)="Y" ECDF=6 S:$G(^SC(EC,"OOS")) ECDF=6
"RTN","ECXSCLD",57,0)
 S ECDB=EC_U_$S(+ECS(7):+ECS(7),1:"")_U_$S(+ECS(18):+ECS(18),1:"")
"RTN","ECXSCLD",58,0)
 ;new entry
"RTN","ECXSCLD",59,0)
 I '$D(ECD2) D
"RTN","ECXSCLD",60,0)
 .S $P(^ECX(728.44,EC,0),U,1,5)=ECDB_U_$S(+ECS(7):+ECS(7),1:"")_U_$S(+ECS(18):+ECS(18),1:"")
"RTN","ECXSCLD",61,0)
 .S $P(^(0),U,6)=ECDF,$P(^(0),U,12)=$P(ECD,U,17)
"RTN","ECXSCLD",62,0)
 .S ECDNEW=^ECX(728.44,EC,0)
"RTN","ECXSCLD",63,0)
 ;changes to existing entry
"RTN","ECXSCLD",64,0)
 I $D(ECD2) D
"RTN","ECXSCLD",65,0)
 .S $P(ECD2,U,1,3)=ECDB,$P(ECDDIF,U,1,3)=ECDB
"RTN","ECXSCLD",66,0)
 .;differs in stop code
"RTN","ECXSCLD",67,0)
 .I +ECS(7)'=+ECS2(2) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,2)_"!",$P(ECDDIF,U,2)=X
"RTN","ECXSCLD",68,0)
 .;differs in credit stop code
"RTN","ECXSCLD",69,0)
 .I +ECS(18)'=+ECS2(3) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,3)_"!",$P(ECDDIF,U,3)=X
"RTN","ECXSCLD",70,0)
 .;stop code inactive
"RTN","ECXSCLD",71,0)
 .;I $P(ECS(7),U,2) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,2)_"*",$P(ECDDIF,U,2)=X
"RTN","ECXSCLD",72,0)
 .;credit stop code inactive
"RTN","ECXSCLD",73,0)
 .;I $P(ECS(18),U,2) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,3)_"*",$P(ECDDIF,U,3)=X
"RTN","ECXSCLD",74,0)
 .;dss stop code inactive
"RTN","ECXSCLD",75,0)
 .;I $P(ECS2(4),U,2) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,4)_"*",$P(ECDDIF,U,4)=X
"RTN","ECXSCLD",76,0)
 .;dss credit stop code inactive
"RTN","ECXSCLD",77,0)
 .;I $P(ECS2(5),U,2) S $P(ECD2,U,7)="",X=$P(ECDDIF,U,5)_"*",$P(ECDDIF,U,5)=X
"RTN","ECXSCLD",78,0)
 .;change in non-count
"RTN","ECXSCLD",79,0)
 .I $P(ECD2,U,12)'=$P(ECD,U,17) S X=$P(ECD,U,17)_"!",$P(ECDDIF,U,12)=X,$P(ECD2,U,12)=$P(ECD,U,17),$P(ECD2,U,7)=""
"RTN","ECXSCLD",80,0)
 .;reset entry
"RTN","ECXSCLD",81,0)
 .S ^ECX(728.44,EC,0)=ECD2
"RTN","ECXSCLD",82,0)
 ;set tmp node
"RTN","ECXSCLD",83,0)
 S ECSC=$P(ECD,U) S:$L(ECSC)>27 ECSC=$E(ECSC,1,27)
"RTN","ECXSCLD",84,0)
 I $D(ECD2),$P(ECD2,U,7)="" D
"RTN","ECXSCLD",85,0)
 .;I ECXINAC,ECDDIF'["!" Q-patch 142 removed no longer being used
"RTN","ECXSCLD",86,0)
 .I $D(^XTMP("ECX UNREVIEWED CLINICS",ECSC)) D UPDATE(ECSC,ECDDIF,ECSCSIGN)
"RTN","ECXSCLD",87,0)
 .I '$D(^XTMP("ECX UNREVIEWED CLINICS",ECSC)) S ^XTMP("ECX UNREVIEWED CLINICS",ECSC)=ECSCSIGN_U_$P(ECDDIF,U,2,200),^XTMP("ECX UNREVIEWED CLINICS",ECSC,"T")=$$NOW^XLFDT()
"RTN","ECXSCLD",88,0)
 I $D(ECDNEW) S ^XTMP("ECX UNREVIEWED CLINICS",ECSC)=""_U_$P(ECDNEW,U,2,200),^XTMP("ECX UNREVIEWED CLINICS",ECSC,"T")=$$NOW^XLFDT()
"RTN","ECXSCLD",89,0)
 Q
"RTN","ECXSCLD",90,0)
 ;
"RTN","ECXSCLD",91,0)
UPDATE(ECSC,ECDDIF,ECSCSIGN) ;update ^xtmp node with today's changes
"RTN","ECXSCLD",92,0)
 N ECXOLD,J,L1,L2,X,X1,X2
"RTN","ECXSCLD",93,0)
 S ECXOLD=^XTMP("ECX UNREVIEWED CLINICS",ECSC)
"RTN","ECXSCLD",94,0)
 F J=2,3 S X1=+$P(ECXOLD,U,J),X2=+$P(ECDDIF,U,J) I X2=X1,$P(ECDDIF,U,J)'=$P(ECXOLD,U,J) D
"RTN","ECXSCLD",95,0)
 .S L1=$L($P(ECXOLD,U,J)),L2=$L($P(ECDDIF,U,J))
"RTN","ECXSCLD",96,0)
 .I L1>L2 S $P(ECDDIF,U,J)=$P(ECXOLD,U,J)
"RTN","ECXSCLD",97,0)
 S X1=$E($P(ECXOLD,U,12),1),X2=$E($P(ECDDIF,U,12),1) I X2=X1 S $P(ECDDIF,U,12)=$P(ECXOLD,U,12)
"RTN","ECXSCLD",98,0)
 S X1=$P(ECXOLD,U),X=X1_U_$P(ECDDIF,U,2,200)
"RTN","ECXSCLD",99,0)
 I ECSCSIGN'="",ECSCSIGN'=X1 S X=ECSCSIGN_U_$P(ECDDIF,U,2,200)
"RTN","ECXSCLD",100,0)
 S ^XTMP("ECX UNREVIEWED CLINICS",ECSC)=X
"RTN","ECXSCLD",101,0)
 Q
"RTN","ECXSCLD",102,0)
 ;
"RTN","ECXSCLD",103,0)
SELECT ;select IO device to 'gather clinic stop codes' and print 'unreviewd clinics' report;
"RTN","ECXSCLD",104,0)
 ;for menu option 'Create DSS Clinic Stop Code File' or 'Clinics and DSS Stop Codes Print'
"RTN","ECXSCLD",105,0)
 N DIR,ECALL,IOP,POP,XX,ZTIO,ZTRTN,ZTDESC,ZTSK,ZTSAVE
"RTN","ECXSCLD",106,0)
 ;does user hold key?
"RTN","ECXSCLD",107,0)
 I '$$KCHK^XUSRB("ECXMGR",$G(DUZ)) D  G ENDX
"RTN","ECXSCLD",108,0)
 .W !!,?5,"You do not have approved access to this option.",!,"Exiting...",!!
"RTN","ECXSCLD",109,0)
 .D PAUSE
"RTN","ECXSCLD",110,0)
 W !,"Please select a print device for the 'Unreviewed Clinics' report."
"RTN","ECXSCLD",111,0)
 W !,"**Please note: If printing in foreground, synching files may cause screen delay."
"RTN","ECXSCLD",112,0)
 W ! S %ZIS="Q" D ^%ZIS
"RTN","ECXSCLD",113,0)
 I POP Q
"RTN","ECXSCLD",114,0)
 ;I IO=IO(0) W !,"You must queue to a print device.",! D HOME^%ZIS G SELECT
"RTN","ECXSCLD",115,0)
 ;queue the report
"RTN","ECXSCLD",116,0)
 I $D(IO("Q")) D  Q
"RTN","ECXSCLD",117,0)
 . K ZTSAVE S ZTDESC="Gather Clinic Stop Codes for DSS",ZTRTN="START^ECXSCLD"
"RTN","ECXSCLD",118,0)
 . D ^%ZTLOAD
"RTN","ECXSCLD",119,0)
 . I $G(ZTSK) W !,"Queued as Task #: "_ZTSK D ENDX D PAUSE
"RTN","ECXSCLD",120,0)
 W !!,">> Synchronizing Stop Codes file (#728.44) with the Hospital"
"RTN","ECXSCLD",121,0)
 W !,"   Location file (#44)...",!
"RTN","ECXSCLD",122,0)
 D START
"RTN","ECXSCLD",123,0)
 D ^%ZISC,HOME^%ZIS K IO("Q")
"RTN","ECXSCLD",124,0)
 Q
"RTN","ECXSCLD",125,0)
 ;
"RTN","ECXSCLD",126,0)
PRINT ; print worksheet for updates
"RTN","ECXSCLD",127,0)
 N OUT,DIR,ECALL
"RTN","ECXSCLD",128,0)
 I '$O(^ECX(728.44,0)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",129,0)
 W !!,"This option produces a worksheet of (A) All Clinics, (C) Active, (I) Inactive, "
"RTN","ECXSCLD",130,0)
 W !,"or only the (U) Unreviewed Clinics that are awaiting approval."
"RTN","ECXSCLD",131,0)
 W !!,"Clinics that were defined as ""inactive"" by MAS the last time the option"
"RTN","ECXSCLD",132,0)
 W !,"""Create DSS Clinic Stop Code File"" was run will be indicated with an ""*""."
"RTN","ECXSCLD",133,0)
 W !!,"Choose (X) for exporting the CLINICS AND STOP CODES FILE to a text file for"
"RTN","ECXSCLD",134,0)
 W !,"spreadsheet use.",!
"RTN","ECXSCLD",135,0)
 S DIR(0)="S^A:ALL CLINICS;C:ALL ACTIVE CLINICS;I:ALL INACTIVE CLINICS;U:UNREVIEWED CLINICS;X:EXPORT TO TEXT FILE FOR SPREADSHEET USE",DIR("A")="Enter ""A"", ""C"", ""I"", ""U"", or ""X"""
"RTN","ECXSCLD",136,0)
 S DIR("?",1)="Enter: ""C"" to print a worksheet of all active DSS Clinic Stops,"
"RTN","ECXSCLD",137,0)
 S DIR("?",2)="Enter: ""I"" to print a worksheet of all inactive DSS Clinic  Stops,"
"RTN","ECXSCLD",138,0)
 S DIR("?",3)="Enter: ""A"" to print a worksheet of all DSS Clinic  Stops,"
"RTN","ECXSCLD",139,0)
 S DIR("?",4)="Enter: ""U"" to print only the Clinic Stops that have not been approved."
"RTN","ECXSCLD",140,0)
 S DIR("?")="Enter: ""X"" to export CLINICS AND STOP CODES FILE to a text file."
"RTN","ECXSCLD",141,0)
 D ^DIR K DIR G ENDX:$D(DIRUT) S ECALL=$E(Y)
"RTN","ECXSCLD",142,0)
 I ECALL="X" D EXPORT^ECXSCLD1 Q
"RTN","ECXSCLD",143,0)
 ;sync #728.44 with #44 before printing 'unreviewed'
"RTN","ECXSCLD",144,0)
 I ECALL="U" D  Q
"RTN","ECXSCLD",145,0)
 .W !!,?5,"Before the UNREVIEWED CLINICS report prints, the Clinics and"
"RTN","ECXSCLD",146,0)
 .W !,?5,"Stop Codes file (#728.44) will be synchronized with the Hospital"
"RTN","ECXSCLD",147,0)
 .W !,?5,"Location file (#44).",!!
"RTN","ECXSCLD",148,0)
 .K DIR S DIR(0)="YA",DIR("A")="Do you wish to continue? (Y/N)// " D ^DIR
"RTN","ECXSCLD",149,0)
 .I ('$G(Y)!$G(DIRUT)!$G(DUOUT)!$G(DTOUT)) Q
"RTN","ECXSCLD",150,0)
 .D SELECT^ECXSCLD
"RTN","ECXSCLD",151,0)
 S %ZIS="Q" D ^%ZIS Q:POP
"RTN","ECXSCLD",152,0)
 I $D(IO("Q")) K ZTSAVE S ZTDESC="DSS clinic stop code work sheet",ZTRTN="SPRINT^ECXSCLD",ZTSAVE("ECALL")="" D ^%ZTLOAD,HOME^%ZIS Q
"RTN","ECXSCLD",153,0)
SPRINT ; queued entry to print work sheet
"RTN","ECXSCLD",154,0)
 U IO
"RTN","ECXSCLD",155,0)
 S QFLG=0,$P(LN,"-",80)="",PG=0
"RTN","ECXSCLD",156,0)
 S ECDATE=$O(^ECX(728.44,"A1","")) I ECDATE S ECDATE=-ECDATE,ECDATE=$$FMTE^XLFDT(ECDATE,"5DF"),ECDATE=$TR(ECDATE," ","0")
"RTN","ECXSCLD",157,0)
 I ECALL'="U" K ^TMP("EC",$J)
"RTN","ECXSCLD",158,0)
 F J=0:0 S J=$O(^ECX(728.44,J)) Q:'J  I $D(^ECX(728.44,J,0)) S ECSD=^ECX(728.44,J,0) D
"RTN","ECXSCLD",159,0)
 .I ECALL="A" I $D(^SC(J,0)) S ECSC=$P(^SC(J,0),U),^TMP("EC",$J,ECSC)=$P(ECSD,U,2,200)
"RTN","ECXSCLD",160,0)
 .I (ECALL="I"),($P(ECSD,U,10)) I $D(^SC(J,0)) S ECSC=$P(^SC(J,0),U),^TMP("EC",$J,ECSC)=$P(ECSD,U,2,200)
"RTN","ECXSCLD",161,0)
 .I ((ECALL="C")&($P(ECSD,U,10)=""))!((ECALL="C")&($P(ECSD,U,10)>DT)) I $D(^SC(J,0)) S ECSC=$P(^(0),U),^TMP("EC",$J,ECSC)=$P(ECSD,U,2,200)
"RTN","ECXSCLD",162,0)
 I ECALL'="U" D
"RTN","ECXSCLD",163,0)
 .D HEAD S ECSC="" I $O(^TMP("EC",$J,ECSC))="" W !!,"NO DATA FOUND FOR WORKSHEET.",! Q
"RTN","ECXSCLD",164,0)
 .F J=1:1 S ECSC=$O(^TMP("EC",$J,ECSC)) Q:ECSC=""  S ECD=^TMP("EC",$J,ECSC) D SHOWEM Q:QFLG
"RTN","ECXSCLD",165,0)
 .K ^TMP("EC",$J)
"RTN","ECXSCLD",166,0)
 I ECALL="U" D
"RTN","ECXSCLD",167,0)
 .N ECSCSIGN
"RTN","ECXSCLD",168,0)
 .D HEAD S ECSC=0 I $O(^XTMP("ECX UNREVIEWED CLINICS",ECSC))="" W !!,"NO DATA FOUND FOR WORKSHEET.",! Q
"RTN","ECXSCLD",169,0)
 .F  S ECSC=$O(^XTMP("ECX UNREVIEWED CLINICS",ECSC)) Q:ECSC=""  Q:QFLG  D
"RTN","ECXSCLD",170,0)
 ..S ECSCSIGN=$P(^XTMP("ECX UNREVIEWED CLINICS",ECSC),U),ECD=$P(^XTMP("ECX UNREVIEWED CLINICS",ECSC),U,2,99)
"RTN","ECXSCLD",171,0)
 ..D SHOWEM
"RTN","ECXSCLD",172,0)
 I $E(IOST)="C",'QFLG D SS D ENDX
"RTN","ECXSCLD",173,0)
 W:$Y @IOF D ^%ZISC S ZTREQ="@"
"RTN","ECXSCLD",174,0)
 Q
"RTN","ECXSCLD",175,0)
HEAD ; header for worksheet
"RTN","ECXSCLD",176,0)
 D:PG SS Q:QFLG
"RTN","ECXSCLD",177,0)
 S PG=PG+1 W:$Y!($E(IOST)="C") @IOF W !,"WORKSHEET FOR DSS CLINIC STOPS",?71,"Page: ",PG
"RTN","ECXSCLD",178,0)
 I ECDATE]"" W !,"(last reviewed on ",ECDATE,")"
"RTN","ECXSCLD",179,0)
 E  W !,"(NEVER REVIEWED)"
"RTN","ECXSCLD",180,0)
 W !
"RTN","ECXSCLD",181,0)
 W !,?1,"CLINIC",?28,"STOP",?35,"CREDIT",?44,"DSS",?50,"DSS",?59,"ACTION",?68,"NAT'L",?74,"C/N"
"RTN","ECXSCLD",182,0)
 W !,?28,"CODE",?35,"STOP",?44,"STOP",?50,"CREDIT",?68,"CODE"
"RTN","ECXSCLD",183,0)
 W ! W:ECALL'="U" "( * - currently inactive)" W ?35,"CODE",?44,"CODE",?50,"CODE"
"RTN","ECXSCLD",184,0)
 I ECALL="U" W !,?8,"* - inactive     r - reactivated    ! - updated since last review"
"RTN","ECXSCLD",185,0)
 W !,LN
"RTN","ECXSCLD",186,0)
 Q
"RTN","ECXSCLD",187,0)
 ;
"RTN","ECXSCLD",188,0)
SHOWEM ; list clinics for worksheet
"RTN","ECXSCLD",189,0)
 I $Y+6>IOSL D HEAD Q:QFLG
"RTN","ECXSCLD",190,0)
 N ECNON1P
"RTN","ECXSCLD",191,0)
 S ECNON=$P(ECD,U,11),ECNON1P=$E(ECNON,1)
"RTN","ECXSCLD",192,0)
 S ECNON1P=$S(ECNON1P="Y":"N",1:"C") ;if 'yes', then, 'n'on count clinic
"RTN","ECXSCLD",193,0)
 S ECNON=ECNON1P_$E(ECNON,2,99)
"RTN","ECXSCLD",194,0)
 W !!,$E(ECSC,1,25)
"RTN","ECXSCLD",195,0)
 I ECALL="U" S:ECD["!" ECSCSIGN=ECSCSIGN_"!" W ECSCSIGN
"RTN","ECXSCLD",196,0)
 E  I ECALL'="U" W:$P(ECD,U,9)]"" "*"
"RTN","ECXSCLD",197,0)
 F J=1:1:5 W ?$P("28,35,44,50,62",",",J),$S($P(ECD,U,J):$P(ECD,U,J),J<3:"",1:"_____")
"RTN","ECXSCLD",198,0)
 S ECN=$P($G(^ECX(728.441,+$P(ECD,U,7),0)),U) W ?68,$S(ECN]"":ECN,1:"____"),?75,ECNON
"RTN","ECXSCLD",199,0)
 Q
"RTN","ECXSCLD",200,0)
SS ;SCROLL STOPS
"RTN","ECXSCLD",201,0)
 N JJ,SS
"RTN","ECXSCLD",202,0)
 W !,LN
"RTN","ECXSCLD",203,0)
 ;W !,"Key: + - new clinic; ! - updated since last review; * - currently inactiv
"RTN","ECXSCLD",204,0)
 I $E(IOST)="C" S SS=21-$Y F JJ=1:1:SS W !
"RTN","ECXSCLD",205,0)
 I $E(IOST)="C",PG>0 S DIR(0)="E" W ! D ^DIR K DIR I 'Y S QFLG=1 Q
"RTN","ECXSCLD",206,0)
 Q
"RTN","ECXSCLD",207,0)
 ;
"RTN","ECXSCLD",208,0)
EDIT ; put in DSS stopcodes and which one to send
"RTN","ECXSCLD",209,0)
 I '$O(^ECX(728.44,0)) W !,"DSS Clinic stop code file does not exist",!! R X:5 K X Q
"RTN","ECXSCLD",210,0)
 ;patch 142-added for loop to allow for new clinic prompt
"RTN","ECXSCLD",211,0)
 F  W ! K DIC S DIC=728.44,DIC(0)="QEAMZ" D ^DIC Q:Y<0  D
"RTN","ECXSCLD",212,0)
 .S CLIEN1=+Y
"RTN","ECXSCLD",213,0)
 .W !!,"EXISTING CLINIC FILE DATA:",?35,"EXISTING DSS CLINIC FILE DATA:"
"RTN","ECXSCLD",214,0)
 .W !!,"STOP CODE :       ",$P(Y(0),U,2),?35,"DSS STOP CODE :   ",$P(Y(0),U,4)
"RTN","ECXSCLD",215,0)
 .W !,"CREDIT STOP CODE :",$P(Y(0),U,3),?35,"DSS CREDIT STOP CODE :",$P(Y(0),U,5)
"RTN","ECXSCLD",216,0)
 .W !
"RTN","ECXSCLD",217,0)
 .D EDIT1
"RTN","ECXSCLD",218,0)
 D ENDX
"RTN","ECXSCLD",219,0)
 Q
"RTN","ECXSCLD",220,0)
EDIT1 ;check input & update field #3; allow '@' deletion; allow bypass empty with no entry
"RTN","ECXSCLD",221,0)
 N DIR ;136
"RTN","ECXSCLD",222,0)
 S OUT=0 F  D  Q:OUT
"RTN","ECXSCLD",223,0)
 .K DIC,DIR,ECXMSG,FDA,AMIS,X,Y
"RTN","ECXSCLD",224,0)
 .S STOP=$P(^ECX(728.44,CLIEN1,0),U,4)
"RTN","ECXSCLD",225,0)
 .S DIR(0)="FO^1:99",DIR("A")="DSS STOP CODE (3-digit code only)" I STOP]"" S DIR("B")=STOP
"RTN","ECXSCLD",226,0)
 .S DIR("?")="^S DIC=40.7,DIC(0)=""EMQZ"" D ^DIC"
"RTN","ECXSCLD",227,0)
 .D ^DIR
"RTN","ECXSCLD",228,0)
 .I X="@" D  Q
"RTN","ECXSCLD",229,0)
 ..S IENS=CLIEN1_",",FDA(728.44,IENS,3)=X D FILE^DIE("","FDA")
"RTN","ECXSCLD",230,0)
 ..S OUT=1 W "   deleted..."
"RTN","ECXSCLD",231,0)
 .I X="" S X=STOP K DIRUT S OUT=2 Q
"RTN","ECXSCLD",232,0)
 .S DIC("A")="DSS STOP CODE (3-digit code only): "
"RTN","ECXSCLD",233,0)
 .S DIC="^DIC(40.7,",DIC(0)="EMQZ"
"RTN","ECXSCLD",234,0)
 .S DIC("S")="I $P(^(0),U,3)=""""" D ^DIC
"RTN","ECXSCLD",235,0)
 .I X="@" D  Q
"RTN","ECXSCLD",236,0)
 ..S IENS=CLIEN1_",",FDA(728.44,IENS,3)=X D FILE^DIE("","FDA")
"RTN","ECXSCLD",237,0)
 ..S OUT=2 W "   deleted..."
"RTN","ECXSCLD",238,0)
 .I X="" K DIRUT S OUT=2 Q
"RTN","ECXSCLD",239,0)
 .I ($G(DIRUT)!$G(DUOUT)!$G(DTOUT)) S OUT=3 Q
"RTN","ECXSCLD",240,0)
 .I +X'=X W !,?5,"Invalid... try again." Q
"RTN","ECXSCLD",241,0)
 .I +Y'>0  Q
"RTN","ECXSCLD",242,0)
 .S AMIS=$P(^DIC(40.7,+Y,0),"^",2)
"RTN","ECXSCLD",243,0)
 .S CODE=+Y,ECXMSG=$$ERRCHK(CODE,3,CLIEN1)
"RTN","ECXSCLD",244,0)
 .I ECXMSG=-1 W !,?5,"Invalid... try again." Q
"RTN","ECXSCLD",245,0)
 .I $G(ECXMSG)]"" W !,?5,ECXMSG,! Q
"RTN","ECXSCLD",246,0)
 .S IENS=CLIEN1_",",FDA(728.44,IENS,3)=AMIS D FILE^DIE("U","FDA")
"RTN","ECXSCLD",247,0)
 .S OUT=1
"RTN","ECXSCLD",248,0)
 I ($G(DIRUT)!$G(DUOUT)!$G(DTOUT)) G ENDX
"RTN","ECXSCLD",249,0)
 ;check input & update field #4; allow '@' deletion; allow bypass empty with no entry
"RTN","ECXSCLD",250,0)
 S OUT=0 F  D  G:OUT=1 ENDCHK
"RTN","ECXSCLD",251,0)
 .K DIC,DIR,ECXMSG,FDA,AMIS,X,Y
"RTN","ECXSCLD",252,0)
 .S CSTOP=$P(^ECX(728.44,CLIEN1,0),U,5)
"RTN","ECXSCLD",253,0)
 .S DIR(0)="FO^1:99",DIR("A")="DSS CREDIT STOP CODE (3-digit code only)" I CSTOP]"" S DIR("B")=CSTOP
"RTN","ECXSCLD",254,0)
 .S DIR("?")="^S DIC=40.7,DIC(0)=""EMQZ"" D ^DIC"
"RTN","ECXSCLD",255,0)
 .D ^DIR
"RTN","ECXSCLD",256,0)
 .I X="@" D  Q
"RTN","ECXSCLD",257,0)
 ..S IENS=CLIEN1_",",FDA(728.44,IENS,4)=X D FILE^DIE("","FDA")
"RTN","ECXSCLD",258,0)
 ..S OUT=1 W "   deleted..."
"RTN","ECXSCLD",259,0)
 .I X="" S X=CSTOP K DIRUT S OUT=1 Q
"RTN","ECXSCLD",260,0)
 .S DIC("A")="DSS CREDIT STOP CODE (3-digit code only): "
"RTN","ECXSCLD",261,0)
 .S DIC("S")="I $P(^(0),U,3)=""""" D ^DIC
"RTN","ECXSCLD",262,0)
 .S DIC=40.7,DIC(0)="EMQZ" D ^DIC
"RTN","ECXSCLD",263,0)
 .I X="" K DIRUT S OUT=1 Q
"RTN","ECXSCLD",264,0)
 .I ($G(DIRUT)!$G(DUOUT)!$G(DTOUT)) S OUT=1 Q
"RTN","ECXSCLD",265,0)
 .I +X'=X W !,?5,"Invalid... try again." Q
"RTN","ECXSCLD",266,0)
 .I +Y'>0  Q
"RTN","ECXSCLD",267,0)
 .S AMIS=$P(^DIC(40.7,+Y,0),"^",2)
"RTN","ECXSCLD",268,0)
 .S CODE=+Y,ECXMSG=$$ERRCHK(CODE,4,CLIEN1)
"RTN","ECXSCLD",269,0)
 .I ECXMSG=-1 W !,?5,"Invalid... try again." Q
"RTN","ECXSCLD",270,0)
 .I $G(ECXMSG)]"" W !,?5,ECXMSG,! Q
"RTN","ECXSCLD",271,0)
 .S IENS=CLIEN1_",",FDA(728.44,IENS,4)=AMIS D FILE^DIE("U","FDA")
"RTN","ECXSCLD",272,0)
 .S OUT=1
"RTN","ECXSCLD",273,0)
 I ($G(DIRUT)!$G(DUOUT)!$G(DTOUT)) G ENDX
"RTN","ECXSCLD",274,0)
 K I,WARNING,DIC,DIE,DA,DR,DIR,DIRUT,DTOUT,DUOUT,X,Y,ERRCHK
"RTN","ECXSCLD",275,0)
 K CLIEN1,CODE,ECXMSG,IENS,STOP,CSTOP,AMIS,FDA,OUT,ERR,WRN,ECXERR
"RTN","ECXSCLD",276,0)
 Q
"RTN","ECXSCLD",277,0)
ENDCHK ;check validity of clinic
"RTN","ECXSCLD",278,0)
 S CODE=$P(^ECX(728.44,CLIEN1,0),U,4)
"RTN","ECXSCLD",279,0)
 K ERR,WRN,ECXERR,WARNING,ERRCHK
"RTN","ECXSCLD",280,0)
 S ERRCHK=0
"RTN","ECXSCLD",281,0)
 D STOP^ECXSTOP(CODE,"DSS Stop Code",CLIEN1) D ERRPRNT
"RTN","ECXSCLD",282,0)
 I $D(ECXERR) S ERRCHK=1
"RTN","ECXSCLD",283,0)
 K ERR,WRN,ECXERR,WARNING
"RTN","ECXSCLD",284,0)
 S CODE=$P(^ECX(728.44,CLIEN1,0),U,5)
"RTN","ECXSCLD",285,0)
 D STOP^ECXSTOP(CODE,"Credit Stop Code",CLIEN1) D ERRPRNT
"RTN","ECXSCLD",286,0)
 I $D(ECXERR) S ERRCHK=1
"RTN","ECXSCLD",287,0)
 W !!,"...Validity Checker Complete."
"RTN","ECXSCLD",288,0)
 I ERRCHK=1 W !!,"...Errors found please fix." G EDIT1
"RTN","ECXSCLD",289,0)
 ;remaining fields
"RTN","ECXSCLD",290,0)
 S DIE=728.44,DA=+CLIEN1
"RTN","ECXSCLD",291,0)
 S DR="5//1;S:X'=4 Y=6;7;6///"_DT_";8;10" D ^DIE ;136
"RTN","ECXSCLD",292,0)
 S:$P(^ECX(728.44,DA,0),U,6)'=4 $P(^(0),U,8)="" S $P(^(0),U,7)=""
"RTN","ECXSCLD",293,0)
 Q
"RTN","ECXSCLD",294,0)
ERRPRNT ;print errors
"RTN","ECXSCLD",295,0)
 I $G(ERR)>0,$D(ECXERR) D
"RTN","ECXSCLD",296,0)
 . W ! S I=0 F  S I=$O(ECXERR(I)) Q:'I  D
"RTN","ECXSCLD",297,0)
 . . W !,"..",ECXERR(I)
"RTN","ECXSCLD",298,0)
 I $G(WRN)>0,$D(WARNING) D
"RTN","ECXSCLD",299,0)
 . W ! S I=0 F  S I=$O(WARNING(I)) Q:'I  D
"RTN","ECXSCLD",300,0)
 . . W !,"..",WARNING(I)
"RTN","ECXSCLD",301,0)
 Q
"RTN","ECXSCLD",302,0)
KILL ;
"RTN","ECXSCLD",303,0)
 K I,WARNING,DIC,DIE,DA,DR,DIR,DIRUT,DTOUT,DUOUT,X,Y,ERRCHK
"RTN","ECXSCLD",304,0)
 K CLIEN1,CODE,ECXMSG,IENS,STOP,CSTOP,AMIS,FDA,OUT,ERR,WRN,ECXERR
"RTN","ECXSCLD",305,0)
 G EDIT
"RTN","ECXSCLD",306,0)
 ;
"RTN","ECXSCLD",307,0)
ERRCHK(CODE,TYPE,CLIEN1) ;check for problems
"RTN","ECXSCLD",308,0)
 ;input
"RTN","ECXSCLD",309,0)
 ;   code: stop code IEN in #40.7
"RTN","ECXSCLD",310,0)
 ;   type: type (3=dss stop code, 4=dss credit stop code)
"RTN","ECXSCLD",311,0)
 ;  clien: clinic IEN in #728.44
"RTN","ECXSCLD",312,0)
 ;output
"RTN","ECXSCLD",313,0)
 ;  ecxerr: error msg
"RTN","ECXSCLD",314,0)
 N XCODE,INACT,RTYPE,ERR,WRN
"RTN","ECXSCLD",315,0)
 K ECXERR,WARNING
"RTN","ECXSCLD",316,0)
 S ECXERR="",WARNING="",ERR=0
"RTN","ECXSCLD",317,0)
 Q:'$G(CODE) -1 Q:'$G(CLIEN1) -1
"RTN","ECXSCLD",318,0)
 Q:(TYPE="") -1 Q:((TYPE<3)&(TYPE>4)) -1
"RTN","ECXSCLD",319,0)
 S XCODE=$P(^DIC(40.7,CODE,0),"^",2)
"RTN","ECXSCLD",320,0)
 S TYPE=$S(TYPE=3:"DSS Stop Code",1:"DSS Credit Stop Code")
"RTN","ECXSCLD",321,0)
 I TYPE="DSS Stop Code" D STOP^ECXSTOP(XCODE,TYPE,,,CODE)
"RTN","ECXSCLD",322,0)
 I TYPE="DSS Credit Stop Code" D STOP^ECXSTOP(XCODE,TYPE,CLIEN1,,CODE)
"RTN","ECXSCLD",323,0)
 I $G(ERR)>0,$D(ECXERR(1)) S ERR=$O(ECXERR(0)),ECXERR=ECXERR(ERR) Q ECXERR
"RTN","ECXSCLD",324,0)
 E  S ECXERR="" Q ECXERR
"RTN","ECXSCLD",325,0)
 Q ECXERR
"RTN","ECXSCLD",326,0)
 ;
"RTN","ECXSCLD",327,0)
APPROVE ; approve current DSS Stop and Credit Stop codes
"RTN","ECXSCLD",328,0)
 W !!,"This option allows you to mark the current clinic entries in the CLINICS AND",!,"STOP CODES file (#728.44) as ""reviewed"".  Those entries will then be omitted"
"RTN","ECXSCLD",329,0)
 W !,"from the list printed from the ""Clinic and DSS Stop Codes Print"" when you",!,"choose to print only ""unreviewed"" clinics.",!
"RTN","ECXSCLD",330,0)
 K DIR S DIR(0)="Y",DIR("A",1)="Are you ready to approve the reviewed information provided by the",DIR("A")="""Clinic and DSS Stop Codes Print""",DIR("B")="NO"
"RTN","ECXSCLD",331,0)
 S DIR("?",1)="   Enter:"
"RTN","ECXSCLD",332,0)
 S DIR("?",2)="     ""YES"" if you concur with the ""Clinic and DSS Stop Codes Print"","
"RTN","ECXSCLD",333,0)
 S DIR("?",3)="     ""NO"" or <RET> if you do not want to approve the current information,"
"RTN","ECXSCLD",334,0)
 S DIR("?")="     ""^"" to exit option."
"RTN","ECXSCLD",335,0)
 D ^DIR K DIR I 'Y!($D(DIRUT)) G ENDX
"RTN","ECXSCLD",336,0)
 W ! S ZTRTN="APPLOOP^ECXSCLD",ZTIO="",ZTDESC="Approve DSS stop codes for clinic extract" D ^%ZTLOAD W !!,"...approval queued" G ENDX
"RTN","ECXSCLD",337,0)
 ;
"RTN","ECXSCLD",338,0)
APPLOOP ; queued entry to approve action codes
"RTN","ECXSCLD",339,0)
 F EC=0:0 S EC=$O(^ECX(728.44,EC)) Q:'EC  I $D(^ECX(728.44,EC,0)) S DA=EC,DIE="^ECX(728.44,",DR="6///"_DT D ^DIE
"RTN","ECXSCLD",340,0)
 S ZTREQ="@"
"RTN","ECXSCLD",341,0)
 K ^XTMP("ECX UNREVIEWED CLINICS") S ^XTMP("ECX UNREVIEWED CLINICS",0)=$$FMADD^XLFDT(DT,180)_U_DT_U_"ECX UNREVIEWED CLINICS"
"RTN","ECXSCLD",342,0)
ENDX K X,Y,DA,DR,DIC,DIE,QFLG,PG,LN,ZTRTN,ZTIO,ZTDESC
"RTN","ECXSCLD",343,0)
 K DIR,DIRUT,DTOUT,DUOUT,CLIEN,CODE,ECXMSG,IENS,STOP,CSTOP,AMIS,FDA,OUT
"RTN","ECXSCLD",344,0)
 K J,ECSC,ECSD,ECDATE,ECD,ECN,ECNON,QFLG,PG,LN,SS,POP,%ZIS
"RTN","ECXSCLD",345,0)
 K EC,ECD,ECD2,ECL,ECS,ECS2,ECP,ECSC,ECSC2,ECDB,ECDNEW,ECDDIF,ECSCSIGN,ECDF,ECALL,ID,RD
"RTN","ECXSCLD",346,0)
 ;ECXINAC-patch 142 removed variable,it is no longer used
"RTN","ECXSCLD",347,0)
 Q
"RTN","ECXSCLD",348,0)
 ;
"RTN","ECXSCLD",349,0)
PAUSE ;pause screen
"RTN","ECXSCLD",350,0)
 N DIR,X,Y,DTOUT,DUOUT,DIROUT,DIRUT
"RTN","ECXSCLD",351,0)
 S DIR(0)="E" W !! D ^DIR W !!
"RTN","ECXSCLD",352,0)
 Q
"RTN","ECXSCLD",353,0)
 ;
"RTN","ECXSCLD",354,0)
LOOK ;queued entry to check for new clinics
"RTN","ECXSCLD",355,0)
 N DAT,ECD0,ECXMISS,ID,ECGRP
"RTN","ECXSCLD",356,0)
 S ECD=$E(DT,1,5)-1-($E(DT,4,5)="01"*8800),ECD0=ECD_"00",ECXMISS=10,ECGRP="SCX" K ^TMP("ECXS",$J)
"RTN","ECXSCLD",357,0)
 F EC=0:0 S EC=$O(^SC(EC)) Q:'EC  I $D(^SC(EC,0)),$P(^SC(EC,0),U,3)="C",'$D(^ECX(728.44,EC)) S DAT=$G(^SC(EC,"I")) D
"RTN","ECXSCLD",358,0)
 .S ID=+DAT,RD=$P(DAT,U,2) I ID,ID<DT I 'RD!(RD>DT) Q
"RTN","ECXSCLD",359,0)
 .S ^TMP("ECXS",$J,ECXMISS,0)=$J(EC,6)_"    "_$$LJ^XLFSTR($P(^SC(EC,0),U),40),ECXMISS=ECXMISS+1
"RTN","ECXSCLD",360,0)
 D ^ECXSCX1
"RTN","ECXSCLD",361,0)
 Q
"VER")
8.0^22.0
"BLD",9204,6)
^130
**END**
**END**
