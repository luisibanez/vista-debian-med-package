Released PSJ*5*264 SEQ #224
Extracted from mail message
**KIDS**:PSJ*5.0*264^

**INSTALL NAME**
PSJ*5.0*264
"BLD",8566,0)
PSJ*5.0*264^INPATIENT MEDICATIONS^0^3110816^y
"BLD",8566,1,0)
^^5^5^3110810^
"BLD",8566,1,1,0)
This patch will resolve the following issues in the Inpatient Medications 
"BLD",8566,1,2,0)
package:
"BLD",8566,1,3,0)
                                
"BLD",8566,1,4,0)
-Units per Dose calculated incorrectly
"BLD",8566,1,5,0)
-Erroneous warnings about overlapping complex schedules
"BLD",8566,4,0)
^9.64PA^^
"BLD",8566,6.3)
3
"BLD",8566,"KRN",0)
^9.67PA^779.2^20
"BLD",8566,"KRN",.4,0)
.4
"BLD",8566,"KRN",.401,0)
.401
"BLD",8566,"KRN",.402,0)
.402
"BLD",8566,"KRN",.403,0)
.403
"BLD",8566,"KRN",.5,0)
.5
"BLD",8566,"KRN",.84,0)
.84
"BLD",8566,"KRN",3.6,0)
3.6
"BLD",8566,"KRN",3.8,0)
3.8
"BLD",8566,"KRN",9.2,0)
9.2
"BLD",8566,"KRN",9.8,0)
9.8
"BLD",8566,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8566,"KRN",9.8,"NM",1,0)
PSJDOSE^^0^B62380893
"BLD",8566,"KRN",9.8,"NM",2,0)
PSGOEF2^^0^B20186389
"BLD",8566,"KRN",9.8,"NM","B","PSGOEF2",2)

"BLD",8566,"KRN",9.8,"NM","B","PSJDOSE",1)

"BLD",8566,"KRN",19,0)
19
"BLD",8566,"KRN",19.1,0)
19.1
"BLD",8566,"KRN",101,0)
101
"BLD",8566,"KRN",409.61,0)
409.61
"BLD",8566,"KRN",771,0)
771
"BLD",8566,"KRN",779.2,0)
779.2
"BLD",8566,"KRN",870,0)
870
"BLD",8566,"KRN",8989.51,0)
8989.51
"BLD",8566,"KRN",8989.52,0)
8989.52
"BLD",8566,"KRN",8994,0)
8994
"BLD",8566,"KRN","B",.4,.4)

"BLD",8566,"KRN","B",.401,.401)

"BLD",8566,"KRN","B",.402,.402)

"BLD",8566,"KRN","B",.403,.403)

"BLD",8566,"KRN","B",.5,.5)

"BLD",8566,"KRN","B",.84,.84)

"BLD",8566,"KRN","B",3.6,3.6)

"BLD",8566,"KRN","B",3.8,3.8)

"BLD",8566,"KRN","B",9.2,9.2)

"BLD",8566,"KRN","B",9.8,9.8)

"BLD",8566,"KRN","B",19,19)

"BLD",8566,"KRN","B",19.1,19.1)

"BLD",8566,"KRN","B",101,101)

"BLD",8566,"KRN","B",409.61,409.61)

"BLD",8566,"KRN","B",771,771)

"BLD",8566,"KRN","B",779.2,779.2)

"BLD",8566,"KRN","B",870,870)

"BLD",8566,"KRN","B",8989.51,8989.51)

"BLD",8566,"KRN","B",8989.52,8989.52)

"BLD",8566,"KRN","B",8994,8994)

"BLD",8566,"QUES",0)
^9.62^^
"BLD",8566,"REQB",0)
^9.611^2^2
"BLD",8566,"REQB",1,0)
PSJ*5.0*216^2
"BLD",8566,"REQB",2,0)
PSJ*5.0*222^2
"BLD",8566,"REQB","B","PSJ*5.0*216",1)

"BLD",8566,"REQB","B","PSJ*5.0*222",2)

"MBREQ")
0
"PKG",221,-1)
1^1
"PKG",221,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",221,22,0)
^9.49I^1^1
"PKG",221,22,1,0)
5.0^2971215^2981113^1
"PKG",221,22,1,"PAH",1,0)
264^3110816
"PKG",221,22,1,"PAH",1,1,0)
^^5^5^3110816
"PKG",221,22,1,"PAH",1,1,1,0)
This patch will resolve the following issues in the Inpatient Medications 
"PKG",221,22,1,"PAH",1,1,2,0)
package:
"PKG",221,22,1,"PAH",1,1,3,0)
                                
"PKG",221,22,1,"PAH",1,1,4,0)
-Units per Dose calculated incorrectly
"PKG",221,22,1,"PAH",1,1,5,0)
-Erroneous warnings about overlapping complex schedules
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSGOEF2")
0^2^B20186389^B16020117
"RTN","PSGOEF2",1,0)
PSGOEF2 ;BIR/JMC - INPATIENT MEDS OVERLAPPING ADMIN TIMES ;23 Jun 09 / 2:48 PM
"RTN","PSGOEF2",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**222,264**;16 DEC 97;Build 3
"RTN","PSGOEF2",3,0)
 ;
"RTN","PSGOEF2",4,0)
 ; Reference to ORCD is supported by DBIA 5493.
"RTN","PSGOEF2",5,0)
 ;
"RTN","PSGOEF2",6,0)
 Q
"RTN","PSGOEF2",7,0)
 ;
"RTN","PSGOEF2",8,0)
OVERLAP ;  Check for overlapping admin times on complex orders with "AND" conjunction.
"RTN","PSGOEF2",9,0)
 K ORDIALOG,^TMP("PSJATOVR",$J)  ;Have to use array name ORDIALOG even though it's not PSJ namespaced. 
"RTN","PSGOEF2",10,0)
 S PSJOVRLP=0
"RTN","PSGOEF2",11,0)
 N PSJORDLG,X,CNT,TOTCONJ
"RTN","PSGOEF2",12,0)
 S PSJORDLG=$$PTR^ORCD("PSJ OR PAT OE") I PSJORDLG="" Q  ;locates dialog sequence for Inpatient Meds dialog in CPRS.
"RTN","PSGOEF2",13,0)
 D GETDLG^ORCD(PSJORDLG)  ;retrieves info about Inpatient Meds dialog setup in CPRS
"RTN","PSGOEF2",14,0)
 S X="" F  S X=$O(ORDIALOG(X)) Q:X=""  D
"RTN","PSGOEF2",15,0)
 . I $P($G(ORDIALOG(X)),"^",2)="CONJ" D GETDLG1^ORCD(PSJORDLG),GETORDER^ORCD(PSJCOM) M PSJOVR("CONJ")=ORDIALOG(X)
"RTN","PSGOEF2",16,0)
 . I $P($G(ORDIALOG(X)),"^",2)="ADMIN" D GETDLG1^ORCD(PSJORDLG),GETORDER^ORCD(PSJCOM) M PSJOVR("ADMIN")=ORDIALOG(X)
"RTN","PSGOEF2",17,0)
 . I $P($G(ORDIALOG(X)),"^",2)="SCHEDULE" D GETDLG1^ORCD(PSJORDLG),GETORDER^ORCD(PSJCOM) M PSJOVR("SCHEDULE")=ORDIALOG(X)
"RTN","PSGOEF2",18,0)
 K ORDIALOG
"RTN","PSGOEF2",19,0)
 ; Clean up array below by killing unnecessary nodes
"RTN","PSGOEF2",20,0)
 F X="CONJ","ADMIN","SCHEDULE"  K PSJOVR(X,0),PSJOVR(X,"A"),PSJOVR(X,"?"),PSJOVR(X,"??") I X="ADMIN" M PSJOVR(X_"O")=PSJOVR(X)
"RTN","PSGOEF2",21,0)
 ; Look for no AND conjunctions.  If no AND conjuncitons, quit.
"RTN","PSGOEF2",22,0)
 S X="",CNT=0,TOTCONJ=$O(PSJOVR("CONJ",""),-1)
"RTN","PSGOEF2",23,0)
 F  S X=$O(PSJOVR("CONJ",X)) Q:X=""  I PSJOVR("CONJ",X)="A" S CNT=CNT+1
"RTN","PSGOEF2",24,0)
 Q:CNT=0  ;if CNT=0, there are no AND conjunctions in the order.  No need to proceed further.
"RTN","PSGOEF2",25,0)
 D BUILD
"RTN","PSGOEF2",26,0)
 ; Format all admin times to 4 digit length for comparison.
"RTN","PSGOEF2",27,0)
 S X="" F  S X=$O(PSJOVR("ADMIN",X)) Q:X=""  D
"RTN","PSGOEF2",28,0)
 . S X1=$G(PSJOVR("ADMIN",X)),X2=$L(X1,"-")
"RTN","PSGOEF2",29,0)
 . F X3=1:1:X2 D
"RTN","PSGOEF2",30,0)
 . . I $L($P(X1,"-",X3))<4 S $P(X1,"-",X3)=$P(X1,"-",X3)_"00"
"RTN","PSGOEF2",31,0)
 . . S PSJOVR("ADMIN",X)=X1,PSJADOV(X,$P(X1,"-",X3))=""
"RTN","PSGOEF2",32,0)
 ; Order contains all AND conjunctions, no THEN conjunctions.
"RTN","PSGOEF2",33,0)
 I CNT=TOTCONJ D CHK,EXIT Q
"RTN","PSGOEF2",34,0)
 ; Piece order back together in a string of part number, conjunction
"RTN","PSGOEF2",35,0)
 ; Produces a string like 1A2T3 - part 1 AND part 2 THEN part 3
"RTN","PSGOEF2",36,0)
 S X="" F  S X=$O(PSJOVR("ADMIN",X)) Q:X=""  D
"RTN","PSGOEF2",37,0)
 . S PSJOVR("STRING")=$G(PSJOVR("STRING"))_X_$G(PSJOVR("CONJ",X))
"RTN","PSGOEF2",38,0)
 . S PSJTHEN=$L(PSJOVR("STRING"),"T")
"RTN","PSGOEF2",39,0)
 . S PSJTHEN1="" F PSJTHEN1=1:1:PSJTHEN D
"RTN","PSGOEF2",40,0)
 . . I $P(PSJOVR("STRING"),"T",PSJTHEN1)'["A" Q  ;No need to check for overlap if only one part to a THEN conjunction
"RTN","PSGOEF2",41,0)
 . . S PSJAND=$L($P(PSJOVR("STRING"),"T",PSJTHEN1),"A")
"RTN","PSGOEF2",42,0)
 . . S PSJAND1="" F PSJAND1=1:1:PSJAND D
"RTN","PSGOEF2",43,0)
 . . . S PSJAND(PSJTHEN1,PSJAND1)=$P($P(PSJOVR("STRING"),"T",PSJTHEN1),"A",PSJAND1)
"RTN","PSGOEF2",44,0)
 D CHK2,EXIT
"RTN","PSGOEF2",45,0)
 Q
"RTN","PSGOEF2",46,0)
CHK ;
"RTN","PSGOEF2",47,0)
 Q:'CNT
"RTN","PSGOEF2",48,0)
 K PSJADOVR
"RTN","PSGOEF2",49,0)
 S X=""
"RTN","PSGOEF2",50,0)
 F X=1:1:CNT D
"RTN","PSGOEF2",51,0)
 . S X2=""  F  S X2=$O(PSJADOV(X2)) Q:X2=""  D
"RTN","PSGOEF2",52,0)
 . . ;*PSJ*5*264
"RTN","PSGOEF2",53,0)
 . . N DAYOVLP,DWSCH
"RTN","PSGOEF2",54,0)
 . . I ("SU-MO-TU-WE-TH-FR-SA"[$P($P(PSJOVR("SCHEDULE",X2),"@"),"-")),$D(PSJOVR("SCHEDULE",X2+X)),("SU-MO-TU-WE-TH-FR-SA"[$P($P(PSJOVR("SCHEDULE",X2+X),"@"),"-")) S DWSCH=1 D DWCHK(PSJOVR("SCHEDULE",X2),PSJOVR("SCHEDULE",X2+X))
"RTN","PSGOEF2",55,0)
 . . S X3=""  F  S X3=$O(PSJADOV(X2,X3)) Q:X3=""  D
"RTN","PSGOEF2",56,0)
 . . . I $D(PSJADOV(X2+X,X3)),$S($G(DWSCH):$G(DAYOVLP),1:1) S $P(^TMP("PSJATOVR",$J,X2),"^",4)=1,$P(^TMP("PSJATOVR",$J,X2+X),"^",4)=1,PSJOVRLP=1
"RTN","PSGOEF2",57,0)
 Q
"RTN","PSGOEF2",58,0)
 ;
"RTN","PSGOEF2",59,0)
DWCHK(X,Y) ; PSJ*5*264 - DWCHK added
"RTN","PSGOEF2",60,0)
 N SCH1,SCH2,DAY S SCH1=$P(X,"@",1),SCH2=$P(Y,"@",1)
"RTN","PSGOEF2",61,0)
 F CNT=1:1:$L(SCH1,"-") Q:$G(DAYOVLP)  D
"RTN","PSGOEF2",62,0)
 . S DAY=$P(SCH1,"-",CNT)
"RTN","PSGOEF2",63,0)
 . I SCH2[DAY S DAYOVLP=1 Q
"RTN","PSGOEF2",64,0)
 Q
"RTN","PSGOEF2",65,0)
 ;
"RTN","PSGOEF2",66,0)
CHK2 ;
"RTN","PSGOEF2",67,0)
 Q:'$G(PSJAND1)
"RTN","PSGOEF2",68,0)
 S (X,X1,X2,X3,X4,PSJZT)=""
"RTN","PSGOEF2",69,0)
 K PSJADOVR
"RTN","PSGOEF2",70,0)
 F X=1:1:PSJAND1 D
"RTN","PSGOEF2",71,0)
 . S X2="" F  S X2=$O(PSJAND(X2)) Q:X2=""  D
"RTN","PSGOEF2",72,0)
 . . S X3="" F  S X3=$O(PSJAND(X2,X3)) Q:X3=""  D
"RTN","PSGOEF2",73,0)
 . . . S X4=$G(PSJAND(X2,X3))
"RTN","PSGOEF2",74,0)
 . . . Q:X4=""
"RTN","PSGOEF2",75,0)
 . . . M PSJADOVR(X2,X3,X4)=PSJADOV(X4)
"RTN","PSGOEF2",76,0)
 F PSJZT=1:1:PSJAND1 D
"RTN","PSGOEF2",77,0)
 . S X="" F  S X=$O(PSJADOVR(X)) Q:X=""  D
"RTN","PSGOEF2",78,0)
 . . S X1="" F  S X1=$O(PSJADOVR(X,X1)) Q:X1=""  D
"RTN","PSGOEF2",79,0)
 . . . S X2="" F  S X2=$O(PSJADOVR(X,X1,X2)) Q:X2=""  D
"RTN","PSGOEF2",80,0)
 . . . . S X3="" F  S X3=$O(PSJADOVR(X,X1,X2,X3)) Q:X3=""  D
"RTN","PSGOEF2",81,0)
 . . . . . I $D(PSJADOVR(X,X1+PSJZT,X2+PSJZT,X3)) S $P(^TMP("PSJATOVR",$J,X2),"^",4)=1,$P(^TMP("PSJATOVR",$J,X2+PSJZT),"^",4)=1,PSJOVRLP=1
"RTN","PSGOEF2",82,0)
 Q
"RTN","PSGOEF2",83,0)
 ;
"RTN","PSGOEF2",84,0)
BUILD ;
"RTN","PSGOEF2",85,0)
 S X="" F  S X=$O(PSJOVR("SCHEDULE",X)) Q:X=""  S ^TMP("PSJATOVR",$J,X)=X_"^"_$G(PSJOVR("SCHEDULE",X))
"RTN","PSGOEF2",86,0)
 S X="" F  S X=$O(PSJOVR("ADMIN",X)) Q:X=""  S ^TMP("PSJATOVR",$J,X)=^TMP("PSJATOVR",$J,X)_"^"_$G(PSJOVR("ADMIN",X))_"^0"
"RTN","PSGOEF2",87,0)
 Q
"RTN","PSGOEF2",88,0)
 ;
"RTN","PSGOEF2",89,0)
EXIT ; Kill variables
"RTN","PSGOEF2",90,0)
 K PSJAND,PSJAND1,PSJTHEN,PSJTHEN1,PSJADOVR,PSJADOV,PSJADOV2
"RTN","PSGOEF2",91,0)
 K X,X1,X2,X3,X4,PSJZT,TOTCONJ,CNT,PSJORDLG
"RTN","PSGOEF2",92,0)
 Q
"RTN","PSJDOSE")
0^1^B62380893^B47956224
"RTN","PSJDOSE",1,0)
PSJDOSE ;BIR/MV-POSSIBLE DOSES UTILITY ; 1/28/10 8:21am
"RTN","PSJDOSE",2,0)
 ;;5.0;INPATIENT MEDICATIONS ;**50,65,106,111,216,264**;16 DEC 97;Build 3
"RTN","PSJDOSE",3,0)
 ;
"RTN","PSJDOSE",4,0)
 ; Reference to ^PSSORPH is supported by DBIA #3234.
"RTN","PSJDOSE",5,0)
 ;
"RTN","PSJDOSE",6,0)
 ;PSJDSFLG: Set to 1 if Dose and DD are not compatible
"RTN","PSJDOSE",7,0)
 ;PSJDSSEL: The selected dose in format:
"RTN","PSJDOSE",8,0)
 ;          Dosage Order^DD IEN^DUPD/BCMA DUPD^1(if BCMA DUPD exist
"RTN","PSJDOSE",9,0)
 ;PSJDSUPD: Set to 1 if need to prompt for the Units Per Dose
"RTN","PSJDOSE",10,0)
 ;
"RTN","PSJDOSE",11,0)
EDITDOSE ;Editing Dosage Ordered for active order
"RTN","PSJDOSE",12,0)
 ;*Need to set PSJDSFLG to null when call EDITDOSE.
"RTN","PSJDOSE",13,0)
 NEW PSGOER1,PSJDD,PSJDSUPD,PSJDSSEL,PSJX,Y
"RTN","PSJDOSE",14,0)
 ;Offer the possible doses from the only one or 1st DD
"RTN","PSJDOSE",15,0)
 S PSJX=$O(^PS(53.45,PSJSYSP,2,0)) S PSJDD=+$G(^(+PSJX,0))
"RTN","PSJDOSE",16,0)
 D DOSE(PSJDD)
"RTN","PSJDOSE",17,0)
 D DOSECHK
"RTN","PSJDOSE",18,0)
 I +PSJDSFLG D
"RTN","PSJDOSE",19,0)
 . W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1"),!
"RTN","PSJDOSE",20,0)
 . D PAUSE^VALM1
"RTN","PSJDOSE",21,0)
 S PSGOEE=2
"RTN","PSJDOSE",22,0)
 Q
"RTN","PSJDOSE",23,0)
GETDOSE(PSJDD) ;Dosage Order
"RTN","PSJDOSE",24,0)
 NEW PSJDSSEL,PSJDSUPD
"RTN","PSJDOSE",25,0)
 D DOSE(PSJDD)
"RTN","PSJDOSE",26,0)
 Q:'$D(PSJDSSEL)
"RTN","PSJDOSE",27,0)
 D:+$G(PSJDSUPD) DUPD
"RTN","PSJDOSE",28,0)
 D:'+$G(PSJDSUPD) SETDUPD($P(PSJDSSEL,U,3))
"RTN","PSJDOSE",29,0)
 D DOSECHK
"RTN","PSJDOSE",30,0)
 I +$G(PSJDSFLG) D
"RTN","PSJDOSE",31,0)
 . W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1"),!
"RTN","PSJDOSE",32,0)
 Q
"RTN","PSJDOSE",33,0)
 ;
"RTN","PSJDOSE",34,0)
SETVAR ;
"RTN","PSJDOSE",35,0)
 S PSJDOSE("WARN")="WARNING: Dosage Ordered and Dispense Units do not match."
"RTN","PSJDOSE",36,0)
 S PSJDOSE("WARN1")="         Please verify Dosage."
"RTN","PSJDOSE",37,0)
 Q
"RTN","PSJDOSE",38,0)
 ;
"RTN","PSJDOSE",39,0)
DOSE(PSJDD) ;Prompt for Dosage Ordered
"RTN","PSJDOSE",40,0)
 ;PSJDD: Dispense drug IEN
"RTN","PSJDOSE",41,0)
 ;
"RTN","PSJDOSE",42,0)
 NEW DA,DR,DIR,DTOUT,DUOUT,DIRUT,PSJDL,PSJX,PSJPIECE,PSJCONT
"RTN","PSJDOSE",43,0)
 D SETVAR
"RTN","PSJDOSE",44,0)
 D DOSE^PSSORPH(.PSJDOX,+PSJDD,"U")
"RTN","PSJDOSE",45,0)
 I '$D(PSJDOX) S PSJDOX(1)=-1
"RTN","PSJDOSE",46,0)
 S PSJPIECE=$S($P(PSJDOX(1),U,11)]"":11,1:3)
"RTN","PSJDOSE",47,0)
 I PSJPIECE=3 S:$S($P(PSJDOX(1),U,3)="":1,1:$P(PSJDOX(1),U)=-1) $P(PSJDOX(1),U)=-1
"RTN","PSJDOSE",48,0)
AGAIN ;Prompt for dosage order again
"RTN","PSJDOSE",49,0)
 S PSJX=0
"RTN","PSJDOSE",50,0)
 NEW DIR
"RTN","PSJDOSE",51,0)
 W:($P(PSJDOX(1),U)'=-1) !!,"Available Dosage(s)"
"RTN","PSJDOSE",52,0)
 F PSJDL=0:0 S PSJDL=$O(PSJDOX(PSJDL)) Q:$S('PSJDL:1,$G(DUOUT):1,1:+PSJDOX(PSJDL)=-1)  D
"RTN","PSJDOSE",53,0)
 . S PSJX=PSJX+1
"RTN","PSJDOSE",54,0)
 . W !?4,$J(PSJX,3),".    ",$P(PSJDOX(PSJDL),U,PSJPIECE)
"RTN","PSJDOSE",55,0)
 . I '(PSJX#16) S DIR(0)="E" D ^DIR
"RTN","PSJDOSE",56,0)
 W !
"RTN","PSJDOSE",57,0)
 K DIR S DIR(0)="F^1:60"  ;*216 - No null dosage
"RTN","PSJDOSE",58,0)
 S DIR("A")=$S(+PSJX:"Select from list of Available Dosages or Enter Free Text Dose",1:"DOSAGE ORDERED")
"RTN","PSJDOSE",59,0)
 S:$G(PSGDO)]"" DIR("B")=PSGDO
"RTN","PSJDOSE",60,0)
 S DIR("?")="^D ENHLP^PSGOEM(53.1,109)" D ^DIR
"RTN","PSJDOSE",61,0)
 S PSJY=Y
"RTN","PSJDOSE",62,0)
 ;
"RTN","PSJDOSE",63,0)
 I $S($D(DTOUT):1,$D(DUOUT):1,$D(DIRUT):1,1:0) S PSGOROE1=1 Q
"RTN","PSJDOSE",64,0)
 ;
"RTN","PSJDOSE",65,0)
 ;* If select for the presented list (possible and local doses)
"RTN","PSJDOSE",66,0)
 I $D(PSJDOX(PSJY)) D  G:'PSJCONT AGAIN Q
"RTN","PSJDOSE",67,0)
 . NEW X S X=$P(PSJDOX(PSJY),U,PSJPIECE)
"RTN","PSJDOSE",68,0)
 . W "  ",X
"RTN","PSJDOSE",69,0)
 . S PSJCONT=$$CONT(X)
"RTN","PSJDOSE",70,0)
 . Q:'PSJCONT
"RTN","PSJDOSE",71,0)
 . D SELDOSE(PSJY,PSJDD)
"RTN","PSJDOSE",72,0)
 ;
"RTN","PSJDOSE",73,0)
 ;* Entered a numeric and choices are not local pos dose
"RTN","PSJDOSE",74,0)
 I PSJY?.N!(PSJY?.N1".".N),(PSJPIECE'=3) D  G:'PSJCONT AGAIN  Q
"RTN","PSJDOSE",75,0)
 . Q:$L(PSJY)>15
"RTN","PSJDOSE",76,0)
 . D DOSE^PSSORPH(.PSJDOX,+PSJDD,"U",,PSJY/+$P(PSJDOX(1),U,5))
"RTN","PSJDOSE",77,0)
 . S PSJCONT=$$CONT($P(PSJDOX(1),U,11))
"RTN","PSJDOSE",78,0)
 . I 'PSJCONT D DOSE^PSSORPH(.PSJDOX,+PSJDD,"U") Q
"RTN","PSJDOSE",79,0)
 . D SELDOSE(1,PSJDD)
"RTN","PSJDOSE",80,0)
 ;
"RTN","PSJDOSE",81,0)
 ;* Can't accept just a numeric value
"RTN","PSJDOSE",82,0)
 I PSJY?.N!(PSJY?.N1".".N) D ENHLP^PSGOEM(53.1,109) G AGAIN
"RTN","PSJDOSE",83,0)
 ;
"RTN","PSJDOSE",84,0)
 ;* Free text
"RTN","PSJDOSE",85,0)
 G:'$$CONT(PSJY) AGAIN
"RTN","PSJDOSE",86,0)
 K PSJDSSEL
"RTN","PSJDOSE",87,0)
 F X=0:0 S X=$O(PSJDOX(X)) Q:'X  S PSJXDOSE=$P(PSJDOX(X),U,PSJPIECE) I PSJY=PSJXDOSE D SELDOSE(X,PSJDD) Q
"RTN","PSJDOSE",88,0)
 I '$D(PSJDSSEL),($G(PSJY)]"") S PSJDSSEL=PSJY_U_+PSJDD_U_1,PSGDO=PSJY,PSJDSUPD=1
"RTN","PSJDOSE",89,0)
 Q
"RTN","PSJDOSE",90,0)
 ;
"RTN","PSJDOSE",91,0)
SELDOSE(X,PSJDD) ;
"RTN","PSJDOSE",92,0)
 S X=PSJDOX(X)
"RTN","PSJDOSE",93,0)
 S PSGDO=$P(X,U,PSJPIECE)
"RTN","PSJDOSE",94,0)
 S:$P(X,U)'=-1 PSJDOSE("DO")=$P(X,U,1,2)
"RTN","PSJDOSE",95,0)
 S PSJDSSEL=$P(X,U,PSJPIECE)_U_PSJDD
"RTN","PSJDOSE",96,0)
 I +$P(X,U,12) S $P(PSJDSSEL,U,3)=$P(X,U,12)_U_1 Q
"RTN","PSJDOSE",97,0)
 S $P(PSJDSSEL,U,3)=$S(PSJPIECE=11:$P(X,U,3),1:1)
"RTN","PSJDOSE",98,0)
 Q
"RTN","PSJDOSE",99,0)
CONT(X) ;Ask if user accepting the dose
"RTN","PSJDOSE",100,0)
 NEW DIR,DIRUT,Y
"RTN","PSJDOSE",101,0)
 W ! K DIR,DIRUT,DUOUT
"RTN","PSJDOSE",102,0)
 S DIR(0)="Y",DIR("A")="You entered "_X_" is this correct",DIR("B")="Yes"
"RTN","PSJDOSE",103,0)
 D ^DIR
"RTN","PSJDOSE",104,0)
 K DUOUT
"RTN","PSJDOSE",105,0)
 Q +Y
"RTN","PSJDOSE",106,0)
 ;
"RTN","PSJDOSE",107,0)
DUPD ;
"RTN","PSJDOSE",108,0)
 NEW PSJX,X
"RTN","PSJDOSE",109,0)
 S PSGUD=1
"RTN","PSJDOSE",110,0)
 W !,"UNITS PER DOSE: "_PSGUD_"// " R X:DTIME W "  ",X I X="^"!'$T S PSGOROE1=1 Q
"RTN","PSJDOSE",111,0)
 S:X="" X=1
"RTN","PSJDOSE",112,0)
 I X="@",'PSGUD W $C(7),"  ??" S X="?" D ENHLP^PSGOEM(53.11,.02) G DUPD
"RTN","PSJDOSE",113,0)
 I X?1."?" D ENHLP^PSGOEM(53.11,.02) G DUPD
"RTN","PSJDOSE",114,0)
 I X?1.2N1"/"1.2N S X=+$J(+X/$P(X,"/",2),0,2) W "  ("_$E("0",X<1)_X_")"
"RTN","PSJDOSE",115,0)
 I $S($L(X)>12:1,X'=+X:1,X>50:1,X<0:1,1:X?.N1"."5.N) W $C(7),"  ??" S X="?" D ENHLP^PSGOEM(53.11,.02) G DUPD
"RTN","PSJDOSE",116,0)
 S $P(PSJDSSEL,U,3)=X
"RTN","PSJDOSE",117,0)
 D SETDUPD(X)
"RTN","PSJDOSE",118,0)
 Q
"RTN","PSJDOSE",119,0)
SETDUPD(X) ;
"RTN","PSJDOSE",120,0)
 S PSGUD=X,X=$S(PSJDSSEL]"":$P(PSJDSSEL,U,2),1:0)
"RTN","PSJDOSE",121,0)
 S PSJX=$O(^PS(53.45,PSJSYSP,2,"B",X,0))
"RTN","PSJDOSE",122,0)
 S PSGUD=+$FN(PSGUD,"",4) S:$E(PSGUD)="." PSGUD="0"_PSGUD
"RTN","PSJDOSE",123,0)
 S $P(^PS(53.45,PSJSYSP,2,+PSJX,0),U,2)=PSGUD
"RTN","PSJDOSE",124,0)
 Q
"RTN","PSJDOSE",125,0)
EDITDD ;Editing DDs
"RTN","PSJDOSE",126,0)
 NEW DA,DR,DIE
"RTN","PSJDOSE",127,0)
 S DIE="^PS(53.45,",DA=PSJSYSP,DR=2,DR(2,53.4502)=".02//1" D ^DIE
"RTN","PSJDOSE",128,0)
 I '$O(^PS(53.45,PSJSYSP,2,0)) W $C(7),!!,"WARNING:      This order must have at least one dispense drug before pharmacy can",!?9,"verify it!"
"RTN","PSJDOSE",129,0)
 Q
"RTN","PSJDOSE",130,0)
DOSECHK ;
"RTN","PSJDOSE",131,0)
 K PSJDSFLG S PSJDSFLG=0
"RTN","PSJDOSE",132,0)
 Q:'$P(PSJSYSU,";",4)
"RTN","PSJDOSE",133,0)
 Q:$G(PSGDO)=""
"RTN","PSJDOSE",134,0)
 NEW PSJX,PSJXDD,PSJCNT S PSJCNT=0
"RTN","PSJDOSE",135,0)
 ;*216 Be sure PSJDT is set
"RTN","PSJDOSE",136,0)
 I '$G(PSJDT) N X,% D NOW^%DTC S PSJDT=X
"RTN","PSJDOSE",137,0)
 F PSJX=0:0 S PSJX=$O(^PS(53.45,PSJSYSP,2,PSJX)) Q:'PSJX  D
"RTN","PSJDOSE",138,0)
 . S PSJXDD=$G(^PS(53.45,PSJSYSP,2,PSJX,0)) Q:PSJXDD=""
"RTN","PSJDOSE",139,0)
 . S:$P(PSJXDD,U,2)="" $P(^PS(53.45,PSJSYSP,2,PSJX,0),U,2)=1
"RTN","PSJDOSE",140,0)
 . ;*216 Don't count inactive Disp. Drug
"RTN","PSJDOSE",141,0)
 . I $P(PSJXDD,U,3)'="",$P(PSJXDD,U,3)'>PSJDT Q
"RTN","PSJDOSE",142,0)
 . S PSJCNT=PSJCNT+1
"RTN","PSJDOSE",143,0)
 D DOSECHK1
"RTN","PSJDOSE",144,0)
 Q
"RTN","PSJDOSE",145,0)
DOSECHK1 ;
"RTN","PSJDOSE",146,0)
 NEW PSJX,PSJXDD,PSJXUNIT,PSJUNIT,PSJXFLG,PSJTOT,PSJDRGDOSE,PSJUNITNM,PSJDRGUD,CNT
"RTN","PSJDOSE",147,0)
 S CNT=0
"RTN","PSJDOSE",148,0)
 ;*216 Be sure PSJDT is set
"RTN","PSJDOSE",149,0)
 I '$G(PSJDT) N X,% D NOW^%DTC S PSJDT=X
"RTN","PSJDOSE",150,0)
 S PSJUNIT=$P(PSGDO,+PSGDO,2,$L(PSGDO,+PSGDO))
"RTN","PSJDOSE",151,0)
 S (PSJDSFLG,PSJXFLG,PSJTOT)=0
"RTN","PSJDOSE",152,0)
 S PSJX=0 F  S PSJX=$O(^PS(53.45,PSJSYSP,2,PSJX)) Q:'PSJX!PSJDSFLG!PSJXFLG  D
"RTN","PSJDOSE",153,0)
 . S PSJXDD=$G(^PS(53.45,PSJSYSP,2,PSJX,0))
"RTN","PSJDOSE",154,0)
 . S PSJXDUP=$S(+$P(PSJXDD,U,2):$P(PSJXDD,U,2),1:1)
"RTN","PSJDOSE",155,0)
 . ;*216 Don't count inactive Disp. Drug
"RTN","PSJDOSE",156,0)
 . I $P(PSJXDD,U,3)'="",$P(PSJXDD,U,3)'>PSJDT Q
"RTN","PSJDOSE",157,0)
 . D DOSE^PSSORPH(.PSJXDOX,+PSJXDD,"U")
"RTN","PSJDOSE",158,0)
 . I $S('$D(PSJXDOX):1,$P(PSJXDOX(1),U)="":1,1:+PSJXDOX(1)=-1) S PSJXFLG=1 Q
"RTN","PSJDOSE",159,0)
 . S PSJXUNIT=""
"RTN","PSJDOSE",160,0)
 . S:PSJUNIT["/" PSJXUNIT=PSJUNIT
"RTN","PSJDOSE",161,0)
 . I PSJUNIT'["/" F X=1:1:$L(PSJUNIT)  I $E(PSJUNIT,X)'?.N&($E(PSJUNIT,X)'?1" ") S PSJXUNIT=PSJXUNIT_$E(PSJUNIT,X)
"RTN","PSJDOSE",162,0)
 . I PSJCNT=1 D ONEDD Q:'PSJDSFLG
"RTN","PSJDOSE",163,0)
 . D BCMAUPD(PSJXDD),DOSE^PSSORPH(.PSJXDOX,+PSJXDD,"U",,PSJXDUP)
"RTN","PSJDOSE",164,0)
 . I PSJCNT=1 D ONEDD Q
"RTN","PSJDOSE",165,0)
 . S PSJTOT=+PSJXDOX(1)+$G(PSJTOT)
"RTN","PSJDOSE",166,0)
 . ;*PSJ*5*264 - Data for POINTTOSURFACE calculation
"RTN","PSJDOSE",167,0)
 . S CNT=CNT+1,PSJDRGDOSE(CNT)=+$P(PSJXDOX(1),U,5),PSJUNITNM(CNT)=$P(PSJXDOX(1),U,2),PSJDRGUD(CNT)=+$P(PSJXDOX(1),U,3)
"RTN","PSJDOSE",168,0)
 I PSJCNT>1,(PSJTOT'=+PSGDO) D
"RTN","PSJDOSE",169,0)
 . N UNITCNT,UNITERR
"RTN","PSJDOSE",170,0)
 . S PSJDSFLG=1
"RTN","PSJDOSE",171,0)
 . F UNITCNT=2:1:CNT I PSJUNITNM(UNITCNT)'=PSJUNITNM(1) S UNITERR=1 Q
"RTN","PSJDOSE",172,0)
 . I '$G(UNITERR),$$PTPLANE(.PSJDRGUD,.PSJDRGDOSE,+PSGDO)'=-1,$$PTPLANE(.PSJDRGUD,.PSJDRGDOSE,+PSGDO)<($$SQRT^XLFMTH(CNT)/100) S PSJDSFLG=0
"RTN","PSJDOSE",173,0)
 Q
"RTN","PSJDOSE",174,0)
ONEDD ;
"RTN","PSJDOSE",175,0)
 NEW X S PSJDSFLG=1
"RTN","PSJDOSE",176,0)
 F X=0:0 S X=$O(PSJXDOX(X)) Q:'X!'PSJDSFLG  D
"RTN","PSJDOSE",177,0)
 . I +PSJXDOX(X)'=+PSGDO,(PSJXUNIT=$P(PSJXDOX(X),U,2)),$S(+PSJXDUP=+$P(PSJXDOX(X),U,3):1,1:PSJXDUP=$P(PSJXDOX(X),U,12)) D  Q:PSJDSFLG
"RTN","PSJDOSE",178,0)
 .. N CHK,DGTS S CHK=+PSGDO/$P(PSJXDOX(X),U,5) S DGTS=$L($P(PSJXDUP,".",2)) S CHK=+$FN(CHK,"",DGTS) I +CHK=+PSJXDUP S PSJDSFLG=0
"RTN","PSJDOSE",179,0)
 . I +PSJXDOX(X)=+PSGDO,$TR($P(PSJXDOX(X),U,11)," ")=$TR(PSGDO," "),$S(+PSJXDUP=+$P(PSJXDOX(X),U,3):1,1:PSJXDUP=$P(PSJXDOX(X),U,12)) S PSJDSFLG=0
"RTN","PSJDOSE",180,0)
 Q
"RTN","PSJDOSE",181,0)
PTPLANE(P,X,C) ;Find the distance from a point to a line/plane
"RTN","PSJDOSE",182,0)
                ;P - array containing coordinates of point
"RTN","PSJDOSE",183,0)
                ;X - array representing normal vector defining the line/plane
"RTN","PSJDOSE",184,0)
                ;C - constant representing point defining the line/plane
"RTN","PSJDOSE",185,0)
 ;*PSJ*5*264 - PTPLANE added
"RTN","PSJDOSE",186,0)
 ;
"RTN","PSJDOSE",187,0)
 N N,CNT,NUM,DEN
"RTN","PSJDOSE",188,0)
 Q:'$D(P)!'$D(X)!'$D(C) -1
"RTN","PSJDOSE",189,0)
 S N=0,CNT=0,NUM=0,DEN=0
"RTN","PSJDOSE",190,0)
 F  S CNT=$O(P(CNT)) Q:'CNT  S N=N+1
"RTN","PSJDOSE",191,0)
 F CNT=1:1:N S NUM=P(CNT)*X(CNT)+NUM
"RTN","PSJDOSE",192,0)
 S NUM=$$ABS^XLFMTH(NUM-C)
"RTN","PSJDOSE",193,0)
 F CNT=1:1:N S DEN=X(CNT)**2+DEN
"RTN","PSJDOSE",194,0)
 S DEN=$$SQRT^XLFMTH(DEN)
"RTN","PSJDOSE",195,0)
 Q $S(DEN=0:-1,1:NUM/DEN)
"RTN","PSJDOSE",196,0)
BCMAUPD(PSJDD) ;
"RTN","PSJDOSE",197,0)
 NEW PSJCNT
"RTN","PSJDOSE",198,0)
 K PSJBCMA
"RTN","PSJDOSE",199,0)
 F X=0:0 S X=$O(PSJXDOX(X)) Q:'X  D
"RTN","PSJDOSE",200,0)
 . Q:'+$P(PSJXDOX(X),U,12)
"RTN","PSJDOSE",201,0)
 . S PSJCNT=+$G(PSJCNT)+1
"RTN","PSJDOSE",202,0)
 . S PSJBCMA(+PSJDD,$P(PSJXDOX(X),U,12),PSJCNT)=$P(PSJXDOX(X),U,1,2)
"RTN","PSJDOSE",203,0)
 Q
"RTN","PSJDOSE",204,0)
DSPWARN ;
"RTN","PSJDOSE",205,0)
 NEW PSJDOSE
"RTN","PSJDOSE",206,0)
 D SETVAR
"RTN","PSJDOSE",207,0)
 W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1"),!
"RTN","PSJDOSE",208,0)
 D PAUSE^VALM1
"RTN","PSJDOSE",209,0)
 Q
"VER")
8.0^22.0
"BLD",8566,6)
^224
**END**
**END**
