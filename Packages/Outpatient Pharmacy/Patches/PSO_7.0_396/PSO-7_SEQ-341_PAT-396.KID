Released PSO*7*396 SEQ #341
Extracted from mail message
**KIDS**:PSO*7.0*396^

**INSTALL NAME**
PSO*7.0*396
"BLD",8771,0)
PSO*7.0*396^OUTPATIENT PHARMACY^0^3120221^y
"BLD",8771,1,0)
^^8^8^3120216^^
"BLD",8771,1,1,0)
This patch will resolve the following 3 tickets:
"BLD",8771,1,2,0)
HD0000000498138 - Date of Death cancelled prescriptions reinstated does not
"BLD",8771,1,3,0)
                  show correct Last Fill dates.
"BLD",8771,1,4,0)
 
"BLD",8771,1,5,0)
HD0000000601013 - Print issues with TRICARE prescriptions
"BLD",8771,1,6,0)
 
"BLD",8771,1,7,0)
HD0000000586028 - Refills are clogging CPRS
"BLD",8771,1,8,0)
                  (CPRS refills were not processing automatically)
"BLD",8771,4,0)
^9.64PA^59.7^1
"BLD",8771,4,59.7,0)
59.7
"BLD",8771,4,59.7,2,0)
^9.641^59.7^1
"BLD",8771,4,59.7,2,59.7,0)
PHARMACY SYSTEM  (File-top level)
"BLD",8771,4,59.7,2,59.7,1,0)
^9.6411^40.16^1
"BLD",8771,4,59.7,2,59.7,1,40.16,0)
AUTOMATE CPRS REFILL
"BLD",8771,4,59.7,222)
y^y^p^^^^n^^n
"BLD",8771,4,59.7,224)

"BLD",8771,4,"APDD",59.7,59.7)

"BLD",8771,4,"APDD",59.7,59.7,40.16)

"BLD",8771,4,"B",59.7,59.7)

"BLD",8771,6)
1^
"BLD",8771,6.3)
5
"BLD",8771,"ABPKG")
n
"BLD",8771,"KRN",0)
^9.67PA^779.2^20
"BLD",8771,"KRN",.4,0)
.4
"BLD",8771,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8771,"KRN",.401,0)
.401
"BLD",8771,"KRN",.401,"NM",0)
^9.68A^^
"BLD",8771,"KRN",.402,0)
.402
"BLD",8771,"KRN",.402,"NM",0)
^9.68A^^
"BLD",8771,"KRN",.403,0)
.403
"BLD",8771,"KRN",.403,"NM",0)
^9.68A^^
"BLD",8771,"KRN",.5,0)
.5
"BLD",8771,"KRN",.84,0)
.84
"BLD",8771,"KRN",3.6,0)
3.6
"BLD",8771,"KRN",3.8,0)
3.8
"BLD",8771,"KRN",9.2,0)
9.2
"BLD",8771,"KRN",9.8,0)
9.8
"BLD",8771,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",8771,"KRN",9.8,"NM",1,0)
PSOCAN2^^0^B82356240
"BLD",8771,"KRN",9.8,"NM","B","PSOCAN2",1)

"BLD",8771,"KRN",19,0)
19
"BLD",8771,"KRN",19,"NM",0)
^9.68A^^
"BLD",8771,"KRN",19.1,0)
19.1
"BLD",8771,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8771,"KRN",101,0)
101
"BLD",8771,"KRN",101,"NM",0)
^9.68A^^
"BLD",8771,"KRN",409.61,0)
409.61
"BLD",8771,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",8771,"KRN",771,0)
771
"BLD",8771,"KRN",771,"NM",0)
^9.68A^^
"BLD",8771,"KRN",779.2,0)
779.2
"BLD",8771,"KRN",779.2,"NM",0)
^9.68A^^
"BLD",8771,"KRN",870,0)
870
"BLD",8771,"KRN",870,"NM",0)
^9.68A^^
"BLD",8771,"KRN",8989.51,0)
8989.51
"BLD",8771,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",8771,"KRN",8989.52,0)
8989.52
"BLD",8771,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",8771,"KRN",8994,0)
8994
"BLD",8771,"KRN",8994,"NM",0)
^9.68A^^
"BLD",8771,"KRN","B",.4,.4)

"BLD",8771,"KRN","B",.401,.401)

"BLD",8771,"KRN","B",.402,.402)

"BLD",8771,"KRN","B",.403,.403)

"BLD",8771,"KRN","B",.5,.5)

"BLD",8771,"KRN","B",.84,.84)

"BLD",8771,"KRN","B",3.6,3.6)

"BLD",8771,"KRN","B",3.8,3.8)

"BLD",8771,"KRN","B",9.2,9.2)

"BLD",8771,"KRN","B",9.8,9.8)

"BLD",8771,"KRN","B",19,19)

"BLD",8771,"KRN","B",19.1,19.1)

"BLD",8771,"KRN","B",101,101)

"BLD",8771,"KRN","B",409.61,409.61)

"BLD",8771,"KRN","B",771,771)

"BLD",8771,"KRN","B",779.2,779.2)

"BLD",8771,"KRN","B",870,870)

"BLD",8771,"KRN","B",8989.51,8989.51)

"BLD",8771,"KRN","B",8989.52,8989.52)

"BLD",8771,"KRN","B",8994,8994)

"BLD",8771,"QUES",0)
^9.62^^
"BLD",8771,"REQB",0)
^9.611^1^1
"BLD",8771,"REQB",1,0)
PSO*7.0*379^2
"BLD",8771,"REQB","B","PSO*7.0*379",1)

"FIA",59.7)
PHARMACY SYSTEM
"FIA",59.7,0)
^PS(59.7,
"FIA",59.7,0,0)
59.7
"FIA",59.7,0,1)
y^y^p^^^^n^^n
"FIA",59.7,0,10)

"FIA",59.7,0,11)

"FIA",59.7,0,"RLRO")

"FIA",59.7,0,"VR")
7.0^PSO
"FIA",59.7,59.7)
1
"FIA",59.7,59.7,40.16)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
396^3120221^66485
"PKG",206,22,1,"PAH",1,1,0)
^^8^8^3120221
"PKG",206,22,1,"PAH",1,1,1,0)
This patch will resolve the following 3 tickets:
"PKG",206,22,1,"PAH",1,1,2,0)
HD0000000498138 - Date of Death cancelled prescriptions reinstated does not
"PKG",206,22,1,"PAH",1,1,3,0)
                  show correct Last Fill dates.
"PKG",206,22,1,"PAH",1,1,4,0)
 
"PKG",206,22,1,"PAH",1,1,5,0)
HD0000000601013 - Print issues with TRICARE prescriptions
"PKG",206,22,1,"PAH",1,1,6,0)
 
"PKG",206,22,1,"PAH",1,1,7,0)
HD0000000586028 - Refills are clogging CPRS
"PKG",206,22,1,"PAH",1,1,8,0)
                  (CPRS refills were not processing automatically)
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSOCAN2")
0^1^B82356240^B77487451
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - rx cancel with speed ability drug check ; 2/16/12 3:40pm
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235,148,259,281,287,251,375,379,396**;DEC 1997;Build 5
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCAN2",4,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5425
"RTN","PSOCAN2",5,0)
REINS N DODR,ORN
"RTN","PSOCAN2",6,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",7,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",8,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",9,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",10,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",11,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) N PSOVODA S PSOVODA=DA D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))  S DA=PSOVODA Q:PSORX("DFLG")  D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",12,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",13,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",14,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",15,0)
 W !!,RX_"  "_DRG I $G(POERR) S HPOERR=POERR
"RTN","PSOCAN2",16,0)
 D DRGDRG Q:$G(PSOQUIT)&($G(PSOREINS))
"RTN","PSOCAN2",17,0)
 S:$G(HPOERR) POERR=HPOERR S:$G(PSORX("DFLG"))'=1 PSORX("DFLG")=0
"RTN","PSOCAN2",18,0)
 S RX=HOLDRX K HOLDRX,HPOERR Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))
"RTN","PSOCAN2",19,0)
 S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",20,0)
 N RXIEN S RXIEN=DA
"RTN","PSOCAN2",21,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",22,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",23,0)
 S (LPRT,LREF)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",24,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",25,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",26,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",27,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",28,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",29,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",30,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",31,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",32,0)
 W !,"Prescription #"_RX_" REINSTATED!"
"RTN","PSOCAN2",33,0)
 ;
"RTN","PSOCAN2",34,0)
 N PSOTRIC S PSOTRIC="",PSOTRIC=$$TRIC^PSOREJP1(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",35,0)
 D SUBMIT^PSOREJU3(RXIEN,RFCNT,PSOTRIC)
"RTN","PSOCAN2",36,0)
 ;
"RTN","PSOCAN2",37,0)
 W !?3,"Prescription #",RX_": "
"RTN","PSOCAN2",38,0)
 W !?6,$S('RFCNT:"  Filled",1:"  Refilled # "_LREF)_": "_XFDT,"  Printed: "_$S(LREF=RFCNT:XLPDT,1:""),"  Released: "_$G(XRELDT),!
"RTN","PSOCAN2",39,0)
 I FDT<DT D
"RTN","PSOCAN2",40,0)
 .Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",41,0)
 .Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",42,0)
 .I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",43,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",44,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=RXIEN D Q^PSORXL Q
"RTN","PSOCAN2",45,0)
 I FDT=DT D
"RTN","PSOCAN2",46,0)
 . Q:$$FIND^PSOREJUT(RXIEN)  ;No label for Rx's with unresolved claims rejects
"RTN","PSOCAN2",47,0)
 . Q:PSOTRIC&($$STATUS^PSOBPSUT(RXIEN,RFCNT)["IN PROGRESS")  ;No labels for TRICARE/CHAMPVA in progress Rx *396
"RTN","PSOCAN2",48,0)
 . I PSOTRIC,$P($G(^PSRX(RXIEN,"STA")),"^")=12 Q  ;No label for TRICARE/CHAMPVA if discontinued via Reject Notification screen *396
"RTN","PSOCAN2",49,0)
 . W !?5,"Either print the label using the reprint option "
"RTN","PSOCAN2",50,0)
 . W !?7,"or check later to see if the label has been printed." D WAIT^PSODRG Q
"RTN","PSOCAN2",51,0)
 I FDT>DT&('$G(DODR)) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",52,0)
 K DODR
"RTN","PSOCAN2",53,0)
 Q
"RTN","PSOCAN2",54,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",55,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",56,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",57,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",58,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",59,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",60,0)
 Q
"RTN","PSOCAN2",61,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",62,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",63,0)
 S (PSORX("DFLG"),PSORXED("DFLG"))=0
"RTN","PSOCAN2",64,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",65,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",66,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",67,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",68,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",69,0)
 K PSOY,PSOTECCK S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",70,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S PSOTECCK=1
"RTN","PSOCAN2",71,0)
 S PSORENW("OIRXN")=DA D SET^PSODRG,POST^PSODRG Q:$G(PSOREINS)&$G(PSOQUIT)
"RTN","PSOCAN2",72,0)
 D:$$DS^PSSDSAPI&('$G(PSORX("DFLG"))) DOSCK^PSODOSUT("C")
"RTN","PSOCAN2",73,0)
 S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",74,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",75,0)
 Q
"RTN","PSOCAN2",76,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",77,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",78,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",79,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",80,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",81,0)
 Q
"RTN","PSOCAN2",82,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",83,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",84,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",85,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",86,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",87,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",88,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",89,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",90,0)
 Q
"RTN","PSOCAN2",91,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",92,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",93,0)
 .;PSO*7*259;CHECK IF REFILL RELEASED OR LABEL PRINTED
"RTN","PSOCAN2",94,0)
 .I $P($G(^PSRX(DA,1,IFN,0)),"^",18)]"" Q  ;REFILL RELEASED
"RTN","PSOCAN2",95,0)
 .N PSONODEL,PSOLBL S PSONODEL=0
"RTN","PSOCAN2",96,0)
 .I $P(^PSRX(DA,"STA"),"^")=5 D REF^PSOCAN4 Q:PSONODEL
"RTN","PSOCAN2",97,0)
 .S PSOLBL="" F  S PSOLBL=$O(^PSRX(DA,"L",PSOLBL),-1) Q:'PSOLBL  Q:PSONODEL  Q:$P(^PSRX(DA,"L",PSOLBL,0),"^",2)<IFN  I $P(^PSRX(DA,"L",PSOLBL,0),"^",2)=IFN S PSONODEL=1
"RTN","PSOCAN2",98,0)
 .Q:PSONODEL
"RTN","PSOCAN2",99,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",100,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",101,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",102,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",103,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",104,0)
 K IFN,SUSD
"RTN","PSOCAN2",105,0)
 Q
"RTN","PSOCAN2",106,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",107,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",108,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",109,0)
DELREF ;
"RTN","PSOCAN2",110,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",111,0)
 S PSORFDEL=0
"RTN","PSOCAN2",112,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",113,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",114,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",115,0)
 Q
"RTN","PSOCAN2",116,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",117,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",118,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",119,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",120,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",121,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",122,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",123,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",124,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",125,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",126,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",127,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",128,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",129,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",130,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",131,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",132,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",133,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",134,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",135,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",136,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",137,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",138,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",139,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",140,0)
 K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",141,0)
 Q
"RTN","PSOCAN2",142,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",143,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",144,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",145,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",146,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",147,0)
 I $P(^PSRX(DA,3),"^",10) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",10) ;*396
"RTN","PSOCAN2",148,0)
 S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8)
"RTN","PSOCAN2",149,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",150,0)
 Q
"RTN","PSOCAN2",151,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",152,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",153,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",154,0)
 Q
"RTN","PSOCAN2",155,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN2",156,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN2",157,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN2",158,0)
 S ST6=""
"RTN","PSOCAN2",159,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN2",160,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN2",161,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN2",162,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN2",163,0)
 Q
"RTN","PSOCAN2",164,0)
 ;
"VER")
8.0^22.0
"^DD",59.7,59.7,40.16,0)
AUTOMATE CPRS REFILL^S^0:NO;1:YES;^40.1;7^Q
"^DD",59.7,59.7,40.16,3)
Enter Y to process CPRS refill automatically or N to process it manually.
"^DD",59.7,59.7,40.16,21,0)
^.001^15^15^3120213^^^^
"^DD",59.7,59.7,40.16,21,1,0)
Answer YES if refill requests from CPRS are to be
"^DD",59.7,59.7,40.16,21,2,0)
processed automatically and filed in the PRESCRIPTION file (#52) and
"^DD",59.7,59.7,40.16,21,3,0)
placed on Suspense.
"^DD",59.7,59.7,40.16,21,4,0)
                                                  
"^DD",59.7,59.7,40.16,21,5,0)
Answer NO if refill requests from CPRS are to be filed in the
"^DD",59.7,59.7,40.16,21,6,0)
PENDING OUTPATIENT ORDERS file (#52.41) for manual processing.
"^DD",59.7,59.7,40.16,21,7,0)
                                                                    
"^DD",59.7,59.7,40.16,21,8,0)
NOTE: This functionality is partnered with the PSOAUTRF security key.
"^DD",59.7,59.7,40.16,21,9,0)
When this field is set to YES and the PSOAUTRF security
"^DD",59.7,59.7,40.16,21,10,0)
key has been assigned to at least one user, all refills placed in CPRS
"^DD",59.7,59.7,40.16,21,11,0)
by the provider are processed and suspended with the next fill date and
"^DD",59.7,59.7,40.16,21,12,0)
all routing is set to Mail automatically.
"^DD",59.7,59.7,40.16,21,13,0)
                                                                       
"^DD",59.7,59.7,40.16,21,14,0)
When this field is set to NO or if the PSOAUTRF security 
"^DD",59.7,59.7,40.16,21,15,0)
key is not assigned, the manual refill process is required.
"^DD",59.7,59.7,40.16,"DT")
3120213
"BLD",8771,6)
^341
**END**
**END**
