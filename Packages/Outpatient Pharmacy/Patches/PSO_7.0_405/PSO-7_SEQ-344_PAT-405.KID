Released PSO*7*405 SEQ #344
Extracted from mail message
**KIDS**:PSO*7.0*405^

**INSTALL NAME**
PSO*7.0*405
"BLD",9068,0)
PSO*7.0*405^OUTPATIENT PHARMACY^0^3120402^y
"BLD",9068,1,0)
^^6^6^3120402^
"BLD",9068,1,1,0)
The same last 4 digits of the SSN prints for every patient with Non-VA 
"BLD",9068,1,2,0)
meds and no prescriptions when running the Poly Pharmacy Report for ALL 
"BLD",9068,1,3,0)
patients.
"BLD",9068,1,4,0)
An undefined error occurs when running the Poly Pharmacy Report for one 
"BLD",9068,1,5,0)
patient that has Non-VA Meds and no prescriptions.
"BLD",9068,1,6,0)
The display of the CMOP suspense date is truncated on a reinstate.
"BLD",9068,4,0)
^9.64PA^^
"BLD",9068,6.3)
2
"BLD",9068,"KRN",0)
^9.67PA^779.2^20
"BLD",9068,"KRN",.4,0)
.4
"BLD",9068,"KRN",.401,0)
.401
"BLD",9068,"KRN",.402,0)
.402
"BLD",9068,"KRN",.403,0)
.403
"BLD",9068,"KRN",.5,0)
.5
"BLD",9068,"KRN",.84,0)
.84
"BLD",9068,"KRN",3.6,0)
3.6
"BLD",9068,"KRN",3.8,0)
3.8
"BLD",9068,"KRN",9.2,0)
9.2
"BLD",9068,"KRN",9.8,0)
9.8
"BLD",9068,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",9068,"KRN",9.8,"NM",1,0)
PSOPOLY^^0^B41119787
"BLD",9068,"KRN",9.8,"NM",2,0)
PSOCMOP^^0^B38920299
"BLD",9068,"KRN",9.8,"NM","B","PSOCMOP",2)

"BLD",9068,"KRN",9.8,"NM","B","PSOPOLY",1)

"BLD",9068,"KRN",19,0)
19
"BLD",9068,"KRN",19.1,0)
19.1
"BLD",9068,"KRN",101,0)
101
"BLD",9068,"KRN",409.61,0)
409.61
"BLD",9068,"KRN",771,0)
771
"BLD",9068,"KRN",779.2,0)
779.2
"BLD",9068,"KRN",870,0)
870
"BLD",9068,"KRN",8989.51,0)
8989.51
"BLD",9068,"KRN",8989.52,0)
8989.52
"BLD",9068,"KRN",8994,0)
8994
"BLD",9068,"KRN","B",.4,.4)

"BLD",9068,"KRN","B",.401,.401)

"BLD",9068,"KRN","B",.402,.402)

"BLD",9068,"KRN","B",.403,.403)

"BLD",9068,"KRN","B",.5,.5)

"BLD",9068,"KRN","B",.84,.84)

"BLD",9068,"KRN","B",3.6,3.6)

"BLD",9068,"KRN","B",3.8,3.8)

"BLD",9068,"KRN","B",9.2,9.2)

"BLD",9068,"KRN","B",9.8,9.8)

"BLD",9068,"KRN","B",19,19)

"BLD",9068,"KRN","B",19.1,19.1)

"BLD",9068,"KRN","B",101,101)

"BLD",9068,"KRN","B",409.61,409.61)

"BLD",9068,"KRN","B",771,771)

"BLD",9068,"KRN","B",779.2,779.2)

"BLD",9068,"KRN","B",870,870)

"BLD",9068,"KRN","B",8989.51,8989.51)

"BLD",9068,"KRN","B",8989.52,8989.52)

"BLD",9068,"KRN","B",8994,8994)

"BLD",9068,"QDEF")
^^^^NO^^^^^^NO
"BLD",9068,"QUES",0)
^9.62^^
"BLD",9068,"REQB",0)
^9.611^2^2
"BLD",9068,"REQB",1,0)
PSO*7.0*326^2
"BLD",9068,"REQB",2,0)
PSO*7.0*251^2
"BLD",9068,"REQB","B","PSO*7.0*251",2)

"BLD",9068,"REQB","B","PSO*7.0*326",1)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
405^3120402
"PKG",206,22,1,"PAH",1,1,0)
^^6^6^3120402
"PKG",206,22,1,"PAH",1,1,1,0)
The same last 4 digits of the SSN prints for every patient with Non-VA 
"PKG",206,22,1,"PAH",1,1,2,0)
meds and no prescriptions when running the Poly Pharmacy Report for ALL 
"PKG",206,22,1,"PAH",1,1,3,0)
patients.
"PKG",206,22,1,"PAH",1,1,4,0)
An undefined error occurs when running the Poly Pharmacy Report for one 
"PKG",206,22,1,"PAH",1,1,5,0)
patient that has Non-VA Meds and no prescriptions.
"PKG",206,22,1,"PAH",1,1,6,0)
The display of the CMOP suspense date is truncated on a reinstate.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOCMOP")
0^2^B38920299^B39239270
"RTN","PSOCMOP",1,0)
PSOCMOP ;BIR/HTW-Rx Order Entry Screen for CMOP ;6/28/07 7:35am
"RTN","PSOCMOP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,16,21,27,43,61,126,148,274,347,251,405**;DEC 1997;Build 2
"RTN","PSOCMOP",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOCMOP",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOCMOP",5,0)
 ;External reference to ^PSDRUG supported by DBIA 3165
"RTN","PSOCMOP",6,0)
 ;External reference to ^PSSHUIDG supported by DBIA 3621
"RTN","PSOCMOP",7,0)
 ;External reference to $$DS^PSSDSAPI supported by DBIA 5424
"RTN","PSOCMOP",8,0)
TOP ;
"RTN","PSOCMOP",9,0)
 I $G(PSOFROM)="EDIT" S PPL=$G(PSORX("PSOL",1)) Q:$G(PPL)']""  G TEST
"RTN","PSOCMOP",10,0)
 I $G(PPL) G START
"RTN","PSOCMOP",11,0)
 I '$G(RXLTOP) S PPL=$G(DA) G TEST
"RTN","PSOCMOP",12,0)
 S:'$G(PPL) PPL=$G(PSORX("PSOL",1)) G:$G(PPL)']"" D1
"RTN","PSOCMOP",13,0)
START ;          Establish CMOP PPL
"RTN","PSOCMOP",14,0)
TEST N ACT,B,C,CK,COMM,CNT,DFLG,I,FLAG,MW,NEWDT,PI,P1,P2,REL,RFD,RX,RX0,RXN
"RTN","PSOCMOP",15,0)
 N RXP,RXS,SD,VALMSG,X,X7,Y,ZD,DFN,TRX
"RTN","PSOCMOP",16,0)
 S (P1,P2)=1,FLAG=0
"RTN","PSOCMOP",17,0)
LOOP F CNT=1:1 S RX=$P($G(PPL),",",CNT) Q:RX']""  D  S:'FLAG $P(RX("PSO"),",",P1)=RX,P1=P1+1 S FLAG=0
"RTN","PSOCMOP",18,0)
 .;   PSOMC=Mail Code, PSOMDT=Mail Code Expiration Date
"RTN","PSOCMOP",19,0)
 .N DFN  ;*347
"RTN","PSOCMOP",20,0)
 .S DFN=$P(^PSRX(RX,0),"^",2),PSOMDT=$P($G(^PS(55,DFN,0)),"^",5),PSOMC=$P($G(^PS(55,DFN,0)),"^",3) K DFN  ;*347
"RTN","PSOCMOP",21,0)
 .I (PSOMC>1&(PSOMDT>DT))!(PSOMC>1&(PSOMDT<1)) K PSOMC,PSOMDT Q  ;*347
"RTN","PSOCMOP",22,0)
 .;          Get drug IEN and check if CMOP
"RTN","PSOCMOP",23,0)
 .S CK=$P($G(^PSRX(RX,0)),"^",6) Q:'$D(^PSDRUG("AQ",CK))
"RTN","PSOCMOP",24,0)
 .;          If not marked for O.P., unmark for CMOP...
"RTN","PSOCMOP",25,0)
 .I $P($G(^PSDRUG(CK,2)),"^",3)'["O" D UNMARK^PSOCMOP Q
"RTN","PSOCMOP",26,0)
 .;          Check Drug Warning >11
"RTN","PSOCMOP",27,0)
 .N WARNS,COMM S WARNS=$P(^PSDRUG(CK,0),U,8) I $L(WARNS)>11 D  Q
"RTN","PSOCMOP",28,0)
 .. S COMM(1)="Rx# "_$P(^PSRX(RX,0),"^")_" CMOP cannot dispense - Drug warnings >11 characters."
"RTN","PSOCMOP",29,0)
 .. S COMM(2)="Drug Name: "_$P(^PSDRUG(CK,0),U)_"  (IEN: # "_CK_")"
"RTN","PSOCMOP",30,0)
 .. D COMM(RX,.COMM)
"RTN","PSOCMOP",31,0)
 .;           Q:If partial or pull early
"RTN","PSOCMOP",32,0)
 .Q:$G(RXPR(RX))!($G(RXRS(RX)))
"RTN","PSOCMOP",33,0)
 .;           Q:If standard reprint but allow edit reprint
"RTN","PSOCMOP",34,0)
 .I $G(RXRP(RX))&($P($G(RXRP(RX)),"^",4)'=1) Q
"RTN","PSOCMOP",35,0)
 .;           Q:If tradename
"RTN","PSOCMOP",36,0)
 .Q:$G(^PSRX(RX,"TN"))]""
"RTN","PSOCMOP",37,0)
 .;           Q: If Cancelled, Expired, Deleted, Hold
"RTN","PSOCMOP",38,0)
 .Q:$P(^PSRX(RX,"STA"),"^")>9!($P(^("STA"),"^")=4)!($P(^("STA"),"^")=3)
"RTN","PSOCMOP",39,0)
 .;        Find last fill
"RTN","PSOCMOP",40,0)
 .S RFD=0 F X7=0:0 S X7=$O(^PSRX(RX,1,X7)) Q:'$G(X7)  S (RFD)=X7
"RTN","PSOCMOP",41,0)
 .;if original fill and a tech stop
"RTN","PSOCMOP",42,0)
 .I 'RFD,$P(^PSRX(RX,"STA"),"^")=4!($D(^PSRX(RX,"DRI"))&('$D(^XUSEC("PSORPH",DUZ)))) Q
"RTN","PSOCMOP",43,0)
 .I 'RFD,$$DS^PSSDSAPI,($G(^PS(52.4,RX,1))>0)&('$D(^XUSEC("PSORPH",DUZ))) Q
"RTN","PSOCMOP",44,0)
 .Q:$G(RXFL(RX))&(RFD)&($G(RXFL(RX))'=RFD)
"RTN","PSOCMOP",45,0)
 .I '$O(^PSRX(RX,1,0)),'$P($G(^PSRX(RX,2)),"^",13),$P($G(^(0)),"^",11)="W",$S($P($G(^PSRX(RX,2)),"^",2):$P($G(^(2)),"^",2),1:+$G(PSOX("FILL DATE")))>DT D
"RTN","PSOCMOP",46,0)
 ..S PSOCPDA=$G(DA) K DIE S DA=RX,DIE="^PSRX(",DR="11////M" D ^DIE K DIE S:$G(PSOCPDA) DA=$G(PSOCPDA) K PSOCPDA
"RTN","PSOCMOP",47,0)
 .;           Q:If not "Mail"
"RTN","PSOCMOP",48,0)
 .S MW=$S($G(RFD)>0:$P(^PSRX(RX,1,RFD,0),"^",2),1:$P(^PSRX(RX,0),"^",11)) K X7 I $G(MW)="W"  K RFD Q
"RTN","PSOCMOP",49,0)
 .;
"RTN","PSOCMOP",50,0)
 .;           Q:If fill was CMOPed and other than a '3' 'not dispensed' 
"RTN","PSOCMOP",51,0)
 .Q:'$$FILTRAN(RX,RFD)
"RTN","PSOCMOP",52,0)
 .;
"RTN","PSOCMOP",53,0)
 .;            Check if released, for use in Sus
"RTN","PSOCMOP",54,0)
 .S REL=$S(RFD=0:$P($G(^PSRX(RX,2)),"^",13),1:$P($G(^PSRX(RX,1,RFD,0)),"^",18)) K RFD
"RTN","PSOCMOP",55,0)
 .I $G(REL) Q
"RTN","PSOCMOP",56,0)
 .;           Save CMOP's in PSXPPL1
"RTN","PSOCMOP",57,0)
 .S $P(RX("CMOP"),",",P2)=RX,P2=P2+1,FLAG=1 Q
"RTN","PSOCMOP",58,0)
 K PPL S PPL=$G(RX("PSO")),RX1("CMOP")=$G(RX("CMOP")) K RX("PSO")
"RTN","PSOCMOP",59,0)
 G:$G(XFROM)="EDIT" D1 ; passed from PSXEDIT
"RTN","PSOCMOP",60,0)
RESET ;
"RTN","PSOCMOP",61,0)
 G:'$G(RX("CMOP")) D1
"RTN","PSOCMOP",62,0)
 I $G(XFROM)="REINSTATE"!($G(XFROM)="UNHOLD") Q
"RTN","PSOCMOP",63,0)
 I $G(PSOFROM)="EDIT",($G(REL)]"") S PPL=RX("CMOP") G D1
"RTN","PSOCMOP",64,0)
S ;           Auto-Suspend CMOPS
"RTN","PSOCMOP",65,0)
 N DA,Y
"RTN","PSOCMOP",66,0)
 F PI=1:1 S DA=$P($G(RX("CMOP")),",",PI) Q:'DA  D SUS
"RTN","PSOCMOP",67,0)
 S SUSPT="SUSPENSE"
"RTN","PSOCMOP",68,0)
 G D1
"RTN","PSOCMOP",69,0)
SUS ;
"RTN","PSOCMOP",70,0)
 I $G(XFROM)="REINSTATE" W !,RX_" REINSTATED -- "
"RTN","PSOCMOP",71,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),SD=$S($G(ZD(DA)):$E(ZD(DA),1,7),1:$P(^(3),"^")),RXS=$O(^PS(52.5,"B",DA,0)) I RXS D  Q:$G(DFLG)
"RTN","PSOCMOP",72,0)
 .S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCMOP",73,0)
 K X7 S RFD1=0 F X7=0:0 S X7=$O(^PSRX(DA,1,X7)) Q:'$G(X7)  S (RFD1)=X7
"RTN","PSOCMOP",74,0)
LOCK S RXP=+$G(RXPR(DA)),DIC="^PS(52.5,",DIC(0)="",X=RXN
"RTN","PSOCMOP",75,0)
 S DIC("DR")=".02////"_SD_";.03////"_$P(^PSRX(DA,0),"^",2)_";.04////M;.05////"_RXP_";.06////"_PSOSITE_";2////0;3////Q;9////"_RFD1
"RTN","PSOCMOP",76,0)
 K DD,DO D FILE^DICN K DD,DO S DA=RXN I +Y S PSONAME=$P(^PSRX(DA,0),"^",2) K ^PS(52.5,"AC",PSONAME,SD,+Y),PSONAME
"RTN","PSOCMOP",77,0)
 S $P(^PSRX(RXN,"STA"),"^")=5,LFD=$E(SD,4,5)_"-"_$E(SD,6,7)_"-"_$E(SD,2,3) D ACT
"RTN","PSOCMOP",78,0)
 W !!,"RX# ",$P(^PSRX(RXN,0),"^")_" SUSPENDED for CMOP Until "_LFD_"."
"RTN","PSOCMOP",79,0)
 S VALMSG="Rx# "_$P(^PSRX(RXN,0),"^")_" Suspended for CMOP Until "_LFD_"."
"RTN","PSOCMOP",80,0)
 S COMM="Rx# "_$P(^PSRX(RXN,0),"^")_" Suspended for CMOP Until "_LFD_"."
"RTN","PSOCMOP",81,0)
 D EN^PSOHLSN1(RXN,"SC","ZS",COMM) K COMM
"RTN","PSOCMOP",82,0)
 ;- Calling ECME to reverse any PAYABLE claim for the prescription/fill
"RTN","PSOCMOP",83,0)
 D REVERSE^PSOBPSU1(RXN,,"DC",3)
"RTN","PSOCMOP",84,0)
 Q
"RTN","PSOCMOP",85,0)
ACT S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOCMOP",86,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOCMOP",87,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOCMOP",88,0)
 D NOW^%DTC S ^PSRX(DA,"A",IR,0)=%_"^S^"_DUZ_"^"_RXF_"^"_"RX Placed on Suspense for CMOP until "_LFD
"RTN","PSOCMOP",89,0)
 K RXF,I,FDA,DIC,DIE,DR,Y,X,%,%H,%I
"RTN","PSOCMOP",90,0)
 Q
"RTN","PSOCMOP",91,0)
D1 K CNT,COUNT,DFLG,DIRUT,DIROUT,DTOUT,DUOUT,EXDT,FLAG,FLD,L,PDUZ,PI,X7
"RTN","PSOCMOP",92,0)
 K PSOCMOP,REF,REPRINT,RFDATE,RFL1,RFLL,RXPD,SD,SUSPT,WARN,XFROM,ZY,RX1
"RTN","PSOCMOP",93,0)
 Q
"RTN","PSOCMOP",94,0)
RXL N FROM S FROM=$G(PSOFROM)
"RTN","PSOCMOP",95,0)
 I ((FROM="NEW")!(FROM="REFILL")!(FROM="CANCEL")!(FROM="BATCH")!($G(XFROM)="HOLD")!($G(XFROM)="BATCH")) G TOP
"RTN","PSOCMOP",96,0)
 Q
"RTN","PSOCMOP",97,0)
SUS1 ;
"RTN","PSOCMOP",98,0)
 N PPL
"RTN","PSOCMOP",99,0)
 S PPL=DA D TEST
"RTN","PSOCMOP",100,0)
 I $G(PPL)']"" S XFLAG=1
"RTN","PSOCMOP",101,0)
 S RX("CMOP")=$G(RX1("CMOP"))
"RTN","PSOCMOP",102,0)
 Q
"RTN","PSOCMOP",103,0)
A S:'$G(PPL) PPL=$G(PSORX("PSOL",PPL1)) G:$G(PPL)']"" D1
"RTN","PSOCMOP",104,0)
 G TEST
"RTN","PSOCMOP",105,0)
UNMARK ;Entry point to unmark drug for CMOP dispense
"RTN","PSOCMOP",106,0)
 N X,Z,%
"RTN","PSOCMOP",107,0)
 S $P(^PSDRUG(CK,3),"^",1)=0 K ^PSDRUG("AQ",CK)
"RTN","PSOCMOP",108,0)
 S:'$D(^PSDRUG(CK,4,0)) ^PSDRUG(CK,4,0)="^50.0214DA^^"
"RTN","PSOCMOP",109,0)
 S (X,Z)=0 F  S Z=$O(^PSDRUG(CK,4,Z)) Q:'Z  S X=Z
"RTN","PSOCMOP",110,0)
 S X=X+1 D NOW^%DTC S ^PSDRUG(CK,4,X,0)=%_"^E^"_DUZ_"^CMOP Dispense^"_$S($G(^PSDRUG(CK,3))=1:"YES",$G(^PSDRUG(CK,3))=0:"NO",1:"")
"RTN","PSOCMOP",111,0)
 S $P(^PSDRUG(CK,4,0),"^",3)=X,$P(^(0),"^",4)=$P(^(0),"^",4)+1
"RTN","PSOCMOP",112,0)
 I $$PATCH^XPDUTL("PSS*1.0*70") D DRG^PSSHUIDG(CK)
"RTN","PSOCMOP",113,0)
 K X,Z,%
"RTN","PSOCMOP",114,0)
 Q
"RTN","PSOCMOP",115,0)
FILTRAN(RX,RFD) ; Test fill's CMOP tran status, return 1 if OK to send
"RTN","PSOCMOP",116,0)
 N DA,CMOP
"RTN","PSOCMOP",117,0)
 S DA=RX
"RTN","PSOCMOP",118,0)
 D ^PSOCMOPA
"RTN","PSOCMOP",119,0)
 I '$D(CMOP(RFD)) Q 1
"RTN","PSOCMOP",120,0)
 I CMOP(RFD)=3 Q 1
"RTN","PSOCMOP",121,0)
 Q 0
"RTN","PSOCMOP",122,0)
COMM(RXN,COMM) ;EP process problem message to g.cmop managers
"RTN","PSOCMOP",123,0)
 N XMSUB,XMTEXT
"RTN","PSOCMOP",124,0)
 S XMTEXT="COMM(",XMY("I:G.CMOP MANAGERS")=""
"RTN","PSOCMOP",125,0)
 S XMSUB="CMOP RX PROBLEM ENCOUNTERED"
"RTN","PSOCMOP",126,0)
 D ^XMD
"RTN","PSOCMOP",127,0)
 Q
"RTN","PSOCMOP",128,0)
CMPRXTYP(SUSDA) ; given suspense record SUSDA returns RX CMOP TYPE C - CS, N -Non-CS
"RTN","PSOCMOP",129,0)
 ;used in compound index ^PS(52.5,"CMP",STAT,TYP,DIV,DATE,DFN,DA)
"RTN","PSOCMOP",130,0)
 N RXDA,DRGDA,DEA,TYP
"RTN","PSOCMOP",131,0)
 S RXDA=$P(^PS(52.5,SUSDA,0),U),DRGDA=$P(^PSRX(RXDA,0),U,6)
"RTN","PSOCMOP",132,0)
 S TYP="N",DEA=$P(^PSDRUG(DRGDA,0),U,3) F I=3,4,5 I DEA[I S TYP="C"
"RTN","PSOCMOP",133,0)
 Q TYP
"RTN","PSOCMOP",134,0)
NOW() D NOW^%DTC Q %
"RTN","PSOCMOP",135,0)
 ;
"RTN","PSOCMOP",136,0)
PIECE(REC,DLM,VP) ; VP="Variable^Piece"
"RTN","PSOCMOP",137,0)
 ; Set Variable V = piece P of REC using delimiter DLM
"RTN","PSOCMOP",138,0)
 N V,P S V=$P(VP,U),P=$P(VP,U,2),@V=$P(REC,DLM,P)
"RTN","PSOCMOP",139,0)
 Q
"RTN","PSOCMOP",140,0)
PUT(REC,DLM,VP) ; VP="Variable^Piece"
"RTN","PSOCMOP",141,0)
 ; pass by reference D PUT^PSOCMOP(.REC,DLM,VP)
"RTN","PSOCMOP",142,0)
 ; Set Variable V into piece P of REC using delimiter DLM
"RTN","PSOCMOP",143,0)
 N V,P S V=$P(VP,U),P=$P(VP,U,2)
"RTN","PSOCMOP",144,0)
 S $P(REC,DLM,P)=$G(@V)
"RTN","PSOCMOP",145,0)
 Q
"RTN","PSOCMOP",146,0)
KCMPX(SUS,VAL) ; Kill ^PS(52.5,"CMP",VAL index given SUS
"RTN","PSOCMOP",147,0)
 N SDT,TYP,DFN,DIV,RX,F,XX
"RTN","PSOCMOP",148,0)
 S F=$G(^PS(52.5,SUS,0)) Q:'+F  S TYP=$$CMPRXTYP(SUS)
"RTN","PSOCMOP",149,0)
 F XX="RX^1","SDT^2","DFN^3","DIV^6" D PIECE(F,U,XX)
"RTN","PSOCMOP",150,0)
 K ^PS(52.5,"CMP",VAL,TYP,DIV,SDT,DFN,SUS)
"RTN","PSOCMOP",151,0)
 Q
"RTN","PSOCMOP",152,0)
SCMPX(SUS,VAL) ; Set  ^PS(52.5,"CMP",VAL index given SUS
"RTN","PSOCMOP",153,0)
 N SDT,TYP,DFN,DIV,RX,F,XX
"RTN","PSOCMOP",154,0)
 S F=$G(^PS(52.5,SUS,0)) Q:'+F  S TYP=$$CMPRXTYP(SUS)
"RTN","PSOCMOP",155,0)
 F XX="RX^1","SDT^2","DFN^3","DIV^6" D PIECE(F,U,XX)
"RTN","PSOCMOP",156,0)
 S ^PS(52.5,"CMP",VAL,TYP,DIV,SDT,DFN,SUS)=""
"RTN","PSOCMOP",157,0)
 Q
"RTN","PSOPOLY")
0^1^B41119787^B40529966
"RTN","PSOPOLY",1,0)
PSOPOLY ;BHAM ISC/SAB - patients with a minimum amount of rx's within a # of days ;10/06/93
"RTN","PSOPOLY",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**19,28,132,326,405**;DEC 1997;Build 2
"RTN","PSOPOLY",3,0)
 ;External reference ^PS(55 supported by DBIA# 2228
"RTN","PSOPOLY",4,0)
 ;External reference ^PSDRUG( supported by DBIA# 221
"RTN","PSOPOLY",5,0)
 ;External reference ^DPT( supported by DBIA# 10035
"RTN","PSOPOLY",6,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOPOLY",7,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOPOLY",8,0)
 K ^TMP($J),DIR S PG=0
"RTN","PSOPOLY",9,0)
 S DIR("A")="Number Of Days To Begin Search",DIR("?")="^D HLP^PSOPOLY",DIR(0)="N^1:730:0",DIR("B")=180 D ^DIR G:$D(DIRUT) END S DAYS=Y K DIR
"RTN","PSOPOLY",10,0)
 S DIR("A")="Minimum Number Of Rxs and Active Non-VA Meds",DIR("B")=7,DIR("?")="^D HLP1^PSOPOLY",DIR(0)="N^1:100:0" D ^DIR G:$D(DIRUT) END S RX=Y K DIR
"RTN","PSOPOLY",11,0)
PAT W !! S DIC("A")="Enter Patient's Name or ^ALL for All Patients: "
"RTN","PSOPOLY",12,0)
 S DIC(0)="QEM" D EN^PSOPATLK S Y=PSOPTLK G:$E(Y,1,2)="^A"!($E(Y,1,2)="^a") ALL G:"^"[$E(Y) END S (PSODFN,DFN)=+Y
"RTN","PSOPOLY",13,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN) S ALL=0 D DEV G:$G(QP)!($D(ZTSK)) END
"RTN","PSOPOLY",14,0)
ENQ D CON,PID^VADPT S DFN=PSODFN I '$O(^PS(55,DFN,"P","A",PSDATE)),'$O(^PS(55,DFN,"NVA",0)) G NRX
"RTN","PSOPOLY",15,0)
BEG S RXS=0 S:$G(PSDATEX) PSDATE=PSDATEX
"RTN","PSOPOLY",16,0)
 F  S PSDATE=$O(^PS(55,DFN,"P","A",PSDATE)) Q:'PSDATE  S (P,J)=0 F  S J=$O(^PS(55,DFN,"P","A",PSDATE,J)) Q:'J  D:$D(^PSRX(J,0))
"RTN","PSOPOLY",17,0)
 .I 134'[$E(+$P($G(^PSRX(J,"STA")),"^")),$P($G(^PSDRUG($P($G(^PSRX(J,0)),"^",6),0)),"^",3)'["S" S RXS=RXS+1,RX(DFN,J)=+$P($G(^PSRX(J,"STA")),"^")
"RTN","PSOPOLY",18,0)
 N NVA F NVA=0:0 S NVA=$O(^PS(55,DFN,"NVA",NVA)) Q:'NVA  I '$P(^PS(55,DFN,"NVA",NVA,0),"^",7) S RXS=RXS+1
"RTN","PSOPOLY",19,0)
 I RXS'<RX S P=0 F  S P=$O(RX(DFN,P)) Q:'P  S RX0=$S($D(^PSRX(P,0)):^(0),1:""),RX2=$S($D(^(2)):^(2),1:""),RX3=$S($D(^(3)):^(3),1:"") D
"RTN","PSOPOLY",20,0)
 .S STA=RX(DFN,P),DRUG=$S($D(^PSDRUG($P(RX0,"^",6),0)):$P(^PSDRUG($P(RX0,"^",6),0),"^"),1:"UNKNOWN"),CLASS=$S($P($G(^PSDRUG($P(RX0,"^",6),0)),"^",2)]"":$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOPOLY",21,0)
A .S STAT="A^N^R^H^N^S^^^^^^E^DC^^DC^DE^H^P^",STATUS=$P(STAT,"^",STA+1)
"RTN","PSOPOLY",22,0)
 .S FILLDATE=9999999-$P(^PSRX(P,2),"^",2)
"RTN","PSOPOLY",23,0)
 .S ^TMP($J,$P(^DPT(DFN,0),"^"),CLASS,DRUG,FILLDATE,P)=$P(^PSRX(P,0),"^",2)_"^"_RXS_"^"_$P(RX3,"^")_"^"_$P(RX0,"^",4)_"^"_STATUS_"^"_VA("BID")_"^"_DFN
"RTN","PSOPOLY",24,0)
 I RXS'<RX,$O(^TMP($J,$P(^DPT(DFN,0),"^"),""))="" S CLASS="NVA",^TMP($J,$P(^DPT(DFN,0),"^"),CLASS)=DFN_"^"_RXS
"RTN","PSOPOLY",25,0)
 S RXS=0 K RX(DFN),CLASS
"RTN","PSOPOLY",26,0)
 I 'ALL,'$D(^TMP($J)) G NRX
"RTN","PSOPOLY",27,0)
 I 'ALL D PRI G:$G(PSOTRUE) END D NVA G END
"RTN","PSOPOLY",28,0)
 Q
"RTN","PSOPOLY",29,0)
 ;
"RTN","PSOPOLY",30,0)
PRI S PG=0 D HDR S (DFN,ZDFN)="" D
"RTN","PSOPOLY",31,0)
 .F  S DFN=$O(^TMP($J,DFN)) Q:DFN=""  S (ZCLASS,CLASS)="" D  I ALL,$G(CLASS)="" D:'$G(PSOTRUE) NVA K PSOTRUE W ! F I=1:1:132 W "-"
"RTN","PSOPOLY",32,0)
 ..F  S CLASS=$O(^TMP($J,DFN,CLASS)) Q:CLASS=""  D
"RTN","PSOPOLY",33,0)
 ...I CLASS="NVA" S PSODFN=$P(^TMP($J,DFN,"NVA"),"^"),PSOTRUE=1 D NVA Q
"RTN","PSOPOLY",34,0)
 ...S DRUG="" F  S DRUG=$O(^TMP($J,DFN,CLASS,DRUG)) Q:DRUG=""  S FILLDATE="" F  S FILLDATE=$O(^TMP($J,DFN,CLASS,DRUG,FILLDATE)) Q:'FILLDATE  D
"RTN","PSOPOLY",35,0)
 ....F RNX=0:0 S RNX=$O(^TMP($J,DFN,CLASS,DRUG,FILLDATE,RNX)) Q:'RNX  S POLY=^(RNX),PSODFN=$P(POLY,"^",7) D
"RTN","PSOPOLY",36,0)
 .....I ($Y+5)>IOSL D HDR
"RTN","PSOPOLY",37,0)
 .....W ! W:ZDFN'=DFN !,DFN_" ("_$P(POLY,"^",6)_")" W:ZDFN'=DFN ?65,$J($P(POLY,"^",2),3),! W:ZCLASS'=CLASS ?2,$E(CLASS,1,16)
"RTN","PSOPOLY",38,0)
 .....W ?22,DRUG,?65,$P(POLY,"^",5) S Y=$P(POLY,"^",3) W ?77 D DT^DIQ S PROV=$P($G(^VA(200,$P(POLY,"^",4),0)),"^") W ?92,$E(PROV,1,25),?121,$P(^PSRX(RNX,0),"^") S ZCLASS=CLASS,ZDFN=DFN
"RTN","PSOPOLY",39,0)
 .....S TOTRX=$G(TOTRX)+1 S:'$D(^TMP($J,"PAT",DFN)) TOTP=$G(TOTP)+1,^TMP($J,"PAT",DFN)=""
"RTN","PSOPOLY",40,0)
 I ALL U IO W !!,"Total Number of Patients: "_TOTP,?40,"Total Number of Rxs: "_TOTRX,?80,"Average Rxs per Patient: "_(TOTRX\TOTP)
"RTN","PSOPOLY",41,0)
 Q
"RTN","PSOPOLY",42,0)
END W ! D ^%ZISC K QP,^TMP($J),DIR,DTOUT,DUOUT,DIRUT,DIROUT,%DT,ALL,CLASS,DAYS,DFN,DIC,DRUG,EDT,FILLDATE,PSDATEX,G,I,J,P,PSDATE,RX,RXS,RX0,RX2,RX3,SDT,X,Y,POLY,PROV,POP,RNX,Z0,Z1,Z2,ZCLASS,PG,ZDFN,ZTSK,STA,STAT,STATUS D KVA^VADPT
"RTN","PSOPOLY",43,0)
 K PSODFN,PAT,TOTRX,TOTP S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOPOLY",44,0)
 Q
"RTN","PSOPOLY",45,0)
ALL ;print all patients
"RTN","PSOPOLY",46,0)
 W ! S ALL=1,(TOTRX,TOTP)=0 D DEV G:$G(QP)!($D(ZTSK)) END
"RTN","PSOPOLY",47,0)
ALLP D CON
"RTN","PSOPOLY",48,0)
 F DFN=0:0 S DFN=$O(^PS(55,DFN)) Q:'DFN  S ALL=1 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN) D PID^VADPT,BEG
"RTN","PSOPOLY",49,0)
 I '$D(^TMP($J)) G NRX
"RTN","PSOPOLY",50,0)
 D PRI,END
"RTN","PSOPOLY",51,0)
 Q
"RTN","PSOPOLY",52,0)
CON ;convert data to date
"RTN","PSOPOLY",53,0)
 S %DT="",X="T-"_DAYS D ^%DT S SDT=Y,(PSDATE,PSDATEX)=SDT-1,X="T" D ^%DT S EDT=Y,RXS=0
"RTN","PSOPOLY",54,0)
 Q
"RTN","PSOPOLY",55,0)
NRX ;prints no rx message
"RTN","PSOPOLY",56,0)
 D HDR U IO W:'ALL !,$P(^DPT(DFN,0),"^")_" ("_VA("BID")_")" W !?20,">>>> No Active Prescriptions and/or Non-VA Meds found within the Range <<<<" W @IOF G END
"RTN","PSOPOLY",57,0)
 Q
"RTN","PSOPOLY",58,0)
HLP ;help module
"RTN","PSOPOLY",59,0)
 W !!,$C(7),"Enter numeric value greater than zero.",!,"The value must a whole number, no decimals or fractions.",!!
"RTN","PSOPOLY",60,0)
 Q
"RTN","PSOPOLY",61,0)
HLP1 W !!,$C(7),"Enter a numeric value greater than zero.",!,"The number seven (7) is the default, no decimals or fractions.",!,"The count will include both Active Prescriptions and Non-VA Medications.",!!
"RTN","PSOPOLY",62,0)
 Q
"RTN","PSOPOLY",63,0)
DEV K %ZIS,IOP,ZTSK S %ZIS("B")="",PSOION=ION,%ZIS="QM" D ^%ZIS K %ZIS I POP S QP=1,IOP=PSOION D ^%ZIS K IOP,PSOION Q
"RTN","PSOPOLY",64,0)
 I $G(IOM)<132 W $C(7),!!,"Printout Must be 132 Columns.",!! G DEV
"RTN","PSOPOLY",65,0)
 K PSOION I $D(IO("Q")) D  K IO("Q") D ^%ZTLOAD W:$D(ZTSK) !,"Report is queued to print !",!
"RTN","PSOPOLY",66,0)
 .S ZTDESC="Poly Pharmacy Report",ZTRTN=$S('ALL:"ENQ^PSOPOLY",1:"ALLP^PSOPOLY") F G="ALL","RX","DAYS","DFN","PG","PSODFN" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOPOLY",67,0)
 Q
"RTN","PSOPOLY",68,0)
HDR ;report header
"RTN","PSOPOLY",69,0)
 S PG=PG+1 U IO W @IOF,?55,"Poly Pharmacy Report",!?50,$E(SDT,4,5)_"-"_$E(SDT,6,7)_"-"_($E(SDT,1,3)+1700)_"    to    "_$E(EDT,4,5)_"-"_$E(EDT,6,7)_"-"_($E(EDT,1,3)+1700)
"RTN","PSOPOLY",70,0)
 W !?37," for "_DAYS_" Days for "_RX_" or More Active Prescriptions and/or Non-VA Meds"
"RTN","PSOPOLY",71,0)
 W ?122,"Page "_PG,!,"Patient",?40,"ID#",?62,"Active Rx's",!,?2,"Class",?22,"Drug",?65,"Status",?77,"Last Filled",?92,"Provider",?121,"Rx Number"
"RTN","PSOPOLY",72,0)
 W ! F I=1:1:132 W "-"
"RTN","PSOPOLY",73,0)
 Q
"RTN","PSOPOLY",74,0)
NVA ;displays non-va meds
"RTN","PSOPOLY",75,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))  N TITLE
"RTN","PSOPOLY",76,0)
 D  ;*405
"RTN","PSOPOLY",77,0)
 .N DFN S DFN=PSODFN
"RTN","PSOPOLY",78,0)
 .D KVA^VADPT
"RTN","PSOPOLY",79,0)
 .D PID^VADPT
"RTN","PSOPOLY",80,0)
 S PSOSTA=">>>Non-VA MEDS (Not dispensed by VA)<<<"
"RTN","PSOPOLY",81,0)
 S STR=($L(PSOSTA)+IOM/2)-$L(PSOSTA),STP=IOM-(STR+$L(PSOSTA)) F I=1:1:STR S TITLE=$G(TITLE)_" "
"RTN","PSOPOLY",82,0)
 S TITLE=TITLE_PSOSTA F I=1:1:STP S TITLE=TITLE_" "
"RTN","PSOPOLY",83,0)
 D:($Y+7)>IOSL HDR W !!,TITLE
"RTN","PSOPOLY",84,0)
 I $G(CLASS)="NVA" W !,DFN_" ("_VA("BID")_")",?40,"Total Non-VA Meds: "_$P(^TMP($J,DFN,CLASS),"^",2)
"RTN","PSOPOLY",85,0)
 F NVAO=0:0 S NVAO=$O(^PS(55,PSODFN,"NVA",NVAO)) Q:'NVAO  D
"RTN","PSOPOLY",86,0)
 .Q:$P(^PS(55,PSODFN,"NVA",NVAO,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",NVAO,0),"^")
"RTN","PSOPOLY",87,0)
 .S DUPRX0=^PS(55,PSODFN,"NVA",NVAO,0)
"RTN","PSOPOLY",88,0)
 .I ($Y+7)>IOSL D HDR W !!,TITLE,!,$P(^DPT(PSODFN,0),"^")_" ("_VA("BID")_")"
"RTN","PSOPOLY",89,0)
 .S DOI=$S($P(DUPRX0,"^",2):$P(^PSDRUG($P(DUPRX0,"^",2),0),"^"),1:$P(^PS(50.7,$P(DUPRX0,"^"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^"))
"RTN","PSOPOLY",90,0)
 .W !?2,DOI_" "_$P(DUPRX0,"^",3)
"RTN","PSOPOLY",91,0)
 .W !?5,"Schedule: "_$P(DUPRX0,"^",5)
"RTN","PSOPOLY",92,0)
 .W !?5,"Start Date: "_$$FMTE^XLFDT($P(DUPRX0,"^",9)),?45," Documented: "_$$FMTE^XLFDT($P(DUPRX0,"^",10)) ;_"  Status: Active"
"RTN","PSOPOLY",93,0)
 K DUPRX0,NVA,STP,STR,PSOSTA,TITLE,DOI
"RTN","PSOPOLY",94,0)
 Q
"VER")
8.0^22.0
"BLD",9068,6)
^344
**END**
**END**
