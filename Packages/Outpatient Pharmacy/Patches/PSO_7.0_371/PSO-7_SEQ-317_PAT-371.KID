Released PSO*7*371 SEQ #317
Extracted from mail message
**KIDS**:PSO*7.0*371^

**INSTALL NAME**
PSO*7.0*371
"BLD",7856,0)
PSO*7.0*371^OUTPATIENT PHARMACY^0^3110215^y
"BLD",7856,1,0)
^^7^7^3110215^
"BLD",7856,1,1,0)
This patch will resolve two issues with the List of Patients/Prescriptions
"BLD",7856,1,2,0)
for Recall Notices.
"BLD",7856,1,3,0)
 
"BLD",7856,1,4,0)
1)  List of Patients/Prescriptions for Recall Notices is wrapping
"BLD",7856,1,5,0)
    incorrectly.
"BLD",7856,1,6,0)
 
"BLD",7856,1,7,0)
2)  PSO RECALL LIST Report needs End-of-Record Identifier.
"BLD",7856,4,0)
^9.64PA^^
"BLD",7856,6)
2^
"BLD",7856,6.3)
12
"BLD",7856,"ABPKG")
n
"BLD",7856,"KRN",0)
^9.67PA^779.2^20
"BLD",7856,"KRN",.4,0)
.4
"BLD",7856,"KRN",.401,0)
.401
"BLD",7856,"KRN",.402,0)
.402
"BLD",7856,"KRN",.403,0)
.403
"BLD",7856,"KRN",.5,0)
.5
"BLD",7856,"KRN",.84,0)
.84
"BLD",7856,"KRN",3.6,0)
3.6
"BLD",7856,"KRN",3.8,0)
3.8
"BLD",7856,"KRN",9.2,0)
9.2
"BLD",7856,"KRN",9.8,0)
9.8
"BLD",7856,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",7856,"KRN",9.8,"NM",1,0)
PSORLST^^0^B59288392
"BLD",7856,"KRN",9.8,"NM",2,0)
PSORLST2^^0^B70157701
"BLD",7856,"KRN",9.8,"NM","B","PSORLST",1)

"BLD",7856,"KRN",9.8,"NM","B","PSORLST2",2)

"BLD",7856,"KRN",19,0)
19
"BLD",7856,"KRN",19.1,0)
19.1
"BLD",7856,"KRN",101,0)
101
"BLD",7856,"KRN",409.61,0)
409.61
"BLD",7856,"KRN",771,0)
771
"BLD",7856,"KRN",779.2,0)
779.2
"BLD",7856,"KRN",870,0)
870
"BLD",7856,"KRN",8989.51,0)
8989.51
"BLD",7856,"KRN",8989.52,0)
8989.52
"BLD",7856,"KRN",8994,0)
8994
"BLD",7856,"KRN","B",.4,.4)

"BLD",7856,"KRN","B",.401,.401)

"BLD",7856,"KRN","B",.402,.402)

"BLD",7856,"KRN","B",.403,.403)

"BLD",7856,"KRN","B",.5,.5)

"BLD",7856,"KRN","B",.84,.84)

"BLD",7856,"KRN","B",3.6,3.6)

"BLD",7856,"KRN","B",3.8,3.8)

"BLD",7856,"KRN","B",9.2,9.2)

"BLD",7856,"KRN","B",9.8,9.8)

"BLD",7856,"KRN","B",19,19)

"BLD",7856,"KRN","B",19.1,19.1)

"BLD",7856,"KRN","B",101,101)

"BLD",7856,"KRN","B",409.61,409.61)

"BLD",7856,"KRN","B",771,771)

"BLD",7856,"KRN","B",779.2,779.2)

"BLD",7856,"KRN","B",870,870)

"BLD",7856,"KRN","B",8989.51,8989.51)

"BLD",7856,"KRN","B",8989.52,8989.52)

"BLD",7856,"KRN","B",8994,8994)

"BLD",7856,"QUES",0)
^9.62^^
"BLD",7856,"REQB",0)
^9.611^1^1
"BLD",7856,"REQB",1,0)
PSO*7.0*348^2
"BLD",7856,"REQB","B","PSO*7.0*348",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
371^3110215^1000018
"PKG",141,22,1,"PAH",1,1,0)
^^7^7^3110215
"PKG",141,22,1,"PAH",1,1,1,0)
This patch will resolve two issues with the List of Patients/Prescriptions
"PKG",141,22,1,"PAH",1,1,2,0)
for Recall Notices.
"PKG",141,22,1,"PAH",1,1,3,0)
 
"PKG",141,22,1,"PAH",1,1,4,0)
1)  List of Patients/Prescriptions for Recall Notices is wrapping
"PKG",141,22,1,"PAH",1,1,5,0)
    incorrectly.
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
2)  PSO RECALL LIST Report needs End-of-Record Identifier.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSORLST")
0^1^B59288392^B56046364
"RTN","PSORLST",1,0)
PSORLST ;BIRM/MFR - List of Patients/Prescriptions for Recall Notice ;12/30/09
"RTN","PSORLST",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**348,371**;DEC 1997;Build 12
"RTN","PSORLST",3,0)
 ;
"RTN","PSORLST",4,0)
 ; External reference to ^PSS50 supported by DBIA 4533
"RTN","PSORLST",5,0)
 ; External reference to ^PSS50P7 supported by DBIA 4662
"RTN","PSORLST",6,0)
 ; External reference to ^DPT supported by DBIA 10035
"RTN","PSORLST",7,0)
 ; External reference to ^PSNDF(50.6 supported by DBIA 2079
"RTN","PSORLST",8,0)
 ;
"RTN","PSORLST",9,0)
START ; Prompt user for search/selection criteria.
"RTN","PSORLST",10,0)
 N PSODTRNG,PSONDC,PSOMED,PSOXDED,PSODDRG,PSOOI,PSOGEN,DDRG,EXIT,PSODIV,PSORXDIV,PSODJ
"RTN","PSORLST",11,0)
 N DIC,PSODEAD,OUTPUT,PSOSDIV,PSOTYPE
"RTN","PSORLST",12,0)
 ;
"RTN","PSORLST",13,0)
 ; - Division/Site selection
"RTN","PSORLST",14,0)
 D DIVSEL(.PSOSDIV) I $G(PSOSDIV)="^" G EXIT
"RTN","PSORLST",15,0)
 I $G(PSOSDIV)="ALL" S PSODIV=0 F  S PSODIV=$O(^PS(59,PSODIV)) Q:'PSODIV  S PSOSDIV(PSODIV)=""
"RTN","PSORLST",16,0)
 ;
"RTN","PSORLST",17,0)
 ; Date range selection
"RTN","PSORLST",18,0)
 W ! S PSODTRNG=$$DTRNG("T-90","T") I PSODTRNG="^" G START
"RTN","PSORLST",19,0)
LKTP ; Type of Drug Lookup
"RTN","PSORLST",20,0)
 S PSOMED=$$MED() W ! I PSOMED<1 D EXIT W !! G START
"RTN","PSORLST",21,0)
 I PSOMED=1 D NDC(.PSONDC) I $D(PSONDC)<10 D EXIT G LKTP
"RTN","PSORLST",22,0)
 I PSOMED=2!(PSOMED=3) D DDRG(.PSODDRG,PSOMED) I ($D(PSODDRG)<10) D EXIT G LKTP
"RTN","PSORLST",23,0)
 I PSOMED=4 D GENERIC(.PSODDRG) I $D(PSODDRG)<10 D EXIT G LKTP
"RTN","PSORLST",24,0)
 I PSOMED=5 D ORDITEM(.PSODDRG) I $D(PSODDRG)<10 D EXIT G LKTP
"RTN","PSORLST",25,0)
 ; Exclude Deceased Patients?
"RTN","PSORLST",26,0)
 W ! S PSOXDED=$$EXCL() I PSOXDED="^" G START
"RTN","PSORLST",27,0)
 ;
"RTN","PSORLST",28,0)
 D MARGIN
"RTN","PSORLST",29,0)
 W ! D DEV I $G(EXIT) D EXIT G START
"RTN","PSORLST",30,0)
 D EXCMSG I $G(DUOUT) D EXIT G START
"RTN","PSORLST",31,0)
 ;
"RTN","PSORLST",32,0)
QUE ; Entry point for queued report. Begin processing based on user's selection criteria.
"RTN","PSORLST",33,0)
 U IO
"RTN","PSORLST",34,0)
 D PROCESS^PSORLST2
"RTN","PSORLST",35,0)
 G START
"RTN","PSORLST",36,0)
 ;
"RTN","PSORLST",37,0)
EXIT ; Quit.
"RTN","PSORLST",38,0)
 Q
"RTN","PSORLST",39,0)
 ;
"RTN","PSORLST",40,0)
DTRNG(BGN,END) ; Date Range Selection
"RTN","PSORLST",41,0)
 ;Input: (o) BGN - Default Begin Date 
"RTN","PSORLST",42,0)
 ;       (o) END - Default End Date 
"RTN","PSORLST",43,0)
 N %DT,DTOUT,DUOUT,DTRNG,X,Y
"RTN","PSORLST",44,0)
 S DTRNG=""
"RTN","PSORLST",45,0)
 S %DT="AEST",%DT("A")="From Release Date: ",%DT("B")=$G(BGN) K:$G(BGN)="" %DT("B") D ^%DT
"RTN","PSORLST",46,0)
 I $G(DUOUT)!$G(DTOUT)!($G(Y)=-1) Q "^"
"RTN","PSORLST",47,0)
 S $P(DTRNG,U)=Y
"RTN","PSORLST",48,0)
 W ! K %DT
"RTN","PSORLST",49,0)
 S %DT="AEST",%DT("A")="To Release Date: ",%DT("B")=$G(END),%DT(0)=Y K:$G(END)="" %DT("B") D ^%DT
"RTN","PSORLST",50,0)
 I $G(DUOUT)!$G(DTOUT)!($G(Y)=-1) Q "^"
"RTN","PSORLST",51,0)
 S $P(DTRNG,U,2)=Y
"RTN","PSORLST",52,0)
 Q DTRNG
"RTN","PSORLST",53,0)
 ;
"RTN","PSORLST",54,0)
EXCL() ; Exclude Deceased Patients
"RTN","PSORLST",55,0)
 ; Input: (o) EXCLUDE - "Y"es or "N"o
"RTN","PSORLST",56,0)
 K DIR,X,Y S DIR("A")="Exclude Deceased Patients"
"RTN","PSORLST",57,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR
"RTN","PSORLST",58,0)
 Q Y
"RTN","PSORLST",59,0)
 ;
"RTN","PSORLST",60,0)
MED() ; Select Medication(s)
"RTN","PSORLST",61,0)
 ; Medication Selection (NDC/Dispense Drug/Generic Drug)
"RTN","PSORLST",62,0)
 K DIR,Y,X
"RTN","PSORLST",63,0)
 S DIR(0)="S^1:NDC;2:DISPENSE DRUG AND LOT NUMBER;3:DISPENSE DRUG;4:VA GENERIC NAME;5:ORDERABLE ITEM"
"RTN","PSORLST",64,0)
 S DIR("A")="Select 1-5 ",DIR("?")="Choose a drug selection method."
"RTN","PSORLST",65,0)
 D ^DIR
"RTN","PSORLST",66,0)
 Q Y
"RTN","PSORLST",67,0)
 ;
"RTN","PSORLST",68,0)
NDC(NDC) ; Select NDC
"RTN","PSORLST",69,0)
 K NDC
"RTN","PSORLST",70,0)
 F  Q:Y<1  D
"RTN","PSORLST",71,0)
 .K DIR,X,Y
"RTN","PSORLST",72,0)
 .S DIR("A")="NDC"
"RTN","PSORLST",73,0)
 .S DIR(0)="FO^5:13"
"RTN","PSORLST",74,0)
 .S DIR("?")="Answer must be from 5 to 20 characters, in correct NDC format ( e.g., 4-4-2, 5-3-2, 5-4-1, 5-4-2, or 6-4-2)"
"RTN","PSORLST",75,0)
 .D ^DIR
"RTN","PSORLST",76,0)
 .I Y'="",$TR($TR(Y,"-","")," ","")="" W !,DIR("?") S Y=1 Q
"RTN","PSORLST",77,0)
 .I Y>0 S NDC($TR($TR(Y,"-","")," ",""))=1
"RTN","PSORLST",78,0)
 I '$D(NDC) W !!," *** NO NDC SELECTED ***"
"RTN","PSORLST",79,0)
 Q
"RTN","PSORLST",80,0)
 ;
"RTN","PSORLST",81,0)
DDRG(PSODDRG,LOTSEL) ; Select Dispense Drug
"RTN","PSORLST",82,0)
 K DIC
"RTN","PSORLST",83,0)
 S DIC=50,DIC(0)="QVAEZ",DIC("A")="Dispense Drug: "
"RTN","PSORLST",84,0)
 S DIC("S")="I $S($G(^(""I"")):0,1:1)"
"RTN","PSORLST",85,0)
 F  Q:(Y<1)!$G(EXIT)  K X,Y D ^DIC I Y>0 S PSODDRG(+Y)=$P(Y,"^",2) I LOTSEL=2 D LOT(+Y,.PSODDRG,Y(0,0))
"RTN","PSORLST",86,0)
 I '$D(PSODDRG) W !!," *** NO MEDICATION SELECTED ***"
"RTN","PSORLST",87,0)
 Q
"RTN","PSORLST",88,0)
 ;
"RTN","PSORLST",89,0)
LOT(DRGNO,DRGARR,DRGNAM) ; Enter Lot Number(s)
"RTN","PSORLST",90,0)
 N X,Y,LOT,EXIT,PSOLOTAR
"RTN","PSORLST",91,0)
 F  Q:$G(EXIT)  D
"RTN","PSORLST",92,0)
 .K DIR,Y,X
"RTN","PSORLST",93,0)
 .S DIR("A")="Lot # ",DIR(0)="FO^2:20"
"RTN","PSORLST",94,0)
 .D ^DIR S:$G(DUOUT) EXIT=1 W !
"RTN","PSORLST",95,0)
 .I $L(Y)>1 S PSOLOTAR(Y)="",DRGARR(DRGNO,Y)="" Q
"RTN","PSORLST",96,0)
 .I Y="",$D(PSOLOTAR)>1 S EXIT=1
"RTN","PSORLST",97,0)
 .Q:$D(PSOLOTAR)>1
"RTN","PSORLST",98,0)
 .I '$G(EXIT),Y="" W !?5,"At least one Lot # must be entered" Q
"RTN","PSORLST",99,0)
 I $G(EXIT),'$D(PSOLOTAR) K DRGARR(DRGNO),PSOLOTAR W !?27,"* No LOT # was entered *" D
"RTN","PSORLST",100,0)
 .W !?((80-$L(DRGNAM))/2),DRGNAM,!?22,"will not be included on the report",!!
"RTN","PSORLST",101,0)
 Q
"RTN","PSORLST",102,0)
 ;
"RTN","PSORLST",103,0)
GENERIC(PSODDRG) ; Select drug by VA GENERIC (file 50.6)
"RTN","PSORLST",104,0)
 N GENUM,GENAM,DDRGLI,INACTDT,DDRGLIA
"RTN","PSORLST",105,0)
 S INACTDT=$$FMADD^XLFDT(DT,-1)
"RTN","PSORLST",106,0)
GLOOP ; Prompt loop
"RTN","PSORLST",107,0)
 S DIC="^PSNDF(50.6,",DIC(0)="QMEAZ",DIC("A")="VA Generic Name: "
"RTN","PSORLST",108,0)
 F  Q:($G(GENUM)<0)  K X,Y D ^DIC S GENUM=+Y I GENUM>0 S GENUM=+Y,GENAM=$P(Y,"^",2) D
"RTN","PSORLST",109,0)
 .K ^TMP($J,"PSORLDN"),^TMP($J,"PSORLGN")
"RTN","PSORLST",110,0)
 .D AND^PSS50(GENUM,INACTDT,,"PSORLGN")
"RTN","PSORLST",111,0)
 .S DDRGLI=0 F  S DDRGLI=$O(^TMP($J,"PSORLGN",DDRGLI)) Q:'DDRGLI  D
"RTN","PSORLST",112,0)
 ..D DATA^PSS50(DDRGLI,,INACTDT,,,"PSORLDN")
"RTN","PSORLST",113,0)
 ..S DDRGLIA(DDRGLI)=$G(^TMP($J,"PSORLDN",DDRGLI,.01)) K ^TMP($J,"PSORLDN",DDRGLI)
"RTN","PSORLST",114,0)
 .I $D(DDRGLIA)>1 D DDSEL(.DDRGLIA,.PSODDRG)
"RTN","PSORLST",115,0)
 I '$D(PSODDRG) W !!," *** NO MEDICATION SELECTED ***"
"RTN","PSORLST",116,0)
 Q
"RTN","PSORLST",117,0)
 ;
"RTN","PSORLST",118,0)
ORDITEM(PSODDRG) ; Select drug by ORDERABLE ITEM (file 50.7)
"RTN","PSORLST",119,0)
 N OINUM,OINAM,OIDRGLI,INACTDT,OINUM,OIDRGLIA
"RTN","PSORLST",120,0)
 S INACTDT=$$FMADD^XLFDT(DT,-1)
"RTN","PSORLST",121,0)
OLOOP ; Prompt loop 
"RTN","PSORLST",122,0)
 S DIC="50.7",DIC(0)="QMEAZ",DIC("A")="Orderable Item: ",DIC("S")="I $S($P($G(^(0)),""^"",4):0,1:1)"
"RTN","PSORLST",123,0)
 F  Q:($G(OINUM)<0)  K X,Y D ^DIC S OINUM=+Y I OINUM>0 S OINAM=$P(Y,"^",2) D
"RTN","PSORLST",124,0)
 .K ^TMP($J,"PSORLDN"),^TMP($J,"PSORLDOI")
"RTN","PSORLST",125,0)
 .D DRGIEN^PSS50P7(OINUM,INACTDT,"PSORLOI")
"RTN","PSORLST",126,0)
 .S OIDRGLI=0 F  S OIDRGLI=$O(^TMP($J,"PSORLOI",OIDRGLI)) Q:'OIDRGLI  D
"RTN","PSORLST",127,0)
 ..D DATA^PSS50(OIDRGLI,,INACTDT,,,"PSORLDN")
"RTN","PSORLST",128,0)
 ..S DDRGLIA(OIDRGLI)=$G(^TMP($J,"PSORLDN",OIDRGLI,.01)) K ^TMP($J,"PSORLDN",OIDRGLI)
"RTN","PSORLST",129,0)
 .I $D(DDRGLIA)>1 D DDSEL(.DDRGLIA,.PSODDRG)
"RTN","PSORLST",130,0)
 I '$D(PSODDRG) W !!," *** NO MEDICATION SELECTED ***"
"RTN","PSORLST",131,0)
 Q
"RTN","PSORLST",132,0)
 ;
"RTN","PSORLST",133,0)
DDSEL(DDIN,DDOUT) ; Display selectable dispense drugs (DDIN), prompt for selection, save selected dispense drugs in DDOUT
"RTN","PSORLST",134,0)
 K DIR
"RTN","PSORLST",135,0)
 I $D(DDIN)<10 K DDIN Q
"RTN","PSORLST",136,0)
 W !!?2,"Dispense Drugs"
"RTN","PSORLST",137,0)
 W !?2,"---------------"
"RTN","PSORLST",138,0)
 S (II,DD)=0 F II=1:1 S DD=$O(DDIN(DD)) Q:'DD  W !?3,II," - ",DDIN(DD)
"RTN","PSORLST",139,0)
 W ! S II=II-1 S DIR(0)="L^1:"_II D ^DIR W !
"RTN","PSORLST",140,0)
 S (II,DD)=0 F II=1:1 S DD=$O(DDIN(DD)) Q:'DD  I (","_Y_",")[(","_II_",") S DDOUT(DD)=DDIN(DD)
"RTN","PSORLST",141,0)
 K DDIN
"RTN","PSORLST",142,0)
 Q
"RTN","PSORLST",143,0)
 ;
"RTN","PSORLST",144,0)
DEV ; Prompt user for output device
"RTN","PSORLST",145,0)
 K %ZIS,IOP,POP,ZTSK,EXIT S PSOION=$I,%ZIS="QM"
"RTN","PSORLST",146,0)
 D ^%ZIS K %ZIS
"RTN","PSORLST",147,0)
 I POP S IOP=PSOION D ^%ZIS K IOP,PSOION W !,"Please try later!" S EXIT=1
"RTN","PSORLST",148,0)
 S X=0 X ^%ZOSF("RM")
"RTN","PSORLST",149,0)
 K PSOION I $D(IO("Q")) D  S EXIT=1 Q
"RTN","PSORLST",150,0)
 .S ZTDESC="List of Patient for Recall Notice",ZTRTN="QUE^PSORLST"
"RTN","PSORLST",151,0)
 .F G="PSODTRNG","PSOXDED","PSOMED","PSODIV","PSODJ","PSONDC(","PSODDRG(","PSOSDIV(" S ZTSAVE(G)=""
"RTN","PSORLST",152,0)
 .K IO("Q") D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print!" K ZTSK
"RTN","PSORLST",153,0)
 Q
"RTN","PSORLST",154,0)
 ;
"RTN","PSORLST",155,0)
DIVSEL(ARRAY) ; - Division selection (one, multiple or ALL)
"RTN","PSORLST",156,0)
 N DIC,DTOUT,DUOUT,QT,Y,X
"RTN","PSORLST",157,0)
 W !!,"You may select a single or multiple Divisions,"
"RTN","PSORLST",158,0)
 W !,"or enter ^ALL to select all Divisions.",!
"RTN","PSORLST",159,0)
 I '$G(DT) N DT S DT=$$NOW^XLFDT()
"RTN","PSORLST",160,0)
 S DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSORLST",161,0)
 K ARRAY S DIC="^PS(59,",DIC(0)="QEZAM",DIC("A")="Division: "
"RTN","PSORLST",162,0)
 F  D ^DIC Q:X=""  D  Q:$G(QT)
"RTN","PSORLST",163,0)
 .I $$UP^XLFSTR(X)="^ALL" K ARRAY S ARRAY="ALL",QT=1 Q
"RTN","PSORLST",164,0)
 .I $D(DTOUT)!$D(DUOUT) K ARRAY S ARRAY="^",QT=1 Q
"RTN","PSORLST",165,0)
 .W "   ",$P(Y,"^",2),$S($D(ARRAY(+Y)):"       (already selected)",1:"")
"RTN","PSORLST",166,0)
 .W ! S ARRAY(+Y)="",DIC("A")="ANOTHER ONE: " K DIC("B")
"RTN","PSORLST",167,0)
 I '$D(ARRAY) S ARRAY="^"
"RTN","PSORLST",168,0)
 Q
"RTN","PSORLST",169,0)
 ;
"RTN","PSORLST",170,0)
EXCMSG ;Display the message about capturing to an Excel file format
"RTN","PSORLST",171,0)
 K DUOUT
"RTN","PSORLST",172,0)
 Q:$E($G(IOST))'="C"
"RTN","PSORLST",173,0)
 W !!?5,"Before continuing, please set up your terminal to capture the"
"RTN","PSORLST",174,0)
 W !?5,"detailed report data. On some terminals, this can be done by"
"RTN","PSORLST",175,0)
 W !?5,"clicking on the 'Tools' menu above, then click on 'Capture"
"RTN","PSORLST",176,0)
 W !?5,"Incoming Data' to save to Desktop."
"RTN","PSORLST",177,0)
 W !
"RTN","PSORLST",178,0)
 W !?5,"     *** THIS REPORT MAY TAKE AWHILE TO RUN ***",!!
"RTN","PSORLST",179,0)
 N DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSORLST",180,0)
 W !
"RTN","PSORLST",181,0)
 Q
"RTN","PSORLST",182,0)
 ;
"RTN","PSORLST",183,0)
MARGIN   ; Display message about margin and page length
"RTN","PSORLST",184,0)
 I $G(PSODWFL) D
"RTN","PSORLST",185,0)
 . W !!!?8,"** Users unfamiliar with sort templates should review **"
"RTN","PSORLST",186,0)
 . W !?8,"**   sort template documentation before continuing.   **"
"RTN","PSORLST",187,0)
 . K PSODFWL
"RTN","PSORLST",188,0)
 W !!
"RTN","PSORLST",189,0)
 W !?8,"**  To avoid undesired wrapping of the output data,    **"
"RTN","PSORLST",190,0)
 W !?8,"**  please enter '0;512;999' at the 'DEVICE:' prompt.  **" ;371 change from 256 to 512.
"RTN","PSORLST",191,0)
 W !?8,"**  You may need to set your Terminal Session Display  **" ;371 Add the next two lines.
"RTN","PSORLST",192,0)
 W !?8,"**            Settings to 512 columns.                 **"
"RTN","PSORLST",193,0)
 W !
"RTN","PSORLST",194,0)
 Q
"RTN","PSORLST",195,0)
 ;
"RTN","PSORLST",196,0)
PSODED(RXIEN) ;
"RTN","PSORLST",197,0)
 N PSODED
"RTN","PSORLST",198,0)
 S PSODED=""
"RTN","PSORLST",199,0)
 I $G(DFN) S PSODED=$S($G(^DPT(+$P(^PSRX(RXIEN,0),"^",2),.35)):"Y",1:"N")
"RTN","PSORLST",200,0)
 Q PSODED
"RTN","PSORLST2")
0^2^B70157701^B68475218
"RTN","PSORLST2",1,0)
PSORLST2 ;BIRM/MFR - List of Patients/Prescriptions for Recall Notice ;12/30/09
"RTN","PSORLST2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**348,371**;DEC 1997;Build 12
"RTN","PSORLST2",3,0)
 ;
"RTN","PSORLST2",4,0)
 ; Report Output fields ("^" separated):
"RTN","PSORLST2",5,0)
 ; ------------------------------------
"RTN","PSORLST2",6,0)
 ;    1. FILL TYPE (e.g.,\\ORIGINAL\)    2. RX #
"RTN","PSORLST2",7,0)
 ;    3. DRUG NAME                       4. PATIENT NAME
"RTN","PSORLST2",8,0)
 ;    5. SSN                             6. ADDRESS 1
"RTN","PSORLST2",9,0)
 ;    7. ADDRESS 2                       8. ADDRESS 3
"RTN","PSORLST2",10,0)
 ;    9. CITY                           10. STATE
"RTN","PSORLST2",11,0)
 ;   11. ZIP                            12. PHONE (HOME)
"RTN","PSORLST2",12,0)
 ;   13. PHONE (WORK)                   14. PHONE (CELL)
"RTN","PSORLST2",13,0)
 ;   15. DECEASED?                      16. FILL #
"RTN","PSORLST2",14,0)
 ;   17. ISSUE DATE                     18. FILL DATE
"RTN","PSORLST2",15,0)
 ;   19. RELEASED DATE/TIME             20. EXPIRATION DATE
"RTN","PSORLST2",16,0)
 ;   21. LOT #                          22. NDC
"RTN","PSORLST2",17,0)
 ;   23. DIVISION                       24. PHARMACIST
"RTN","PSORLST2",18,0)
 ;   25. PROVIDER                       26. PATIENT STATUS
"RTN","PSORLST2",19,0)
 ;   27. QTY                            28. DAYS SUPPLY
"RTN","PSORLST2",20,0)
 ;   29. # OF REFILLS                   30. MAIL/WINDOW
"RTN","PSORLST2",21,0)
 ;   31. CMOP?                          32. PARTIAL REMARKS
"RTN","PSORLST2",22,0)
 ;   33. TRANSMISSION NUMBER            34. SEQUENCE #
"RTN","PSORLST2",23,0)
 ;   35. CMOP NDC                       36. DATE SHIPPED
"RTN","PSORLST2",24,0)
 ;   37. CARRIER                        38. PACKAGE ID
"RTN","PSORLST2",25,0)
 ;   39. /*EOR*/   Added with PSO*7*371
"RTN","PSORLST2",26,0)
 ;   
"RTN","PSORLST2",27,0)
PROCESS ; Use input search criteria to find matching orders, store in TMP global.
"RTN","PSORLST2",28,0)
 N PSOFRMDT,PSOTODT,PSORX,PSOFILL,PSORDT,RXND0,RXND2,PSOPAT,REFILLS
"RTN","PSORLST2",29,0)
 N PSORXDRG,NDC,LOT,PSODEAD,PTSTAT,OUTPUT,ISSDT,EXPDT,RX,FILL,PAT
"RTN","PSORLST2",30,0)
 ;
"RTN","PSORLST2",31,0)
 ; - Search Originals and Refills
"RTN","PSORLST2",32,0)
 K ^TMP(+$J,"PSORLST")
"RTN","PSORLST2",33,0)
 S PSOFRMDT=$P(PSODTRNG,"^"),PSOTODT=$P(PSODTRNG,"^",2)
"RTN","PSORLST2",34,0)
 S PSORDT=$$FMADD^XLFDT(PSOFRMDT,,,,-1)
"RTN","PSORLST2",35,0)
 F  S PSORDT=$O(^PSRX("AL",PSORDT)) Q:((PSORDT="")!(PSORDT>(PSOTODT_".24")))  D
"RTN","PSORLST2",36,0)
 . S PSORX=0
"RTN","PSORLST2",37,0)
 . F  S PSORX=$O(^PSRX("AL",PSORDT,PSORX)) Q:'PSORX  D
"RTN","PSORLST2",38,0)
 . . S RXND0=$G(^PSRX(PSORX,0)),RXND2=$G(^PSRX(PSORX,2))
"RTN","PSORLST2",39,0)
 . . S PSOPAT=$P(RXND0,"^",2) I 'PSOPAT Q
"RTN","PSORLST2",40,0)
 . . S PSODEAD=+$G(^DPT(+PSOPAT,.35)) I ($G(PSOXDED))&$G(PSODEAD) Q
"RTN","PSORLST2",41,0)
 . . S PSORXDRG=$P(RXND0,"^",6) I 'PSORXDRG Q
"RTN","PSORLST2",42,0)
 . . I PSOMED'=1,'$D(PSODDRG(+PSORXDRG)) Q
"RTN","PSORLST2",43,0)
 . . S PSOFILL=""
"RTN","PSORLST2",44,0)
 . . F  S PSOFILL=$O(^PSRX("AL",PSORDT,PSORX,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSORLST2",45,0)
 . . . I '$$RXRLDT^PSOBPSUT(PSORX,PSOFILL) Q
"RTN","PSORLST2",46,0)
 . . . I '$D(PSOSDIV(+$$RXSITE^PSOBPSUT(PSORX,PSOFILL))) Q
"RTN","PSORLST2",47,0)
 . . . I PSOMED=1 S NDC=$$RAWNDC($$GETNDC^PSONDCUT(PSORX,PSOFILL)) Q:NDC=""  Q:'$D(PSONDC(NDC))
"RTN","PSORLST2",48,0)
 . . . I PSOMED=2 S LOT=$$LOT(PSORX,PSOFILL) Q:LOT=""  Q:'$D(PSODDRG(+PSORXDRG,LOT))
"RTN","PSORLST2",49,0)
 . . . S ^TMP($J,"PSORLST",$$GET1^DIQ(2,PSOPAT,.01),PSORX,PSOFILL)=""
"RTN","PSORLST2",50,0)
 ;
"RTN","PSORLST2",51,0)
 ; - Search Partials
"RTN","PSORLST2",52,0)
 S PSORDT=$$FMADD^XLFDT(PSOFRMDT,,,,-1)
"RTN","PSORLST2",53,0)
 F  S PSORDT=$O(^PSRX("AM",PSORDT)) Q:((PSORDT="")!(PSORDT>(PSOTODT_".24")))  D
"RTN","PSORLST2",54,0)
 . S PSORX=0
"RTN","PSORLST2",55,0)
 . F  S PSORX=$O(^PSRX("AM",PSORDT,PSORX)) Q:'PSORX  D
"RTN","PSORLST2",56,0)
 . . S RXND0=$G(^PSRX(PSORX,0)),RXND2=$G(^PSRX(PSORX,2))
"RTN","PSORLST2",57,0)
 . . S PSOPAT=$P(RXND0,"^",2) I 'PSOPAT Q
"RTN","PSORLST2",58,0)
 . . S PSODEAD=+$G(^DPT(+PSOPAT,.35)) I ($G(PSOXDED))&$G(PSODEAD) Q
"RTN","PSORLST2",59,0)
 . . S PSORXDRG=$P(RXND0,"^",6) I 'PSORXDRG Q
"RTN","PSORLST2",60,0)
 . . I PSOMED'=1,'$D(PSODDRG(+PSORXDRG)) Q
"RTN","PSORLST2",61,0)
 . . S PSOFILL=0
"RTN","PSORLST2",62,0)
 . . F  S PSOFILL=$O(^PSRX("AM",PSORDT,PSORX,PSOFILL)) Q:'PSOFILL  D
"RTN","PSORLST2",63,0)
 . . . I '$D(PSOSDIV(+$$GET1^DIQ(52.2,(+PSOFILL)_","_PSORX,.09,"I"))) Q
"RTN","PSORLST2",64,0)
 . . . I PSOMED=1 S NDC=$$RAWNDC($$GET1^DIQ(52.2,(+PSOFILL)_","_PSORX,1)) S:NDC="" NDC=$$RAWNDC($P(RXND2,"^",7)) Q:NDC=""  Q:'$D(PSONDC(NDC))
"RTN","PSORLST2",65,0)
 . . . I PSOMED=2 S LOT=$$LOT(PSORX,PSOFILL_"P") Q:LOT=""  Q:'$D(PSODDRG(+PSORXDRG,LOT))
"RTN","PSORLST2",66,0)
 . . . S ^TMP($J,"PSORLST",$$GET1^DIQ(2,PSOPAT,.01),PSORX,PSOFILL_"P")=""
"RTN","PSORLST2",67,0)
 ;
"RTN","PSORLST2",68,0)
 I $D(^TMP($J,"PSORLST")) D
"RTN","PSORLST2",69,0)
 . W !,"\\FILL TYPE\^RX #^DRUG NAME^PATIENT NAME^SSN^ADDRESS 1^ADDRESS 2^ADDRESS 3^"
"RTN","PSORLST2",70,0)
 . W "CITY^STATE^ZIP^PHONE (HOME)^PHONE (WORK)^PHONE (CELL)^DECEASED?^FILL #^ISSUE DATE^"
"RTN","PSORLST2",71,0)
 . W "FILL DATE^RELEASED DATE/TIME^EXPIRATION DATE^LOT #^NDC^DIVISION^PHARMACIST^PROVIDER^"
"RTN","PSORLST2",72,0)
 . W "PATIENT STATUS^QTY^DAYS SUPPLY^# OF REFILLS^MAIL/WINDOW^CMOP?^PARTIAL REMARKS^"
"RTN","PSORLST2",73,0)
 . W "TRANSMISSION NUMBER^SEQUENCE #^CMOP NDC^DATE SHIPPED^CARRIER^PACKAGE ID^/*EOR*/" ;371 Add End of Row indicator
"RTN","PSORLST2",74,0)
 . S (PAT,RX,FILL,OUTPUT)=""
"RTN","PSORLST2",75,0)
 . F  S PAT=$O(^TMP($J,"PSORLST",PAT)) Q:PAT=""  D
"RTN","PSORLST2",76,0)
 . . F  S RX=$O(^TMP($J,"PSORLST",PAT,RX)) Q:RX=""  D
"RTN","PSORLST2",77,0)
 . . . S RXND0=$G(^PSRX(RX,0)),RXND2=$G(^PSRX(RX,2))
"RTN","PSORLST2",78,0)
 . . . S ISSDT=$P(RXND0,"^",13) I ISSDT S ISSDT=$TR($$FMTE^XLFDT(ISSDT,2),"@"," ")
"RTN","PSORLST2",79,0)
 . . . S EXPDT=$P(RXND2,"^",6) I EXPDT S EXPDT=$TR($$FMTE^XLFDT(EXPDT,2),"@"," ")
"RTN","PSORLST2",80,0)
 . . . S PTSTAT=$P(RXND0,"^",3),PTSTAT=$P(^PS(53,+PTSTAT,0),"^")
"RTN","PSORLST2",81,0)
 . . . S REFILLS=$P(RXND0,"^",9)
"RTN","PSORLST2",82,0)
 . . . F  S FILL=$O(^TMP($J,"PSORLST",PAT,RX,FILL)) Q:FILL=""  D
"RTN","PSORLST2",83,0)
 . . . . I FILL=0 D
"RTN","PSORLST2",84,0)
 . . . . . S OUTPUT="\\ORIGINAL\^"_$$PATIENT(RXND0,RXND2)_"^"_$$ORIGINAL(RXND0,RXND2)_"^"_$$CMOP(RX,0)
"RTN","PSORLST2",85,0)
 . . . . E  I FILL'["P" D
"RTN","PSORLST2",86,0)
 . . . . . S OUTPUT="\\REFILL\^"_$$PATIENT(RXND0,RXND2)_"^"_$$REFILL(RX,FILL,RXND0,RXND2)_"^"_$$CMOP(RX,FILL)
"RTN","PSORLST2",87,0)
 . . . . E  D
"RTN","PSORLST2",88,0)
 . . . . . S OUTPUT="\\PARTIAL\^"_$$PATIENT(RXND0,RXND2)_"^"_$$PARTIAL(RX,+FILL,RXND0,RXND2)_"^^^^^^^"_"/*EOR*/"  ;371
"RTN","PSORLST2",89,0)
 . . . . S $P(OUTPUT,"^",17)=ISSDT
"RTN","PSORLST2",90,0)
 . . . . S $P(OUTPUT,"^",20)=EXPDT
"RTN","PSORLST2",91,0)
 . . . . S $P(OUTPUT,"^",26)=PTSTAT
"RTN","PSORLST2",92,0)
 . . . . S $P(OUTPUT,"^",29)=REFILLS
"RTN","PSORLST2",93,0)
 . . . . S $P(OUTPUT,"^",31)=$S($P(OUTPUT,"^",33)'="":"Y",1:"N")
"RTN","PSORLST2",94,0)
 . . . . W !,OUTPUT
"RTN","PSORLST2",95,0)
 E  D
"RTN","PSORLST2",96,0)
 . W !!!?15,"*** NO RECORDS TO PRINT ***",!!!!
"RTN","PSORLST2",97,0)
 ;
"RTN","PSORLST2",98,0)
 K ^TMP($J,"PSORLST") D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSORLST2",99,0)
 Q
"RTN","PSORLST2",100,0)
 ;
"RTN","PSORLST2",101,0)
PATIENT(RXND0,RXND2) ; Build patient information (HEADER), store in ^TMP
"RTN","PSORLST2",102,0)
 ; RXND0 - Prescription File (#52) zero node (^PSRX(RX,0))
"RTN","PSORLST2",103,0)
 ; RXND2 - Prescription File (#52) two node (^PSRX(RX,2))
"RTN","PSORLST2",104,0)
 ; Ouptput: RX #^DRUG NAME^PATIENT NAME^SSN^ADDRESS 1^ADDRESS 2^ADDRESS 3^CITY^STATE^ZIP^
"RTN","PSORLST2",105,0)
 ;          PHONE (HOME)^PHONE (WORK)^PHONE (CELL)^DECEASED?
"RTN","PSORLST2",106,0)
 ;
"RTN","PSORLST2",107,0)
 N PATIENT,DFN,VADM,VAPA,DEAD,PHONES,RESID,WORK,CELL
"RTN","PSORLST2",108,0)
 ;
"RTN","PSORLST2",109,0)
 S DFN=$P(RXND0,"^",2) D DEM^VADPT,ADD^VADPT
"RTN","PSORLST2",110,0)
 S DEAD=+$G(^DPT(+DFN,.35)),DEAD=$S(DEAD:"Y",1:"N")
"RTN","PSORLST2",111,0)
 S PATIENT=$P(RXND0,"^")_"^"_$$GET1^DIQ(50,+$P(RXND0,"^",6),.01)_"^"_VADM(1)_"^"_$P(VADM(2),"^",2)
"RTN","PSORLST2",112,0)
 S PATIENT=PATIENT_"^"_VAPA(1)_"^"_VAPA(2)_"^"_VAPA(3)_"^"_VAPA(4)_"^"_$P(VAPA(5),"^",2)_"^"_VAPA(6)
"RTN","PSORLST2",113,0)
 S PHONES=$G(^DPT(+DFN,.13)),RESID=$P(PHONES,"^"),WORK=$P(PHONES,"^",2),CELL=$P(PHONES,"^",4)
"RTN","PSORLST2",114,0)
 S PATIENT=PATIENT_"^"_RESID_"^"_WORK_"^"_CELL_"^"_DEAD
"RTN","PSORLST2",115,0)
 Q PATIENT
"RTN","PSORLST2",116,0)
 Q
"RTN","PSORLST2",117,0)
 ;
"RTN","PSORLST2",118,0)
ORIGINAL(RXND0,RXND2) ; Build output for specific original RX, store in ^TMP
"RTN","PSORLST2",119,0)
 ; RXND0 - Prescription File (#52) zero node (^PSRX(RX,0))
"RTN","PSORLST2",120,0)
 ; RXND2 - Prescription File (#52) two node (^PSRX(RX,2))
"RTN","PSORLST2",121,0)
 ; Output: 0(Original)^ISSUE DATE^FILL DATE^RELEASED DATE/TIME^^LOT #^NDC^DIVISION (###)^
"RTN","PSORLST2",122,0)
 ;         PHARMACIST^PROVIDER^^QTY^DAYS SUPPLY^# OF REFILLS^MAIL/WINDOW^^
"RTN","PSORLST2",123,0)
 ;
"RTN","PSORLST2",124,0)
 N ORIGINAL,FILLDT,RELDT,LOT,NDC,DIV,DIVNAM,DIVNUM,PHARM,PROV,MW,QTY,DAYS,Z
"RTN","PSORLST2",125,0)
 ;
"RTN","PSORLST2",126,0)
 S FILLDT=$P(RXND2,"^",2) I FILLDT S FILLDT=$TR($$FMTE^XLFDT(FILLDT,2),"@"," ")
"RTN","PSORLST2",127,0)
 S RELDT=$P(RXND2,"^",13) I RELDT S RELDT=$TR($$FMTE^XLFDT(RELDT,2),"@"," ")
"RTN","PSORLST2",128,0)
 S LOT=$P(RXND2,"^",4)
"RTN","PSORLST2",129,0)
 S NDC=$P(RXND2,"^",7)
"RTN","PSORLST2",130,0)
 S DIVNAM="",DIV=$P(RXND2,"^",9)
"RTN","PSORLST2",131,0)
 S (DIVNAM,DIVNUM)="" I DIV S Z=$G(^PS(59,+DIV,0)),DIVNAM=$P(Z,"^"),DIVNUM=$P(Z,"^",6)
"RTN","PSORLST2",132,0)
 S PHARM=$P($G(^VA(200,+$P(RXND2,"^",3),0)),"^")
"RTN","PSORLST2",133,0)
 S PROV=$P($G(^VA(200,+$P(RXND0,"^",4),0)),"^")
"RTN","PSORLST2",134,0)
 S QTY=$P(RXND0,"^",7),DAYS=$P(RXND0,"^",8)
"RTN","PSORLST2",135,0)
 S MW=$S($P(RXND0,"^",11)="W":"WINDOW",1:"MAIL")
"RTN","PSORLST2",136,0)
 S ORIGINAL="0^^"_FILLDT_"^"_RELDT_"^^"_LOT_"^"_NDC_"^"_DIVNAM_" ("_DIVNUM_")"
"RTN","PSORLST2",137,0)
 S ORIGINAL=ORIGINAL_"^"_PHARM_"^"_PROV_"^^"_QTY_"^"_DAYS_"^^"_MW_"^^"
"RTN","PSORLST2",138,0)
 Q ORIGINAL
"RTN","PSORLST2",139,0)
 ;
"RTN","PSORLST2",140,0)
REFILL(RX,REF,RXND0,RXND2) ; Build output for specific Refill, store in ^TMP
"RTN","PSORLST2",141,0)
 ; REF - Refill Number
"RTN","PSORLST2",142,0)
 ; RXND0 - Prescription File (#52) zero node (^PSRX(RX,0))
"RTN","PSORLST2",143,0)
 ; RXND2 - Prescription File (#52) two node (^PSRX(RX,2))
"RTN","PSORLST2",144,0)
 ; Output: FILL #^ISSUE DATE^FILL DATE^RELEASED DATE/TIME^^LOT #^NDC^DIVISION(###)^
"RTN","PSORLST2",145,0)
 ;         PHARMACIST^PROVIDER^^QTY^DAYS SUPPLY^# OF REFILLS^MAIL/WINDOW^^
"RTN","PSORLST2",146,0)
 ;
"RTN","PSORLST2",147,0)
 N REFILL,RF0,RF1,RFILDT,RLSDT,QTY,DAYS,LOT,NDC,DIV,DIVNAM,DIVNUM,PROV,PHARM,MW,Z
"RTN","PSORLST2",148,0)
 ;
"RTN","PSORLST2",149,0)
 S RF0=$G(^PSRX(RX,1,REF,0))
"RTN","PSORLST2",150,0)
 S RF1=$G(^PSRX(RX,1,REF,1))
"RTN","PSORLST2",151,0)
 S RFILDT=$P(RF0,"^") I RFILDT S RFILDT=$TR($$FMTE^XLFDT(RFILDT,2),"@"," ")
"RTN","PSORLST2",152,0)
 S RLSDT=$P(RF0,"^",18) I RLSDT S RLSDT=$TR($$FMTE^XLFDT(RLSDT,2),"@"," ")
"RTN","PSORLST2",153,0)
 S LOT=$$LOT(RX,REF)
"RTN","PSORLST2",154,0)
 S QTY=$P(RF0,"^",4)
"RTN","PSORLST2",155,0)
 S DAYS=$P(RF0,"^",10)
"RTN","PSORLST2",156,0)
 S NDC=$$GETNDC^PSONDCUT(RX,REF)
"RTN","PSORLST2",157,0)
 S DIV=$P(RF0,"^",9) S:'DIV DIV=$P(RXND2,"^",9)
"RTN","PSORLST2",158,0)
 S (DIVNAM,DIVNUM)="" I DIV S Z=$G(^PS(59,+DIV,0)),DIVNAM=$P(Z,"^"),DIVNUM=$P(Z,"^",6)
"RTN","PSORLST2",159,0)
 S PHARM=$P(RF0,"^",5) S:'PHARM PHARM=$P(RXND2,"^",3) S PHARM=$P($G(^VA(200,+PHARM,0)),"^")
"RTN","PSORLST2",160,0)
 S PROV=$P(RF0,"^",17) S:'PROV PROV=$P(RXND0,"^",4) S PROV=$P($G(^VA(200,+PROV,0)),"^")
"RTN","PSORLST2",161,0)
 S MW=$S($P(RF0,"^",2)="W":"WINDOW",1:"MAIL")
"RTN","PSORLST2",162,0)
 S REFILL=REF_"^^"_RFILDT_"^"_RLSDT_"^^"_LOT_"^"_NDC_"^"_DIVNAM_" ("_DIVNUM_")"
"RTN","PSORLST2",163,0)
 S REFILL=REFILL_"^"_PHARM_"^"_PROV_"^^"_QTY_"^"_DAYS_"^^"_MW_"^^"
"RTN","PSORLST2",164,0)
 Q REFILL
"RTN","PSORLST2",165,0)
 ;
"RTN","PSORLST2",166,0)
PARTIAL(RX,PAR,RXND0,RXND2) ; Build output for specific partial fill, store in ^TMP
"RTN","PSORLST2",167,0)
 ; SEQ - Integer representing a specific Partial node from the Prescription file (#52)
"RTN","PSORLST2",168,0)
 ; RXND0 - Prescription File (#52) zero node (^PSRX(RX,0))
"RTN","PSORLST2",169,0)
 ; RXND2 - Prescription File (#52) two node (^PSRX(RX,2))
"RTN","PSORLST2",170,0)
 ; Output: FILL #^ISSUE DATE^FILL DATE^RELEASED DATE/TIME^^LOT #^NDC^DIVISION(###)^
"RTN","PSORLST2",171,0)
 ;         PHARMACIST^PROVIDER^^QTY^DAYS SUPPLY^# OF REFILLS^MAIL/WINDOW^CMOP?^REMARKS
"RTN","PSORLST2",172,0)
 ;
"RTN","PSORLST2",173,0)
 N PARTIAL,PT0,PARTDT,RLSDT,NDC,LOT,QTY,DAYS,DIV,DIVNUM,DIVNAM,PROV,PHARM,RMRKS,MW,RXNDP,Z
"RTN","PSORLST2",174,0)
 S PT0=$G(^PSRX(RX,"P",PAR,0))
"RTN","PSORLST2",175,0)
 S PARTDT=$P(PT0,"^") I PARTDT S PARTDT=$TR($$FMTE^XLFDT(PARTDT,2),"@"," ")
"RTN","PSORLST2",176,0)
 S RLSDT=$P(PT0,"^",19) IF RLSDT S RLSDT=$TR($$FMTE^XLFDT(RLSDT,2),"@"," ")
"RTN","PSORLST2",177,0)
 S LOT=$$LOT(RX,PAR_"P")
"RTN","PSORLST2",178,0)
 S NDC=$P(PT0,"^",12) S:NDC="" NDC=$$GETNDC^PSONDCUT(RX,0)
"RTN","PSORLST2",179,0)
 S QTY=$P(PT0,"^",4)
"RTN","PSORLST2",180,0)
 S DAYS=$P(PT0,"^",10)
"RTN","PSORLST2",181,0)
 S DIV=$P(PT0,"^",9) S:'DIV DIV=$P(RXND2,"^",9)
"RTN","PSORLST2",182,0)
 S (DIVNAM,DIVNUM)="" I DIV S Z=$G(^PS(59,+DIV,0)),DIVNAM=$P(Z,"^"),DIVNUM=$P(Z,"^",6)
"RTN","PSORLST2",183,0)
 S PHARM=$P(PT0,"^",5) S:'PHARM PHARM=$P(RXND2,"^",3) S PHARM=$P($G(^VA(200,+PHARM,0)),"^")
"RTN","PSORLST2",184,0)
 S PROV=$P(PT0,"^",17) S:'PROV PROV=$P(RXND0,"^",4) S PROV=$P($G(^VA(200,+PROV,0)),"^")
"RTN","PSORLST2",185,0)
 S MW=$S($P(PT0,"^",2)="W":"WINDOW",1:"MAIL")
"RTN","PSORLST2",186,0)
 S RMRKS=$P(PT0,"^",3)
"RTN","PSORLST2",187,0)
 S PARTIAL=PAR_"^^"_PARTDT_"^"_RLSDT_"^^"_LOT_"^"_NDC_"^"_DIVNAM_" ("_DIVNUM_")"
"RTN","PSORLST2",188,0)
 S PARTIAL=PARTIAL_"^"_PHARM_"^"_PROV_"^^"_QTY_"^"_DAYS_"^^"_MW_"^N^"_RMRKS
"RTN","PSORLST2",189,0)
 Q PARTIAL
"RTN","PSORLST2",190,0)
 ;
"RTN","PSORLST2",191,0)
CMOP(RX,FILL) ; Build output for CMOP fields
"RTN","PSORLST2",192,0)
 ; RX   - Prescription file (#52) IEN
"RTN","PSORLST2",193,0)
 ; FILL - Fill # (0 - Original, 1 - Refill #1, 2 - Refill #2, etc...)
"RTN","PSORLST2",194,0)
 ; Output: TRANSMISSION NUMBER^SEQUENCE #^CMOP NDC^DATE SHIPPED^CARRIER^PACKAGE ID
"RTN","PSORLST2",195,0)
 ;
"RTN","PSORLST2",196,0)
 N CMOP,CMOPSEQ,Z0,Z1
"RTN","PSORLST2",197,0)
 ;
"RTN","PSORLST2",198,0)
 S CMOP="^^^^^^/*EOR*/" ;371 Add End of Row indicator.
"RTN","PSORLST2",199,0)
 I '$D(^PSRX(RX,4)) Q CMOP
"RTN","PSORLST2",200,0)
 ;
"RTN","PSORLST2",201,0)
 S CMOPSEQ=0 F  S CMOPSEQ=$O(^PSRX(RX,4,CMOPSEQ)) Q:'CMOPSEQ  D
"RTN","PSORLST2",202,0)
 . S Z0=$G(^PSRX(RX,4,CMOPSEQ,0))
"RTN","PSORLST2",203,0)
 . I $P(Z0,"^",3)'=FILL!($P(Z0,"^",4)'=1) Q
"RTN","PSORLST2",204,0)
 . S CMOP=$P(Z0,"^",1)_"^"_$P(Z0,"^",2)_"^"_$P(Z0,"^",8)
"RTN","PSORLST2",205,0)
 . S Z1=$G(^PSRX(RX,4,CMOPSEQ,1))
"RTN","PSORLST2",206,0)
 . S CMOP=CMOP_"^"_$TR($$FMTE^XLFDT($P(Z1,"^",2),2),"@"," ")_"^"_$P(Z1,"^",3)_"^"_$P(Z1,"^",4)_"^"_"/*EOR*/"  ;371
"RTN","PSORLST2",207,0)
 ;
"RTN","PSORLST2",208,0)
 Q CMOP
"RTN","PSORLST2",209,0)
 ;
"RTN","PSORLST2",210,0)
LOT(RX,FILL) ; Returns the LOT# for a specific Fill
"RTN","PSORLST2",211,0)
 ; Input:  (r) RX   - Rx IEN (#52)
"RTN","PSORLST2",212,0)
 ;         (r) FILL - Refill #/Partial # (note: Partials contain a "P", e.g. "1P")
"RTN","PSORLST2",213,0)
 ; Output:     LOT  - Rx Drug Lot #
"RTN","PSORLST2",214,0)
 N LOT S LOT=""
"RTN","PSORLST2",215,0)
 I (FILL["P") D
"RTN","PSORLST2",216,0)
 . S LOT=$$GET1^DIQ(52.2,(+FILL)_","_RX,.06)
"RTN","PSORLST2",217,0)
 E  I (FILL>0) S LOT=$$GET1^DIQ(52.1,(+FILL)_","_RX,5)
"RTN","PSORLST2",218,0)
 I (FILL=0)!(LOT="") D
"RTN","PSORLST2",219,0)
 . S LOT=$$GET1^DIQ(52,RX,24)
"RTN","PSORLST2",220,0)
 ;
"RTN","PSORLST2",221,0)
 Q LOT
"RTN","PSORLST2",222,0)
RAWNDC(NDC) ; Returns NDC without dashes ('-') or spaces (' ')
"RTN","PSORLST2",223,0)
 Q $TR($TR(NDC,"-","")," ","")
"VER")
8.0^22.0
"BLD",7856,6)
^317
**END**
**END**
