Released PSO*7*404 SEQ #338
Extracted from mail message
**KIDS**:PSO*7.0*404^

**INSTALL NAME**
PSO*7.0*404
"BLD",8927,0)
PSO*7.0*404^OUTPATIENT PHARMACY^0^3120223^y
"BLD",8927,1,0)
^^3^3^3120216^
"BLD",8927,1,1,0)
Need to replace the direct global read for the Major Diagnostic Category
"BLD",8927,1,2,0)
of the ICD Diagnosis file (#80) with the API $$ICDDX^ICDCODE and the 
"BLD",8927,1,3,0)
Description of the ICD Diagnosis file (#80) with the API $$ICDD^ICDCODE.
"BLD",8927,4,0)
^9.64PA^^
"BLD",8927,6.3)
4
"BLD",8927,"KRN",0)
^9.67PA^779.2^20
"BLD",8927,"KRN",.4,0)
.4
"BLD",8927,"KRN",.401,0)
.401
"BLD",8927,"KRN",.402,0)
.402
"BLD",8927,"KRN",.403,0)
.403
"BLD",8927,"KRN",.5,0)
.5
"BLD",8927,"KRN",.84,0)
.84
"BLD",8927,"KRN",3.6,0)
3.6
"BLD",8927,"KRN",3.8,0)
3.8
"BLD",8927,"KRN",9.2,0)
9.2
"BLD",8927,"KRN",9.8,0)
9.8
"BLD",8927,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",8927,"KRN",9.8,"NM",1,0)
PSOHLSN2^^0^B9232532
"BLD",8927,"KRN",9.8,"NM",2,0)
PSOHLSNC^^0^B56662298
"BLD",8927,"KRN",9.8,"NM",3,0)
PSODIAG^^0^B63818227
"BLD",8927,"KRN",9.8,"NM","B","PSODIAG",3)

"BLD",8927,"KRN",9.8,"NM","B","PSOHLSN2",1)

"BLD",8927,"KRN",9.8,"NM","B","PSOHLSNC",2)

"BLD",8927,"KRN",19,0)
19
"BLD",8927,"KRN",19.1,0)
19.1
"BLD",8927,"KRN",101,0)
101
"BLD",8927,"KRN",409.61,0)
409.61
"BLD",8927,"KRN",771,0)
771
"BLD",8927,"KRN",779.2,0)
779.2
"BLD",8927,"KRN",870,0)
870
"BLD",8927,"KRN",8989.51,0)
8989.51
"BLD",8927,"KRN",8989.52,0)
8989.52
"BLD",8927,"KRN",8994,0)
8994
"BLD",8927,"KRN","B",.4,.4)

"BLD",8927,"KRN","B",.401,.401)

"BLD",8927,"KRN","B",.402,.402)

"BLD",8927,"KRN","B",.403,.403)

"BLD",8927,"KRN","B",.5,.5)

"BLD",8927,"KRN","B",.84,.84)

"BLD",8927,"KRN","B",3.6,3.6)

"BLD",8927,"KRN","B",3.8,3.8)

"BLD",8927,"KRN","B",9.2,9.2)

"BLD",8927,"KRN","B",9.8,9.8)

"BLD",8927,"KRN","B",19,19)

"BLD",8927,"KRN","B",19.1,19.1)

"BLD",8927,"KRN","B",101,101)

"BLD",8927,"KRN","B",409.61,409.61)

"BLD",8927,"KRN","B",771,771)

"BLD",8927,"KRN","B",779.2,779.2)

"BLD",8927,"KRN","B",870,870)

"BLD",8927,"KRN","B",8989.51,8989.51)

"BLD",8927,"KRN","B",8989.52,8989.52)

"BLD",8927,"KRN","B",8994,8994)

"BLD",8927,"QDEF")
^^^^NO^^^^^^NO
"BLD",8927,"QUES",0)
^9.62^^
"BLD",8927,"REQB",0)
^9.611^1^1
"BLD",8927,"REQB",1,0)
PSO*7.0*225^2
"BLD",8927,"REQB","B","PSO*7.0*225",1)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
404^3120223
"PKG",206,22,1,"PAH",1,1,0)
^^3^3^3120223
"PKG",206,22,1,"PAH",1,1,1,0)
Need to replace the direct global read for the Major Diagnostic Category
"PKG",206,22,1,"PAH",1,1,2,0)
of the ICD Diagnosis file (#80) with the API $$ICDDX^ICDCODE and the 
"PKG",206,22,1,"PAH",1,1,3,0)
Description of the ICD Diagnosis file (#80) with the API $$ICDD^ICDCODE.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSODIAG")
0^3^B63818227^B63590551
"RTN","PSODIAG",1,0)
PSODIAG ;BIR/LE - Diagnosis code prompts ;02/27/04
"RTN","PSODIAG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239,268,225,404**;DEC 1997;Build 4
"RTN","PSODIAG",3,0)
 ;Ext ref to ^XUSEC sup by DBIA 10076
"RTN","PSODIAG",4,0)
 ;Ext ref to $$ICDDX^ICDCODE sup DBIA 3990
"RTN","PSODIAG",5,0)
 ;Ext ref to $$STATCHK^ICDAPIU sup DBIA 3991
"RTN","PSODIAG",6,0)
EN ;
"RTN","PSODIAG",7,0)
 ;don't ask icd's if user doesn't hold provider key
"RTN","PSODIAG",8,0)
 Q:$T(CIDC^IBBAPI)']""
"RTN","PSODIAG",9,0)
 Q:'$D(^XUSEC("PROVIDER",DUZ))
"RTN","PSODIAG",10,0)
 N PSODDFN S PSODDFN=$S($D(DFN):DFN,$D(PSODFN):PSODFN,1:"")  ;need to do this since PU patient update deletes DFN and in case some other function does
"RTN","PSODIAG",11,0)
 I PSODDFN'="" I '$$CIDC^IBBAPI(PSODDFN) S:(+$G(PSONEW("DFLG")))&(+$G(PSOEDIT)=1)&('$D(DA)) PSONEW("DFLG")=0 Q  ;is CIDC activated; does patient have insurance
"RTN","PSODIAG",12,0)
 ;new variables and initialize variables based on CPRS or backdoor order.
"RTN","PSODIAG",13,0)
 N DX,POP,I,J,X,Y,Z,OLD,OLDI,SOLDI,NEW,TNEW,RAR,CPRS,FILDAT,STATCHK,STATCHK2
"RTN","PSODIAG",14,0)
 I '$G(PSOX("IRXN")) N PSOX S:$G(PSORXED("IRXN")) PSOX("IRXN")=PSORXED("IRXN")
"RTN","PSODIAG",15,0)
 K DIC
"RTN","PSODIAG",16,0)
 S CPRS=0
"RTN","PSODIAG",17,0)
 I $G(PSORXED) S RAR="PSORXED",@RAR@("DFLG")=0,PSORXED("FLD",39.3)=""
"RTN","PSODIAG",18,0)
 E  S RAR="PSONEW",@RAR@("DFLG")=0 I $G(ORD) D
"RTN","PSODIAG",19,0)
 . I $D(^PS(52.41,ORD)) S CPRS=1 M PSONEW("ICD")=PSORXED("ICD") K PSORXED("ICD"),PSORXED("FLD",39.3)
"RTN","PSODIAG",20,0)
 ;
"RTN","PSODIAG",21,0)
 S FILDAT="",FILDAT=DT I $G(PSOX("IRXN")) S FILDAT=$$GET1^DIQ(52,PSOX("IRXN")_",","22","I")
"RTN","PSODIAG",22,0)
 ;display any previously entered ICD's
"RTN","PSODIAG",23,0)
 W !!,"Previously entered ICD-9 diagnosis codes: "
"RTN","PSODIAG",24,0)
 I 'CPRS D  ;&(RAR="PSORXED"!(RAR="PSONEW")) D
"RTN","PSODIAG",25,0)
 . I $D(PSOX("IRXN")) I '$D(PSORXED("ICD")) I $D(^PSRX(PSOX("IRXN"),"ICD")) F I=1:1:8 Q:'$D(^PSRX(PSOX("IRXN"),"ICD",I,0))  D
"RTN","PSODIAG",26,0)
 .. S OLD(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01")
"RTN","PSODIAG",27,0)
 .. S OLDI(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01","I")
"RTN","PSODIAG",28,0)
 . I ($D(@RAR@("ICD"))&('$D(OLD)))!($G(PSOCOPY)) D
"RTN","PSODIAG",29,0)
 .. F I=1:1:8 Q:'$D(@RAR@("ICD",I))  I @RAR@("ICD",I)'="" S OLDI(I)=@RAR@("ICD",I) D
"RTN","PSODIAG",30,0)
 ... S OLD(I)=$P($$ICDDX^ICDCODE(OLDI(I),FILDAT),"^",2)  ;*404
"RTN","PSODIAG",31,0)
 ... S J=I-1 I I=1 W OLD(I) Q
"RTN","PSODIAG",32,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",33,0)
 E  I CPRS D
"RTN","PSODIAG",34,0)
 . I '$G(PSONEW("ICD")) F I=1:1:8 Q:'$D(^PS(52.41,ORD,"ICD",I,0))  D
"RTN","PSODIAG",35,0)
 .. S OLD(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01")
"RTN","PSODIAG",36,0)
 .. S OLDI(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01","I")
"RTN","PSODIAG",37,0)
 . I $D(PSONEW("ICD")) K OLD,OLDI D
"RTN","PSODIAG",38,0)
 .. F I=1:1:8 Q:'$D(PSONEW("ICD",I))  S OLDI(I)=PSONEW("ICD",I) D
"RTN","PSODIAG",39,0)
 ... S OLD(I)=$P($$ICDDX^ICDCODE(OLDI(I),FILDAT),"^",2)  ;*404
"RTN","PSODIAG",40,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",41,0)
 M SOLDI=OLDI
"RTN","PSODIAG",42,0)
 ;
"RTN","PSODIAG",43,0)
EN2 ;ask for ICD's or display previously entered ones for editing
"RTN","PSODIAG",44,0)
 ;note: because ICD's are not longer required, could not use standard
"RTN","PSODIAG",45,0)
 ;       FileMan calls everywhere because of need to control deleted
"RTN","PSODIAG",46,0)
 ;       entries and cross-references.
"RTN","PSODIAG",47,0)
 W !
"RTN","PSODIAG",48,0)
 F I=1:1:8 D  Q:+$G(Y)=-1!(@RAR@("DFLG")) 
"RTN","PSODIAG",49,0)
 . I '$G(PSORXED)&('$G(CPRS)) S RAR="PSONEW"
"RTN","PSODIAG",50,0)
 .K DIC S DIC("A")=$S(I=1:"Select Primary ICD-9 Code: ",1:"Select Secondary ICD-9 Code: ")
"RTN","PSODIAG",51,0)
 . I $D(OLD(I)),(OLD(I)'="") S DIC("B")=OLD(I)
"RTN","PSODIAG",52,0)
 . S X="" W !,DIC("A") D  R X:60   ;did this so that I have control of the deletes
"RTN","PSODIAG",53,0)
 .. I $D(OLD(I)),(OLD(I)'="") W OLD(I)_"// "
"RTN","PSODIAG",54,0)
 . I $D(OLD(I)) S:X="" X=OLD(I)
"RTN","PSODIAG",55,0)
 . I X="" S Y=-1 Q
"RTN","PSODIAG",56,0)
 . I X["?" W !,"Enter a valid ICD-9 diagnosis code." S I=1-1 Q
"RTN","PSODIAG",57,0)
 . I X="@" D DELETE Q
"RTN","PSODIAG",58,0)
 . I X="^" S Y=-1 Q
"RTN","PSODIAG",59,0)
 . K DIC S DIC=80,DIC(0)="EMZQ"
"RTN","PSODIAG",60,0)
 . ;S DIC("S")="I $P($$ICDDX^ICDCODE(Y,FILDAT),U,10)&($P($$ICDDX^ICDCODE(Y,FILDAT),U,17)>$P($$ICDDX^ICDCODE(Y,FILDAT),U,12))"
"RTN","PSODIAG",61,0)
 . S DIC("S")="I $$STATCHK^PSODIAG(Y,FILDAT)"
"RTN","PSODIAG",62,0)
 . K DTOUT,DUOUT D ^DIC K DIC
"RTN","PSODIAG",63,0)
 . I X="^" S I=I-1,Y="" Q
"RTN","PSODIAG",64,0)
 . I $G(DUOUT)!($G(DTOUT)) S Y=-1,X="^" Q
"RTN","PSODIAG",65,0)
 . I +Y=-1&(X'=""!(X'="^")) I $D(^ICD9("BA",X)) S I=I-1,(X,Y)="" Q  ;user said No to are you sure ?.
"RTN","PSODIAG",66,0)
 . I Y=-1&(X?1A.A) S I=I-1,Y="" Q  ;user said not to Yes? question.
"RTN","PSODIAG",67,0)
 . I Y'=-1 D  I STATCHK2=1 S I=I-1,Y="" Q
"RTN","PSODIAG",68,0)
 .. S (STATCHK,STATCHK2)="",STATCHK=$$STATCHK^ICDAPIU($P(Y,U,2),FILDAT) D
"RTN","PSODIAG",69,0)
 ... I $P(STATCHK,"^",2)=-1 W !!,"Invalid ICD-9 diagnosis code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",70,0)
 ... I +STATCHK=0 W !!,"Inactivated ICD-9 Diagnosis Code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",71,0)
 . I +Y=-1 S I=I-1,Y="" W !!,"Invalid or inactivated ICD-9 diagnosis code.  Please choose another.",! Q
"RTN","PSODIAG",72,0)
 . S (POP,J)=0 F J=1:1:I D
"RTN","PSODIAG",73,0)
 ..I $G(DX(J))=+Y W $C(7),!," Duplicate entry.  Please select a different ICD-9 diagnosis code.",! S I=I-1,(Y,X)="",POP=1
"RTN","PSODIAG",74,0)
 . Q:POP
"RTN","PSODIAG",75,0)
 . S NEW("ICD",I)=$P(Y,U,1),DX(I)=+Y
"RTN","PSODIAG",76,0)
 ;
"RTN","PSODIAG",77,0)
 ;resequence entered ICD's and removed deleted ones from file
"RTN","PSODIAG",78,0)
 ;I X="^"&(RAR="PSONEW")&('CPRS) S @RAR@("DFLG")=0 K DUOUT,DTOUT,Y,X Q
"RTN","PSODIAG",79,0)
 ;
"RTN","PSODIAG",80,0)
 I '$D(NEW("ICD")) I $D(OLDI) M NEW("ICD")=OLDI ;if user ^ out on first icd
"RTN","PSODIAG",81,0)
 K PSOICDD I '$D(NEW("ICD"))&($G(PSOCOPY)) S PSOICDD=1
"RTN","PSODIAG",82,0)
 ;
"RTN","PSODIAG",83,0)
 S J=0 F I=1:1:8 Q:'$D(NEW("ICD",I))  I NEW("ICD",I)'="" S J=J+1,@RAR@("ICD",J)=NEW("ICD",I)
"RTN","PSODIAG",84,0)
 S TNEW=I
"RTN","PSODIAG",85,0)
 I X="^" D  ;if up arrow out, set all icd's past ^ point into array
"RTN","PSODIAG",86,0)
 . ;S Y=TNEW-1 F  S Y=$O(OLDI(Y)) Q:Y=""  S J=J+1,@RAR@("ICD",J)=OLDI(Y)
"RTN","PSODIAG",87,0)
 . K @RAR@("ICD") S Y="" F  S Y=$O(SOLDI(Y)) Q:Y=""  S @RAR@("ICD",Y)=SOLDI(Y)
"RTN","PSODIAG",88,0)
 . K PSORXED("FLD",39.3)  ;7/12/04
"RTN","PSODIAG",89,0)
 I $G(CPRS) K PSORX("ICD") M PSORXED("ICD")=@RAR@("ICD"),PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",90,0)
 I $G(PSORXED) K PSORX("ICD") M PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",91,0)
 I '$D(@RAR@("ICD"))&(CPRS) S PSONEW("IDFLG")=1 ;user deleted all in finish/complete order
"RTN","PSODIAG",92,0)
 Q:(RAR="PSONEW")
"RTN","PSODIAG",93,0)
 I '$D(@RAR@("ICD"))&('CPRS)&($D(^PSRX(PSOX("IRXN"),"ICD",1,0))) S PSORXED("IDFLG")=1  ;user deleted all
"RTN","PSODIAG",94,0)
 Q
"RTN","PSODIAG",95,0)
 ;
"RTN","PSODIAG",96,0)
 ;called from above to write previously entered ICD's to screen.
"RTN","PSODIAG",97,0)
WRITE S J=I-1 I I=1 W !,?10,"Primary: ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",98,0)
WRITE2 I I=2 W !,?3,"Secondaries #"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",99,0)
 I I>2 W !,?15,"#"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4)
"RTN","PSODIAG",100,0)
 Q
"RTN","PSODIAG",101,0)
STATCHK(ICDIEN,FILDAT) ;called from above to check active/inactive date during FileMan call.
"RTN","PSODIAG",102,0)
 N X S X=""
"RTN","PSODIAG",103,0)
 S ICDIEN=$P(^ICD9(ICDIEN,0),"^",1) S X=$$STATCHK^ICDAPIU(ICDIEN,FILDAT)
"RTN","PSODIAG",104,0)
 Q +X
"RTN","PSODIAG",105,0)
DELETE ;called from above to verify delete with user and to delete said entries
"RTN","PSODIAG",106,0)
 W !,"SURE YOU WANT TO DELETE? " S X="" R X:30 S X=$TR(X,"yn","YN")
"RTN","PSODIAG",107,0)
 I X'="Y"&(X'="N") W !,"Enter Y or N" G DELETE
"RTN","PSODIAG",108,0)
 I X="N" S I=I-1 Q
"RTN","PSODIAG",109,0)
 F J=I:1:8 Q:'$D(OLDI(J))  D
"RTN","PSODIAG",110,0)
 . I $D(OLDI(J+1)) S OLDI(J)=OLDI(J+1),OLD(J)=OLD(J+1) D
"RTN","PSODIAG",111,0)
 .. I CPRS&($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",112,0)
 .. E  I CPRS&('$D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=OLDI(J+1)
"RTN","PSODIAG",113,0)
 .. I $G(PSOCOPY) D
"RTN","PSODIAG",114,0)
 ... I ($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",115,0)
 ... I ($D(PSORXED("ICD",J+1))) S PSORXED("ICD",J)=PSORXED("ICD",J+1)
"RTN","PSODIAG",116,0)
 . E  K OLD(J),OLDI(J),PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",117,0)
 . ;I CPRS!($G(PSOCOPY)) K PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",118,0)
 S I=I-1,(X,Y)=""
"RTN","PSODIAG",119,0)
 Q
"RTN","PSODIAG",120,0)
 ;
"RTN","PSODIAG",121,0)
ICD ;called from PSON52 cause PSON52'S too large.  Stores ICD info for new Rx's (CPRS and backdoor) using variables from copy function and new order functions.
"RTN","PSODIAG",122,0)
 N D,DDATA,ICD,II
"RTN","PSODIAG",123,0)
 I $G(PSOCOPY)&('$D(PSOX("ICD")))&('$G(PSOICDD)) D
"RTN","PSODIAG",124,0)
 . S D=0 F D=1:1 Q:'$D(PSOX("ICD",D))
"RTN","PSODIAG",125,0)
 . F D=D:1:8 K ^PSRX(PSOX("IRXN"),"ICD",D,0)  ;remove any icd's del
"RTN","PSODIAG",126,0)
 . I $D(^PSRX(PSOX("OIRXN"),"ICD",0)) F D=1:1:8 Q:'$D(^PSRX(PSOX("OIRXN"),"ICD",D,0))  S PSOX("ICD",D)=$P(^PSRX(PSOX("OIRXN"),"ICD",D,0),U,1)
"RTN","PSODIAG",127,0)
 I $G(ORD) I $D(^PS(52.41,ORD,0))&($D(PSORX("ICD"))) M PSOX("ICD")=PSONEW("ICD")
"RTN","PSODIAG",128,0)
 I $D(PSOX("ICD")) F D=1:1:8 Q:'$D(PSOX("ICD",D))  S ICD=$G(PSOX("ICD",D)) D
"RTN","PSODIAG",129,0)
 . S DDATA=ICD_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSODIAG",130,0)
 . S DDATA=DDATA_"^"_$G(PSOANSQ("SHAD"))
"RTN","PSODIAG",131,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(DDATA,"^",4)=PSOANSQ("SC>50")  ;for times when sc has no % defined.
"RTN","PSODIAG",132,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",133,0)
 E  S D=1 D
"RTN","PSODIAG",134,0)
 . S DDATA="^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")
"RTN","PSODIAG",135,0)
 . S DDATA=DDATA_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))_"^"_$G(PSOANSQ("SHAD"))
"RTN","PSODIAG",136,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",137,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(^PSRX(PSOX("IRXN"),"ICD",D,0),"^",4)=PSOANSQ("SC>50")
"RTN","PSODIAG",138,0)
 S ^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311P^"_II_"^"_II
"RTN","PSODIAG",139,0)
 K PSOX("ICD"),PSORXED("ICD"),PSONEW("ICD"),PSORX("ICD")
"RTN","PSODIAG",140,0)
 Q
"RTN","PSODIAG",141,0)
 ;
"RTN","PSODIAG",142,0)
UPDATE ;was in PSOORED6; now called from PSOORED6; removes deletes for edits and stores data.
"RTN","PSODIAG",143,0)
 ;
"RTN","PSODIAG",144,0)
 N TNEW,DA,DIK,SCEI,I,II
"RTN","PSODIAG",145,0)
 S DA=PSORXED("IRXN")
"RTN","PSODIAG",146,0)
 I '$D(PSORXED("ICD"))&($G(PSORXED("IDFLG"))) D  K PSORXED("IDFLG") Q
"RTN","PSODIAG",147,0)
 . I $D(^PSRX(PSORXED("IRXN"),"ICD",1,0)) D
"RTN","PSODIAG",148,0)
 .. S TNEW=2 K ^PSRX(PSORXED("IRXN"),"ICD","B") S $P(^PSRX(PSORXED("IRXN"),"ICD",1,0),U,1)=""
"RTN","PSODIAG",149,0)
 .. F I=TNEW:1:8 Q:'$D(^PSRX(PSORXED("IRXN"),"ICD",I,0))  S DIK="^PSRX("_PSORXED("IRXN")_","_$C(34)_"ICD"_$C(34)_",",DA=I,DA(1)=PSORXED("IRXN") D ^DIK K DA,DIK
"RTN","PSODIAG",150,0)
 ;
"RTN","PSODIAG",151,0)
 I $D(PSORXED("ICD")) D
"RTN","PSODIAG",152,0)
 . S SCEI=$G(^PSRX(DA,"ICD",1,0)),$P(SCEI,"^")=""
"RTN","PSODIAG",153,0)
 . K ^PSRX(DA,"ICD")
"RTN","PSODIAG",154,0)
 . F I=1:1:8 Q:'$D(PSORXED("ICD",I))  S $P(SCEI,"^")=PSORXED("ICD",I),^PSRX(DA,"ICD",I,0)=SCEI,^PSRX(DA,"ICD","B",$P(SCEI,"^"),I)="",II=I
"RTN","PSODIAG",155,0)
 . S ^PSRX(DA,"ICD",0)="^52.052311P^"_II_U_II
"RTN","PSODIAG",156,0)
 Q
"RTN","PSODIAG",157,0)
 ;
"RTN","PSODIAG",158,0)
CSET ;Called from PSOHLNEW due to it's routine size.  Requires PSOICD & PENDING variable.  Sets ICD node for orders passed from CPRS.
"RTN","PSODIAG",159,0)
 N EE,EEE
"RTN","PSODIAG",160,0)
 S (EE,EEE)=0 F  S EE=$O(PSOICD(EE)) Q:EE=""  D
"RTN","PSODIAG",161,0)
 .S EEE=EEE+1,^PS(52.41,PENDING,"ICD",EEE,0)=PSOICD(EE) S:$P(PSOICD(EE),"^")'="" ^PS(52.41,PENDING,"ICD","B",$P(PSOICD(EE),"^"),EEE)=""
"RTN","PSODIAG",162,0)
 .S ^PS(52.41,PENDING,"ICD",0)="^52.41311PA"_U_EEE_U_EEE
"RTN","PSODIAG",163,0)
 Q
"RTN","PSOHLSN2")
0^1^B9232532^B7919233
"RTN","PSOHLSN2",1,0)
PSOHLSN2 ;BIR/LE - Utilities for PSOHLSN1 ;02/27/04
"RTN","PSOHLSN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,226,239,225,404**;DEC 1997;Build 4
"RTN","PSOHLSN2",3,0)
 ;
"RTN","PSOHLSN2",4,0)
 ;Ext ref to $$ICDDX^ICDCODE sup DBIA 3990
"RTN","PSOHLSN2",5,0)
 ;Ext ref to $$ICDD^ICDCODE sup DBIA 3990
"RTN","PSOHLSN2",6,0)
 ;
"RTN","PSOHLSN2",7,0)
DG1 ;this section builds both DG1 segments 
"RTN","PSOHLSN2",8,0)
 Q:'$D(^PSRX(PSRXIEN,"ICD",1,0))
"RTN","PSOHLSN2",9,0)
 N LP,DG,DXDESC,I
"RTN","PSOHLSN2",10,0)
 S LIMIT=4,FIELD(0)="DG1",FIELD(4)=""
"RTN","PSOHLSN2",11,0)
 ;I '$D(^PSRX(PSRXIEN,"ICD",1,0)) S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",12,0)
 I $P(^PSRX(PSRXIEN,"ICD",1,0),"^",1)="" Q  ;S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",13,0)
 F I=1:1:8 D
"RTN","PSOHLSN2",14,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",15,0)
 . S PSOICD="",PSOICD=^PSRX(PSRXIEN,"ICD",I,0) Q:$P(PSOICD,U,1)=""
"RTN","PSOHLSN2",16,0)
 . S (DG,DXDESC)=""
"RTN","PSOHLSN2",17,0)
 . I $P(PSOICD,U,1)'="" D
"RTN","PSOHLSN2",18,0)
 .. N PSOICDD,PSOARRY,PSOICDX,PSOFILDT  ;*404
"RTN","PSOHLSN2",19,0)
 .. S PSOFILDT=$$GET1^DIQ(52,PSRXIEN_",","22","I")  ;*404
"RTN","PSOHLSN2",20,0)
 .. S PSOICDX=$$ICDDX^ICDCODE($P(PSOICD,U,1),PSOFILDT)  ;*404
"RTN","PSOHLSN2",21,0)
 .. S PSOICDD=$$ICDD^ICDCODE($P(PSOICDX,U,2),"PSOARRY",PSOFILDT)  ;*404
"RTN","PSOHLSN2",22,0)
 .. S DXDESC=PSOARRY(1),FIELD(1)=I,FIELD(2)=""  ;*404
"RTN","PSOHLSN2",23,0)
 .. S FIELD(3)=$P(PSOICD,U,1)_U_DXDESC_U_"80"_U_$P(PSOICDX,U,2)_U_DXDESC_U_"ICD9"  ;*404
"RTN","PSOHLSN2",24,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",25,0)
 K PSOICD("K")
"RTN","PSOHLSN2",26,0)
 Q
"RTN","PSOHLSN2",27,0)
ZCL N STOP,IBQ,ICD,I,JJJ,EI
"RTN","PSOHLSN2",28,0)
 S LIMIT=3,FIELD(0)="ZCL"
"RTN","PSOHLSN2",29,0)
 I '$D(^PSRX(PSRXIEN,"ICD"))&($D(^PSRX(PSRXIEN,"IBQ"))) D    ;For edits; currently CPRS doesn't update SC/EI for edits, but just in case they start
"RTN","PSOHLSN2",30,0)
 . S FIELD(1)=1,FIELD(2)=3
"RTN","PSOHLSN2",31,0)
 . S EI="",EI=^PSRX(PSRXIEN,"IBQ")
"RTN","PSOHLSN2",32,0)
 . S JJJ=0 F I=3,4,1,5,2,6,7,8 S JJJ=JJJ+1,FIELD(3)=$P(EI,U,I) S FIELD(1)=1,FIELD(2)=JJJ D SEG^PSOHLSN1
"RTN","PSOHLSN2",33,0)
 E  F I=1:1:8 D
"RTN","PSOHLSN2",34,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",35,0)
 . S PSOICD=^PSRX(PSRXIEN,"ICD",I,0),ICD=$P(PSOICD,"^",1)
"RTN","PSOHLSN2",36,0)
 . Q:ICD=""&(I>1)
"RTN","PSOHLSN2",37,0)
 . F JJJ=2:1:9 S EI=$P(PSOICD,U,JJJ),FIELD(2)=JJJ-1 D
"RTN","PSOHLSN2",38,0)
 .. S FIELD(1)=$S(ICD="":1,1:I)
"RTN","PSOHLSN2",39,0)
 .. ;S FIELD(3)=$S(EI=1:EI,1:0)
"RTN","PSOHLSN2",40,0)
 .. S FIELD(3)=$S(EI=1:EI,EI=0:EI,1:"")
"RTN","PSOHLSN2",41,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",42,0)
 K PSOICD
"RTN","PSOHLSN2",43,0)
 Q
"RTN","PSOHLSN2",44,0)
 ;CPRS doesn't look at the ZCL segment when their CIDC switch is off.  Always send both ZCL and ZSC for consistency
"RTN","PSOHLSN2",45,0)
ZSC S PSOCPS=$$DT^PSOMLLDT S LIMIT=$S($G(PSOCPS):8,1:1) X NULLFLDS
"RTN","PSOHLSN2",46,0)
 S FIELD(0)="ZSC" N JJJ,PSOICD
"RTN","PSOHLSN2",47,0)
 I '$D(^PSRX(PSRXIEN,"ICD",1,0)) D
"RTN","PSOHLSN2",48,0)
 . I '$G(PSOCPS) S FIELD(1)=$S($P($G(^PSRX(PSRXIEN,"IB")),"^"):"NSC",1:"SC")
"RTN","PSOHLSN2",49,0)
 . I $G(PSOCPS) D
"RTN","PSOHLSN2",50,0)
 .. S FIELD(1)=$P($G(^PSRX(PSRXIEN,"IBQ")),"^")
"RTN","PSOHLSN2",51,0)
 .. F JJJ=2:1:8 S FIELD(JJJ)=$P($G(^PSRX(PSRXIEN,"IBQ")),"^",JJJ)
"RTN","PSOHLSN2",52,0)
 .D SEG^PSOHLSN1
"RTN","PSOHLSN2",53,0)
 I $D(^PSRX(PSRXIEN,"ICD",1,0)) D
"RTN","PSOHLSN2",54,0)
 . S PSOICD=$G(^PSRX(PSRXIEN,"ICD",1,0))
"RTN","PSOHLSN2",55,0)
 . F JJJ=2:1:9 D
"RTN","PSOHLSN2",56,0)
 .. I JJJ=2 S FIELD(3)=$P(PSOICD,"^",JJJ)  ;AO
"RTN","PSOHLSN2",57,0)
 .. I JJJ=3 S FIELD(4)=$P(PSOICD,"^",JJJ)  ;IR
"RTN","PSOHLSN2",58,0)
 .. I JJJ=4 S FIELD(1)=$P(PSOICD,"^",JJJ)  ;SC
"RTN","PSOHLSN2",59,0)
 .. I JJJ=5 S FIELD(5)=$P(PSOICD,"^",JJJ)  ;EC
"RTN","PSOHLSN2",60,0)
 .. I JJJ=6 S FIELD(2)=$P(PSOICD,"^",JJJ)  ;MST
"RTN","PSOHLSN2",61,0)
 .. I JJJ=7 S FIELD(6)=$P(PSOICD,"^",JJJ)  ;HNC
"RTN","PSOHLSN2",62,0)
 .. I JJJ=8 S FIELD(7)=$P(PSOICD,"^",JJJ)  ;CV
"RTN","PSOHLSN2",63,0)
 .. I JJJ=9 S FIELD(8)=$P(PSOICD,"^",JJJ)  ;SHAD
"RTN","PSOHLSN2",64,0)
 . D SEG^PSOHLSN1
"RTN","PSOHLSN2",65,0)
 Q
"RTN","PSOHLSNC")
0^2^B56662298^B54704997
"RTN","PSOHLSNC",1,0)
PSOHLSNC ;BIR/RTR - Send CHCS message to CPRS ;07/03/02
"RTN","PSOHLSNC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**111,157,143,225,404**;DEC 1997;Build 4
"RTN","PSOHLSNC",3,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOHLSNC",4,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOHLSNC",5,0)
 ;External reference to ^PSDRUG( supported by DBIA 221
"RTN","PSOHLSNC",6,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOHLSNC",7,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOHLSNC",8,0)
 ;External reference to EN^PSSUTIL1 supported by DBIA 3179
"RTN","PSOHLSNC",9,0)
 ;External reference to ^ICDCODE sup DBIA 3990
"RTN","PSOHLSNC",10,0)
 ;
"RTN","PSOHLSNC",11,0)
 ;PSOPND=Internal number from 52.41
"RTN","PSOHLSNC",12,0)
 ;PSOPNDST=Order Control Code Status
"RTN","PSOHLSNC",13,0)
 ;PSOPNDPT=Pharmacy Status
"RTN","PSOHLSNC",14,0)
 ;
"RTN","PSOHLSNC",15,0)
EN(PSOPND,PSOPNDST,PSOPNDPT) ;
"RTN","PSOHLSNC",16,0)
 N MSG,PSOHLIP,PSOHLIPX,PSOHLIPC,PSOHLTTL,PSOHUTL,PSOHND,PSOHNDD,PSOHNDU,PSONFLD,PSOXFLD,PSOLIMIT,PSONJJ,PSOHJJ,PSOHCT,PSOSEGMT,PSOHENT,PSOHPRO,PSOHIM,PSOHPC,PSOHPCTX,PSOHRT,PSOHRTE,PSOHRTEN,PSOHRTX,Y,DA,DIQ,DR
"RTN","PSOHLSNC",17,0)
 I $G(PSOPND)=""!($G(PSOPNDST)="") Q
"RTN","PSOHLSNC",18,0)
 I '$D(^PS(52.41,+$G(PSOPND),0)) Q
"RTN","PSOHLSNC",19,0)
 S PSONFLD="F PSONJJ=0:1:PSOLIMIT S PSOXFLD(PSONJJ)="""""
"RTN","PSOHLSNC",20,0)
 S PSOHCT=1
"RTN","PSOHLSNC",21,0)
 D INIT^PSOHLSN
"RTN","PSOHLSNC",22,0)
 D PID,PV1,ORC,RXO,RXE,RXR,ZRX,DG1,ZCL
"RTN","PSOHLSNC",23,0)
 D MSG^XQOR("PS EVSEND OR",.MSG)
"RTN","PSOHLSNC",24,0)
 Q
"RTN","PSOHLSNC",25,0)
PID ;Build PID segment
"RTN","PSOHLSNC",26,0)
 S PSOLIMIT=5 X PSONFLD
"RTN","PSOHLSNC",27,0)
 ;What about this ICN number?
"RTN","PSOHLSNC",28,0)
 S PSOXFLD(0)="PID"
"RTN","PSOHLSNC",29,0)
 S PSOXFLD(3)=$P($G(^PS(52.41,PSOPND,0)),"^",2)
"RTN","PSOHLSNC",30,0)
 D SEG
"RTN","PSOHLSNC",31,0)
 Q
"RTN","PSOHLSNC",32,0)
PV1 ;Build PV1 segment
"RTN","PSOHLSNC",33,0)
 S PSOLIMIT=19 X PSONFLD
"RTN","PSOHLSNC",34,0)
 S PSOXFLD(0)="PV1"
"RTN","PSOHLSNC",35,0)
 S PSOXFLD(2)="O"
"RTN","PSOHLSNC",36,0)
 I $P($G(^PS(52.41,PSOPND,0)),"^",13) S PSOXFLD(3)=$P(^(0),"^",13)
"RTN","PSOHLSNC",37,0)
 D SEG
"RTN","PSOHLSNC",38,0)
 Q
"RTN","PSOHLSNC",39,0)
DG1 ;Build DG1 segment
"RTN","PSOHLSNC",40,0)
 ;future use; chcs does not send ICD-9 codes.
"RTN","PSOHLSNC",41,0)
 Q:'$D(^PS(52.41,PSOPND,"ICD"))
"RTN","PSOHLSNC",42,0)
 S PSOLIMIT=4 X PSONFLD
"RTN","PSOHLSNC",43,0)
 S PSOXFLD(0)="DG1"
"RTN","PSOHLSNC",44,0)
 N LP,VDG,FLAG,DXDESC,DG
"RTN","PSOHLSNC",45,0)
 S FLAG="",PSOXFLD(4)="",PSOXFLD(2)=""
"RTN","PSOHLSNC",46,0)
 F LP=1:1:8 Q:'$D(^PS(52.41,PSOPND,"ICD",LP,0))  D
"RTN","PSOHLSNC",47,0)
 . S VDG="",VDG=^PS(52.41,PSOPND,"ICD",LP,0) Q:$P(VDG,U,1)=""
"RTN","PSOHLSNC",48,0)
 . S (DG,DXDESC)=""
"RTN","PSOHLSNC",49,0)
 . N PSOARRY,PSOICDD,PSOICDDX  ;*404
"RTN","PSOHLSNC",50,0)
 . S PSOICDDX=$$ICDDX^ICDCODE($P(VDG,U,1))  ;*404
"RTN","PSOHLSNC",51,0)
 . S PSOICDD=$$ICDD^ICDCODE($P(PSOICDDX,U,2),"PSOARRY"),PSOXFLD(1)=LP  ;*404
"RTN","PSOHLSNC",52,0)
 . S DXDESC=PSOARRY(1)  ;*404
"RTN","PSOHLSNC",53,0)
 . S PSOXFLD(3)=$P(VDG,U,1)_U_DXDESC_U_"80"_U_$P(PSOICDDX,U,2)_U_DXDESC_U_"ICD9"  ;*404
"RTN","PSOHLSNC",54,0)
 . D SEG
"RTN","PSOHLSNC",55,0)
 Q
"RTN","PSOHLSNC",56,0)
ORC ;Build ORC segment
"RTN","PSOHLSNC",57,0)
 S PSOLIMIT=15 X PSONFLD
"RTN","PSOHLSNC",58,0)
 S PSOXFLD(0)="ORC"
"RTN","PSOHLSNC",59,0)
 S PSOXFLD(1)=$G(PSOPNDST)
"RTN","PSOHLSNC",60,0)
 S PSOXFLD(3)=PSOPND_"S^PS"
"RTN","PSOHLSNC",61,0)
 S PSOXFLD(5)=$G(PSOPNDPT)
"RTN","PSOHLSNC",62,0)
 S X=$P($G(^PS(52.41,PSOPND,0)),"^",6) I X S PSOXFLD(9)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSNC",63,0)
 S PSOHENT=$P($G(^PS(52.41,PSOPND,0)),"^",4) I PSOHENT K ^UTILITY("DIQ1",$J) S DIC=200,DR=.01,DA=PSOHENT,DIQ(0)="E" D EN^DIQ1 S PSOXFLD(10)=PSOHENT_"^"_$P($G(^UTILITY("DIQ1",$J,200,PSOHENT,.01,"E")),"^")
"RTN","PSOHLSNC",64,0)
 S PSOHPRO=$P($G(^PS(52.41,PSOPND,0)),"^",5) I PSOHPRO K ^UTILITY("DIQ1",$J) S DIC=200,DR=.01,DA=PSOHPRO,DIQ(0)="E" D EN^DIQ1 S PSOXFLD(12)=PSOHPRO_"^"_$P($G(^UTILITY("DIQ1",$J,200,PSOHPRO,.01,"E")),"^")
"RTN","PSOHLSNC",65,0)
 K ^UTILITY("DIQ1",$J)
"RTN","PSOHLSNC",66,0)
 S X=$P($G(^PS(52.41,PSOPND,0)),"^",12) I X S PSOXFLD(15)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSNC",67,0)
 D SEG
"RTN","PSOHLSNC",68,0)
 Q
"RTN","PSOHLSNC",69,0)
RXO ;Build RXO segment
"RTN","PSOHLSNC",70,0)
 S PSOLIMIT=1 X PSONFLD
"RTN","PSOHLSNC",71,0)
 S PSOXFLD(0)="RXO"
"RTN","PSOHLSNC",72,0)
 S PSOHITM=$P($G(^PS(52.41,PSOPND,0)),"^",8)
"RTN","PSOHLSNC",73,0)
 S PSOXFLD(1)=$S($G(PSOHITM):"^^^"_PSOHITM_"^"_$P($G(^PS(50.7,+$G(PSOHITM),0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP",1:"^^^^^")
"RTN","PSOHLSNC",74,0)
 D SEG
"RTN","PSOHLSNC",75,0)
 Q
"RTN","PSOHLSNC",76,0)
RXE ;Build RXE segment
"RTN","PSOHLSNC",77,0)
 K PSOXFLD S PSOLIMIT=26 X PSONFLD
"RTN","PSOHLSNC",78,0)
 S PSOXFLD(0)="RXE"
"RTN","PSOHLSNC",79,0)
 ;No Quantity Timing, since the Sig is entered as free text
"RTN","PSOHLSNC",80,0)
 S PSOHNDD=$P($G(^PS(52.41,PSOPND,0)),"^",9)
"RTN","PSOHLSNC",81,0)
 S PSOHND="" I PSOHNDD S PSOHND=$G(^PSDRUG(PSOHNDD,"ND"))
"RTN","PSOHLSNC",82,0)
 S PSOXFLD(2)=$S($P(PSOHND,"^")&($P(PSOHND,"^",3)):$P(PSOHND,"^")_"."_$P(PSOHND,"^",3)_"^"_$P(PSOHND,"^",2)_"^"_"99NDF",1:"^^")_"^"_$G(PSOHNDD)_"^"_$S($G(PSOHNDD):$P($G(^PSDRUG(PSOHNDD,0)),"^"),1:"")_"^"_"99PSD"
"RTN","PSOHLSNC",83,0)
 I $P(PSOHND,"^"),$P(PSOHND,"^",3) D
"RTN","PSOHLSNC",84,0)
 .I $T(^PSNAPIS)]"" S PSOHNDU=$$DFSU^PSNAPIS($P(PSOHND,"^"),$P(PSOHND,"^",3)) S PSOXFLD(5)="^^^"_$P($G(PSOHNDU),"^",5)_"^"_$P($G(PSOHNDU),"^",6)_"^"_"99PSU"
"RTN","PSOHLSNC",85,0)
 I $G(PSOHITM) S PSOXFLD(6)="^^^"_$P($G(^PS(50.7,$G(PSOHITM),0)),"^",2)_"^"_$P($G(^PS(50.606,+$P($G(^PS(50.7,$G(PSOHITM),0)),"^",2),0)),"^")_"^"_"99PSF"
"RTN","PSOHLSNC",86,0)
 S PSOXFLD(10)=$P(^PS(52.41,PSOPND,0),"^",10)
"RTN","PSOHLSNC",87,0)
 S PSOXFLD(12)=$P(^PS(52.41,PSOPND,0),"^",11)
"RTN","PSOHLSNC",88,0)
 S PSOXFLD(22)=$P(^PS(52.41,PSOPND,0),"^",22)
"RTN","PSOHLSNC",89,0)
 I $G(PSOHNDD) S PSOHUTL=$$EN^PSSUTIL1(PSOHNDD) S PSOXFLD(25)=$S($E($P(PSOHUTL,"|"),1)=".":"0",1:"")_$P(PSOHUTL,"|"),PSOXFLD(26)=$P(PSOHUTL,"|",2)
"RTN","PSOHLSNC",90,0)
 ;Create RXE segment, can possibly go over 245 in length
"RTN","PSOHLSNC",91,0)
 S PSOHCT=PSOHCT+1
"RTN","PSOHLSNC",92,0)
 S (PSOHLIPX,PSOHLIPC,PSOHLTTL)=0,PSOHLIP="" F  S PSOHLIP=$O(PSOXFLD(PSOHLIP)) Q:PSOHLIP=""  D
"RTN","PSOHLSNC",93,0)
 .I PSOHLIP S PSOXFLD(PSOHLIP)="|"_PSOXFLD(PSOHLIP)
"RTN","PSOHLSNC",94,0)
 .I PSOHLTTL+$L(PSOXFLD(PSOHLIP))<246 D  S PSOHLTTL=PSOHLTTL+$L(PSOXFLD(PSOHLIP)) Q
"RTN","PSOHLSNC",95,0)
 ..I 'PSOHLIPX S MSG(PSOHCT)=$G(MSG(PSOHCT))_PSOXFLD(PSOHLIP) Q
"RTN","PSOHLSNC",96,0)
 ..S MSG(PSOHCT,PSOHLIPX)=$G(MSG(PSOHCT,PSOHLIPX))_PSOXFLD(PSOHLIP)
"RTN","PSOHLSNC",97,0)
 .S PSOHLICP=245-PSOHLTTL
"RTN","PSOHLSNC",98,0)
 .I 'PSOHLIPX D  S PSOHLTTL=$L(MSG(PSOHCT,PSOHLIPX)) Q
"RTN","PSOHLSNC",99,0)
 ..S MSG(PSOHCT)=$G(MSG(PSOHCT))_$E(PSOXFLD(PSOHLIP),1,PSOHLICP)
"RTN","PSOHLSNC",100,0)
 ..S PSOHLIPX=1,MSG(PSOHCT,PSOHLIPX)=$E(PSOXFLD(PSOHLIP),(PSOHLICP+1),999)
"RTN","PSOHLSNC",101,0)
 .S MSG(PSOHCT,PSOHLIPX)=$G(MSG(PSOHCT,PSOHLIPX))_$E(PSOXFLD(PSOHLIP),1,PSOHLICP)
"RTN","PSOHLSNC",102,0)
 .S PSOHLIPX=PSOHLIPX+1,MSG(PSOHCT,PSOHLIPX)=$E(PSOXFLD(PSOHLIP),(PSOHLICP+1),999)
"RTN","PSOHLSNC",103,0)
 .S PSOHLTTL=$L(MSG(PSOHCT,PSOHLIPX))
"RTN","PSOHLSNC",104,0)
 ;Set NTE segments
"RTN","PSOHLSNC",105,0)
 S PSOHPCT=0,PSOHCT=PSOHCT+1 I $O(^PS(52.41,PSOPND,3,0)) F PSOHPC=0:0 S PSOHPC=$O(^PS(52.41,PSOPND,3,PSOHPC)) Q:'PSOHPC  D
"RTN","PSOHLSNC",106,0)
 .I $G(^PS(52.41,PSOPND,3,PSOHPC,0))="" Q
"RTN","PSOHLSNC",107,0)
 .I 'PSOHPCT S MSG(PSOHCT)="NTE|6||"_$G(^PS(52.41,PSOPND,3,PSOHPC,0)) S PSOHPCT=1 Q
"RTN","PSOHLSNC",108,0)
 .S MSG(PSOHCT,PSOHPCT)=$G(^PS(52.41,PSOPND,3,PSOHPC,0)),PSOHPCT=PSOHPCT+1
"RTN","PSOHLSNC",109,0)
 I 'PSOHPCT S PSOHCT=PSOHCT-1
"RTN","PSOHLSNC",110,0)
 S PSOHCT=PSOHCT+1,PSOHPCT=0 I $O(^PS(52.41,PSOPND,"SIG",0)) F PSOHPC=0:0 S PSOHPC=$O(^PS(52.41,PSOPND,"SIG",PSOHPC)) Q:'PSOHPC  D
"RTN","PSOHLSNC",111,0)
 .I $G(^PS(52.41,PSOPND,"SIG",PSOHPC,0))="" Q
"RTN","PSOHLSNC",112,0)
 .I 'PSOHPCT S MSG(PSOHCT)="NTE|21||"_$G(^PS(52.41,PSOPND,"SIG",PSOHPC,0)) S PSOHPCT=1 Q
"RTN","PSOHLSNC",113,0)
 .S MSG(PSOHCT,PSOHPCT)=$G(^PS(52.41,PSOPND,"SIG",PSOHPC,0)),PSOHPCT=PSOHPCT+1
"RTN","PSOHLSNC",114,0)
 I 'PSOHPCT S MSG(PSOHCT)="NTE|21||"_"No SIG available"
"RTN","PSOHLSNC",115,0)
 Q
"RTN","PSOHLSNC",116,0)
RXR ;Build RXR segment
"RTN","PSOHLSNC",117,0)
 S PSOHRTX="" F PSOHRT=0:0 S PSOHRT=$O(^PS(52.41,PSOPND,1,PSOHRT)) Q:'PSOHRT  D
"RTN","PSOHLSNC",118,0)
 .S PSOHRTX=1
"RTN","PSOHLSNC",119,0)
 .S PSOLIMIT=1 X PSONFLD
"RTN","PSOHLSNC",120,0)
 .S PSOXFLD(0)="RXR"
"RTN","PSOHLSNC",121,0)
 .S PSOHRTEN=""
"RTN","PSOHLSNC",122,0)
 .S PSOHRTE=$P($G(^PS(52.41,PSOPND,1,PSOHRT,1)),"^",8) I PSOHRTE,$D(^PS(51.2,PSOHRTE,0)) S PSOHRTEN=$P($G(^(0)),"^")
"RTN","PSOHLSNC",123,0)
 .S PSOXFLD(1)="^^^"_$G(PSOHRTE)_"^"_$G(PSOHRTEN)_"^"_"99PSR"
"RTN","PSOHLSNC",124,0)
 .D SEG
"RTN","PSOHLSNC",125,0)
 I '$G(PSOHRTX) S PSOLIMIT=1 X PSONFLD S PSOXFLD(0)="RXR",PSOXFLD(1)="^^^^^99PSR" D SEG
"RTN","PSOHLSNC",126,0)
 Q
"RTN","PSOHLSNC",127,0)
ZRX ;Build ZRX segment
"RTN","PSOHLSNC",128,0)
 S PSOLIMIT=6 X PSONFLD
"RTN","PSOHLSNC",129,0)
 S PSOXFLD(0)="ZRX"
"RTN","PSOHLSNC",130,0)
 S PSOXFLD(3)="N"
"RTN","PSOHLSNC",131,0)
 S PSOXFLD(4)=$P($G(^PS(52.41,PSOPND,0)),"^",17)
"RTN","PSOHLSNC",132,0)
 D SEG
"RTN","PSOHLSNC",133,0)
 Q
"RTN","PSOHLSNC",134,0)
ZCL ;Build ZCL segment
"RTN","PSOHLSNC",135,0)
 N I,JJJ,INODE,EI
"RTN","PSOHLSNC",136,0)
 S PSOXFLD(0)="ZCL",PSOLIMIT=3 X PSONFLD
"RTN","PSOHLSNC",137,0)
 I $D(^PS(52.41,PSOPND,"ICD")) D
"RTN","PSOHLSNC",138,0)
 .F I=1:1:8 D
"RTN","PSOHLSNC",139,0)
 ..Q:'$D(^PS(52.41,PSOPND,"ICD",I,0))
"RTN","PSOHLSNC",140,0)
 ..S INODE="",INODE=^PS(52.41,PSOPND,"ICD",I,0)
"RTN","PSOHLSNC",141,0)
 ..F JJJ=2:1:9 S EI=$P(INODE,U,JJJ) D
"RTN","PSOHLSNC",142,0)
 ...S PSOXFLD(1)=I,PSOXFLD(2)=JJJ-1,PSOXFLD(3)=EI
"RTN","PSOHLSNC",143,0)
 ...;I JJJ=4 S EI=$S(EI=1:"SC",EI=0:"NSC",1:"") S PSOXFLD(3)=EI
"RTN","PSOHLSNC",144,0)
 ...D SEG
"RTN","PSOHLSNC",145,0)
 E  D  ;if no ICD node, send one ZCL segment
"RTN","PSOHLSNC",146,0)
 .S PSOXFLD(0)="ZCL",PSOXFLD(1)=1,PSOXFLD(2)=3
"RTN","PSOHLSNC",147,0)
 .S PSOXFLD(3)=$S($P(^PS(52.41,PSOPND,0),"^",16)="SC":1,$P(^(0),"^",16)="NSC":0,1:"")
"RTN","PSOHLSNC",148,0)
 .D SEG
"RTN","PSOHLSNC",149,0)
 .Q:'$D(^PS(52.41,PSOPND,"IBQ"))
"RTN","PSOHLSNC",150,0)
 .S EI=^PS(52.41,PSOPND,"IBQ")
"RTN","PSOHLSNC",151,0)
 .F I=2,3,4,1,5,6,7 S PSOXFLD(3)=$P(EI,U,I) D
"RTN","PSOHLSNC",152,0)
 .. S PSOXFLD(2)=$S(I=2:1,I=3:2,I=4:4,I=1:5,I=5:6,I=6:7,I=7:8,1:"") D SEG
"RTN","PSOHLSNC",153,0)
 Q
"RTN","PSOHLSNC",154,0)
ZSC ;Build ZSC segment
"RTN","PSOHLSNC",155,0)
 S PSOLIMIT=6 X PSONFLD
"RTN","PSOHLSNC",156,0)
 S PSOXFLD(0)="ZSC"
"RTN","PSOHLSNC",157,0)
 S PSOXFLD(1)=$S($P(^PS(52.41,PSOPND,0),"^",16)="SC":1,$P(^(0),"^",16)="NSC":0,1:"")
"RTN","PSOHLSNC",158,0)
 S PSOXFLD(2)=$P($G(^PS(52.41,PSOPND,"IBQ")),"^"),PSOXFLD(3)=$P($G(^("IBQ")),"^",2),PSOXFLD(4)=$P($G(^("IBQ")),"^",3),PSOXFLD(5)=$P($G(^("IBQ")),"^",4),PSOXFLD(6)=$P($G(^("IBQ")),"^",5),PSOXFLD(7)=$P($G(^("IBQ")),"^",6)
"RTN","PSOHLSNC",159,0)
 D SEG
"RTN","PSOHLSNC",160,0)
 Q
"RTN","PSOHLSNC",161,0)
SEG ;
"RTN","PSOHLSNC",162,0)
 S PSOSEGMT="" F PSOHJJ=0:1:PSOLIMIT S PSOSEGMT=$S(PSOSEGMT="":PSOXFLD(PSOHJJ),1:PSOSEGMT_"|"_PSOXFLD(PSOHJJ))
"RTN","PSOHLSNC",163,0)
 S PSOHCT=PSOHCT+1,MSG(PSOHCT)=PSOSEGMT
"RTN","PSOHLSNC",164,0)
 Q
"VER")
8.0^22.0
"BLD",8927,6)
^338
**END**
**END**
