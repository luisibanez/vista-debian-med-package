Released PSO*7*388 SEQ #335
Extracted from mail message
**KIDS**:PSO*7.0*388^

**INSTALL NAME**
PSO*7.0*388
"BLD",8759,0)
PSO*7.0*388^OUTPATIENT PHARMACY^0^3110620^y
"BLD",8759,1,0)
^^9^9^3110620^^^
"BLD",8759,1,1,0)
This patch resolves the following two issues:
"BLD",8759,1,2,0)
 
"BLD",8759,1,3,0)
1) Provide users a more accurate description as to as to why a refill is 
"BLD",8759,1,4,0)
not allowed.
"BLD",8759,1,5,0)
 
"BLD",8759,1,6,0)
                                                                   
"BLD",8759,1,7,0)
 
"BLD",8759,1,8,0)
2) Correct a misspelling of the word "prescription" in a CPRS pop-up 
"BLD",8759,1,9,0)
box.
"BLD",8759,4,0)
^9.64PA^^
"BLD",8759,6)
1^
"BLD",8759,6.3)
6
"BLD",8759,"ABPKG")
n
"BLD",8759,"KRN",0)
^9.67PA^779.2^20
"BLD",8759,"KRN",.4,0)
.4
"BLD",8759,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8759,"KRN",.401,0)
.401
"BLD",8759,"KRN",.401,"NM",0)
^9.68A^^
"BLD",8759,"KRN",.402,0)
.402
"BLD",8759,"KRN",.403,0)
.403
"BLD",8759,"KRN",.5,0)
.5
"BLD",8759,"KRN",.84,0)
.84
"BLD",8759,"KRN",3.6,0)
3.6
"BLD",8759,"KRN",3.8,0)
3.8
"BLD",8759,"KRN",9.2,0)
9.2
"BLD",8759,"KRN",9.8,0)
9.8
"BLD",8759,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",8759,"KRN",9.8,"NM",1,0)
PSORENW^^0^B35245788
"BLD",8759,"KRN",9.8,"NM",2,0)
PSOATRF^^0^B79340036
"BLD",8759,"KRN",9.8,"NM",3,0)
PSOATRFC^^0^B45655839
"BLD",8759,"KRN",9.8,"NM",4,0)
PSOREF0^^0^B38701454
"BLD",8759,"KRN",9.8,"NM",5,0)
PSOUTLA1^^0^B59550372
"BLD",8759,"KRN",9.8,"NM","B","PSOATRF",2)

"BLD",8759,"KRN",9.8,"NM","B","PSOATRFC",3)

"BLD",8759,"KRN",9.8,"NM","B","PSOREF0",4)

"BLD",8759,"KRN",9.8,"NM","B","PSORENW",1)

"BLD",8759,"KRN",9.8,"NM","B","PSOUTLA1",5)

"BLD",8759,"KRN",19,0)
19
"BLD",8759,"KRN",19,"NM",0)
^9.68A^^
"BLD",8759,"KRN",19.1,0)
19.1
"BLD",8759,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8759,"KRN",101,0)
101
"BLD",8759,"KRN",101,"NM",0)
^9.68A^^
"BLD",8759,"KRN",409.61,0)
409.61
"BLD",8759,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",8759,"KRN",771,0)
771
"BLD",8759,"KRN",771,"NM",0)
^9.68A^^
"BLD",8759,"KRN",779.2,0)
779.2
"BLD",8759,"KRN",779.2,"NM",0)
^9.68A^^
"BLD",8759,"KRN",870,0)
870
"BLD",8759,"KRN",870,"NM",0)
^9.68A^^
"BLD",8759,"KRN",8989.51,0)
8989.51
"BLD",8759,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",8759,"KRN",8989.52,0)
8989.52
"BLD",8759,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",8759,"KRN",8994,0)
8994
"BLD",8759,"KRN","B",.4,.4)

"BLD",8759,"KRN","B",.401,.401)

"BLD",8759,"KRN","B",.402,.402)

"BLD",8759,"KRN","B",.403,.403)

"BLD",8759,"KRN","B",.5,.5)

"BLD",8759,"KRN","B",.84,.84)

"BLD",8759,"KRN","B",3.6,3.6)

"BLD",8759,"KRN","B",3.8,3.8)

"BLD",8759,"KRN","B",9.2,9.2)

"BLD",8759,"KRN","B",9.8,9.8)

"BLD",8759,"KRN","B",19,19)

"BLD",8759,"KRN","B",19.1,19.1)

"BLD",8759,"KRN","B",101,101)

"BLD",8759,"KRN","B",409.61,409.61)

"BLD",8759,"KRN","B",771,771)

"BLD",8759,"KRN","B",779.2,779.2)

"BLD",8759,"KRN","B",870,870)

"BLD",8759,"KRN","B",8989.51,8989.51)

"BLD",8759,"KRN","B",8989.52,8989.52)

"BLD",8759,"KRN","B",8994,8994)

"BLD",8759,"QUES",0)
^9.62^^
"BLD",8759,"REQB",0)
^9.611^5^4
"BLD",8759,"REQB",1,0)
PSO*7.0*206^2
"BLD",8759,"REQB",2,0)
PSO*7.0*305^2
"BLD",8759,"REQB",4,0)
PSO*7.0*322^2
"BLD",8759,"REQB",5,0)
PSO*7.0*382^2
"BLD",8759,"REQB","B","PSO*7.0*206",1)

"BLD",8759,"REQB","B","PSO*7.0*305",2)

"BLD",8759,"REQB","B","PSO*7.0*322",4)

"BLD",8759,"REQB","B","PSO*7.0*382",5)

"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^3021122^3021202^66481
"PKG",206,22,1,"PAH",1,0)
388^3110620^66485
"PKG",206,22,1,"PAH",1,1,0)
^^9^9^3110620
"PKG",206,22,1,"PAH",1,1,1,0)
This patch resolves the following two issues:
"PKG",206,22,1,"PAH",1,1,2,0)
 
"PKG",206,22,1,"PAH",1,1,3,0)
1) Provide users a more accurate description as to as to why a refill is 
"PKG",206,22,1,"PAH",1,1,4,0)
not allowed.
"PKG",206,22,1,"PAH",1,1,5,0)
 
"PKG",206,22,1,"PAH",1,1,6,0)
                                                                   
"PKG",206,22,1,"PAH",1,1,7,0)
 
"PKG",206,22,1,"PAH",1,1,8,0)
2) Correct a misspelling of the word "prescription" in a CPRS pop-up 
"PKG",206,22,1,"PAH",1,1,9,0)
box.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSOATRF")
0^2^B79340036^B77200307
"RTN","PSOATRF",1,0)
PSOATRF ;BIR/MHA - Automate Internet Refill ; 5/23/11 5:00pm
"RTN","PSOATRF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**264,322,388**;DEC 1997;Build 6
"RTN","PSOATRF",3,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOATRF",4,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSOATRF",5,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOATRF",6,0)
 ;
"RTN","PSOATRF",7,0)
START ;
"RTN","PSOATRF",8,0)
 S PSOITMG="",U="^",PSOITNS="PSOATRF"  S:'$G(DT) DT=$$DT^XLFDT
"RTN","PSOATRF",9,0)
 I '$D(^PS(52.43,"AINST")) S PSOITMG="There are no internet refills to process." G END
"RTN","PSOATRF",10,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),U,17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSOUTIL" D EN^DIQ1
"RTN","PSOATRF",11,0)
 S PSOINST=$G(PSOUTIL(4,SITE,99,"I"))
"RTN","PSOATRF",12,0)
 I PSOINST']"" S PSOITMG="The Institution "_SITE_" is not defined in the INSTITUTION file (#4)." G END
"RTN","PSOATRF",13,0)
 S PSXSYS=+$O(^PSX(550,"C",""))_"^"_$G(PSOINST)_"^"_$G(PSOUTIL(4,SITE,.01,"E"))
"RTN","PSOATRF",14,0)
 K SITE,DA,PSOUTIL,DIQ
"RTN","PSOATRF",15,0)
 I $G(PSXSYS) D
"RTN","PSOATRF",16,0)
 . K:($P($G(^PSX(550,+PSXSYS,0)),"^",2)'="A") PSXSYS
"RTN","PSOATRF",17,0)
 . I $$VERSION^XPDUTL("PSO")<7.0 K PSXSYS
"RTN","PSOATRF",18,0)
 I '$O(^XUSEC("PSOAUTRF","")) S PSOITMG="There are no users with PSOAUTRF key, at least one should have this key." G END
"RTN","PSOATRF",19,0)
 I '$D(^PS(52.43,"AINST",PSOINST)) S PSOITMG="There are no internet refills to process for Institution "_PSOINST G END
"RTN","PSOATRF",20,0)
 L +^XTMP(PSOITNS):3 E  S PSOITMG="Automate Internet Refill job is currently running - Try later." G END
"RTN","PSOATRF",21,0)
 K ^XTMP(PSOITNS,$J)
"RTN","PSOATRF",22,0)
 S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOATRF",23,0)
 S (I,J,PSOITDD)=0 F  S I=$O(^PS(59,I)) Q:'I  I '$P($G(^PS(59,I,"I")),U)!(DT<$P($G(^("I")),U)) S J=J+1 D  G:PSOITMG]"" END
"RTN","PSOATRF",24,0)
 . S PSOSITE(I)=I,PSOSNM(I)=$P(^PS(59,I,0),U),PSORFN(I)=$G(^PS(59,I,"RF")),PSOPAR(I)=$G(^PS(59,I,1)),PSOPRPAS(I)=$P($G(PSOPAR),U,7)
"RTN","PSOATRF",25,0)
 . S PSOPAR7(I)=$G(^PS(59,I,"IB")),PSOPINST(I)=$P($G(^PS(59,I,"INI")),U)
"RTN","PSOATRF",26,0)
 . I J=1 D SDIV S PSOITDD=I
"RTN","PSOATRF",27,0)
 I 'J S PSOITMG="There are no active divisions in File #(59) - At least one division should be active - None processed." G END
"RTN","PSOATRF",28,0)
 D PRORF
"RTN","PSOATRF",29,0)
END ;
"RTN","PSOATRF",30,0)
 I $D(^XTMP(PSOITNS,$J)) D SMAIL^PSOATRF1 G:'$G(PSOITC) KV
"RTN","PSOATRF",31,0)
 S PSOITMG(1)=$S($G(PSOITC):"Total internet refills processed = "_PSOITC,PSOITMG="":"There are no internet refills to process.",1:PSOITMG)
"RTN","PSOATRF",32,0)
 D GRP
"RTN","PSOATRF",33,0)
 S:'$O(XMY(0)) XMY(DUZ)=""
"RTN","PSOATRF",34,0)
 S XMDUZ=.5,XMSUB="Outpatient Pharmacy - PSO AUTO REFILL"
"RTN","PSOATRF",35,0)
 S XMTEXT="PSOITMG(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOATRF",36,0)
KV ;
"RTN","PSOATRF",37,0)
 L -^XTMP(PSOITNS) K ^XTMP(PSOITNS)
"RTN","PSOATRF",38,0)
 K DFN,PSODFN,PSODTCUT,PSOITMG,PSOITNF,PSOITNS,PSOITC,PSOITDD,PSOITF,PSOITP,PSOITR
"RTN","PSOATRF",39,0)
 K PSOINST,PSOPAR,PSOPINST,PSOPRPAS,PSOPAR7,PSOPTPST,PSOSITE,PSOSNM,PSOSYS,PSORFN
"RTN","PSOATRF",40,0)
 K DRG,DIVN,PSXSYS,RX,RX0,RXN,VA,ZZ,LC,PSOS,XMY,PSOREA,PSOSTAT,PSOD
"RTN","PSOATRF",41,0)
 Q
"RTN","PSOATRF",42,0)
 ;
"RTN","PSOATRF",43,0)
PRORF ;
"RTN","PSOATRF",44,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X
"RTN","PSOATRF",45,0)
 S PSOITR="",PSOITC=0
"RTN","PSOATRF",46,0)
 F  S PSOITR=$O(^PS(52.43,"AINST",PSOINST,PSOITR)) Q:'PSOITR  D  D:PSOITMG]"" FILE D ULK
"RTN","PSOATRF",47,0)
 . S (PSOITF,PSOITNF)=0,PSOITMG="",PSOITRX=+PSOITR,PSOITP=$O(^PS(52.43,"AINST",PSOINST,PSOITRX,""))
"RTN","PSOATRF",48,0)
 . Q:'PSOITP
"RTN","PSOATRF",49,0)
 . I '$D(^PS(52.43,PSOITP))!($P(^(PSOITP,0),U,5)'="") K ^PS(52.43,"AINST",PSOINST,PSOITRX,PSOITP) Q
"RTN","PSOATRF",50,0)
 . I '$D(^PSRX(PSOITRX,0))!($P(^(0),U)="")!('$D(^(2)))!($P(^("STA"),U)=13) S PSOITNF=1,PSOITMG="Rx IEN "_PSOITRX_" not in file (#52)/Incomplete/Deleted" Q
"RTN","PSOATRF",51,0)
 . D PSOL^PSSLOCK(PSOITRX) I '$G(PSOMSG) K PSOMSG Q
"RTN","PSOATRF",52,0)
 . K PSOMSG
"RTN","PSOATRF",53,0)
 . S PSOITRX0=^PSRX(PSOITRX,0),PSOITRX2=^(2),PSOITRX3=^(3),PSOITRXS=^("STA")
"RTN","PSOATRF",54,0)
 . S (DFN,PSODFN)=$P(PSOITRX0,U,2),RXN=$P(PSOITRX0,U),DRG=$P(PSOITRX0,U,6)
"RTN","PSOATRF",55,0)
 . I PSODFN'=$P(^PS(52.43,PSOITP,0),U,9) D  Q
"RTN","PSOATRF",56,0)
 . . S PSOITNF=1,PSOITMG="Can't refill Rx # "_RXN_", it is not for this patient. DFN in file #52="_DFN_", DFN in file #52.43="_$P(^PS(52.43,PSOITP,0),U,9)
"RTN","PSOATRF",57,0)
 . D GET^PSOPTPST
"RTN","PSOATRF",58,0)
 . I $G(PSOPTPST(2,PSODFN,.351))]"" S PSOITNF=1,PSOITMG="Patient Died on "_PSOPTPST(2,PSODFN,.351) Q
"RTN","PSOATRF",59,0)
 . D ICN^PSODPT(DFN)
"RTN","PSOATRF",60,0)
 . S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),U,6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOATRF",61,0)
 . I '$P(PSOPAR,U,11),$G(^PSDRUG(DRG,"I"))]"",DT>$G(^("I")) D  Q
"RTN","PSOATRF",62,0)
 . . S PSOITNF=1,PSOITMG="Drug is inactive for Rx # "_RXN_" cannot be refilled"
"RTN","PSOATRF",63,0)
 . S I=$P(^PSRX(PSOITRX,2),U,9) S:'I I=PSOITDD D SDIV
"RTN","PSOATRF",64,0)
 . ;
"RTN","PSOATRF",65,0)
 . I $G(PSOBDIV) D  Q
"RTN","PSOATRF",66,0)
 . . S PSOITNF=1
"RTN","PSOATRF",67,0)
 . . S PSOITMG="Inactive division for Rx # "_RXN_".  Cannot refill."
"RTN","PSOATRF",68,0)
 . . K PSOBDIV
"RTN","PSOATRF",69,0)
 . ;
"RTN","PSOATRF",70,0)
 . I $G(PSOPTPST(2,PSODFN,.1))]"",'PSORFN S PSOITNF=1,PSOITMG="Patient is an Inpatient on Ward "_PSOPTPST(2,PSODFN,.1) Q
"RTN","PSOATRF",71,0)
 . I $G(PSOPTPST(2,PSODFN,148))="YES",'$P(PSORFN,U,2) S PSOITNF=1,PSOITMG="Patient is in a Contract Nursing Home" Q
"RTN","PSOATRF",72,0)
 . D CHKRF Q:PSOITNF
"RTN","PSOATRF",73,0)
 . I $O(^PS(52.5,"B",PSOITRX,0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOITRX,0)),"P")) S PSOITNF=1,PSOITMG="Rx is in suspense and cannot be refilled" Q
"RTN","PSOATRF",74,0)
 . S PSOY=1+$$LSTRFL^PSOBPSU1(PSOITRX)
"RTN","PSOATRF",75,0)
 . I PSOY>$P(PSOITRX0,U,9) S PSOITNF=1,PSOITMG="Can't refill, no refills remaining" Q
"RTN","PSOATRF",76,0)
 . S (PSOITF,PSOX("NUMBER"))=PSOY
"RTN","PSOATRF",77,0)
 . S PSOX("RX0")=PSOITRX0,PSOX("RX2")=PSOITRX2,PSOX("RX3")=PSOITRX3,PSOX("STA")=PSOITRXS
"RTN","PSOATRF",78,0)
 . S DRG=$P(PSOITRX0,U,6)
"RTN","PSOATRF",79,0)
 . N PSODEA,PSODAY,PSOCHECK
"RTN","PSOATRF",80,0)
 . S PSODEA=$P($G(^PSDRUG(DRG,0)),U,3)
"RTN","PSOATRF",81,0)
 . S PSODAY=$P(PSOITRX0,U,8)
"RTN","PSOATRF",82,0)
 . S PSOCHECK=$$DEACHK^PSOUTLA1(PSOITRX,PSODEA,PSODAY)
"RTN","PSOATRF",83,0)
 . I PSOCHECK S PSOITNF=1 D  Q
"RTN","PSOATRF",84,0)
 . . I PSOCHECK=1 S PSOITMG="Requested refill exceeds maximum allowable days supply for Rx." Q  ;*388
"RTN","PSOATRF",85,0)
 . . S PSOITMG="Current drug DEA/SPECIAL HANDLING code does not allow refills."  ;*388
"RTN","PSOATRF",86,0)
 . D CHKDT Q:PSOITNF
"RTN","PSOATRF",87,0)
 . D EN^PSOR52(.PSOX) I PSOITF,$D(^PSRX(PSOITRX,1,PSOITF,0)) S PSOITC=PSOITC+1,PSOITMG=PSOITF_" Susp. until "_$$DSP($P(^(0),U))
"RTN","PSOATRF",88,0)
 Q
"RTN","PSOATRF",89,0)
 ;
"RTN","PSOATRF",90,0)
CHKRF ;
"RTN","PSOATRF",91,0)
 D ^PSOBUILD
"RTN","PSOATRF",92,0)
 I '$G(PSOSD) S PSOITNF=1,PSOITMG="This patient has no prescriptions" Q
"RTN","PSOATRF",93,0)
 S (PSOX,PSOY,PSOS)="",PSOX("STA")=PSOITRXS
"RTN","PSOATRF",94,0)
 F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  D
"RTN","PSOATRF",95,0)
 . I PSOITRX=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $P(PSOY,U,4)]"" D
"RTN","PSOATRF",96,0)
 . . S PSOITNF=1,PSOITMG="Cannot refill Rx # "_RXN
"RTN","PSOATRF",97,0)
 . . S PSOREA=$P(PSOY,U,4),PSOSTAT=PSOX("STA")
"RTN","PSOATRF",98,0)
 . . I PSOREA["Z" S:PSOSTAT=4 PSOSTAT=1 D  Q
"RTN","PSOATRF",99,0)
 . . . S PSOA=";"_PSOSTAT
"RTN","PSOATRF",100,0)
 . . . D STATUS^PSODI(52,100,"PSOB")
"RTN","PSOATRF",101,0)
 . . . S PSOA=$F(PSOB("POINTER"),PSOA)
"RTN","PSOATRF",102,0)
 . . . S PSOA=$P($E(PSOB("POINTER"),PSOA,999),";",1)
"RTN","PSOATRF",103,0)
 . . . S PSOITMG=PSOITMG_" Rx is in "_$P(PSOA,":",2)_" status"
"RTN","PSOATRF",104,0)
 . . . K PSOA,PSOB
"RTN","PSOATRF",105,0)
 . . I PSOREA["M" S PSOITMG=PSOITMG_" Drug no longer used by Outpatient Pharmacy" Q
"RTN","PSOATRF",106,0)
 . . I PSOREA["B" S PSOITMG=PSOITMG_" Narcotic Drug" Q
"RTN","PSOATRF",107,0)
 . . I PSOREA["C" S PSOITMG=PSOITMG_" Non-Renewable Drug" Q
"RTN","PSOATRF",108,0)
 . . I PSOREA["D" S PSOITMG=PSOITMG_" Non-Renewable Patient Status" Q
"RTN","PSOATRF",109,0)
 . . I PSOREA["E" S PSOITMG=PSOITMG_" Non-Verified Rx" Q
"RTN","PSOATRF",110,0)
 . . I PSOREA["G",PSOREA'["B" S PSOITMG=PSOITMG_" No more refills left"
"RTN","PSOATRF",111,0)
 I PSOY="" S PSOITNF=1,PSOITMG="Cannot refill, Rx is DC/Exp. Later Rx may exist " D
"RTN","PSOATRF",112,0)
 . S (PSOS,PSOX)="",PSOD=$P(^PSDRUG($P(PSOITRX0,U,6),0),U)
"RTN","PSOATRF",113,0)
 . N ZRX S ZRX="" F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  I PSOD=PSOX,+PSOSD(PSOS,PSOX) S ZRX=$P($G(^PSRX(+PSOSD(PSOS,PSOX),0)),U)
"RTN","PSOATRF",114,0)
 . S PSOITMG=PSOITMG_ZRX
"RTN","PSOATRF",115,0)
 Q
"RTN","PSOATRF",116,0)
  ;
"RTN","PSOATRF",117,0)
FILE ;
"RTN","PSOATRF",118,0)
 K DIE S DA=PSOITP
"RTN","PSOATRF",119,0)
 S DIE="^PS(52.43,",DR="5////"_DT_";6///"_$S(PSOITNF:"NOT ",1:"")_"FILLED;10////"_PSOITMG D ^DIE
"RTN","PSOATRF",120,0)
 K ^PS(52.43,"AINST",PSOINST,PSOITRX,DA) I PSOITNF  S ^XTMP(PSOITNS,$J,PSOSITE,DFN,PSOITRX)=PSOITMG
"RTN","PSOATRF",121,0)
 Q
"RTN","PSOATRF",122,0)
 ;
"RTN","PSOATRF",123,0)
GRP ;
"RTN","PSOATRF",124,0)
 S MDUZ=0
"RTN","PSOATRF",125,0)
 I '$D(^XUSEC("PSOAUTRF")) D  Q
"RTN","PSOATRF",126,0)
 . F  S MDUZ=$O(^XUSEC("PSORPH",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRF",127,0)
 F  S MDUZ=$O(^XUSEC("PSOAUTRF",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRF",128,0)
 K MDUZ Q
"RTN","PSOATRF",129,0)
 ;
"RTN","PSOATRF",130,0)
ULK ;
"RTN","PSOATRF",131,0)
 I '$G(PSOITRX) Q
"RTN","PSOATRF",132,0)
 D PSOUL^PSSLOCK(PSOITRX)
"RTN","PSOATRF",133,0)
 K PSOITRX,PSOSD,PSOX,PSORX,PSOITRX0,PSOITRX2,PSOITRX3,PSOITRXS
"RTN","PSOATRF",134,0)
 Q
"RTN","PSOATRF",135,0)
SETUP ;
"RTN","PSOATRF",136,0)
 I '$D(^XUSEC("PSOAUTRF",DUZ)) W !,"You must hold the PSOAUTRF key to run this option!" Q
"RTN","PSOATRF",137,0)
 N PATCH,JOBN
"RTN","PSOATRF",138,0)
 S JOBN="PSO AUTO REFILL"
"RTN","PSOATRF",139,0)
 L +^XTMP("PSOATRF"):5 I '$T D  Q
"RTN","PSOATRF",140,0)
 .D BMES^XPDUTL("The Refill Automation job is currently running, try later.")
"RTN","PSOATRF",141,0)
 .D MES^XPDUTL("")
"RTN","PSOATRF",142,0)
 .S DIR(0)="E",DIR("A")=" Press ENTER to Continue" D ^DIR K DIR
"RTN","PSOATRF",143,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO AUTO REFILL" D ^DIC
"RTN","PSOATRF",144,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AUTO REFILL") G EX
"RTN","PSOATRF",145,0)
 D RESCH^XUTMOPT("PSO AUTO REFILL","","","24H","L"),EDIT^XUTMOPT("PSO AUTO REFILL") K DIC,Y,X
"RTN","PSOATRF",146,0)
EX ;
"RTN","PSOATRF",147,0)
 L -^XTMP("PSOATRF") K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,X
"RTN","PSOATRF",148,0)
 Q
"RTN","PSOATRF",149,0)
 ;
"RTN","PSOATRF",150,0)
SDIV ;
"RTN","PSOATRF",151,0)
 S PSOSITE=$G(PSOSITE(I)) I 'PSOSITE S PSOSITE=I,PSOBDIV=1 Q
"RTN","PSOATRF",152,0)
 S PSOPAR=PSOPAR(I),PSOPRPAS=PSOPRPAS(I),PSORFN=PSORFN(I)
"RTN","PSOATRF",153,0)
 S PSOPAR7=PSOPAR7(I),PSOPINST=PSOPINST(I)
"RTN","PSOATRF",154,0)
 Q
"RTN","PSOATRF",155,0)
 ;
"RTN","PSOATRF",156,0)
CHKDT ;
"RTN","PSOATRF",157,0)
 S PSOX("IRXN")=PSOITRX
"RTN","PSOATRF",158,0)
 S PSOX("MAIL/WINDOW")="M",PSOX("FLD")=2,PSOX("QS")="S"
"RTN","PSOATRF",159,0)
 S PSOX("FIELD")=0,(PSORX("FILL DATE"),PSOX("FILL DATE"))=DT,PSOX("FLD")=1,X1=DT,X2=-180
"RTN","PSOATRF",160,0)
 D C^%DTC S PSOX("ISSUE DATE")=X,PSOX("CLERK CODE")=DUZ
"RTN","PSOATRF",161,0)
 S PSOX("STOP DATE")=$P(PSOITRX2,U,6) D NEXT
"RTN","PSOATRF",162,0)
 I PSOX("FILL DATE")<$P(PSOITRX3,U,2) D SUSDATE^PSOUTIL(.PSOX)
"RTN","PSOATRF",163,0)
 I PSOX("FILL DATE")>PSOX("STOP DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",164,0)
 .S PSOITMG="Can't refill, Refill Date "_$$DSP(PSOX("FILL DATE"))
"RTN","PSOATRF",165,0)
 .S PSOITMG=PSOITMG_" is past Expiration Date "_$$DSP(PSOX("STOP DATE"))
"RTN","PSOATRF",166,0)
 S PSOX("LAST REFILL DATE")=$P(PSOITRX3,U,1)
"RTN","PSOATRF",167,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")=PSOX("LAST REFILL DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",168,0)
 .S PSOITMG="Can't refill, Fill Date already exists for "_$$DSP(PSOX("FILL DATE"))
"RTN","PSOATRF",169,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")<PSOX("LAST REFILL DATE") S PSOITNF=1 D  Q
"RTN","PSOATRF",170,0)
 .S PSOITMG="Can't refill, later Refill Date already exists for "_$$DSP(PSOX("LAST REFILL DATE"))
"RTN","PSOATRF",171,0)
 Q
"RTN","PSOATRF",172,0)
 ;
"RTN","PSOATRF",173,0)
NEXT ;
"RTN","PSOATRF",174,0)
 S PSOX1=$P(PSOITRX2,U,2)
"RTN","PSOATRF",175,0)
 I '$O(^PSRX(PSOITRX,1,0)) D  Q
"RTN","PSOATRF",176,0)
 . S $P(PSOITRX3,U)=PSOX1,X1=PSOX1
"RTN","PSOATRF",177,0)
 . S X2=$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",178,0)
 . D C^%DTC
"RTN","PSOATRF",179,0)
 . S:'$P(PSOITRX3,U,8) $P(PSOITRX3,U,2)=X K X
"RTN","PSOATRF",180,0)
 S PSOY2=0
"RTN","PSOATRF",181,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSOITRX,1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOATRF",182,0)
 S PSOY=^PSRX(PSOITRX,1,PSOY1,0)
"RTN","PSOATRF",183,0)
 S PSOX2=$P(PSOY,U)
"RTN","PSOATRF",184,0)
 S $P(PSOITRX3,U)=PSOX2,X1=PSOX2
"RTN","PSOATRF",185,0)
 S X2=$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",186,0)
 D C^%DTC S PSOY3=X
"RTN","PSOATRF",187,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSOITRX0,U,8)-10\1
"RTN","PSOATRF",188,0)
 D C^%DTC S PSOY4=X
"RTN","PSOATRF",189,0)
 S $P(PSOITRX3,U,2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOATRF",190,0)
 K X,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOATRF",191,0)
 Q
"RTN","PSOATRF",192,0)
 ;
"RTN","PSOATRF",193,0)
DSP(X) ;
"RTN","PSOATRF",194,0)
 Q:'X ""
"RTN","PSOATRF",195,0)
 Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","PSOATRF",196,0)
 ; 
"RTN","PSOATRFC")
0^3^B45655839^B44210974
"RTN","PSOATRFC",1,0)
PSOATRFC ;BIR/MHA - Automate CPRS Refill request ; 5/25/11 4:48pm
"RTN","PSOATRFC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**305,388**;DEC 1997;Build 6
"RTN","PSOATRFC",3,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOATRFC",4,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSOATRFC",5,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOATRFC",6,0)
 ;
"RTN","PSOATRFC",7,0)
REF(PSORXN,PSOITMG) ;process refill request
"RTN","PSOATRFC",8,0)
 N DFN,PSODFN,PSODTCUT,PSOITNS,PSOITDD,PSOITNF,PSOITF,DIV
"RTN","PSOATRFC",9,0)
 N PSOITP,PSOITR,PSOINST,PSOPAR,PSOPINST,PSOPRPAS,PSOPAR7,PSOPTPST
"RTN","PSOATRFC",10,0)
 N PSOSITE,PSOSNM,PSOSYS,PSORFN,PSOREA,PSOSTAT,PSOD,PSOS,DRG,DIVN
"RTN","PSOATRFC",11,0)
 N PSXSYS,RX,RX0,RXN,VA,ZZ,LC,XMY,PSORXN0,PSORXN2,PSORXN3,PSORXNS
"RTN","PSOATRFC",12,0)
 ;
"RTN","PSOATRFC",13,0)
 S (DIV,PSOSITE)=$P(^PSRX(PSORXN,2),"^",9)
"RTN","PSOATRFC",14,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),U,17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSOUTIL" D EN^DIQ1
"RTN","PSOATRFC",15,0)
 S PSOINST=$G(PSOUTIL(4,SITE,99,"I"))
"RTN","PSOATRFC",16,0)
 S PSOPAR=$G(^PS(59,DIV,1)),PSORFN=$G(^PS(59,DIV,"RF")),PSOITNF=0
"RTN","PSOATRFC",17,0)
 S PSXSYS=+$O(^PSX(550,"C",""))_"^"_$G(PSOINST)_"^"_$G(PSOUTIL(4,SITE,.01,"E"))
"RTN","PSOATRFC",18,0)
 I $G(PSXSYS) D
"RTN","PSOATRFC",19,0)
 . K:($P($G(^PSX(550,+PSXSYS,0)),"^",2)'="A") PSXSYS
"RTN","PSOATRFC",20,0)
 . I $$VERSION^XPDUTL("PSO")<7.0 K PSXSYS
"RTN","PSOATRFC",21,0)
 S PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOATRFC",22,0)
 ;
"RTN","PSOATRFC",23,0)
 I '$D(^PSRX(PSORXN,0))!($P(^(0),U)="")!('$D(^(2)))!($P(^("STA"),U)=13) D  Q
"RTN","PSOATRFC",24,0)
 . D ERR("Rx IEN "_PSORXN_" not in file (#52)/Incomplete/Deleted")
"RTN","PSOATRFC",25,0)
 S PSORXN0=^PSRX(PSORXN,0),PSORXN2=^(2),PSORXN3=^(3),PSORXNS=^("STA")
"RTN","PSOATRFC",26,0)
 S (DFN,PSODFN)=$P(PSORXN0,U,2),RXN=$P(PSORXN0,U),DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",27,0)
 D GET^PSOPTPST
"RTN","PSOATRFC",28,0)
 I $G(PSOPTPST(2,PSODFN,.351))]"" D  Q
"RTN","PSOATRFC",29,0)
 . D ERR("Patient Died on "_PSOPTPST(2,PSODFN,.351))
"RTN","PSOATRFC",30,0)
 D ICN^PSODPT(DFN)
"RTN","PSOATRFC",31,0)
 S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),U,6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOATRFC",32,0)
 I '$P(PSOPAR,U,11),$G(^PSDRUG(DRG,"I"))]"",DT>$G(^("I")) D  Q
"RTN","PSOATRFC",33,0)
 . D ERR("Drug is inactive for Rx # "_RXN_" cannot be refilled")
"RTN","PSOATRFC",34,0)
 I $G(PSOPTPST(2,PSODFN,.1))]"",'PSORFN D  Q
"RTN","PSOATRFC",35,0)
 . D ERR("Patient is an Inpatient on Ward "_PSOPTPST(2,PSODFN,.1))
"RTN","PSOATRFC",36,0)
 I $G(PSOPTPST(2,PSODFN,148))="YES",'$P(PSORFN,U,2) D  Q
"RTN","PSOATRFC",37,0)
 . D ERR("Patient is in a Contract Nursing Home")
"RTN","PSOATRFC",38,0)
 D CHKRF Q:PSOITNF           ;Quit if RX not refillable
"RTN","PSOATRFC",39,0)
 ;
"RTN","PSOATRFC",40,0)
 ;more checks
"RTN","PSOATRFC",41,0)
 I $O(^PS(52.5,"B",PSORXN,0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSORXN,0)),"P")) D  Q
"RTN","PSOATRFC",42,0)
 . D ERR("Rx is in suspense and cannot be refilled")
"RTN","PSOATRFC",43,0)
 S PSOY=1+$$LSTRFL^PSOBPSU1(PSORXN)
"RTN","PSOATRFC",44,0)
 I PSOY>$P(PSORXN0,U,9) D  Q
"RTN","PSOATRFC",45,0)
 . D ERR("Can't refill, no refills remaining")
"RTN","PSOATRFC",46,0)
 S (PSOITF,PSOX("NUMBER"))=PSOY
"RTN","PSOATRFC",47,0)
 S PSOX("RX0")=PSORXN0,PSOX("RX2")=PSORXN2,PSOX("RX3")=PSORXN3,PSOX("STA")=PSORXNS
"RTN","PSOATRFC",48,0)
 S DRG=$P(PSORXN0,U,6)
"RTN","PSOATRFC",49,0)
 N PSODEA,PSODAY,PSOCHECK
"RTN","PSOATRFC",50,0)
 S PSODEA=$P($G(^PSDRUG(DRG,0)),U,3)
"RTN","PSOATRFC",51,0)
 S PSODAY=$P(PSORXN0,U,8)
"RTN","PSOATRFC",52,0)
 S PSOCHECK=$$DEACHK^PSOUTLA1(PSORXN,PSODEA,PSODAY)
"RTN","PSOATRFC",53,0)
 I PSOCHECK=1 D ERR("Requested refill exceeds maximum allowable days supply for Rx.") Q  ;*388
"RTN","PSOATRFC",54,0)
 I PSOCHECK=2 D ERR("Current drug DEA/SPECIAL HANDLING code does not allow refills.") Q  ;*388
"RTN","PSOATRFC",55,0)
 D CHKDT Q:PSOITNF           ;Quit if not refillable
"RTN","PSOATRFC",56,0)
 ;
"RTN","PSOATRFC",57,0)
 ;ok to process refill
"RTN","PSOATRFC",58,0)
 D EN^PSOR52(.PSOX)
"RTN","PSOATRFC",59,0)
 ;add additional activity log comment to refill just added
"RTN","PSOATRFC",60,0)
 I PSOITF,$D(^PSRX(PSORXN,1,PSOITF,0)) D
"RTN","PSOATRFC",61,0)
 . N AL,DONE,PSOFDA
"RTN","PSOATRFC",62,0)
 . S AL="",DONE=0
"RTN","PSOATRFC",63,0)
 . F  S AL=$O(^PSRX(PSORXN,"A",AL),-1) Q:'AL  D  Q:DONE
"RTN","PSOATRFC",64,0)
 . . Q:$P(^PSRX(PSORXN,"A",AL,0),U,4)'=PSOITF
"RTN","PSOATRFC",65,0)
 . . S PSOFDA(52.34,"+3,"_AL_","_PSORXN_",",.01)="CPRS Auto Refill"
"RTN","PSOATRFC",66,0)
 . . D UPDATE^DIE("","PSOFDA")
"RTN","PSOATRFC",67,0)
 . . S DONE=1
"RTN","PSOATRFC",68,0)
 Q
"RTN","PSOATRFC",69,0)
 ;
"RTN","PSOATRFC",70,0)
CHKRF ;check precription if still refillable
"RTN","PSOATRFC",71,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOATRFC",72,0)
 D ^PSOBUILD
"RTN","PSOATRFC",73,0)
 I '$G(PSOSD) D  Q
"RTN","PSOATRFC",74,0)
 .  D ERR("This patient has no prescriptions")
"RTN","PSOATRFC",75,0)
 S (PSOX,PSOY,PSOS)="",PSOX("STA")=PSORXNS
"RTN","PSOATRFC",76,0)
 F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX']""  D
"RTN","PSOATRFC",77,0)
 . I PSORXN=+PSOSD(PSOS,PSOX) S PSOY=PSOSD(PSOS,PSOX) I $P(PSOY,U,4)]"" D
"RTN","PSOATRFC",78,0)
 . . D ERR("Cannot refill Rx # "_RXN)
"RTN","PSOATRFC",79,0)
 . . S PSOREA=$P(PSOY,U,4),PSOSTAT=PSOX("STA")
"RTN","PSOATRFC",80,0)
 . . I PSOREA["Z" S:PSOSTAT=4 PSOSTAT=1 D  Q
"RTN","PSOATRFC",81,0)
 . . . S PSOA=";"_PSOSTAT,PSOB=$P(^DD(52,100,0),U,3)
"RTN","PSOATRFC",82,0)
 . . . S PSOA=$F(PSOB,PSOA),PSOA=$P($E(PSOB,PSOA,999),";",1)
"RTN","PSOATRFC",83,0)
 . . . D ERR(" Rx is in "_$P(PSOA,":",2)_" status")
"RTN","PSOATRFC",84,0)
 . . . K PSOA,PSOB
"RTN","PSOATRFC",85,0)
 . . I PSOREA["M" D ERR("Drug no longer used by Outpatient Pharmacy") Q
"RTN","PSOATRFC",86,0)
 . . I PSOREA["B" D ERR("Narcotic Drug") Q
"RTN","PSOATRFC",87,0)
 . . I PSOREA["C" D ERR("Non-Renewable Drug") Q
"RTN","PSOATRFC",88,0)
 . . I PSOREA["D" D ERR("Non-Renewable Patient Status") Q
"RTN","PSOATRFC",89,0)
 . . I PSOREA["E" D ERR("Non-Verified Rx") Q
"RTN","PSOATRFC",90,0)
 . . I PSOREA["G",PSOREA'["B" D ERR("No more refills left")
"RTN","PSOATRFC",91,0)
 I PSOY="" D ERR("Cannot refill, Rx is DC/Exp. Later Rx may exist") D
"RTN","PSOATRFC",92,0)
 . S (PSOS,PSOX)="",PSOD=$P(^PSDRUG($P(PSORXN0,U,6),0),U)
"RTN","PSOATRFC",93,0)
 . N ZRX S ZRX=""
"RTN","PSOATRFC",94,0)
 . F  S PSOS=$O(PSOSD(PSOS)) Q:PSOS=""  D
"RTN","PSOATRFC",95,0)
 . . F  S PSOX=$O(PSOSD(PSOS,PSOX)) Q:PSOX=""  D
"RTN","PSOATRFC",96,0)
 . . . I PSOD=PSOX,+PSOSD(PSOS,PSOX) S ZRX=$P($G(^PSRX(+PSOSD(PSOS,PSOX),0)),U)
"RTN","PSOATRFC",97,0)
 . D ERR(ZRX)
"RTN","PSOATRFC",98,0)
 Q
"RTN","PSOATRFC",99,0)
 ;
"RTN","PSOATRFC",100,0)
CHKDT ;check date on this refill request
"RTN","PSOATRFC",101,0)
 N X1,X2
"RTN","PSOATRFC",102,0)
 S PSOX("IRXN")=PSORXN
"RTN","PSOATRFC",103,0)
 S PSOX("MAIL/WINDOW")="M",PSOX("FLD")=2,PSOX("QS")="S"
"RTN","PSOATRFC",104,0)
 S PSOX("FIELD")=0,(PSORX("FILL DATE"),PSOX("FILL DATE"))=DT,PSOX("FLD")=1,X1=DT,X2=-180
"RTN","PSOATRFC",105,0)
 D C^%DTC S PSOX("ISSUE DATE")=X,PSOX("CLERK CODE")=DUZ
"RTN","PSOATRFC",106,0)
 S PSOX("STOP DATE")=$P(PSORXN2,U,6) D NEXT
"RTN","PSOATRFC",107,0)
 I PSOX("FILL DATE")<$P(PSORXN3,U,2) D SUSDATE^PSOUTIL(.PSOX)
"RTN","PSOATRFC",108,0)
 I PSOX("FILL DATE")>PSOX("STOP DATE") D  Q
"RTN","PSOATRFC",109,0)
 . D ERR("Can't refill, Refill Date "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",110,0)
 . D ERR("is past Expiration Date "_$$DSP(PSOX("STOP DATE")))
"RTN","PSOATRFC",111,0)
 S PSOX("LAST REFILL DATE")=$P(PSORXN3,U,1)
"RTN","PSOATRFC",112,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")=PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",113,0)
 . D ERR("Can't refill, Fill Date already exists for "_$$DSP(PSOX("FILL DATE")))
"RTN","PSOATRFC",114,0)
 I PSOX("LAST REFILL DATE"),PSOX("FILL DATE")<PSOX("LAST REFILL DATE") D  Q
"RTN","PSOATRFC",115,0)
 . D ERR("Can't refill, later Refill Date already exists for "_$$DSP(PSOX("LAST REFILL DATE")))
"RTN","PSOATRFC",116,0)
 Q
"RTN","PSOATRFC",117,0)
 ;
"RTN","PSOATRFC",118,0)
NEXT ;
"RTN","PSOATRFC",119,0)
 S PSOX1=$P(PSORXN2,U,2)
"RTN","PSOATRFC",120,0)
 I '$O(^PSRX(PSORXN,1,0)) D  Q
"RTN","PSOATRFC",121,0)
 . S $P(PSORXN3,U)=PSOX1,X1=PSOX1
"RTN","PSOATRFC",122,0)
 . S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",123,0)
 . D C^%DTC
"RTN","PSOATRFC",124,0)
 . S:'$P(PSORXN3,U,8) $P(PSORXN3,U,2)=X K X
"RTN","PSOATRFC",125,0)
 S PSOY2=0
"RTN","PSOATRFC",126,0)
 F PSOY=0:0 S PSOY=$O(^PSRX(PSORXN,1,PSOY)) Q:'PSOY  S PSOY1=PSOY,PSOY2=PSOY2+1
"RTN","PSOATRFC",127,0)
 S PSOY=^PSRX(PSORXN,1,PSOY1,0)
"RTN","PSOATRFC",128,0)
 S PSOX2=$P(PSOY,U)
"RTN","PSOATRFC",129,0)
 S $P(PSORXN3,U)=PSOX2,X1=PSOX2
"RTN","PSOATRFC",130,0)
 S X2=$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",131,0)
 D C^%DTC S PSOY3=X
"RTN","PSOATRFC",132,0)
 S X1=PSOX1,X2=(PSOY2+1)*$P(PSORXN0,U,8)-10\1
"RTN","PSOATRFC",133,0)
 D C^%DTC S PSOY4=X
"RTN","PSOATRFC",134,0)
 S $P(PSORXN3,U,2)=$S(PSOY3<PSOY4:PSOY4,1:PSOY3)
"RTN","PSOATRFC",135,0)
 K X,X1,X2,PSOX1,PSOX2,PSOY,PSOY1,PSOY2,PSOY3,PSOY4
"RTN","PSOATRFC",136,0)
 Q
"RTN","PSOATRFC",137,0)
 ;
"RTN","PSOATRFC",138,0)
DSP(X) ;
"RTN","PSOATRFC",139,0)
 Q:'X ""
"RTN","PSOATRFC",140,0)
 Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","PSOATRFC",141,0)
 ;
"RTN","PSOATRFC",142,0)
ERR(TXT) ;Build error text array
"RTN","PSOATRFC",143,0)
 ;  add TXT to end of last line in array, if will fit, else
"RTN","PSOATRFC",144,0)
 ;     add it as a new last line and indented 3.
"RTN","PSOATRFC",145,0)
 ;  and set error flag
"RTN","PSOATRFC",146,0)
 N II S II=$O(PSOITMG(""),-1) S:'II II=1
"RTN","PSOATRFC",147,0)
 S PSOITNF=1
"RTN","PSOATRFC",148,0)
 I $L($G(PSOITMG(II)))+$L(TXT)>79 D
"RTN","PSOATRFC",149,0)
 . S PSOITMG(II+1)="   "_TXT
"RTN","PSOATRFC",150,0)
 E  D
"RTN","PSOATRFC",151,0)
 . S PSOITMG(II)=$G(PSOITMG(II))_" "_TXT
"RTN","PSOATRFC",152,0)
 Q
"RTN","PSOATRFC",153,0)
 ;
"RTN","PSOATRFC",154,0)
MAILMSG(DFN,RXN,ERRTXT) ;send alert via mailman msg to PSOAUTRF key holders
"RTN","PSOATRFC",155,0)
 N MDUZ,XMDUZ,XMTEXT,XMSUB,PTNAME,PTSSN,DIV,DIVN
"RTN","PSOATRFC",156,0)
 D DEM^VADPT
"RTN","PSOATRFC",157,0)
 S PTNAME=$P(VADM(1),"^"),PTSSN=$P($P(VADM(2),"^",2),"-",3) K VADM
"RTN","PSOATRFC",158,0)
 S DIV=$$RXSITE^PSOBPSUT(RXN,0),DIVN=$P($G(^PS(59,DIV,0)),"^")
"RTN","PSOATRFC",159,0)
 S MDUZ=0
"RTN","PSOATRFC",160,0)
 F  S MDUZ=$O(^XUSEC("PSOAUTRF",MDUZ)) Q:MDUZ'>0  S XMY(MDUZ)=""
"RTN","PSOATRFC",161,0)
 S XMDUZ=.5,XMSUB=DIVN_" CPRS AUTO REFILL - Not Processed List"
"RTN","PSOATRFC",162,0)
 S ERRTXT(.1)="CPRS requested an Outpatient refill, but not allowed for the below reason:"
"RTN","PSOATRFC",163,0)
 S ERRTXT(.2)=""
"RTN","PSOATRFC",164,0)
 S ERRTXT(.3)="   Patient: "_PTNAME_" ("_PTSSN_")"
"RTN","PSOATRFC",165,0)
 S ERRTXT(.4)="      Rx #: "_$$GET1^DIQ(52,RXN,.01)
"RTN","PSOATRFC",166,0)
 S ERRTXT(.5)="      Drug: "_$$GET1^DIQ(52,RXN,6)
"RTN","PSOATRFC",167,0)
 S ERRTXT(.6)=""
"RTN","PSOATRFC",168,0)
 S XMTEXT="ERRTXT(" N DIFROM
"RTN","PSOATRFC",169,0)
 D ^XMD
"RTN","PSOATRFC",170,0)
 Q
"RTN","PSOREF0")
0^4^B38701454^B37449897
"RTN","PSOREF0",1,0)
PSOREF0 ;IHS/JCM - REFILL CON'T ; 6/17/11 6:02pm
"RTN","PSOREF0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,152,180,186,204,306,382,388**;DEC 1997;Build 6
"RTN","PSOREF0",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOREF0",4,0)
 ;
"RTN","PSOREF0",5,0)
 ;PSO*186 add check for DEA Special handling field refill restrictions
"RTN","PSOREF0",6,0)
PROCESS ;
"RTN","PSOREF0",7,0)
 K PSODF S PSOREF("RX0")=^PSRX(PSOREF("IRXN"),0),PSOREF("RX2")=^(2),PSOREF("RX3")=^(3),PSOREF("STA")=+$G(^("STA")),PSOREF("SIG")=$P($G(^("SIG")),"^"),PSOREF("PSODFN")=$P(PSOREF("RX0"),"^",2)
"RTN","PSOREF0",8,0)
 S PSOREF("DAYS SUPPLY")=$P(PSOREF("RX0"),"^",8)
"RTN","PSOREF0",9,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSOREF("PSODFN") D NEWPT
"RTN","PSOREF0",10,0)
 W !,"Now refilling Rx# ",$P(PSOREF("RX0"),"^")_"   Drug: "_$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^")
"RTN","PSOREF0",11,0)
 K ZD(PSOREF("IRXN"))   ;*306
"RTN","PSOREF0",12,0)
 S PSOREF("DFLG")=0 D DSPLY G:PSOREF("DFLG") PROCESSX
"RTN","PSOREF0",13,0)
 I $G(PSOHRC) S PSOREF("QS")="S",PSOREF("MAIL/WINDOW")="M",PSORX("MAIL/WINDOW")="M",PSOHRCF=1 K VALMHDR
"RTN","PSOREF0",14,0)
 D CHECK G:$G(PSODF) PROCESS G:PSOREF("DFLG") PROCESSX D EN^PSOR52(.PSOREF)
"RTN","PSOREF0",15,0)
 S:$G(PSOREF("MAIL/WINDOW"))["W" BINGRTE="W",BINGCRT=1
"RTN","PSOREF0",16,0)
PROCESSX D:$G(PSOREF("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSOREF)
"RTN","PSOREF0",17,0)
 Q
"RTN","PSOREF0",18,0)
DSPLY ;W !!,$P(PSOREF("RX0"),"^"),?12," ",$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^"),?45," SIG: "_PSOREF("SIG"),?60," QTY: ",$P(PSOREF("RX0"),"^",7)
"RTN","PSOREF0",19,0)
 K FSIG,BSIG I $P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D FSIG^PSOUTLA("R",PSOREF("IRXN"),54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOREF0",20,0)
 K FSIG,PSREV I '$P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D EN2^PSOUTLA1(PSOREF("IRXN"),54)
"RTN","PSOREF0",21,0)
 W !!,"Qty: ",$P(PSOREF("RX0"),"^",7),?19,"Sig: ",$G(BSIG(1))
"RTN","PSOREF0",22,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOREF0",23,0)
 K BSIG,PSREV
"RTN","PSOREF0",24,0)
DSPLYX Q
"RTN","PSOREF0",25,0)
CHECK ;
"RTN","PSOREF0",26,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG($P(PSOREF("RX0"),"^",6),"I"))]"",DT>$G(^("I")) D  G CKQ
"RTN","PSOREF0",27,0)
 .W $C(7),!!," *** Drug is inactive for Rx # "_$P(PSOREF("RX0"),"^")_" cannot be refilled ***",!
"RTN","PSOREF0",28,0)
 I '$D(PSORX("BAR CODE")),PSOREF("PSODFN")'=PSODFN W !!,?5,$C(7),"Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSOREF0",29,0)
 S (PSOX,PSOY,STA)=""
"RTN","PSOREF0",30,0)
 I $G(PSOSD) F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S PSOX=$O(PSOSD(STA,PSOX)) Q:PSOX']""!(PSOREF("DFLG"))  I PSOREF("IRXN")=+PSOSD(STA,PSOX) S PSOY=PSOSD(STA,PSOX) I $P(PSOY,"^",4)]"" D
"RTN","PSOREF0",31,0)
 . S PSOREF("DFLG")=1 W:'$G(PSOERR) !,$C(7),"Cannot refill Rx # "_$P(PSOREF("RX0"),"^") S PSOREA=$P(PSOY,"^",4),PSOSTAT=PSOREF("STA")
"RTN","PSOREF0",32,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSOREF0",33,0)
 . Q
"RTN","PSOREF0",34,0)
 I PSOY="" W !,$C(7),"Cannot refill, Rx is discontinued or expired.  Later Rx may exist.",! D  I $G(PSODF) Q
"RTN","PSOREF0",35,0)
 .D LOOK^PSOREF2 I $G(PSODF) Q
"RTN","PSOREF0",36,0)
 .S PSOREF("DFLG")=1
"RTN","PSOREF0",37,0)
 K PSOX,PSOY G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",38,0)
 I $O(^PS(52.5,"B",PSOREF("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOREF("IRXN"),0)),"P")) W !,$C(7),"Rx is in suspense and cannot be refilled" S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",39,0)
 ;
"RTN","PSOREF0",40,0)
 S PSOREF("RXSTATUS")=PSOREF("STA")
"RTN","PSOREF0",41,0)
 I PSOREF("RXSTATUS"),PSOREF("RXSTATUS")'=6 D  G CHECKX
"RTN","PSOREF0",42,0)
 . S PSOY=";"_PSOREF("RXSTATUS"),PSOX=$P(^DD(52,100,0),"^",3),PSOY=$F(PSOX,PSOY),PSOY=$P($E(PSOX,PSOY,999),";",1)
"RTN","PSOREF0",43,0)
 . W !,$C(7),"Rx is in "_PSOY_" status, cannot be refilled" S PSOREF("DFLG")=1
"RTN","PSOREF0",44,0)
 D CHKDIV G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",45,0)
 D NUMBER I PSOREF("NUMBER")>$P(PSOREF("RX0"),"^",9) W !?5,"Can't refill, no refills remaining." S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",46,0)
 ;
"RTN","PSOREF0",47,0)
 ;PSO*7*186  check DEA, SPEC HNDLG field, in case changed, and apply
"RTN","PSOREF0",48,0)
 N PSODRG,PSODEA,PSODAY,PSOCHECK
"RTN","PSOREF0",49,0)
 S PSODRG=$G(^PSDRUG($P(PSOREF("RX0"),U,6),0)),PSODEA=$P(PSODRG,U,3)
"RTN","PSOREF0",50,0)
 S PSODAY=$P(PSOREF("RX0"),U,8)
"RTN","PSOREF0",51,0)
 S PSOCHECK=$$DEACHK^PSOUTLA1(PSOREF("IRXN"),PSODEA,PSODAY)
"RTN","PSOREF0",52,0)
 I PSOCHECK S PSOREF("DFLG")=1 W $C(7),!! D  G CHECKX
"RTN","PSOREF0",53,0)
 . I PSOCHECK=1 W "Requested refill exceeds maximum allowable days supply for Rx.",! Q  ;*388
"RTN","PSOREF0",54,0)
 . W "Current drug DEA/SPECIAL HANDLING code does not allow refills.",! ;*388
"RTN","PSOREF0",55,0)
 ;
"RTN","PSOREF0",56,0)
 D DATES
"RTN","PSOREF0",57,0)
CHECKX Q
"RTN","PSOREF0",58,0)
CKQ ;
"RTN","PSOREF0",59,0)
 S PSOREF("DFLG")=1 D PAUSE^VALM1 G CHECKX
"RTN","PSOREF0",60,0)
 Q
"RTN","PSOREF0",61,0)
 ;
"RTN","PSOREF0",62,0)
CHKDIV G:$P(PSOREF("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSOREF0",63,0)
 W !?5,$C(7),"RX # ",$P(PSOREF("RX0"),"^")," is for (",$P(^PS(59,$P(PSOREF("RX2"),"^",9),0),"^"),") division."
"RTN","PSOREF0",64,0)
 I '$P($G(PSOSYS),"^",2) S (PSOREF("DFLG"),PSOMHV)=1 W !,"********* Not Refilled *********" G CHKDIVX
"RTN","PSOREF0",65,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSOREF0",66,0)
CHKDIVX Q
"RTN","PSOREF0",67,0)
 ;
"RTN","PSOREF0",68,0)
NUMBER K PSOX,PSOY S PSOREF("# OF REFILLS")=0
"RTN","PSOREF0",69,0)
 I $G(^PSRX(PSOREF("IRXN"),1,0))]"" F PSOX=0:0 S PSOX=$O(^PSRX(PSOREF("IRXN"),1,PSOX)) Q:'PSOX  S PSOREF("# OF REFILLS")=PSOX
"RTN","PSOREF0",70,0)
 S PSOREF("NUMBER")=PSOREF("# OF REFILLS")+1
"RTN","PSOREF0",71,0)
 Q
"RTN","PSOREF0",72,0)
 ;
"RTN","PSOREF0",73,0)
DATES S PSOREF("STOP DATE")=$P(PSOREF("RX2"),"^",6) D NEXT^PSOUTIL(.PSOREF)
"RTN","PSOREF0",74,0)
 D:$G(PSOBBC("QFLG"))&($P(PSOPAR,"^",6)) EDATE Q:$G(PSOREF("DFLG"))
"RTN","PSOREF0",75,0)
 S PSOREF("FILL DATE")=$S($G(PSOREF("FILL DATE")):PSOREF("FILL DATE"),1:DT)
"RTN","PSOREF0",76,0)
 I $P(PSOPAR,"^",6),PSOREF("FILL DATE")<$P(PSOREF("RX3"),"^",2) D SUSDATE^PSOUTIL(.PSOREF)
"RTN","PSOREF0",77,0)
 ;
"RTN","PSOREF0",78,0)
 I PSOREF("FILL DATE")>PSOREF("STOP DATE") D
"RTN","PSOREF0",79,0)
 . W !!?5,$C(7),"Can't refill, Refill Date ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/"
"RTN","PSOREF0",80,0)
 . W $E(PSOREF("FILL DATE"),2,3)," is past Expiration Date ",$E(PSOREF("STOP DATE"),4,5),"/",$E(PSOREF("STOP DATE"),6,7),"/"
"RTN","PSOREF0",81,0)
 . W $E(PSOREF("STOP DATE"),2,3) S PSOREF("DFLG")=1
"RTN","PSOREF0",82,0)
EDATE S PSOREF("LAST REFILL DATE")=$P(PSOREF("RX3"),"^",1)
"RTN","PSOREF0",83,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")=PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",84,0)
 . W !?5,"Can't refill, Fill Date already exists for ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/",$E(PSOREF("FILL DATE"),2,3)
"RTN","PSOREF0",85,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",86,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")<PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",87,0)
 . W !?5,"Can't refill, later Refill Date already exists for ",$E(PSOREF("LAST REFILL DATE"),4,5),"/",$E(PSOREF("LAST REFILL DATE"),6,7),"/",$E(PSOREF("LAST REFILL DATE"),2,3)
"RTN","PSOREF0",88,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",89,0)
 I '$P(PSOPAR,"^",6),'$D(PSOREF("EAOK")),$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",90,0)
 . S PSOX1=(PSOREF("NUMBER")+1)*PSOREF("DAYS SUPPLY")-10
"RTN","PSOREF0",91,0)
 . W !?5,$C(7),"LESS THAN ",PSOX1," DAYS FOR ",PSOREF("NUMBER")+1," FILLS",! D DIR K PSOX1
"RTN","PSOREF0",92,0)
 I '$P(PSOPAR,"^",6),$G(PSOREF("EAOK"))=0,$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",93,0)
 . S Y=$P(PSOREF("RX3"),"^",2) D DD^%DT W !!,$C(7),"Cannot be refilled until "_Y_"." S (PSOREF("DFLG"),PSOMHV)=1 K Y
"RTN","PSOREF0",94,0)
DATESX Q
"RTN","PSOREF0",95,0)
DIR K DIR,X,Y S DIR(0)="Y",DIR("A")="Continue ",DIR("B")="N",DIR("?")="Answer YES to Refill, NO to bypass"
"RTN","PSOREF0",96,0)
 D ^DIR K DIR S:$D(DIRUT)!('Y) (PSOREF("DFLG"),PSOMHV)=1 K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOREF0",97,0)
 Q
"RTN","PSOREF0",98,0)
NEWPT S PSOQFLG=0,(DFN,PSODFN)=PSOREF("PSODFN") D ^PSOPTPST I PSOQFLG S PSOREF("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSOREF0",99,0)
 D PROFILE^PSOREF1
"RTN","PSOREF0",100,0)
NEWPTX Q
"RTN","PSOREF0",101,0)
 ;
"RTN","PSOREF0",102,0)
EN(PSOREF)         ; Entry Point for Batch Barcode Option
"RTN","PSOREF0",103,0)
 D PROCESS K DRUG,PSODF
"RTN","PSOREF0",104,0)
 Q
"RTN","PSORENW")
0^1^B35245788^B35245784
"RTN","PSORENW",1,0)
PSORENW ;BIR/SAB-renew main driver ; 6/8/11 3:22pm
"RTN","PSORENW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,30,46,71,96,100,130,148,206,388**;DEC 1997;Build 6
"RTN","PSORENW",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORENW",4,0)
 ;External references L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORENW",5,0)
 ;External reference to LK^ORX2 and ULK^ORX2 supported by DBIA 867
"RTN","PSORENW",6,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSORENW",7,0)
 ;External reference to MAIN^TIUEDIT supported by DBIA 2410
"RTN","PSORENW",8,0)
 ;
"RTN","PSORENW",9,0)
ASK ;
"RTN","PSORENW",10,0)
 K PSORENW("FILL DATE") D FILLDT^PSODIR2(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",11,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",12,0)
 S PSORNW("FILL DATE")=PSORENW("FILL DATE")
"RTN","PSORENW",13,0)
 D MW^PSOCMOPA(.PSORENW)
"RTN","PSORENW",14,0)
 I PSORENW("DFLG") S PSORENW("QFLG")=1,PSORENW("DFLG")=0 G ASKX
"RTN","PSORENW",15,0)
 S PSORNW("MAIL/WINDOW")=PSORENW("MAIL/WINDOW") S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="M":"MAIL",1:"WINDOW")
"RTN","PSORENW",16,0)
 D NOORE^PSONEW(.PSORENW) S:$G(PSORENW("DFLG")) VALMSG="Renew Rx request canceled",VALMBCK="R"
"RTN","PSORENW",17,0)
 I PSORENW("DFLG")!('$D(PSORENW("FILL DATE"))) S PSORENW("QFLG")=1,PSORENW("DFLG")=0
"RTN","PSORENW",18,0)
ASKX Q
"RTN","PSORENW",19,0)
 ;
"RTN","PSORENW",20,0)
EOJ ;
"RTN","PSORENW",21,0)
 K VERB,RTE,DRET,PSOMSG,PSORNW,PSOLIST,PSORENW,PSORX("BAR CODE"),PSORX("FILL DATE"),PSODIR,PSOID,PSONOOR,PSOCOU,PSOCOUU,PSOID,PSOFDMX,PSODRUG,COPY,PSOBCKDR
"RTN","PSORENW",22,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSORENW",23,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSORENW",24,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS",$P(RXN1,"^",4))
"RTN","PSORENW",25,0)
 K RXN,RXN1,^TMP("PSORXN",$J)
"RTN","PSORENW",26,0)
 I $G(PSONOTE) D MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSORENW",27,0)
 K PSONOTE
"RTN","PSORENW",28,0)
 Q
"RTN","PSORENW",29,0)
OERR ;entry for renew backdoor
"RTN","PSORENW",30,0)
 I $$LMREJ^PSOREJU1($P(PSOLST(ORN),"^",2),,.VALMSG,.VALMBCK) Q
"RTN","PSORENW",31,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSORENW",32,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSORENW",33,0)
 K PSOID,PSOFDMX,PSORX("FILL DATE"),PSORENW("FILL DATE"),PSORX("QS"),PSORENW("QS"),PSOBARCD,COPY
"RTN","PSORENW",34,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULPAT Q
"RTN","PSORENW",35,0)
 S PSOBCKDR=1,PSOFROM="NEW",PSORENW("OIRXN")=$P(PSOLST(ORN),"^",2),PSOOPT=3,(PSORENW("DFLG"),PSORENW("QFLG"),PSORX("DFLG"))=0
"RTN","PSORENW",36,0)
 S PSONEW("DAYS SUPPLY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",8),PSONEW("# OF REFILLS")=$P(^(0),"^",9)
"RTN","PSORENW",37,0)
 D FULL^VALM1,ASK D:PSORENW("QFLG") KLIB^PSORENW1 D:PSORENW("QFLG") ULPAT D:PSORENW("QFLG") PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) G:PSORENW("QFLG") EOJ D ^PSORENW0
"RTN","PSORENW",38,0)
 D ULPAT,EOJ,KLIB^PSORENW1 K PSOOPT,PSONEW,PSORX("DFLG")
"RTN","PSORENW",39,0)
 Q
"RTN","PSORENW",40,0)
ULPAT K PSOMSG D UL^PSSLOCK(PSODFN) S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSORENW",41,0)
 Q
"RTN","PSORENW",42,0)
RENEW(PLACER,PSOCPDRG) ;passes flag to CPRS for front door renews
"RTN","PSORENW",43,0)
 ;-1=couldn't find order, 0=unable to renew, 1=renewable
"RTN","PSORENW",44,0)
 ;Placer=Pharmacy number
"RTN","PSORENW",45,0)
 N PSOSURX,PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST,PSONEWOI,PSOOLDOI,PSOIFLAG,PSOINA
"RTN","PSORENW",46,0)
 I $G(PLACER)["S"!('$G(PLACER)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",47,0)
 S RXN=PLACER I '$D(^PSRX(RXN,0)) Q "-1^Not a Valid Outpatient Medication Order."
"RTN","PSORENW",48,0)
 S RX0=^PSRX(RXN,0),PSODRG=+$P(^PSRX(RXN,0),"^",6),ST=+^("STA"),PSODRUG0=^PSDRUG(PSODRG,0)
"RTN","PSORENW",49,0)
 S PSOIFLAG=0,PSOOLDOI=+$P($G(^PSRX(RXN,"OR1")),"^"),PSONEWOI=+$P($G(^PSDRUG(+$G(PSODRG),2)),"^") I PSONEWOI,PSONEWOI'=PSOOLDOI S PSOIFLAG=1
"RTN","PSORENW",50,0)
 S PSOINA=$P($G(^PS(50.7,PSONEWOI,0)),"^",4)
"RTN","PSORENW",51,0)
 I PSOINA,DT>PSOINA Q "0^This Orderable Item has been Inactivated."
"RTN","PSORENW",52,0)
 I ST=5 S PSOSURX=$O(^PS(52.5,"B",RXN,0)) I PSOSURX,$P($G(^PS(52.5,PSOSURX,0)),"^",7)="L" Q "0^Rx loading into a CMOP Transmission."
"RTN","PSORENW",53,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,2)),"^",6)<X Q "0^Prescription Expired more than 120 Days."
"RTN","PSORENW",54,0)
 S X1=DT,X2=-120 D C^%DTC I $P($G(^PSRX(RXN,3)),"^",5),$P($G(^(3)),"^",5)<X,$P(^("STA"),"^")=12 Q "0^Prescription Discontinued more than 120 Days."
"RTN","PSORENW",55,0)
 I $G(PSOCPDRG),$G(PSOCPDRG)'=$G(PSODRG) Q "0^Drug Mismatch, Non-Renewable."
"RTN","PSORENW",56,0)
 N PSOOCPRX,PSOOLPF,PSOOLPD,PSONOSIG S PSOOCPRX=RXN D CDOSE^PSORENW0 I PSOOLPF Q "0^Non-Renewable, invalid Dosage of "_$G(PSOOLPD)
"RTN","PSORENW",57,0)
 I PSONOSIG Q "0^Non-Renewable, missing Sig."
"RTN","PSORENW",58,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" Q "0^Drug is No longer used by Outpatient Pharmacy."
"RTN","PSORENW",59,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) Q "0^This Drug has been Inactivated."
"RTN","PSORENW",60,0)
 I ($P(PSODRUG0,"^",3)[1)!($P(PSODRUG0,"^",3)[2)!($P(PSODRUG0,"^",3)["W") Q "0^Non-Renewable "_$S($P(PSODRUG0,"^",3)["A":"Drug Narcotic.",1:"Drug.")
"RTN","PSORENW",61,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) Q "0^Non-Renewable Prescription."
"RTN","PSORENW",62,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 Q "0^Max number of renewals (26) has been reached."
"RTN","PSORENW",63,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12,ST'=14 Q "0^Prescription is in a Non-Renewable Status."
"RTN","PSORENW",64,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",4) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",65,0)
 I $O(^PS(52.41,"AQ",RXN,0)) Q "0^Duplicate Rx Renewal Request."
"RTN","PSORENW",66,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0,RXN,ST
"RTN","PSORENW",67,0)
 Q 1_$S($G(PSOIFLAG):"^"_$G(PSONEWOI),1:"")
"RTN","PSORENW",68,0)
 ;
"RTN","PSORENW",69,0)
INST1 ;Set Pharmacy Instructions array
"RTN","PSORENW",70,0)
 N PSOTZ
"RTN","PSORENW",71,0)
 I $O(^PSRX(RXN,"PI",0)) S PHI=$G(^PSRX(RXN,"PI",0)),PSOTZ=0 D
"RTN","PSORENW",72,0)
 .F  S PSOTZ=$O(^PSRX(RXN,"PI",PSOTZ)) Q:PSOTZ=""  S PHI(PSOTZ)=$G(^PSRX(RXN,"PI",PSOTZ,0))
"RTN","PSORENW",73,0)
 Q
"RTN","PSORENW",74,0)
INST2 ;Set Instructions and Comments
"RTN","PSORENW",75,0)
 I '$G(PSORENW("OIRXN")) Q
"RTN","PSORENW",76,0)
 I $G(PSOFDR) Q
"RTN","PSORENW",77,0)
 N PSOPHL,PSOPRL
"RTN","PSORENW",78,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PI",0)) K PHI S PHI=$G(^PSRX(PSORENW("OIRXN"),"PI",0)),PSOPHL="" D
"RTN","PSORENW",79,0)
 .F  S PSOPHL=$O(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL)) Q:PSOPHL=""  S PHI(PSOPHL)=$G(^PSRX(PSORENW("OIRXN"),"PI",PSOPHL,0))
"RTN","PSORENW",80,0)
 I $O(^PSRX(PSORENW("OIRXN"),"PRC",0)) K PRC S PRC=$G(^PSRX(PSORENW("OIRXN"),"PRC",0)),PSOPRL="" D
"RTN","PSORENW",81,0)
 .F  S PSOPRL=$O(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL)) Q:PSOPRL=""  S PRC(PSOPRL)=$G(^PSRX(PSORENW("OIRXN"),"PRC",PSOPRL,0))
"RTN","PSORENW",82,0)
 Q
"RTN","PSOUTLA1")
0^5^B59550372^B59314173
"RTN","PSOUTLA1",1,0)
PSOUTLA1 ;BHAM ISC/RTR-Pharmacy utility program cont. ; 17 Jun 2011  2:21 PM
"RTN","PSOUTLA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,186,218,259,206,388**;DEC 1997;Build 6
"RTN","PSOUTLA1",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOUTLA1",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOUTLA1",5,0)
 ;External reference to File ^PS(59.7 supported by DBIA 694
"RTN","PSOUTLA1",6,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOUTLA1",7,0)
 ;
"RTN","PSOUTLA1",8,0)
 ;*186 - add DEACHK function
"RTN","PSOUTLA1",9,0)
 ;*218 - add REFIP function
"RTN","PSOUTLA1",10,0)
 ;*259 - reverse *218 delete restriction only warn of deleting
"RTN","PSOUTLA1",11,0)
 ;       also add del of last refill only
"RTN","PSOUTLA1",12,0)
 ;
"RTN","PSOUTLA1",13,0)
EN1 ;Formats condensed, back door sig in BSIG array
"RTN","PSOUTLA1",14,0)
 ;pass in  1) Internal Rx from 52
"RTN","PSOUTLA1",15,0)
 ;         2) max length of BSIG array
"RTN","PSOUTLA1",16,0)
 ;Returned, still condensed, in BSIG array, when looping through, check for array=null, if so, juist don't print it
"RTN","PSOUTLA1",17,0)
EN2(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",18,0)
 K BSIG
"RTN","PSOUTLA1",19,0)
 N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM
"RTN","PSOUTLA1",20,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",21,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",22,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",23,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",24,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",25,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",26,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",27,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",28,0)
 Q
"RTN","PSOUTLA1",29,0)
 ;
"RTN","PSOUTLA1",30,0)
EN3(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",31,0)
 ;Pass in to EN3 the internal Rx number from 52, and the length of
"RTN","PSOUTLA1",32,0)
 ;the array you want. Returns expanded Sig, or warning from PSOHELP
"RTN","PSOUTLA1",33,0)
 ;concantenated with the condensed Sig in the BSIG array
"RTN","PSOUTLA1",34,0)
 ;BACK DOOR ONLY
"RTN","PSOUTLA1",35,0)
 K BSIG,X N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM,Y,SIG,Z0,Z1,BBWARN
"RTN","PSOUTLA1",36,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",37,0)
 S (SIG,X)=BBSIG
"RTN","PSOUTLA1",38,0)
 I $E(BBSIG)=" " S BBWARN="Leading spaces are not allowed in the SIG!" G START
"RTN","PSOUTLA1",39,0)
 S SIG="" Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" START S Z1=$P(X," ",Z0) D  G:'$D(X) START
"RTN","PSOUTLA1",40,0)
 .I $L(Z1)>32 S BBWARN="MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES!" K X Q
"RTN","PSOUTLA1",41,0)
 .D:$D(X)&($G(Z1)]"")  S SIG=SIG_" "_Z1
"RTN","PSOUTLA1",42,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOUTLA1",43,0)
START ;
"RTN","PSOUTLA1",44,0)
 S BBSIG=$S($G(BBWARN)="":SIG,1:BBWARN_"  "_BBSIG)
"RTN","PSOUTLA1",45,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",46,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",47,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",48,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",49,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",50,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",51,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",52,0)
 Q
"RTN","PSOUTLA1",53,0)
PATCH ;Allow sites to backfill more than what was done at install
"RTN","PSOUTLA1",54,0)
 N PSOBACKL,PSOBACKI,PSOBACKS,PSOBACKB,PSOBACKD,PSOBACKA
"RTN","PSOUTLA1",55,0)
 S PSOBACKL=$O(^PS(59.7,0)),PSOBACKI=$E($P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",7),1,7)
"RTN","PSOUTLA1",56,0)
 I '$G(PSOBACKI) S PSOBACKI=$P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",4)
"RTN","PSOUTLA1",57,0)
 I $G(PSOBACKI) S Y=PSOBACKI D DD^%DT S PSOBACKS=Y S X1=PSOBACKI,X2=-120 D C^%DTC S (Y,PSOBACKB)=X D DD^%DT S PSOBACKD=Y
"RTN","PSOUTLA1",58,0)
 I $G(PSOBACKD)'="" W !!,"Your CPRS/Outpatient installation date is "_$G(PSOBACKS)_","_" which",!,"means we have already backfilled all active prescriptions and all",!,"prescriptions canceled or expired after "_$G(PSOBACKD)_"."
"RTN","PSOUTLA1",59,0)
 I  W !!,"If you want to backfill orders that were canceled or expired prior to this",!,"date of "_$G(PSOBACKD)_", enter an earlier date and those orders",!,"will be backfilled to CPRS.",!
"RTN","PSOUTLA1",60,0)
 I $G(PSOBACKD)="" W !!,"We cannot determine the date of the CPRS/Outpatient installation.",!
"RTN","PSOUTLA1",61,0)
 W !,"If you choose to backfill more orders to CPRS by utilizing this option,",!,"we remind you that disk storage can be significantly affected, depending on",!,"how many orders are backfilled.",!
"RTN","PSOUTLA1",62,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to backfill more prescriptions",DIR("?")="Enter Yes to backfill prescriptions canceled or expired before "_$G(PSOBACKD) D ^DIR K DIR I Y'=1 W ! G PATCHQ
"RTN","PSOUTLA1",63,0)
 W ! S %DT="AEPX",%DT("A")="Enter Date to begin backfill: " S:$G(PSOBACKB) %DT(0)=-PSOBACKB D ^%DT G:Y<0!($D(DTOUT)) PATCHQ S PSOBACKA=$E(Y,1,7)
"RTN","PSOUTLA1",64,0)
 W ! K ZTDTH S ZTSAVE("PSOBACKB")="",ZTSAVE("PSOBACKA")="",ZTRTN="PATCHR^PSOUTLA1",ZTDESC="BACKFILL PRSCRIPTIONS TO CPRS",ZTIO="" D ^%ZTLOAD W ! G PATCHQ
"RTN","PSOUTLA1",65,0)
PATCHR ;Begin task
"RTN","PSOUTLA1",66,0)
 N PSOPAL,PSOLPD,PSOLPRX
"RTN","PSOUTLA1",67,0)
 S PSOBACKA=PSOBACKA-.01
"RTN","PSOUTLA1",68,0)
 I '$G(PSOBACKB) S PSOBACKB=DT
"RTN","PSOUTLA1",69,0)
 F PSOPAL=0:0 S PSOPAL=$O(^PS(55,PSOPAL)) Q:'PSOPAL  F PSOLPD=PSOBACKA:0 S PSOLPD=$O(^PS(55,PSOPAL,"P","A",PSOLPD)) Q:'PSOLPD!(PSOLPD>PSOBACKB)  F PSOLPRX=0:0 S PSOLPRX=$O(^PS(55,PSOPAL,"P","A",PSOLPD,PSOLPRX)) Q:'PSOLPRX  D
"RTN","PSOUTLA1",70,0)
 .I $P($G(^PSRX(PSOLPRX,0)),"^")=""!('$P($G(^(0)),"^",2))!('$P($G(^(0)),"^",6)) Q
"RTN","PSOUTLA1",71,0)
 .I $P($G(^PSRX(PSOLPRX,"OR1")),"^",2) Q
"RTN","PSOUTLA1",72,0)
 .I '$P($G(^PSRX(PSOLPRX,0)),"^",19) D
"RTN","PSOUTLA1",73,0)
 ..I $P($G(^PSRX(PSOLPRX,"OR1")),"^")="",+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2)) S $P(^PSRX(PSOLPRX,"OR1"),"^")=+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2))
"RTN","PSOUTLA1",74,0)
 ..I $P($G(^PSRX(PSOLPRX,0)),"^",10)'="",$G(^PSRX(PSOLPRX,"SIG"))']"",'$O(^PSRX(PSOLPRX,"SIG1",0)) S ^PSRX(PSOLPRX,"SIG")=$P($G(^PSRX(PSOLPRX,0)),"^",10)_"^"_0 S $P(^PSRX(PSOLPRX,0),"^",10)=""
"RTN","PSOUTLA1",75,0)
 ..I $P($G(^PSRX(PSOLPRX,"STA")),"^")="",$P($G(^PSRX(PSOLPRX,0)),"^",15)'="" S $P(^PSRX(PSOLPRX,"STA"),"^")=$P($G(^PSRX(PSOLPRX,0)),"^",15) S $P(^PSRX(PSOLPRX,0),"^",15)=""
"RTN","PSOUTLA1",76,0)
 ..S $P(^PSRX(PSOLPRX,0),"^",19)=1
"RTN","PSOUTLA1",77,0)
 .S PSOLPSTA=$P($G(^PSRX(PSOLPRX,"STA")),"^") Q:PSOLPSTA=""!(PSOLPSTA=13)!(PSOLPSTA=10)
"RTN","PSOUTLA1",78,0)
 .D EN^PSOHLSN1(PSOLPRX,"ZC","")
"RTN","PSOUTLA1",79,0)
 .I PSOLPSTA'="",PSOLPSTA<10 D
"RTN","PSOUTLA1",80,0)
 ..I +$P($G(^PSRX(PSOLPRX,2)),"^",6),+$P($G(^(2)),"^",6)<DT S $P(^PSRX(PSOLPRX,"STA"),"^")=11,PSOLPSTA=11
"RTN","PSOUTLA1",81,0)
 .S PSOLPSTX=$S(PSOLPSTA=3:"OH",PSOLPSTA=16:"OH",PSOLPSTA=12:"OD",PSOLPSTA=15:"OD",PSOLPSTA=14:"OD",1:"SC"),PSOLPSTZ=$S(PSOLPSTA=0:"CM",PSOLPSTA=1:"IP",PSOLPSTA=4:"IP",PSOLPSTA=5:"ZS",PSOLPSTA=11:"ZE",1:"")
"RTN","PSOUTLA1",82,0)
 .D EN^PSOHLSN1(PSOLPRX,PSOLPSTX,PSOLPSTZ,"")
"RTN","PSOUTLA1",83,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOUTLA1",84,0)
PATCHQ Q
"RTN","PSOUTLA1",85,0)
 ;
"RTN","PSOUTLA1",86,0)
 ;PSO*186
"RTN","PSOUTLA1",87,0)
DEACHK(PSIRXN,PSDEA,PSDAYS,PCLOZ,PSOCS,PSMAXRF) ;Apply DEA restrictions
"RTN","PSOUTLA1",88,0)
 ;
"RTN","PSOUTLA1",89,0)
 ; If no refills allowed indicate that and set Max refills to number
"RTN","PSOUTLA1",90,0)
 ; of fills thus far, or if new order, then num of refills will not be
"RTN","PSOUTLA1",91,0)
 ; found and Max refills will be 0.
"RTN","PSOUTLA1",92,0)
 ;
"RTN","PSOUTLA1",93,0)
 ;  Function returns: 1 = no refills allowed
"RTN","PSOUTLA1",94,0)
 ;  Function returns: 2 = no refills allowed
"RTN","PSOUTLA1",95,0)
 ;                    0 = ok to refill
"RTN","PSOUTLA1",96,0)
 ;  Input Variables: PSIRXN = internal RX number or "*"=(new order)
"RTN","PSOUTLA1",97,0)
 ;                   PSDEA  = DEA special handling for drug ordered
"RTN","PSOUTLA1",98,0)
 ;                   PSDAYS = Days supply ordered
"RTN","PSOUTLA1",99,0)
 ;                   PCLOZ  = Clozapine patient? (Optional)
"RTN","PSOUTLA1",100,0)
 ; Output Variables: PSOCS  = Controlled sub flag  (Optional)
"RTN","PSOUTLA1",101,0)
 ;                   PSMAXRF= Max Refill allowed by DEA restriction
"RTN","PSOUTLA1",102,0)
 ;                                                 (Optional)
"RTN","PSOUTLA1",103,0)
 ;
"RTN","PSOUTLA1",104,0)
 S PSIRXN=+$G(PSIRXN),PSDEA=$G(PSDEA),PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",105,0)
 S PSOCS=+$G(PSOCS),PSMAXRF=+$G(PSMAXRF),PCLOZ=$G(PCLOZ)
"RTN","PSOUTLA1",106,0)
 ;
"RTN","PSOUTLA1",107,0)
 ;if clozapine patient (passed in 0 or 1),  set max refills and quit
"RTN","PSOUTLA1",108,0)
 I PCLOZ=0 S PSMAXRF=0 Q 1
"RTN","PSOUTLA1",109,0)
 I PCLOZ=1 S PSMAXRF=1 Q 0
"RTN","PSOUTLA1",110,0)
 ;
"RTN","PSOUTLA1",111,0)
 ;no refills if PSDEA = 'A' & not 'B' or 'F',
"RTN","PSOUTLA1",112,0)
 I (PSDEA["A")&(PSDEA'["B")!(PSDEA["F")!(PSDEA[1)!(PSDEA[2) D  Q 2  ;*388
"RTN","PSOUTLA1",113,0)
 . S PSMAXRF=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",114,0)
 ;
"RTN","PSOUTLA1",115,0)
 N QQ
"RTN","PSOUTLA1",116,0)
 F QQ=1:1 Q:$E(PSDEA,QQ)=""  I $E(+PSDEA,QQ)>1,$E(+PSDEA,QQ)<6 D
"RTN","PSOUTLA1",117,0)
 . S PSOCS=1
"RTN","PSOUTLA1",118,0)
 . S:$E(+PSDEA,QQ)=2 $P(PSOCS,"^",2)=1
"RTN","PSOUTLA1",119,0)
 ;
"RTN","PSOUTLA1",120,0)
 ;no refills allowed on sched 2
"RTN","PSOUTLA1",121,0)
 I $P(PSOCS,"^",2)=1 S PSMAXRF=$$NUMFILLS(PSIRXN) Q 2  ;*388
"RTN","PSOUTLA1",122,0)
 ;
"RTN","PSOUTLA1",123,0)
 ;set max refill for controlled substance & other based on days supply
"RTN","PSOUTLA1",124,0)
 S PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",125,0)
 I PSOCS D
"RTN","PSOUTLA1",126,0)
 . S PSMAXRF=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0)
"RTN","PSOUTLA1",127,0)
 E  D
"RTN","PSOUTLA1",128,0)
 . S PSMAXRF=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0)
"RTN","PSOUTLA1",129,0)
 ;
"RTN","PSOUTLA1",130,0)
 ;get number of fills if applies & compare to Max refills
"RTN","PSOUTLA1",131,0)
 N PNFILLS S PNFILLS=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",132,0)
 I PNFILLS'<PSMAXRF S PSMAXRF=PNFILLS Q 1
"RTN","PSOUTLA1",133,0)
 ;
"RTN","PSOUTLA1",134,0)
 Q 0
"RTN","PSOUTLA1",135,0)
 ;
"RTN","PSOUTLA1",136,0)
NUMFILLS(PSIRXN) ;Return number of fills thus far, or 0 if doesn't apply
"RTN","PSOUTLA1",137,0)
 ; function returns: if   Active drug, then number of refills thus far
"RTN","PSOUTLA1",138,0)
 ;                   else return 0 for does not apply
"RTN","PSOUTLA1",139,0)
 ;  Input Variables: PSIRXN = internal RX number (Optional)
"RTN","PSOUTLA1",140,0)
 Q:'$G(PSIRXN) 0
"RTN","PSOUTLA1",141,0)
 N RFN,RFNC
"RTN","PSOUTLA1",142,0)
 S (RFN,RFNC)=0
"RTN","PSOUTLA1",143,0)
 F  S RFN=$O(^PSRX(PSIRXN,1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSOUTLA1",144,0)
 Q RFNC
"RTN","PSOUTLA1",145,0)
 ;
"RTN","PSOUTLA1",146,0)
REFIP(RXI,RFIL,TYP) ;Check if refill is Not Released and In Process and
"RTN","PSOUTLA1",147,0)
 ;           pending Auto Release by an external dispense machine.
"RTN","PSOUTLA1",148,0)
 ; Input: RXI = internal Prescription no.
"RTN","PSOUTLA1",149,0)
 ;        RFIL= refill number
"RTN","PSOUTLA1",150,0)
 ;        TYP ="R"-refill or "P"-partial
"RTN","PSOUTLA1",151,0)
 ; Returns 1 = In Process      (Not OK to delete)
"RTN","PSOUTLA1",152,0)
 ;         0 = Not In Process  (OK to delete)
"RTN","PSOUTLA1",153,0)
 ;
"RTN","PSOUTLA1",154,0)
 ;assumes a refill is Not In Process by the external dispense machine
"RTN","PSOUTLA1",155,0)
 ;unless it finds a record in this file and is marked to the contrary
"RTN","PSOUTLA1",156,0)
 ;
"RTN","PSOUTLA1",157,0)
 N PSIEN,IP,FOUND,EXDATA,EXDIV
"RTN","PSOUTLA1",158,0)
 S (IP,FOUND)=0,PSIEN=""
"RTN","PSOUTLA1",159,0)
 ;find first specified refill processing backwards, in case dupes
"RTN","PSOUTLA1",160,0)
 F  S PSIEN=$O(^PS(52.51,"B",RXI,PSIEN),-1) Q:PSIEN=""  D  Q:FOUND
"RTN","PSOUTLA1",161,0)
 . S EXDATA=^PS(52.51,PSIEN,0)
"RTN","PSOUTLA1",162,0)
 . I $P(EXDATA,"^",9)=RFIL D
"RTN","PSOUTLA1",163,0)
 . . S EXDIV=$P(EXDATA,"^",11)
"RTN","PSOUTLA1",164,0)
 . . Q:'$P($G(^PS(59,EXDIV,"DISP")),"^",2)     ;quit, not auto release
"RTN","PSOUTLA1",165,0)
 . . S FOUND=1
"RTN","PSOUTLA1",166,0)
 . I FOUND,$P(^PS(52.51,PSIEN,0),"^",10)'=2 S IP=1
"RTN","PSOUTLA1",167,0)
 Q IP
"RTN","PSOUTLA1",168,0)
 ;
"RTN","PSOUTLA1",169,0)
WARN1 ;partial del checks    *259
"RTN","PSOUTLA1",170,0)
 N PSR,PSOL
"RTN","PSOUTLA1",171,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),"P",PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTLA1",172,0)
 I DA=PSOL,$P(^PSRX(DA(1),"P",DA,0),"^",19) D  Q
"RTN","PSOUTLA1",173,0)
 .D EN^DDIOL("Partial Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTLA1",174,0)
 ;
"RTN","PSOUTLA1",175,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTLA1",176,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"P") D  I 'Y Q               ;reset $T
"RTN","PSOUTLA1",177,0)
 . D EN^DDIOL("** Partial refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTLA1",178,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTLA1",179,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTLA1",180,0)
 . K DIR
"RTN","PSOUTLA1",181,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTLA1",182,0)
 . S DIR("B")="Y"
"RTN","PSOUTLA1",183,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTLA1",184,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTLA1",185,0)
 . D ^DIR
"RTN","PSOUTLA1",186,0)
 . K DIR
"RTN","PSOUTLA1",187,0)
 Q
"VER")
8.0^22.0
"BLD",8759,6)
^335
**END**
**END**
