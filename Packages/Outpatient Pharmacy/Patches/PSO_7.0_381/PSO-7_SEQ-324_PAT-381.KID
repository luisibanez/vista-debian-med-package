Released PSO*7*381 SEQ #324
Extracted from mail message
**KIDS**:PSO*7.0*381^

**INSTALL NAME**
PSO*7.0*381
"BLD",7949,0)
PSO*7.0*381^OUTPATIENT PHARMACY^0^3110224^y
"BLD",7949,1,0)
^^5^5^3110217^
"BLD",7949,1,1,0)
This patch will resolve the issue where Active Non-VA meds with a 
"BLD",7949,1,2,0)
Start Date do no display on the Meds Tab when no Stop Date is defined in
"BLD",7949,1,3,0)
the ORCH CONTEXT MEDS parameter.
"BLD",7949,1,4,0)
 
"BLD",7949,1,5,0)
parameter.
"BLD",7949,4,0)
^9.64PA^^
"BLD",7949,6.3)
4
"BLD",7949,"KRN",0)
^9.67PA^779.2^20
"BLD",7949,"KRN",.4,0)
.4
"BLD",7949,"KRN",.401,0)
.401
"BLD",7949,"KRN",.402,0)
.402
"BLD",7949,"KRN",.403,0)
.403
"BLD",7949,"KRN",.5,0)
.5
"BLD",7949,"KRN",.84,0)
.84
"BLD",7949,"KRN",3.6,0)
3.6
"BLD",7949,"KRN",3.8,0)
3.8
"BLD",7949,"KRN",9.2,0)
9.2
"BLD",7949,"KRN",9.8,0)
9.8
"BLD",7949,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",7949,"KRN",9.8,"NM",1,0)
PSOORRLN^^0^B47940442
"BLD",7949,"KRN",9.8,"NM",2,0)
PSOORRLO^^0^B43456969
"BLD",7949,"KRN",9.8,"NM",3,0)
PSOORRL3^^0^B27858556
"BLD",7949,"KRN",9.8,"NM","B","PSOORRL3",3)

"BLD",7949,"KRN",9.8,"NM","B","PSOORRLN",1)

"BLD",7949,"KRN",9.8,"NM","B","PSOORRLO",2)

"BLD",7949,"KRN",19,0)
19
"BLD",7949,"KRN",19.1,0)
19.1
"BLD",7949,"KRN",101,0)
101
"BLD",7949,"KRN",409.61,0)
409.61
"BLD",7949,"KRN",771,0)
771
"BLD",7949,"KRN",779.2,0)
779.2
"BLD",7949,"KRN",870,0)
870
"BLD",7949,"KRN",8989.51,0)
8989.51
"BLD",7949,"KRN",8989.52,0)
8989.52
"BLD",7949,"KRN",8994,0)
8994
"BLD",7949,"KRN","B",.4,.4)

"BLD",7949,"KRN","B",.401,.401)

"BLD",7949,"KRN","B",.402,.402)

"BLD",7949,"KRN","B",.403,.403)

"BLD",7949,"KRN","B",.5,.5)

"BLD",7949,"KRN","B",.84,.84)

"BLD",7949,"KRN","B",3.6,3.6)

"BLD",7949,"KRN","B",3.8,3.8)

"BLD",7949,"KRN","B",9.2,9.2)

"BLD",7949,"KRN","B",9.8,9.8)

"BLD",7949,"KRN","B",19,19)

"BLD",7949,"KRN","B",19.1,19.1)

"BLD",7949,"KRN","B",101,101)

"BLD",7949,"KRN","B",409.61,409.61)

"BLD",7949,"KRN","B",771,771)

"BLD",7949,"KRN","B",779.2,779.2)

"BLD",7949,"KRN","B",870,870)

"BLD",7949,"KRN","B",8989.51,8989.51)

"BLD",7949,"KRN","B",8989.52,8989.52)

"BLD",7949,"KRN","B",8994,8994)

"BLD",7949,"QDEF")
^^^^NO^^^^^^NO
"BLD",7949,"QUES",0)
^9.62^^
"BLD",7949,"REQB",0)
^9.611^1^1
"BLD",7949,"REQB",1,0)
PSO*7.0*331^2
"BLD",7949,"REQB","B","PSO*7.0*331",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
381^3110224
"PKG",141,22,1,"PAH",1,1,0)
^^5^5^3110224
"PKG",141,22,1,"PAH",1,1,1,0)
This patch will resolve the issue where Active Non-VA meds with a 
"PKG",141,22,1,"PAH",1,1,2,0)
Start Date do no display on the Meds Tab when no Stop Date is defined in
"PKG",141,22,1,"PAH",1,1,3,0)
the ORCH CONTEXT MEDS parameter.
"PKG",141,22,1,"PAH",1,1,4,0)
 
"PKG",141,22,1,"PAH",1,1,5,0)
parameter.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSOORRL3")
0^3^B27858556^B26670310
"RTN","PSOORRL3",1,0)
PSOORRL3 ;BHAM ISC/SJA - returns patient's outpatient meds-new sort ;02/02/07
"RTN","PSOORRL3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,331,381**;DEC 1997;Build 4
"RTN","PSOORRL3",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORRL3",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRL3",5,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOORRL3",6,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORRL3",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORRL3",8,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORRL3",9,0)
 ;External reference to OCL^PSJORRE supported by DBIA 2383
"RTN","PSOORRL3",10,0)
OCL ;entry point to return condensed list
"RTN","PSOORRL3",11,0)
 ;BHW;PSO*7*159;New SD* Variables
"RTN","PSOORRL3",12,0)
 N SD,SDT,SDT1,PSG,PST,PSD,DRUG,PSOSTA
"RTN","PSOORRL3",13,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOORRL3",14,0)
 K ^TMP("PS",$J),^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRL3",15,0)
 S TFN=0,PSBDT=$G(BDT),PSEDT=$G(EDT) I +$G(PSBDT)<1 S X1=DT,X2=-120 D C^%DTC S PSBDT=X
"RTN","PSOORRL3",16,0)
 S EXDT=PSBDT-1,IFN=0
"RTN","PSOORRL3",17,0)
 F  S EXDT=$O(^PS(55,DFN,"P","A",EXDT)) Q:'EXDT  F  S IFN=$O(^PS(55,DFN,"P","A",EXDT,IFN)) Q:'IFN  D:$D(^PSRX(IFN,0))
"RTN","PSOORRL3",18,0)
 .S PSOSTA=$P($G(^PSRX(IFN,"STA")),"^") Q:'(PSOSTA=0!(PSOSTA=11)!(PSOSTA=5)!(PSOSTA=3)!(PSOSTA=16))
"RTN","PSOORRL3",19,0)
 .S TFN=TFN+1,RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2),LSTRD=$P(RX2,"^",13),LSTDS=$P(RX0,"^",8)
"RTN","PSOORRL3",20,0)
 .F I=0:0 S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^"),LSTDS=$P(^(0),"^",10) S:$P(^(0),"^",18)]"" LSTRD=$P(^(0),"^",18)
"RTN","PSOORRL3",21,0)
 .S ST0=STA,ST=$P("ERROR^ACTIVE^^^HOLD^^ACTIVE/SUSP^^^^^^EXPIRED^^^^^HOLD^","^",ST0+2)
"RTN","PSOORRL3",22,0)
 .S DRUG=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")
"RTN","PSOORRL3",23,0)
 .S ^TMP("PSO",$J,DRUG,ST,TFN,0)=IFN_"R;O"_"^"_DRUG_"^^"_$P(RX2,"^",6)_"^"_($P(RX0,"^",9)-TRM)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)
"RTN","PSOORRL3",24,0)
 .S ^TMP("PSO",$J,DRUG,ST,TFN,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOORRL3",25,0)
 .S ^TMP("PSO",$J,DRUG,ST,TFN,0)=^TMP("PSO",$J,DRUG,ST,TFN,0)_"^"_ST_"^"_LSTFD_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P(RX0,"^",13)_"^"_LSTRD_"^"_LSTDS
"RTN","PSOORRL3",26,0)
 .S ^TMP("PSO",$J,DRUG,ST,TFN,"SCH",0)=0
"RTN","PSOORRL3",27,0)
 .S (SCH,SC)=0 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PSO",$J,DRUG,ST,TFN,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^"),^TMP("PSO",$J,DRUG,ST,TFN,"SCH",0)=^TMP("PSO",$J,DRUG,ST,TFN,"SCH",0)+1
"RTN","PSOORRL3",28,0)
 .S ^TMP("PSO",$J,DRUG,ST,TFN,"MDR",0)=0,(MDR,MR)=0 F  S MR=$O(^PSRX(IFN,"MEDR",MR)) Q:'MR  D
"RTN","PSOORRL3",29,0)
 ..Q:'$D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0))  S MDR=MDR+1
"RTN","PSOORRL3",30,0)
 ..I $P($G(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),"^",3)]"" S ^TMP("PSO",$J,DRUG,ST,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^",3)
"RTN","PSOORRL3",31,0)
 ..I $D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),$P($G(^(0)),"^",3)']"" S ^TMP("PSO",$J,DRUG,ST,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^")
"RTN","PSOORRL3",32,0)
 ..S ^TMP("PSO",$J,DRUG,ST,TFN,"MDR",0)=^TMP("PSO",$J,DRUG,ST,TFN,"MDR",0)+1
"RTN","PSOORRL3",33,0)
 .S PSOELSE=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S PSOELSE=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG1^PSOORRL1
"RTN","PSOORRL3",34,0)
 .I '$G(PSOELSE) S ITFN=1 D
"RTN","PSOORRL3",35,0)
 ..S ^TMP("PSO",$J,DRUG,ST,TFN,"SIG",ITFN,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PSO",$J,DRUG,ST,TFN,"SIG",0)=+$G(^TMP("PSO",$J,DRUG,ST,TFN,"SIG",0))+1
"RTN","PSOORRL3",36,0)
 ..F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S ITFN=ITFN+1,^TMP("PSO",$J,DRUG,ST,TFN,"SIG",ITFN,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PSO",$J,DRUG,ST,TFN,"SIG",0)=+$G(^TMP("PSO",$J,DRUG,ST,TFN,"SIG",0))+1
"RTN","PSOORRL3",37,0)
 K PSOELSE D NVA
"RTN","PSOORRL3",38,0)
 S PSG="",J=1 F  S PSG=$O(^TMP("PSO",$J,PSG)) Q:PSG=""  S PST="" F  S PST=$O(^TMP("PSO",$J,PSG,PST)) Q:PST=""  S I=0 F  S I=$O(^TMP("PSO",$J,PSG,PST,I)) Q:'I  D
"RTN","PSOORRL3",39,0)
 .M ^TMP("PS",$J,J)=^TMP("PSO",$J,PSG,PST,I) S J=J+1
"RTN","PSOORRL3",40,0)
 S PSG="" F  S PSG=$O(^TMP("PS1",$J,PSG)) Q:PSG=""  S PST="" F  S PST=$O(^TMP("PS1",$J,PSG,PST)) Q:PST=""  S I=0 F  S I=$O(^TMP("PS1",$J,PSG,PST,I)) Q:I=""  D
"RTN","PSOORRL3",41,0)
 .M ^TMP("PS",$J,J)=^TMP("PS1",$J,PSG,PST,I) S J=J+1
"RTN","PSOORRL3",42,0)
 K ^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRL3",43,0)
 D OCL^PSJORRE(DFN,BDT,EDT,.TFN,+$G(VIEW)) D END^PSOORRL1
"RTN","PSOORRL3",44,0)
 K SDT,SDT1,ST,DRUG,PSG,PST,PSD,EDT,EDT1,BDT,DBT1,X
"RTN","PSOORRL3",45,0)
 Q
"RTN","PSOORRL3",46,0)
NVA ; Set Non-VA Med Orders in the ^TMP Global
"RTN","PSOORRL3",47,0)
 ;BHW;PSO*7*159;New SDT,SDT1 Variables
"RTN","PSOORRL3",48,0)
 ;BDT - ORCH CONTEXT MEDS START DATE
"RTN","PSOORRL3",49,0)
 ;EDT - ORCH CONTEXT MEDS END DATE
"RTN","PSOORRL3",50,0)
 ;SDT - NON-VA MED START DATE
"RTN","PSOORRL3",51,0)
 ;PSODCDT - NON-VA MED DISCONTINUE DATE
"RTN","PSOORRL3",52,0)
 N SDT,SDT1,PSOACT,PSODC,PSODCDT,PSOBDT,PSOEDT
"RTN","PSOORRL3",53,0)
 S PSOBDT=$G(BDT),PSOEDT=$G(EDT)
"RTN","PSOORRL3",54,0)
 I 'PSOBDT,'PSOEDT S PSOBDT=PSBDT,PSOEDT=DT  ;*381
"RTN","PSOORRL3",55,0)
 I PSOBDT,'PSOEDT S PSOEDT=DT   ;*381
"RTN","PSOORRL3",56,0)
 F I=0:0 S I=$O(^PS(55,DFN,"NVA",I)) Q:'I  S X=$G(^PS(55,DFN,"NVA",I,0)) D
"RTN","PSOORRL3",57,0)
 .Q:'$P(X,"^")
"RTN","PSOORRL3",58,0)
 .S DRG=$S($P(X,"^",2):$P($G(^PSDRUG($P(X,"^",2),0)),"^"),1:$P(^PS(50.7,$P(X,"^"),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(X,"^"),0),"^",2),0),"^"))
"RTN","PSOORRL3",59,0)
 .S SDT=$P(X,"^",9),PSODCDT=$P(X,"^",7)  ;*331
"RTN","PSOORRL3",60,0)
 .S (PSOACT,PSODC)=0
"RTN","PSOORRL3",61,0)
 .I 'PSODCDT S PSOACT=1
"RTN","PSOORRL3",62,0)
 .I PSODCDT S PSODC=1
"RTN","PSOORRL3",63,0)
 .I PSOACT D  ;ACTIVE NON-VA MED
"RTN","PSOORRL3",64,0)
 ..I 'SDT D TMPBLD Q
"RTN","PSOORRL3",65,0)
 ..I $E(SDT,4,5),$E(SDT,6,7) D
"RTN","PSOORRL3",66,0)
 ...I SDT>$G(PSOEDT) Q
"RTN","PSOORRL3",67,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRL3",68,0)
 ..I $E(SDT,4,5),'$E(SDT,6,7) D  Q
"RTN","PSOORRL3",69,0)
 ...S SDT1=$E(SDT,1,5),BDT1=$E(+$G(PSOBDT),1,5),EDT1=$E(+$G(PSOEDT),1,5)
"RTN","PSOORRL3",70,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRL3",71,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRL3",72,0)
 ..I '$E(SDT,4,5),'$E(SDT,6,7) D  Q
"RTN","PSOORRL3",73,0)
 ...S SDT1=$E(SDT,1,3),BDT1=$E(+$G(PSOBDT),1,3),EDT1=$E(+$G(PSOEDT),1,3)
"RTN","PSOORRL3",74,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRL3",75,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRL3",76,0)
 .I PSODC D  ;DISCONTINUED NON-VA MED
"RTN","PSOORRL3",77,0)
 ..I SDT="",PSODCDT>$G(PSOBDT) D TMPBLD Q  ;NO MED START DATE AND MED DC DATE AFTER PARAM START DATE
"RTN","PSOORRL3",78,0)
 ..I PSODCDT<$G(PSOBDT) Q  ;QUIT IF MED DC DATE BEFORE PARAM START DATE
"RTN","PSOORRL3",79,0)
 ..I SDT>$G(PSOEDT) Q  ;QUIT IF MED START DATE AFTER PARAM END DATE
"RTN","PSOORRL3",80,0)
 ..D TMPBLD Q
"RTN","PSOORRL3",81,0)
 Q
"RTN","PSOORRL3",82,0)
TMPBLD S TFN=$G(TFN)+1,ST="ACTIVE"
"RTN","PSOORRL3",83,0)
 S ^TMP("PS1",$J,DRG,ST,TFN,0)=I_"N;O^"_DRG
"RTN","PSOORRL3",84,0)
 S $P(^TMP("PS1",$J,DRG,ST,TFN,0),"^",8)=$P(X,"^",8)_"^"_$S($P(X,"^",7):"DISCONTINUED",1:"ACTIVE")
"RTN","PSOORRL3",85,0)
 S ^TMP("PS1",$J,DRG,ST,TFN,"SCH",0)=1,^TMP("PS1",$J,DRG,ST,TFN,"SCH",1,0)=$P(X,"^",5)
"RTN","PSOORRL3",86,0)
 S ^TMP("PS1",$J,DRG,ST,TFN,"SIG",0)=1,^TMP("PS1",$J,DRG,ST,TFN,"SIG",1,0)=$P(X,"^",3)_" "_$P(X,"^",4)_" "_$P(X,"^",5)
"RTN","PSOORRL3",87,0)
 Q
"RTN","PSOORRLN")
0^1^B47940442^B46517542
"RTN","PSOORRLN",1,0)
PSOORRLN ;BHAM ISC/SJA - returns patient's outpatient meds-new sort ;10/12/06
"RTN","PSOORRLN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,331,381**;DEC 1997;Build 4
"RTN","PSOORRLN",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORRLN",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRLN",5,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOORRLN",6,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORRLN",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORRLN",8,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORRLN",9,0)
 ;External reference to OCL^PSJORRE supported by DBIA 2383
"RTN","PSOORRLN",10,0)
OCL ;entry point to return condensed list
"RTN","PSOORRLN",11,0)
 ;BHW;PSO*7*159;New SD* Variables
"RTN","PSOORRLN",12,0)
 N SD,SDT,SDT1,ST,STT,PSG,PST,PSD,GP,DRUG
"RTN","PSOORRLN",13,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOORRLN",14,0)
 K ^TMP("PS",$J),^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRLN",15,0)
 S TFN=0,PSBDT=$G(BDT),PSEDT=$G(EDT) I +$G(PSBDT)<1 S X1=DT,X2=-120 D C^%DTC S PSBDT=X
"RTN","PSOORRLN",16,0)
 S EXDT=PSBDT-1,IFN=0
"RTN","PSOORRLN",17,0)
 F  S EXDT=$O(^PS(55,DFN,"P","A",EXDT)) Q:'EXDT  F  S IFN=$O(^PS(55,DFN,"P","A",EXDT,IFN)) Q:'IFN  D:$D(^PSRX(IFN,0))
"RTN","PSOORRLN",18,0)
 .Q:$P($G(^PSRX(IFN,"STA")),"^")=13
"RTN","PSOORRLN",19,0)
 .S TFN=TFN+1,RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2),LSTRD=$P(RX2,"^",13),LSTDS=$P(RX0,"^",8)
"RTN","PSOORRLN",20,0)
 .F I=0:0 S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^"),LSTDS=$P(^(0),"^",10) S:$P(^(0),"^",18)]"" LSTRD=$P(^(0),"^",18)
"RTN","PSOORRLN",21,0)
 .S ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOORRLN",22,0)
 .S STT=$P("ERROR^ACTIVE;1:1^NON-VERIFIED;2:1^REFILL FILL;1:2^HOLD;1:3^NON-VERIFIED;2:1^ACTIVE/SUSP;1:1^^^^^DONE;3:1^EXPIRED;3:2^DISCONTINUED;3:3^DISCONTINUED;3:3^DISCONTINUED;3:3^DISCONTINUED (EDIT);3:6^HOLD;1:3^","^",ST0+2)
"RTN","PSOORRLN",23,0)
 .S ST=$P(STT,";"),GP=$P(STT,";",2)
"RTN","PSOORRLN",24,0)
 .;Status Groups: 1-ACTIVE, 2-PENDING, , 3-DISCONTINUED 
"RTN","PSOORRLN",25,0)
 .S DRUG=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")
"RTN","PSOORRLN",26,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,0)=IFN_"R;O"_"^"_DRUG_"^^"_$P(RX2,"^",6)_"^"_($P(RX0,"^",9)-TRM)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)
"RTN","PSOORRLN",27,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOORRLN",28,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,0)=^TMP("PSO",$J,GP,ST,DRUG,TFN,0)_"^"_ST_"^"_LSTFD_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P(RX0,"^",13)_"^"_LSTRD_"^"_LSTDS
"RTN","PSOORRLN",29,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",0)=0
"RTN","PSOORRLN",30,0)
 .S (SCH,SC)=0 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^"),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",0)=^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",0)+1
"RTN","PSOORRLN",31,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"MDR",0)=0,(MDR,MR)=0 F  S MR=$O(^PSRX(IFN,"MEDR",MR)) Q:'MR  D
"RTN","PSOORRLN",32,0)
 ..Q:'$D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0))  S MDR=MDR+1
"RTN","PSOORRLN",33,0)
 ..I $P($G(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),"^",3)]"" S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^",3)
"RTN","PSOORRLN",34,0)
 ..I $D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),$P($G(^(0)),"^",3)']"" S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^")
"RTN","PSOORRLN",35,0)
 ..S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"MDR",0)=^TMP("PSO",$J,GP,ST,DRUG,TFN,"MDR",0)+1
"RTN","PSOORRLN",36,0)
 .S PSOELSE=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S PSOELSE=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG1^PSOORRL1
"RTN","PSOORRLN",37,0)
 .I '$G(PSOELSE) S ITFN=1 D
"RTN","PSOORRLN",38,0)
 ..S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",ITFN,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",0)=+$G(^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",0))+1
"RTN","PSOORRLN",39,0)
 ..F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S ITFN=ITFN+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",ITFN,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",0)=+$G(^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",0))+1
"RTN","PSOORRLN",40,0)
 K PSOELSE
"RTN","PSOORRLN",41,0)
 S IFN=0 F  S IFN=$O(^PS(52.41,"P",DFN,IFN)) Q:'IFN  S PSOR=^PS(52.41,IFN,0) D:$P(PSOR,"^",3)="" WAIT D:$P(PSOR,"^",3)'="DC"&($P(PSOR,"^",3)'="DE")&($P(PSOR,"^",3)'="")
"RTN","PSOORRLN",42,0)
 .S ST="PENDING",GP="2:4"
"RTN","PSOORRLN",43,0)
 .Q:$P(PSOR,"^",3)="RF"
"RTN","PSOORRLN",44,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" D WAIT
"RTN","PSOORRLN",45,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" Q  ; QUIT IF STILL NULL AFTER WAITING
"RTN","PSOORRLN",46,0)
 .S DRUG=$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^")),TFN=TFN+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,0)=IFN_"P;O^"_DRUG
"RTN","PSOORRLN",47,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,0)=^TMP("PSO",$J,GP,ST,DRUG,TFN,0)_"^^^^^^"_$P(PSOR,"^")_"^"_"PENDING^^^"_$P(PSOR,"^",10)_"^"
"RTN","PSOORRLN",48,0)
 .S ^TMP("PSO",$J,GP,ST,DRUG,TFN,0)=^TMP("PSO",$J,GP,ST,DRUG,TFN,0)_"^"_$S($P(PSOR,"^",3)="RNW":1,1:0)
"RTN","PSOORRLN",49,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,1,SCH)) Q:'SCH  S SD=SD+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",SD,0)=$P(^PS(52.41,IFN,1,SCH,1),"^"),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SCH",0)=SD
"RTN","PSOORRLN",50,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,"SIG",SCH)) Q:'SCH  S SD=SD+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",SD,0)=$P(^PS(52.41,IFN,"SIG",SCH,0),"^"),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIG",0)=SD
"RTN","PSOORRLN",51,0)
 .S (IEN,SD)=1,INST=0 F  S INST=$O(^PS(52.41,IFN,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,IFN,2,INST,0),^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIO",0)=SD D
"RTN","PSOORRLN",52,0)
 ..F SG=1:1:$L(MIG," ") S:$L($G(^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG))>80 IEN=IEN+1,SD=SD+1,^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIO",0)=SD D
"RTN","PSOORRLN",53,0)
 ...S ^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIO",IEN,0)=$G(^TMP("PSO",$J,GP,ST,DRUG,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORRLN",54,0)
 D NVA
"RTN","PSOORRLN",55,0)
 S PSG=0,J=1 F  S PSG=$O(^TMP("PSO",$J,PSG)) Q:'PSG  S PST="" F  S PST=$O(^TMP("PSO",$J,PSG,PST)) Q:PST=""  S PSD="" F  S PSD=$O(^TMP("PSO",$J,PSG,PST,PSD)) Q:PSD=""  S I=0 F  S I=$O(^TMP("PSO",$J,PSG,PST,PSD,I)) Q:'I  D
"RTN","PSOORRLN",56,0)
 .M ^TMP("PS",$J,J)=^TMP("PSO",$J,PSG,PST,PSD,I) S J=J+1
"RTN","PSOORRLN",57,0)
 S PSG=0 F  S PSG=$O(^TMP("PS1",$J,PSG)) Q:'PSG  S PST="" F  S PST=$O(^TMP("PS1",$J,PSG,PST)) Q:PST=""  S PSD="" F  S PSD=$O(^TMP("PS1",$J,PSG,PST,PSD)) Q:PSD=""  S I=0 F  S I=$O(^TMP("PS1",$J,PSG,PST,PSD,I)) Q:'I  D
"RTN","PSOORRLN",58,0)
 .M ^TMP("PS",$J,J)=^TMP("PS1",$J,PSG,PST,PSD,I) S J=J+1
"RTN","PSOORRLN",59,0)
 K ^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRLN",60,0)
 D OCL^PSJORRE(DFN,BDT,EDT,.TFN,+$G(VIEW)) D END^PSOORRL1
"RTN","PSOORRLN",61,0)
 K SDT,SDT1,GP,ST,DRUG,PSG,PST,PSD,EDT,EDT1,BDT,DBT1,X
"RTN","PSOORRLN",62,0)
 Q
"RTN","PSOORRLN",63,0)
WAIT ; IF PENDING ENTRY STILL BEING BUILT SEE IF IT COMPLETES WITHIN ANOTHER SECOND
"RTN","PSOORRLN",64,0)
 H 1 S PSOR=$G(^PS(52.41,IFN,0))
"RTN","PSOORRLN",65,0)
 Q
"RTN","PSOORRLN",66,0)
 ;
"RTN","PSOORRLN",67,0)
NVA ; Set Non-VA Med Orders in the ^TMP Global
"RTN","PSOORRLN",68,0)
 ;BHW;PSO*7*159;New SDT,SDT1 Variables
"RTN","PSOORRLN",69,0)
 ;BDT - ORCH CONTEXT MEDS START DATE
"RTN","PSOORRLN",70,0)
 ;EDT - ORCH CONTEXT MEDS END DATE
"RTN","PSOORRLN",71,0)
 ;SDT - NON-VA MED START DATE
"RTN","PSOORRLN",72,0)
 ;PSODCDT - NON-VA MED DISCONTINUE DATE
"RTN","PSOORRLN",73,0)
 N SDT,SDT1,PSODCDT,PSODC,PSOACT,PSOBDT,PSOEDT
"RTN","PSOORRLN",74,0)
 S PSOBDT=$G(BDT),PSOEDT=$G(EDT)
"RTN","PSOORRLN",75,0)
 I 'PSOBDT,'PSOEDT S PSOBDT=PSBDT,PSOEDT=DT  ;*381
"RTN","PSOORRLN",76,0)
 I PSOBDT,'PSOEDT S PSOEDT=DT   ;*381
"RTN","PSOORRLN",77,0)
 F I=0:0 S I=$O(^PS(55,DFN,"NVA",I)) Q:'I  S X=$G(^PS(55,DFN,"NVA",I,0)) D
"RTN","PSOORRLN",78,0)
 .Q:'$P(X,"^")
"RTN","PSOORRLN",79,0)
 .S DRG=$S($P(X,"^",2):$P($G(^PSDRUG($P(X,"^",2),0)),"^"),1:$P(^PS(50.7,$P(X,"^"),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(X,"^"),0),"^",2),0),"^"))
"RTN","PSOORRLN",80,0)
 .S SDT=$P(X,"^",9),PSODCDT=$P(X,"^",7)
"RTN","PSOORRLN",81,0)
 .S (PSOACT,PSODC)=0
"RTN","PSOORRLN",82,0)
 .I 'PSODCDT S PSOACT=1
"RTN","PSOORRLN",83,0)
 .I PSODCDT S PSODC=1
"RTN","PSOORRLN",84,0)
 .I PSOACT D   ;ACTIVE NON-VA MED
"RTN","PSOORRLN",85,0)
 ..I 'SDT D TMPBLD Q
"RTN","PSOORRLN",86,0)
 ..I $E(SDT,4,5),$E(SDT,6,7) D
"RTN","PSOORRLN",87,0)
 ...I SDT>$G(PSOEDT) Q
"RTN","PSOORRLN",88,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLN",89,0)
 ..I $E(SDT,4,5),'$E(SDT,6,7) D
"RTN","PSOORRLN",90,0)
 ...S SDT1=$E(SDT,1,5),BDT1=$E(+$G(PSOBDT),1,5),EDT1=$E(+$G(PSOEDT),1,5)
"RTN","PSOORRLN",91,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRLN",92,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLN",93,0)
 ..I '$E(SDT,4,5),'$E(SDT,6,7) D
"RTN","PSOORRLN",94,0)
 ...S SDT1=$E(SDT,1,3),BDT1=$E(+$G(PSOBDT),1,3),EDT1=$E(+$G(PSOEDT),1,3)
"RTN","PSOORRLN",95,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRLN",96,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLN",97,0)
 .I PSODC D   ;DISCONTINUED NON-VA MED
"RTN","PSOORRLN",98,0)
 ..I SDT="",PSODCDT>$G(PSOBDT) D TMPBLD Q  ;NO MED START DATE AND MED DC DATE AFTER PARAM START DATE
"RTN","PSOORRLN",99,0)
 ..I PSODCDT<$G(PSOBDT) Q  ;QUIT IF MED DC DATE BEFORE PARAM START DATE
"RTN","PSOORRLN",100,0)
 ..I SDT>$G(PSOEDT) Q  ;QUIT IF MED START DATE AFTER PARAM END DATE
"RTN","PSOORRLN",101,0)
 ..D TMPBLD
"RTN","PSOORRLN",102,0)
 Q
"RTN","PSOORRLN",103,0)
TMPBLD S TFN=$G(TFN)+1
"RTN","PSOORRLN",104,0)
 S ST=$S($P(X,"^",7):"DISCONTINUED",1:"ACTIVE"),GP=$S(ST="ACTIVE":1,1:3)
"RTN","PSOORRLN",105,0)
 S ^TMP("PS1",$J,GP,ST,DRG,TFN,0)=I_"N;O^"_DRG
"RTN","PSOORRLN",106,0)
 S $P(^TMP("PS1",$J,GP,ST,DRG,TFN,0),"^",8)=$P(X,"^",8)_"^"_$S($P(X,"^",7):"DISCONTINUED",1:"ACTIVE")
"RTN","PSOORRLN",107,0)
 S ^TMP("PS1",$J,GP,ST,DRG,TFN,"SCH",0)=1,^TMP("PS1",$J,GP,ST,DRG,TFN,"SCH",1,0)=$P(X,"^",5)
"RTN","PSOORRLN",108,0)
 S ^TMP("PS1",$J,GP,ST,DRG,TFN,"SIG",0)=1,^TMP("PS1",$J,GP,ST,DRG,TFN,"SIG",1,0)=$P(X,"^",3)_" "_$P(X,"^",4)_" "_$P(X,"^",5)
"RTN","PSOORRLN",109,0)
 Q
"RTN","PSOORRLO")
0^2^B43456969^B42050035
"RTN","PSOORRLO",1,0)
PSOORRLO ;BHAM ISC/SJA - returns patient's outpatient meds-original sort ;10/12/06
"RTN","PSOORRLO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**225,331,381**;DEC 1997;Build 4
"RTN","PSOORRLO",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORRLO",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRLO",5,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSOORRLO",6,0)
 ;External reference to(51.2 supported by DBIA 2226
"RTN","PSOORRLO",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORRLO",8,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOORRLO",9,0)
 ;External reference to OCL^PSJORRE supported by DBIA 2383
"RTN","PSOORRLO",10,0)
OCL ;entry point to return condensed list
"RTN","PSOORRLO",11,0)
 ;BHW;PSO*7*159;New SD* Variables
"RTN","PSOORRLO",12,0)
 N SD,SDT,SDT1,ST,STT,PSEX,PSG,PST,GP,EXDT1
"RTN","PSOORRLO",13,0)
 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOORRLO",14,0)
 K ^TMP("PS",$J),^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRLO",15,0)
 S TFN=0,PSBDT=$G(BDT),PSEDT=$G(EDT) I +$G(PSBDT)<1 S X1=DT,X2=-120 D C^%DTC S PSBDT=X
"RTN","PSOORRLO",16,0)
 S EXDT=PSBDT-1,IFN=0
"RTN","PSOORRLO",17,0)
 F  S EXDT=$O(^PS(55,DFN,"P","A",EXDT)) Q:'EXDT  F  S IFN=$O(^PS(55,DFN,"P","A",EXDT,IFN)) Q:'IFN  D:$D(^PSRX(IFN,0))
"RTN","PSOORRLO",18,0)
 .S EXDT1=9999999-EXDT
"RTN","PSOORRLO",19,0)
 .Q:$P($G(^PSRX(IFN,"STA")),"^")=13
"RTN","PSOORRLO",20,0)
 .S TFN=TFN+1,RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2),LSTRD=$P(RX2,"^",13),LSTDS=$P(RX0,"^",8)
"RTN","PSOORRLO",21,0)
 .F I=0:0 S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^"),LSTDS=$P(^(0),"^",10) S:$P(^(0),"^",18)]"" LSTRD=$P(^(0),"^",18)
"RTN","PSOORRLO",22,0)
 .S ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOORRLO",23,0)
 .S STT=$P("ERROR^ACTIVE;2:1^NON-VERIFIED;1:1^REFILL FILL;2:3^HOLD;2:7^NON-VERIFIED;1:1^ACTIVE/SUSP;2:6^^^^^DONE;2:9^EXPIRED;3:1^DISCONTINUED;4:3^DISCONTINUED;4:3^DISCONTINUED;4:3^DISCONTINUED (EDIT);4:4^HOLD;2:7^","^",ST0+2)
"RTN","PSOORRLO",24,0)
 .S ST=$P(STT,";"),GP=$P(STT,";",2)
"RTN","PSOORRLO",25,0)
 .;Status Groups: 1-PENDING, 2-ACTIVE, 3-Expired, 4-DISCONTINUED 
"RTN","PSOORRLO",26,0)
 .S ^TMP("PSO",$J,GP,EXDT1,TFN,0)=IFN_"R;O"_"^"_$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")_"^^"_$P(RX2,"^",6)_"^"_($P(RX0,"^",9)-TRM)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)
"RTN","PSOORRLO",27,0)
 .S ^TMP("PSO",$J,GP,EXDT1,TFN,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOORRLO",28,0)
 .S ^TMP("PSO",$J,GP,EXDT1,TFN,0)=^TMP("PSO",$J,GP,EXDT1,TFN,0)_"^"_ST_"^"_LSTFD_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P(RX0,"^",13)_"^"_LSTRD_"^"_LSTDS
"RTN","PSOORRLO",29,0)
 .S ^TMP("PSO",$J,GP,EXDT1,TFN,"SCH",0)=0
"RTN","PSOORRLO",30,0)
 .S (SCH,SC)=0 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PSO",$J,GP,EXDT1,TFN,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^"),^TMP("PSO",$J,GP,EXDT1,TFN,"SCH",0)=^TMP("PSO",$J,GP,EXDT1,TFN,"SCH",0)+1
"RTN","PSOORRLO",31,0)
 .S ^TMP("PSO",$J,GP,EXDT1,TFN,"MDR",0)=0,(MDR,MR)=0 F  S MR=$O(^PSRX(IFN,"MEDR",MR)) Q:'MR  D
"RTN","PSOORRLO",32,0)
 ..Q:'$D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0))  S MDR=MDR+1
"RTN","PSOORRLO",33,0)
 ..I $P($G(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),"^",3)]"" S ^TMP("PSO",$J,GP,EXDT1,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^",3)
"RTN","PSOORRLO",34,0)
 ..I $D(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0)),$P($G(^(0)),"^",3)']"" S ^TMP("PSO",$J,GP,EXDT1,TFN,"MDR",MDR,0)=$P(^PS(51.2,+^PSRX(IFN,"MEDR",MR,0),0),"^")
"RTN","PSOORRLO",35,0)
 ..S ^TMP("PSO",$J,GP,EXDT1,TFN,"MDR",0)=^TMP("PSO",$J,GP,EXDT1,TFN,"MDR",0)+1
"RTN","PSOORRLO",36,0)
 .S PSOELSE=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S PSOELSE=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG1^PSOORRL1
"RTN","PSOORRLO",37,0)
 .I '$G(PSOELSE) S ITFN=1 D
"RTN","PSOORRLO",38,0)
 ..S ^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",ITFN,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",0)=+$G(^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",0))+1
"RTN","PSOORRLO",39,0)
 ..F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S ITFN=ITFN+1,^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",ITFN,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",0)=+$G(^TMP("PSO",$J,GP,EXDT1,TFN,"SIG",0))+1
"RTN","PSOORRLO",40,0)
 K PSOELSE
"RTN","PSOORRLO",41,0)
 S IFN=0 F  S IFN=$O(^PS(52.41,"P",DFN,IFN)) Q:'IFN  S PSOR=^PS(52.41,IFN,0) D:$P(PSOR,"^",3)="" WAIT D:$P(PSOR,"^",3)'="DC"&($P(PSOR,"^",3)'="DE")&($P(PSOR,"^",3)'="")
"RTN","PSOORRLO",42,0)
 .S GP="1:3",PSEX="9999999"
"RTN","PSOORRLO",43,0)
 .Q:$P(PSOR,"^",3)="RF"
"RTN","PSOORRLO",44,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" D WAIT
"RTN","PSOORRLO",45,0)
 .I $P(PSOR,"^",8)="",$P(PSOR,"^",9)="" Q  ; QUIT IF STILL NULL AFTER WAITING
"RTN","PSOORRLO",46,0)
 .S TFN=TFN+1,^TMP("PSO",$J,GP,PSEX,TFN,0)=IFN_"P;O^"_$S($P(PSOR,"^",9):$P($G(^PSDRUG($P(PSOR,"^",9),0)),"^"),1:$P(^PS(50.7,$P(PSOR,"^",8),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(PSOR,"^",8),0),"^",2),0),"^"))
"RTN","PSOORRLO",47,0)
 .S ^TMP("PSO",$J,GP,PSEX,TFN,0)=^TMP("PSO",$J,GP,PSEX,TFN,0)_"^^^^^^"_$P(PSOR,"^")_"^"_"PENDING^^^"_$P(PSOR,"^",10)_"^"
"RTN","PSOORRLO",48,0)
 .S ^TMP("PSO",$J,GP,PSEX,TFN,0)=^TMP("PSO",$J,GP,PSEX,TFN,0)_"^"_$S($P(PSOR,"^",3)="RNW":1,1:0)
"RTN","PSOORRLO",49,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,1,SCH)) Q:'SCH  S SD=SD+1,^TMP("PSO",$J,GP,PSEX,TFN,"SCH",SD,0)=$P(^PS(52.41,IFN,1,SCH,1),"^"),^TMP("PSO",$J,GP,PSEX,TFN,"SCH",0)=SD
"RTN","PSOORRLO",50,0)
 .S SD=0 F SCH=0:0 S SCH=$O(^PS(52.41,IFN,"SIG",SCH)) Q:'SCH  S SD=SD+1,^TMP("PSO",$J,GP,PSEX,TFN,"SIG",SD,0)=$P(^PS(52.41,IFN,"SIG",SCH,0),"^"),^TMP("PSO",$J,GP,PSEX,TFN,"SIG",0)=SD
"RTN","PSOORRLO",51,0)
 .S (IEN,SD)=1,INST=0 F  S INST=$O(^PS(52.41,IFN,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,IFN,2,INST,0),^TMP("PSO",$J,GP,PSEX,TFN,"SIO",0)=SD D
"RTN","PSOORRLO",52,0)
 ..F SG=1:1:$L(MIG," ") S:$L($G(^TMP("PSO",$J,GP,PSEX,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG))>80 IEN=IEN+1,SD=SD+1,^TMP("PSO",$J,GP,PSEX,TFN,"SIO",0)=SD D
"RTN","PSOORRLO",53,0)
 ...S ^TMP("PSO",$J,GP,PSEX,TFN,"SIO",IEN,0)=$G(^TMP("PSO",$J,GP,PSEX,TFN,"SIO",IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORRLO",54,0)
 D NVA
"RTN","PSOORRLO",55,0)
 S PSG=0,J=1 F  S PSG=$O(^TMP("PSO",$J,PSG)) Q:'PSG  S PST="" F  S PST=$O(^TMP("PSO",$J,PSG,PST)) Q:PST=""  S I=0 F  S I=$O(^TMP("PSO",$J,PSG,PST,I)) Q:'I  D
"RTN","PSOORRLO",56,0)
 .M ^TMP("PS",$J,J)=^TMP("PSO",$J,PSG,PST,I) S J=J+1
"RTN","PSOORRLO",57,0)
 S PSG=0 F  S PSG=$O(^TMP("PS1",$J,PSG)) Q:'PSG  S I=0 F  S I=$O(^TMP("PS1",$J,PSG,I)) Q:'I  D
"RTN","PSOORRLO",58,0)
 .M ^TMP("PS",$J,J)=^TMP("PS1",$J,PSG,I) S J=J+1
"RTN","PSOORRLO",59,0)
 K ^TMP("PSO",$J),^TMP("PS1",$J)
"RTN","PSOORRLO",60,0)
 D OCL^PSJORRE(DFN,BDT,EDT,.TFN,+$G(VIEW)) D END^PSOORRL1
"RTN","PSOORRLO",61,0)
 K SDT,SDT1,GP,PSEX,PSG,PST,EDT,EDT1,BDT,DBT1,X
"RTN","PSOORRLO",62,0)
 Q
"RTN","PSOORRLO",63,0)
WAIT ; IF PENDING ENTRY STILL BEING BUILT SEE IF IT COMPLETES WITHIN ANOTHER SECOND
"RTN","PSOORRLO",64,0)
 H 1 S PSOR=$G(^PS(52.41,IFN,0))
"RTN","PSOORRLO",65,0)
 Q
"RTN","PSOORRLO",66,0)
 ;
"RTN","PSOORRLO",67,0)
NVA ; Set Non-VA Med Orders in the ^TMP Global
"RTN","PSOORRLO",68,0)
 ;BHW;PSO*7*159;New SDT,SDT1 Variables
"RTN","PSOORRLO",69,0)
 ;BDT - ORCH CONTEXT MEDS START DATE
"RTN","PSOORRLO",70,0)
 ;EDT - ORCH CONTEXT MEDS END DATE
"RTN","PSOORRLO",71,0)
 ;SDT - NON-VA MED START DATE
"RTN","PSOORRLO",72,0)
 ;PSODCDT - NON-VA MED DISCONTINUE DATE
"RTN","PSOORRLO",73,0)
 N SDT,SDT1,PSODCDT,PSODC,PSOACT,PSOBDT,PSOEDT
"RTN","PSOORRLO",74,0)
 S PSOBDT=$G(BDT),PSOEDT=$G(EDT)
"RTN","PSOORRLO",75,0)
 I 'PSOBDT,'PSOEDT S PSOBDT=PSBDT,PSOEDT=DT  ;*381
"RTN","PSOORRLO",76,0)
 I PSOBDT,'PSOEDT S PSOEDT=DT   ;*381
"RTN","PSOORRLO",77,0)
 F I=0:0 S I=$O(^PS(55,DFN,"NVA",I)) Q:'I  S X=$G(^PS(55,DFN,"NVA",I,0)) D
"RTN","PSOORRLO",78,0)
 .Q:'$P(X,"^")
"RTN","PSOORRLO",79,0)
 .S DRG=$S($P(X,"^",2):$P($G(^PSDRUG($P(X,"^",2),0)),"^"),1:$P(^PS(50.7,$P(X,"^"),0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,$P(X,"^"),0),"^",2),0),"^"))
"RTN","PSOORRLO",80,0)
 .S SDT=$P(X,"^",9),PSODCDT=$P(X,"^",7)  ;*331
"RTN","PSOORRLO",81,0)
 .S (PSOACT,PSODC)=0
"RTN","PSOORRLO",82,0)
 .I 'PSODCDT S PSOACT=1
"RTN","PSOORRLO",83,0)
 .I PSODCDT S PSODC=1
"RTN","PSOORRLO",84,0)
 .I PSOACT D  ;ACTIVE NON-VA MED
"RTN","PSOORRLO",85,0)
 ..I 'SDT D TMPBLD Q
"RTN","PSOORRLO",86,0)
 ..I $E(SDT,4,5),$E(SDT,6,7) D
"RTN","PSOORRLO",87,0)
 ...I SDT>$G(PSOEDT) Q
"RTN","PSOORRLO",88,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLO",89,0)
 ..I $E(SDT,4,5),'$E(SDT,6,7) D  Q
"RTN","PSOORRLO",90,0)
 ...S SDT1=$E(SDT,1,5),BDT1=$E(+$G(PSOBDT),1,5),EDT1=$E(+$G(PSOEDT),1,5)
"RTN","PSOORRLO",91,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRLO",92,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLO",93,0)
 ..I '$E(SDT,4,5),'$E(SDT,6,7) D  Q
"RTN","PSOORRLO",94,0)
 ...S SDT1=$E(SDT,1,3),BDT1=$E(+$G(PSOBDT),1,3),EDT1=$E(+$G(PSOEDT),1,3)
"RTN","PSOORRLO",95,0)
 ...I SDT1>EDT1 Q
"RTN","PSOORRLO",96,0)
 ...D TMPBLD  ;MED START DATE PRIOR TO PARAM. END DATE
"RTN","PSOORRLO",97,0)
 .I PSODC D  ;DISCONTINUED NON-VA MED
"RTN","PSOORRLO",98,0)
 ..I SDT="",PSODCDT>$G(PSOBDT) D TMPBLD Q  ;NO MED START DATE AND MED DC DATE AFTER PARAM START DATE
"RTN","PSOORRLO",99,0)
 ..I PSODCDT<$G(PSOBDT) Q  ;QUIT IF MED DC DATE BEFORE PARAM START DATE
"RTN","PSOORRLO",100,0)
 ..I SDT>$G(PSOEDT) Q  ;QUIT IF MED START DATE AFTER PARAM END DATE
"RTN","PSOORRLO",101,0)
 ..D TMPBLD
"RTN","PSOORRLO",102,0)
 Q
"RTN","PSOORRLO",103,0)
TMPBLD S TFN=$G(TFN)+1,GP=$S($P(X,"^",7):3,1:2)
"RTN","PSOORRLO",104,0)
 S ^TMP("PS1",$J,GP,TFN,0)=I_"N;O^"_DRG
"RTN","PSOORRLO",105,0)
 S $P(^TMP("PS1",$J,GP,TFN,0),"^",8)=$P(X,"^",8)_"^"_$S($P(X,"^",7):"DISCONTINUED",1:"ACTIVE")
"RTN","PSOORRLO",106,0)
 S ^TMP("PS1",$J,GP,TFN,"SCH",0)=1,^TMP("PS1",$J,GP,TFN,"SCH",1,0)=$P(X,"^",5)
"RTN","PSOORRLO",107,0)
 S ^TMP("PS1",$J,GP,TFN,"SIG",0)=1,^TMP("PS1",$J,GP,TFN,"SIG",1,0)=$P(X,"^",3)_" "_$P(X,"^",4)_" "_$P(X,"^",5)
"RTN","PSOORRLO",108,0)
 Q
"VER")
8.0^22.0
"BLD",7949,6)
^324
**END**
**END**
