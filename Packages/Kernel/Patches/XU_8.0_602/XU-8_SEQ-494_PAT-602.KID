Released XU*8*602 SEQ #494
Extracted from mail message
**KIDS**:XU*8.0*602^

**INSTALL NAME**
XU*8.0*602
"BLD",1446,0)
XU*8.0*602^KERNEL^0^3121023^y
"BLD",1446,1,0)
^^2^2^3120709^
"BLD",1446,1,1,0)
The description of this build can be found in the National Patch Module 
"BLD",1446,1,2,0)
under patch XU*8*602.
"BLD",1446,4,0)
^9.64PA^^0
"BLD",1446,6.3)
9
"BLD",1446,"KRN",0)
^9.67PA^9002226^21
"BLD",1446,"KRN",.4,0)
.4
"BLD",1446,"KRN",.401,0)
.401
"BLD",1446,"KRN",.402,0)
.402
"BLD",1446,"KRN",.403,0)
.403
"BLD",1446,"KRN",.5,0)
.5
"BLD",1446,"KRN",.84,0)
.84
"BLD",1446,"KRN",3.6,0)
3.6
"BLD",1446,"KRN",3.8,0)
3.8
"BLD",1446,"KRN",9.2,0)
9.2
"BLD",1446,"KRN",9.8,0)
9.8
"BLD",1446,"KRN",9.8,"NM",0)
^9.68A^12^12
"BLD",1446,"KRN",9.8,"NM",1,0)
XQALSURO^^0^B93224133
"BLD",1446,"KRN",9.8,"NM",2,0)
XQALFWD^^0^B28643229
"BLD",1446,"KRN",9.8,"NM",3,0)
XQALERT^^0^B19925402
"BLD",1446,"KRN",9.8,"NM",4,0)
XQALERT1^^0^B93213944
"BLD",1446,"KRN",9.8,"NM",5,0)
XQALDOIT^^0^B15175289
"BLD",1446,"KRN",9.8,"NM",6,0)
XQALDATA^^0^B11271249
"BLD",1446,"KRN",9.8,"NM",7,0)
XQALSUR1^^0^B72344647
"BLD",1446,"KRN",9.8,"NM",8,0)
XQALSUR2^^0^B5665797
"BLD",1446,"KRN",9.8,"NM",9,0)
XQALBUTL^^0^B78074082
"BLD",1446,"KRN",9.8,"NM",10,0)
XQALSET^^0^B72705650
"BLD",1446,"KRN",9.8,"NM",11,0)
XQALMAKE^^0^B13644529
"BLD",1446,"KRN",9.8,"NM",12,0)
XQALDEL^^0^B56273165
"BLD",1446,"KRN",9.8,"NM","B","XQALBUTL",9)

"BLD",1446,"KRN",9.8,"NM","B","XQALDATA",6)

"BLD",1446,"KRN",9.8,"NM","B","XQALDEL",12)

"BLD",1446,"KRN",9.8,"NM","B","XQALDOIT",5)

"BLD",1446,"KRN",9.8,"NM","B","XQALERT",3)

"BLD",1446,"KRN",9.8,"NM","B","XQALERT1",4)

"BLD",1446,"KRN",9.8,"NM","B","XQALFWD",2)

"BLD",1446,"KRN",9.8,"NM","B","XQALMAKE",11)

"BLD",1446,"KRN",9.8,"NM","B","XQALSET",10)

"BLD",1446,"KRN",9.8,"NM","B","XQALSUR1",7)

"BLD",1446,"KRN",9.8,"NM","B","XQALSUR2",8)

"BLD",1446,"KRN",9.8,"NM","B","XQALSURO",1)

"BLD",1446,"KRN",19,0)
19
"BLD",1446,"KRN",19,"NM",0)
^9.68A^^
"BLD",1446,"KRN",19.1,0)
19.1
"BLD",1446,"KRN",101,0)
101
"BLD",1446,"KRN",409.61,0)
409.61
"BLD",1446,"KRN",771,0)
771
"BLD",1446,"KRN",779.2,0)
779.2
"BLD",1446,"KRN",870,0)
870
"BLD",1446,"KRN",8989.51,0)
8989.51
"BLD",1446,"KRN",8989.52,0)
8989.52
"BLD",1446,"KRN",8994,0)
8994
"BLD",1446,"KRN",9002226,0)
9002226
"BLD",1446,"KRN","B",.4,.4)

"BLD",1446,"KRN","B",.401,.401)

"BLD",1446,"KRN","B",.402,.402)

"BLD",1446,"KRN","B",.403,.403)

"BLD",1446,"KRN","B",.5,.5)

"BLD",1446,"KRN","B",.84,.84)

"BLD",1446,"KRN","B",3.6,3.6)

"BLD",1446,"KRN","B",3.8,3.8)

"BLD",1446,"KRN","B",9.2,9.2)

"BLD",1446,"KRN","B",9.8,9.8)

"BLD",1446,"KRN","B",19,19)

"BLD",1446,"KRN","B",19.1,19.1)

"BLD",1446,"KRN","B",101,101)

"BLD",1446,"KRN","B",409.61,409.61)

"BLD",1446,"KRN","B",771,771)

"BLD",1446,"KRN","B",779.2,779.2)

"BLD",1446,"KRN","B",870,870)

"BLD",1446,"KRN","B",8989.51,8989.51)

"BLD",1446,"KRN","B",8989.52,8989.52)

"BLD",1446,"KRN","B",8994,8994)

"BLD",1446,"KRN","B",9002226,9002226)

"BLD",1446,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",1446,"QUES",0)
^9.62^^
"BLD",1446,"REQB",0)
^9.611^^0
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
602^3121023
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3121023
"PKG",3,22,1,"PAH",1,1,1,0)
The description of this build can be found in the National Patch Module 
"PKG",3,22,1,"PAH",1,1,2,0)
under patch XU*8*602.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","XQALBUTL")
0^9^B78074082^B72107811
"RTN","XQALBUTL",1,0)
XQALBUTL ; ISC-SF/JLI - Utilities for OE/RR notifications ;07/13/12  13:24
"RTN","XQALBUTL",2,0)
 ;;8.0;KERNEL;**114,125,171,285,602**;Jul 10, 1995;Build 9
"RTN","XQALBUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALBUTL",4,0)
 ; PROVIDES FUNCTIONALITY USED BY ORBUTL
"RTN","XQALBUTL",5,0)
EN ;
"RTN","XQALBUTL",6,0)
 Q
"RTN","XQALBUTL",7,0)
RECIPURG(XQX) ; SR. ICR #3010 (supported)
"RTN","XQALBUTL",8,0)
 ; Called by option ORB PURG RECIP - purge existing notifs: recipient/DUZ
"RTN","XQALBUTL",9,0)
 N XQK,XQA,XQADAT S XQADAT=$$NOW^XLFDT()
"RTN","XQALBUTL",10,0)
 F XQK=0:0 S XQK=$O(^XTV(8992,XQX,"XQA",XQK)) Q:XQK'>0  S XQA=$P(^(XQK,0),"^",2) D OLDPURG
"RTN","XQALBUTL",11,0)
 Q
"RTN","XQALBUTL",12,0)
 ;
"RTN","XQALBUTL",13,0)
PTPURG(DFN) ; SR. ICR #3010 (supported)
"RTN","XQALBUTL",14,0)
 ; Called by option ORB PURG PATIENT - purge existing notifs: patient
"RTN","XQALBUTL",15,0)
 N XQX,XQK,XQA,XQADAT S XQADAT=$$NOW^XLFDT()
"RTN","XQALBUTL",16,0)
 F XQX=0:0 S XQX=$O(^XTV(8992,XQX)) Q:XQX'>0  F XQK=0:0 S XQK=$O(^XTV(8992,XQX,"XQA",XQK)) Q:XQK'>0  S XQA=$P(^(XQK,0),"^",2) I $P($P(XQA,";"),",",2)=DFN D OLDPURG
"RTN","XQALBUTL",17,0)
 Q
"RTN","XQALBUTL",18,0)
 ;
"RTN","XQALBUTL",19,0)
NOTIPURG(Y) ; SR. ICR #3010 (supported)
"RTN","XQALBUTL",20,0)
 ; Called by option ORB PURG NOTIF - purge existing notifs: notification
"RTN","XQALBUTL",21,0)
 N XQX,XQK,XQA,XQADAT S XQADAT=$$NOW^XLFDT()
"RTN","XQALBUTL",22,0)
 F XQX=0:0 S XQX=$O(^XTV(8992,XQX)) Q:XQX'>0  F XQK=0:0 S XQK=$O(^XTV(8992,XQX,"XQA",XQK)) Q:XQK'>0  S XQA=$P(^(XQK,0),"^",2) I $P($P(XQA,";"),",",3)=+Y D OLDPURG
"RTN","XQALBUTL",23,0)
 Q
"RTN","XQALBUTL",24,0)
 ;
"RTN","XQALBUTL",25,0)
OLDPURG ;called by RECIPURG, PTPURG, NOTIPURG - KILLs specified alert entries
"RTN","XQALBUTL",26,0)
 N XQAID S XQAID=XQA D DELA^XQALDEL ; JLI 9-3-99 FIXES NULL SUBSCRIPT IN DELA+1^XQALDEL
"RTN","XQALBUTL",27,0)
 Q
"RTN","XQALBUTL",28,0)
 ;
"RTN","XQALBUTL",29,0)
AHISTORY(XQAID,ROOT) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",30,0)
 ; Returns information from alert tracking file for alert with XQAID as its alert ID.  The data is returned desendent from the closed root passed in ROOT.
"RTN","XQALBUTL",31,0)
 N X
"RTN","XQALBUTL",32,0)
 K @ROOT
"RTN","XQALBUTL",33,0)
 S X=$O(^XTV(8992.1,"B",XQAID,0)) I X'>0 Q
"RTN","XQALBUTL",34,0)
 M @ROOT=^XTV(8992.1,X)
"RTN","XQALBUTL",35,0)
 Q
"RTN","XQALBUTL",36,0)
 ;
"RTN","XQALBUTL",37,0)
PENDING(XQAUSER,XQAID) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",38,0)
 ; Returns whether the user specified has the alert indicated by XQAID pending.  (1=YES, 0=NO)
"RTN","XQALBUTL",39,0)
 Q $D(^XTV(8992,"AXQA",XQAID,XQAUSER))/10
"RTN","XQALBUTL",40,0)
 ;
"RTN","XQALBUTL",41,0)
PKGPEND(XQAUSER,XQAPKG) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",42,0)
 ; Returns 1 if the user indicated by XQAUSER has any pending alerts with the first ';'-piece of XQAID contains the package identifier indicated by XQAPKG.
"RTN","XQALBUTL",43,0)
 N I,X
"RTN","XQALBUTL",44,0)
 F I=0:0 S X="",I=$O(^XTV(8992,XQAUSER,"XQA",I)) Q:I'>0  S X=$P($P(^(I,0),U,2),";") I X[XQAPKG Q
"RTN","XQALBUTL",45,0)
 Q $S(X'="":1,1:0)
"RTN","XQALBUTL",46,0)
 ;
"RTN","XQALBUTL",47,0)
ALERTDAT(XQAID,ROOT) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",48,0)
 ; Returns information from alert tracking file for alert with XQAID in array XQALERTD.  If the alert is not present, the array is undefined.
"RTN","XQALBUTL",49,0)
 N IEN
"RTN","XQALBUTL",50,0)
 I $G(ROOT)="" S ROOT="XQALERTD"
"RTN","XQALBUTL",51,0)
 K @ROOT
"RTN","XQALBUTL",52,0)
 S IEN=$O(^XTV(8992.1,"B",XQAID,0)) I IEN'>0 S @ROOT="" Q
"RTN","XQALBUTL",53,0)
 D MAKELIST(ROOT,8992.1,(IEN_","))
"RTN","XQALBUTL",54,0)
 Q
"RTN","XQALBUTL",55,0)
 ;
"RTN","XQALBUTL",56,0)
USERLIST(XQAID,ROOT) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",57,0)
 ; Returns recipients of alert with ID of XQAID from alert tracking file in array XQALUSER
"RTN","XQALBUTL",58,0)
 N IEN,N,I,X
"RTN","XQALBUTL",59,0)
 I $G(ROOT)="" S ROOT="XQALUSRS"
"RTN","XQALBUTL",60,0)
 K @ROOT
"RTN","XQALBUTL",61,0)
 S IEN=$O(^XTV(8992.1,"B",XQAID,0)) I IEN'>0 S @ROOT="" Q
"RTN","XQALBUTL",62,0)
 S N=0 F I=0:0 S I=$O(^XTV(8992.1,IEN,20,I)) Q:I'>0  S N=N+1,X=+^(I,0),X=X_U_$$GET1^DIQ(8992.11,(I_","_IEN_","),.01),@ROOT@(N)=X
"RTN","XQALBUTL",63,0)
 Q
"RTN","XQALBUTL",64,0)
 ;
"RTN","XQALBUTL",65,0)
USERDATA(XQAID,XQAUSER,ROOT) ; SR. ICR #2778 (supported)
"RTN","XQALBUTL",66,0)
 ; Returns information from alert tracking file related to alert with ID of XQAID for user specified by XQAUSER
"RTN","XQALBUTL",67,0)
 N IEN,IEN2
"RTN","XQALBUTL",68,0)
 I $G(ROOT)="" S ROOT="XQALUSER"
"RTN","XQALBUTL",69,0)
 K @ROOT
"RTN","XQALBUTL",70,0)
 S IEN=$O(^XTV(8992.1,"B",XQAID,0)) I IEN'>0 S @ROOT="" Q
"RTN","XQALBUTL",71,0)
 S IEN2=$O(^XTV(8992.1,IEN,20,"B",XQAUSER,0)) I IEN2'>0 S @ROOT="" Q
"RTN","XQALBUTL",72,0)
 D MAKELIST(ROOT,8992.11,(IEN2_","_IEN_","))
"RTN","XQALBUTL",73,0)
 Q
"RTN","XQALBUTL",74,0)
 ;
"RTN","XQALBUTL",75,0)
MAKELIST(ARRAY,FILE,IENS) ; Makes a list of fields as subscripts in ARRAY with the values of the fields as the value.  If internal and external differ, the value is given as internal^external.
"RTN","XQALBUTL",76,0)
 N ROOT,FIELD,X
"RTN","XQALBUTL",77,0)
 K @ARRAY
"RTN","XQALBUTL",78,0)
 S ROOT=$NA(^TMP("XQALMAKELIST",$J))
"RTN","XQALBUTL",79,0)
 K @ROOT
"RTN","XQALBUTL",80,0)
 D GETS^DIQ(FILE,IENS,"*","IE",ROOT)
"RTN","XQALBUTL",81,0)
 F FIELD=0:0 S FIELD=$O(@ROOT@(FILE,IENS,FIELD)) Q:FIELD'>0  S X=^(FIELD,"I") S:X'=^("E") X=X_U_^("E") S @ARRAY@(FIELD)=X,@ARRAY@(FIELD,$$GET1^DID(FILE,FIELD,"","LABEL"))=""
"RTN","XQALBUTL",82,0)
 K @ROOT
"RTN","XQALBUTL",83,0)
 Q
"RTN","XQALBUTL",84,0)
 ;
"RTN","XQALBUTL",85,0)
 ;;  DELSTAT - For the most recent alert with XQAIDVAL as the PackageID
"RTN","XQALBUTL",86,0)
 ;;  passed in, on return array VALUES contains the DUZ for users in
"RTN","XQALBUTL",87,0)
 ;;  VALUES along with an indicator of whether the alert has been
"RTN","XQALBUTL",88,0)
 ;;  deleted or not, e.g., DUZ^0 if not deleted or DUZ^1 if deleted.
"RTN","XQALBUTL",89,0)
 ;;  Note that contents of VALUES will be killed prior to building the
"RTN","XQALBUTL",90,0)
 ;;  list.
"RTN","XQALBUTL",91,0)
 ;;
"RTN","XQALBUTL",92,0)
 ;;  Example:   D DELSTAT^XQALBUTL("OR;14765;23",.RESULTS)
"RTN","XQALBUTL",93,0)
 ;;
"RTN","XQALBUTL",94,0)
 ;;  Returned:   The value of RESULTS indicates the number of entries in
"RTN","XQALBUTL",95,0)
 ;;              the array.  The entries are then ordered in numerical
"RTN","XQALBUTL",96,0)
 ;;              order in the RESULTS array.
"RTN","XQALBUTL",97,0)
 ;;                  RESULTS = 3
"RTN","XQALBUTL",98,0)
 ;;                  RESULTS(1) = "146^0"   User 146 - not deleted
"RTN","XQALBUTL",99,0)
 ;;                  RESULTS(2) = "297^1"   User 297 - deleted
"RTN","XQALBUTL",100,0)
 ;;                  RESULTS(3) = "673^0"   User 673 - not deleted
"RTN","XQALBUTL",101,0)
 ;;
"RTN","XQALBUTL",102,0)
DELSTAT(XQAIDVAL,VALUES) ; .SR ICR #3197 (supported)
"RTN","XQALBUTL",103,0)
 N XQAX,XQADATE,XQAID,XQAFN,I,X,X1,X
"RTN","XQALBUTL",104,0)
 S XQAX=XQAIDVAL,XQADATE=0,XQAID="" K VALUES S VALUES=0
"RTN","XQALBUTL",105,0)
 F  S XQAX=$O(^XTV(8992.1,"B",XQAX)) Q:XQAX'[XQAIDVAL  I XQADATE<$P(XQAX,";",3) S XQADATE=$P(XQAX,";",3),XQAID=XQAX
"RTN","XQALBUTL",106,0)
 Q:XQAID=""  S XQAFN=$O(^XTV(8992.1,"B",XQAID,0)) Q:XQAFN'>0
"RTN","XQALBUTL",107,0)
 F I=0:0 S I=$O(^XTV(8992.1,XQAFN,20,I)) Q:I'>0  S X=^(I,0),X1=+X,X2=($P(X,U,5)>0!($P(X,U,6)>0)),VALUES=VALUES+1,VALUES(VALUES)=X1_U_X2
"RTN","XQALBUTL",108,0)
 Q
"RTN","XQALBUTL",109,0)
 ;
"RTN","XQALBUTL",110,0)
BKUPREVW ;OPT - SET BACKUP REVIEWER(S) IN PARAMETER FILE - Moved from XQALDEL
"RTN","XQALBUTL",111,0)
 N DIR,DIRUT,XQALBKUP,XQALCASE,XQPARAM,ERR
"RTN","XQALBUTL",112,0)
 S XQPARAM="XQAL BACKUP REVIEWER"
"RTN","XQALBUTL",113,0)
BK1 ; Select NEW PERSON entry as backup reviewer
"RTN","XQALBUTL",114,0)
 F  S XQALBKUP=$$NEWPERSN() Q:$D(DIRUT)  Q:XQALBKUP'>0  D  Q:$D(DIRUT)
"RTN","XQALBUTL",115,0)
 . D LISTCURR(XQALBKUP)
"RTN","XQALBUTL",116,0)
BK2 . ; Select Entity type for backup reviewer - XQALLAST indicates maximum number of choices, last is SYSTEM.
"RTN","XQALBUTL",117,0)
 . N XQALVALS,XQALLAST
"RTN","XQALBUTL",118,0)
 . S XQALLAST=4,XQALVALS(1)="User^200^USER^USR",XQALVALS(2)="Service^49^SERVICE^SRV",XQALVALS(3)="Division^4^DIVISION^DIV",XQALVALS(4)="System^"
"RTN","XQALBUTL",119,0)
 . F  S XQALCASE=$$ENTTYPE(.XQALVALS,XQALLAST) Q:$D(DIRUT)  Q:XQALCASE'>0  D  K:X="" DIRUT Q:$D(DIRUT)
"RTN","XQALBUTL",120,0)
 . . ; Select individual in Entity for backup reviewer
"RTN","XQALBUTL",121,0)
 . . I XQALCASE<XQALLAST D
"RTN","XQALBUTL",122,0)
 . . . S DIR(0)="PO^"_$P(XQALVALS(XQALCASE),U,2)_":AEQM",DIR("A")="Select "_$P(XQALVALS(XQALCASE),U,3)_" to set "_$P(XQALBKUP,U,2)_" as BACKUP REVIEWER for"
"RTN","XQALBUTL",123,0)
 . . . F  D ^DIR Q:Y'>0  S XQAENT=+Y D CHKCURR($P(XQALVALS(XQALCASE),U,4)_".`"_XQAENT,+XQALBKUP)
"RTN","XQALBUTL",124,0)
 . . . K DIR
"RTN","XQALBUTL",125,0)
 . . . Q
"RTN","XQALBUTL",126,0)
 . . ; Special handling for SYSTEM entity
"RTN","XQALBUTL",127,0)
 . . I XQALCASE=XQALLAST S Y=$$GET1^DIQ(8989.3,"1,",.01,"I") D CHKCURR("SYS.`"_Y,+XQALBKUP)
"RTN","XQALBUTL",128,0)
 . . Q
"RTN","XQALBUTL",129,0)
 . Q
"RTN","XQALBUTL",130,0)
 Q
"RTN","XQALBUTL",131,0)
 ;
"RTN","XQALBUTL",132,0)
NEWPERSN() ;
"RTN","XQALBUTL",133,0)
 ;   Select a Backup Reviewer, then select parameter cases for this Backup
"RTN","XQALBUTL",134,0)
 ;   Reviewer.  You may then select another Backup Reviewer for additional
"RTN","XQALBUTL",135,0)
 ;   parameter cases if necessary.
"RTN","XQALBUTL",136,0)
 ;
"RTN","XQALBUTL",137,0)
 ;   Select NEW PERSON entry to be BACKUP REVIEWER
"RTN","XQALBUTL",138,0)
NEWLOOP ;
"RTN","XQALBUTL",139,0)
 W ! S DIR(0)="PO^200:AEQM",DIR("A")="Select NEW PERSON entry to be BACKUP REVIEWER",DIR("A",1)="Select a Backup Reviewer, then select parameter cases for this Backup"
"RTN","XQALBUTL",140,0)
 S DIR("A",2)="Reviewer.  You may then select another Backup Reviewer for additional",DIR("A",3)="parameter cases if necessary.",DIR("A",4)=""
"RTN","XQALBUTL",141,0)
 D ^DIR K DIR I X="" K DIRUT
"RTN","XQALBUTL",142,0)
 I Y>0,'$$ACTIVE^XUSER(+Y) W !,$C(7),"This is not an ACTIVE USER...  Select an Active user",! G NEWLOOP
"RTN","XQALBUTL",143,0)
 Q Y
"RTN","XQALBUTL",144,0)
 ;
"RTN","XQALBUTL",145,0)
ENTTYPE(XQALVALS,XQALLAST) ;
"RTN","XQALBUTL",146,0)
 K DIR("A")
"RTN","XQALBUTL",147,0)
 S XQALCASE="" F I=1:1:XQALLAST S XQALCASE=XQALCASE_I_":"_$P(XQALVALS(I),U)_";"
"RTN","XQALBUTL",148,0)
 S DIR(0)="SO^"_XQALCASE D ^DIR K DIR I X="" K DIRUT
"RTN","XQALBUTL",149,0)
 Q Y
"RTN","XQALBUTL",150,0)
 ;
"RTN","XQALBUTL",151,0)
CHKCURR(ENTITY,XQALBKUP) ;
"RTN","XQALBUTL",152,0)
 S XQAINST=$$GETINST(ENTITY,XQALBKUP)
"RTN","XQALBUTL",153,0)
 I XQAINST>0 D PUT^XPAR(ENTITY,XQPARAM,XQAINST,XQALBKUP,.ERR) W "   ...Done"
"RTN","XQALBUTL",154,0)
 I XQAINST<0 D PUT^XPAR(ENTITY,XQPARAM,-XQAINST,"@",.ERR) W "    ...Done"
"RTN","XQALBUTL",155,0)
 Q
"RTN","XQALBUTL",156,0)
 ;
"RTN","XQALBUTL",157,0)
GETINST(ENTITY,XQALBKUP) ;
"RTN","XQALBUTL",158,0)
 N DIR,DIRUT,I,J,IMAX,XQAA,XQATYP,XQAI,Y,ISELF,IEN,XQAVAL
"RTN","XQALBUTL",159,0)
 D GETLST^XPAR(.XQAA,ENTITY,XQPARAM,"Q",.XQERR) I XQAA=0 Q 1
"RTN","XQALBUTL",160,0)
LOOP ;
"RTN","XQALBUTL",161,0)
 W !,"There "_$S(XQAA=1:"is",1:"are")_" currently "_XQAA_" instance"_$S(XQAA>1:"s",1:"")_" for this entity"
"RTN","XQALBUTL",162,0)
 S ISELF=0
"RTN","XQALBUTL",163,0)
 F I=0:0 S I=$O(XQAA(I)) Q:I'>0  S IEN=+$P(XQAA(I),U,2) W !,?5,+XQAA(I),?10,$$GET1^DIQ(200,IEN_",",.01) S IMAX=+XQAA(I) I IEN=XQALBKUP S ISELF=+XQAA(I)
"RTN","XQALBUTL",164,0)
 S DIR(0)="S^"_$S(ISELF=0:";a:Add an instance;r:Replace an instance;",1:"")_"d:Delete an instance;q:Quit",DIR("A")="Select Action" D ^DIR K DIR I $D(DIRUT)!(Y="q") K DIRUT Q 0
"RTN","XQALBUTL",165,0)
 S XQATYP=Y I XQATYP="a" S J=0 D  Q J
"RTN","XQALBUTL",166,0)
 . F XQAI=1:1 I +$G(XQAA(XQAI))'=XQAI S J=XQAI I J>0 Q
"RTN","XQALBUTL",167,0)
 E  D  Q:Y=0 0
"RTN","XQALBUTL",168,0)
 . S Y=IMAX I XQAA>1 S DIR(0)="N^1:"_IMAX,DIR("A")="Select Instance number to "_$S(XQATYP="r":"REPLACE",1:"DELETE") D ^DIR K DIR I $D(DIRUT) K DIRUT S Y=0 Q
"RTN","XQALBUTL",169,0)
 . F XQAI=1:1 Q:'$D(XQAA(XQAI))  I +XQAA(XQAI)=Y Q
"RTN","XQALBUTL",170,0)
 . I '$D(XQAA(XQAI)) S Y=-1
"RTN","XQALBUTL",171,0)
 I Y<0 W $C(7),!!,"To "_$S(XQATYP="r":"REPLACE",1:"DELETE")_" an entry enter an instance number from the list." G LOOP
"RTN","XQALBUTL",172,0)
 S XQAVAL=+Y I XQATYP="d" S XQAVAL=-Y
"RTN","XQALBUTL",173,0)
 Q XQAVAL
"RTN","XQALBUTL",174,0)
 ;
"RTN","XQALBUTL",175,0)
LISTCURR(XQALBKUP) ;
"RTN","XQALBUTL",176,0)
 N XLIST,NVALS,ENT,XQIEN,X,ENTIEN,ENTFIL,FILNAM,FILNUM
"RTN","XQALBUTL",177,0)
 S NVALS=$$LISTGET(+XQALBKUP,.XLIST) I NVALS>0 D
"RTN","XQALBUTL",178,0)
 . W !,"Currently Backup Reviewer for:"
"RTN","XQALBUTL",179,0)
 . S ENT="" F  S ENT=$O(XLIST(ENT)) Q:ENT=""  F XQIEN=0:0 S XQIEN=$O(XLIST(ENT,XQIEN)) Q:XQIEN'>0  D
"RTN","XQALBUTL",180,0)
 . . S X=$$GET1^DIQ(8989.5,XQIEN_",",.01,"I"),ENTIEN=$P(X,";"),ENTFIL=$P(X,";",2),FILNAM=$P(@(U_ENTFIL_"0)"),U),FILNUM=+$P(@(U_ENTFIL_"0)"),U,2) I FILNUM>0 D
"RTN","XQALBUTL",181,0)
 . . . W !?10,$S(FILNUM=4:"Division",FILNUM=4.2:"System",FILNUM=49:"Service",FILNUM=200:"User",1:"UNKNOWN???")_":",?25,$$GET1^DIQ(FILNUM,ENTIEN_",",.01)
"RTN","XQALBUTL",182,0)
 . . . Q
"RTN","XQALBUTL",183,0)
 . . Q
"RTN","XQALBUTL",184,0)
 . Q
"RTN","XQALBUTL",185,0)
 Q
"RTN","XQALBUTL",186,0)
 ;
"RTN","XQALBUTL",187,0)
LISTGET(XQALBKUP,XLIST) ;
"RTN","XQALBUTL",188,0)
 N PARAMIEN,ENT,INST,X,IEN,ENT1,CNT
"RTN","XQALBUTL",189,0)
 S PARAMIEN=$$FIND1^DIC(8989.51,"","","XQAL BACKUP REVIEWER"),CNT=0
"RTN","XQALBUTL",190,0)
 S ENT="" F  S ENT=$O(^XTV(8989.5,"AC",PARAMIEN,ENT)) Q:ENT=""   F INST=0:0 S INST=$O(^XTV(8989.5,"AC",PARAMIEN,ENT,INST)) Q:INST'>0  S IEN=^(INST),X=$O(^(INST,"")) I IEN=XQALBKUP S ENT1=$P(ENT,";",2),XLIST(ENT1,X)="",CNT=CNT+1
"RTN","XQALBUTL",191,0)
 Q CNT
"RTN","XQALDATA")
0^6^B11271249^B11750303
"RTN","XQALDATA",1,0)
XQALDATA ;ISC/JLI ISD/HGW - PROVIDE DATA ON ALERTS ;07/05/12  13:08
"RTN","XQALDATA",2,0)
 ;;8.0;KERNEL;**207,285,443,513,602**;Jul 10, 1995;Build 9
"RTN","XQALDATA",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALDATA",4,0)
 Q
"RTN","XQALDATA",5,0)
GETUSER(ROOT,XQAUSER,FRSTDATE,LASTDATE) ; SR. ICR #4834 (private OE/RR)
"RTN","XQALDATA",6,0)
 N XREF,XVAL,X,X2,X3,I,NCNT ; P443
"RTN","XQALDATA",7,0)
 S:$G(XQAUSER)'>0 XQAUSER=DUZ
"RTN","XQALDATA",8,0)
 S:$G(FRSTDATE)'>0 FRSTDATE=0
"RTN","XQALDATA",9,0)
 S:$G(LASTDATE)'>0 LASTDATE=0
"RTN","XQALDATA",10,0)
 S NCNT=0 K @ROOT
"RTN","XQALDATA",11,0)
 I FRSTDATE=0 D  Q
"RTN","XQALDATA",12,0)
 . F I=0:0 S I=$O(^XTV(8992,XQAUSER,"XQA",I)) Q:I'>0  S X=^(I,0),X3=$G(^(3)),X2=$G(^(2)) D
"RTN","XQALDATA",13,0)
 . . S NCNT=NCNT+1
"RTN","XQALDATA",14,0)
 . . S @ROOT@(NCNT)=$S($P(X3,U)'="":"G  ",$P(X,U,7,8)="^ ":"I  ",1:"   ")_$P(X,U,3)_U_$P(X,U,2)_$S($P(X2,U,3)'="":U_$P(X2,U,3),1:"") ; P443
"RTN","XQALDATA",15,0)
 . S @ROOT=NCNT
"RTN","XQALDATA",16,0)
 S XREF="R"
"RTN","XQALDATA",17,0)
 S XVAL=XQAUSER
"RTN","XQALDATA",18,0)
 D CHKTRAIL
"RTN","XQALDATA",19,0)
 Q
"RTN","XQALDATA",20,0)
GETPAT(ROOT,PATIENT,FRSTDATE,LASTDATE) ;
"RTN","XQALDATA",21,0)
 N XREF,XVAL,NCNT
"RTN","XQALDATA",22,0)
 S NCNT=0 K @ROOT
"RTN","XQALDATA",23,0)
 I $G(PATIENT)'>0 S @ROOT=0 Q
"RTN","XQALDATA",24,0)
 S XREF="C"
"RTN","XQALDATA",25,0)
 S XVAL=PATIENT
"RTN","XQALDATA",26,0)
 D CHKTRAIL
"RTN","XQALDATA",27,0)
 Q
"RTN","XQALDATA",28,0)
CHKTRAIL ;
"RTN","XQALDATA",29,0)
 ; ZEXCEPT: FRSTDATE,LASTDATE,NCNT,ROOT,XREF,XVAL  -- from GETPAT or GETUSER
"RTN","XQALDATA",30,0)
 N XQ1,X,X1,X2,X3
"RTN","XQALDATA",31,0)
 F XQ1=0:0 S XQ1=$O(^XTV(8992.1,XREF,XVAL,XQ1)) Q:XQ1'>0  D
"RTN","XQALDATA",32,0)
 . S X=$G(^XTV(8992.1,XQ1,0)),X1=$G(^(1)),X3=$G(^(3)),X2=$G(^(2)) Q:X=""
"RTN","XQALDATA",33,0)
 . I FRSTDATE'>0,'$D(^XTV(8992,"AXQA",$P(X,U))) Q
"RTN","XQALDATA",34,0)
 . I FRSTDATE>0,$P(X,U,2)<FRSTDATE Q
"RTN","XQALDATA",35,0)
 . I FRSTDATE>0,LASTDATE>0,$P(X,U,2)>LASTDATE Q
"RTN","XQALDATA",36,0)
 . S NCNT=NCNT+1
"RTN","XQALDATA",37,0)
 . S @ROOT@(NCNT)=$S($P(X3,U)'="":"G  ",$P(X1,U,2,3)="^":"I  ",$P(X1,U,2,3)="":"I  ",1:"   ")_$P(X1,U)_U_$P(X,U)_$S($P(X2,U,3)'="":U_$P(X2,U,3),1:"") ; P443
"RTN","XQALDATA",38,0)
 S @ROOT=NCNT
"RTN","XQALDATA",39,0)
 Q
"RTN","XQALDATA",40,0)
GETUSER1(ROOT,XQAUSER,FRSTDATE,LASTDATE) ;
"RTN","XQALDATA",41,0)
 N NCNT,KEY
"RTN","XQALDATA",42,0)
 S:$G(XQAUSER)'>0 XQAUSER=DUZ
"RTN","XQALDATA",43,0)
 S:$G(FRSTDATE)'>0 FRSTDATE=0
"RTN","XQALDATA",44,0)
 S:$G(LASTDATE)'>0 LASTDATE=0
"RTN","XQALDATA",45,0)
 I $$ACTVSURO^XQALSURO(XQAUSER)'>0 D RETURN^XQALSUR1(XQAUSER) ; P513
"RTN","XQALDATA",46,0)
 S NCNT=0 K @ROOT
"RTN","XQALDATA",47,0)
 I FRSTDATE=0 D  Q
"RTN","XQALDATA",48,0)
 . N X,X2,X3,X4,I S I="" F  S I=$O(^XTV(8992,XQAUSER,"XQA",I),-1) Q:I'>0  S X=^(I,0),X2=$G(^(2)),X3=$G(^(3)),X4=$D(^(4)) D
"RTN","XQALDATA",49,0)
 . . I $P(X,U,4)'="" D
"RTN","XQALDATA",50,0)
 . . . N XQAID,XQXX,XQXY,XQADAT ; P513, update ALERT TRACKING FILE
"RTN","XQALDATA",51,0)
 . . . S $P(^XTV(8992,XQAUSER,"XQA",I,0),U,4)="" ; P513 - MARK SEEN
"RTN","XQALDATA",52,0)
 . . . S XQAID=$P(X,U,2) ; P513
"RTN","XQALDATA",53,0)
 . . . S XQXX=$O(^XTV(8992.1,"B",XQAID,0)),XQXY=0,XQADAT=$$NOW^XLFDT() ; P513
"RTN","XQALDATA",54,0)
 . . . I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",XQAUSER,0)) I XQXY>0 D
"RTN","XQALDATA",55,0)
 . . . . I $P(^XTV(8992.1,XQXX,20,XQXY,0),U,2)="" S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,2)=XQADAT
"RTN","XQALDATA",56,0)
 . . . . I $P(^XTV(8992.1,XQXX,20,XQXY,0),U,3)="" S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,3)=XQADAT
"RTN","XQALDATA",57,0)
 . . S NCNT=NCNT+1
"RTN","XQALDATA",58,0)
 . . S KEY=$S($P(X3,U)'="":"G  ",X4>1:"L  ",$P(X,U,7,8)="^ ":"I  ",1:"R  "),@ROOT@(NCNT)=KEY_$P(X,U,3)_U_$P(X,U,2)
"RTN","XQALDATA",59,0)
 . . I X2'="" D
"RTN","XQALDATA",60,0)
 . . . S NCNT=NCNT+1,@ROOT@(NCNT)=KEY_"-----Forwarded by: "_$$GET1^DIQ(200,($P(X2,U)_","),.01)_"   Generated: "_$$DAT8^XQALERT($P(X2,U,2),1)_U_$P(X,U,2)
"RTN","XQALDATA",61,0)
 . . . I $P(X2,U,3)'="" S NCNT=NCNT+1,@ROOT@(NCNT)=KEY_"-----"_$P(X2,U,3)_U_$P(X,U,2)
"RTN","XQALDATA",62,0)
 . . . Q
"RTN","XQALDATA",63,0)
 . S @ROOT=NCNT
"RTN","XQALDATA",64,0)
 . Q
"RTN","XQALDATA",65,0)
 Q
"RTN","XQALDEL")
0^12^B56273165^B55829845
"RTN","XQALDEL",1,0)
XQALDEL ;ISC-SF.SEA/JLI - DELETE ALERTS ;07/16/12  11:40
"RTN","XQALDEL",2,0)
 ;;8.0;KERNEL;**6,24,65,114,174,285,443,602**;Jul 10, 1995;Build 9
"RTN","XQALDEL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALDEL",4,0)
 ;;
"RTN","XQALDEL",5,0)
 Q
"RTN","XQALDEL",6,0)
 ;
"RTN","XQALDEL",7,0)
DELETE ;
"RTN","XQALDEL",8,0)
 N XQAFOUND,XQADAT,XQX,XQK,XQXX,XQXY,XQJ,XQAID1
"RTN","XQALDEL",9,0)
 Q:'$D(XQAID)  Q:XQAID=""  S:'$D(XQAKILL) XQAKILL=0 S:$P(XQAID,";")="NO-ID" XQAKILL=1
"RTN","XQALDEL",10,0)
 S XQADAT=$$NOW^XLFDT()
"RTN","XQALDEL",11,0)
 I '$D(XQAUSER) N XQAUSER S XQAUSER=DUZ
"RTN","XQALDEL",12,0)
 S XQAFOUND=0 D
"RTN","XQALDEL",13,0)
 . S XQX=XQAUSER F XQK=0:0 S XQK=$O(^XTV(8992,XQAUSER,"XQA",XQK)) Q:XQK'>0  I $P(^(XQK,0),U,2)=XQAID S XQAFOUND=1 Q
"RTN","XQALDEL",14,0)
 S XQXX=$O(^XTV(8992.1,"B",XQAID,0)) I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",XQAUSER,0)) I XQXY>0,XQAFOUND,'$G(XQAUSERD) S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,4)=XQADAT
"RTN","XQALDEL",15,0)
 K XQXX,XQXY
"RTN","XQALDEL",16,0)
 I '$D(^XTV(8992,"AXQA",XQAID,XQAUSER)) D KILLOC
"RTN","XQALDEL",17,0)
 F XQX=0:0 S XQX=$O(^XTV(8992,"AXQA",XQAID,XQX)) Q:XQX'>0  D  Q:XQAKILL
"RTN","XQALDEL",18,0)
 . I XQAKILL S XQX=XQAUSER ; Make sure XQAKILL gets only XQAUSER
"RTN","XQALDEL",19,0)
 . F XQK=0:0 S XQK=$O(^XTV(8992,"AXQA",XQAID,XQX,XQK)) Q:XQK'>0  K ^(XQK),^XTV(8992,"AXQAN",$P(XQAID,";"),XQX,XQK) S XQAID1=XQAID D:$D(^XTV(8992,XQX,"XQA",XQK,0)) DELA S XQAID=XQAID1
"RTN","XQALDEL",20,0)
 K XQAID,XQX,XQJ,XQK,XQAID1,XQAKILL
"RTN","XQALDEL",21,0)
 Q
"RTN","XQALDEL",22,0)
 ;
"RTN","XQALDEL",23,0)
DELETEA ;
"RTN","XQALDEL",24,0)
 N XQA1,XQADAT,XQAFOUND,XQX,XQXX,XQXY,XQK,XQJ
"RTN","XQALDEL",25,0)
 Q:'$D(XQAID)  Q:XQAID=""  S XQA1=$P(XQAID,";")
"RTN","XQALDEL",26,0)
 S XQADAT=$$NOW^XLFDT()
"RTN","XQALDEL",27,0)
 I '$D(XQAUSER) N XQAUSER S XQAUSER=DUZ
"RTN","XQALDEL",28,0)
 S:'$D(XQAKILL) XQAKILL=0 G:$P(XQAID,";")="NO-ID" DELETE
"RTN","XQALDEL",29,0)
 S XQAFOUND=0 D
"RTN","XQALDEL",30,0)
 . S XQX=XQAUSER F XQK=0:0 S XQK=$O(^XTV(8992,XQAUSER,"XQA",XQK)) Q:XQK'>0  I $P($G(^(XQK,0)),U,2)=XQAID S XQAFOUND=1 Q
"RTN","XQALDEL",31,0)
 S XQXX=$O(^XTV(8992.1,"B",XQAID,0)) I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",XQAUSER,0)) I XQXY>0,XQAFOUND,'$G(XQAUSERD) S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,4)=XQADAT
"RTN","XQALDEL",32,0)
 I '$D(^XTV(8992,"AXQAN",XQA1,XQAUSER)) D KILLOC
"RTN","XQALDEL",33,0)
 I $P(XQAID,",",2)'=""!($P(XQAID,";",2)="") F XQX=0:0 S XQX=$O(^XTV(8992,"AXQAN",XQA1,XQX)) Q:XQX'>0  D  Q:XQAKILL
"RTN","XQALDEL",34,0)
 . I XQAKILL S XQX=XQAUSER
"RTN","XQALDEL",35,0)
 . F XQK=0:0 S XQK=$O(^XTV(8992,"AXQAN",XQA1,XQX,XQK)) Q:XQK'>0  K ^(XQK) I $D(^XTV(8992,XQX,"XQA",XQK,0)) D DELA
"RTN","XQALDEL",36,0)
 I $P(XQAID,",",2)=""&($P(XQAID,";",2)'="") F XQX=0:0 S XQX=$O(^XTV(8992,"AXQA",XQAID,XQX)) Q:XQX'>0  D  Q:XQAKILL
"RTN","XQALDEL",37,0)
 . I XQAKILL S XQX=XQAUSER
"RTN","XQALDEL",38,0)
 . S XQK=$O(^XTV(8992,"AXQA",XQAID,XQX,0)) Q:XQK'>0  K ^(XQK),^XTV(8992,"AXQAN",XQA1,XQX,XQK) I $D(^XTV(8992,XQX,"XQA",XQK,0)) D DELA
"RTN","XQALDEL",39,0)
 K XQAID,XQA1,XQX,XQK,XQAKILL
"RTN","XQALDEL",40,0)
 Q
"RTN","XQALDEL",41,0)
DELA ;
"RTN","XQALDEL",42,0)
 N XQDEL11 S XQAID=$P($G(^XTV(8992,XQX,"XQA",XQK,0)),U,2),XQDEL11=$P($G(^(0)),U) K ^XTV(8992,XQX,"XQA",XQK) K:XQAID'="" ^XTV(8992,"AXQA",XQAID,XQX,XQK)
"RTN","XQALDEL",43,0)
 D COUNT(-1,XQX)
"RTN","XQALDEL",44,0)
 K:XQAID'="" ^XTV(8992,"AXQAN",$P(XQAID,";"),XQX,XQK) K:XQDEL11'="" ^XTV(8992,XQX,"XQA","B",XQDEL11,XQK)
"RTN","XQALDEL",45,0)
 S XQXX=$S(XQAID'="":$O(^XTV(8992.1,"B",XQAID,0)),1:0) I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",XQX,0)) I XQXY>0,$P(^XTV(8992.1,XQXX,20,XQXY,0),U,5)'>0 S $P(^(0),U,5)=XQADAT I $G(XQAUSERD) S $P(^(0),U,9)=DUZ
"RTN","XQALDEL",46,0)
 K XQXX,XQXY
"RTN","XQALDEL",47,0)
 Q
"RTN","XQALDEL",48,0)
 ;
"RTN","XQALDEL",49,0)
COUNT(%1,%2) ;Change the count on the zero node, (amount, user)
"RTN","XQALDEL",50,0)
 Q:$G(%2)'>0
"RTN","XQALDEL",51,0)
 L +^XTV(8992,%2):10
"RTN","XQALDEL",52,0)
 I %1 S %=$P($G(^XTV(8992,%2,"XQA",0)),U,4)+%1 S:%'<0 $P(^(0),U,4)=%
"RTN","XQALDEL",53,0)
 I '%1 D
"RTN","XQALDEL",54,0)
 . N % S %1=0,%=0 F  S %=$O(^XTV(8992,%2,"XQA",%)) Q:%'>0  S %1=%1+1
"RTN","XQALDEL",55,0)
 . S $P(^XTV(8992,%2,"XQA",0),U,4)=%1
"RTN","XQALDEL",56,0)
 L -^XTV(8992,%2)
"RTN","XQALDEL",57,0)
 Q
"RTN","XQALDEL",58,0)
KILLOC ;
"RTN","XQALDEL",59,0)
 N XQX,XQK
"RTN","XQALDEL",60,0)
 S XQX=XQAUSER F XQK=0:0 S XQK=$O(^XTV(8992,XQAUSER,"XQA",XQK)) Q:XQK'>0  I $P(^(XQK,0),U,2)=XQAID D
"RTN","XQALDEL",61,0)
 . N XQAID D DELA
"RTN","XQALDEL",62,0)
 Q
"RTN","XQALDEL",63,0)
 ;
"RTN","XQALDEL",64,0)
OLDDEL ;
"RTN","XQALDEL",65,0)
 N XQADAT,X2,XQDAT,XQDEL1
"RTN","XQALDEL",66,0)
 S XQADAT=$$NOW^XLFDT()
"RTN","XQALDEL",67,0)
 S X2=-15 I $G(ZTQPARAM)>0 S X2=-ZTQPARAM
"RTN","XQALDEL",68,0)
 S XQDAT=$$FMADD^XLFDT(DT,X2)
"RTN","XQALDEL",69,0)
 ;Loop thru users (XQDEL1) levels
"RTN","XQALDEL",70,0)
 F XQDEL1=0:0 S XQDEL1=$O(^XTV(8992,XQDEL1)) Q:XQDEL1'>0  D OLDDEL1
"RTN","XQALDEL",71,0)
 D KILLARCH
"RTN","XQALDEL",72,0)
 K X1,X2,X,XQDEL1,XQDEL2,XQDAT,XQA,XQADAT
"RTN","XQALDEL",73,0)
 Q
"RTN","XQALDEL",74,0)
OLDDEL1 ;Loop thru the Alert (XQDEL2) level
"RTN","XQALDEL",75,0)
 L +^XTV(8992,XQDEL1):10
"RTN","XQALDEL",76,0)
 N XQAGLOB,KILLOLD,XQAZERO,XQAUSER,XQLIST,Y,XQAV,XQPRAMTY,XQDEL2,XQA
"RTN","XQALDEL",77,0)
 S XQAGLOB=$NA(^XTV(8992,XQDEL1,"XQA")),XQAUSER=XQDEL1
"RTN","XQALDEL",78,0)
 F XQDEL2=0:0 S XQDEL2=$O(@XQAGLOB@(XQDEL2)) Q:XQDEL2'>0  S XQAZERO=^(XQDEL2,0) D
"RTN","XQALDEL",79,0)
 . ; CHECK FOR BACKUP REVIEWER TO FORWARD ALERTS NEEDING ACTION -- P174
"RTN","XQALDEL",80,0)
 . I $P(XQAZERO,U,15)>0 I $$FMADD^XLFDT(+XQAZERO,+$P(XQAZERO,U,15))\1=DT D  Q:$D(KILLOLD)  ; changed '>DT to =DT so only send once without killing
"RTN","XQALDEL",81,0)
 . . N XQA D GETBKUP(.XQA,XQDEL1)
"RTN","XQALDEL",82,0)
 . . I $D(XQA) S XQALTYPE="BACKUP REVIEWER" D FORWARD^XQALFWD($P(XQAZERO,U,2),.XQA,"A","ALERT NOT PROCESSED BY "_$$GET1^DIQ(200,XQDEL1_",",.01)) S KILLOLD=1
"RTN","XQALDEL",83,0)
 . . Q  ;  End of Backup Reviewer Code -- P174
"RTN","XQALDEL",84,0)
 . I $P(XQAZERO,U,13)>0 I $$FMADD^XLFDT(+XQAZERO,+$P(XQAZERO,U,13))\1=DT D  Q:$D(KILLOLD)  ; P174
"RTN","XQALDEL",85,0)
 . . N XQA,I F I=0:0 S I=$O(^XMB(3.7,XQAUSER,9,I)) Q:I'>0  S XQAV=+^(I,0),XQA(XQAV)=XQAV
"RTN","XQALDEL",86,0)
 . . I $D(XQA) S XQALTYPE="EMAIL SURROGATE" D FORWARD^XQALFWD($P(XQAZERO,U,2),.XQA,"A","ALERT NOT PROCESSED BY "_$$GET1^DIQ(200,XQDEL1_",",.01)) S KILLOLD=1
"RTN","XQALDEL",87,0)
 . . Q
"RTN","XQALDEL",88,0)
 . I $P(XQAZERO,U,14)>0 I $$FMADD^XLFDT(+XQAZERO,+$P(XQAZERO,U,14))\1=DT D  Q:$D(KILLOLD)  ; P174
"RTN","XQALDEL",89,0)
 . . N XQA,I S I=$P($G(^VA(200,XQAUSER,5)),U) I I>0 S I=$P($G(^DIC(49,+I,0)),U,3) I I>0,$D(^VA(200,+I,0)) S XQA(+I)=+I
"RTN","XQALDEL",90,0)
 . . I $D(XQA) S XQALTYPE="CHIEF/SUPERVISOR" D FORWARD^XQALFWD($P(XQAZERO,U,2),.XQA,"A","ALERT NOT PROCESSED BY "_$$GET1^DIQ(200,XQDEL1_",",.01)) S KILLOLD=1
"RTN","XQALDEL",91,0)
 . . Q
"RTN","XQALDEL",92,0)
 . I XQDEL2'>XQDAT  D OLDDEL2
"RTN","XQALDEL",93,0)
 . Q
"RTN","XQALDEL",94,0)
 K:$O(^XTV(8992,XQDEL1,"XQA",0))="" ^XTV(8992,XQDEL1,"XQA")
"RTN","XQALDEL",95,0)
 L -^XTV(8992,XQDEL1)
"RTN","XQALDEL",96,0)
 Q
"RTN","XQALDEL",97,0)
 ;
"RTN","XQALDEL",98,0)
OLDDEL2 ;
"RTN","XQALDEL",99,0)
 N XQA,XQXX,XQXY
"RTN","XQALDEL",100,0)
 S XQA=$P(^XTV(8992,XQDEL1,"XQA",XQDEL2,0),U,2) K ^XTV(8992,XQDEL1,"XQA",XQDEL2) K:XQA'="" ^XTV(8992,"AXQA",XQA,XQDEL1),^XTV(8992,"AXQAN",$P(XQA,";"),XQDEL1)
"RTN","XQALDEL",101,0)
 D COUNT(-1,XQDEL1)
"RTN","XQALDEL",102,0)
 I XQA'="" S XQXX=$O(^XTV(8992.1,"B",XQA,0)) I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",XQDEL1,0)) I XQXY>0 S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,6)=XQADAT
"RTN","XQALDEL",103,0)
 Q
"RTN","XQALDEL",104,0)
 ;
"RTN","XQALDEL",105,0)
KILLARCH ;
"RTN","XQALDEL",106,0)
 ;  Q  ; turn off deletion from ALERT TRACKING file ; remove from XU*8*285  JLI 040624
"RTN","XQALDEL",107,0)
 N DA,DIK,XQDAT,XQDEL1,X1,X2,DA,DIK
"RTN","XQALDEL",108,0)
 S XQDAT=$$FMADD^XLFDT(DT,-30)
"RTN","XQALDEL",109,0)
 F XQDEL1=0:0 S XQDEL1=$O(^XTV(8992.1,XQDEL1)) Q:XQDEL1'>0  D
"RTN","XQALDEL",110,0)
 . S X1=$P($G(^XTV(8992.1,XQDEL1,0)),U,2),X2=$P($G(^(0)),U,8)
"RTN","XQALDEL",111,0)
 . S DA=XQDEL1 I X2="",X1>XQDAT Q
"RTN","XQALDEL",112,0)
 . I X2>0,DT<X2 Q
"RTN","XQALDEL",113,0)
 . S DIK="^XTV(8992.1," D ^DIK
"RTN","XQALDEL",114,0)
 Q
"RTN","XQALDEL",115,0)
 ;
"RTN","XQALDEL",116,0)
USERDEL ; Delete undesired alerts for a user
"RTN","XQALDEL",117,0)
 N DA,DIC,XQAUSERD
"RTN","XQALDEL",118,0)
 S DIC("A")="Select NEW PERSON entry for deletion of alerts: "
"RTN","XQALDEL",119,0)
 S DIC(0)="AEQM",DIC=200
"RTN","XQALDEL",120,0)
 D ^DIC K DIC Q:Y'>0  S XQAUSER=+Y
"RTN","XQALDEL",121,0)
 S XQALDELE=1
"RTN","XQALDEL",122,0)
 K XQX1
"RTN","XQALDEL",123,0)
 D DOIT^XQALERT1
"RTN","XQALDEL",124,0)
 K XQALDELE S XQAUSERD=1
"RTN","XQALDEL",125,0)
 I $D(XQX1),XQX1>0 D
"RTN","XQALDEL",126,0)
 . F  Q:XQX1=""  S DA=+XQX1,XQX1=$P(XQX1,",",2,99) D  I XQX1="" S Y=$O(XQX1(0)) I Y>0 S XQX1=XQX1(Y) K XQX1(Y)
"RTN","XQALDEL",127,0)
 . . S XQAID=$P(^TMP("XQ",$J,"XQA1",DA),U,2),XQAKILL=1
"RTN","XQALDEL",128,0)
 . . I XQAID="" K ^XTV(8992,XQAUSER,"XQA",+^TMP("XQ",$J,"XQA1",DA,1))
"RTN","XQALDEL",129,0)
 . . I XQAID'="" D DELETE
"RTN","XQALDEL",130,0)
 . . K ^TMP("XQ",$J,"XQA1",DA),^TMP("XQ",$J,"XQA",(999999-DA))
"RTN","XQALDEL",131,0)
 K XQAUSER,XQX1
"RTN","XQALDEL",132,0)
 Q
"RTN","XQALDEL",133,0)
 ;
"RTN","XQALDEL",134,0)
GETBKUP(XQA,XQAUSER) ;  JLI 030129 - REMOVED TO SEPARATE METHOD
"RTN","XQALDEL",135,0)
 N I,XQORY,XQENTITY,XQPARAM,XQERR,K,XQAV,XQLIST
"RTN","XQALDEL",136,0)
 S XQPARAM="XQAL BACKUP REVIEWER"
"RTN","XQALDEL",137,0)
 D GETLST^XPAR(.XQLIST,"USR.`"_XQAUSER,XQPARAM,"Q",.XQERR) S:$D(XQLIST)>1 XQPRAMTY=200 ; USER
"RTN","XQALDEL",138,0)
 I '($D(XQLIST)>1) S I=$$GET1^DIQ(200,XQAUSER_",",29,"I") I I>0 D GETLST^XPAR(.XQLIST,"SRV.`"_I,XQPARAM,"Q",.XQERR) S:$D(XQLIST)>1 XQPRAMTY=49 ; SERVICE
"RTN","XQALDEL",139,0)
 I '($D(XQLIST)>1) D GETLST^XPAR(.XQLIST,$$DIVENTIT(XQAUSER),XQPARAM,"Q",.XQERR) S:$D(XQLIST)>1 XQPRAMTY=4 ; DIVISION
"RTN","XQALDEL",140,0)
 I '($D(XQLIST)>1) D GETLST^XPAR(.XQLIST,"SYS",XQPARAM,"Q",.XQERR) S:$D(XQLIST)>1 XQPRAMTY=4.2 ; SYSTEM
"RTN","XQALDEL",141,0)
 F I=0:0 S I=$O(XQLIST(I)) Q:I'>0  S XQAV=$P(XQLIST(I),U,2),XQA(XQAV)=XQAV
"RTN","XQALDEL",142,0)
 ; Removed Teams per Curtis Anderson with CPRS
"RTN","XQALDEL",143,0)
 ;I '$D(XQA) D  ; NONE UNDER USER - CHECK FOR ENTRIES IN PARAMETER FILE FOR TEAMS
"RTN","XQALDEL",144,0)
 ;. I $T(TEAMPR^ORQPTQ1)]"" D TEAMPR^ORQPTQ1(.XQORY,XQAUSER) K:+$G(XQORY(1))<1 XQORY ; GET TEAM ID'S IF ANY ; CONTROLLED SUBSCRIPTION
"RTN","XQALDEL",145,0)
 ;. S I=0 F  S I=$O(XQORY(I)) Q:I'>0  K XQLIST D GETLST^XPAR(.XQLIST,$P(XQORY(I),U,2)_";OR(100.21,",XQPARAM,"Q",.ERR) I $D(XQTEAM) D
"RTN","XQALDEL",146,0)
 ;. . N K F K=0:0 S K=$O(XQLIST(K)) Q:K'>0  S XQAV=$P(XQLIST(K),U,2),XQA(XQAV)=XQAV
"RTN","XQALDEL",147,0)
 ;. . Q`
"RTN","XQALDEL",148,0)
 ;. Q
"RTN","XQALDEL",149,0)
 ;I '$D(XQLIST) D  ; NO TEAM ENTRIES, CHECK OTHER ENTITIES (SERVICE,DIVISION,SYSTEM)
"RTN","XQALDEL",150,0)
 ;. S XQENTITY="SYS"
"RTN","XQALDEL",151,0)
 ;. S I=$$GET1^DIQ(200,XQAUSER_",",16,"I") I I>0 S XQENTITY="DIV.`"_I_U_XQENTITY ; DIVISION
"RTN","XQALDEL",152,0)
 ;. S I=$$GET1^DIQ(200,XQAUSER_",",29,"I") I I>0 S XQENTITY="SRV.`"_I_U_XQENTITY ; SERVICE\SECTION
"RTN","XQALDEL",153,0)
 ;. D GETLST^XPAR(.XQLIST,XQENTITY,XQPARAM,"Q",.XQERR) F I=0:0 S I=$O(XQLIST(I)) Q:I'>0  S XQAV=+$P(XQLIST(I),U,2),XQA(XQAV)=XQAV
"RTN","XQALDEL",154,0)
 ;. Q
"RTN","XQALDEL",155,0)
 ;I '$D(XQA) D  ; NO PARAMETERS ENTERED - USE LAST RESORT MAIL GROUP
"RTN","XQALDEL",156,0)
 ;. S XQJ="G.XQAL UNPROCESSED ALERTS" D GROUP^XQALSET1
"RTN","XQALDEL",157,0)
 ;. I '$D(XQA) S XQJ="G.PATCH" D GROUP^XQALSET1 ; REALLY LAST RESORT
"RTN","XQALDEL",158,0)
 ;. F I=0:0 S I=$O(XQA(I)) Q:I'>0  S XQA(I)=I
"RTN","XQALDEL",159,0)
 ;. Q
"RTN","XQALDEL",160,0)
 Q
"RTN","XQALDEL",161,0)
 ;
"RTN","XQALDEL",162,0)
DIVENTIT(XQAUSER) ;
"RTN","XQALDEL",163,0)
 N ENTITY,NCNT,DIVNAM,I
"RTN","XQALDEL",164,0)
 S ENTITY="" I DUZ=XQAUSER S ENTITY="DIV.`"_DUZ(2)
"RTN","XQALDEL",165,0)
 I ENTITY="" D
"RTN","XQALDEL",166,0)
 . K NCNT,DIVNAM S NCNT=0 F I=0:0 S I=$O(^VA(200,XQAUSER,2,I)) Q:I'>0  S NCNT=NCNT+1,DIVNAM(NCNT)=+^(I,0) I $P(^(0),U,2) S DIVNAM=+^(0)
"RTN","XQALDEL",167,0)
 . I NCNT'>0 Q
"RTN","XQALDEL",168,0)
 . I NCNT=1 S ENTITY="DIV.`"_DIVNAM(1) Q
"RTN","XQALDEL",169,0)
 . I $D(DIVNAM)#2 S ENTITY="DIV.`"_DIVNAM Q
"RTN","XQALDEL",170,0)
 . F I=1:1:NCNT S ENTITY="DIV.`"_DIVNAM(I)_$S(ENTITY'="":U,1:"")_ENTITY
"RTN","XQALDEL",171,0)
 I ENTITY="" S ENTITY="DIV.`"_$$GET1^DIQ(8989.3,"1,",217,"I")
"RTN","XQALDEL",172,0)
 Q ENTITY
"RTN","XQALDEL",173,0)
 ;
"RTN","XQALDEL",174,0)
BKUPREVW ;OPT - SET BACKUP REVIEWER(S) IN PARAMETER FILE
"RTN","XQALDEL",175,0)
 G BKUPREVW^XQALBUTL
"RTN","XQALDEL",176,0)
 ;
"RTN","XQALDOIT")
0^5^B15175289^B16827192
"RTN","XQALDOIT",1,0)
XQALDOIT ;ISC-SF.SEA/JLI - ALERT HANDLER ;07/05/12  12:19
"RTN","XQALDOIT",2,0)
 ;;8.0;KERNEL;**1,6,65,114,128,129,207,602**;Jul 10, 1995;Build 9
"RTN","XQALDOIT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALDOIT",4,0)
 ;
"RTN","XQALDOIT",5,0)
EN ;
"RTN","XQALDOIT",6,0)
 S XQAEXIT="DOIT^XQALERT1"
"RTN","XQALDOIT",7,0)
 S XQX=^TMP("XQ",$J,"XQA1",+XQX1),XQI=^(+XQX1,1),XQZ=^(2)
"RTN","XQALDOIT",8,0)
EN1 ;
"RTN","XQALDOIT",9,0)
 S XQADATA=$S(XQZ'="":XQZ,1:$P(XQX,U,9,99)),XQAID=$P(XQX,U,2),XQA1=$P(XQAID,";"),XQX2=+XQX1,XQX1=$P(XQX1,",",2,200) I XQX1'>0 S XQK=$O(XQX1(0)) I XQK>0 S XQX1=XQX1(XQK) K XQX1(XQK)
"RTN","XQALDOIT",10,0)
 S XQAROU=""
"RTN","XQALDOIT",11,0)
 S XQAKILL=1 I XQX2,$P(XQX,U,8)'="" S XQAROU=$P(XQX,U,7,8) K:XQA1="" ^XTV(8992,DUZ,"XQA",XQI)
"RTN","XQALDOIT",12,0)
 I XQAID'="" D
"RTN","XQALDOIT",13,0)
 . S XQXX=$O(^XTV(8992.1,"B",XQAID,0)),XQXY=0,XQADAT=$$NOW^XLFDT()
"RTN","XQALDOIT",14,0)
 . I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",DUZ,0)) I XQXY>0,$P(^XTV(8992.1,XQXX,20,XQXY,0),U,3)="" S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,3)=XQADAT
"RTN","XQALDOIT",15,0)
 . K XQXX,XQXY
"RTN","XQALDOIT",16,0)
 I XQAROU'="",XQAROU'="^ " S XQAROUX=XQAROU D  G @XQAEXIT
"RTN","XQALDOIT",17,0)
 . N XQAROUX D @XQAROU
"RTN","XQALDOIT",18,0)
 . Q
"RTN","XQALDOIT",19,0)
 I XQAROU'="" S XQAROUX="^ " D  W !!,"Processed Alert Number ",XQX2,!?4,$P(XQX,U,3),! G @XQAEXIT
"RTN","XQALDOIT",20,0)
 . I $O(^XTV(8992,DUZ,"XQA",XQI,4,0))>0 D EN^DDIOL("",$NA(^XTV(8992,DUZ,"XQA",XQI,4)))
"RTN","XQALDOIT",21,0)
 . Q
"RTN","XQALDOIT",22,0)
 I XQX2 S XQAROUX=$P(XQX,U,7),XQMM("J")=XQAROUX_";"_$P(^DIC(19,XQY,0),U),XQRB=0 K:XQA1="" ^XTV(8992,DUZ,"XQA",XQI)
"RTN","XQALDOIT",23,0)
 K XQI,XQX,XQJ,XQK,XQXOUT,XQ1,XQII,XQA1,XQAREV,XQACNT,XQX2,%ZIS
"RTN","XQALDOIT",24,0)
 ;Need to reset count in zero node
"RTN","XQALDOIT",25,0)
 Q
"RTN","XQALDOIT",26,0)
 ;
"RTN","XQALDOIT",27,0)
ACTION(ALERTID) ;
"RTN","XQALDOIT",28,0)
 N XQAUSER
"RTN","XQALDOIT",29,0)
 S XQI=$O(^XTV(8992,"AXQA",ALERTID,DUZ,0))
"RTN","XQALDOIT",30,0)
 Q:XQI'>0
"RTN","XQALDOIT",31,0)
 S XQX=$G(^XTV(8992,DUZ,"XQA",XQI,0)) Q:XQX=""  S XQAUSER=DUZ
"RTN","XQALDOIT",32,0)
 S XQZ=$G(^XTV(8992,DUZ,"XQA",XQI,1))
"RTN","XQALDOIT",33,0)
 I $D(XQAGETAC) Q  ; just get data to return
"RTN","XQALDOIT",34,0)
 S XQAEXIT="ENDACT",XQX1=XQI
"RTN","XQALDOIT",35,0)
 I $P(XQX,U,8)'="" G EN1
"RTN","XQALDOIT",36,0)
 D EN1
"RTN","XQALDOIT",37,0)
ENDACT ;
"RTN","XQALDOIT",38,0)
 I $D(XQMM("J")) S XQMM("J")=$P(XQMM("J"),";")_";",XQALEXIT=1 D  D ^XQ74 K XQALEXIT,XQALMENU
"RTN","XQALDOIT",39,0)
 . K XQALMENU
"RTN","XQALDOIT",40,0)
 . N X S X=$P(XQMM("J"),";")
"RTN","XQALDOIT",41,0)
 . I X=+X S:$P(^DIC(19,X,0),U,4)="M" XQALMENU="" Q
"RTN","XQALDOIT",42,0)
 . S X=$O(^DIC(19,"B",X,0)) S:$P($G(^DIC(19,+X,0)),U,4)="M" XQALMENU=""
"RTN","XQALDOIT",43,0)
 I $D(XQX1),XQX1'>0 K XQX1
"RTN","XQALDOIT",44,0)
 I $D(XQAKILL) D DELETEA^XQALERT
"RTN","XQALDOIT",45,0)
 K XQAKILL,XQAROU,XQAID,XQADATA
"RTN","XQALDOIT",46,0)
 Q
"RTN","XQALDOIT",47,0)
 ;
"RTN","XQALDOIT",48,0)
DOOPT(OPTION) ;
"RTN","XQALDOIT",49,0)
 N XQX1,XQAKILL,XQAROU,XQADATA,XQAID,XQMM
"RTN","XQALDOIT",50,0)
 S XQMM("J")=OPTION
"RTN","XQALDOIT",51,0)
 D ENDACT
"RTN","XQALDOIT",52,0)
 Q
"RTN","XQALDOIT",53,0)
 ;
"RTN","XQALDOIT",54,0)
PRINT ;
"RTN","XQALDOIT",55,0)
 S XQIJ=$$NOW^XLFDT(),%ZIS="MQ" D ^%ZIS Q:POP  I $D(IO("Q")) K IO("Q") S ZTRTN="DQ^XQALDOIT",ZTIO=ION,ZTSAVE("XQIJ")="",ZTSAVE("^TMP(""XQ"",$J,""XQA2"",")="" D ^%ZTLOAD K ZTSK,ZTRTN,ZTIO,ZTSAVE Q
"RTN","XQALDOIT",56,0)
DQ ;
"RTN","XQALDOIT",57,0)
 U IO W @IOF,!!?10,"PENDING ALERTS  "_$P(^VA(200,+^XTV(8992,DUZ,0),0),U)_"   "_$E(XQIJ,4,5)_"/"_$E(XQIJ,6,7)_"/"_$E(XQIJ,2,3)_"  "_$E($P(XQIJ,".",2)_"00",1,2)_":"_$E($P(XQIJ,".",2)_"0000",3,4),!!
"RTN","XQALDOIT",58,0)
 F XQIJ=0:0 S XQIJ=$O(^TMP("XQ",$J,"XQA2",XQIJ)) Q:XQIJ'>0  W !,^(XQIJ,0)
"RTN","XQALDOIT",59,0)
 D ^%ZISC K XQIJ W:'$D(ZTQUEUED) !!
"RTN","XQALDOIT",60,0)
 Q
"RTN","XQALDOIT",61,0)
MORP K ^TMP("XQ",$J,"XQA2") S XQIK=0 F XQIJ=0:0 S XQIJ=$O(^TMP("XQ",$J,"XQA",XQIJ)) Q:XQIJ'>0  S XQIK=XQIK+1,XQIX=^(XQIJ),^TMP("XQ",$J,"XQA2",XQIK,0)=$J(XQIK,3)_". "_$P(XQIX,U,3)
"RTN","XQALDOIT",62,0)
 K XQIK,XQIX,XQIJ
"RTN","XQALDOIT",63,0)
 Q
"RTN","XQALDOIT",64,0)
MAIL ;
"RTN","XQALDOIT",65,0)
 S XMTEXT="^TMP(""XQ"",$J,""XQA2"",",XMSUB="LIST OF PENDING ALERTS",XMY(DUZ)="",XMDUZ=.5 D ^XMD K XMTEXT,XMSUB,XMDUZ,XMY W !!,"Message will be delivered as NEW mail to YOU.",!!
"RTN","XQALDOIT",66,0)
 Q
"RTN","XQALERT")
0^3^B19925402^B18400944
"RTN","XQALERT",1,0)
XQALERT ;ISC-SF.SEA/JLI - ALERT HANDLER ;07/05/12  12:05
"RTN","XQALERT",2,0)
 ;;8.0;KERNEL;**1,65,125,173,285,366,513,602**;Jul 10, 1995;Build 9
"RTN","XQALERT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALERT",4,0)
 Q
"RTN","XQALERT",5,0)
 ;
"RTN","XQALERT",6,0)
SETUP ;SR.
"RTN","XQALERT",7,0)
 D SETUP^XQALSET
"RTN","XQALERT",8,0)
 Q
"RTN","XQALERT",9,0)
 ;
"RTN","XQALERT",10,0)
SETUP1() ;SR.
"RTN","XQALERT",11,0)
 N I S I=$$SETUP1^XQALSET()
"RTN","XQALERT",12,0)
 Q I
"RTN","XQALERT",13,0)
 ;
"RTN","XQALERT",14,0)
DISPLAY ;SR. Display any new alerts
"RTN","XQALERT",15,0)
 ; ZEXCEPT: XQAUSER - global variable
"RTN","XQALERT",16,0)
 N X1,X2,XQACNT,XQJ
"RTN","XQALERT",17,0)
 I '$D(XQAUSER) S XQAUSER=DUZ I $$ACTVSURO^XQALSURO(XQAUSER)'>0 D RETURN^XQALSUR1(XQAUSER) ; P513 (ISD/HGW 20111227)
"RTN","XQALERT",18,0)
 Q:$O(^XTV(8992,DUZ,"XQA",0))'>0
"RTN","XQALERT",19,0)
 N X,XQI,XQX,XQX1,DIR,XQA,Y,XQON,XQOFF,XQ1ON,XQ1OFF,XQXDAT S XQX=0,XQX1=0,Y=1,DIR(0)="E" ; P285
"RTN","XQALERT",20,0)
 I $$ACTVSURO^XQALSURO(DUZ)'>0 D RETURN^XQALSUR1(DUZ) ; P366
"RTN","XQALERT",21,0)
 S XQACNT=0 D SORT
"RTN","XQALERT",22,0)
 F XQJ=0:0 D:XQX1&'(XQX1#20) ^DIR Q:'Y  S XQJ=$O(^TMP("XQ",$J,"XQA",XQJ)) Q:XQJ'>0  S XQI=^TMP("XQ",$J,"XQA",XQJ),XQX=XQX+1,X=$G(^XTV(8992,DUZ,"XQA",XQI,0)) I $P(X,U,4) D
"RTN","XQALERT",23,0)
 . N XQXXX,XQXX,XQXY
"RTN","XQALERT",24,0)
 . S XQXXX=X,(XQXX,XQXY)=0,XQXX=$P(X,U,2) I XQXX'="" S XQXX=$O(^XTV(8992.1,"B",$E(XQXX,1,50),0)) I XQXX>0 S XQXY=$O(^XTV(8992.1,XQXX,20,"B",DUZ,0)) I XQXY>0 S XQXDAT=$$NOW^XLFDT(),$P(^XTV(8992.1,XQXX,20,XQXY,0),U,2)=XQXDAT ; P173
"RTN","XQALERT",25,0)
 . S XQON="$C(0)",XQOFF="$C(0)"
"RTN","XQALERT",26,0)
 . I $$CHKCRIT^XQALSUR2(XQXXX) D:'$D(XQ1ON) SETREV S XQON=XQ1ON,XQOFF=XQ1OFF ; P513 modified to add use data from file 8992.3 for identifying critical alerts
"RTN","XQALERT",27,0)
 . S X=XQXXX W:XQX1=0 $C(7) W !,@XQON,$P(X,U,3),@XQOFF S XQX1=XQX1+1,$P(^XTV(8992,DUZ,"XQA",XQI,0),U,4)="" I $D(^(2)) S X1=^(2) D  ; P285
"RTN","XQALERT",28,0)
 . . S X2=$P(X1,U,3)
"RTN","XQALERT",29,0)
 . . W !?5,"*** FORWARDED BY: ",$P(^VA(200,+X1,0),U),"   Generated: " S X1=$P($P(X,U,2),";",3) W $$DAT8(X1,1)
"RTN","XQALERT",30,0)
 . . I X2'="" W !?5,X2
"RTN","XQALERT",31,0)
 . I $P(X,U,5)="D" S XQA=$P(X,U,2) K ^XTV(8992,DUZ,"XQA",XQI) D  S XQX=XQX-1 D:XQA'="" D
"RTN","XQALERT",32,0)
 . . I $G(XQXX)>0,$G(XQXY)>0 S $P(^XTV(8992.1,XQXX,20,XQXY,0),U,5)=XQXDAT
"RTN","XQALERT",33,0)
 . K XQXX,XQXY
"RTN","XQALERT",34,0)
 I XQX>0 W:XQX1=0 !!,"You have PENDING ALERTS" W !?10,"Enter  ""VA to jump to VIEW ALERTS option",! ; ISL-0898-51279
"RTN","XQALERT",35,0)
 W:XQX1>0 !
"RTN","XQALERT",36,0)
 K XQI,XQX,XQX1,DIR,XQA,Y
"RTN","XQALERT",37,0)
 Q
"RTN","XQALERT",38,0)
SORT ;Sort alerts
"RTN","XQALERT",39,0)
 ; ZEXCEPT: XQAUSER,XQACNT - global variable
"RTN","XQALERT",40,0)
 N XQI,XQJ,XQX
"RTN","XQALERT",41,0)
 K ^TMP("XQ",$J,"XQA")
"RTN","XQALERT",42,0)
 F XQI=0:0 S XQI=$O(^XTV(8992,XQAUSER,"XQA",XQI)) Q:(XQI'>0)!(XQACNT>10000)  D
"RTN","XQALERT",43,0)
 . S XQX=^XTV(8992,XQAUSER,"XQA",XQI,0) ; zero node for the alert
"RTN","XQALERT",44,0)
 . S XQACNT=XQACNT+1
"RTN","XQALERT",45,0)
 . I $$CHKCRIT^XQALSUR2(XQX) D
"RTN","XQALERT",46,0)
 . . S XQJ=XQACNT ; critical alert
"RTN","XQALERT",47,0)
 . E  D
"RTN","XQALERT",48,0)
 . . S XQJ=500000+XQACNT ; normal alert
"RTN","XQALERT",49,0)
 . S ^TMP("XQ",$J,"XQA",XQJ)=XQI ; IEN of the alert
"RTN","XQALERT",50,0)
 Q
"RTN","XQALERT",51,0)
 ;
"RTN","XQALERT",52,0)
D ;
"RTN","XQALERT",53,0)
 ; ZEXCEPT: XQA
"RTN","XQALERT",54,0)
 K ^XTV(8992,"AXQA",XQA,DUZ),^XTV(8992,"AXQAN",$P(XQA,";"),DUZ)
"RTN","XQALERT",55,0)
 Q
"RTN","XQALERT",56,0)
 ;
"RTN","XQALERT",57,0)
DAT8(FMDAT,TFLG) ;
"RTN","XQALERT",58,0)
 N X
"RTN","XQALERT",59,0)
 S X=$E(FMDAT,4,5)_"/"_$E(FMDAT,6,7)_"/"_$E(FMDAT,2,3)
"RTN","XQALERT",60,0)
 I $G(TFLG)>0 S FMDAT=FMDAT_"0000000",X=X_" "_$E(FMDAT,9,10)_":"_$E(FMDAT,11,12)_":"_$E(FMDAT,13,14)
"RTN","XQALERT",61,0)
 Q X
"RTN","XQALERT",62,0)
 ;
"RTN","XQALERT",63,0)
DOIT ;OPT. Process Alerts [XQALERT]
"RTN","XQALERT",64,0)
 N XQALAST,XQALFWD,XQAUSER
"RTN","XQALERT",65,0)
 S XQAUSER=DUZ D DOIT^XQALERT1,COUNT^XQALDEL(0,XQAUSER)
"RTN","XQALERT",66,0)
 Q
"RTN","XQALERT",67,0)
 ;
"RTN","XQALERT",68,0)
DELETE ;
"RTN","XQALERT",69,0)
 D DELETE^XQALDEL
"RTN","XQALERT",70,0)
 Q
"RTN","XQALERT",71,0)
 ;
"RTN","XQALERT",72,0)
DELETEA ;
"RTN","XQALERT",73,0)
 D DELETEA^XQALDEL
"RTN","XQALERT",74,0)
 Q
"RTN","XQALERT",75,0)
 ;
"RTN","XQALERT",76,0)
OLDDEL ;OPT.
"RTN","XQALERT",77,0)
 D OLDDEL^XQALDEL
"RTN","XQALERT",78,0)
 Q
"RTN","XQALERT",79,0)
 ;
"RTN","XQALERT",80,0)
USERDEL ;OPT.
"RTN","XQALERT",81,0)
 D USERDEL^XQALDEL
"RTN","XQALERT",82,0)
 Q
"RTN","XQALERT",83,0)
 ;
"RTN","XQALERT",84,0)
USER(ROOT,XQAUSER,FRSTDATE,LASTDATE) ; Returns current alerts for the user in an array located under root
"RTN","XQALERT",85,0)
 I '$D(XQAUSER) S XQAUSER=DUZ
"RTN","XQALERT",86,0)
 I $$ACTVSURO^XQALSURO(XQAUSER)'>0 D RETURN^XQALSUR1(XQAUSER) ; P366
"RTN","XQALERT",87,0)
 D GETUSER^XQALDATA(ROOT,XQAUSER,$G(FRSTDATE),$G(LASTDATE))
"RTN","XQALERT",88,0)
 Q
"RTN","XQALERT",89,0)
 ;
"RTN","XQALERT",90,0)
PATIENT(ROOT,PATIENT,FRSTDATE,LASTDATE) ;
"RTN","XQALERT",91,0)
 I $G(PATIENT)'>0 Q
"RTN","XQALERT",92,0)
 D GETPAT^XQALDATA(ROOT,PATIENT,$G(FRSTDATE),$G(LASTDATE))
"RTN","XQALERT",93,0)
 Q
"RTN","XQALERT",94,0)
 ;
"RTN","XQALERT",95,0)
ACTION(ALERTID) ;
"RTN","XQALERT",96,0)
 D ACTION^XQALDOIT(ALERTID)
"RTN","XQALERT",97,0)
 Q
"RTN","XQALERT",98,0)
 ;
"RTN","XQALERT",99,0)
GETACT(ALERTID) ; Return to calling routine the information needed to act on the specified alert.
"RTN","XQALERT",100,0)
 ; On return the following variables are defined:
"RTN","XQALERT",101,0)
 ;  XQAID = the full alert id
"RTN","XQALERT",102,0)
 ;  XQADATA = Any data passed as XQADATA at the time the alert was generated
"RTN","XQALERT",103,0)
 ;  XQAROU  = Indicates routine to be run (includes tag if necessary)
"RTN","XQALERT",104,0)
 ;    This value may have three meanings
"RTN","XQALERT",105,0)
 ;      1.  A null value indicates no routine to be used (XQAOPT contains option name to be run)
"RTN","XQALERT",106,0)
 ;      2.  A value of ^<space>  indicates that the alert is information only (no routine or option action involved).
"RTN","XQALERT",107,0)
 ;      3.  The name of the routine as ^ROUTINE  or TAG^ROUTINE
"RTN","XQALERT",108,0)
 ;  XQAOPT  = Indicates the name of the option to be run if not null.
"RTN","XQALERT",109,0)
 ;
"RTN","XQALERT",110,0)
 ; ZEXCEPT: XQADATA,XQAID,XQAOPT,XQAROU
"RTN","XQALERT",111,0)
 N XQX,XQZ,XQAGETAC
"RTN","XQALERT",112,0)
 S XQAGETAC=1,XQX="",XQZ=""
"RTN","XQALERT",113,0)
 D ACTION^XQALDOIT(ALERTID)
"RTN","XQALERT",114,0)
 S XQAID=$P(XQX,U,2)
"RTN","XQALERT",115,0)
 S XQADATA=$S(XQZ'="":XQZ,1:$P(XQX,U,9,99))
"RTN","XQALERT",116,0)
 S XQAROU=$S($P(XQX,U,8)="":"",1:$P(XQX,U,7,8))
"RTN","XQALERT",117,0)
 S XQAOPT=$S($P(XQX,U,8)="":$P(XQX,U,7),1:"")
"RTN","XQALERT",118,0)
 Q
"RTN","XQALERT",119,0)
 ;
"RTN","XQALERT",120,0)
SETREV ; Set on (XQ1ON) and off (XQ1OFF) variables for Reverse video ; P285
"RTN","XQALERT",121,0)
 ; ZEXCEPT: IOST,XQ1OFF,XQ1ON - global variables
"RTN","XQALERT",122,0)
 N XQ1ON1,XQ1OFF1
"RTN","XQALERT",123,0)
 S XQ1ON="$C(0)",XQ1OFF="$C(0)" I IOST(0)>0 D
"RTN","XQALERT",124,0)
 . S XQ1ON1=$$GET1^DIQ(3.2,IOST(0)_",",14) I XQ1ON1'="" S XQ1ON=XQ1ON1
"RTN","XQALERT",125,0)
 . S XQ1OFF1=$$GET1^DIQ(3.2,IOST(0)_",",15) I XQ1OFF1'="" S XQ1OFF=XQ1OFF1
"RTN","XQALERT",126,0)
 . Q
"RTN","XQALERT",127,0)
 Q
"RTN","XQALERT1")
0^4^B93213944^B79700717
"RTN","XQALERT1",1,0)
XQALERT1 ;ISC-SF.SEA/JLI - ALERT HANDLER ;07/05/12  11:27
"RTN","XQALERT1",2,0)
 ;;8.0;KERNEL;**20,65,114,123,125,164,173,285,366,443,513,602**;Jul 10, 1995;Build 9
"RTN","XQALERT1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALERT1",4,0)
 Q
"RTN","XQALERT1",5,0)
 ;
"RTN","XQALERT1",6,0)
DOIT ;SR.
"RTN","XQALERT1",7,0)
 ; ZEXCEPT: IOF,XQAID,XQAUSER,XQX1 - global variables
"RTN","XQALERT1",8,0)
 ; ZEXCEPT: XQACNT,XQADATA,XQAKILL,XQALDELE,XQALFWD,XQAQ,XQAREV,XQAROU,XQAROUX,XQI,XQII,XQK,XQX,XQXOUT,XQZ4
"RTN","XQALERT1",9,0)
 N DIR,DIRUT,DUOUT,Y
"RTN","XQALERT1",10,0)
 I $D(XQX1),XQX1'>0 K XQX1
"RTN","XQALERT1",11,0)
 I $D(XQAID) D  I '$D(XQAID) G EXIT
"RTN","XQALERT1",12,0)
 . N XQACHOIC,REASK S REASK=0
"RTN","XQALERT1",13,0)
 . I '$D(XQX1),$O(^XTV(8992,XQAUSER,"XQA",+$O(^XTV(8992,XQAUSER,"XQA",0))))'>0,$G(XQAROUX)="^ " S XQAROU=""
"RTN","XQALERT1",14,0)
AGAIN . S XQACHOIC="Y:YES;N:NO;C:CONTINUE;",XQAQ("?")="Enter Y (or C) to continue, N to exit alert processing"
"RTN","XQALERT1",15,0)
 . S XQACHOIC=$G(XQACHOIC)_"F:FORWARD ALERT;R:RENEW(MAKE NEW AGAIN);" S XQAQ("?",1)="Enter F to forward this alert to someone else",XQAQ("?",2)="Enter R to Renew (Make New) this alert"
"RTN","XQALERT1",16,0)
 . D  I REASK=1 G AGAIN
"RTN","XQALERT1",17,0)
 . . S REASK=0 W !! K DIR S DIR(0)="SA^"_XQACHOIC,DIR("A")=$S(XQACHOIC["F:":"Continue (Y/N) or F(orward) or R(enew) ",1:"Continue Processing (Y/N) "),DIR("B")="YES" M DIR("?")=XQAQ("?") D ^DIR K DIR
"RTN","XQALERT1",18,0)
 . . I $D(DUOUT)!$D(DIRUT) S Y="N" K DUOUT,DIRUT
"RTN","XQALERT1",19,0)
 . . I Y="N" D:$D(XQAKILL) DELETEA^XQALERT K XQAID
"RTN","XQALERT1",20,0)
 . . I Y="R" S REASK=REASK+1 K XQAKILL I '$D(^XTV(8992,"AXQA",XQAID,DUZ)) D RESTORE
"RTN","XQALERT1",21,0)
 . . I Y="F" D:'$D(^XTV(8992,"AXQA",XQAID,DUZ)) RESTORE D FRWRDONE S REASK=REASK+1
"RTN","XQALERT1",22,0)
 . . Q
"RTN","XQALERT1",23,0)
 . Q
"RTN","XQALERT1",24,0)
 I $D(XQAKILL) D DELETEA^XQALERT
"RTN","XQALERT1",25,0)
 S XQAREV=1,XQXOUT=0,XQK=0,XQACNT=0 K XQADATA,XQAID,XQAROU,XQAKILL,XQAROUX
"RTN","XQALERT1",26,0)
 I '$D(XQX1) S XQX1=0 K ^TMP("XQ",$J,"XQA"),^("XQA1"),^("XQA2") I $O(^XTV(8992,XQAUSER,"XQA",0))'>0 K XQX1 D:'$G(^TMP("XQALERT1",$J,"NOTFIRST")) CHKSURO G:$O(^XTV(8992,XQAUSER,"XQA",0))'>0 EXIT S XQX1=0 ; P366
"RTN","XQALERT1",27,0)
 I $$ACTVSURO^XQALSURO(XQAUSER)'>0 D RETURN^XQALSUR1(XQAUSER) ; P366
"RTN","XQALERT1",28,0)
 S ^TMP("XQALERT1",$J,"NOTFIRST")=1 ; Added 2/2/99 jli to clear flag for initial entry
"RTN","XQALERT1",29,0)
 ;Sort and remove display only
"RTN","XQALERT1",30,0)
 I 'XQX1 W !!! D
"RTN","XQALERT1",31,0)
 . D SORT
"RTN","XQALERT1",32,0)
 ; Now display them.
"RTN","XQALERT1",33,0)
SUBLOOP W @IOF
"RTN","XQALERT1",34,0)
 N XQZ1,XQZ
"RTN","XQALERT1",35,0)
 S XQK=0 F XQI=0:0 Q:XQX1!XQXOUT  S XQI=$O(^TMP("XQ",$J,"XQA",XQI)) Q:XQI'>0  S XQX=^(XQI),XQII=^(XQI,1),XQZ=^(2),XQZ1=^(3),XQZ4=^(4) D  I XQX'="" D DOIT1
"RTN","XQALERT1",36,0)
 . I '$D(^XTV(8992,XQAUSER,"XQA",XQII)) S XQX="" K ^TMP("XQ",$J,"XQA",XQI),^TMP("XQ",$J,"XQA1",(XQI))
"RTN","XQALERT1",37,0)
 . Q
"RTN","XQALERT1",38,0)
 S:'$D(XQXOUT) XQXOUT=0 G:XQXOUT EXIT G:XQK'>0&'XQX1 EXIT I 'XQX1 D ASK G:XQXOUT EXIT
"RTN","XQALERT1",39,0)
 G:+XQX1=0 EXIT I XQX1<0 S XQX1=0 G DOIT
"RTN","XQALERT1",40,0)
 I $D(XQALDELE)!$D(XQALFWD) Q
"RTN","XQALERT1",41,0)
 G:XQXOUT EXIT
"RTN","XQALERT1",42,0)
 G EN^XQALDOIT
"RTN","XQALERT1",43,0)
 ;
"RTN","XQALERT1",44,0)
RESTORE ; SR. ICR #4100 (controlled subscription)
"RTN","XQALERT1",45,0)
 ; Restore a deleted message for use
"RTN","XQALERT1",46,0)
 ; ZEXCEPT: XQAID
"RTN","XQALERT1",47,0)
 N ALERTREF,XTVGLOB,ADUZ,X,X0,X1,X2,TIME,MESG,OPT,TAG,ROU,X4,LONG
"RTN","XQALERT1",48,0)
 S XTVGLOB=$NA(^XTV(8992,DUZ,"XQA"))
"RTN","XQALERT1",49,0)
 S ADUZ=$O(^XTV(8992,"AXQA",XQAID,0)) I ADUZ>0 S TIME=$O(^(ADUZ,0)) D  I 1
"RTN","XQALERT1",50,0)
 . M @XTVGLOB@(TIME)=^XTV(8992,ADUZ,"XQA",TIME) K @XTVGLOB@(TIME,2) ; copy alert, kill comment if any
"RTN","XQALERT1",51,0)
 E  S ALERTREF=$O(^XTV(8992.1,"B",XQAID,0)) Q:ALERTREF'>0  D  ; otherwise rebuild from alert tracking file if possible
"RTN","XQALERT1",52,0)
 . S X0=^XTV(8992.1,ALERTREF,0),X1=$G(^(1)),X2=$G(^(2)),X4=$O(^(4,0))
"RTN","XQALERT1",53,0)
 . S TIME=$P($P(X0,U),";",3),MESG=$P(X1,U),OPT=$P(X1,U,2),TAG=$P(X1,U,3),ROU=$P(X1,U,4),LONG=(X4>0)
"RTN","XQALERT1",54,0)
 . S X=TIME_U_XQAID_U_MESG_U_U_$S(OPT'=""!(ROU'=""):"R",LONG:"L",1:"I")_U_U_$S(OPT'="":OPT,TAG'="":TAG,1:"")_U_$S(OPT'="":"",ROU'="":ROU,1:" ")
"RTN","XQALERT1",55,0)
 . S @XTVGLOB@(TIME,0)=X I $G(X2)'="" S ^(1)=X2
"RTN","XQALERT1",56,0)
 S ^XTV(8992,"AXQA",XQAID,DUZ,TIME)="",^XTV(8992,"AXQAN",$E($P(XQAID,";"),1,30),DUZ,TIME)=""
"RTN","XQALERT1",57,0)
 Q
"RTN","XQALERT1",58,0)
 ;
"RTN","XQALERT1",59,0)
EXIT ;
"RTN","XQALERT1",60,0)
 ; ZEXCEPT: %ZIS,XQ1,XQ1OFF,XQ1ON,XQA1,XQACNT,XQALAST,XQALDELE,XQALFWD,XQAQ,XQAREV,XQAROU,XQAROUX,XQI,XQII,XQJ,XQK,XQOFF,XQON,XQOUT,XQX,XQX1,XQX2,XQXOUT
"RTN","XQALERT1",61,0)
 I $G(XQALAST)="I",$G(DUZ("AUTO")) D WAIT2
"RTN","XQALERT1",62,0)
 I $D(XQALDELE)!$D(XQALFWD) Q
"RTN","XQALERT1",63,0)
 K ^TMP("XQ",$J,"XQA"),^("XQA1"),^("XQA2"),XQI,XQX,XQJ,XQK,XQX1,XQX2,XQXOUT,XQ1,XQII,XQACNT,XQA1,XQAREV,%ZIS,XQAROU,XQALAST,XQAROUX,XQON,XQOFF,XQ1ON,XQ1OFF,XQOUT,XQAQ
"RTN","XQALERT1",64,0)
 K ^TMP("XQALERT1",$J)
"RTN","XQALERT1",65,0)
 Q
"RTN","XQALERT1",66,0)
 ;
"RTN","XQALERT1",67,0)
CHKSURO ; If user selects process alerts with no alerts present, give him/her the opportunity to add or delete a surrogate
"RTN","XQALERT1",68,0)
 ; P366 - list currently established surrogates if any
"RTN","XQALERT1",69,0)
 I '$G(^TMP("XQALERT1",$J,"NOTFIRST")) W !!,"You have no alerts for processing.",!
"RTN","XQALERT1",70,0)
 D SURROGAT^XQALSURO ; XU*8*17
"RTN","XQALERT1",71,0)
 Q
"RTN","XQALERT1",72,0)
 ;
"RTN","XQALERT1",73,0)
DOIT1 ;
"RTN","XQALERT1",74,0)
 ; ZEXCEPT: IOF,IOSL,XQ1OFF,XQ1ON,XQALFWD,XQALINFO,XQI,XQII,XQK,XQOFF,XQON,XQX,XQZ,XQZ1,XQZ4
"RTN","XQALERT1",75,0)
 I XQK=0 S XQALINFO=0 I '$D(XQALFWD) W @IOF
"RTN","XQALERT1",76,0)
 S XQON="$C(0)",XQOFF="$C(0)" I $$CHKCRIT^XQALSUR2(XQX) D:'$D(XQ1ON) SETREV^XQALERT S XQON=XQ1ON,XQOFF=XQ1OFF ; P513 modified to add use data from file 8992.3 for identifying critical alerts
"RTN","XQALERT1",77,0)
 S XQK=XQK+1 W !,$J(XQK,2),".",$S(XQZ4:"L",$P(XQX,U,8)=" ":"I",1:" "),"  ",@XQON,$E($P(XQX,U,3),1,70),@XQOFF S:$P(XQX,U,8)=" " XQALINFO=XQALINFO+1 D:XQZ1'=""  ; P285
"RTN","XQALERT1",78,0)
 . W !?8,"Forwarded by: ",$P(^VA(200,+XQZ1,0),U),"  Generated: ",$$DAT8^XQALERT(+$P($P(XQX,U,2),";",3),1)
"RTN","XQALERT1",79,0)
 . I $P(XQZ1,U,3)'="" W !?8,$P(XQZ1,U,3)
"RTN","XQALERT1",80,0)
 S ^TMP("XQ",$J,"XQA1",XQK)=XQX,^(XQK,1)=XQII,^(2)=XQZ,^(3)=XQZ1
"RTN","XQALERT1",81,0)
 I ($Y+6)>IOSL N XQKVALUE S XQKVALUE=XQK D ASK0(XQI) S:'$D(XQK) XQK=XQKVALUE Q:XQX1!(XQXOUT)  W @IOF
"RTN","XQALERT1",82,0)
 Q
"RTN","XQALERT1",83,0)
 ;
"RTN","XQALERT1",84,0)
ASK0(XQI) ;Stack XQI
"RTN","XQALERT1",85,0)
 ; ZEXCEPT: DIR,X,XQ1,XQACNT,XQALAST,XQALDELE,XQALFWD,XQAUSER,XQII,XQK,XQX1,XQX2,XQXOUT,Y
"RTN","XQALERT1",86,0)
ASK ;
"RTN","XQALERT1",87,0)
 N XQALNEWF K XQALAST
"RTN","XQALERT1",88,0)
 S XQ1=0,XQXOUT=0 W !?10,"Select from 1 to ",XQK W:$D(XQALDELE) " to DELETE" W:$D(XQALFWD) " to FORWARD"
"RTN","XQALERT1",89,0)
 W !?10,"or enter ?, A, " W:'$D(XQALDELE)&'$D(XQALFWD)&(XQALINFO>0) "I, D, " W:'$D(XQALDELE)&'$D(XQALFWD) "F, S, P, M, R, " W "or ^ to exit" I XQI>0,$O(^XTV(8992,XQAUSER,"XQA",XQI))>0 W !?10,"or RETURN to continue" S XQ1=1
"RTN","XQALERT1",90,0)
 R ": ",XQII:DTIME S:'$T!(XQII[U)!(XQII=""&'XQ1) XQXOUT=1 Q:XQXOUT
"RTN","XQALERT1",91,0)
 I '$D(XQALDELE)&'$D(XQALFWD),"PpMm"[$E(XQII_".") D MORP^XQALDOIT D:"Pp"[$E(XQII_".") PRINT^XQALDOIT D:"Mm"[$E(XQII_".") MAIL^XQALDOIT K ^TMP("XQ",$J,"XQA2") G ASK
"RTN","XQALERT1",92,0)
 I XQII'="",XQII["?" D HELP G ASK
"RTN","XQALERT1",93,0)
 I XQII=""&XQ1 Q
"RTN","XQALERT1",94,0)
 I "IiAaFfRrSsDd"'[$E(XQII_"."),$L(XQII)>31,$E(XQII,1,32)?1N.N W !,$C(7),"  ??  Invalid number entered",! G ASK
"RTN","XQALERT1",95,0)
 I "IiAaFfRrSsDd"'[$E(XQII_"."),(XQII<1)!(XQII>XQK) W $C(7),"  ??",! G ASK
"RTN","XQALERT1",96,0)
 I '$D(XQALDELE)&'$D(XQALFWD),"Ff"[$E(XQII) D FWRD^XQALFWD S XQX1=-2 Q  ; MODIFIED 7-6
"RTN","XQALERT1",97,0)
 I '$D(XQALDELE)&'$D(XQALFWD),"Ss"[$E(XQII) D CHKSURO S XQX1=-1 Q
"RTN","XQALERT1",98,0)
 I '$D(XQALDELE)&'$D(XQALFWD),"Dd"[$E(XQII) D ASKDEL S XQX1=-2 Q  ; MODIFIED 7-6
"RTN","XQALERT1",99,0)
 I '$D(XQALDELE),"Rr"[$E(XQII) S XQX1=-2 Q
"RTN","XQALERT1",100,0)
 I "Aa"[$E(XQII) S X="1-"_XQACNT,DIR(0)="LV^1:"_XQACNT D ^DIR K DIR,XQX1 M XQX1=Y S XQII="" K Y ;Merge list from Y
"RTN","XQALERT1",101,0)
 I XQII'="","Ii"[$E(XQII) S XQX1(0)="",XQX2=0,XQII="" F XQK=0:0 S XQK=$O(^TMP("XQ",$J,"XQA1",XQK)) S:XQK'>0 XQX1=XQX1(0) Q:XQK'>0  I $P(^(XQK),U,7,8)="^ " S XQX1(XQX2)=XQX1(XQX2)_XQK_"," S:$L(XQX1(XQX2))>240 XQX2=XQX2+1,XQX1(XQX2)=""
"RTN","XQALERT1",102,0)
 I XQII="" Q
"RTN","XQALERT1",103,0)
 S X=XQII,DIR(0)="LV^1:"_XQK D ^DIR I '$D(Y) W $C(7),"  ??" D HELP G ASK ;Use of 'LV' is special
"RTN","XQALERT1",104,0)
 K XQX1 M XQX1=Y K Y S Y=XQX1 ;Merge list from Y
"RTN","XQALERT1",105,0)
 Q
"RTN","XQALERT1",106,0)
 ;
"RTN","XQALERT1",107,0)
WAIT(IFN) ;Wait for user input if last alert is INFO and next isn't.
"RTN","XQALERT1",108,0)
 ; ZEXCEPT: IOF,IOSL,XQALAST
"RTN","XQALERT1",109,0)
 N X,YY Q:$G(XQXOUT)
"RTN","XQALERT1",110,0)
 S X=$G(^TMP("XQ",$J,"XQA1",IFN)),YY=$P(X,U,7,8),YY=$S(YY="^ ":"I",YY="^":"O",1:"R")
"RTN","XQALERT1",111,0)
 I $G(XQALAST)="I","OR"[YY D WAIT2
"RTN","XQALERT1",112,0)
 I YY="I",$Y+4>IOSL D WAIT2 W @IOF
"RTN","XQALERT1",113,0)
 S XQALAST=YY
"RTN","XQALERT1",114,0)
 Q
"RTN","XQALERT1",115,0)
 ;
"RTN","XQALERT1",116,0)
WAIT2 ;Wait for user input before continuing
"RTN","XQALERT1",117,0)
 ; ZEXCEPT: XQXOUT
"RTN","XQALERT1",118,0)
 N DIR,Y,DIROUT,DIRUT S DIR(0)="E",DIR("?")="The next ALERT may cause the loss of info on the screen."
"RTN","XQALERT1",119,0)
 D ^DIR S:$D(DIRUT) XQXOUT=1
"RTN","XQALERT1",120,0)
 Q
"RTN","XQALERT1",121,0)
 ;
"RTN","XQALERT1",122,0)
HELP ;
"RTN","XQALERT1",123,0)
 ; ZEXCEPT: XQALDELE,XQALFWD,XQI,XQK
"RTN","XQALERT1",124,0)
 W !!,"YOU MAY ENTER:",!?3,$S(XQK>1:"One or more numbers",1:"A number")," in the range 1 to ",XQK," to select specific alert(s)"
"RTN","XQALERT1",125,0)
 W !?6,"for "_$S($D(XQALDELE):"DELETION.",$D(XQALFWD):"FORWARDING",1:"processing.") W:XQK>1 "  This may be a series of numbers, e.g., 2,3,6-9"
"RTN","XQALERT1",126,0)
 W !?3,"A to "_$S($D(XQALDELE):"DELETE",$D(XQALFWD):"FORWARD",1:"process")," all of the pending alerts in the order shown."
"RTN","XQALERT1",127,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"I to process all of the INFORMATION ONLY alerts, if any, without further ado."
"RTN","XQALERT1",128,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"S to add or remove a surrogate to receive alerts for you"
"RTN","XQALERT1",129,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"F to forward one or more specific alerts.  Forwarding may be as an ALERT",!,"to specific user(s) and/or mail group(s), or as a MAIL MESSAGE, or to a",!,"specific PRINTER."
"RTN","XQALERT1",130,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"D to delete specific alerts (some alerts may not be deleted)"
"RTN","XQALERT1",131,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"P to print a copy of the pending alerts on a printer"
"RTN","XQALERT1",132,0)
 W:'$D(XQALDELE)&'$D(XQALFWD) !?3,"M to receive a MailMan message containing a copy of these pending alerts"
"RTN","XQALERT1",133,0)
 W:'$D(XQALDELE) !?3,"R to Redisplay the available alerts"
"RTN","XQALERT1",134,0)
 W !?3,"^ to exit"
"RTN","XQALERT1",135,0)
 I XQI W !?5,"or RETURN to see additional pending ALERTS"
"RTN","XQALERT1",136,0)
 W !!
"RTN","XQALERT1",137,0)
 Q
"RTN","XQALERT1",138,0)
 ;
"RTN","XQALERT1",139,0)
SORT ;Sort and remove display only
"RTN","XQALERT1",140,0)
 ; ZEXCEPT: XQAUSER,XQACNT,XQAREV - global variable
"RTN","XQALERT1",141,0)
 ; Unit test: P602T3^ZZUTXQA6
"RTN","XQALERT1",142,0)
 N XQZ,XQZ1,XQZ4,XQI,XQK,XQX,XQJ
"RTN","XQALERT1",143,0)
 K ^TMP("XQ",$J,"XQA")
"RTN","XQALERT1",144,0)
 K ^TMP("XQ",$J,"XQA1")
"RTN","XQALERT1",145,0)
 F XQI=0:0 S XQI=$O(^XTV(8992,XQAUSER,"XQA",XQI)) Q:(XQI'>0)!(XQACNT>10000)  D
"RTN","XQALERT1",146,0)
 . S XQX=^XTV(8992,XQAUSER,"XQA",XQI,0) ; zero node for the alert
"RTN","XQALERT1",147,0)
 . S XQZ=$G(^XTV(8992,XQAUSER,"XQA",XQI,1)) ; data for alert
"RTN","XQALERT1",148,0)
 . S XQZ1=$G(^XTV(8992,XQAUSER,"XQA",XQI,2)) ; comment for display
"RTN","XQALERT1",149,0)
 . S XQZ4=$O(^XTV(8992,XQAUSER,"XQA",XQI,4,0)) ; long info text
"RTN","XQALERT1",150,0)
 . S XQJ=$P(XQX,U,7,8) K:XQJ=U ^XTV(8992,XQAUSER,"XQA",XQI) I XQJ'=U D
"RTN","XQALERT1",151,0)
 . . S XQACNT=XQACNT+1
"RTN","XQALERT1",152,0)
 . . I $$CHKCRIT^XQALSUR2(XQX) D
"RTN","XQALERT1",153,0)
 . . . S XQJ=$S(XQAREV:499999-XQACNT,1:XQACNT) ; critical alert
"RTN","XQALERT1",154,0)
 . . E  D
"RTN","XQALERT1",155,0)
 . . . S XQJ=$S(XQAREV:999999-XQACNT,1:500000+XQACNT) ; normal alert
"RTN","XQALERT1",156,0)
 . . S ^TMP("XQ",$J,"XQA",XQJ)=XQX ; zero node for the alert
"RTN","XQALERT1",157,0)
 . . S ^TMP("XQ",$J,"XQA",XQJ,1)=XQI ; IEN of the alert
"RTN","XQALERT1",158,0)
 . . S ^TMP("XQ",$J,"XQA",XQJ,2)=XQZ ; data for the alert
"RTN","XQALERT1",159,0)
 . . S ^TMP("XQ",$J,"XQA",XQJ,3)=XQZ1 ; comment for display
"RTN","XQALERT1",160,0)
 . . S ^TMP("XQ",$J,"XQA",XQJ,4)=XQZ4 ; long info text
"RTN","XQALERT1",161,0)
 S XQK=0 F XQI=0:0 S XQI=$O(^TMP("XQ",$J,"XQA",XQI)) Q:XQI'>0  S XQK=XQK+1 M ^TMP("XQ",$J,"XQA1",XQK)=^TMP("XQ",$J,"XQA",XQI)
"RTN","XQALERT1",162,0)
 K ^TMP("XQ",$J,"XQA")
"RTN","XQALERT1",163,0)
 S XQK=0 F XQI=0:0 S XQI=$O(^TMP("XQ",$J,"XQA1",XQI)) Q:XQI'>0  S XQK=XQK+1 M ^TMP("XQ",$J,"XQA",XQK)=^TMP("XQ",$J,"XQA1",XQI)
"RTN","XQALERT1",164,0)
 Q
"RTN","XQALERT1",165,0)
 ;
"RTN","XQALERT1",166,0)
ASKDEL ;
"RTN","XQALERT1",167,0)
 ; ZEXCEPT: XQAUSER,XQX1 - global variables
"RTN","XQALERT1",168,0)
 N DIR,XQALDELE,XQX1COPY,XQAID,DA,XQAKILL,XQXOUT,XQAUSERD,XQALVALU,Y
"RTN","XQALERT1",169,0)
 S XQALDELE=1
"RTN","XQALERT1",170,0)
 K XQX1
"RTN","XQALERT1",171,0)
 D DOIT^XQALERT1
"RTN","XQALERT1",172,0)
 K XQALDELE S XQAUSERD=1
"RTN","XQALERT1",173,0)
 I $D(XQX1),XQX1>0 D
"RTN","XQALERT1",174,0)
 . M XQX1COPY=XQX1
"RTN","XQALERT1",175,0)
 . F  Q:XQX1=""  S DA=+XQX1,XQX1=$P(XQX1,",",2,99) D  I XQX1="" S Y=$O(XQX1(0)) I Y>0 S XQX1=XQX1(Y) K XQX1(Y)
"RTN","XQALERT1",176,0)
 . . S XQAID=$P(^TMP("XQ",$J,"XQA1",DA),U,2),XQALVALU=^(DA),XQAKILL=1
"RTN","XQALERT1",177,0)
 . . I $P(XQALVALU,U,8)=" "!$P(XQALVALU,U,10) D
"RTN","XQALERT1",178,0)
 . . . I XQAID="" K ^XTV(8992,XQAUSER,"XQA",+^TMP("XQ",$J,"XQA1",DA,1))
"RTN","XQALERT1",179,0)
 . . . I XQAID'="" D DELETE^XQALDEL
"RTN","XQALERT1",180,0)
 . . . K ^TMP("XQ",$J,"XQA1",DA),^TMP("XQ",$J,"XQA",(999999-DA))
"RTN","XQALERT1",181,0)
 . K XQX1 M XQX1=XQX1COPY S XQAID=0
"RTN","XQALERT1",182,0)
 . F  Q:XQX1=""  S DA=+XQX1,XQX1=$P(XQX1,",",2,99) D  I XQX1="" S Y=$O(XQX1(0)) I Y>0 S XQX1=XQX1(Y) K XQX1(Y)
"RTN","XQALERT1",183,0)
 . . I $D(^TMP("XQ",$J,"XQA1",DA)) W:'XQAID !!,"Unable to delete alerts which require action: ",DA W:XQAID ",",DA S XQAID=1
"RTN","XQALERT1",184,0)
 . I XQAID=1 K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","XQALERT1",185,0)
 K XQX1,XQAKILL
"RTN","XQALERT1",186,0)
 Q
"RTN","XQALERT1",187,0)
 ;
"RTN","XQALERT1",188,0)
FRWRDONE ;
"RTN","XQALERT1",189,0)
 ; ZEXCEPT: XQAID - global variable
"RTN","XQALERT1",190,0)
 N XQX1,XQALFWDL S XQALFWDL(1)=XQAID
"RTN","XQALERT1",191,0)
 N XQAID
"RTN","XQALERT1",192,0)
 D FWDONE^XQALFWD
"RTN","XQALERT1",193,0)
 Q
"RTN","XQALFWD")
0^2^B28643229^B24652553
"RTN","XQALFWD",1,0)
XQALFWD ;ISC/JLI,ISD/HGW - FORWARD ALERTS ;06/20/12  13:09
"RTN","XQALFWD",2,0)
 ;;8.0;KERNEL;**6,65,91,111,114,128,129,285,602**;Jul 10, 1995;Build 9
"RTN","XQALFWD",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQALFWD",4,0)
 Q
"RTN","XQALFWD",5,0)
FWRD ; ENTRY POINT FOR SELECTION FROM 'VIEW ALERTS' SCREEN
"RTN","XQALFWD",6,0)
 ; USER NEEDS TO SELECT ALERT(S) FOR FORWARDING
"RTN","XQALFWD",7,0)
 ; TYPE (ALERT, MAIL MESSAGE, OR PRINT)
"RTN","XQALFWD",8,0)
 ; AND RECIPIENT(S) OR DEVICE
"RTN","XQALFWD",9,0)
 ; AND COMMENT IF ANY TO BE DISPLAYED WITH ALERT
"RTN","XQALFWD",10,0)
 ;
"RTN","XQALFWD",11,0)
 ; ZEXCEPT: DIC,DIRUT,IOF,X,XQA,XQAARR,XQACOMNT,XQALFWD,XQALFWDL,XQATYP,XQX1,XQXOUT,Y
"RTN","XQALFWD",12,0)
 W !,"Enter RETURN to continue:" R X:DTIME Q:'$T  W @IOF,!,"You may now Select the alert or alerts that you want forwarded:",!
"RTN","XQALFWD",13,0)
 N XQI,XQK,XQACNT,XQAREV,DIR
"RTN","XQALFWD",14,0)
 S XQALFWD=1 S XQX1=-1 D DOIT^XQALERT1
"RTN","XQALFWD",15,0)
 K XQALFWDL
"RTN","XQALFWD",16,0)
 S:'$D(XQX1) XQX1=-1 S:'$D(XQXOUT) XQXOUT=0
"RTN","XQALFWD",17,0)
 F  Q:XQX1'>0  S XQALFWDL(+XQX1)=$P(^TMP("XQ",$J,"XQA1",+XQX1),U,2),XQX1=$P(XQX1,",",2,200)
"RTN","XQALFWD",18,0)
 G:'$D(XQALFWDL) EXIT
"RTN","XQALFWD",19,0)
FWDONE K DIR S DIR(0)="S^A:ALERT;M:MAIL MESSAGE;P:PRINT COPY;",DIR("A")="Select the method of forwarding desired",DIR("B")="ALERT" D ^DIR K DIR G:$D(DIRUT) EXIT S XQATYP=Y
"RTN","XQALFWD",20,0)
 I XQATYP="A"!(XQATYP="M") D LOOP1^XQALMAKE G:'$D(XQA) EXIT N XQAI S XQAI="" F  S XQAI=$O(XQA(XQAI)) Q:XQAI=""  S XQAARR(XQAI)=XQAI K XQA(XQAI)
"RTN","XQALFWD",21,0)
 I XQATYP="P" S DIC=3.5,DIC(0)="AEQM",DIC("A")="Select the DEVICE to print on: " D ^DIC K DIC G:Y'>0 EXIT S XQAARR="`"_(+Y)
"RTN","XQALFWD",22,0)
 S DIR("A",1)="You may enter a comment to be associated with the forwarded alert if you wish",DIR("A")="Comment (optional)",DIR("?")="Free text 1 to 245 characters.",DIR(0)="FO^1:245"
"RTN","XQALFWD",23,0)
 D ^DIR G:$D(DUOUT)!$D(DTOUT)!$D(DIROUT) EXIT S XQACOMNT=X
"RTN","XQALFWD",24,0)
 K XQALFWD,DIR
"RTN","XQALFWD",25,0)
 D FORWARD(.XQALFWDL,.XQAARR,XQATYP,XQACOMNT)
"RTN","XQALFWD",26,0)
EXIT S XQX1=-1 W !!,"You will now return to PROCESSING ALERTS, enter RETURN to continue:" R X:DTIME
"RTN","XQALFWD",27,0)
 K XQALFWDL,XQAARR,XQATYP,XQACOMNT,DIRUT,XQALFWD
"RTN","XQALFWD",28,0)
 Q
"RTN","XQALFWD",29,0)
 ;
"RTN","XQALFWD",30,0)
FORWARD1(XQAID,XQARECIP,XQATYPE,XQACOMNT,XQALTYPE) ;
"RTN","XQALFWD",31,0)
 D FORWARD(.XQAID,XQARECIP,XQATYPE,XQACOMNT)
"RTN","XQALFWD",32,0)
 Q
"RTN","XQALFWD",33,0)
 ;
"RTN","XQALFWD",34,0)
FORWARD(XQALST,XQARECIP,XQATYPE,XQACOMNT) ; SR. ICR #3009 (Supported)
"RTN","XQALFWD",35,0)
 ;D FORWARD^XQALFWD([.]alerts,[.]users,type[,comment])
"RTN","XQALFWD",36,0)
 ;  [.]alerts - Alerts to be forwarded by full identifier ($$SETUP1^XQALERT)
"RTN","XQALFWD",37,0)
 ;  [.]users  - Users to forward alerts to by IEN (file #200), G.MAIL GROUP, or printer (name or `IEN)
"RTN","XQALFWD",38,0)
 ;  type      - A:alert, M:mailgroup, P:printer
"RTN","XQALFWD",39,0)
 ;  comment   - Character string comment to accompany the alert
"RTN","XQALFWD",40,0)
 ; ZEXCEPT: IOP
"RTN","XQALFWD",41,0)
 Q:'$D(XQALST)  Q:'$D(XQARECIP)
"RTN","XQALFWD",42,0)
 N I,XQAPRNT,XQAVALS,XQALTYPE,%ZIS,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","XQALFWD",43,0)
 S XQALTYPE="FWD BY USER"
"RTN","XQALFWD",44,0)
 S XQATYPE=$G(XQATYPE)
"RTN","XQALFWD",45,0)
 I XQATYPE="A" D
"RTN","XQALFWD",46,0)
 . N XQAI S XQAI="" F  S XQAI=$O(XQALST(XQAI)) Q:XQAI=""  D SETXQA D RESETUP(XQALST(XQAI),.XQAVALS,XQACOMNT)
"RTN","XQALFWD",47,0)
 . I $O(XQALST(""))="",$D(XQALST)=1,XQALST'="" D SETXQA D RESETUP(XQALST,.XQAVALS,XQACOMNT)
"RTN","XQALFWD",48,0)
 I XQATYPE="M" D
"RTN","XQALFWD",49,0)
 . D MAIL1
"RTN","XQALFWD",50,0)
 I XQATYPE="P" D
"RTN","XQALFWD",51,0)
 . S XQAPRNT=$$FIND1^DIC(3.5,,"X",$G(XQARECIP)) Q:XQAPRNT'>0  ;p602
"RTN","XQALFWD",52,0)
 . S IOP="Q;"_$P($G(^%ZIS(1,XQAPRNT,0)),U) ;p602
"RTN","XQALFWD",53,0)
 . S %ZIS="Q" D ^%ZIS Q:POP  ;p602
"RTN","XQALFWD",54,0)
 . S ZTRTN="PRNT^XQALFWD",ZTDESC="Forward alerts to printer",ZTDTH=$H,ZTSAVE("XQA*")="" ;p602
"RTN","XQALFWD",55,0)
 . D ^%ZTLOAD D HOME^%ZIS K IO("Q") ;p602
"RTN","XQALFWD",56,0)
 Q
"RTN","XQALFWD",57,0)
 ;
"RTN","XQALFWD",58,0)
SETXQA ;
"RTN","XQALFWD",59,0)
 ; ZEXCEPT: J,XQARECIP,XQAVALS
"RTN","XQALFWD",60,0)
 I $D(XQARECIP)=1 S XQAVALS(XQARECIP)="" Q
"RTN","XQALFWD",61,0)
 S J="" F  S J=$O(XQARECIP(J)) Q:J=""  S XQAVALS(XQARECIP(J))=""
"RTN","XQALFWD",62,0)
 Q
"RTN","XQALFWD",63,0)
 ;
"RTN","XQALFWD",64,0)
SETXMY ;
"RTN","XQALFWD",65,0)
 ; ZEXCEPT: J,XMY,XQARECIP
"RTN","XQALFWD",66,0)
 I $D(XQARECIP)=1 S XMY(XQARECIP)="" Q
"RTN","XQALFWD",67,0)
 S J="" F  S J=$O(XQARECIP(J)) Q:J=""  S XMY(XQARECIP(J))=""
"RTN","XQALFWD",68,0)
 Q
"RTN","XQALFWD",69,0)
 ;
"RTN","XQALFWD",70,0)
MAIL1 ;
"RTN","XQALFWD",71,0)
 ; ZEXCEPT: X,XQALST,XQAUSER
"RTN","XQALFWD",72,0)
 N I,XMY,XMSUB,XMTEXT
"RTN","XQALFWD",73,0)
 N XQAI S XQAI="" F  S XQAI=$O(XQALST(XQAI)) Q:XQAI=""  S X=$O(^XTV(8992,"AXQA",XQALST(XQAI),XQAUSER,0)) I X'="" S X=$G(^XTV(8992,XQAUSER,"XQA",X,0)) I X'="" D SETXMY D MAIL
"RTN","XQALFWD",74,0)
 I $D(XQALST)=1,XQALST]"" S X=$O(^XTV(8992,"AXQA",XQALST,XQAUSER,0)) I X'="" S X=$G(^XTV(8992,XQAUSER,"XQA",X,0)) I X'="" D SETXMY D MAIL
"RTN","XQALFWD",75,0)
 Q
"RTN","XQALFWD",76,0)
MAIL ;
"RTN","XQALFWD",77,0)
 ; ZEXCEPT: X,XMSUB,XMTEXT,XQACOMNT,XQAUSER
"RTN","XQALFWD",78,0)
 K ^TMP($J,"XQAL") S XMSUB="ALERT: "_$P(X,U,3),XMTEXT="^TMP($J,""XQAL"","
"RTN","XQALFWD",79,0)
 S ^TMP($J,"XQAL",1,0)=$P(X,U,3),^TMP($J,"XQAL",2,0)="  Forwarded by: "_$P(^VA(200,XQAUSER,0),U)_"       Generated: "_$$DAT8^XQALERT($P($P(X,U,2),";",3),1) S:$G(XQACOMNT)'="" ^TMP($J,"XQAL",3,0)=XQACOMNT
"RTN","XQALFWD",80,0)
 D ^XMD
"RTN","XQALFWD",81,0)
 Q
"RTN","XQALFWD",82,0)
 ;
"RTN","XQALFWD",83,0)
PRNT ;
"RTN","XQALFWD",84,0)
 ; ZEXCEPT: X,XQALST,XQAUSER
"RTN","XQALFWD",85,0)
 I $D(XQALST)=1,XQALST>0 S X=$O(^XTV(8992,"AXQA",XQALST,XQAUSER,0)) I X'="" S X=$G(^XTV(8992,XQAUSER,"XQA",X,0)) I X'="" D PRNT1
"RTN","XQALFWD",86,0)
 N XQAI S XQAI="" F  S XQAI=$O(XQALST(XQAI)) Q:XQAI=""  S X=$O(^XTV(8992,"AXQA",XQALST(XQAI),XQAUSER,0)) I X'="" S X=$G(^XTV(8992,XQAUSER,"XQA",X,0)) I X'="" D PRNT1
"RTN","XQALFWD",87,0)
 Q
"RTN","XQALFWD",88,0)
PRNT1 ;
"RTN","XQALFWD",89,0)
 ; ZEXCEPT: IOF,X,XQACOMNT,XQAUSER
"RTN","XQALFWD",90,0)
 U IO W @IOF
"RTN","XQALFWD",91,0)
 W !!,"ALERT:  "_$P(X,U,3),!!,"   Forwarded by: ",$P(^VA(200,XQAUSER,0),U),"    Generated on: ",$$DAT8^XQALERT($P($P(X,U,2),";",3)),!!,$G(XQACOMNT)
"RTN","XQALFWD",92,0)
 Q
"RTN","XQALFWD",93,0)
 ;
"RTN","XQALFWD",94,0)
RESETUP(XQAIDVAL,XQA,XQACOMNT) ;
"RTN","XQALFWD",95,0)
 ; ZEXCEPT: XQALTYPE,XQAUSER
"RTN","XQALFWD",96,0)
 N XQAIEN,DA,XQI,XQJ,XQK,XQX,X,X1,X3,XQARESET,XQAID,XQA1,XQADA,XQAOPT1,XQAMSG,XQACTMSG,XQADATA,XQAGUID,RETVAL,XQADA,XQADFN
"RTN","XQALFWD",97,0)
 S:'$D(XQAUSER) XQAUSER=DUZ
"RTN","XQALFWD",98,0)
 S XQARESET=1,XQALTYPE=$G(XQALTYPE,"FWD BY USER")
"RTN","XQALFWD",99,0)
 S XQAIEN=$O(^XTV(8992,"AXQA",XQAIDVAL,XQAUSER,0)) Q:XQAIEN'>0
"RTN","XQALFWD",100,0)
 S X=$G(^XTV(8992,XQAUSER,"XQA",XQAIEN,0)),X1=$G(^(1)),X3=$G(^(3))
"RTN","XQALFWD",101,0)
 Q:X=""
"RTN","XQALFWD",102,0)
 S XQAID=$P(X,U,2),XQA1=$P(XQAID,";"),XQADA=$O(^XTV(8992.1,"B",XQAID,0))
"RTN","XQALFWD",103,0)
 S XQAOPT1=$P(X,U,7,8),XQAMSG=$P(X,U,3),XQACTMSG=$P(X,U,6)
"RTN","XQALFWD",104,0)
 S XQADATA=$S(X1'="":X1,1:$P(X,U,9,100)) S:$P(X3,U)'="" XQAGUID=$P(X3,U) S:$P(X3,U,2)'="" XQADFN=$P(X3,U,2)
"RTN","XQALFWD",105,0)
 S XQX=$$NOW^XLFDT()
"RTN","XQALFWD",106,0)
 S RETVAL=$$REENT^XQALSET()
"RTN","XQALFWD",107,0)
 Q
"RTN","XQALMAKE")
0^11^B13644529^B13487319
"RTN","XQALMAKE",1,0)
XQALMAKE ;ISC-SF.SEA/JLI- HIGH LEVEL SETUP ALERT ;4/9/07  14:03
"RTN","XQALMAKE",2,0)
 ;;8.0;KERNEL;**443,602**;Jul 10, 1995;Build 9
"RTN","XQALMAKE",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALMAKE",4,0)
 ;;
"RTN","XQALMAKE",5,0)
ENTRY ;
"RTN","XQALMAKE",6,0)
 W !!,"ALERT GENERATOR"
"RTN","XQALMAKE",7,0)
TEXT K XQA,XQAMSG,XQAOPT,XQAROU,DIC,DIR
"RTN","XQALMAKE",8,0)
 R !!,"ON THE NEXT LINE ENTER THE TEXT TO BE DISPLAYED FOR THE ALERT ___",!,X:DTIME G:'$T!(X[U)!(X="") EXIT W !!,X S XQALX=X,DIR(0)="Y",DIR("A")="Is this text OK? ",DIR("B")="YES" D ^DIR K DIR G:'Y TEXT S XQAMSG=XQALX
"RTN","XQALMAKE",9,0)
 D LOOP1 G:'$D(XQA) EXIT
"RTN","XQALMAKE",10,0)
ASKOPT S DIR(0)="Y",DIR("A")="Do you want to transfer control to an option when the alert is selected" D ^DIR K DIR I Y D GETOPT G:Y'="" SETIT G ASKOPT
"RTN","XQALMAKE",11,0)
ASKROU S DIR(0)="Y",DIR("A")="Do you want to transfer control to a routine when the alert is selected" D ^DIR K DIR G:'Y SETIT
"RTN","XQALMAKE",12,0)
 R !,"Enter ROUTINE name or ENTRY^ROUTINE name: ",X:DTIME S:'$T X=U G:X=U EXIT G:X="" ASKROU S XQAROU=X S X=$S(X'[U:X,1:$P(X,U,2)) G:X="" ASKROU X ^%ZOSF("TEST") I 'Y W !,"Routine '",X,"' not present" G ASKROU
"RTN","XQALMAKE",13,0)
SETIT ;
"RTN","XQALMAKE",14,0)
 I '$D(XQAROU),'$D(XQAOPT) S DIR(0)="Y",DIR("A")="Do you want to make a long text info only alert" D ^DIR K DIR I Y D LONGTEXT
"RTN","XQALMAKE",15,0)
 W !!,"As currently entered, this alert will display the following text:",!!,XQAMSG
"RTN","XQALMAKE",16,0)
 W !!,"The alert is currently to be delivered to:" S XQAX="" F I=1:1 S XQAX=$O(XQA(XQAX)) Q:XQAX=""  S X=$S(XQAX>0:$P(^VA(200,XQAX,0),U),1:XQAX) W:(I#2) ! W:'(I#2) ?40 W X
"RTN","XQALMAKE",17,0)
 W:$D(XQAROU) !!,"On selection of the alert, the user will run the routine ",XQAROU W:$D(XQAOPT) !!,"On selection of the alert, the user will be taken to the",!,"the option ",XQAOPT W !!
"RTN","XQALMAKE",18,0)
 S DIR(0)="Y",DIR("A")="Is this alert what was intended",DIR("B")="YES" D ^DIR K DIR I 'Y G ENTRY
"RTN","XQALMAKE",19,0)
 D SETUP^XQALERT
"RTN","XQALMAKE",20,0)
 W !!?20,"ALERT IS NOW SET",!!
"RTN","XQALMAKE",21,0)
 G ENTRY
"RTN","XQALMAKE",22,0)
 ;
"RTN","XQALMAKE",23,0)
GETOPT ;
"RTN","XQALMAKE",24,0)
 S DIC=19,DIC(0)="AEQM",DIC("A")="Indicate the desired OPTION: " D ^DIC K DIC S:Y'>0 Y="" S XQAOPT=$P(Y,U,2)
"RTN","XQALMAKE",25,0)
 Q
"RTN","XQALMAKE",26,0)
 ;
"RTN","XQALMAKE",27,0)
EXIT ;
"RTN","XQALMAKE",28,0)
 K XQALDIC,XQALX,XQA,XQAMSG,XQAOPT,XQAROU,DIC,DIR,X,Y
"RTN","XQALMAKE",29,0)
 Q
"RTN","XQALMAKE",30,0)
LOOP1 K XQA R !,"Enter a User name or G.mailgroup",!,"as recipient of the Alert: ",X:DTIME S:'$T!(X="") X=U I X'[U D SETONE G:Y'>0 LOOP1
"RTN","XQALMAKE",31,0)
 I X'[U F  R !,"Enter another user or G.mailgroup: ",X:DTIME  S:'$T X=U Q:X[U!(X="")  D SETONE
"RTN","XQALMAKE",32,0)
 K:X[U XQA Q
"RTN","XQALMAKE",33,0)
SETONE ;
"RTN","XQALMAKE",34,0)
 S XQALDIC=$S("g.G."[$E(X,1,2):3.8,1:200),X=$S(XQALDIC=3.8:$E(X,3,$L(X)),1:X),DIC=XQALDIC,DIC(0)="EMQ" D ^DIC Q:Y'>0  S X=$S(XQALDIC=3.8:"G."_$P(Y,U,2),1:+Y),XQA(X)=""
"RTN","XQALMAKE",35,0)
 Q
"RTN","XQALMAKE",36,0)
 ;
"RTN","XQALMAKE",37,0)
LONGTEXT ;
"RTN","XQALMAKE",38,0)
 W !,"Enter .EXIT  to terminate input",!
"RTN","XQALMAKE",39,0)
 S COUNT="" F  R X:DTIME Q:X=".EXIT"  S COUNT=COUNT+1,XQATEXT(COUNT)=X W !
"RTN","XQALMAKE",40,0)
 Q
"RTN","XQALSET")
0^10^B72705650^B72175488
"RTN","XQALSET",1,0)
XQALSET ;ISC-SF.SEA/JLI - SETUP ALERTS ;4/10/07  14:06
"RTN","XQALSET",2,0)
 ;;8.0;KERNEL;**1,6,65,75,114,125,173,207,285,443,602**;Jul 10, 1995;Build 9
"RTN","XQALSET",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALSET",4,0)
 ;;
"RTN","XQALSET",5,0)
 Q
"RTN","XQALSET",6,0)
 ; Original entry point - throw away return value since no value expected
"RTN","XQALSET",7,0)
SETUP ;
"RTN","XQALSET",8,0)
 N I S I=$$SETUP1() K XQALERR
"RTN","XQALSET",9,0)
 Q
"RTN","XQALSET",10,0)
 ;
"RTN","XQALSET",11,0)
SETUP1() ; .SR Returns a string beginning with 1 if successful, 0 if not successful, the second piece is the IEN in the Alert Tracking File and the third piece is the value of XQAID.
"RTN","XQALSET",12,0)
 ; If not successful XQALERR is defined and contains reason for failure.
"RTN","XQALSET",13,0)
 K XQALERR
"RTN","XQALSET",14,0)
 I $O(XQA(0))="" S XQALERR="No recipient list in XQA array" Q 0
"RTN","XQALSET",15,0)
 I '($D(XQAMSG)#2)!($G(XQAMSG)="") S XQALERR="No valid XQAMSG for display" Q 0
"RTN","XQALSET",16,0)
 N X,XQI,XQJ,XQX,XQK,XQACOMNT,XQARESET,DA,XQADA,XQALTYPE
"RTN","XQALSET",17,0)
 S XQALTYPE="INITIAL RECIPIENT"
"RTN","XQALSET",18,0)
 S XQAOPT1=$S('($D(XQAROU)#2):U,XQAROU'[U:U_XQAROU,1:XQAROU),XQAOPT1=$S(XQAOPT1'=U:XQAOPT1,$D(XQAOPT)#2:XQAOPT_U,1:XQAOPT1) S:XQAOPT1=U XQAOPT1=U_" "
"RTN","XQALSET",19,0)
NOW S XQX=$$NOW^XLFDT()
"RTN","XQALSET",20,0)
 S:$S('$D(XQAID):1,XQAID="":1,1:0) XQAID="NO-ID" S:XQAID[";" XQAID=$P(XQAID,";") S XQA1=XQAID,XQI=XQX
"RTN","XQALSET",21,0)
 S XQAID=$$SETIEN(XQA1,XQX),XQADA=""
"RTN","XQALSET",22,0)
 Q $$REENT()
"RTN","XQALSET",23,0)
 ;
"RTN","XQALSET",24,0)
REENT() ; Entry for forwarding, etc.
"RTN","XQALSET",25,0)
 N RETVAL S RETVAL=1
"RTN","XQALSET",26,0)
 K ^TMP("XQAGROUP",$J) ; P443 - clear location for storage of groups processed
"RTN","XQALSET",27,0)
 N XQADATIM,XQALIST,XQALIST1,XQNRECIP S XQNRECIP=0 S XQADATIM=$$NOW^XLFDT()
"RTN","XQALSET",28,0)
 S XQALIN1=$S($D(XQAID)#2:XQAID,1:"")_U_$E(XQAMSG,1,80)_"^1^"_$S(XQAOPT1=U:"D",1:"R")_U_$S($D(XQACTMSG):$E(XQACTMSG,1,40),1:"")_U_XQAOPT1
"RTN","XQALSET",29,0)
 S:$D(XQACNDEL) $P(XQALIN1,U,9)=1 S:$D(XQASURO) $P(XQALIN1,U,12)=XQASURO S:$D(XQASUPV) $P(XQALIN1,U,13)=XQASUPV S:$D(XQAREVUE) $P(XQALIN1,U,14)=XQAREVUE
"RTN","XQALSET",30,0)
 S XQALIN=XQX_U_XQALIN1,XQJ=0
"RTN","XQALSET",31,0)
 K XQALIN1 S:$D(XQADATA) XQALIN1=XQADATA
"RTN","XQALSET",32,0)
LOOP1 S XQJ=$O(XQA(" ")) I XQJ'="" K:"G.g."'[$E(XQJ_",,",1,2) XQA(XQJ) D:$D(XQA(XQJ)) GROUP^XQALSET1 G LOOP1
"RTN","XQALSET",33,0)
LOOP2 ; RE-ENTRY FOR FORWARDING IF ALL RECIPIENTS ARE UNDELIVERABLE
"RTN","XQALSET",34,0)
 N:'$D(XQAUSER) XQAUSER M XQALIST=XQA F I=0:0 S I=$O(XQALIST(I)) Q:I'>0  S XQALIST(I,XQALTYPE)="" I '$D(XQAUSER) S XQAUSER=I ; SAVE ORIGINAL LIST OF RECIPIENTS AND REASON
"RTN","XQALSET",35,0)
 ; The following section of code was added to provide a generalized way to handle surrogates
"RTN","XQALSET",36,0)
 F XQJ=0:0 S XQJ=$O(XQA(XQJ)) Q:XQJ=""  D
"RTN","XQALSET",37,0)
 . N X S X=$$ACTVSURO^XQALSURO(XQJ) I X>0 D  ; Modified to get final surrogate if a sequence of them
"RTN","XQALSET",38,0)
 . . S XQA(X)="" K XQA(XQJ) ; Add Surrogate to XQA array, delete XQJ entry
"RTN","XQALSET",39,0)
 . . S XQALIST(X,$O(XQALIST(XQJ,""))_"-SURROGATE")="" ; Add Surrogate to XQALIST with same type as original
"RTN","XQALSET",40,0)
 . . S XQALIST(X,"z AS_SURO",XQJ)="" ; Mark user as in list as a surrogate, subscript for surrogate to
"RTN","XQALSET",41,0)
 . . S XQALIST(XQJ,"z TO_SURO",X)=""
"RTN","XQALSET",42,0)
 . . Q
"RTN","XQALSET",43,0)
 . Q
"RTN","XQALSET",44,0)
 ;
"RTN","XQALSET",45,0)
 S XQJ=0
"RTN","XQALSET",46,0)
LOOP ;
"RTN","XQALSET",47,0)
 S XQJ=$O(XQA(XQJ)) G:XQJ="" WRAP
"RTN","XQALSET",48,0)
 ;
"RTN","XQALSET",49,0)
 I '(+$$ACTIVE^XUSER(XQJ)) K XQA(XQJ) N XX S XX=$O(XQALIST(XQJ,"")) K XQALIST(XQJ,XX) S XQALIST(XQJ,XX_"-UNDELIVERABLE")="" G LOOP ;Don't send to users that can't sign-on
"RTN","XQALSET",50,0)
 ;
"RTN","XQALSET",51,0)
 I '$D(^XTV(8992,XQJ,0)) D  I '$D(^XTV(8992,XQJ,0)) S ^(0)=XQJ
"RTN","XQALSET",52,0)
 . N FDA,IENS
"RTN","XQALSET",53,0)
 . F  D  Q:'$D(DIERR)  Q:'$D(^TMP("DIERR",$J,"E",110))&'$D(^TMP("DIERR",$J,"E",111))
"RTN","XQALSET",54,0)
 . . K DIERR,^TMP("DIERR",$J)
"RTN","XQALSET",55,0)
 . . S FDA=$NA(^TMP($J,"XQALSET")) K @FDA S @FDA@(8992,"+1,",.01)=XQJ
"RTN","XQALSET",56,0)
 . . S IENS(1)=XQJ
"RTN","XQALSET",57,0)
 . . D UPDATE^DIE("S",FDA,"IENS")
"RTN","XQALSET",58,0)
 . . Q
"RTN","XQALSET",59,0)
 . Q
"RTN","XQALSET",60,0)
 L +^XTV(8992,XQJ):10 S XQXI=XQX S:'$D(^XTV(8992,XQJ,"XQA",0)) ^(0)="^8992.01DA^"
"RTN","XQALSET",61,0)
REP I $D(^XTV(8992,XQJ,"XQA",XQXI,0)) S XQXI=XQXI+.00000001 G REP
"RTN","XQALSET",62,0)
 S ^XTV(8992,XQJ,"XQA",XQXI,0)=XQALIN S:$D(XQALIN1) ^(1)=XQALIN1 S:$D(XQAGUID)!$D(XQADFN) ^(3)=$G(XQAGUID)_U_$G(XQADFN) S:$D(XQARESET) ^(2)=XQAUSER_U_XQX_U_$G(XQACOMNT) S ^(0)=$P(^XTV(8992,XQJ,"XQA",0),U,1,2)_U_XQXI_U_($P(^(0),U,4)+1)
"RTN","XQALSET",63,0)
 I $D(XQATEXT) S:($D(XQATEXT)#2) XQATEXT(.1)=XQATEXT D WP^DIE(8992.01,(XQXI_","_XQJ_","),4,"","XQATEXT") ; P443 PUT DATA IN XQATEXT INTO ARRAY
"RTN","XQALSET",64,0)
 L -^XTV(8992,XQJ)
"RTN","XQALSET",65,0)
 K XQA(XQJ) S:XQAID'="" ^XTV(8992,"AXQA",XQAID,XQJ,XQXI)="",^XTV(8992,"AXQAN",XQA1,XQJ,XQXI)=""
"RTN","XQALSET",66,0)
 S XQNRECIP=XQNRECIP+1
"RTN","XQALSET",67,0)
 G LOOP
"RTN","XQALSET",68,0)
 ;
"RTN","XQALSET",69,0)
WRAP ;
"RTN","XQALSET",70,0)
 M XQALIST1=XQALIST
"RTN","XQALSET",71,0)
 I XQNRECIP=0,'$$SNDNACTV(XQAID) S RETVAL=0,XQALERR="NO ACTIVE RECIPIENTS - OLDER TIU ALERTS"
"RTN","XQALSET",72,0)
 E  I XQNRECIP=0 D  I $D(XQA) S XQACOMNT=$E("None of recipients were active users. "_$G(XQACOMNT),1,245),XQNRECIP=1,XQARESET=1 K XQALIST G LOOP2 ; SET NUMBER OF RECIPIENTS TO 1 SO WE WON'T COME HERE AGAIN
"RTN","XQALSET",73,0)
 . N XQAA,XQJ F XQI=0:0 S XQI=$O(XQALIST(XQI)) Q:XQI'>0  D GETBKUP^XQALDEL(.XQAA,XQI) S XQALTYPE="BACKUP REVIEWER" F XQJ=0:0 S XQJ=$O(XQAA(XQJ)) Q:XQJ'>0  S XQA(XQAA(XQJ))=""
"RTN","XQALSET",74,0)
 . I $D(XQA) D CHEKACTV^XQALSET1(.XQA)
"RTN","XQALSET",75,0)
 . I '$D(XQA) S XQJ="G.XQAL UNPROCESSED ALERTS" D GROUP^XQALSET1 S XQALTYPE="UNPROCESSED ALERTS MAIL GROUP" ;D GETMLGRP(.XQA,XQI) ; COULDN'T FIND ANY BACKUP, GET A MAILGROUP AND MEMBERS TO SEND IT TO
"RTN","XQALSET",76,0)
 . I '$D(XQA) S XQJ="G.PATCHES" D GROUP^XQALSET1 S XQALTYPE="LAST HOPE" ; Last gasp, send it to G.PATCHES
"RTN","XQALSET",77,0)
 . I '$D(XQA) S XQJ="G.PATCH" D GROUP^XQALSET1 S XQALTYPE="LAST HOPE" ; Last gasp, send it to G.PATCH
"RTN","XQALSET",78,0)
 . I '$D(XQA) S RETVAL=0,XQALERR="Could not find any active user to send it to" ; Should not get here, this is only if all backups and mail groups tried don't have any active users
"RTN","XQALSET",79,0)
 . Q
"RTN","XQALSET",80,0)
 ; END OF JLI 030129 INSERTION P285
"RTN","XQALSET",81,0)
 ; moved recording of users in Alert Tracking file to here to include all of them  030220
"RTN","XQALSET",82,0)
 ; modified code to use FM calls instead of direct global references
"RTN","XQALSET",83,0)
 I RETVAL,$G(XQADA)'>0,XQAID'="" D SETTRACK ; moved to here to avoid tracking entries with no users
"RTN","XQALSET",84,0)
 ;
"RTN","XQALSET",85,0)
 I RETVAL,$G(XQADA)>0 L +^XTV(8992.1,XQADA):10 D  L -^XTV(8992.1,XQADA) ; 030131
"RTN","XQALSET",86,0)
 . F XQJ=0:0 S XQJ=$O(XQALIST1(XQJ)) Q:XQJ'>0  D
"RTN","XQALSET",87,0)
 . . N NCOUNT,SUBSCRPT,SUBSCRPN,KCNT,IENVAL
"RTN","XQALSET",88,0)
 . . S IENVAL=XQADA_",",KCNT=$$FIND1^DIC(8992.11,","_IENVAL,"Q",XQJ)
"RTN","XQALSET",89,0)
 . . S FDA=$NA(^TMP($J,"XQALSET")) K @FDA I KCNT=0 S @FDA@(8992.11,"+1,"_IENVAL,.01)=XQJ,KCNT="+1"
"RTN","XQALSET",90,0)
 . . S IENVAL=","_KCNT_","_IENVAL,NCOUNT=1 S SUBSCRPT="" F  S SUBSCRPT=$O(XQALIST1(XQJ,SUBSCRPT)) Q:SUBSCRPT=""  I $E(SUBSCRPT,1)'="z" D
"RTN","XQALSET",91,0)
 . . . S SUBSCRPN=$$FIND1^DIC(8992.2,"","X",SUBSCRPT) I SUBSCRPN'>0 D
"RTN","XQALSET",92,0)
 . . . . N FDA1,IENROOT S FDA1=$NA(^TMP($J,"XQALSET1")) K @FDA1 S @FDA1@(8992.2,"+1,",.01)=SUBSCRPT D UPDATE^DIE("",FDA1,"IENROOT") S SUBSCRPN=$G(IENROOT(1))
"RTN","XQALSET",93,0)
 . . . . Q
"RTN","XQALSET",94,0)
 . . . S NCOUNT=NCOUNT+1,@FDA@(8992.111,"+"_NCOUNT_IENVAL,.01)=SUBSCRPN,@FDA@(8992.111,"+"_NCOUNT_IENVAL,.04)=XQADATIM
"RTN","XQALSET",95,0)
 . . . Q
"RTN","XQALSET",96,0)
 . . I $D(XQALIST1(XQJ,"z TO_SURO")) S @FDA@(8992.111,"+"_NCOUNT_IENVAL,.02)=$O(XQALIST1(XQJ,"z TO_SURO",0))
"RTN","XQALSET",97,0)
 . . I $D(XQALIST1(XQJ,"z AS_SURO")) D
"RTN","XQALSET",98,0)
 . . . S @FDA@(8992.111,"+"_NCOUNT_IENVAL,.03)="Y"
"RTN","XQALSET",99,0)
 . . . N XQK S NCOUNT=NCOUNT+1 F XQK=0:0 S XQK=$O(XQALIST1(XQJ,"z AS_SURO",XQK)) Q:XQK'>0  S @FDA@(8992.113,"+"_NCOUNT_IENVAL,.01)=XQK,@FDA@(8992.113,"+"_NCOUNT_IENVAL,.02)=XQADATIM
"RTN","XQALSET",100,0)
 . . . Q
"RTN","XQALSET",101,0)
 . . S SUBSCRPT=$O(XQALIST1(XQJ,"")) I SUBSCRPT'["INITIAL" S SUBSCRPT=$P(SUBSCRPT,"-") D  ; FORWARDING
"RTN","XQALSET",102,0)
 . . . S SUBSCRPN=$$FIND1^DIC(8992.2,"","X",SUBSCRPT) I SUBSCRPN'>0 D
"RTN","XQALSET",103,0)
 . . . . N FDA1,IENROOT S FDA1=$NA(^TMP($J,"XQALSET1")) K @FDA1 S @FDA1@(8992.2,"+1,",.01)=SUBSCRPT D UPDATE^DIE("",FDA1,"IENROOT") S SUBSCRPN=$G(IENROOT(1))
"RTN","XQALSET",104,0)
 . . . . Q
"RTN","XQALSET",105,0)
 . . . S NCOUNT=NCOUNT+1,@FDA@(8992.112,"+"_NCOUNT_IENVAL,.01)=XQADATIM,@FDA@(8992.112,"+"_NCOUNT_IENVAL,.02)=SUBSCRPN I $G(XQACOMNT)'="" S @FDA@(8992.112,"+"_NCOUNT_IENVAL,1.01)=XQACOMNT
"RTN","XQALSET",106,0)
 . . . I $G(XQAUSER)>0 S @FDA@(8992.112,"+"_NCOUNT_IENVAL,.03)=XQAUSER
"RTN","XQALSET",107,0)
 . . . Q
"RTN","XQALSET",108,0)
 . . N IENSTR D UPDATE^DIE("",FDA,"IENSTR")
"RTN","XQALSET",109,0)
 . . Q
"RTN","XQALSET",110,0)
 . Q
"RTN","XQALSET",111,0)
 ;
"RTN","XQALSET",112,0)
 I RETVAL S RETVAL=RETVAL_U_$G(XQADA)_U_XQAID
"RTN","XQALSET",113,0)
 K:XQAID'="" ^XTV(8992,"AXQA",XQAID,0,0)
"RTN","XQALSET",114,0)
 K ^TMP("XQAGROUP",$J) ; P443 - clear global used to track processing of groups
"RTN","XQALSET",115,0)
 K XQA,XQALIN,XQALIN1,XQAMSG,XQAID,XQAFLG,XQAOPT,XQAOPT1,XQAROU,XQADATA,XQI,XQX,XQJ,XQK,XQA1,XQACTMSG,XQJ,XQXI,XQAARCH,XQACNDEL,XQAREVUE,XQASUPV,XQASURO,XQATEXT
"RTN","XQALSET",116,0)
 Q RETVAL
"RTN","XQALSET",117,0)
 ;
"RTN","XQALSET",118,0)
SNDNACTV(XQAID) ; Determine if we go ahead and send alerts addressed only to inactive users to backup reviewers
"RTN","XQALSET",119,0)
 N XVAL
"RTN","XQALSET",120,0)
 I $E(XQAID,1,3)="TIU" S XVAL=$E($P(XQAID,";"),4,99),XVAL=$$GET1^DIQ(8925,XVAL_",",1201,"I") I XVAL>0,$$FMDIFF^XLFDT(DT,XVAL)>60 Q 0
"RTN","XQALSET",121,0)
 Q 1
"RTN","XQALSET",122,0)
 ;
"RTN","XQALSET",123,0)
SETIEN(XQA1,XQI) ; determine unique XQAID value for alert
"RTN","XQALSET",124,0)
 N XQAID
"RTN","XQALSET",125,0)
 S:$G(XQA1)="" XQA1="NO-ID" F  S XQAID=XQA1_";"_DUZ_";"_XQI L +^XTV(8992,"AXQA",XQAID):10 D  L -^XTV(8992,"AXQA",XQAID) Q:XQI=""  S XQI=XQI+.00000001
"RTN","XQALSET",126,0)
 . I $D(^XTV(8992,"AXQA",XQAID)) Q
"RTN","XQALSET",127,0)
 . S ^XTV(8992,"AXQA",XQAID,0,0)="",XQI=""
"RTN","XQALSET",128,0)
 . Q
"RTN","XQALSET",129,0)
 Q XQAID
"RTN","XQALSET",130,0)
 ;
"RTN","XQALSET",131,0)
SETTRACK ; Setup entry in Alert Tracking file
"RTN","XQALSET",132,0)
 ; Note: if there are error messages or we can't create an entry for some reason, it simply returns and continues
"RTN","XQALSET",133,0)
 N FDA,IENS,XQA2,DIERR
"RTN","XQALSET",134,0)
 S XQADA=0
"RTN","XQALSET",135,0)
 S XQA2=XQA1 I XQA2[",",$P(XQA2,",",3)'="" S XQA2=$P(XQA2,",")_","_$P(XQA2,",",3)
"RTN","XQALSET",136,0)
 F  D  Q:'$D(DIERR)  Q:'$D(^TMP("DIERR",$J,"E",111))
"RTN","XQALSET",137,0)
 . K DIERR,^TMP("DIERR",$J)
"RTN","XQALSET",138,0)
 . S FDA=$NA(^TMP($J,"XQALSET")) K @FDA
"RTN","XQALSET",139,0)
 . S @FDA@(8992.1,"+1,",.01)=XQAID D UPDATE^DIE("",FDA,"IENS")
"RTN","XQALSET",140,0)
 . K @FDA
"RTN","XQALSET",141,0)
 . Q
"RTN","XQALSET",142,0)
 I $D(DIERR) Q  ;S XQDIERR1=DIERR M XQDIERR=^TMP("DIERR",$J) Q
"RTN","XQALSET",143,0)
 Q:IENS(1)'>0  S (DA,XQADA)=IENS(1)
"RTN","XQALSET",144,0)
 S IENS=IENS(1)_",",@FDA@(8992.1,IENS,.02)=XQX,^(.03)=XQA2,^(.05)=DUZ,^(1.01)=XQAMSG
"RTN","XQALSET",145,0)
 I $D(XQAARCH) S X=$$FMADD^XLFDT(DT,XQAARCH) I X>DT S @FDA@(8992.1,IENS,.08)=X
"RTN","XQALSET",146,0)
 I $P(XQA1,",")="OR",$P(XQA1,",",2)>0 S @FDA@(8992.1,IENS,.04)=$P(XQA1,",",2)
"RTN","XQALSET",147,0)
 I $D(ZTQUEUED) S @FDA@(8992.1,IENS,.06)=1
"RTN","XQALSET",148,0)
 I $D(XQAOPT)#2 S @FDA@(8992.1,IENS,1.02)=XQAOPT
"RTN","XQALSET",149,0)
 I $D(XQAROU)#2 N XQAXX S XQAXX=$S(XQAROU[U:XQAROU,1:U_XQAROU) I $P(XQAXX,U,2)'="" S:$P(XQAXX,U)'="" @FDA@(8992.1,IENS,1.03)=$P(XQAXX,U) S @FDA@(8992.1,IENS,1.04)=$P(XQAXX,U,2)
"RTN","XQALSET",150,0)
 I $D(XQACTMSG) S @FDA@(8992.1,IENS,1.05)=XQACTMSG
"RTN","XQALSET",151,0)
 I $D(XQADATA) S @FDA@(8992.1,IENS,2)=XQADATA
"RTN","XQALSET",152,0)
 I $D(XQAGUID) S @FDA@(8992.1,IENS,3.01)=XQAGUID
"RTN","XQALSET",153,0)
 I $D(XQADFN) S @FDA@(8992.1,IENS,.04)=XQADFN
"RTN","XQALSET",154,0)
 D FILE^DIE("KS",FDA)
"RTN","XQALSET",155,0)
 I $D(XQATEXT) D WP^DIE(8992.1,IENS,4,"","XQATEXT")
"RTN","XQALSET",156,0)
 Q
"RTN","XQALSET",157,0)
 ;
"RTN","XQALSET",158,0)
CHEKUSER(XQAUSER) ; .SR Returns 0 if no valid user or surrogate, otherwise returns IEN of user or surrogate
"RTN","XQALSET",159,0)
 Q $$CHEKUSER^XQALSET1(XQAUSER)
"RTN","XQALSET",160,0)
 ;
"RTN","XQALSUR1")
0^7^B72344647^B64901704
"RTN","XQALSUR1",1,0)
XQALSUR1 ;ISC-SF.SEA/JLI - SURROGATES FOR ALERTS ;10/23/12  12:12
"RTN","XQALSUR1",2,0)
 ;;8.0;KERNEL;**366,443,602**;Jul 10, 1995;Build 9
"RTN","XQALSUR1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALSUR1",4,0)
 Q
"RTN","XQALSUR1",5,0)
RETURN(XQAUSER) ; P366 - return alerts to the user
"RTN","XQALSUR1",6,0)
 N XQAI,X0,XQASTRT,XQASURO,XQAEND
"RTN","XQALSUR1",7,0)
 ; identify periods in the surrogate multiple that haven't been returned
"RTN","XQALSUR1",8,0)
 F XQAI=0:0 S XQAI=$O(^XTV(8992,XQAUSER,2,"AC",1,XQAI)) Q:XQAI'>0  S X0=^XTV(8992,XQAUSER,2,XQAI,0) I $P(X0,U,4)=1 D
"RTN","XQALSUR1",9,0)
 . S XQASTRT=$P(X0,U) S XQAEND=$P(X0,U,3)
"RTN","XQALSUR1",10,0)
 . ; and clear the flag indicating we need to restore these alerts
"RTN","XQALSUR1",11,0)
 . N XQAFDA S XQAFDA(8992.02,XQAI_","_XQAUSER_",",.04)="@" D FILE^DIE("","XQAFDA")
"RTN","XQALSUR1",12,0)
 . ; restore alerts to intended user, remove from surrogate if completed (i.e., no other surrogates and not intended recipient)
"RTN","XQALSUR1",13,0)
 . D PUSHBACK(XQAUSER,XQASTRT,XQAEND)
"RTN","XQALSUR1",14,0)
 . Q
"RTN","XQALSUR1",15,0)
 Q
"RTN","XQALSUR1",16,0)
 ;
"RTN","XQALSUR1",17,0)
PUSHBACK(XQAUSER,XQASTRT,XQAEND) ; P366 - identify alerts in alert tracking file for return and return them
"RTN","XQALSUR1",18,0)
 N XQAINIT,XQAI,X0,X30,XNOSURO,XQADT,XQAJ,XQAK,XQAL,XQAOTH,XQASUROP
"RTN","XQALSUR1",19,0)
 S XQAINIT=$$FIND1^DIC(8992.2,,"X","INITIAL RECIPIENT")
"RTN","XQALSUR1",20,0)
 F XQADT=XQASTRT-.0000001:0 S XQADT=$O(^XTV(8992.1,"AUD",XQAUSER,XQADT)) Q:XQADT'>0  Q:XQADT>XQAEND  F XQAI=0:0 S XQAI=$O(^XTV(8992.1,"AUD",XQAUSER,XQADT,XQAI)) Q:XQAI'>0  D
"RTN","XQALSUR1",21,0)
 . S XQAJ=$O(^XTV(8992.1,XQAI,20,"B",XQAUSER,0)) Q:XQAJ'>0
"RTN","XQALSUR1",22,0)
 . N XSURO,XNOSURO,XQAID S XNOSURO=0,XQAID=$P(^XTV(8992.1,XQAI,0),U)
"RTN","XQALSUR1",23,0)
 . F XQAK=0:0 S XQAK=$O(^XTV(8992.1,XQAI,20,XQAJ,1,"B",XQAK)) Q:XQAK'>0  F XQAL=0:0 S XQAL=$O(^XTV(8992.1,XQAI,20,XQAJ,1,"B",XQAK,XQAL)) Q:XQAL'>0  D
"RTN","XQALSUR1",24,0)
 . . S X0=^XTV(8992.1,XQAI,20,XQAJ,1,XQAL,0) S:$P(X0,U,2)>0 XSURO($P(X0,U,2))="" S:$P(X0,U,2)'>0 XNOSURO=1 ; sent to XSURO as surrogate
"RTN","XQALSUR1",25,0)
 . . Q
"RTN","XQALSUR1",26,0)
 . I 'XNOSURO D
"RTN","XQALSUR1",27,0)
 . . N XQA,XQACMNT,XQALTYPE
"RTN","XQALSUR1",28,0)
 . . S XQA(XQAUSER)="",XQACMNT="RESTORED FROM SURROGATE",XQALTYPE="RESTORE FROM SURROGATE"
"RTN","XQALSUR1",29,0)
 . . N XQAUSER,XQAI S XQAUSER=$O(^XTV(8992,"AXQA",XQAID,0)) Q:XQAUSER'>0  D RESETUP^XQALFWD(XQAID,.XQA,XQACMNT)
"RTN","XQALSUR1",30,0)
 . . Q
"RTN","XQALSUR1",31,0)
 . ; walk through each of those it was sent to as a surrogate for XQAUSER
"RTN","XQALSUR1",32,0)
 . F XQASUROP=0:0 S XQASUROP=$O(XSURO(XQASUROP)) Q:XQASUROP'>0  S XQAJ=$O(^XTV(8992.1,XQAI,20,"B",XQASUROP,0)) D
"RTN","XQALSUR1",33,0)
 . . ; and identify each time they were considered a recipient of the alert
"RTN","XQALSUR1",34,0)
 . . S XNOSURO=0 F XQAK=0:0 Q:XNOSURO  S XQAK=$O(^XTV(8992.1,XQAI,20,XQAJ,1,"B",XQAK)) Q:XQAK'>0  F XQAL=0:0 S XQAL=$O(^XTV(8992.1,XQAI,20,XQAJ,1,"B",XQAK,XQAL)) Q:XQAL'>0  S X0=^XTV(8992.1,XQAI,20,XQAJ,1,XQAL,0) D  Q:XNOSURO
"RTN","XQALSUR1",35,0)
 . . . I $P(X0,U,3)'="Y" S XNOSURO=1 Q  ; this one got it directly as a recipient as well
"RTN","XQALSUR1",36,0)
 . . . ; walk through the SURROGATE FOR entries for this user
"RTN","XQALSUR1",37,0)
 . . . F XQAOTH=0:0 S XQAOTH=$O(^XTV(8992.1,XQAI,20,XQAJ,3,XQAOTH)) Q:XQAOTH'>0  S X30=^(XQAOTH,0) D  Q:XNOSURO
"RTN","XQALSUR1",38,0)
 . . . . I +X30=XQAUSER S $P(^XTV(8992.1,XQAI,20,XQAJ,3,XQAOTH,0),U,3)=$$NOW^XLFDT() Q  ; mark this user as returned
"RTN","XQALSUR1",39,0)
 . . . . I $P(X30,U,3)'>0 S XNOSURO=1 Q  ; another surrogate hasn't been returned yet, so leave the alert
"RTN","XQALSUR1",40,0)
 . . . . Q
"RTN","XQALSUR1",41,0)
 . . . Q
"RTN","XQALSUR1",42,0)
 . . I 'XNOSURO D
"RTN","XQALSUR1",43,0)
 . . . N XQAKILL,XQAUSER,XQAI S XQAKILL=1,XQAUSER=XQASUROP D DELETE^XQALDEL
"RTN","XQALSUR1",44,0)
 . . . Q
"RTN","XQALSUR1",45,0)
 . . Q
"RTN","XQALSUR1",46,0)
 . Q
"RTN","XQALSUR1",47,0)
 Q
"RTN","XQALSUR1",48,0)
 ;
"RTN","XQALSUR1",49,0)
SUROLIST(XQAUSER,XQALIST) ; returns for XQAUSER a list of current and/or future surrogates in XQALIST
"RTN","XQALSUR1",50,0)
 ;  usage  D SUROLIST^XQALSUR1(DUZ,.XQALIST)
"RTN","XQALSUR1",51,0)
 ;
"RTN","XQALSUR1",52,0)
 ;  returns  XQALIST=count
"RTN","XQALSUR1",53,0)
 ;           XQALIST(1)=IEN2^NEWPERSON,USER2^STARTDATETIME^ENDDATETIME
"RTN","XQALSUR1",54,0)
 ;           XQALIST(2)=3^NAME,USER3^3050407.1227^3050406
"RTN","XQALSUR1",55,0)
 ;
"RTN","XQALSUR1",56,0)
 N XQA0,XQADATE,XQAIEN,XQAL,XQALCNT,XQALEND,XQANOW,XQASTART,XQASURO,XQAVALU
"RTN","XQALSUR1",57,0)
 D CHEKSUBS^XQALSUR2(XQAUSER)
"RTN","XQALSUR1",58,0)
 S XQALCNT=$$CURRSURO^XQALSURO(XQAUSER)
"RTN","XQALSUR1",59,0)
 S XQANOW=$$NOW^XLFDT(),XQALCNT=0
"RTN","XQALSUR1",60,0)
 S XQADATE="" F  S XQADATE=$O(^XTV(8992,XQAUSER,2,"B",XQADATE)) Q:XQADATE'>0  S XQAIEN="" F  S XQAIEN=$O(^XTV(8992,XQAUSER,2,"B",XQADATE,XQAIEN)) Q:XQAIEN'>0  D
"RTN","XQALSUR1",61,0)
 . S XQA0=^XTV(8992,XQAUSER,2,XQAIEN,0),XQASTART=$P(XQA0,U),XQASURO=$P(XQA0,U,2),XQALEND=$P(XQA0,U,3) I XQALEND>0,XQALEND'>XQANOW Q
"RTN","XQALSUR1",62,0)
 . S XQALCNT=XQALCNT+1,XQAVALU=$$GET1^DIQ(200,XQASURO_",",.01),XQAL(XQALCNT)=XQASURO_U_XQAVALU_U_XQASTART_U_XQALEND
"RTN","XQALSUR1",63,0)
 . Q
"RTN","XQALSUR1",64,0)
 ; now rearrange by earliest to last
"RTN","XQALSUR1",65,0)
 K XQALIST S XQALIST=0
"RTN","XQALSUR1",66,0)
 S XQALCNT="" F  S XQALCNT=$O(XQAL(XQALCNT)) Q:XQALCNT'>0  D
"RTN","XQALSUR1",67,0)
 . ; if end date not specified, and start date follows, set end date to next start date
"RTN","XQALSUR1",68,0)
 . I $D(XQAL(XQALCNT+1)),($P(XQAL(XQALCNT),U,4)>$P(XQAL(XQALCNT+1),U,3))!($P(XQAL(XQALCNT),U,4)'>0) S $P(XQAL(XQALCNT),U,4)=$P(XQAL(XQALCNT+1),U,3)
"RTN","XQALSUR1",69,0)
 . S XQALIST=XQALIST+1,XQALIST(XQALIST)=XQAL(XQALCNT)
"RTN","XQALSUR1",70,0)
 . Q
"RTN","XQALSUR1",71,0)
 Q
"RTN","XQALSUR1",72,0)
 ;
"RTN","XQALSUR1",73,0)
DCYCLIC(XQALSURO,XQAUSER,XQALSTRT,XQALEND) ; code added to prevent cyclical surrogates - use dates for surrogacy
"RTN","XQALSUR1",74,0)
 N XQALNEXT,XQALIST,I,XQALAST
"RTN","XQALSUR1",75,0)
 I XQALSURO=XQAUSER Q "This forms a circle which leads back to this user during this period - can't do it!"
"RTN","XQALSUR1",76,0)
 S XQALNEXT=$$CURRSURO^XQALSURO(XQALSURO,XQALSTRT,XQALEND) I XQALNEXT>0 D
"RTN","XQALSUR1",77,0)
 . F I=1:1 Q:$P(XQALNEXT,U,I)=""  S XQALAST=$$DCYCLIC($P(XQALNEXT,U,I),XQAUSER,XQALSTRT,XQALEND) I XQALAST'>0 S XQALSURO=XQALAST Q
"RTN","XQALSUR1",78,0)
 . Q
"RTN","XQALSUR1",79,0)
 Q XQALSURO
"RTN","XQALSUR1",80,0)
 ;
"RTN","XQALSUR1",81,0)
DATESURO(XQAUSER,XQALSTRT,XQALEND) ; returns surrogate(s) for XQAUSER in date range XQALSTRT to XQALEND, may be multiple values ^-separated
"RTN","XQALSUR1",82,0)
 N XQALY,XQA0,XQALIEN,XQALS
"RTN","XQALSUR1",83,0)
 S XQALY="" I XQALEND'>0 S XQALEND=4000101
"RTN","XQALSUR1",84,0)
 F XQALS=0:0 S XQALS=$O(^XTV(8992,XQAUSER,2,"B",XQALS)) Q:XQALS'>0  Q:XQALS'<XQALEND  D
"RTN","XQALSUR1",85,0)
 . F XQALIEN=0:0 S XQALIEN=$O(^XTV(8992,XQAUSER,2,"B",XQALS,XQALIEN)) Q:XQALIEN'>0  S XQA0=^XTV(8992,XQAUSER,2,XQALIEN,0) Q:$P(XQA0,U,3)'>XQALSTRT  S XQALY=XQALY_$S(XQALY="":"",1:U)_$P(XQA0,U,2)
"RTN","XQALSUR1",86,0)
 . Q
"RTN","XQALSUR1",87,0)
 Q XQALY
"RTN","XQALSUR1",88,0)
 ;
"RTN","XQALSUR1",89,0)
SURRO1(XQAUSER) ;
"RTN","XQALSUR1",90,0)
 N XQALSURO,XQALSTRT,XQALEND
"RTN","XQALSUR1",91,0)
 D CHKREMV^XQALSURO
"RTN","XQALSUR1",92,0)
SURRO11 ;
"RTN","XQALSUR1",93,0)
 S XQALSURO=$$NEWDLG() I XQALSURO'>0 Q
"RTN","XQALSUR1",94,0)
 I $$CYCLIC^XQALSURO(XQALSURO,XQAUSER)'>0 W $C(7),!,$$CYCLIC^XQALSURO(XQALSURO,XQAUSER),! G SURRO11
"RTN","XQALSUR1",95,0)
 S XQALSTRT=+$$STRTDLG() I XQALSTRT<0 Q
"RTN","XQALSUR1",96,0)
 S XQALEND=+$$ENDDLG() I XQALEND<0 Q
"RTN","XQALSUR1",97,0)
 ; p602 check again for cyclical surrogates
"RTN","XQALSUR1",98,0)
 I $$DCYCLIC(XQALSURO,XQAUSER,XQALSTRT,XQALEND)'>0 W $C(7),!,$$DCYCLIC(XQALSURO,XQAUSER,XQALSTRT,XQALEND),! G SURRO11
"RTN","XQALSUR1",99,0)
 D SETSURO^XQALSURO(XQAUSER,XQALSURO,XQALSTRT,XQALEND)
"RTN","XQALSUR1",100,0)
 G SURRO11 ;
"RTN","XQALSUR1",101,0)
 Q
"RTN","XQALSUR1",102,0)
 ;
"RTN","XQALSUR1",103,0)
 ; P366 - added OPTIONAL second and third arguments to permit deletion of a specific pending surrogate and start date
"RTN","XQALSUR1",104,0)
REMVSURO(XQAUSER,XQALSURO,XQALSTRT) ; SR - ends the currently active surrogate relationship
"RTN","XQALSUR1",105,0)
 I $G(XQAUSER)'>0 Q
"RTN","XQALSUR1",106,0)
 S XQALSURO=$G(XQALSURO),XQALSTRT=$G(XQALSTRT)
"RTN","XQALSUR1",107,0)
 N XQALFM,XQALXREF,XQALSTR1,XQALSUR1,XQALNOW,XQALEND,XQA0
"RTN","XQALSUR1",108,0)
 D CHEKSUBS^XQALSUR2(XQAUSER)
"RTN","XQALSUR1",109,0)
 S XQALSUR1=+$P($G(^XTV(8992,XQAUSER,0)),U,2) S:XQALSURO'>0 XQALSURO=XQALSUR1
"RTN","XQALSUR1",110,0)
 S XQALSTR1=$P($G(^XTV(8992,XQAUSER,0)),U,3) S:XQALSTRT'>0 XQALSTRT=XQALSTR1
"RTN","XQALSUR1",111,0)
 S XQALEND=$P($G(^XTV(8992,XQAUSER,0)),U,4)
"RTN","XQALSUR1",112,0)
 S XQALXREF=0 I XQALSTRT>0 F  S XQALXREF=$O(^XTV(8992,XQAUSER,2,"B",XQALSTRT,XQALXREF)) Q:XQALXREF'>0  I $P(^XTV(8992,XQAUSER,2,XQALXREF,0),U,2)=XQALSURO D
"RTN","XQALSUR1",113,0)
 . S XQALEND=$P(^XTV(8992,XQAUSER,2,XQALXREF,0),U,3) D DELETENT(XQAUSER,XQALXREF,XQALSURO,XQALSTRT,XQALSUR1,XQALSTR1,XQALEND)
"RTN","XQALSUR1",114,0)
 . Q
"RTN","XQALSUR1",115,0)
 S XQALSURO=$$CURRSURO^XQALSURO(XQAUSER) ; make sure current surrogate is updated if necessary.
"RTN","XQALSUR1",116,0)
 D CLEANUP^XQALSUR2(XQAUSER) ;p602 clean up surrogate history (moved from SR. RETURN)
"RTN","XQALSUR1",117,0)
 Q
"RTN","XQALSUR1",118,0)
 ;
"RTN","XQALSUR1",119,0)
DELETENT(XQAUSER,XQALXREF,XQALSURO,XQALSTRT,XQALSUR1,XQALSTR1,XQALEND) ;
"RTN","XQALSUR1",120,0)
 N XQALNOW,XQALFM
"RTN","XQALSUR1",121,0)
 S XQAUSER=XQAUSER_",",XQALXREF=XQALXREF_","_XQAUSER
"RTN","XQALSUR1",122,0)
 I XQALXREF>0 D
"RTN","XQALSUR1",123,0)
 . S XQALNOW=$$NOW^XLFDT()
"RTN","XQALSUR1",124,0)
 . I XQALSTRT>XQALNOW S XQALFM(8992.02,XQALXREF,.01)=XQALNOW ; if scheduled for later, mark start as now
"RTN","XQALSUR1",125,0)
 . I (XQALEND>XQALNOW)!(XQALEND'>0) S XQALFM(8992.02,XQALXREF,.03)=XQALNOW ; update end time for surrogate to now
"RTN","XQALSUR1",126,0)
 . I XQALSTRT'>XQALNOW S XQALFM(8992.02,XQALXREF,.04)=1
"RTN","XQALSUR1",127,0)
 . Q
"RTN","XQALSUR1",128,0)
 I XQALSUR1=XQALSURO,XQALSTRT=XQALSTR1 D
"RTN","XQALSUR1",129,0)
 . S XQALFM(8992,XQAUSER,.02)="@"
"RTN","XQALSUR1",130,0)
 . S XQALFM(8992,XQAUSER,.03)="@"
"RTN","XQALSUR1",131,0)
 . S XQALFM(8992,XQAUSER,.04)="@"
"RTN","XQALSUR1",132,0)
 . Q
"RTN","XQALSUR1",133,0)
 I $D(XQALFM) D FILE^DIE("","XQALFM")
"RTN","XQALSUR1",134,0)
 ; ZEXCEPT: XTMUNIT   (EXTERNAL VALUE - INDICATING UNIT TEST BEING RUN)
"RTN","XQALSUR1",135,0)
 I XQALSURO>0,'$D(XTMUNIT) D
"RTN","XQALSUR1",136,0)
 . N XQAMESG,XMSUB,XMTEXT
"RTN","XQALSUR1",137,0)
 . S XQAMESG(1,0)="You have been REMOVED as a surrogate recipient for alerts for"
"RTN","XQALSUR1",138,0)
 . S XQAMESG(2,0)=$$GET1^DIQ(200,XQAUSER,.01,"E")_" (IEN="_$P(XQAUSER,",")_")."
"RTN","XQALSUR1",139,0)
 . S XMTEXT="XQAMESG(",XMSUB="Removal as surrogate recipient"
"RTN","XQALSUR1",140,0)
 . D SENDMESG^XQALSURO
"RTN","XQALSUR1",141,0)
 . Q
"RTN","XQALSUR1",142,0)
 Q
"RTN","XQALSUR1",143,0)
 ;
"RTN","XQALSUR1",144,0)
NEWDLG() ; new surrogate dialog
"RTN","XQALSUR1",145,0)
 N DIR,Y S DIR(0)="Y",DIR("A")="Do you want to SET a new surrogate recipient",DIR("?")="A surrogate will receive your alerts until they are removed as surrogate.",DIR("B")="NO"
"RTN","XQALSUR1",146,0)
 S Y=$$ASKDIR(.DIR) I 'Y Q 0
"RTN","XQALSUR1",147,0)
 ;
"RTN","XQALSUR1",148,0)
 S DIR(0)="P^200:AEMQ",DIR("A")="Select USER to be SURROGATE" S Y=$$ASKDIR(.DIR)  ; COS-0401-41366
"RTN","XQALSUR1",149,0)
 I Y>0 W "  ",$P(Y,U,2)
"RTN","XQALSUR1",150,0)
 Q +Y
"RTN","XQALSUR1",151,0)
 ;
"RTN","XQALSUR1",152,0)
STRTDLG() ; new surrogate start date/time dialog
"RTN","XQALSUR1",153,0)
 N DIR
"RTN","XQALSUR1",154,0)
 S DIR(0)="DO^NOW::AEFRX",DIR("A")="Enter Date/Time SURROGATE is to start" ; BRX-1000-10427
"RTN","XQALSUR1",155,0)
 S DIR("A",1)="",DIR("A",2)=""
"RTN","XQALSUR1",156,0)
 S DIR("A",3)=" - If no date/time is entered, new alerts will start going to"
"RTN","XQALSUR1",157,0)
 S DIR("A",4)="   the SURROGATE immediately."
"RTN","XQALSUR1",158,0)
 S DIR("A",5)=" - A past date/time (earlier than NOW) is not permitted."
"RTN","XQALSUR1",159,0)
 S DIR("A",6)=" - If a date is entered, then a time is also required."
"RTN","XQALSUR1",160,0)
 S DIR("A",7)=""
"RTN","XQALSUR1",161,0)
 Q +$$ASKDIR(.DIR)
"RTN","XQALSUR1",162,0)
 ;
"RTN","XQALSUR1",163,0)
ENDDLG() ; new surrogate end date/time dialog
"RTN","XQALSUR1",164,0)
 N DIR
"RTN","XQALSUR1",165,0)
 S DIR(0)="DO^NOW::AEFRX",DIR("A")="Enter Date/Time SURROGATE is to end" ; BRX-1000-10427
"RTN","XQALSUR1",166,0)
 S DIR("A",1)="",DIR("A",2)=""
"RTN","XQALSUR1",167,0)
 S DIR("A",3)=" - If no date/time is entered, YOU must remove the SURROGATE"
"RTN","XQALSUR1",168,0)
 S DIR("A",4)="   to terminate the surrogacy."
"RTN","XQALSUR1",169,0)
 S DIR("A",5)=" - A past date/time (earlier than NOW) is not permitted."
"RTN","XQALSUR1",170,0)
 S DIR("A",6)=" - If a date is entered, then a time is also required."
"RTN","XQALSUR1",171,0)
 S DIR("A",7)=""
"RTN","XQALSUR1",172,0)
 Q +$$ASKDIR(.DIR)
"RTN","XQALSUR1",173,0)
 ;
"RTN","XQALSUR1",174,0)
ASKDIR(DIR) ;
"RTN","XQALSUR1",175,0)
 N Y,DTOUT,DUOUT
"RTN","XQALSUR1",176,0)
 D ^DIR K DIR I $D(DTOUT)!$D(DUOUT) S Y=-1
"RTN","XQALSUR1",177,0)
 Q Y
"RTN","XQALSUR2")
0^8^B5665797^B3811185
"RTN","XQALSUR2",1,0)
XQALSUR2 ;FO-OAK.SEA/JLI-Continuation of alert surrogate processing ;07/12/12  11:30
"RTN","XQALSUR2",2,0)
 ;;8.0;KERNEL;**366,513,602**;Jul 10, 1995;Build 9
"RTN","XQALSUR2",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALSUR2",4,0)
 Q
"RTN","XQALSUR2",5,0)
 ; added to handle adjustment for manual or Fileman editing of surrogate on top zero node
"RTN","XQALSUR2",6,0)
CHEKSUBS(XQAUSER) ;
"RTN","XQALSUR2",7,0)
 N XQA0,XQASTR1,XQANOW,XQB0,XQB1
"RTN","XQALSUR2",8,0)
 S XQANOW=$$NOW^XLFDT()
"RTN","XQALSUR2",9,0)
 S XQA0=$G(^XTV(8992,XQAUSER,0)) I $P(XQA0,U,2)>0 D
"RTN","XQALSUR2",10,0)
 . N XQAFDA,XQAIEN,XQADA
"RTN","XQALSUR2",11,0)
 . S XQASTR1=$P(XQA0,U,3) S:XQASTR1'>0 XQASTR1=XQANOW,XQAFDA(8992,XQAUSER_",",.03)=XQASTR1 D
"RTN","XQALSUR2",12,0)
 . . S XQADA=0 F  S XQADA=$O(^XTV(8992,XQAUSER,2,"B",XQASTR1,XQADA)) Q:XQADA'>0  Q:$P(^XTV(8992,XQAUSER,2,XQADA,0),U,2)=$P(XQA0,U,2)
"RTN","XQALSUR2",13,0)
 . . S XQAIEN=$S(XQADA>0:XQADA,1:"+1")_","_XQAUSER_"," S XQAFDA(8992.02,XQAIEN,.01)=XQASTR1
"RTN","XQALSUR2",14,0)
 . . S XQAFDA(8992.02,XQAIEN,.02)=$P(XQA0,U,2) S:$P(XQA0,U,4)>0 XQAFDA(8992.02,XQAIEN,.03)=$P(XQA0,U,4)
"RTN","XQALSUR2",15,0)
 . . D:XQADA'>0 UPDATE^DIE("","XQAFDA")
"RTN","XQALSUR2",16,0)
 . . D:XQADA>0 FILE^DIE("","XQAFDA")
"RTN","XQALSUR2",17,0)
 . . Q
"RTN","XQALSUR2",18,0)
 . Q
"RTN","XQALSUR2",19,0)
 Q
"RTN","XQALSUR2",20,0)
 ;
"RTN","XQALSUR2",21,0)
CHKCRIT(ZERONODE) ;EXTRINSIC - check for critical indication for alert
"RTN","XQALSUR2",22,0)
 ; ZERONODE - input - Value for zero node for alert data
"RTN","XQALSUR2",23,0)
 ; RETURN VALUE - 1 if the alert is indicated as critical
"RTN","XQALSUR2",24,0)
 ;                0 otherwise
"RTN","XQALSUR2",25,0)
 N RESULT,IEN
"RTN","XQALSUR2",26,0)
 S RESULT=0
"RTN","XQALSUR2",27,0)
 F IEN=0:0 S IEN=$O(^XTV(8992.3,IEN)) Q:IEN'>0  D  Q:RESULT
"RTN","XQALSUR2",28,0)
 . N IENS,RES,MSG,CRITTEXT,PKGID,ALERTTXT
"RTN","XQALSUR2",29,0)
 . S IENS=IEN_","
"RTN","XQALSUR2",30,0)
 . D GETS^DIQ(8992.3,IENS,".01:.02",,"RES","MSG")
"RTN","XQALSUR2",31,0)
 . S CRITTEXT=$$UP^XLFSTR(RES(8992.3,IENS,.01)),PKGID=$$UP^XLFSTR(RES(8992.3,IENS,.02))
"RTN","XQALSUR2",32,0)
 . I PKGID'="",$$UP^XLFSTR($P(ZERONODE,U,2))'[PKGID Q
"RTN","XQALSUR2",33,0)
 . S ALERTTXT=$$UP^XLFSTR($P(ZERONODE,U,3))
"RTN","XQALSUR2",34,0)
 . I ALERTTXT[CRITTEXT,ALERTTXT'["NOT "_CRITTEXT S RESULT=1
"RTN","XQALSUR2",35,0)
 Q RESULT
"RTN","XQALSUR2",36,0)
CLEANUP(XQAUSER) ;SR. - clean up expired surrogate info
"RTN","XQALSUR2",37,0)
 N XQAI,XQANOW,XQASUR
"RTN","XQALSUR2",38,0)
 S XQANOW=$$NOW^XLFDT()
"RTN","XQALSUR2",39,0)
 I $P($G(^XTV(8992,XQAUSER,2,0)),U,2)>0 D
"RTN","XQALSUR2",40,0)
 . S XQAI=0 F  S XQAI=$O(^XTV(8992,XQAUSER,2,XQAI)) Q:XQAI'>0  D
"RTN","XQALSUR2",41,0)
 . . S XQASUR=$G(^XTV(8992,XQAUSER,2,XQAI,0))
"RTN","XQALSUR2",42,0)
 . . I ($P(XQASUR,U)<XQANOW)&($P(XQASUR,U,4)'=1)&($P(XQASUR,U,3)<XQANOW)&($P(XQASUR,U,3)>0) D
"RTN","XQALSUR2",43,0)
 . . . N XQAIEN S XQAIEN=XQAI_","_XQAUSER_","
"RTN","XQALSUR2",44,0)
 . . . N XQAFDA S XQAFDA(8992.02,XQAIEN,.01)="@" D FILE^DIE("","XQAFDA")
"RTN","XQALSUR2",45,0)
 Q
"RTN","XQALSURO")
0^1^B93224133^B90015726
"RTN","XQALSURO",1,0)
XQALSURO ;ISC-SF.SEA/JLI,ISD/HGW - SURROGATES FOR ALERTS ;07/24/12  10:24
"RTN","XQALSURO",2,0)
 ;;8.0;KERNEL;**114,125,173,285,366,443,513,602**;Jul 10, 1995;Build 9
"RTN","XQALSURO",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQALSURO",4,0)
 Q
"RTN","XQALSURO",5,0)
OTHRSURO ; OPT:- XQALERT SURROGATE SET/REMOVE -- OTHERS SPECIFY SURROGATE FOR SELECTED USER
"RTN","XQALSURO",6,0)
 N XQAUSER,DIR,Y
"RTN","XQALSURO",7,0)
 S DIR(0)="PD^200:AEMQ",DIR("A",1)="SURROGATE related to which"
"RTN","XQALSURO",8,0)
 S DIR("A")="NEW PERSON entry"
"RTN","XQALSURO",9,0)
 D ^DIR K DIR Q:Y'>0  W "  ",$P(Y,U,2)
"RTN","XQALSURO",10,0)
 S XQAUSER=+Y
"RTN","XQALSURO",11,0)
 G SURROGAT
"RTN","XQALSURO",12,0)
 Q
"RTN","XQALSURO",13,0)
 ;
"RTN","XQALSURO",14,0)
SURROGAT ; USER SPECIFICATION OF SURROGATE
"RTN","XQALSURO",15,0)
 I '$D(XQAUSER) N XQAUSER S XQAUSER=DUZ
"RTN","XQALSURO",16,0)
 D SURRO1^XQALSUR1(XQAUSER)
"RTN","XQALSURO",17,0)
 Q
"RTN","XQALSURO",18,0)
 ;
"RTN","XQALSURO",19,0)
CYCLIC(XQALSURO,XQAUSER,XQASTRT,XQAEND) ; code added to prevent cyclical surrogates
"RTN","XQALSURO",20,0)
 I '$$ACTIVE^XUSER(XQALSURO) Q "You cannot have an INACTIVE USER ("_$$NAME^XUSER(XQALSURO,"F")_") as a surrogate!" ;P443
"RTN","XQALSURO",21,0)
 I XQALSURO=XQAUSER Q "You cannot specify yourself as your own surrogate!" ; moved in P443
"RTN","XQALSURO",22,0)
 I $G(XQASTRT)>0 Q $$DCYCLIC^XQALSUR1(XQALSURO,XQAUSER,XQASTRT,$G(XQAEND))
"RTN","XQALSURO",23,0)
 ;p602 in SURRO11^XQALSUR1 split the check for cyclical surrogates into two parts. The following code becomes unnecessary.
"RTN","XQALSURO",24,0)
 ;N XQALSTRT
"RTN","XQALSURO",25,0)
 ;S XQALSTRT=$$CURRSURO(XQALSURO) I XQALSTRT>0 D
"RTN","XQALSURO",26,0)
 ;. I XQALSTRT=XQAUSER S XQALSURO="YOU are designated as the surrogate for this user ("_XQALSURO_") - can't do it!" Q
"RTN","XQALSURO",27,0)
 ;. F  S XQALSTRT=$$CURRSURO(XQALSTRT) Q:XQALSTRT'>0  I XQALSTRT=XQAUSER S XQALSURO="This forms a circle which leads back to you - can't do it!" Q
"RTN","XQALSURO",28,0)
 ;. Q
"RTN","XQALSURO",29,0)
 Q XQALSURO
"RTN","XQALSURO",30,0)
 ;
"RTN","XQALSURO",31,0)
SETSURO(XQAUSER,XQALSURO,XQALSTRT,XQALEND) ; SR. ICR #2790 (Supported)
"RTN","XQALSURO",32,0)
 ; Use SETSURO1 instead
"RTN","XQALSURO",33,0)
 N XQALVAL ; P443
"RTN","XQALSURO",34,0)
 S XQALVAL=$$SETSURO1(XQAUSER,XQALSURO,$G(XQALSTRT),$G(XQALEND)) ; P443
"RTN","XQALSURO",35,0)
 Q
"RTN","XQALSURO",36,0)
 ;
"RTN","XQALSURO",37,0)
SETSUROX(XQAUSER,XQALSURO,XQALSTRT,XQALEND) ; SETSURO CODE MOVED TO HERE TO PERMIT AN ERROR TO BE GENERATED AT THE OLD ENTRY POINT
"RTN","XQALSURO",38,0)
 N XQALFM,XQALIEN,XQAIENS
"RTN","XQALSURO",39,0)
 I '$D(^XTV(8992,XQAUSER,0)) D
"RTN","XQALSURO",40,0)
 . N XQALFM,XQALFM1
"RTN","XQALSURO",41,0)
 . S XQALFM1(1)=XQAUSER
"RTN","XQALSURO",42,0)
 . S XQALFM(8992,"+1,",.01)=XQAUSER
"RTN","XQALSURO",43,0)
 . D UPDATE^DIE("","XQALFM","XQALFM1")
"RTN","XQALSURO",44,0)
 . Q
"RTN","XQALSURO",45,0)
 S XQAIENS=XQAUSER_","
"RTN","XQALSURO",46,0)
 ; P366 - force no start date/time to NOW, and anything less than NOW to NOW
"RTN","XQALSURO",47,0)
 I $G(XQALSTRT)<$$NOW^XLFDT() S XQALSTRT=$$NOW^XLFDT()
"RTN","XQALSURO",48,0)
 ; P366 - add values to new multiple
"RTN","XQALSURO",49,0)
 S XQALFM(8992.02,"+1,"_XQAIENS,.01)=XQALSTRT
"RTN","XQALSURO",50,0)
 S XQALFM(8992.02,"+1,"_XQAIENS,.02)=XQALSURO
"RTN","XQALSURO",51,0)
 I (XQALEND>0)&(XQALEND'>XQALSTRT) S XQALEND=$$FMADD^XLFDT(XQALSTRT,0,0,0,1) ;p602 force end date/time to be after start date/time
"RTN","XQALSURO",52,0)
 I XQALEND>0 S XQALFM(8992.02,"+1,"_XQAIENS,.03)=XQALEND
"RTN","XQALSURO",53,0)
 K XQALIEN D UPDATE^DIE("","XQALFM","XQALIEN")
"RTN","XQALSURO",54,0)
 ; P366 - if start date time is already in effect - place in old locations to make active
"RTN","XQALSURO",55,0)
 ;D ACTIVATE(XQAUSER,XQALIEN(1)) ; P513 activate if current or next
"RTN","XQALSURO",56,0)
 I XQALSTRT'>$$NOW^XLFDT() D ACTIVATE(XQAUSER,XQALIEN(1)) ; p602 activate only if current
"RTN","XQALSURO",57,0)
 N XQAMESG,XMSUB,XMTEXT
"RTN","XQALSURO",58,0)
 S XQAMESG(1,0)="You have been specified as a surrogate recipient for alerts for"
"RTN","XQALSURO",59,0)
 S XQAMESG(2,0)=$$GET1^DIQ(200,XQAIENS,.01,"E")_" (IEN="_XQAUSER_") effective "_$$FMTE^XLFDT(XQALSTRT)
"RTN","XQALSURO",60,0)
 I $G(XQALEND)'>0 S XQAMESG(2,0)=XQAMESG(2,0)_"."
"RTN","XQALSURO",61,0)
 E  S XQAMESG(3,0)="until "_$$FMTE^XLFDT(XQALEND)
"RTN","XQALSURO",62,0)
 S XMSUB="Surrogate Recipient for "_$$GET1^DIQ(200,XQAIENS,.01,"E")
"RTN","XQALSURO",63,0)
 S XMTEXT="XQAMESG("
"RTN","XQALSURO",64,0)
 ; ZEXCEPT: XTMUNIT   - Defined if unit tests are being run
"RTN","XQALSURO",65,0)
 D:'$D(XTMUNIT) SENDMESG
"RTN","XQALSURO",66,0)
 Q
"RTN","XQALSURO",67,0)
 ;
"RTN","XQALSURO",68,0)
ACTIVATE(XQAUSER,XQALIEN) ; activates a surrogate
"RTN","XQALSURO",69,0)
 N X0,XQALFM,XQALSURO,XQALSTRT,XQALEND
"RTN","XQALSURO",70,0)
 S X0=$G(^XTV(8992,XQAUSER,2,XQALIEN,0)) Q:X0=""  S XQALSTRT=$P(X0,U),XQALSURO=$P(X0,U,2),XQALEND=$P(X0,U,3)
"RTN","XQALSURO",71,0)
 S X0=^XTV(8992,XQAUSER,0)
"RTN","XQALSURO",72,0)
 I $P(X0,U,2)>0,$P(X0,U,3)'>$$NOW^XLFDT() D REMVSURO(XQAUSER) ; If we are activating a new surrogate, if one exists simply remove.
"RTN","XQALSURO",73,0)
 K XQALFM S XQALFM(8992,XQAUSER_",",.03)=XQALSTRT
"RTN","XQALSURO",74,0)
 S XQALFM(8992,XQAUSER_",",.02)=XQALSURO
"RTN","XQALSURO",75,0)
 S XQALFM(8992,XQAUSER_",",.04)=$S($G(XQALEND)>0:XQALEND,1:"@")
"RTN","XQALSURO",76,0)
 D FILE^DIE("","XQALFM")
"RTN","XQALSURO",77,0)
 Q
"RTN","XQALSURO",78,0)
 ;
"RTN","XQALSURO",79,0)
 ; usage $$SETSURO1(XQAUSER,XQALSURO,XQALSTRT,XQALEND)  returns 0 if invalid, otherwise > 0
"RTN","XQALSURO",80,0)
SETSURO1(XQAUSER,XQALSURO,XQALSTRT,XQALEND) ;EXTRINSIC. ICR #3213 (supported)
"RTN","XQALSURO",81,0)
 ; This should be used instead of SETSURO
"RTN","XQALSURO",82,0)
 I $G(XQAUSER)'>0 Q "Invalid Internal Entry Number for user ("_XQAUSER_")" ; P513 moved from SETSUROX+2
"RTN","XQALSURO",83,0)
 I $G(XQALSURO)'>0 Q "Invalid Internal Entry Number for surrogate ("_XQALSURO_")" ; P513 moved from SETSUROX+3
"RTN","XQALSURO",84,0)
 I $G(XQALSTRT)'>0 S XQALSTRT=$$NOW^XLFDT()
"RTN","XQALSURO",85,0)
 N XQAVAL
"RTN","XQALSURO",86,0)
 S XQAVAL=$$CYCLIC(XQALSURO,XQAUSER,XQALSTRT,$G(XQALEND)) I XQAVAL'>0 Q XQAVAL ; Can't use as surrogate
"RTN","XQALSURO",87,0)
 D SETSUROX(XQAUSER,XQALSURO,XQALSTRT,$G(XQALEND)) ; P443
"RTN","XQALSURO",88,0)
 Q XQALSURO
"RTN","XQALSURO",89,0)
 ;
"RTN","XQALSURO",90,0)
CHKREMV ;
"RTN","XQALSURO",91,0)
 N DIR,XQAI,XQASLIST,XQAVAL,YVAL,Y
"RTN","XQALSURO",92,0)
 ; ZEXCEPT: XQAUSER    (EXTERNAL VALUE)
"RTN","XQALSURO",93,0)
 D SUROLIST^XQALSUR1(XQAUSER,.XQASLIST)
"RTN","XQALSURO",94,0)
 W !,"Current Surrogate(s):",?35,"START DATE",?60,"END DATE"
"RTN","XQALSURO",95,0)
 F XQAI=0:0 S XQAI=$O(XQASLIST(XQAI)) Q:XQAI'>0  W !,XQAI,"  ",$P(XQASLIST(XQAI),U,2),?35,$$FMTE^XLFDT($P(XQASLIST(XQAI),U,3)),?60,$$FMTE^XLFDT($P(XQASLIST(XQAI),U,4))
"RTN","XQALSURO",96,0)
 W ! I XQASLIST'>0 W !,"  No current surrogates",! Q
"RTN","XQALSURO",97,0)
 S DIR(0)="Y",DIR("A")="Do you want to REMOVE "_$S(XQASLIST>1:"a",1:"THIS")_" surrogate recipient",DIR("?")="A surrogate will receive your alerts until they are removed as surrogate." D ^DIR K DIR Q:Y'>0
"RTN","XQALSURO",98,0)
 S Y=1 I XQASLIST>1 S DIR(0)="L^1:"_XQASLIST,DIR("A")="Enter a list (comma separated, e.g., 1,2) of the surrogate(s) to remove" D ^DIR K DIR
"RTN","XQALSURO",99,0)
 I Y>0 S YVAL=Y F XQAI=1:1 S XQAVAL=+$P(YVAL,",",XQAI) Q:XQAVAL'>0  D REMVSURO(XQAUSER,$P(XQASLIST(XQAVAL),U),$P(XQASLIST(XQAVAL),U,3))
"RTN","XQALSURO",100,0)
 Q
"RTN","XQALSURO",101,0)
 ;
"RTN","XQALSURO",102,0)
 ; P366 - added OPTIONAL second and third arguments to permit deletion of a specific pending surrogate and start date
"RTN","XQALSURO",103,0)
REMVSURO(XQAUSER,XQALSURO,XQALSTRT) ;SR. ICR #2790 (supported)
"RTN","XQALSURO",104,0)
 ; Ends the currently active surrogate relationship
"RTN","XQALSURO",105,0)
 I $G(XQAUSER)'>0 Q
"RTN","XQALSURO",106,0)
 D REMVSURO^XQALSUR1(XQAUSER,$G(XQALSURO),$G(XQALSTRT))
"RTN","XQALSURO",107,0)
 Q
"RTN","XQALSURO",108,0)
 ;
"RTN","XQALSURO",109,0)
 ; P366 - added OPTIONAL second and third arguments to determine surrogate for specified time range
"RTN","XQALSURO",110,0)
CURRSURO(XQAUSER,XQASTRT,XQAEND) ;SR. ICR #2790 (supported)
"RTN","XQALSURO",111,0)
 ; Returns current surrogate for user or -1  usage $$CURRSURO^XQALSURO(DUZ)
"RTN","XQALSURO",112,0)
 N X,ACTIVE,XQANOW,XQASTR1,XQAIVAL,XQA0,XQAI
"RTN","XQALSURO",113,0)
 D CHEKSUBS^XQALSUR2(XQAUSER)
"RTN","XQALSURO",114,0)
 I $G(XQASTRT)>0 Q $$DATESURO^XQALSUR1(XQAUSER,XQASTRT,$G(XQAEND)) ; P366 - check for current in specified date/times
"RTN","XQALSURO",115,0)
 ;
"RTN","XQALSURO",116,0)
 ; P366 - find the latest start time which is now or past or the first one in the future
"RTN","XQALSURO",117,0)
 S XQANOW=$$NOW^XLFDT() D
"RTN","XQALSURO",118,0)
 . S XQAIVAL=0,XQASTR1=0
"RTN","XQALSURO",119,0)
 . F XQASTRT=0:0 S XQASTRT=$O(^XTV(8992,XQAUSER,2,"B",XQASTRT)) Q:XQASTRT'>0  Q:XQASTRT'<XQANOW  S XQASTR1=XQASTRT F XQAI=0:0 S XQAI=$O(^XTV(8992,XQAUSER,2,"B",XQASTRT,XQAI)) Q:XQAI'>0  D
"RTN","XQALSURO",120,0)
 . . S XQAEND=$P(^XTV(8992,XQAUSER,2,XQAI,0),U,3) I (XQAEND="")!(XQAEND>XQANOW) S XQAIVAL=XQAI
"RTN","XQALSURO",121,0)
 . . Q
"RTN","XQALSURO",122,0)
 . ; to be compatible with the past, if there is not a current surrogate, show the next scheduled on the zero node if there is one
"RTN","XQALSURO",123,0)
 . I XQAIVAL=0 S XQASTRT=$O(^XTV(8992,XQAUSER,2,"B",XQASTR1)) Q:XQASTRT=""  F XQAI=0:0 S XQAI=$O(^XTV(8992,XQAUSER,2,"B",XQASTRT,XQAI)) Q:XQAI'>0  D  Q:XQAIVAL>0
"RTN","XQALSURO",124,0)
 . . S XQAEND=$P(^XTV(8992,XQAUSER,2,XQAI,0),U,3) I (XQAEND="")!(XQAEND>XQANOW) S XQAIVAL=XQAI
"RTN","XQALSURO",125,0)
 . . Q
"RTN","XQALSURO",126,0)
 . I XQAIVAL>0 S XQA0=^XTV(8992,XQAUSER,2,XQAIVAL,0),XQASTRT=^XTV(8992,XQAUSER,0) I ($P(XQA0,U,2)'=$P(XQASTRT,U,2))!($P(XQA0,U)'=$P(XQASTRT,U,3))!(+$P(XQA0,U,3)'=+$P(XQASTRT,U,4)) D ACTIVATE(XQAUSER,XQAIVAL)
"RTN","XQALSURO",127,0)
 . Q
"RTN","XQALSURO",128,0)
 ; P366 - end
"RTN","XQALSURO",129,0)
 S X=$G(^XTV(8992,XQAUSER,0))
"RTN","XQALSURO",130,0)
 ; now check for a CURRENT surrogate, already started and not expired or cyclic
"RTN","XQALSURO",131,0)
 I $P(X,U,2)>0,+$P(X,U,3)'>XQANOW D  I $P($G(^XTV(8992,XQAUSER,0)),U,2)>0 Q +$P(^XTV(8992,XQAUSER,0),U,2)
"RTN","XQALSURO",132,0)
 . N DATE ;   Get Current date/time to check date/times if present
"RTN","XQALSURO",133,0)
 . ; FOLLOWING LINES MODIFIED IN P443 TO ELIMINATE A STACK ERROR WHEN SURROGATE WAS CIRCULAR
"RTN","XQALSURO",134,0)
 . ;  Current Date/time past End date for surrogate
"RTN","XQALSURO",135,0)
 . S DATE=$P(X,U,4) I (DATE>0&(DATE<XQANOW)) D REMVSURO(XQAUSER) Q
"RTN","XQALSURO",136,0)
 . ; P513 quit if not already active
"RTN","XQALSURO",137,0)
 . S DATE=$P(X,U,3) S:DATE="" DATE=XQANOW I DATE>XQANOW Q  ; P513
"RTN","XQALSURO",138,0)
 . N XQASURO,XQASURO1 S XQASURO1=+$P(^XTV(8992,XQAUSER,0),U,2)
"RTN","XQALSURO",139,0)
 . ; REMOVE IF SURROGATE IS USER
"RTN","XQALSURO",140,0)
 . I XQASURO1=XQAUSER D REMVSURO(XQAUSER) Q
"RTN","XQALSURO",141,0)
 . N XQALLIST,XQAUDATE S XQAUDATE=DATE,XQALLIST(XQAUSER,DATE)="" ; P513 JLI 100504 add XQAUDATE to be able to check earlier start time
"RTN","XQALSURO",142,0)
 . ; REMOVE IF CYCLES BACK TO USER - thought about removing inactive, but best to let those be handled by groups for unprocessed alerts
"RTN","XQALSURO",143,0)
 . ; P513 but ignore if surrogate isn't already active - JLI 100504
"RTN","XQALSURO",144,0)
 . ; begin changes in P513
"RTN","XQALSURO",145,0)
 . S XQASURO1=XQAUSER
"RTN","XQALSURO",146,0)
 . F  S XQASURO=$P($G(^XTV(8992,XQASURO1,0)),U,2) Q:XQASURO'>0  Q:'$$ISACTIVE(XQASURO)  S DATE=$P(^XTV(8992,XQASURO,0),U,3) Q:DATE>XQANOW  D  S XQASURO1=XQASURO ; JLI 100504
"RTN","XQALSURO",147,0)
 . . I $D(XQALLIST(XQASURO1)) D
"RTN","XQALSURO",148,0)
 . . . N DATE1 S DATE1=$O(XQALLIST(XQASURO1,""))
"RTN","XQALSURO",149,0)
 . . . ; remove the surrogate relationship that started earliest
"RTN","XQALSURO",150,0)
 . . . I DATE<DATE1 D REMVSURO(XQASURO)
"RTN","XQALSURO",151,0)
 . . . I DATE1<=DATE D REMVSURO(XQASURO1)
"RTN","XQALSURO",152,0)
 . . . S XQASURO=XQAUSER K XQALLIST S DATE=XQAUDATE ; start over
"RTN","XQALSURO",153,0)
 . . . Q
"RTN","XQALSURO",154,0)
 . . S XQALLIST(XQASURO,DATE)=""
"RTN","XQALSURO",155,0)
 . . ; end of P513 modification
"RTN","XQALSURO",156,0)
 . . Q
"RTN","XQALSURO",157,0)
 . ; END OF P443 MODIFICATION
"RTN","XQALSURO",158,0)
 . Q
"RTN","XQALSURO",159,0)
 Q -1
"RTN","XQALSURO",160,0)
 ;
"RTN","XQALSURO",161,0)
ISACTIVE(XQAUSER) ; checks for whether a surrogate relationship is active or not (returns 0 or 1)
"RTN","XQALSURO",162,0)
 N DATA
"RTN","XQALSURO",163,0)
 S DATA=$G(^XTV(8992,XQAUSER,0)) Q:$P(DATA,U,2)="" 0  ; NO SURROGATE SPECIFIED
"RTN","XQALSURO",164,0)
 I $P(DATA,U,3)>0,$P(DATA,U,3)>$$NOW^XLFDT() Q 0  ; START DATE/TIME NOT YET
"RTN","XQALSURO",165,0)
 I $P(DATA,U,4)>0,$P(DATA,U,4)<$$NOW^XLFDT() Q 0  ; PAST END DATE/TIME
"RTN","XQALSURO",166,0)
 Q 1
"RTN","XQALSURO",167,0)
 ;
"RTN","XQALSURO",168,0)
ACTVSURO(XQAUSER) ;SR. ICR #2790 (supported)
"RTN","XQALSURO",169,0)
 ; Returns the actual surrogate at this time
"RTN","XQALSURO",170,0)
 N CURRSURO,NEXTSURO,SURODATA,NOW
"RTN","XQALSURO",171,0)
 S NOW=$$NOW^XLFDT()
"RTN","XQALSURO",172,0)
 S CURRSURO=$$CURRSURO(XQAUSER),SURODATA=$$GETSURO(XQAUSER) I (CURRSURO'>0)!(+$P(SURODATA,U,3)>NOW)!('(+$$ACTIVE^XUSER(CURRSURO))) Q -1
"RTN","XQALSURO",173,0)
 F  S NEXTSURO=$$CURRSURO(CURRSURO),SURODATA=$$GETSURO(CURRSURO) Q:NEXTSURO'>0  Q:+$P(SURODATA,U,3)>NOW  Q:'(+$$ACTIVE^XUSER(NEXTSURO))  S CURRSURO=NEXTSURO
"RTN","XQALSURO",174,0)
 Q CURRSURO
"RTN","XQALSURO",175,0)
 ;
"RTN","XQALSURO",176,0)
GETSURO(XQAUSER) ;EXTRINSIC. ICR #3213 (supported)
"RTN","XQALSURO",177,0)
 ; Returns data for surrogate for user including times
"RTN","XQALSURO",178,0)
 I $$CURRSURO(XQAUSER)'>0 Q ""
"RTN","XQALSURO",179,0)
 N GLOBREF,IENS,X
"RTN","XQALSURO",180,0)
 S IENS=XQAUSER_",",GLOBREF=$NA(^TMP($J,"XQALSURO")) K @GLOBREF
"RTN","XQALSURO",181,0)
 D GETS^DIQ(8992,IENS,".02;.03;.04","IE",GLOBREF)
"RTN","XQALSURO",182,0)
 S GLOBREF=$NA(@GLOBREF@(8992,IENS))
"RTN","XQALSURO",183,0)
 S X=$G(@GLOBREF@(.02,"I"))_U_$G(@GLOBREF@(.02,"E"))_U_$G(@GLOBREF@(.03,"I"))_U_$G(@GLOBREF@(.04,"I"))
"RTN","XQALSURO",184,0)
 K @GLOBREF
"RTN","XQALSURO",185,0)
 Q X
"RTN","XQALSURO",186,0)
 ;
"RTN","XQALSURO",187,0)
GETFOR ;OPT.
"RTN","XQALSURO",188,0)
 N XQAUSER,VALUES,XQACNT,DIR,DIRUT,I,Y
"RTN","XQALSURO",189,0)
 S DIR(0)="PD^200:AEMQ"
"RTN","XQALSURO",190,0)
 S DIR("A")="Select Surrogate (NEW PERSON entry)"
"RTN","XQALSURO",191,0)
 S DIR("A",1)="",DIR("A",2)=""
"RTN","XQALSURO",192,0)
 S DIR("A",3)=" - List Users who have chosen this User to be their current Surrogate." ;p602
"RTN","XQALSURO",193,0)
 S DIR("A",4)=""
"RTN","XQALSURO",194,0)
 D ^DIR K DIR Q:Y'>0  W "  ",$P(Y,U,2)
"RTN","XQALSURO",195,0)
 S XQAUSER=+Y
"RTN","XQALSURO",196,0)
 D SUROFOR(.VALUES,XQAUSER) I VALUES'>0 W !,"No entries found.",!! Q
"RTN","XQALSURO",197,0)
 S XQACNT=0 K DIRUT F I=0:0 S I=$O(VALUES(I)) Q:I'>0  D:(XQACNT>(IOSL-4))  Q:$D(DIRUT)  W !,?5,$P(VALUES(I),U,2) S XQACNT=XQACNT+1
"RTN","XQALSURO",198,0)
 . S DIR(0)="E" D ^DIR K DIR
"RTN","XQALSURO",199,0)
 . Q
"RTN","XQALSURO",200,0)
 K DIRUT
"RTN","XQALSURO",201,0)
 Q
"RTN","XQALSURO",202,0)
 ;
"RTN","XQALSURO",203,0)
SUROLIST(XQAUSER,XQALIST) ;SR. ICR #3213 (supported)
"RTN","XQALSURO",204,0)
 ; Returns list of current and scheduled surrogates for XQAUSER
"RTN","XQALSURO",205,0)
 D SUROLIST^XQALSUR1(XQAUSER,.XQALIST)
"RTN","XQALSURO",206,0)
 Q
"RTN","XQALSURO",207,0)
 ;
"RTN","XQALSURO",208,0)
SUROFOR(LIST,XQAUSER) ;SR. ICR #3213 (supported)
"RTN","XQALSURO",209,0)
 ; Returns list of users XQAUSER is acting as a surrogate for
"RTN","XQALSURO",210,0)
 I $G(XQAUSER)="" Q
"RTN","XQALSURO",211,0)
 N I,COUNT S I=0,COUNT=0 F  S I=$O(^XTV(8992,"AC",XQAUSER,I)) Q:I'>0  I $$CURRSURO(I)>0 D
"RTN","XQALSURO",212,0)
 . S COUNT=COUNT+1,LIST(COUNT)=I_U_$$GET1^DIQ(200,(I_","),".01","E")_U_$$GET1^DIQ(8992,(I_","),".03","E")_U_$$GET1^DIQ(8992,(I_","),".04","E")
"RTN","XQALSURO",213,0)
 S LIST=COUNT
"RTN","XQALSURO",214,0)
 Q
"RTN","XQALSURO",215,0)
 ;
"RTN","XQALSURO",216,0)
SENDMESG ;
"RTN","XQALSURO",217,0)
 N XMY,XMDUZ,XMCHAN
"RTN","XQALSURO",218,0)
 ; ZEXCEPT: XQALSURO   (EXTERNAL VALUE)
"RTN","XQALSURO",219,0)
 S XMY(XQALSURO)="",XMDUZ=.5
"RTN","XQALSURO",220,0)
 D ^XMD
"RTN","XQALSURO",221,0)
 Q
"VER")
8.0^22.0
"BLD",1446,6)
^494
**END**
**END**
