Released XU*8*570 SEQ #463
Extracted from mail message
**KIDS**:XU*8.0*570^

**INSTALL NAME**
XU*8.0*570
"BLD",1359,0)
XU*8.0*570^KERNEL^0^3110616^y
"BLD",1359,1,0)
^^2^2^3110428^
"BLD",1359,1,1,0)
Kernel patch XU*8*570; FIXES: OUT OF ORDER OPTION.
"BLD",1359,1,2,0)
Please refer to the Description in Forum Patch Module for details.
"BLD",1359,4,0)
^9.64PA^^
"BLD",1359,6.3)
3
"BLD",1359,"ABPKG")
n
"BLD",1359,"KRN",0)
^9.67PA^9002226^21
"BLD",1359,"KRN",.4,0)
.4
"BLD",1359,"KRN",.401,0)
.401
"BLD",1359,"KRN",.402,0)
.402
"BLD",1359,"KRN",.403,0)
.403
"BLD",1359,"KRN",.5,0)
.5
"BLD",1359,"KRN",.84,0)
.84
"BLD",1359,"KRN",3.6,0)
3.6
"BLD",1359,"KRN",3.8,0)
3.8
"BLD",1359,"KRN",9.2,0)
9.2
"BLD",1359,"KRN",9.8,0)
9.8
"BLD",1359,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1359,"KRN",9.8,"NM",1,0)
XQCHK^^0^B16549312
"BLD",1359,"KRN",9.8,"NM",2,0)
XQCHK2^^0^B8962094
"BLD",1359,"KRN",9.8,"NM",3,0)
XQ75^^0^B51528192
"BLD",1359,"KRN",9.8,"NM",4,0)
XQ^^0^B25124681
"BLD",1359,"KRN",9.8,"NM","B","XQ",4)

"BLD",1359,"KRN",9.8,"NM","B","XQ75",3)

"BLD",1359,"KRN",9.8,"NM","B","XQCHK",1)

"BLD",1359,"KRN",9.8,"NM","B","XQCHK2",2)

"BLD",1359,"KRN",19,0)
19
"BLD",1359,"KRN",19.1,0)
19.1
"BLD",1359,"KRN",101,0)
101
"BLD",1359,"KRN",409.61,0)
409.61
"BLD",1359,"KRN",771,0)
771
"BLD",1359,"KRN",779.2,0)
779.2
"BLD",1359,"KRN",870,0)
870
"BLD",1359,"KRN",8989.51,0)
8989.51
"BLD",1359,"KRN",8989.52,0)
8989.52
"BLD",1359,"KRN",8994,0)
8994
"BLD",1359,"KRN",9002226,0)
9002226
"BLD",1359,"KRN","B",.4,.4)

"BLD",1359,"KRN","B",.401,.401)

"BLD",1359,"KRN","B",.402,.402)

"BLD",1359,"KRN","B",.403,.403)

"BLD",1359,"KRN","B",.5,.5)

"BLD",1359,"KRN","B",.84,.84)

"BLD",1359,"KRN","B",3.6,3.6)

"BLD",1359,"KRN","B",3.8,3.8)

"BLD",1359,"KRN","B",9.2,9.2)

"BLD",1359,"KRN","B",9.8,9.8)

"BLD",1359,"KRN","B",19,19)

"BLD",1359,"KRN","B",19.1,19.1)

"BLD",1359,"KRN","B",101,101)

"BLD",1359,"KRN","B",409.61,409.61)

"BLD",1359,"KRN","B",771,771)

"BLD",1359,"KRN","B",779.2,779.2)

"BLD",1359,"KRN","B",870,870)

"BLD",1359,"KRN","B",8989.51,8989.51)

"BLD",1359,"KRN","B",8989.52,8989.52)

"BLD",1359,"KRN","B",8994,8994)

"BLD",1359,"KRN","B",9002226,9002226)

"BLD",1359,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",1359,"QUES",0)
^9.62^^
"BLD",1359,"REQB",0)
^9.611^2^2
"BLD",1359,"REQB",1,0)
XU*8.0*503^1
"BLD",1359,"REQB",2,0)
XU*8.0*553^1
"BLD",1359,"REQB","B","XU*8.0*503",1)

"BLD",1359,"REQB","B","XU*8.0*553",2)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^200^1
"PKG",3,20,200,0)
200^^XDRM200N
"PKG",3,20,200,1)

"PKG",3,20,"B",200,200)

"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
570^3110616
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3110616
"PKG",3,22,1,"PAH",1,1,1,0)
Kernel patch XU*8*570; FIXES: OUT OF ORDER OPTION.
"PKG",3,22,1,"PAH",1,1,2,0)
Please refer to the Description in Forum Patch Module for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","XQ")
0^4^B25124681^B24858955
"RTN","XQ",1,0)
XQ ; SEA/MJM - Menu driver (Part 1) ;06/16/2011
"RTN","XQ",2,0)
 ;;8.0;KERNEL;**9,46,94,103,157,570**;Jul 10, 1995;Build 3
"RTN","XQ",3,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",4,0)
 D INIT^XQ12 Q:'$D(XQY)
"RTN","XQ",5,0)
 I $D(XQUR),$E(XQUR,1,2)="^^" S XQRB=1,XQJS=4
"RTN","XQ",6,0)
 I '$D(XQJS),$D(XQUR),XQUR'="",XQUR'["[" S:XQUR'[U XQUR=U_XQUR K ^VA(200,DUZ,202.1) S XQJS=0 D ^XQTOC
"RTN","XQ",7,0)
 I $D(XQUR),XQUR["[" K ^VA(200,DUZ,202.1) S XQJS=3,^XUTL("XQ",$J,"T")=1
"RTN","XQ",8,0)
 I $D(^VA(200,DUZ,202.1)),$L($P(^(202.1),U)) S XQJS=1 S %=+^(202.1) S XQUR=$G(^DIC(19,%,"U")) I XQUR]"" D ^XQTOC
"RTN","XQ",9,0)
M I '$D(XQVOL) S XQVOL=$G(^XUTL("XQ",$J,"XQVOL")) I '$L(XQVOL) D GETENV^%ZOSV S XQVOL=$P(Y,U,2)
"RTN","XQ",10,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) S XQNOLOG="" G H^XUS
"RTN","XQ",11,0)
 S:$S('$D(XQY0):1,'$L(XQY0):1,1:0) XQY0=^DIC(19,XQY,0) S XQT=$P(XQY0,U,4) G:XQT="" M3 K:'$D(XQJS) XQUR K X,XQNOGO,XQR,XQUIT,XQUEFLG ;,XQSV
"RTN","XQ",12,0)
 I $D(XQAUDIT),XQAUDIT D LOGOPT^XQ12
"RTN","XQ",13,0)
 ;I $P(XQY0,U,18) D CHKQUE^XQ92 I XQUEFLG S XQNOGO="" ;Removed - p570
"RTN","XQ",14,0)
 I $G(XQY)>0 D CHKQUE^XQ92 I XQUEFLG S XQNOGO="" ;Added - p570
"RTN","XQ",15,0)
 ;
"RTN","XQ",16,0)
 ;Execute the Entry Action and look for XQUIT
"RTN","XQ",17,0)
 D:'$D(XQM3)&("LOQX"'[XQT) LO K XQM3 I $D(XQUIT) D
"RTN","XQ",18,0)
 .S XQUIT=0
"RTN","XQ",19,0)
 .D ^XQUIT
"RTN","XQ",20,0)
 .Q
"RTN","XQ",21,0)
 ;
"RTN","XQ",22,0)
 G:$D(XQUR) ASK1 ;Jump start or continue
"RTN","XQ",23,0)
 I '$D(XQUIT),XQT'="A",$P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ",24,0)
 D:$D(XQXFLG)[0 ABT^XQ12 ;D:$P($G(XQXFLG),U,2) LOGRSRC^%ZOSV($P(XQY0,U))
"RTN","XQ",25,0)
 D:$P(XQY0,U)]"" LOGRSRC^%ZOSV($P(XQY0,U),0,1)
"RTN","XQ",26,0)
 ;A call to PRIO was removed from the following line D:$L($P(XQY0,U,8))
"RTN","XQ",27,0)
 ;Since Kernel no longer resets priority from the Option File
"RTN","XQ",28,0)
 I XQT'="M" W:'^XUTL("XQ",$J,"T") !,$P(XQY0,U,2) W:$D(DUZ("SAV")) !,"Not when testing another's menus." S %=^XUTL("XQ",$J,"T"),^("T")=%+1,^(%+1)=XQY_XQPSM_U_XQY0 G M3:XQT'?1U!$D(DUZ("SAV"))
"RTN","XQ",29,0)
 I XQT'="M" D:'$D(XQXFLG) ABT^XQ12 D:+XQXFLG ABLOG^XQ12 K %,X,XQTT G @(XQT_"^XQ1")
"RTN","XQ",30,0)
M1 ;
"RTN","XQ",31,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",32,0)
 Q:XQY<1!'$D(^XUTL("XQ",$J,"T"))  D:'$D(XQXFLG) ABT^XQ12
"RTN","XQ",33,0)
 D:'$D(XQABOLD)&(+XQXFLG) ABLOG^XQ12 K XQABOLD W ! S XQUR=0,XQTT=^XUTL("XQ",$J,"T"),XQDIC=XQY,XQAA="Select "_$S($D(DUZ("SAV")):$P(DUZ("SAV"),U,3)_"'s ",1:"")_$P(XQY0,U,2)_" Option: " S:$D(XQMM("B")) XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",34,0)
 S:$S('XQTT:1,1:+$P(^XUTL("XQ",$J,XQTT),U,1)'=XQY) ^("T")=XQTT+1,^(XQTT+1)=XQY_XQPSM_U_XQY0 I $D(DUZ("AUTO")),DUZ("AUTO"),'$D(XQMM("J")),'$D(XQMM("N")) G EN^XQ2
"RTN","XQ",35,0)
 K:'$D(XQMM("J")) XQMM("N")
"RTN","XQ",36,0)
M2 ;
"RTN","XQ",37,0)
 I '$D(XQMMF),$D(XQMM("J")) G ^XQ74
"RTN","XQ",38,0)
 Q:$D(XQALEXIT)&'$D(XQALMENU)  K XQMMF I $D(XQMM("A")) S XQAA=XQMM("A") K XQMM("A") I $D(XQMM("B")),$L(XQMM("B")) S XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",39,0)
 D DISPLAY^XQALERT,CHK^XM
"RTN","XQ",40,0)
 S:'$D(DTIME) DTIME=60
"RTN","XQ",41,0)
 ;
"RTN","XQ",42,0)
ASK ;Get user's response in XQUR
"RTN","XQ",43,0)
 W !,XQAA R XQUR:DTIME I '$T Q:$D(XQALEXIT)  W $C(7),"  Timed out...." G CON^XQTOC
"RTN","XQ",44,0)
 I $D(XQALEXIT),XQUR=""!(XQUR["^") Q
"RTN","XQ",45,0)
 ;
"RTN","XQ",46,0)
ASK1 D SETSV ;Set XQSV to remember where we started from (XQY^XQDIC^XQY0)
"RTN","XQ",47,0)
 K XQUIT
"RTN","XQ",48,0)
 I XQUR="*",$D(DUZ("SAV")) G TESTN^XUS91
"RTN","XQ",49,0)
 I $D(XQJS),XQJS,XQJS'>2 D SET^XQTOC G JUMP^XQ72 ;Continue, 3=[LOGIN
"RTN","XQ",50,0)
 I XQUR["[" G:'$D(DUZ("SAV")) ^XQT W !,"Not when testing another's menus!" S %=^XUTL("XQ",$J,"T")+1,^("T")=%,^(%)=XQY_XQPSM_U_XQY0 G M3
"RTN","XQ",51,0)
 I XQUR="" S:$D(XQMM("B")) XQUR=XQMM("B") K XQMM("B") G:$L(XQUR) D S XQABOLD=1 G M3:^XUTL("XQ",$J,"T")>1,XPRMP^XQ12
"RTN","XQ",52,0)
 I XQUR=U G M3
"RTN","XQ",53,0)
 ;$C(34) is ", which is a shortcut to XUCOMMAND
"RTN","XQ",54,0)
 I $E(XQUR)=$C(34),$L(XQUR)>1 S XQUR=$P(XQUR,$C(34),2) D P^XQ75 G:XQY'>0 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G JUMP^XQ72
"RTN","XQ",55,0)
 ;,XQY=-1 G:$L(XQUR) M0 S XQUR=$C(34)
"RTN","XQ",56,0)
D I XQUR["^^" G:XQUR="^^" R^XQ73 S XQRB=1 S XQUR=$P(XQUR,U,2,99)
"RTN","XQ",57,0)
 ;"^^" is GO HOME, return to the Primary Menu, "^^x" is a rubber band
"RTN","XQ",58,0)
 I XQUR[U S XQUR=$P(XQUR,U,2) G:'$L(XQUR) NOFIND D S^XQ75 G D:'XQY,NOFIND:XQY<0 K XQAA S XQY=+XQY,XQCH=XQUR G:$D(XQRB) ^XQ73 G JUMP^XQ72
"RTN","XQ",59,0)
D0 G:XQUR'?1"?"1AN.ANP D1 D OPT^XQHLP G ASK
"RTN","XQ",60,0)
D1 G EN^XQ2:XQUR?."?"!(XQUR'?.ANP) D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM=$S(XQPSM=("U"_DUZ):XQPSM_",P"_XQDIC,XQPSM[",":XQPSM,XQDIC>0:XQPSM,1:"P"_XQDIC)
"RTN","XQ",61,0)
 I XQY=-1,$O(^VA(200,DUZ,203,0))>0 S XQDIC="U"_DUZ D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="U"_DUZ_",P"_XQY
"RTN","XQ",62,0)
M0 I XQY=-1 S XQDIC=$O(^DIC(19,"B","XUCOMMAND",0)) S:XQDIC="" XQDIC=-1 D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="PXU" I XQY=-1 G M3:XQUR="HALT",NOFIND
"RTN","XQ",63,0)
 G:XQY=-2 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G M
"RTN","XQ",64,0)
 ;
"RTN","XQ",65,0)
NOFIND ;Could not find the option requested, go back and try again
"RTN","XQ",66,0)
 W:XQY=-1 "  ??" S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),XQY0=$P(%,U,2,999),XQY=+$P(%,U,1) K XQJS,XQR G M1
"RTN","XQ",67,0)
 ;
"RTN","XQ",68,0)
M3 I $P(XQY0,U,15),$D(^DIC(19,+XQY,15)),$L(^(15)) X ^(15) ;W "  ==> XQ+47"
"RTN","XQ",69,0)
 S %=^XUTL("XQ",$J,"T")-1,^("T")=% G H^XUS:(%'>0) S %=^XUTL("XQ",$J,%),XQY0=$P(%,U,2,999),XQPSM=$P(%,U,1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,99),XQM3="" I +XQY<0 D RBX^XQ73
"RTN","XQ",70,0)
 G M
"RTN","XQ",71,0)
 ;
"RTN","XQ",72,0)
LO I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,+XQY,20)),$L(^(20)) X ^(20) ;W " ==> LO^XQ"
"RTN","XQ",73,0)
 ;I $D(^XUTL("XQ",$J,"P")) S X=^("P") K ^("P") X ^%ZOSF("PRIORITY")
"RTN","XQ",74,0)
 Q
"RTN","XQ",75,0)
 ;
"RTN","XQ",76,0)
SETSV ;Record where we are now for posterity in XQSV
"RTN","XQ",77,0)
 N %
"RTN","XQ",78,0)
 S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T"))
"RTN","XQ",79,0)
 S XQSV=""
"RTN","XQ",80,0)
 S $P(XQSV,U)=+%
"RTN","XQ",81,0)
 S $P(XQSV,U,2)=$S($P(%,U)["PXU":$O(^DIC(19,"B","XUCOMMAND",0)),1:$P($P(%,U),"P",2)) I $P(XQSV,U,2)="" S $P(XQSV,U,2)=XQY
"RTN","XQ",82,0)
 S $P(XQSV,U,3)=$P(%,U,2,99)
"RTN","XQ",83,0)
 Q
"RTN","XQ",84,0)
 ;
"RTN","XQ",85,0)
PRIO ;This subroutine is no longer used.  Kernel no longer resets priority.
"RTN","XQ",86,0)
 ;S Y=10 X:$D(^%ZOSF("PRIINQ")) ^("PRIINQ") S ^XUTL("XQ",$J,"P")=Y,X=$P(XQY0,U,8) X ^%ZOSF("PRIORITY")
"RTN","XQ",87,0)
 Q
"RTN","XQ75")
0^3^B51528192^B51335820
"RTN","XQ75",1,0)
XQ75 ;SEA/AMF,LUKE,JLI,BT - Lookup response for jumps ;6/14/2011
"RTN","XQ75",2,0)
 ;;8.0;KERNEL;**47,46,157,253,553,570**;Jul 10, 1995;Build 3
"RTN","XQ75",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQ75",4,0)
 ;Enter at S with XQUR. Exit with XQY set to the chosen option #,
"RTN","XQ75",5,0)
 ;with array of possibilities in XQ(XQ):XQY^menu txt [name]^XQPSM
"RTN","XQ75",6,0)
 ;XQXT(XQXT) similarly built, holds exact matches
"RTN","XQ75",7,0)
 ;XQY=-1 (no option found), or XQY=-2 (jumps shut down).
"RTN","XQ75",8,0)
 ;
"RTN","XQ75",9,0)
X ;Unless exact match is found, find all possibilities in any XQDIC
"RTN","XQ75",10,0)
 S XQO=$O(^XUTL("XQO",XQDIC,XQO)) Q:'$S(XQO="":0,XQUR="?":XQO'="^",XQUR=0_$C(1):'$L($P(XQO,"0",1)),1:'$L($P(XQO,XQUR,1)))
"RTN","XQ75",11,0)
 S XQYY=^XUTL("XQO",XQDIC,XQO) S XQY=+XQYY G:$D(XQ("X",+XQY)) X S %=$G(^XUTL("XQO",XQDIC,"^",+XQY)) G:%="" X S XQY0=$P(%,U,2,99)
"RTN","XQ75",12,0)
 S XQCY=XQY,XQCY0=XQY0 D ^XQCHK I (XQCY<0)!'$$CHCKTM(XQY) S XQY=0 G X
"RTN","XQ75",13,0)
 S:'$P(XQYY,U,2) XQ("S",+XQY)=$P(XQO,U)
"RTN","XQ75",14,0)
 I XQUR=$P(XQO,U),'XQS S XQXT=XQXT+1,XQXT(XQXT)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQXT("X",XQY)="" S:'$P(XQYY,U,2) XQXT("S",+XQY)=$P(XQO,U)
"RTN","XQ75",15,0)
 S XQ=XQ+1,XQ1=XQ1+1,XQ(XQ)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQ("X",XQY)=""
"RTN","XQ75",16,0)
 I XQ1>19,'XQXT D C
"RTN","XQ75",17,0)
 Q:XQY<0!(XQUR="")  G X
"RTN","XQ75",18,0)
 Q
"RTN","XQ75",19,0)
 ;
"RTN","XQ75",20,0)
C ;Display a screen-load of 19 possibilities and ask for a choice
"RTN","XQ75",21,0)
 ;I $G(XQXFLG("GUI")) D  Q
"RTN","XQ75",22,0)
 ;.D LIST^XQGS1(XQ)
"RTN","XQ75",23,0)
 ;.S XQUR=""
"RTN","XQ75",24,0)
 ;.Q:XQY<0
"RTN","XQ75",25,0)
 ;.S %="" F  S %=$O(XQ(%)) Q:%=""!(%'=+%)  I XQY=+XQ(%) S XQPSM=$P(XQ(%),U,3)
"RTN","XQ75",26,0)
 ;.Q
"RTN","XQ75",27,0)
 S:XQ1<1 XQ1=XQ W ! F XQI=1:1:XQ1 S XQJ=XQS*20+XQI W !?4,XQJ,?9,$P(XQ(XQJ),U,2) I $D(XQ("S",+XQ(XQJ))) W ?43,"  (",XQ("S",+XQ(XQJ)),")"
"RTN","XQ75",28,0)
ASK W !!,"Type '^' to stop, or choose a number from 1 to ",XQ," :"
"RTN","XQ75",29,0)
 R XQJ:DTIME S:'$T XQJ=U W:XQJ["?" !!,"**> Choose an item from this list by selecting its corresponding number,",!?5,"or type a '^' to return to your menu.",! G:XQJ["?" ASK
"RTN","XQ75",30,0)
 I XQJ=U S XQY=-1,XQ=0 Q
"RTN","XQ75",31,0)
 I XQJ'?1N.N,$L(XQJ),XQJ'=U W $C(7),"  ??",! G ASK
"RTN","XQ75",32,0)
 I XQJ?1N.N G C:'$D(XQ(XQJ)) D  Q:$D(XQ(+XQJ))
"RTN","XQ75",33,0)
 .N %,XQD,XQP,Y
"RTN","XQ75",34,0)
 .S %=XQ(XQJ),Y=+% I Y>0 D
"RTN","XQ75",35,0)
 ..S XQP=$P(%,U,3),XQD=$S($L(XQP,",")>1:$P(XQP,",",$L(XQP,",")),1:XQP)
"RTN","XQ75",36,0)
 ..S XQY0=$G(^XUTL("XQO",XQD,"^",Y)),XQY0=$P(XQY0,U,2,99)
"RTN","XQ75",37,0)
 ..I XQY0="" K XQ(XQJ) S XQ=XQ-1,XQJ="" Q
"RTN","XQ75",38,0)
 .I $L(XQJ),$D(XQ(XQJ)) S XQY=Y,XQDIC=XQD,XQPSM=XQP,XQUR="" W "  " Q
"RTN","XQ75",39,0)
 .Q
"RTN","XQ75",40,0)
 I XQJ?1N.N W $C(7),$P(XQ(XQJ-1#20+1),U,4),! G C
"RTN","XQ75",41,0)
 I '$L(XQJ),XQ1'<20 S XQS=XQS+1,XQ1=0 Q
"RTN","XQ75",42,0)
 I '$L(XQJ),XQ1<20 S XQY=-1,XQ=0 Q
"RTN","XQ75",43,0)
 I '$D(XQ(XQJ)) G C
"RTN","XQ75",44,0)
 K XQ S XQY=$S(XQJ=U:-3,XQJ="":-3,1:-1),XQUR=$C(95) S:XQJ=U XQJ="",XQY=-1 S:$L(XQJ) XQUR=$S($E(XQDIC,1)="P":U_XQJ,1:XQJ),XQY=0 Q
"RTN","XQ75",45,0)
 Q
"RTN","XQ75",46,0)
 ;
"RTN","XQ75",47,0)
S ;Entry from XQ: Search primary, common, and secondary menus for XQUR
"RTN","XQ75",48,0)
 I XQUR'?.ANP W $C(7) S XQY=-1 Q
"RTN","XQ75",49,0)
 I XQPSM'="PXU" S XQDIC=$S($D(XQPSM):$P(XQPSM,"P",2),$D(XQDIC):XQDIC,1:XQY)
"RTN","XQ75",50,0)
 E  S XQDIC="PXU"
"RTN","XQ75",51,0)
 I '$D(XQTT) S XQTT=$G(^XUTL("XQ",$J,"T")) I XQTT="" S XQTT=1
"RTN","XQ75",52,0)
 ;S:'$D(XQDIC) XQDIC=XQY S XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",53,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",54,0)
 S XQO=$E(XQUR,1,30) I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",55,0)
 S XQUR=XQO,(XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",56,0)
 I '$D(^XUTL("XQ",$J,"XQM")) S ^("XQM")=+^VA(200,DUZ,201)
"RTN","XQ75",57,0)
 ;I '$D(^XUTL("XQ",$J,"XQW")) S ^("XQW")=$P(^VA(200,DUZ,201),U,2)
"RTN","XQ75",58,0)
 I $D(XQJS),XQJS G OUT
"RTN","XQ75",59,0)
 ;
"RTN","XQ75",60,0)
 ;Check the Primary Menu first
"RTN","XQ75",61,0)
 S XQDIC="P"_^XUTL("XQ",$J,"XQM")
"RTN","XQ75",62,0)
 ;If there's no master copy in ^DIC(19,"AXQ"), nothing to do.
"RTN","XQ75",63,0)
 I '$D(^DIC(19,"AXQ",XQDIC,0)) D REACT^XQ84(DUZ) S XQY=-1 G OUT
"RTN","XQ75",64,0)
 I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",65,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",66,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",67,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",68,0)
 ;If tree is not there or out of date, remerge it
"RTN","XQ75",69,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",70,0)
 ;
"RTN","XQ75",71,0)
 ;Look in XUCOMMAND
"RTN","XQ75",72,0)
 S XQDIC="PXU"
"RTN","XQ75",73,0)
 ;I $S('$D(^XUTL("XQO",XQDIC,0)):1,^XUTL("XQO",XQDIC,0)'=^DIC(19,"AXQ",XQDIC,0):1,1:0) D MGPXU^XQ12
"RTN","XQ75",74,0)
 I '$D(^XUTL("XQO",XQDIC,0)) D MGPXU^XQ12
"RTN","XQ75",75,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",76,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",77,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 D MGPXU^XQ12
"RTN","XQ75",78,0)
 S XQO=XQO1 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",79,0)
 ;
"RTN","XQ75",80,0)
 ;Check the top level of the Secondaries
"RTN","XQ75",81,0)
 S XQDIC="U"_DUZ,XQO=XQO1 D:$S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,DUZ,203.1)):1,1:^VA(200,DUZ,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) ^XQSET I '$D(^XUTL("XQO",XQDIC,0)),'XQXT D C G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",82,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",83,0)
 ;
"RTN","XQ75",84,0)
 ;Check each secondary in depth
"RTN","XQ75",85,0)
 F XQK=0:0 Q:XQY<0!(XQUR="")  S XQUD="U"_DUZ,XQK=$O(^XUTL("XQO",XQUD,U,XQK)) Q:XQK=""  D
"RTN","XQ75",86,0)
 .S XQCY=XQK D ^XQCHK I XQCY>0,$P(^XUTL("XQO",XQUD,U,XQK),U,5)="M" D
"RTN","XQ75",87,0)
 ..N XQSAVE
"RTN","XQ75",88,0)
 ..S XQST=XQK,XQDIC="P"_XQK,XQO=XQO1
"RTN","XQ75",89,0)
 ..I '$D(^DIC(19,"AXQ","P0")) D
"RTN","XQ75",90,0)
 ...I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",91,0)
 ...S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",92,0)
 ...Q:XQDIC19=""  ;Nothing to merge, probably a new scondary
"RTN","XQ75",93,0)
 ...I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",94,0)
 ...S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",95,0)
 ...Q
"RTN","XQ75",96,0)
 ..D X Q:XQY<0!(XQUR="")
"RTN","XQ75",97,0)
 ..Q
"RTN","XQ75",98,0)
 .Q
"RTN","XQ75",99,0)
 G:XQY<0 OUT
"RTN","XQ75",100,0)
 G:XQUR="" W
"RTN","XQ75",101,0)
 ;
"RTN","XQ75",102,0)
 I XQXT K XQ S (XQ,XQ1)=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",103,0)
 ;
"RTN","XQ75",104,0)
 I XQ=1,XQS=0 D
"RTN","XQ75",105,0)
 .N X
"RTN","XQ75",106,0)
 .S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3)
"RTN","XQ75",107,0)
 .S XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM)
"RTN","XQ75",108,0)
 .S X=$G(^XUTL("XQO",XQDIC,U,XQY))
"RTN","XQ75",109,0)
 .I X="" S X=$G(^DIC(19,"AXQ",XQDIC,U,XQY))
"RTN","XQ75",110,0)
 .Q:X=""
"RTN","XQ75",111,0)
 .S XQY0=$P(X,U,2,99),XQSFLG=""
"RTN","XQ75",112,0)
 .Q
"RTN","XQ75",113,0)
 I $D(XQSFLG) K XQSFLG G W
"RTN","XQ75",114,0)
 ;
"RTN","XQ75",115,0)
 I XQ>0,'$D(XQ(XQS*20+1)) S XQY=-1 G OUT
"RTN","XQ75",116,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0 S XQY=-1 G OUT
"RTN","XQ75",117,0)
 ;
"RTN","XQ75",118,0)
W ;Write out remaining text and return to XQ
"RTN","XQ75",119,0)
 ;G:$D(XQXFLG("GUI")) OUT
"RTN","XQ75",120,0)
 I $D(XQ("S",+XQY)),XQUR=$E(XQ("S",+XQY),1,$L(XQUR)) W $E(XQ("S",+XQY),$L(XQUR)+1,99),"   ",$P(XQY0,U,2)
"RTN","XQ75",121,0)
 E  W $E($P(XQY0,U,2),$L(XQUR)+1,99) W:$D(XQ("S",+XQY)) "   (",XQ("S",+XQY),")"
"RTN","XQ75",122,0)
 ;
"RTN","XQ75",123,0)
OUT ;Exit here
"RTN","XQ75",124,0)
 K XQ
"RTN","XQ75",125,0)
 N % S XQ=""
"RTN","XQ75",126,0)
 I XQY>0,$D(^XUTL("XQO",XQDIC,"^",+XQY,0)) D
"RTN","XQ75",127,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0)) I %="" D
"RTN","XQ75",128,0)
 ..H 1 ;Micro surgery must have it wait a sec
"RTN","XQ75",129,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0))
"RTN","XQ75",130,0)
 ..Q
"RTN","XQ75",131,0)
 .Q:%=""
"RTN","XQ75",132,0)
 .S:%>0 XQ=+%
"RTN","XQ75",133,0)
 .F XQI=1:1:XQ D
"RTN","XQ75",134,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI)) I %="" D
"RTN","XQ75",135,0)
 ...H 1
"RTN","XQ75",136,0)
 ...S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQ75",137,0)
 ...Q
"RTN","XQ75",138,0)
 ..I %]"" S XQ(XQI)=$P(%,U)
"RTN","XQ75",139,0)
 ..Q
"RTN","XQ75",140,0)
 .Q
"RTN","XQ75",141,0)
 I XQ="" S XQ=0
"RTN","XQ75",142,0)
 ;I XQY=-1,'$D(XQHLP) W $C(7),"  ??" S XQY=+XQSV,XQDIC=$P(XQSV,U,2),XQY0=$P(XQSV,U,3,99),XQUR=""
"RTN","XQ75",143,0)
 ;
"RTN","XQ75",144,0)
 K %,I,J,X,XQ1,XQAP,XQCY,XQCY0,XQDIC19,XQI,XQJ,XQJMP,XQK,XQO,XQO1,XQS,XQST,XQUD,XQXT,XQXUTL,XQYY,Y
"RTN","XQ75",145,0)
 K XQ
"RTN","XQ75",146,0)
 Q
"RTN","XQ75",147,0)
 ;
"RTN","XQ75",148,0)
FIND(XQDIC) ;The expected 0th node in ^XUTL is not here
"RTN","XQ75",149,0)
 I '$D(XQDIC) Q 0
"RTN","XQ75",150,0)
 N %,XQT1,XQT2
"RTN","XQ75",151,0)
 S %=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",152,0)
 I '$L(%) Q 0
"RTN","XQ75",153,0)
 I $D(^XTMP("XQO","NOFIND",XQDIC)) D
"RTN","XQ75",154,0)
 .N XQT1,XQT2,XQFLG
"RTN","XQ75",155,0)
 .S XQT1=$H,XQFLG=0
"RTN","XQ75",156,0)
 .S XQT2=$G(^XTMP("XQO","NOFIND",XQDIC))
"RTN","XQ75",157,0)
 .I '$L(XQT2) Q
"RTN","XQ75",158,0)
 .I XQT2>XQT1 K ^XTMP("XQO","NOFIND",XQDIC) Q
"RTN","XQ75",159,0)
 .I XQT1>XQT2!($P(XQT1,",",2)-$P(XQT2,",",2)>.300) D
"RTN","XQ75",160,0)
 ..K ^XTMP("XQO","NOFIND",XQDIC)
"RTN","XQ75",161,0)
 ..I XQDIC="PXU" S XQFLG=1 D MGPXU^XQ12
"RTN","XQ75",162,0)
 ..I 'XQFLG D MERGE^XQ12
"RTN","XQ75",163,0)
 ..Q
"RTN","XQ75",164,0)
 .Q
"RTN","XQ75",165,0)
 I '$D(^XTMP("XQO","NOFIND",XQDIC)) S ^(XQDIC)=$H
"RTN","XQ75",166,0)
 Q %
"RTN","XQ75",167,0)
 ;
"RTN","XQ75",168,0)
P ;Entry point for '"' jump to XUCOMMAND options
"RTN","XQ75",169,0)
 I XQUR'?.ANP!(XQUR[U) W $C(7)," ??" S XQY=-1 Q
"RTN","XQ75",170,0)
 S XQO=XQUR I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",171,0)
 S XQUR=XQO ;,XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",172,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",173,0)
 S (XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",174,0)
 S XQDIC="PXU" D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",175,0)
 I XQXT K XQ S XQ=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",176,0)
 I XQ=1,XQS=0 S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3),XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM),XQY0=$P(^XUTL("XQO",XQDIC,U,XQY),U,2,99) G OUT
"RTN","XQ75",177,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0&('XQXT) S XQY=-1 G OUT
"RTN","XQ75",178,0)
 G OUT
"RTN","XQ75",179,0)
 ;
"RTN","XQ75",180,0)
CHCKTM(XQIEN) ;check Restriction time/date
"RTN","XQ75",181,0)
 N X,Y
"RTN","XQ75",182,0)
 S Y=+$G(XQIEN) I Y'>0 Q 0
"RTN","XQ75",183,0)
 D NEXT^XQ92 I X'<$$NOW^XLFDT,$G(%XQOP)=3.91 Q 0
"RTN","XQ75",184,0)
 Q 1
"RTN","XQCHK")
0^1^B16549312^B16817550
"RTN","XQCHK",1,0)
XQCHK ; SEA/MJM - Check security on option # XQCY ;4/28/11
"RTN","XQCHK",2,0)
 ;;8.0;KERNEL;**47,110,149,303,427,503,570**;Jul 10, 1995;Build 3
"RTN","XQCHK",3,0)
 ;;"Per VHA Directive 2004-038, this routine should not be modified".
"RTN","XQCHK",4,0)
 ;
"RTN","XQCHK",5,0)
 Q:'$D(XQCY)!(XQCY<1)  S:'$D(XQJMP) XQJMP=0
"RTN","XQCHK",6,0)
 I '$D(XQY0) S XQY0=^DIC(19,+XQCY,0)
"RTN","XQCHK",7,0)
 I '$D(XQCY0) S XQSAV=XQY0,XQY=XQCY D SET Q:XQCY<0  S XQCY0=XQY0,XQY0=XQSAV
"RTN","XQCHK",8,0)
CHK I XQCY0="" S XQCY=-1 G OUT
"RTN","XQCHK",9,0)
 ;I $P(XQCY0,U,3)'="" S XQCY=-1 G OUT ;remove 570
"RTN","XQCHK",10,0)
 N XQRT S XQRT=$$CHKOOO^XQCHK2(XQCY0) I +XQRT=1 S XQCY=-1 G OUT ;add this line to check if the option is set Out Of Order - BT/570
"RTN","XQCHK",11,0)
 N XQRT S XQRT=$$CHCKL^XQCHK2(XQCY0,DUZ) I +XQRT S XQCY=-2 G OUT  ; add this line to check all Locks
"RTN","XQCHK",12,0)
 ;I $L($P(XQCY0,U,6)) S %="" F %XQI=1:1 S %=$P($P(XQCY0,U,6),",",%XQI) Q:%=""  I '$D(^XUSEC(%,DUZ)) S XQCY=-2 G OUT  ; remove 570
"RTN","XQCHK",13,0)
 N XQRT S XQRT=$$CHCKRL^XQCHK2(XQCY0,DUZ) I +XQRT S XQCY=-3 G OUT  ; add this line to check all Reversed Locks
"RTN","XQCHK",14,0)
 ;I $L($P(XQCY0,U,16)) S %="" F %XQI=1:1 S %=$P($P(XQCY0,U,16),",",%XQI) Q:%=""  I $D(^XUSEC(%,DUZ)) S XQCY=-3 G OUT  ; remove 570
"RTN","XQCHK",15,0)
 I $L($P(XQCY0,U,9)) S XQZ=$P(XQCY0,U,9) D ^XQDATE S X=% D XQO^XQ92 I X="" S XQCY=-4 G OUT
"RTN","XQCHK",16,0)
 G:$P(XQCY0,U,10)'["y" OUT
"RTN","XQCHK",17,0)
 S %=0 F %XQI=1:1 S %=$O(^DIC(19,XQCY,3.96,%,0)) Q:%=""  I IOS=% G OUT
"RTN","XQCHK",18,0)
 S XQCY=-5 G OUT
"RTN","XQCHK",19,0)
 Q
"RTN","XQCHK",20,0)
 ;
"RTN","XQCHK",21,0)
OUT K %,%XQI,XQCY0,%Y,XQZ
"RTN","XQCHK",22,0)
 Q
"RTN","XQCHK",23,0)
 ;
"RTN","XQCHK",24,0)
JMP ;Check all options in jump path in %XQJP returned as "" if not OK
"RTN","XQCHK",25,0)
 S XQJMP=1
"RTN","XQCHK",26,0)
 F %XQCI=1:1 S XQCY=$P(%XQJP,",",%XQCI) Q:XQCY=""  S XQCY0=$G(^XUTL("XQO",XQDIC,"^",XQCY)),XQCY0=$P(XQCY0,U,2,99) D CHK S:XQCY<0 %XQJP=""
"RTN","XQCHK",27,0)
 K %XQCI,XQCY,XQCY0
"RTN","XQCHK",28,0)
 Q
"RTN","XQCHK",29,0)
 ;
"RTN","XQCHK",30,0)
SET ;Produce the same XQY0 as SET1^XQ7 without the synonym
"RTN","XQCHK",31,0)
 I '$D(^DIC(19,+XQY,0)) S XQY=-1 Q
"RTN","XQCHK",32,0)
S1 Q:XQY'>0  S XQY0=^DIC(19,+XQY,0),XQY0=$P(XQY0,U,1,2)_U_$S($P(XQY0,U,3)]"":1,1:"")_U_$P(XQY0,U,4)_U_U_$P(XQY0,U,6,99)
"RTN","XQCHK",33,0)
 S %="" I $D(^DIC(19,+XQY,3.91)) F %XQI=0:0 S %XQI=$O(^DIC(19,+XQY,3.91,%XQI)) Q:%XQI=""!(%XQI'=+%XQI)  I ^(%XQI,0)]"" S %=$S(%'="":%_";",1:"")_$P(^(0),U,1)_$P(^(0),U,2)
"RTN","XQCHK",34,0)
 I %]"" S XQY0=$P(XQY0,U,1,8)_U_%_U_$P(XQY0,U,10,99)
"RTN","XQCHK",35,0)
 I $P(XQY0,U,16),$D(^DIC(19,XQY,3)) S %=$P(^(3),U) I %'="" S XQY0=$P(XQY0,U,1,15)_U_%_U_$P(XQY0,U,17,99)
"RTN","XQCHK",36,0)
 K %,%XQI
"RTN","XQCHK",37,0)
 Q
"RTN","XQCHK",38,0)
 ;
"RTN","XQCHK",39,0)
MES ;Messages for rejected options from a call to XQCHK
"RTN","XQCHK",40,0)
 W $C(7)
"RTN","XQCHK",41,0)
 I XQCY=-1 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," is out of order with the message:",!?10,$P(^DIC(19,XQY,0),U,3)
"RTN","XQCHK",42,0)
 I XQCY=-2 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," is locked."
"RTN","XQCHK",43,0)
 I XQCY=-3 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," has a reverse lock on it."
"RTN","XQCHK",44,0)
 I XQCY=-4 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," not allowed right now."
"RTN","XQCHK",45,0)
 I XQCY=-5 W !!?5,"==> Sorry, ",$S($D(XQPRMN):"your Primary Menu",1:"this option")," not allowed on this device."
"RTN","XQCHK",46,0)
 Q
"RTN","XQCHK",47,0)
 ;
"RTN","XQCHK",48,0)
OP ;Find out what option or protocol is in charge right now
"RTN","XQCHK",49,0)
 ;Returns option or protocol name and text in XQOPT
"RTN","XQCHK",50,0)
 S U="^",%XQ=0
"RTN","XQCHK",51,0)
 I $D(XQORNOD) S %XQ=+XQORNOD,%XQ1=U_$P(XQORNOD,";",2),%XQ=@(%XQ1_%XQ_",0)"),XQOPT=$P(%XQ,U)_U_$P(%XQ,U,2)
"RTN","XQCHK",52,0)
 I '$D(XQORNOD) S %XQ=$S($D(XQY)#2:XQY,1:0) I %XQ S %XQ1=^DIC(19,+%XQ,0),XQOPT=$P(%XQ1,U)_U_$P(%XQ1,U,2)
"RTN","XQCHK",53,0)
 I '$D(XQOPT) S XQOPT="-1^Unknown"
"RTN","XQCHK",54,0)
 K %XQ,%XQ1
"RTN","XQCHK",55,0)
 Q
"RTN","XQCHK",56,0)
 ;
"RTN","XQCHK",57,0)
OP1() ;Extrinsic function call returns 3 pieces: 1. "P", "O", or "U" for
"RTN","XQCHK",58,0)
 ;Protocol, Option, or Unknown.  2: The Option or Protocol's name. 3:
"RTN","XQCHK",59,0)
 ;3: Text name of the Protocol or Option.  For example:
"RTN","XQCHK",60,0)
 ;
"RTN","XQCHK",61,0)
 ;           O^EVE^System Manager's Menu
"RTN","XQCHK",62,0)
 ;
"RTN","XQCHK",63,0)
 N %,%XQ,%XQ1
"RTN","XQCHK",64,0)
 S U="^",%XQ=0
"RTN","XQCHK",65,0)
 I $D(XQORNOD) S %XQ=+XQORNOD,%XQ1=U_$P(XQORNOD,";",2),%XQ=@(%XQ1_%XQ_",0)"),%="P"_U_$P(%XQ,U)_U_$P(%XQ,U,2)
"RTN","XQCHK",66,0)
 I '$D(XQORNOD) S %XQ=$S($D(XQY)#2:XQY,1:0) I %XQ S %XQ1=^DIC(19,+%XQ,0),%="O"_U_$P(%XQ1,U)_U_$P(%XQ1,U,2)
"RTN","XQCHK",67,0)
 I '$D(%) S %="U"_U_"Unknown"_U_"No option or protocol data available"
"RTN","XQCHK",68,0)
 Q %
"RTN","XQCHK",69,0)
 ;
"RTN","XQCHK",70,0)
ACCESS(%XQUSR,%XQOP) ;Find out if a user has access to a particular option
"RTN","XQCHK",71,0)
 Q $$ACCESS^XQCHK3(%XQUSR,%XQOP)
"RTN","XQCHK",72,0)
 ;
"RTN","XQCHK",73,0)
OPACCES ;Entry point for the option that checks to see if a user has
"RTN","XQCHK",74,0)
 ;access to a particular option by calling the above function.
"RTN","XQCHK",75,0)
 D OPACCES^XQCHK3
"RTN","XQCHK",76,0)
 Q
"RTN","XQCHK",77,0)
 ;
"RTN","XQCHK",78,0)
KEYSET(XQU) ;Collect users keys and set them into ^TMP($J)
"RTN","XQCHK",79,0)
 N %,XQI
"RTN","XQCHK",80,0)
 S %=0 F XQI=0:1 S %=$O(^VA(200,XQU,51,"B",%)) Q:%=""  S:$D(^DIC(19.1,%,0)) ^TMP($J,$P(^DIC(19.1,%,0),U),%)=""
"RTN","XQCHK",81,0)
 Q
"RTN","XQCHK2")
0^2^B8962094^B6390700
"RTN","XQCHK2",1,0)
XQCHK2 ; OAK-BP/BDT - Internal APIs to check Keys for options; 4/28/11
"RTN","XQCHK2",2,0)
 ;;8.0;KERNEL;**427,503,570**;Jul 10, 1995;Build 3
"RTN","XQCHK2",3,0)
 ;;"Per VHA Directive 2004-038, this routine should not be modified".
"RTN","XQCHK2",4,0)
 Q
"RTN","XQCHK2",5,0)
 ;; These Internal Kernel APIs are using in the routine XQCHK
"RTN","XQCHK2",6,0)
 ;; to check Keys for options
"RTN","XQCHK2",7,0)
 ;; 
"RTN","XQCHK2",8,0)
CHCKL(XQCY0,XQDUZ) ;Entry point for checking all Locks for an option
"RTN","XQCHK2",9,0)
 ;; XQCY0 is $P(^XUTL("XQO",XQDIC,"^",%XQOP),"^",2,99)
"RTN","XQCHK2",10,0)
 ;; XQDUZ is IEN of user
"RTN","XQCHK2",11,0)
 ;; Return XQRT: Zero or 1^Key found that user needed for the option
"RTN","XQCHK2",12,0)
 S XQCY0=$G(XQCY0)
"RTN","XQCHK2",13,0)
 N XQI,XQY,XQX,XQRT,XQK S (XQRT,XQX)=0
"RTN","XQCHK2",14,0)
 ;check Key for the option; p457
"RTN","XQCHK2",15,0)
 S XQY=$P(XQCY0,"^"),XQX=$$GETIEN(XQY)
"RTN","XQCHK2",16,0)
 I +XQX S XQK=$$GET1^DIQ(19,XQX,3)
"RTN","XQCHK2",17,0)
 I $G(XQK)'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q XQRT
"RTN","XQCHK2",18,0)
 ;loop through higher menu options.
"RTN","XQCHK2",19,0)
 S XQY=$P(XQCY0,"^",5)
"RTN","XQCHK2",20,0)
 F XQI=1:1  S XQX=$P(XQY,",",XQI) Q:'XQX  D
"RTN","XQCHK2",21,0)
 . I +XQX S XQK=$$GET1^DIQ(19,XQX,3) I XQK'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q
"RTN","XQCHK2",22,0)
 Q XQRT
"RTN","XQCHK2",23,0)
 ;
"RTN","XQCHK2",24,0)
CHCKRL(XQCY0,XQDUZ) ;Entry point for checking all Reversed Locks for an option
"RTN","XQCHK2",25,0)
 ;; XQCY0 is $P(^XUTL("XQO",XQDIC,"^",%XQOP),"^",2,99)
"RTN","XQCHK2",26,0)
 ;; XQDUZ is IEN of user
"RTN","XQCHK2",27,0)
 ;; Return XQRT: Zero or 1^Reversed Key found that user has
"RTN","XQCHK2",28,0)
 S XQCY0=$G(XQCY0)
"RTN","XQCHK2",29,0)
 N XQI,XQY,XQX,XQRT,XQK S (XQRT,XQX)=0
"RTN","XQCHK2",30,0)
 ;check Reversed Key for the option; p457
"RTN","XQCHK2",31,0)
 S XQY=$P(XQCY0,"^"),XQX=$$GETIEN(XQY)
"RTN","XQCHK2",32,0)
 I +XQX S XQK=$$GET1^DIQ(19,XQX,3.01)
"RTN","XQCHK2",33,0)
 I $G(XQK)'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q XQRT
"RTN","XQCHK2",34,0)
 ;loop through higher menu options.
"RTN","XQCHK2",35,0)
 S XQY=$P(XQCY0,"^",5)
"RTN","XQCHK2",36,0)
 F XQI=1:1  S XQX=$P(XQY,",",XQI) Q:'XQX  D
"RTN","XQCHK2",37,0)
 . I +XQX S XQK=$$GET1^DIQ(19,XQX,3.01) I XQK'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK Q 
"RTN","XQCHK2",38,0)
 Q XQRT
"RTN","XQCHK2",39,0)
 ;
"RTN","XQCHK2",40,0)
GETIEN(XQNAME) ;get IEN for an option; 457
"RTN","XQCHK2",41,0)
 ;; XQNAME is name of an option
"RTN","XQCHK2",42,0)
 ;; Retrun XQIEN: Null or IEN if existed
"RTN","XQCHK2",43,0)
 N XQIEN S XQIEN=""
"RTN","XQCHK2",44,0)
 I $G(XQNAME)="" Q XQIEN
"RTN","XQCHK2",45,0)
 I '$D(^DIC(19,"B",XQNAME)) Q XQIEN
"RTN","XQCHK2",46,0)
 S XQIEN=$O(^DIC(19,"B",XQNAME,XQIEN))
"RTN","XQCHK2",47,0)
 Q XQIEN
"RTN","XQCHK2",48,0)
 ;
"RTN","XQCHK2",49,0)
CHKTOPL(XQIEN,XQDUZ) ;Check Lock for the top level of the secondary options
"RTN","XQCHK2",50,0)
 ;this need to be called to check the top level first when check the
"RTN","XQCHK2",51,0)
 ;Locks for lower menu option because the 6th piece of ^XUTL does not
"RTN","XQCHK2",52,0)
 ;contain the IEN of the top menu option.
"RTN","XQCHK2",53,0)
 N XQRT,XQK S XQRT=0
"RTN","XQCHK2",54,0)
 I XQIEN'=+$G(XQIEN) Q XQRT
"RTN","XQCHK2",55,0)
 S XQK=$$GET1^DIQ(19,XQIEN,3)
"RTN","XQCHK2",56,0)
 I $G(XQK)'="",'$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK
"RTN","XQCHK2",57,0)
 Q XQRT
"RTN","XQCHK2",58,0)
 ;
"RTN","XQCHK2",59,0)
CHKTOPRL(XQIEN,XQDUZ) ;Check Reversed Lock the top level of the secondary options
"RTN","XQCHK2",60,0)
 ;this need to be called to check the top level first when check the
"RTN","XQCHK2",61,0)
 ;Reversed Locks for lower menu option because the 6th piece of ^XUTL does not
"RTN","XQCHK2",62,0)
 ;contain the IEN of the top menu option.
"RTN","XQCHK2",63,0)
 N XQRT,XQK S XQRT=0
"RTN","XQCHK2",64,0)
 I XQIEN'=+$G(XQIEN) Q XQRT
"RTN","XQCHK2",65,0)
 S XQK=$$GET1^DIQ(19,XQIEN,3.01)
"RTN","XQCHK2",66,0)
 I $G(XQK)'="",$D(^XUSEC(XQK,XQDUZ)) S XQRT=1_"^"_XQK
"RTN","XQCHK2",67,0)
 Q XQRT
"RTN","XQCHK2",68,0)
 ;
"RTN","XQCHK2",69,0)
CHKOOO(XQCY0) ; Check OOO option
"RTN","XQCHK2",70,0)
 ;; XQCY0 is $P(^XUTL("XQO",XQDIC,"^",%XQOP),"^",2,99)
"RTN","XQCHK2",71,0)
 ;; Return XQRT: Zero or 1^Out Of Order message
"RTN","XQCHK2",72,0)
 S XQCY0=$G(XQCY0)
"RTN","XQCHK2",73,0)
 N XQI,XQY,XQX,XQRT,XQK S (XQRT,XQX)=0
"RTN","XQCHK2",74,0)
 ;check Out Of Order
"RTN","XQCHK2",75,0)
 S XQY=$P(XQCY0,"^"),XQX=$$GETIEN(XQY)
"RTN","XQCHK2",76,0)
 I +XQX S XQK=$$GET1^DIQ(19,XQX,2)
"RTN","XQCHK2",77,0)
 I $G(XQK)'="" Q "1^"_$G(XQK)
"RTN","XQCHK2",78,0)
 ;loop through higher menu options.
"RTN","XQCHK2",79,0)
 S XQY=$P(XQCY0,"^",5)
"RTN","XQCHK2",80,0)
 F XQI=1:1  S XQX=$P(XQY,",",XQI) Q:'XQX  D
"RTN","XQCHK2",81,0)
 . I +XQX S XQK=$$GET1^DIQ(19,XQX,2) I XQK'="" S XQRT="1^"_XQK Q
"RTN","XQCHK2",82,0)
 Q XQRT
"RTN","XQCHK2",83,0)
 ;
"VER")
8.0^22.0
"BLD",1359,6)
^463
**END**
**END**
