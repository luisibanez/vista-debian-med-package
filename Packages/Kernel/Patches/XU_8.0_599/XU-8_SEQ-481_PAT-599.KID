Released XU*8*599 SEQ #481
Extracted from mail message
**KIDS**:XU*8.0*599^

**INSTALL NAME**
XU*8.0*599
"BLD",1442,0)
XU*8.0*599^KERNEL^0^3120522^y
"BLD",1442,1,0)
^^1^1^3120522^
"BLD",1442,1,1,0)
See patch description on FORUM for XU*8.0*599 for details.
"BLD",1442,4,0)
^9.64PA^^
"BLD",1442,6.3)
8
"BLD",1442,"INID")
^n
"BLD",1442,"INIT")
POST^XU8P599
"BLD",1442,"KRN",0)
^9.67PA^9002226^21
"BLD",1442,"KRN",.4,0)
.4
"BLD",1442,"KRN",.401,0)
.401
"BLD",1442,"KRN",.402,0)
.402
"BLD",1442,"KRN",.403,0)
.403
"BLD",1442,"KRN",.5,0)
.5
"BLD",1442,"KRN",.84,0)
.84
"BLD",1442,"KRN",3.6,0)
3.6
"BLD",1442,"KRN",3.8,0)
3.8
"BLD",1442,"KRN",9.2,0)
9.2
"BLD",1442,"KRN",9.8,0)
9.8
"BLD",1442,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1442,"KRN",9.8,"NM",1,0)
XU8P599^^0^B214875
"BLD",1442,"KRN",9.8,"NM",2,0)
ZIS^^0^B19247416
"BLD",1442,"KRN",9.8,"NM",3,0)
ZISHONT^^0^B61304186
"BLD",1442,"KRN",9.8,"NM",4,0)
ZISUTL^^0^B12853409
"BLD",1442,"KRN",9.8,"NM","B","XU8P599",1)

"BLD",1442,"KRN",9.8,"NM","B","ZIS",2)

"BLD",1442,"KRN",9.8,"NM","B","ZISHONT",3)

"BLD",1442,"KRN",9.8,"NM","B","ZISUTL",4)

"BLD",1442,"KRN",19,0)
19
"BLD",1442,"KRN",19,"NM",0)
^9.68A^^0
"BLD",1442,"KRN",19.1,0)
19.1
"BLD",1442,"KRN",101,0)
101
"BLD",1442,"KRN",409.61,0)
409.61
"BLD",1442,"KRN",771,0)
771
"BLD",1442,"KRN",779.2,0)
779.2
"BLD",1442,"KRN",870,0)
870
"BLD",1442,"KRN",8989.51,0)
8989.51
"BLD",1442,"KRN",8989.52,0)
8989.52
"BLD",1442,"KRN",8994,0)
8994
"BLD",1442,"KRN",9002226,0)
9002226
"BLD",1442,"KRN",9002226,"NM",0)
^9.68A^^
"BLD",1442,"KRN","B",.4,.4)

"BLD",1442,"KRN","B",.401,.401)

"BLD",1442,"KRN","B",.402,.402)

"BLD",1442,"KRN","B",.403,.403)

"BLD",1442,"KRN","B",.5,.5)

"BLD",1442,"KRN","B",.84,.84)

"BLD",1442,"KRN","B",3.6,3.6)

"BLD",1442,"KRN","B",3.8,3.8)

"BLD",1442,"KRN","B",9.2,9.2)

"BLD",1442,"KRN","B",9.8,9.8)

"BLD",1442,"KRN","B",19,19)

"BLD",1442,"KRN","B",19.1,19.1)

"BLD",1442,"KRN","B",101,101)

"BLD",1442,"KRN","B",409.61,409.61)

"BLD",1442,"KRN","B",771,771)

"BLD",1442,"KRN","B",779.2,779.2)

"BLD",1442,"KRN","B",870,870)

"BLD",1442,"KRN","B",8989.51,8989.51)

"BLD",1442,"KRN","B",8989.52,8989.52)

"BLD",1442,"KRN","B",8994,8994)

"BLD",1442,"KRN","B",9002226,9002226)

"BLD",1442,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",1442,"QUES",0)
^9.62^^
"BLD",1442,"REQB",0)
^9.611^1^1
"BLD",1442,"REQB",1,0)
XU*8.0*572^2
"BLD",1442,"REQB","B","XU*8.0*572",1)

"INIT")
POST^XU8P599
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
599^3120522
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^3120522
"PKG",3,22,1,"PAH",1,1,1,0)
See patch description on FORUM for XU*8.0*599 for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","XU8P599")
0^1^B214875^n/a
"RTN","XU8P599",1,0)
XU8P599 ;ISD/HGW - Patch XU*8*599 Post-init ;05/17/12  08:22
"RTN","XU8P599",2,0)
 ;;8.0;KERNEL;**599**;May 17, 2012;Build 8
"RTN","XU8P599",3,0)
 Q
"RTN","XU8P599",4,0)
POST  ;
"RTN","XU8P599",5,0)
 ;Load changes into ^%Z* routines
"RTN","XU8P599",6,0)
 I '$D(^XTV(8989.3,1,"PEER")) S ^XTV(8989.3,1,"PEER")="127.0.0.1"
"RTN","XU8P599",7,0)
 X ^%ZOSF("EON")
"RTN","XU8P599",8,0)
 W ! D RELOAD^ZTMGRSET W !
"RTN","XU8P599",9,0)
 X ^%ZOSF("EOFF")
"RTN","XU8P599",10,0)
 Q
"RTN","ZIS")
0^2^B19247416^B19582012
"RTN","ZIS",1,0)
%ZIS ;SFISC/AC,RWF -- DEVICE HANDLER ;05/22/12  12:31
"RTN","ZIS",2,0)
 ;;8.0;KERNEL;**18,23,69,112,199,191,275,363,440,499,524,546,599**;JUL 10, 1995;Build 8
"RTN","ZIS",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZIS",4,0)
 ; ZEXCEPT: %IS,%ZIS,%ZISVT,DTIME,ION,IOP,IOT,POP,ZTIO,ZTQUEUED
"RTN","ZIS",5,0)
 N %ZISOS,%ZISV
"RTN","ZIS",6,0)
 S U="^",%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^%ZOSF("VOL")),POP=0 ;p524
"RTN","ZIS",7,0)
 ;Check SPOOLER special case first
"RTN","ZIS",8,0)
INIT ;
"RTN","ZIS",9,0)
 I $G(ZTQUEUED),$G(IOT)="SPL",$D(IOP),$L($G(IO)),IO=$G(IO(0)),$D(IO(1,IO))#2,(IOP[$G(ION)!(IOP[IO)) K %ZIS,%IS,IOP Q  ;p524
"RTN","ZIS",10,0)
 ;p524 Line above for HD141181.
"RTN","ZIS",11,0)
 I '$D(%ZIS),$D(%IS) M %ZIS=%IS
"RTN","ZIS",12,0)
 S:'($D(%ZIS)#2) %ZIS="M" M %IS=%ZIS ;update %IS for now
"RTN","ZIS",13,0)
 I '$D(^XUTL("XQ",$J,"MIXED OS")) S ^XUTL("XQ",$J,"MIXED OS")=$$PRI^%ZOSV
"RTN","ZIS",14,0)
 S %ZIS("PRI")=$G(^XUTL("XQ",$J,"MIXED OS"),1)
"RTN","ZIS",15,0)
 ;
"RTN","ZIS",16,0)
 I $D(ZTQUEUED) D  I '$D(IOP) S POP=1 G EXIT^%ZIS1
"RTN","ZIS",17,0)
 .I $G(ZTIO)="" S:%ZIS'[0 %ZIS=%ZIS_"0",%IS=%ZIS
"RTN","ZIS",18,0)
 I '$D(ZTQUEUED),%ZIS["T",$P($G(IOP),";")="Q" S POP=1 G EXIT^%ZIS1
"RTN","ZIS",19,0)
 N %,%A,%E,%H,%I,%X,%XX,%Y,%Z,%Z1,%Z2,%Z9,%Z90,%Z91,%Z95,%ZISB,%ZTIME,%ZTYPE
"RTN","ZIS",20,0)
 N %ZHFN,%ZISOLD,%ZTOUT,%ZISDTIM,DTOUT,DUOUT
"RTN","ZIS",21,0)
 S %ZISDTIM=$G(DTIME,300)
"RTN","ZIS",22,0)
 ;Save symbols to restore if don't open a device
"RTN","ZIS",23,0)
 D SYMBOL^%ZISUTL(0,$NA(%ZISOLD))
"RTN","ZIS",24,0)
A D CLEAN ;p363
"RTN","ZIS",25,0)
 K IO("P"),IO("Q"),IO("S"),IO("T")
"RTN","ZIS",26,0)
K2 D K2^%ZIS1
"RTN","ZIS",27,0)
 S %ZISB=%ZIS'["N",(%E,%H)=0,%Y="" S:'$D(IO(0)) IO(0)=$I
"RTN","ZIS",28,0)
 I $D(IOP),IOP=$I!(IOP="HOME")!(0[IOP),$D(^XUTL("XQ",$J,"IO")) D HOME K %IS,%Y,%ZIS,%ZISB,%ZISV,IOP Q
"RTN","ZIS",29,0)
 ;Don't worry about HOME if %ZIS[0
"RTN","ZIS",30,0)
 D:%ZIS'[0 GETHOME G EXIT^%ZIS1:POP,^%ZIS1 ;Jump to next part
"RTN","ZIS",31,0)
GETHOME I $D(IO("HOME")),$P(IO("HOME"),"^",2)=IO(0) S (%E,%H)=+IO("HOME") Q
"RTN","ZIS",32,0)
 I $D(^XUTL("XQ",$J,"IOS")),$D(^("IO")),IO(0)=^("IO") S (%E,%H)=^("IOS") Q
"RTN","ZIS",33,0)
 ;CALL LINEPORT CODE HERE---
"RTN","ZIS",34,0)
 S %=$$LINEPORT^%ZISUTL I % S (%E,%H)=% Q
"RTN","ZIS",35,0)
 S %ZISVT=$I D VTLKUP I '%E S %ZISVT=$I D VIRTUAL
"RTN","ZIS",36,0)
 I %ZISVT=""!(%E'>0) I %ZIS'[0 O IO(0)::0 I $T U IO(0) W !,"HOME DEVICE ("_$I_") DOES NOT EXIST IN THE DEVICE FILE",!,"PLEASE CONTACT YOUR SYSTEM MANAGER!",*7
"RTN","ZIS",37,0)
 S %H=%E S:'%H&(%ZIS'[0) POP=1 S:(%H>0)&('$D(IO("HOME"))) IO("HOME")=%H_"^"_$I
"RTN","ZIS",38,0)
 Q
"RTN","ZIS",39,0)
VIRTUAL ;See if a Virtual Terminal (LAT, TELNET)
"RTN","ZIS",40,0)
 ; ZEXCEPT: %ZISI,%ZISVT
"RTN","ZIS",41,0)
 F %ZISI=$L(%ZISVT):-1:1 D:$D(^%ZIS(1,"C",%ZISVT))  Q:$S('%E:0,$G(^%ZIS(1,%E,"TYPE"))="VTRM":1,1:0)  S %ZISVT=$E(%ZISVT,1,%ZISI)
"RTN","ZIS",42,0)
 .D VTLKUP Q  ;Q:$S('%E:0,'$D(^%ZIS(1,%E,"TYPE")):0,^("TYPE")="VTRM":1,1:0)
"RTN","ZIS",43,0)
 Q
"RTN","ZIS",44,0)
VTLKUP ;
"RTN","ZIS",45,0)
 ; ZEXCEPT: %E,%ZISV,%ZISVT,%ZISX
"RTN","ZIS",46,0)
 F %ZISX=%ZISV,"" S %E=+$O(^%ZIS(1,"G","SYS."_%ZISX_"."_%ZISVT,0)) Q:%E
"RTN","ZIS",47,0)
 Q
"RTN","ZIS",48,0)
CURRENT ;Old, Not in current doc's.
"RTN","ZIS",49,0)
 ; ZEXCEPT: %ZISI,%ZISOS,%ZISV,%ZISVT,%ZISX,BS,FF,RM,SL,SUB,XY
"RTN","ZIS",50,0)
 N %ZIS,%IS,%E,%H,%A,%,POP,X
"RTN","ZIS",51,0)
 S FF="#",SL=24,BS="*8",RM=80,(SUB,XY)="",%ZIS=0,%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^("VOL")),POP=0
"RTN","ZIS",52,0)
 D GETHOME K %ZISI,%ZISOS,%ZISV,%ZISVT,%ZISX Q:POP
"RTN","ZIS",53,0)
 I $D(^%ZIS(1,%H,"SUBTYPE")) S SUB=+^("SUBTYPE")
"RTN","ZIS",54,0)
 I $D(SUB),SUB,$D(^%ZIS(2,SUB,1)) S SUB=$S($D(^(0)):$P(^(0),"^"),1:""),FF=$P(^(1),"^",2),SL=$P(^(1),"^",3),BS=$P(^(1),"^",4),XY=$P(^(1),"^",5),RM=+^(1)
"RTN","ZIS",55,0)
 E  S SUB=""
"RTN","ZIS",56,0)
 I $D(^%ZOSF("RM")) S X=RM X ^("RM")
"RTN","ZIS",57,0)
 Q
"RTN","ZIS",58,0)
HOME ;Entry point to establish IO* variables for home device.
"RTN","ZIS",59,0)
 ; ZEXCEPT: IOM,IOP
"RTN","ZIS",60,0)
 D CLEAN ;(p363)
"RTN","ZIS",61,0)
 N X I '$D(^XUTL("XQ",$J,"IO")) S IOP="HOME" D ^%ZIS Q
"RTN","ZIS",62,0)
 D RESETVAR
"RTN","ZIS",63,0)
 I $L($G(IO)),$P($G(IO("HOME")),"^",2)=IO,$D(IO(1,IO)) U IO ;p524
"RTN","ZIS",64,0)
 I '$D(IO("C")),$G(IOM),IO=$I,$D(IO(1,IO)),$D(^%ZOSF("RM")) S X=+IOM X ^("RM")
"RTN","ZIS",65,0)
 S X=$$ENDOFILE^%ZISUTL ;p599 Set end-of-file handling for Cache
"RTN","ZIS",66,0)
 Q
"RTN","ZIS",67,0)
 ;IO("Q") is checked by many routines after a call to ^%ZISC, so only clean on call to %ZIS.
"RTN","ZIS",68,0)
CLEAN ;Cleanup env. Called from %ZISC also.
"RTN","ZIS",69,0)
 ; ZEXCEPT: IOPAR,IOT,IOUPAR
"RTN","ZIS",70,0)
 I $G(IOT)'="SPL" K IO("DOC"),IO("SPOOL") ;(p440)
"RTN","ZIS",71,0)
 I $G(IOT)'="HFS" K IO("HFSIO") ;p440
"RTN","ZIS",72,0)
 S (IOPAR,IOUPAR)=""
"RTN","ZIS",73,0)
 Q
"RTN","ZIS",74,0)
RESETVAR ;Reset home IO* variables.
"RTN","ZIS",75,0)
 ; ZEXCEPT: POP
"RTN","ZIS",76,0)
 I '$D(^XUTL("XQ",$J,"IO")) Q
"RTN","ZIS",77,0)
 N %
"RTN","ZIS",78,0)
 F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY","IOPAR","IOUPAR" I $D(^XUTL("XQ",$J,%))#2 S @%=^(%)
"RTN","ZIS",79,0)
 F %="IO(""IP"")","IO(""CLNM"")","IO(""DOC"")","IO(""HFSIO"")","IO(""SPOOL"")" I $D(^XUTL("XQ",$J,%))#2 S @%=^(%)
"RTN","ZIS",80,0)
 S POP=0,IO(0)=IO
"RTN","ZIS",81,0)
 Q
"RTN","ZIS",82,0)
SAVEVAR ;Save home IO* variables, called from XUS1,%ZTMS3
"RTN","ZIS",83,0)
 N %
"RTN","ZIS",84,0)
 F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY","IOPAR","IOUPAR" I $D(@%) S ^XUTL("XQ",$J,%)=@%
"RTN","ZIS",85,0)
 F %="IO(""IP"")","IO(""CLNM"")","IO(""DOC"")","IO(""HFSIO"")","IO(""SPOOL"")" I $D(@%) S ^XUTL("XQ",$J,%)=@%
"RTN","ZIS",86,0)
 Q
"RTN","ZIS",87,0)
ZISLPC Q  ;No longer called in Kernel v8.
"RTN","ZIS",88,0)
HLP1 G EN1^%ZIS7
"RTN","ZIS",89,0)
HLP2 ;
"RTN","ZIS",90,0)
 ; ZEXCEPT: DTIME
"RTN","ZIS",91,0)
 N %E,%H,%X,%ZISV,X,%ZISDTIM
"RTN","ZIS",92,0)
 S %ZISDTIM=$G(DTIME,60),%ZISV=$S($D(^%ZOSF("VOL")):^("VOL"),1:"") G EN2^%ZIS7
"RTN","ZIS",93,0)
REWIND(IO2,IOT,IOPAR) ;Rewind Device
"RTN","ZIS",94,0)
 N %,X,Y,$ES,$ET S $ET="D REWERR^%ZIS Q 0"
"RTN","ZIS",95,0)
 S %=$I
"RTN","ZIS",96,0)
 I '($D(IO2)#2)!'$D(IOT)!'$D(IOPAR) Q 0
"RTN","ZIS",97,0)
 I "MT^SDP^HFS"'[IOT Q 0
"RTN","ZIS",98,0)
 S @("Y=$$REW"_IOT_"^%ZIS4(IO2,IOPAR)")
"RTN","ZIS",99,0)
 U %
"RTN","ZIS",100,0)
 Q Y
"RTN","ZIS",101,0)
REWERR ;Error encountered
"RTN","ZIS",102,0)
 S IO("ERROR")=$EC
"RTN","ZIS",103,0)
 S $EC="",$ET="Q:$ES>1  S $EC="""" Q 0" S $EC=",U1,"
"RTN","ZIS",104,0)
 Q 0
"RTN","ZISHONT")
0^3^B61304186^B60362647
"RTN","ZISHONT",1,0)
%ZISH ;IHS/PR,SFISC/AC - Host File Control for Cache for VMS/NT/UNIX ;05/22/12  11:01
"RTN","ZISHONT",2,0)
 ;;8.0;KERNEL;**34,65,84,104,191,306,385,440,518,524,546,599**;JUL 10, 1995;Build 8
"RTN","ZISHONT",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZISHONT",4,0)
 ;
"RTN","ZISHONT",5,0)
 ; ZEXCEPT: IOM,IOSL,IOT,POP
"RTN","ZISHONT",6,0)
OPEN(X1,X2,X3,X4,X5,X6)    ;SR. Open Host File
"RTN","ZISHONT",7,0)
 ;X1=handle name
"RTN","ZISHONT",8,0)
 ;X2=directory name \dir\
"RTN","ZISHONT",9,0)
 ;X3=file name
"RTN","ZISHONT",10,0)
 ;X4=file access mode e.g.: W for write, R for read, A for append.
"RTN","ZISHONT",11,0)
 ;X5=Max record size for a new file, X6=Subtype
"RTN","ZISHONT",12,0)
 N %,%1,%2,%I,%ZOS,%T,%ZA,%ZISHIO,$ET
"RTN","ZISHONT",13,0)
 S $ET="D OPNERR^%ZISH"
"RTN","ZISHONT",14,0)
 S U="^",%I=$I,%T=0,POP=0,X2=$$DEFDIR($G(X2)),%ZOS=$$OS^%ZOSV M %ZISHIO=IO
"RTN","ZISHONT",15,0)
 I %ZOS'="VMS" S %1=$S(X4["A":"AW",X4["W":"WN",1:"R")_$S(X4["B":"U",1:"S") ;NT & Unix
"RTN","ZISHONT",16,0)
 I %ZOS="VMS" S %1=$S(X4["A":"AW",X4["W":"WN",1:"RH")_$S(X4["B":"U",1:"S")
"RTN","ZISHONT",17,0)
 ;The next line eliminates the <ENDOFFILE> error for sequential files for the current process.
"RTN","ZISHONT",18,0)
 S %ZA=$$ENDOFILE^%ZISUTL ;p599 Work like DSM
"RTN","ZISHONT",19,0)
 S %=X2_X3 O %:(%1):2 I '$T S POP=1 Q
"RTN","ZISHONT",20,0)
 S IO=%,IO(1,IO)="",IOT="HFS",IOM=80,IOSL=60,POP=0 D SUBTYPE^%ZIS3($G(X6,"P-OTHER"))
"RTN","ZISHONT",21,0)
 I $G(X1)]"" D SAVDEV^%ZISUTL(X1)
"RTN","ZISHONT",22,0)
 Q
"RTN","ZISHONT",23,0)
 ;
"RTN","ZISHONT",24,0)
OPNERR ;Handle open error
"RTN","ZISHONT",25,0)
 ; ZEXCEPT: POP
"RTN","ZISHONT",26,0)
 S POP=1,$ECODE=""
"RTN","ZISHONT",27,0)
 ;I $L($G(%I)) U %I
"RTN","ZISHONT",28,0)
 Q
"RTN","ZISHONT",29,0)
 ;
"RTN","ZISHONT",30,0)
CLOSE(X) ;SR. Close HFS device not opened by %ZIS.
"RTN","ZISHONT",31,0)
 ;X=HANDLE NAME
"RTN","ZISHONT",32,0)
 ;IO=Device
"RTN","ZISHONT",33,0)
 N %
"RTN","ZISHONT",34,0)
 I $L($G(IO)) C IO K IO(1,IO)
"RTN","ZISHONT",35,0)
 I $L($G(X)) D RMDEV^%ZISUTL(X)
"RTN","ZISHONT",36,0)
 ;Only reset home if one setup.
"RTN","ZISHONT",37,0)
 I $D(IO("HOME"))!$D(^XUTL("XQ",$J,"IOS")) D HOME^%ZIS
"RTN","ZISHONT",38,0)
 Q
"RTN","ZISHONT",39,0)
 ;
"RTN","ZISHONT",40,0)
OPENERR ;
"RTN","ZISHONT",41,0)
 Q 0
"RTN","ZISHONT",42,0)
 ;
"RTN","ZISHONT",43,0)
DEL(%ZX1,%ZX2) ;ef,SR. Del files, return 1 if deleted all requested.
"RTN","ZISHONT",44,0)
 ;S Y=$$DEL^%ZISH("dir path",$NA(array))
"RTN","ZISHONT",45,0)
 ; will invoke an OS command to delete file(s)
"RTN","ZISHONT",46,0)
 ; UNIX: rm -f filespec[ ...]
"RTN","ZISHONT",47,0)
 ; VMS: del filespec[,...]
"RTN","ZISHONT",48,0)
 N %ZARG,%ZXDEL,%ZOS,%ZDELIM,%ZCOMND,%ZLIST
"RTN","ZISHONT",49,0)
 S %ZARG="",%ZXDEL=1
"RTN","ZISHONT",50,0)
 S %ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHONT",51,0)
 S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",52,0)
 S %ZDELIM=$S(%ZOS="UNIX":" ",1:",")
"RTN","ZISHONT",53,0)
 S %ZCOMND=$S(%ZOS="UNIX":"rm -f ",1:"del ")
"RTN","ZISHONT",54,0)
 D
"RTN","ZISHONT",55,0)
 . N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHONT",56,0)
 . N %,%ZI,%ZISH,%ZX,%ZFOUND S %ZISH=""
"RTN","ZISHONT",57,0)
 . F %ZI=1:1 S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHONT",58,0)
 . . N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHONT",59,0)
 . . I %ZISH["*" S %ZXDEL=0 Q  ; Wild card not allowed.
"RTN","ZISHONT",60,0)
 . . S %ZX=$S(%ZISH[%ZX1:%ZISH,1:%ZX1_%ZISH) ; prepend directory path
"RTN","ZISHONT",61,0)
 . . I %ZOS="VMS",%ZX'[";" S %ZX=%ZX_";*"
"RTN","ZISHONT",62,0)
 . . S %ZFOUND=$ZSEARCH(%ZX)]""  ; File exists
"RTN","ZISHONT",63,0)
 . . S:%ZFOUND %ZARG=$S(%ZARG="":%ZX,1:%ZARG_%ZDELIM_%ZX) ; join files
"RTN","ZISHONT",64,0)
 . . I $L(%ZARG)>2000 S %=$ZF(-1,%ZCOMND_%ZARG),%ZARG="" H 1 ; delete files at a time
"RTN","ZISHONT",65,0)
 . ;
"RTN","ZISHONT",66,0)
 . I $L(%ZARG) S %=$ZF(-1,%ZCOMND_%ZARG) ; delete remaining files
"RTN","ZISHONT",67,0)
 ;
"RTN","ZISHONT",68,0)
 I %ZXDEL S %ZXDEL='$$LIST(%ZX1,%ZX2,"%ZLIST")
"RTN","ZISHONT",69,0)
 Q %ZXDEL
"RTN","ZISHONT",70,0)
 ;
"RTN","ZISHONT",71,0)
DELERR ;Trap any $ETRAP error, unwind and return.
"RTN","ZISHONT",72,0)
 ; ZEXCEPT: %ZARG,%ZXDEL
"RTN","ZISHONT",73,0)
 S $ETRAP="D UNWIND^%ZTER"
"RTN","ZISHONT",74,0)
 S %ZXDEL=0,%ZARG=""
"RTN","ZISHONT",75,0)
 D UNWIND^%ZTER
"RTN","ZISHONT",76,0)
 Q
"RTN","ZISHONT",77,0)
 ;
"RTN","ZISHONT",78,0)
DEL1(%ZX3) ;ef,SR. Delete one file
"RTN","ZISHONT",79,0)
 N %ZI1,%ZI2
"RTN","ZISHONT",80,0)
 D SPLIT(%ZX3,.%ZI1,.%ZI2) S %ZI2(%ZI2)=""
"RTN","ZISHONT",81,0)
 Q $$DEL(%ZI1,$NA(%ZI2))
"RTN","ZISHONT",82,0)
 ;
"RTN","ZISHONT",83,0)
SPLIT(%I,%O1,%O2) ;Split to path,file
"RTN","ZISHONT",84,0)
 N %ZOS,%D,D S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",85,0)
 I %ZOS["VMS" D  Q
"RTN","ZISHONT",86,0)
 . S D=$S(%I["]":"]",1:":")
"RTN","ZISHONT",87,0)
 . S %O1=$P(%I,D,1)_D,%O2=$P(%I,D,2)
"RTN","ZISHONT",88,0)
 . Q
"RTN","ZISHONT",89,0)
 S %D=$S(%ZOS="UNIX":"/",%ZOS="NT":"\",1:""),%O1="",%O2="" Q:%D=""
"RTN","ZISHONT",90,0)
 S D=$L(%I,%D),%O1=$P(%I,%D,1,D-1),%O2=$P(%I,%D,D)
"RTN","ZISHONT",91,0)
 Q
"RTN","ZISHONT",92,0)
 ;
"RTN","ZISHONT",93,0)
FEXIST(%PATH,%FL) ;Check if files exsist.
"RTN","ZISHONT",94,0)
 ;S Y=$$DTEST("/usr/var",$NA(array))
"RTN","ZISHONT",95,0)
 N %ZISH,%ZISHY
"RTN","ZISHONT",96,0)
 S %ZISH=$$LIST(%PATH,%FL,"%ZISHY")
"RTN","ZISHONT",97,0)
 Q %ZISH
"RTN","ZISHONT",98,0)
 ;
"RTN","ZISHONT",99,0)
LIST(%ZX1,%ZX2,%ZX3) ;ef,SR. Create a local array holding file names
"RTN","ZISHONT",100,0)
 ;S Y=$$LIST^%ZISH("\dir\",$NA(array),$NA(return array)) Return 1 if found anything
"RTN","ZISHONT",101,0)
 ;
"RTN","ZISHONT",102,0)
 N %ZISH,%ZISHN,%ZX,%ZISHY,%ZY,%ZOS
"RTN","ZISHONT",103,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZOS=$$OS^%ZOSV
"RTN","ZISHONT",104,0)
 ;S %ZX1=$$TRNLNM(%ZX1)
"RTN","ZISHONT",105,0)
 ;Get fls to act on
"RTN","ZISHONT",106,0)
 S %ZISH="" F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHONT",107,0)
 . S %ZISHY=$P(%ZISH,"*")
"RTN","ZISHONT",108,0)
 . I %ZOS="VMS",%ZISH'["." S %ZISH=%ZISH_".*" ;Allways upper
"RTN","ZISHONT",109,0)
 . ;NT, display case, ignore for lookup
"RTN","ZISHONT",110,0)
 . S %ZX=%ZX1_%ZISH
"RTN","ZISHONT",111,0)
 . F %ZISHN=0:1 D  Q:(%ZX="")
"RTN","ZISHONT",112,0)
 . . S %ZX=$ZSEARCH($S(%ZISHN:"",1:%ZX))
"RTN","ZISHONT",113,0)
 . . ;Q:(%ZX="")!($$UP^XLFSTR(%ZX)'[%ZISHY)!(%ZX?.E1.2".")
"RTN","ZISHONT",114,0)
 . . Q:(%ZX="")!(%ZX?.E1.2".")
"RTN","ZISHONT",115,0)
 . . I %ZOS="VMS" S %ZX=$P(%ZX,"]",2),@%ZX3@(%ZX)=""
"RTN","ZISHONT",116,0)
 . . I %ZOS="NT" S %ZY=$P(%ZX,"\",$L(%ZX,"\")),@%ZX3@(%ZY)=""
"RTN","ZISHONT",117,0)
 . . I %ZOS="UNIX" S %ZY=$P(%ZX,"/",$L(%ZX,"/")) Q:%ZX'[%ZISHY  S @%ZX3@(%ZY)=""
"RTN","ZISHONT",118,0)
 . . Q
"RTN","ZISHONT",119,0)
 Q $O(@%ZX3@(""))]""
"RTN","ZISHONT",120,0)
 ;
"RTN","ZISHONT",121,0)
MV(X1,X2,Y1,Y2) ;ef,SR. Rename a fl
"RTN","ZISHONT",122,0)
 ;S Y=$$MV^ZOSHDOS("\dir\","fl","\dir\","fl")
"RTN","ZISHONT",123,0)
 ;Unix use mv, NT/VMS use COPY and DEL
"RTN","ZISHONT",124,0)
 N %,X,Y,%ZOS,%ZISHX S %ZOS=$$OS^%ZOSV
"RTN","ZISHONT",125,0)
 S X1=$$DEFDIR($G(X1)),Y1=$$DEFDIR($G(Y1))
"RTN","ZISHONT",126,0)
 S X=$ZSEARCH(X1_X2),Y=Y1_Y2 ;move X to Y
"RTN","ZISHONT",127,0)
 I X="" Q 0
"RTN","ZISHONT",128,0)
 ;Move to same place can delete file. Since at destination return 1
"RTN","ZISHONT",129,0)
 I $P(X,";")=Y Q 1
"RTN","ZISHONT",130,0)
 S %=$ZF(-1,$S(%ZOS="UNIX":"mv ",1:"copy ")_X_" "_Y) ;Use NT/VMS copy
"RTN","ZISHONT",131,0)
 I %ZOS'="UNIX" D
"RTN","ZISHONT",132,0)
 . S X2=$P(X,X1,2),%ZISHX(X2)=""
"RTN","ZISHONT",133,0)
 . S Y=$$DEL^%ZISH(X1,$NA(%ZISHX))
"RTN","ZISHONT",134,0)
 Q 1
"RTN","ZISHONT",135,0)
 ;
"RTN","ZISHONT",136,0)
PWD() ;ef,SR. Print working directory
"RTN","ZISHONT",137,0)
 N Y,%ZOS
"RTN","ZISHONT",138,0)
 S Y=$$DEFDIR(""),%ZOS=$$OS^%ZOSV
"RTN","ZISHONT",139,0)
 I Y="" S Y=$ZSEARCH("*")
"RTN","ZISHONT",140,0)
 Q $S(%ZOS["VMS":Y,1:$P(Y,".",1))
"RTN","ZISHONT",141,0)
 ;
"RTN","ZISHONT",142,0)
TRNLNM(PATH) ;ef. Expand logical path
"RTN","ZISHONT",143,0)
 N %ZOS,P1,P2
"RTN","ZISHONT",144,0)
 S %ZOS=$$OS^%ZOSV,PATH=$G(PATH)
"RTN","ZISHONT",145,0)
 I %ZOS="VMS" D  Q PATH
"RTN","ZISHONT",146,0)
 . S P1=PATH_$S(PATH[":":"*.*",1:":*.*")
"RTN","ZISHONT",147,0)
 . S P2=$ZSEARCH(P1)
"RTN","ZISHONT",148,0)
 . S:$L(P2) PATH=$S(P2["]":$P(P2,"]",1,$L(P2,"]")-1)_"]",1:$P(P2,":",1)_":")
"RTN","ZISHONT",149,0)
 . Q
"RTN","ZISHONT",150,0)
 I %ZOS="NT" D  Q PATH
"RTN","ZISHONT",151,0)
 . S P1=PATH_$S($E(PATH,$L(PATH))'="\":"\*",1:"*"),P2=$ZSEARCH(P1)
"RTN","ZISHONT",152,0)
 . S:$L(P2) PATH=$P(P2,"\",1,$L(P2,"\")-1)_"\"
"RTN","ZISHONT",153,0)
 . Q
"RTN","ZISHONT",154,0)
 ;Unix Cache $ZSEARCH uses % around an environment variable
"RTN","ZISHONT",155,0)
 I %ZOS="UNIX" D  Q PATH
"RTN","ZISHONT",156,0)
 . S P1=PATH_$S($E(PATH,$L(PATH))'="/":"/*",1:"*"),P2=$ZSEARCH(P1)
"RTN","ZISHONT",157,0)
 . S:$L(P2) PATH=$P(P2,"/",1,$L(P2,"/")-1)_"/"
"RTN","ZISHONT",158,0)
 . Q
"RTN","ZISHONT",159,0)
 Q PATH
"RTN","ZISHONT",160,0)
 ;
"RTN","ZISHONT",161,0)
DEFDIR(DF) ;ef. Default Dir and frmt
"RTN","ZISHONT",162,0)
 ;Need to handle NT, VMS and Linux
"RTN","ZISHONT",163,0)
 N %ZOS,P1,P2 S %ZOS=$$OS^%ZOSV,DF=$G(DF)
"RTN","ZISHONT",164,0)
 Q:DF="." "" ;Special way to get current dir.
"RTN","ZISHONT",165,0)
 S:DF="" DF=$G(^XTV(8989.3,1,"DEV")),DF=$P(DF,"^",$S($$PRI^%ZOSV<2:1,1:2))
"RTN","ZISHONT",166,0)
 Q:DF="" ""
"RTN","ZISHONT",167,0)
 ;Check syntax, VMS needs disk:[dir] or logical:
"RTN","ZISHONT",168,0)
 I %ZOS="VMS" D
"RTN","ZISHONT",169,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHONT",170,0)
 . E  S P1="",P2=DF
"RTN","ZISHONT",171,0)
 . I P1="",P2["$" S P1=P2,P2=""  ;Could be a logical
"RTN","ZISHONT",172,0)
 . I $L(P2) S:P2'["[" P2="["_P2 S:P2'["]" P2=P2_"]"
"RTN","ZISHONT",173,0)
 . S DF=P1_P2 S:DF'[":" DF=DF_":"
"RTN","ZISHONT",174,0)
 . Q
"RTN","ZISHONT",175,0)
 ;Check syntax, Unix needs /mnt/fl, ./fl, ~/fl %HOME%/fl
"RTN","ZISHONT",176,0)
 I %ZOS="UNIX" D
"RTN","ZISHONT",177,0)
 . S DF=$TR(DF,"\","/")
"RTN","ZISHONT",178,0)
 . S:$E(DF,$L(DF))'="/" DF=DF_"/"
"RTN","ZISHONT",179,0)
 . Q
"RTN","ZISHONT",180,0)
 ;Check syntax, NT needs c:\dir\ or \\server\folder\
"RTN","ZISHONT",181,0)
 I %ZOS="NT" D
"RTN","ZISHONT",182,0)
 . N P1,P2
"RTN","ZISHONT",183,0)
 . I '(DF?1(1A1":\",1"\\").E) S DF=$$DEFDIR("")
"RTN","ZISHONT",184,0)
 . S P1="",P2=DF
"RTN","ZISHONT",185,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHONT",186,0)
 . S P2=$TR(P2,"/","\")
"RTN","ZISHONT",187,0)
 . I $L(P2) S:".\"'[$E(P2,1) P2="\"_P2 S:$E(P2,$L(P2))'="\" P2=P2_"\"
"RTN","ZISHONT",188,0)
 . S DF=P1_P2
"RTN","ZISHONT",189,0)
 . Q
"RTN","ZISHONT",190,0)
 S DF=$$TRNLNM(DF) ;Resolve logicals
"RTN","ZISHONT",191,0)
 Q DF
"RTN","ZISHONT",192,0)
 ;
"RTN","ZISHONT",193,0)
FL(X) ;Fl len
"RTN","ZISHONT",194,0)
 N ZOSHP1,ZOSHP2
"RTN","ZISHONT",195,0)
 S ZOSHP1=$P(X,"."),ZOSHP2=$P(X,".",2)
"RTN","ZISHONT",196,0)
 I $L(ZOSHP1)>8 S X=4 Q
"RTN","ZISHONT",197,0)
 I $L(ZOSHP2)>3 S X=4 Q
"RTN","ZISHONT",198,0)
 Q
"RTN","ZISHONT",199,0)
 ;
"RTN","ZISHONT",200,0)
STATUS() ;ef,SR. Return EOF status
"RTN","ZISHONT",201,0)
 U $I
"RTN","ZISHONT",202,0)
 Q $$EOF($ZEOF)
"RTN","ZISHONT",203,0)
 ;
"RTN","ZISHONT",204,0)
EOF(X) ;Eof flag, pass in $ZEOF
"RTN","ZISHONT",205,0)
 Q (X=-1)
"RTN","ZISHONT",206,0)
 ;
"RTN","ZISHONT",207,0)
MAKEREF(HF,IX,OVF) ;Internal call to rebuild global ref.
"RTN","ZISHONT",208,0)
 ;Return %ZISHF,%ZISHO,%ZISHI,%ZISUB
"RTN","ZISHONT",209,0)
 ; ZEXCEPT: %ZISHF,%ZISHI,%ZISHO,%ZISUB
"RTN","ZISHONT",210,0)
 N I,F,MX
"RTN","ZISHONT",211,0)
 S OVF=$G(OVF,"%ZISHOF")
"RTN","ZISHONT",212,0)
 S %ZISHI=$QS(HF,IX),MX=$QL(HF) ;
"RTN","ZISHONT",213,0)
 S F=$NA(@HF,IX-1) ;Get first part
"RTN","ZISHONT",214,0)
 I IX=1 S %ZISHF=F_"(%ZISHI" ;Build root, IX=1
"RTN","ZISHONT",215,0)
 I IX>1 S %ZISHF=$E(F,1,$L(F)-1)_",%ZISHI" ;Build root
"RTN","ZISHONT",216,0)
 S %ZISHO=%ZISHF_","_OVF_",%OVFCNT)" ;Make overflow
"RTN","ZISHONT",217,0)
 F I=IX+1:1:MX S %ZISHF=%ZISHF_",%ZISUB("_I_")",%ZISUB(I)=$QS(HF,I)
"RTN","ZISHONT",218,0)
 S %ZISHF=%ZISHF_")"
"RTN","ZISHONT",219,0)
 Q
"RTN","ZISHONT",220,0)
 ;
"RTN","ZISHONT",221,0)
READNXT(REC) ;Read any sized record into array. %ZB has terminator
"RTN","ZISHONT",222,0)
 ; ZEXCEPT: %ZB
"RTN","ZISHONT",223,0)
 N %,I,X,$ES,$ET S REC="",$ET="D READNX^%ZISH Q"
"RTN","ZISHONT",224,0)
 U IO R X:5 S %ZB=$A($ZB),REC=$E(X,1,255)
"RTN","ZISHONT",225,0)
 Q:$L(X)<256
"RTN","ZISHONT",226,0)
 S %=256 F I=1:1 Q:$L(X)<%  S REC(I)=$E(X,%,%+254),%=%+255
"RTN","ZISHONT",227,0)
 Q
"RTN","ZISHONT",228,0)
READNX ;Check for EOF
"RTN","ZISHONT",229,0)
 ; ZEXCEPT: %ZA
"RTN","ZISHONT",230,0)
 I $ZE["ENDOFFILE" S %ZA=-1
"RTN","ZISHONT",231,0)
 S $EC=""
"RTN","ZISHONT",232,0)
 Q
"RTN","ZISHONT",233,0)
 ;
"RTN","ZISHONT",234,0)
FTG(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;ef,SR. Unload contents of host file into global
"RTN","ZISHONT",235,0)
 ;p1=hostf file directory
"RTN","ZISHONT",236,0)
 ;p2=host file name
"RTN","ZISHONT",237,0)
 ;p3= $NAME REFERENCE INCLUDING STARTING SUBSCRIPT
"RTN","ZISHONT",238,0)
 ;p4=INCREMENT SUBSCRIPT
"RTN","ZISHONT",239,0)
 ;p5=Overflow subscript, defaults to "OVF"
"RTN","ZISHONT",240,0)
 N %ZA,%ZB,%ZC,%XX,%OVFCNT,%ZISHF,%ZISHO,POP,%ZISUB,$ES,$ET
"RTN","ZISHONT",241,0)
 N I,%ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHOF,%ZISHOX,%ZISHS,%ZX,%ZISHY
"RTN","ZISHONT",242,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZISHOF=$G(%ZX5,"OVF")
"RTN","ZISHONT",243,0)
 D MAKEREF(%ZX3,%ZX4,"%ZISHOF")
"RTN","ZISHONT",244,0)
 D OPEN^%ZISH(,%ZX1,%ZX2,"R")
"RTN","ZISHONT",245,0)
 I POP Q 0
"RTN","ZISHONT",246,0)
 S %ZC=1,%ZA=0,$ET="S %ZC=0,%ZA=-1,$EC="""" Q"
"RTN","ZISHONT",247,0)
 U IO F  K %XX D READNXT(.%XX) Q:$$EOF($ZEOF)!%ZA  D
"RTN","ZISHONT",248,0)
 . S @%ZISHF=%XX
"RTN","ZISHONT",249,0)
 . I $D(%XX)>2 F %OVFCNT=1:1 Q:'$D(%XX(%OVFCNT))  S @%ZISHO=%XX(%OVFCNT)
"RTN","ZISHONT",250,0)
 . S %ZISHI=%ZISHI+1
"RTN","ZISHONT",251,0)
 . Q
"RTN","ZISHONT",252,0)
 D CLOSE() ;Normal exit
"RTN","ZISHONT",253,0)
 Q %ZC
"RTN","ZISHONT",254,0)
 ;
"RTN","ZISHONT",255,0)
GTF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Load contents of global to host file.
"RTN","ZISHONT",256,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",257,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",258,0)
 ;p3=host file directory
"RTN","ZISHONT",259,0)
 ;p4=host file name
"RTN","ZISHONT",260,0)
 N %ZISHY,%ZISHOX
"RTN","ZISHONT",261,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,%ZX3,%ZX4,"W")
"RTN","ZISHONT",262,0)
 Q %ZISHY
"RTN","ZISHONT",263,0)
 ;
"RTN","ZISHONT",264,0)
GATF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Append to host file.
"RTN","ZISHONT",265,0)
 ;
"RTN","ZISHONT",266,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",267,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",268,0)
 ;p3=host file directory
"RTN","ZISHONT",269,0)
 ;p4=host file name
"RTN","ZISHONT",270,0)
 N %ZISHY
"RTN","ZISHONT",271,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,%ZX3,%ZX4,"A")
"RTN","ZISHONT",272,0)
 Q %ZISHY
"RTN","ZISHONT",273,0)
 ;
"RTN","ZISHONT",274,0)
MGTF(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;
"RTN","ZISHONT",275,0)
 ;p1=$NAME of global reference
"RTN","ZISHONT",276,0)
 ;p2=incrementing subscript
"RTN","ZISHONT",277,0)
 ;p3=host file directory
"RTN","ZISHONT",278,0)
 ;p4=host file name
"RTN","ZISHONT",279,0)
 ; ZEXCEPT: %ZISHF,POP
"RTN","ZISHONT",280,0)
 N %ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHS,%ZISHOX,IO,%ZX,Y,%ZC
"RTN","ZISHONT",281,0)
 D MAKEREF(%ZX1,%ZX2)
"RTN","ZISHONT",282,0)
 D OPEN^%ZISH(,$G(%ZX3),%ZX4,%ZX5) ;Default dir set in open
"RTN","ZISHONT",283,0)
 I POP Q 0
"RTN","ZISHONT",284,0)
 N $ETRAP S $ETRAP="S $EC="""" D CLOSE^%ZISH() Q 0"
"RTN","ZISHONT",285,0)
 F  Q:'($D(@%ZISHF)#2)  S %ZX=@%ZISHF,%ZISHI=%ZISHI+1 U IO W %ZX,!
"RTN","ZISHONT",286,0)
 D CLOSE()
"RTN","ZISHONT",287,0)
 Q 1
"RTN","ZISHONT",288,0)
 ;
"RTN","ZISUTL")
0^4^B12853409^B10953558
"RTN","ZISUTL",1,0)
%ZISUTL ;ISD/HGW - Device Handler Utility routine ;05/22/12  10:22
"RTN","ZISUTL",2,0)
 ;;8.0;KERNEL;**18,24,34,69,118,127,199,275,425,599**;JUL 10, 1995;Build 8
"RTN","ZISUTL",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","ZISUTL",4,0)
 ; Unit test routine ^ZZUTZI00
"RTN","ZISUTL",5,0)
 Q  ;No entry from top
"RTN","ZISUTL",6,0)
GETDEV(X) ;Return IO variables
"RTN","ZISUTL",7,0)
 ; ZEXCEPT: POP
"RTN","ZISUTL",8,0)
 I '$D(^TMP("XUDEVICE",$J,X)) S POP=1 Q
"RTN","ZISUTL",9,0)
 ;Cleanup first
"RTN","ZISUTL",10,0)
 N % K IO("S")
"RTN","ZISUTL",11,0)
 D SYMBOL("K") ;Kill first
"RTN","ZISUTL",12,0)
 D SYMBOL(1,$NA(^TMP("XUDEVICE",$J,X)))
"RTN","ZISUTL",13,0)
 Q
"RTN","ZISUTL",14,0)
SAVDEV(NM) ;Save IO variables
"RTN","ZISUTL",15,0)
 ;NM=Handle name
"RTN","ZISUTL",16,0)
 N %,Y,R
"RTN","ZISUTL",17,0)
 I $G(IO)="" Q
"RTN","ZISUTL",18,0)
 S Y=$$FINDEV(NM) I 'Y S Y=$$NEXTDEV(NM)
"RTN","ZISUTL",19,0)
 S R=$NA(^TMP("XUDEVICE",$J,Y)) K @R ;Clear
"RTN","ZISUTL",20,0)
 S @R@(0)=NM
"RTN","ZISUTL",21,0)
 D SYMBOL(0,R)
"RTN","ZISUTL",22,0)
 Q
"RTN","ZISUTL",23,0)
SYMBOL(MODE,ROOT) ;0=Save, 1=Restore, K=Kill IO variables
"RTN","ZISUTL",24,0)
 N %
"RTN","ZISUTL",25,0)
 ;Handle IO as special case.  Don't want to kill all of IO.
"RTN","ZISUTL",26,0)
 I MODE=0 S:$D(IO)#2 @ROOT@("IO")=IO
"RTN","ZISUTL",27,0)
 I MODE=1 S:$D(@ROOT@("IO")) IO=@ROOT@("IO")
"RTN","ZISUTL",28,0)
 F %="IO(""DOC"")","IO(""HFSIO"")","IO(""Q"")","IO(""S"")","IO(""SPOOL"")","IO(""ZIO"")","IOBS","IOCPU","IOF","IOHG","IOM","ION","IOPAR","IOUPAR","IOS","IOSL","IOST","IOST(0)","IOT","IOXY" D
"RTN","ZISUTL",29,0)
 . I MODE=0 S:$D(@%)#2 @ROOT@(%)=@% Q
"RTN","ZISUTL",30,0)
 . I MODE=1 S:$D(@ROOT@(%)) @%=@ROOT@(%) Q
"RTN","ZISUTL",31,0)
 . I MODE="K" K @%
"RTN","ZISUTL",32,0)
 . Q
"RTN","ZISUTL",33,0)
 Q
"RTN","ZISUTL",34,0)
RMDEV(X) ;Remove saved IO variables.
"RTN","ZISUTL",35,0)
 N Y
"RTN","ZISUTL",36,0)
 S Y=$$FINDEV(X)
"RTN","ZISUTL",37,0)
 Q:'Y
"RTN","ZISUTL",38,0)
 K ^TMP("XUDEVICE",$J,"B",X),^TMP("XUDEVICE",$J,+Y)
"RTN","ZISUTL",39,0)
 Q
"RTN","ZISUTL",40,0)
RMALLDEV() ;Remove saved IO variables for all devices saved in table.
"RTN","ZISUTL",41,0)
 K ^TMP("XUDEVICE",$J)
"RTN","ZISUTL",42,0)
 Q 1
"RTN","ZISUTL",43,0)
FINDEV(NM) ;Find Device name and return IEN.
"RTN","ZISUTL",44,0)
 Q $O(^TMP("XUDEVICE",$J,"B",NM,0))
"RTN","ZISUTL",45,0)
NEXTDEV(NM) ;Return next available device.
"RTN","ZISUTL",46,0)
 N Y
"RTN","ZISUTL",47,0)
 F Y=1:1 Q:'$D(^TMP("XUDEVICE",$J,Y))
"RTN","ZISUTL",48,0)
 S ^TMP("XUDEVICE",$J,"B",NM,Y)=""
"RTN","ZISUTL",49,0)
 Q Y
"RTN","ZISUTL",50,0)
OPEN(HNDL,IOP,%ZIS) ;Open extrinsic function
"RTN","ZISUTL",51,0)
 ;Parameters
"RTN","ZISUTL",52,0)
 ;HNDL=Handle name
"RTN","ZISUTL",53,0)
 ;IOP string--optional
"RTN","ZISUTL",54,0)
 ;%ZIS string--optional
"RTN","ZISUTL",55,0)
 N %
"RTN","ZISUTL",56,0)
 I $G(IOP)="" K IOP ;Remove IOP if null.
"RTN","ZISUTL",57,0)
 D ^%ZIS,SAVDEV(HNDL):POP=0
"RTN","ZISUTL",58,0)
 Q
"RTN","ZISUTL",59,0)
CLOSE(X1) ;Close extrinsic function
"RTN","ZISUTL",60,0)
 ;X1=Handle
"RTN","ZISUTL",61,0)
 N %,Y
"RTN","ZISUTL",62,0)
 S Y=$$FINDEV(X1)
"RTN","ZISUTL",63,0)
 Q:'Y
"RTN","ZISUTL",64,0)
 D GETDEV(Y)
"RTN","ZISUTL",65,0)
 D ^%ZISC,RMDEV(X1)
"RTN","ZISUTL",66,0)
 Q
"RTN","ZISUTL",67,0)
USE(X1) ;Restore IO* variables pertaining to the device.
"RTN","ZISUTL",68,0)
 ;X1=Handle name
"RTN","ZISUTL",69,0)
 ; ZEXCEPT: IOT
"RTN","ZISUTL",70,0)
 N %,Y
"RTN","ZISUTL",71,0)
 S Y=$$FINDEV^%ZISUTL(X1)
"RTN","ZISUTL",72,0)
 Q:'Y
"RTN","ZISUTL",73,0)
 D GETDEV^%ZISUTL(Y)
"RTN","ZISUTL",74,0)
 I $G(IOT)'="RES" U $S($D(IO(1,IO)):IO,1:IO(0))
"RTN","ZISUTL",75,0)
 K IO("CLOSE")
"RTN","ZISUTL",76,0)
 Q
"RTN","ZISUTL",77,0)
LINEPORT() ;Return device name for line port.
"RTN","ZISUTL",78,0)
 N %
"RTN","ZISUTL",79,0)
 S %=$$LNPRTIEN^%ZISUTL($$LNPRTNAM^%ZISUTL)
"RTN","ZISUTL",80,0)
 Q +$P($G(^%ZIS(3.23,+%,0)),"^",3)
"RTN","ZISUTL",81,0)
LNPRTSUB() ;Return line port subtype pointer.
"RTN","ZISUTL",82,0)
 N %
"RTN","ZISUTL",83,0)
 S %=$$LNPRTIEN^%ZISUTL($$LNPRTNAM^%ZISUTL)
"RTN","ZISUTL",84,0)
 Q +$P($G(^%ZIS(3.23,+%,0)),"^",4)
"RTN","ZISUTL",85,0)
LNPRTNAM() ;Return Line port name
"RTN","ZISUTL",86,0)
 N Y,%
"RTN","ZISUTL",87,0)
 S Y="",%=$G(^%ZOSF("OS"))
"RTN","ZISUTL",88,0)
 I %["VAX DSM"!(%["OpenM-NT") D
"RTN","ZISUTL",89,0)
 .S Y=$ZIO
"RTN","ZISUTL",90,0)
 E  I %["MSM" X "S Y=$ZDEV($I)"
"RTN","ZISUTL",91,0)
 Q Y
"RTN","ZISUTL",92,0)
LNPRTIEN(X) ;Return internal entry number of Line/port
"RTN","ZISUTL",93,0)
 Q:X'?1AN.29ANP 0
"RTN","ZISUTL",94,0)
 Q $O(^%ZIS(3.23,"B",X,0))
"RTN","ZISUTL",95,0)
LNPRTADR(X) ;Returns Line/Port name of a fixed device.
"RTN","ZISUTL",96,0)
 N %,Y
"RTN","ZISUTL",97,0)
 S Y=""
"RTN","ZISUTL",98,0)
 S %=$O(^%ZIS(1,"B",X,0))
"RTN","ZISUTL",99,0)
 S %=$O(^%ZIS(3.23,"C",+%,0))
"RTN","ZISUTL",100,0)
 I %,$G(^%ZIS(3.23,+%,0))]"" S Y=$P(^(0),"^")
"RTN","ZISUTL",101,0)
 Q Y
"RTN","ZISUTL",102,0)
FIND(IOP) ;e.f. Get the IEN of a device
"RTN","ZISUTL",103,0)
 N %XX,%YY,%ZIS,%ZISV
"RTN","ZISUTL",104,0)
 S %ZISV=^%ZOSF("VOL"),%XX=$$UP^%ZIS1(IOP) D 1^%ZIS5
"RTN","ZISUTL",105,0)
 Q %YY
"RTN","ZISUTL",106,0)
NOQ(IOP) ;e.f. Return queueing status
"RTN","ZISUTL",107,0)
 ;Call with Device name, Return 1 if NO QUEUE, Else 0.
"RTN","ZISUTL",108,0)
 N %X,%Y S %X=$$FIND(IOP) Q:%X'>0 0
"RTN","ZISUTL",109,0)
 S %Y=$P($G(^%ZIS(1,%X,0)),U,12)
"RTN","ZISUTL",110,0)
 Q %Y=2
"RTN","ZISUTL",111,0)
UNIQUE(ZISNA) ;Build a unique number to add to a device name
"RTN","ZISUTL",112,0)
 ;If passed a name put the number before the last dot.
"RTN","ZISUTL",113,0)
 N %,%1,%2
"RTN","ZISUTL",114,0)
 S %2=$INCREMENT(^TMP("ZISUTL",$J))  ;Kernel exemption, allowed to use $INCREMENT
"RTN","ZISUTL",115,0)
 S %=$H,%=$H_"-"_$J,%=$$CRC32^XLFCRC(%)_"-"_%2
"RTN","ZISUTL",116,0)
 I '$L($G(ZISNA)) Q %
"RTN","ZISUTL",117,0)
 S %1=$L(ZISNA,"."),%="_"_%
"RTN","ZISUTL",118,0)
 S:%1=1 %=ZISNA_% S:%1>1 %=$P(ZISNA,".",1,%1-1)_%_"."_$P(ZISNA,".",%1)
"RTN","ZISUTL",119,0)
 Q %
"RTN","ZISUTL",120,0)
ENDOFILE() ;p599 Set Cache end-of-file to work like DSM
"RTN","ZISUTL",121,0)
 ;Return 1 if mode was changed, 0 if unchanged
"RTN","ZISUTL",122,0)
 N %
"RTN","ZISUTL",123,0)
 I $$VERSION^%ZOSV(1)["Cache" D  Q 1
"RTN","ZISUTL",124,0)
 .I +$$VERSION^%ZOSV>2010 X "D $SYSTEM.Process.SetZEOF(1)"
"RTN","ZISUTL",125,0)
 .I +$$VERSION^%ZOSV'>2010 S %=$ZUTIL(68,40,1)
"RTN","ZISUTL",126,0)
 Q 0
"VER")
8.0^22.0
"BLD",1442,6)
^481
**END**
**END**
