Released XU*8*593 SEQ #482
Extracted from mail message
**KIDS**:XU*8.0*593^

**INSTALL NAME**
XU*8.0*593
"BLD",1436,0)
XU*8.0*593^KERNEL^0^3120502^y
"BLD",1436,1,0)
^^1^1^3120501^
"BLD",1436,1,1,0)
See patch description on FORUM for XU*8.0*593 for details.
"BLD",1436,4,0)
^9.64PA^^
"BLD",1436,6.3)
7
"BLD",1436,"KRN",0)
^9.67PA^9002226^21
"BLD",1436,"KRN",.4,0)
.4
"BLD",1436,"KRN",.401,0)
.401
"BLD",1436,"KRN",.402,0)
.402
"BLD",1436,"KRN",.403,0)
.403
"BLD",1436,"KRN",.5,0)
.5
"BLD",1436,"KRN",.84,0)
.84
"BLD",1436,"KRN",3.6,0)
3.6
"BLD",1436,"KRN",3.8,0)
3.8
"BLD",1436,"KRN",9.2,0)
9.2
"BLD",1436,"KRN",9.8,0)
9.8
"BLD",1436,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1436,"KRN",9.8,"NM",1,0)
XQ^^0^B26234879
"BLD",1436,"KRN",9.8,"NM",2,0)
XQ12^^0^B72908021
"BLD",1436,"KRN",9.8,"NM",3,0)
XQ83^^0^B33804424
"BLD",1436,"KRN",9.8,"NM",4,0)
XQTOC^^0^B17537937
"BLD",1436,"KRN",9.8,"NM","B","XQ",1)

"BLD",1436,"KRN",9.8,"NM","B","XQ12",2)

"BLD",1436,"KRN",9.8,"NM","B","XQ83",3)

"BLD",1436,"KRN",9.8,"NM","B","XQTOC",4)

"BLD",1436,"KRN",19,0)
19
"BLD",1436,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",1436,"KRN",19,"NM",1,0)
XU USER START-UP^^0
"BLD",1436,"KRN",19,"NM","B","XU USER START-UP",1)

"BLD",1436,"KRN",19.1,0)
19.1
"BLD",1436,"KRN",101,0)
101
"BLD",1436,"KRN",409.61,0)
409.61
"BLD",1436,"KRN",771,0)
771
"BLD",1436,"KRN",779.2,0)
779.2
"BLD",1436,"KRN",870,0)
870
"BLD",1436,"KRN",8989.51,0)
8989.51
"BLD",1436,"KRN",8989.52,0)
8989.52
"BLD",1436,"KRN",8994,0)
8994
"BLD",1436,"KRN",9002226,0)
9002226
"BLD",1436,"KRN","B",.4,.4)

"BLD",1436,"KRN","B",.401,.401)

"BLD",1436,"KRN","B",.402,.402)

"BLD",1436,"KRN","B",.403,.403)

"BLD",1436,"KRN","B",.5,.5)

"BLD",1436,"KRN","B",.84,.84)

"BLD",1436,"KRN","B",3.6,3.6)

"BLD",1436,"KRN","B",3.8,3.8)

"BLD",1436,"KRN","B",9.2,9.2)

"BLD",1436,"KRN","B",9.8,9.8)

"BLD",1436,"KRN","B",19,19)

"BLD",1436,"KRN","B",19.1,19.1)

"BLD",1436,"KRN","B",101,101)

"BLD",1436,"KRN","B",409.61,409.61)

"BLD",1436,"KRN","B",771,771)

"BLD",1436,"KRN","B",779.2,779.2)

"BLD",1436,"KRN","B",870,870)

"BLD",1436,"KRN","B",8989.51,8989.51)

"BLD",1436,"KRN","B",8989.52,8989.52)

"BLD",1436,"KRN","B",8994,8994)

"BLD",1436,"KRN","B",9002226,9002226)

"BLD",1436,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",1436,"QUES",0)
^9.62^^
"BLD",1436,"REQB",0)
^9.611^2^2
"BLD",1436,"REQB",1,0)
XU*8.0*553^2
"BLD",1436,"REQB",2,0)
XU*8.0*570^2
"BLD",1436,"REQB","B","XU*8.0*553",1)

"BLD",1436,"REQB","B","XU*8.0*570",2)

"KRN",19,1595,-1)
0^1
"KRN",19,1595,0)
XU USER START-UP^User start-up event^^X^^^^^^^^KERNEL
"KRN",19,1595,1,0)
^^8^8^3120309^
"KRN",19,1595,1,1,0)
This is an option used exclusively during a VistA user sign-on event. 
"KRN",19,1595,1,2,0)
Items listed in this option are "TYPE:action" options in the OPTION file 
"KRN",19,1595,1,3,0)
(#19) that can be used to prompt users for input upon VistA sign-on and 
"KRN",19,1595,1,4,0)
before their Primary Menu Option is displayed. It will not be used for 
"KRN",19,1595,1,5,0)
GUI sign-on. It is called from XQ12.
"KRN",19,1595,1,6,0)
 
"KRN",19,1595,1,7,0)
See patch XU*8.0*593 and the Kernel 8.0 Developer's Guide for 
"KRN",19,1595,1,8,0)
instructions on how to use this option.
"KRN",19,1595,"U")
USER START-UP EVENT
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3090706^3090706^6
"PKG",3,22,1,"PAH",1,0)
593^3120502
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^3120502
"PKG",3,22,1,"PAH",1,1,1,0)
See patch description on FORUM for XU*8.0*593 for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","XQ")
0^1^B26234879^B25124681
"RTN","XQ",1,0)
XQ ; SEA/MJM - Menu driver (Part 1) ;04/19/12  08:27
"RTN","XQ",2,0)
 ;;8.0;KERNEL;**9,46,94,103,157,570,593**;Jul 10, 1995;Build 7
"RTN","XQ",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQ",4,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",5,0)
 D INIT^XQ12 Q:'$D(XQY)
"RTN","XQ",6,0)
 I $D(XQUR),$E(XQUR,1,2)="^^" S XQRB=1,XQJS=4
"RTN","XQ",7,0)
 I '$D(XQJS),$D(XQUR),XQUR'="",XQUR'["[" S:XQUR'[U XQUR=U_XQUR K ^VA(200,DUZ,202.1) S XQJS=0 D ^XQTOC
"RTN","XQ",8,0)
 I $D(XQUR),XQUR["[" K ^VA(200,DUZ,202.1) S XQJS=3,^XUTL("XQ",$J,"T")=1
"RTN","XQ",9,0)
 I $D(^VA(200,DUZ,202.1)),$L($P(^(202.1),U)) S XQJS=1 S %=+^(202.1) S XQUR=$G(^DIC(19,%,"U")) I XQUR]"" D ^XQTOC
"RTN","XQ",10,0)
M I '$D(XQVOL) S XQVOL=$G(^XUTL("XQ",$J,"XQVOL")) I '$L(XQVOL) D GETENV^%ZOSV S XQVOL=$P(Y,U,2)
"RTN","XQ",11,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) S XQNOLOG="" G H^XUS
"RTN","XQ",12,0)
 S:$S('$D(XQY0):1,'$L(XQY0):1,1:0) XQY0=^DIC(19,XQY,0) S XQT=$P(XQY0,U,4) G:XQT="" M3 K:'$D(XQJS) XQUR K X,XQNOGO,XQR,XQUIT,XQUEFLG ;,XQSV
"RTN","XQ",13,0)
 I $D(XQAUDIT),XQAUDIT D LOGOPT^XQ12
"RTN","XQ",14,0)
 ;I $P(XQY0,U,18) D CHKQUE^XQ92 I XQUEFLG S XQNOGO="" ;Removed - p570
"RTN","XQ",15,0)
 I $G(XQY)>0 D CHKQUE^XQ92 I XQUEFLG S XQNOGO="" ;Added - p570
"RTN","XQ",16,0)
 ;
"RTN","XQ",17,0)
 ;Execute the Entry Action and look for XQUIT
"RTN","XQ",18,0)
 D:'$D(XQM3)&("LOQX"'[XQT) LO K XQM3 I $D(XQUIT) D
"RTN","XQ",19,0)
 .S XQUIT=0
"RTN","XQ",20,0)
 .D ^XQUIT
"RTN","XQ",21,0)
 .Q
"RTN","XQ",22,0)
 ;
"RTN","XQ",23,0)
 G:$D(XQUR) ASK1 ;Jump start or continue
"RTN","XQ",24,0)
 I '$D(XQUIT),XQT'="A",$P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ",25,0)
 D:$D(XQXFLG)[0 ABT^XQ12 ;D:$P($G(XQXFLG),U,2) LOGRSRC^%ZOSV($P(XQY0,U))
"RTN","XQ",26,0)
 D:$P(XQY0,U)]"" LOGRSRC^%ZOSV($P(XQY0,U),0,1)
"RTN","XQ",27,0)
 ;A call to PRIO was removed from the following line D:$L($P(XQY0,U,8))
"RTN","XQ",28,0)
 ;Since Kernel no longer resets priority from the Option File
"RTN","XQ",29,0)
 I XQT'="M" W:'^XUTL("XQ",$J,"T") !,$P(XQY0,U,2) W:$D(DUZ("SAV")) !,"Not when testing another's menus." S %=^XUTL("XQ",$J,"T"),^("T")=%+1,^(%+1)=XQY_XQPSM_U_XQY0 G M3:XQT'?1U!$D(DUZ("SAV"))
"RTN","XQ",30,0)
 I XQT'="M" D:'$D(XQXFLG) ABT^XQ12 D:+XQXFLG ABLOG^XQ12 K %,X,XQTT G @(XQT_"^XQ1")
"RTN","XQ",31,0)
M1 ;
"RTN","XQ",32,0)
 D LOGRSRC^%ZOSV("$XQ MENU DRIVER$",0,1)
"RTN","XQ",33,0)
 Q:XQY<1!'$D(^XUTL("XQ",$J,"T"))  D:'$D(XQXFLG) ABT^XQ12
"RTN","XQ",34,0)
 ;Modified - p593 to display <TEST ACCOUNT> if not a production VistA system
"RTN","XQ",35,0)
 ;D:'$D(XQABOLD)&(+XQXFLG) ABLOG^XQ12 K XQABOLD W ! S XQUR=0,XQTT=^XUTL("XQ",$J,"T"),XQDIC=XQY,XQAA="Select "_$S($D(DUZ("SAV")):$P(DUZ("SAV"),U,3)_"'s ",1:"")_$P(XQY0,U,2)_" Option: " S:$D(XQMM("B")) XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",36,0)
 S XQXQTEST=$S($D(DUZ("TEST")):" <TEST ACCOUNT>",1:"")
"RTN","XQ",37,0)
 D:'$D(XQABOLD)&(+XQXFLG) ABLOG^XQ12 K XQABOLD W ! S XQUR=0,XQTT=^XUTL("XQ",$J,"T"),XQDIC=XQY S XQAA="Select "_$S($D(DUZ("SAV")):$P(DUZ("SAV"),U,3)_"'s ",1:"")_$P(XQY0,U,2)
"RTN","XQ",38,0)
 S XQAA=XQAA_XQXQTEST_" Option: " S:$D(XQMM("B")) XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",39,0)
 K XQXQTEST
"RTN","XQ",40,0)
 ;end of p593 modifications
"RTN","XQ",41,0)
 S:$S('XQTT:1,1:+$P(^XUTL("XQ",$J,XQTT),U,1)'=XQY) ^("T")=XQTT+1,^(XQTT+1)=XQY_XQPSM_U_XQY0 I $D(DUZ("AUTO")),DUZ("AUTO"),'$D(XQMM("J")),'$D(XQMM("N")) G EN^XQ2
"RTN","XQ",42,0)
 K:'$D(XQMM("J")) XQMM("N")
"RTN","XQ",43,0)
M2 ;
"RTN","XQ",44,0)
 I '$D(XQMMF),$D(XQMM("J")) G ^XQ74
"RTN","XQ",45,0)
 Q:$D(XQALEXIT)&'$D(XQALMENU)  K XQMMF I $D(XQMM("A")) S XQAA=XQMM("A") K XQMM("A") I $D(XQMM("B")),$L(XQMM("B")) S XQAA=XQAA_XQMM("B")_"//"
"RTN","XQ",46,0)
 D DISPLAY^XQALERT,CHK^XM
"RTN","XQ",47,0)
 S:'$D(DTIME) DTIME=60
"RTN","XQ",48,0)
 ;
"RTN","XQ",49,0)
ASK ;Get user's response in XQUR
"RTN","XQ",50,0)
 W !,XQAA R XQUR:DTIME I '$T Q:$D(XQALEXIT)  W $C(7),"  Timed out...." G CON^XQTOC
"RTN","XQ",51,0)
 I $D(XQALEXIT),XQUR=""!(XQUR["^") Q
"RTN","XQ",52,0)
 ;
"RTN","XQ",53,0)
ASK1 D SETSV ;Set XQSV to remember where we started from (XQY^XQDIC^XQY0)
"RTN","XQ",54,0)
 K XQUIT
"RTN","XQ",55,0)
 I XQUR="*",$D(DUZ("SAV")) G TESTN^XUS91
"RTN","XQ",56,0)
 I $D(XQJS),XQJS,XQJS'>2 D SET^XQTOC G JUMP^XQ72 ;Continue, 3=[LOGIN
"RTN","XQ",57,0)
 I XQUR["[" G:'$D(DUZ("SAV")) ^XQT W !,"Not when testing another's menus!" S %=^XUTL("XQ",$J,"T")+1,^("T")=%,^(%)=XQY_XQPSM_U_XQY0 G M3
"RTN","XQ",58,0)
 I XQUR="" S:$D(XQMM("B")) XQUR=XQMM("B") K XQMM("B") G:$L(XQUR) D S XQABOLD=1 G M3:^XUTL("XQ",$J,"T")>1,XPRMP^XQ12
"RTN","XQ",59,0)
 I XQUR=U G M3
"RTN","XQ",60,0)
 ;$C(34) is ", which is a shortcut to XUCOMMAND
"RTN","XQ",61,0)
 I $E(XQUR)=$C(34),$L(XQUR)>1 S XQUR=$P(XQUR,$C(34),2) D P^XQ75 G:XQY'>0 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G JUMP^XQ72
"RTN","XQ",62,0)
 ;,XQY=-1 G:$L(XQUR) M0 S XQUR=$C(34)
"RTN","XQ",63,0)
D I XQUR["^^" G:XQUR="^^" R^XQ73 S XQRB=1 S XQUR=$P(XQUR,U,2,99)
"RTN","XQ",64,0)
 ;"^^" is GO HOME, return to the Primary Menu, "^^x" is a rubber band
"RTN","XQ",65,0)
 I XQUR[U S XQUR=$P(XQUR,U,2) G:'$L(XQUR) NOFIND D S^XQ75 G D:'XQY,NOFIND:XQY<0 K XQAA S XQY=+XQY,XQCH=XQUR G:$D(XQRB) ^XQ73 G JUMP^XQ72
"RTN","XQ",66,0)
D0 G:XQUR'?1"?"1AN.ANP D1 D OPT^XQHLP G ASK
"RTN","XQ",67,0)
D1 G EN^XQ2:XQUR?."?"!(XQUR'?.ANP) D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM=$S(XQPSM=("U"_DUZ):XQPSM_",P"_XQDIC,XQPSM[",":XQPSM,XQDIC>0:XQPSM,1:"P"_XQDIC)
"RTN","XQ",68,0)
 I XQY=-1,$O(^VA(200,DUZ,203,0))>0 S XQDIC="U"_DUZ D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="U"_DUZ_",P"_XQY
"RTN","XQ",69,0)
M0 I XQY=-1 S XQDIC=$O(^DIC(19,"B","XUCOMMAND",0)) S:XQDIC="" XQDIC=-1 D DIC^XQ71 G:'XQY D S:XQY>0 XQPSM="PXU" I XQY=-1 G M3:XQUR="HALT",NOFIND
"RTN","XQ",70,0)
 G:XQY=-2 NOFIND K XQAA S XQY=+XQY,XQCH=XQUR G M
"RTN","XQ",71,0)
 ;
"RTN","XQ",72,0)
NOFIND ;Could not find the option requested, go back and try again
"RTN","XQ",73,0)
 W:XQY=-1 "  ??" S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),XQY0=$P(%,U,2,999),XQY=+$P(%,U,1) K XQJS,XQR G M1
"RTN","XQ",74,0)
 ;
"RTN","XQ",75,0)
M3 I $P(XQY0,U,15),$D(^DIC(19,+XQY,15)),$L(^(15)) X ^(15) ;W "  ==> XQ+47"
"RTN","XQ",76,0)
 S %=^XUTL("XQ",$J,"T")-1,^("T")=% G H^XUS:(%'>0) S %=^XUTL("XQ",$J,%),XQY0=$P(%,U,2,999),XQPSM=$P(%,U,1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,99),XQM3="" I +XQY<0 D RBX^XQ73
"RTN","XQ",77,0)
 G M
"RTN","XQ",78,0)
 ;
"RTN","XQ",79,0)
LO I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,+XQY,20)),$L(^(20)) X ^(20) ;W " ==> LO^XQ"
"RTN","XQ",80,0)
 ;I $D(^XUTL("XQ",$J,"P")) S X=^("P") K ^("P") X ^%ZOSF("PRIORITY")
"RTN","XQ",81,0)
 Q
"RTN","XQ",82,0)
 ;
"RTN","XQ",83,0)
SETSV ;Record where we are now for posterity in XQSV
"RTN","XQ",84,0)
 ; ZEXCEPT: XQSV - global variable recording current VistA menu
"RTN","XQ",85,0)
 ; ZEXCEPT: XQY  - global variable recording current VistA menu
"RTN","XQ",86,0)
 N %
"RTN","XQ",87,0)
 S %=^XUTL("XQ",$J,^XUTL("XQ",$J,"T"))
"RTN","XQ",88,0)
 S XQSV=""
"RTN","XQ",89,0)
 S $P(XQSV,U)=+%
"RTN","XQ",90,0)
 S $P(XQSV,U,2)=$S($P(%,U)["PXU":$O(^DIC(19,"B","XUCOMMAND",0)),1:$P($P(%,U),"P",2)) I $P(XQSV,U,2)="" S $P(XQSV,U,2)=XQY
"RTN","XQ",91,0)
 S $P(XQSV,U,3)=$P(%,U,2,99)
"RTN","XQ",92,0)
 Q
"RTN","XQ",93,0)
 ;
"RTN","XQ",94,0)
PRIO ;This subroutine is no longer used.  Kernel no longer resets priority.
"RTN","XQ",95,0)
 ;S Y=10 X:$D(^%ZOSF("PRIINQ")) ^("PRIINQ") S ^XUTL("XQ",$J,"P")=Y,X=$P(XQY0,U,8) X ^%ZOSF("PRIORITY")
"RTN","XQ",96,0)
 Q
"RTN","XQ12")
0^2^B72908021^B55364301
"RTN","XQ12",1,0)
XQ12 ;SEA/LUKE,ISD/HGW - MENU MANAGER UTILITIES ;05/02/12  16:11
"RTN","XQ12",2,0)
 ;;8.0;KERNEL;**9,20,46,157,253,593**;Jul 10, 1995;Build 7
"RTN","XQ12",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQ12",4,0)
 ;
"RTN","XQ12",5,0)
DVARS ;Set up (or reset) necessary variables. From ^XQ1 and ^XQT1.
"RTN","XQ12",6,0)
 S U="^" I '$D(DUZ)#2 S DUZ=^XUTL("XQ",$J,"DUZ")
"RTN","XQ12",7,0)
 S:'$D(DUZ(0))#2 DUZ(0)="" I DUZ(0)="" S:$D(^VA(200,DUZ,0)) DUZ(0)=$P(^(0),U,4)
"RTN","XQ12",8,0)
 I '$D(DT) D ^XQDATE S DT=$P(%,".")
"RTN","XQ12",9,0)
 I '$D(DUZ("AG")),$D(^XTV(8989.3,1,0)) S DUZ("AG")=$P(^(0),U,8)
"RTN","XQ12",10,0)
 I '$D(IOS) S IOS=$S($D(^XUTL("XQ",$J,"IOS"))#2:^("IOS"),1:"")
"RTN","XQ12",11,0)
 I '$D(DTIME) S DTIME=$$DTIME^XUP(DUZ,IOS)
"RTN","XQ12",12,0)
 I '$D(DUZ("AUTO")) S I=$S($D(^VA(200,DUZ,200)):$P(^(200),U,6),1:"") S:'$L(I) I=$S($D(^%ZIS(1,$I,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=$S($D(^XTV(8989.3,1,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=1 S DUZ("AUTO")=I
"RTN","XQ12",13,0)
 I '$D(DUZ("TEST"))&'$$PROD^XUPROD S DUZ("TEST")=1 ; p593 IA #4440
"RTN","XQ12",14,0)
 Q
"RTN","XQ12",15,0)
 ;
"RTN","XQ12",16,0)
INIT ;Entry for new logon, called from the top of ^XQ and ^XQ1
"RTN","XQ12",17,0)
 K DIC,Y Q:$D(DUZ)[0  Q:'$D(^VA(200,DUZ,0))
"RTN","XQ12",18,0)
 ;S:'$D(XQY) XQY=^VA(200,DUZ,201)
"RTN","XQ12",19,0)
 I '$D(XQUSER) S XQUSER=$P($P(^VA(200,DUZ,0),U),",",2)_" "_$P($P(^(0),U),",")
"RTN","XQ12",20,0)
 ;
"RTN","XQ12",21,0)
 ;Select device tied option, primary menu, or primary window
"RTN","XQ12",22,0)
 ;
"RTN","XQ12",23,0)
 S:'$D(XQY) XQY=""
"RTN","XQ12",24,0)
 S %=$G(^VA(200,DUZ,201)),^XUTL("XQ",$J,"XQM")=+%,^("XQW")=$P(%,"^",2)
"RTN","XQ12",25,0)
 D:'$D(IO) HOME^%ZIS
"RTN","XQ12",26,0)
 I IO]"" S %=$G(^%ZIS(1,IO,201)) I %]"" S XQY=%
"RTN","XQ12",27,0)
 I XQY']"" D
"RTN","XQ12",28,0)
 .S %=$G(^VA(200,DUZ,201))
"RTN","XQ12",29,0)
 .S XQPM=$P(%,U),XQPW=$P(%,U,2),XQSD=$P(%,U,3)
"RTN","XQ12",30,0)
 .I XQPW']"" S XQY=XQPM Q
"RTN","XQ12",31,0)
 .I XQSD="M" S XQY=XQPM
"RTN","XQ12",32,0)
 .E  S XQY=XQPW
"RTN","XQ12",33,0)
 .Q
"RTN","XQ12",34,0)
 ;
"RTN","XQ12",35,0)
 D SET^XQCHK
"RTN","XQ12",36,0)
 S ^XUTL("XQ",$J,1)=XQY_"P"_XQY_"^"_XQY0,^("T")=1
"RTN","XQ12",37,0)
 S XQDIC=XQY,XQPSM="P"_XQY
"RTN","XQ12",38,0)
 ;
"RTN","XQ12",39,0)
 ; P593 Run XU USER START-UP menu option for terminal sessions only
"RTN","XQ12",40,0)
 I $E($G(IOST),1,2)="C-" S XUSQUIT=$$STARTUP() G:XUSQUIT HALT
"RTN","XQ12",41,0)
 ;
"RTN","XQ12",42,0)
 ;D MERGE,MGPXU,MGSEC ;get the menu trees this user will need to jump
"RTN","XQ12",43,0)
 ;
"RTN","XQ12",44,0)
 ;Fire LOGIN menu template if they have one and its the first login
"RTN","XQ12",45,0)
 ;of the day.  XQXFLG("LLOG") is copy of ^VA(200,DUZ,1.1) before it's
"RTN","XQ12",46,0)
 ;updated at XUS1+47
"RTN","XQ12",47,0)
 I $D(^VA(200,DUZ,19.8,"B","LOGIN")) D
"RTN","XQ12",48,0)
 .Q:'$D(XQXFLG("LLOG"))
"RTN","XQ12",49,0)
 .S XQLAST=$P($P(XQXFLG("LLOG"),U),".") ;Get last login DT
"RTN","XQ12",50,0)
 .Q:+XQLAST<1
"RTN","XQ12",51,0)
 .I XQLAST<DT S XQUR="[LOGIN",XQJS=3
"RTN","XQ12",52,0)
 .K XQLAST
"RTN","XQ12",53,0)
 .Q
"RTN","XQ12",54,0)
 K XQXFLG("LLOG")
"RTN","XQ12",55,0)
 ;
"RTN","XQ12",56,0)
UI ;Entry for TaskMan (DUZ may =  0), from ZTSK^XQ1
"RTN","XQ12",57,0)
 D DVARS I '$D(^XUTL("XQ",$J,0)) D ^XQDATE S ^XUTL("XQ",$J,0)=%_U_%Y
"RTN","XQ12",58,0)
 S:'$D(XQDIC) XQDIC="P"_XQY
"RTN","XQ12",59,0)
 S:'$D(XQPSM) XQPSM="P"_XQY
"RTN","XQ12",60,0)
 S:'$D(XQJS)&'$D(ZTQUEUED) XQY0=^DIC(19,XQY,0),^XUTL("XQ",$J,"T")=0,^("DUZ")=DUZ,^("XQM")=XQY,XQPSM="P"_XQY
"RTN","XQ12",61,0)
 S XQCY=XQY D ^XQCHK I XQCY<1 D
"RTN","XQ12",62,0)
 .S XQPRMN=1,XQL=0
"RTN","XQ12",63,0)
 .D:'$D(ZTQUEUED) MES^XQCHK,PAUSE^XQ6
"RTN","XQ12",64,0)
 .;G:'$D(ZTQUEUED) ^XUSCLEAN S XQY=-1
"RTN","XQ12",65,0)
 .S XQY=-1
"RTN","XQ12",66,0)
 .Q
"RTN","XQ12",67,0)
 S XQM3="" I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,XQY,20)),$L(^(20)) X ^(20) ;W "  ==> XQ12+59"
"RTN","XQ12",68,0)
 ;I $D(XQUIT),'$D(ZTQUEUED) S XQL=0 W !!,"The variable XQUIT was encountered in the Entry Action of your Primary Menu." D PAUSE^XQ6 S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",69,0)
 I $D(XQUIT),'$D(ZTQUEUED) D PM^XQUIT I $D(XQUIT) S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",70,0)
 ;I $P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ12",71,0)
ABT ;WARNING: XQXFLG is also used by OERR test sites.
"RTN","XQ12",72,0)
 S U="^"
"RTN","XQ12",73,0)
 S $P(XQXFLG,U)=$S($O(^XTV(8989.3,1,"ABPKG",0))>0:1,1:0)
"RTN","XQ12",74,0)
CMP S $P(XQXFLG,U,2)=$S('$D(^XTV(8989.3,1,"XUCP")):0,1:^("XUCP")="Y")
"RTN","XQ12",75,0)
 K %,%Y,PGM,X,XQCY,XQPM,XQPXU,XQPW,XQSD
"RTN","XQ12",76,0)
 Q
"RTN","XQ12",77,0)
 ;
"RTN","XQ12",78,0)
 ;
"RTN","XQ12",79,0)
MERGE ;Merge in the menu trees that this user needs, start with Primary Menu
"RTN","XQ12",80,0)
 Q:'$D(^DIC(19,"AXQ",XQPSM))
"RTN","XQ12",81,0)
 I $D(^XUTL("XQMERGED",XQPSM)) D OLDF(XQPSM)
"RTN","XQ12",82,0)
 Q:$D(^XUTL("XQMERGED",XQPSM))  ;It's already being done
"RTN","XQ12",83,0)
 ;
"RTN","XQ12",84,0)
 L +^XUTL("XQO",XQPSM):DILOCKTM Q:'$T  ;P593
"RTN","XQ12",85,0)
 S ^XUTL("XQMERGED",XQPSM)=$H
"RTN","XQ12",86,0)
 ;
"RTN","XQ12",87,0)
 K ^XUTL("XQO",XQPSM)
"RTN","XQ12",88,0)
 M ^XUTL("XQO",XQPSM)=^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",89,0)
 ;
"RTN","XQ12",90,0)
 ;L -^DIC(19,"AXQ",XQPSM) ;P593
"RTN","XQ12",91,0)
 L -^XUTL("XQO",XQPSM) ;P593
"RTN","XQ12",92,0)
 K ^XUTL("XQMERGED",XQPSM)
"RTN","XQ12",93,0)
 Q
"RTN","XQ12",94,0)
 ;
"RTN","XQ12",95,0)
MGPXU ;Check for XUCOMMAND
"RTN","XQ12",96,0)
 Q:'$D(^DIC(19,"AXQ","PXU"))
"RTN","XQ12",97,0)
 I $D(^XUTL("XQMERGED","PXU")) D OLDF("PXU")
"RTN","XQ12",98,0)
 Q:$D(^XUTL("XQMERGED","PXU"))  ;Already being merged
"RTN","XQ12",99,0)
 ;
"RTN","XQ12",100,0)
 L +^XUTL("XQO","PXU"):DILOCKTM Q:'$T  ;P593
"RTN","XQ12",101,0)
 S ^XUTL("XQMERGED","PXU")=$H
"RTN","XQ12",102,0)
 ;
"RTN","XQ12",103,0)
 K ^XUTL("XQO","PXU")
"RTN","XQ12",104,0)
 M ^XUTL("XQO","PXU")=^DIC(19,"AXQ","PXU")
"RTN","XQ12",105,0)
 ;
"RTN","XQ12",106,0)
 ;L -^DIC(19,"AXQ","PXU")
"RTN","XQ12",107,0)
 L -^XUTL("XQO","PXU") ;P593
"RTN","XQ12",108,0)
 K ^XUTL("XQMERGED","PXU")
"RTN","XQ12",109,0)
 Q
"RTN","XQ12",110,0)
 ;
"RTN","XQ12",111,0)
MGSEC ;Now the Secondary Menu trees
"RTN","XQ12",112,0)
 N %,%1
"RTN","XQ12",113,0)
 F %=0:0 S %=$O(^VA(200,DUZ,203,"B",%)) Q:%'=+%  D
"RTN","XQ12",114,0)
 .S %1="P"_%
"RTN","XQ12",115,0)
 .I '$D(^XUTL("XQO",%1)),$D(^DIC(19,"AXQ",%1)) D
"RTN","XQ12",116,0)
 ..I $D(^XUTL("XQMERGED",%1)) D OLDF(%1)
"RTN","XQ12",117,0)
 ..Q:$D(^XUTL("XQMERGED",%1))  ;Already merging as we speak
"RTN","XQ12",118,0)
 ..S ^XUTL("XQMERGED",%1)=$H
"RTN","XQ12",119,0)
 ..L +^XUTL("XQO",%1):DILOCKTM Q:'$T  ;P593
"RTN","XQ12",120,0)
 ..I '$D(^XUTL("XQO",%1)) D
"RTN","XQ12",121,0)
 ...K ^XUTL("XQO",%1)
"RTN","XQ12",122,0)
 ...M ^XUTL("XQO",%1)=^DIC(19,"AXQ",%1)
"RTN","XQ12",123,0)
 ...Q
"RTN","XQ12",124,0)
 ..;L -^DIC(19,"AXQ",%1) ;P593
"RTN","XQ12",125,0)
 ..L -^XUTL("XQO",%1) ;P593
"RTN","XQ12",126,0)
 ..K ^XUTL("XQMERGED",%1)
"RTN","XQ12",127,0)
 ..Q
"RTN","XQ12",128,0)
 .Q
"RTN","XQ12",129,0)
 Q
"RTN","XQ12",130,0)
 ;
"RTN","XQ12",131,0)
OLDF(X) ;See if this flag is au current, if not KILL it
"RTN","XQ12",132,0)
 ;X is the P name of the tree, e.g., P9 might be EVE
"RTN","XQ12",133,0)
 S:'$D(XQPXU) XQPXU=$G(^DIC(19,"AXQ","PXU",0))
"RTN","XQ12",134,0)
 I XQPXU="" S XQPXU=$H ;Assume it's rebuilding now
"RTN","XQ12",135,0)
 N Y,Z
"RTN","XQ12",136,0)
 S Y=$G(^XUTL("XQMERGED",X)) Q:Y=""  ;Flag's gone
"RTN","XQ12",137,0)
 S Z=$$HDIFF^XLFDT(XQPXU,Y,2)
"RTN","XQ12",138,0)
 I Z<3600 K ^XUTL("XQMERGED",X) ;Old Flag
"RTN","XQ12",139,0)
 Q
"RTN","XQ12",140,0)
 ;
"RTN","XQ12",141,0)
LOGOPT ;Option audit
"RTN","XQ12",142,0)
 S:'$D(XQLTL) XQLTL=""
"RTN","XQ12",143,0)
 S %=$P($H,",",2),%=DT_(%\60#60/100+(%\3600)+(%#60/10000)/100)
"RTN","XQ12",144,0)
 I XQLTL S $P(^XUSEC(19,XQLTL,0),U,5)=%,XQLTL=0
"RTN","XQ12",145,0)
 S I=1 I XQAUDIT'=1 S I=0 F J=1:2 S K1=$P(XQAUDIT,U,J),K2=$P(XQAUDIT,U,J+1) Q:'$L(K1)!I  I K1=2&(K2=XQY)!(K1=3&($E($P(XQY0,U,1),1,$L(K2))=K2)) S I=1
"RTN","XQ12",146,0)
 Q:'I  S XQLTL=% L +^XUSEC(19,0):0 S %=^XUSEC(19,0),XQLTL=XQLTL+(.00000001*$S(XQLTL'=$E($P(%,U,3),1,14):10,1:$E($P(%,U,3),15,16)+1)),$P(^(0),U,3,4)=XQLTL_"^"_($P(%,U,4)+1) L -^XUSEC(19,0)
"RTN","XQ12",147,0)
 D GETENV^%ZOSV S XUVOL=$P(Y,U,2),^XUSEC(19,XQLTL,0)=XQY_U_DUZ_U_$I_U_$J_"^^"_XUVOL
"RTN","XQ12",148,0)
 K K1,K2
"RTN","XQ12",149,0)
 Q
"RTN","XQ12",150,0)
XPRMP D CHK^XM W !!,"Do you really want to ",$S(XQUR="REST":"restart",1:"halt"),"? YES// " R X:10 S:'$L(X) X="Y"
"RTN","XQ12",151,0)
 ;Modified - p593 to display <TEST ACCOUNT> if not a production VistA system
"RTN","XQ12",152,0)
 S XQXQTEST=$S($D(DUZ("TEST")):" <TEST ACCOUNT>",1:"")
"RTN","XQ12",153,0)
 I "Yy"'[$E(X) S Y=1 S:^XUTL("XQ",$J,"T")>1 Y=^("T")-1 S ^("T")=Y,Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_XQXQTEST_" Option: " W ! G ASK^XQ
"RTN","XQ12",154,0)
 K XQXQTEST
"RTN","XQ12",155,0)
 ;end of p593 modifications
"RTN","XQ12",156,0)
 G REST:XQUR="REST",HALT:XQUR'="CON"
"RTN","XQ12",157,0)
 ;
"RTN","XQ12",158,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQ12",159,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQ12",160,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQ12",161,0)
 ;Modified - p593 to display <TEST ACCOUNT> if not a production VistA system
"RTN","XQ12",162,0)
 S XQXQTEST=$S($D(DUZ("TEST")):" <TEST ACCOUNT>",1:"")
"RTN","XQ12",163,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_XQXQTEST_" Option: " G ASK^XQ
"RTN","XQ12",164,0)
 K XQXQTEST
"RTN","XQ12",165,0)
 ;end of p593 modifications
"RTN","XQ12",166,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQ12",167,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQ12",168,0)
 W !!,$P("HMM^OK^ALL RIGHT^WELL CERTAINLY^FINE","^",$R(5)+1),"... ",$P("SEE YOU LATER^I'LL BE READY WHEN YOU ARE.^HURRY BACK!^HAVE A GOOD LUNCH BREAK!","^",$R(3)+X+1)
"RTN","XQ12",169,0)
HALT ;
"RTN","XQ12",170,0)
 G H^XUS
"RTN","XQ12",171,0)
REST S XQNOHALT=1 D ^XUSCLEAN G ^XUS
"RTN","XQ12",172,0)
 ;
"RTN","XQ12",173,0)
SS ;Search Secondaries for a particular option.
"RTN","XQ12",174,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQ12",175,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQ12",176,0)
 Q
"RTN","XQ12",177,0)
ABLOG S %2=0 F %3=0:0 S %2=$O(^XTV(8989.3,1,"ABPKG",%2)) Q:%2'>0  F %=0:0 S %=$O(^XTV(8989.3,1,"ABPKG",%2,1,%)) Q:%'>0  S %1=$P(^(%,0),U) I $E(XQY0,1,$L(%1))=%1,$E(XQY0,$L(%1)+1)'="Z" D ABLOG1
"RTN","XQ12",178,0)
 K %,%1,%2,%3,%4
"RTN","XQ12",179,0)
 Q
"RTN","XQ12",180,0)
ABLOG1 F %4=0:0 S %4=$O(^XTV(8989.3,1,"ABPKG",%2,1,%,1,%4)) Q:%4'>0  S %1=$P(^(%4,0),U) I $E(XQY0,1,$L(%1))=%1 Q
"RTN","XQ12",181,0)
 I %4'>0 S:'$D(^XTV(8989.3,1,"ABOPT",0)) ^(0)="^8989.333P^" S:'$D(^(XQY)) %4=+$P(^(0),U,3),$P(^(0),U,3,4)=$S(XQY>%4:XQY,1:%4)_U_($P(^(0),U,4)+1) S ^(0)=XQY_U_($S($D(^(XQY,0)):$P(^(0),U,2),1:0)+1),%2="A"
"RTN","XQ12",182,0)
 Q
"RTN","XQ12",183,0)
STARTUP() ; P593 Run XU USER START-UP option
"RTN","XQ12",184,0)
 N XUSER,XUSQUIT ;Protect ourself.
"RTN","XQ12",185,0)
 S DIC="^DIC(19,",X="XU USER START-UP",XUSQUIT=0
"RTN","XQ12",186,0)
 D EN^XQOR
"RTN","XQ12",187,0)
 K X,DIC
"RTN","XQ12",188,0)
 Q XUSQUIT ;If option set XUSQUIT will stop sign-on.
"RTN","XQ12",189,0)
SAMPLE ; P593 sample start-up option
"RTN","XQ12",190,0)
 N DA
"RTN","XQ12",191,0)
 S DA=+DUZ
"RTN","XQ12",192,0)
 W !!,"  Sample: Testing XU USER START-UP option for patch XU*8.0*593"
"RTN","XQ12",193,0)
 W !!,"  Sample: Prompt to edit fields in NEW PERSON file (#200)",!
"RTN","XQ12",194,0)
 S DA=+DUZ,DIE="^VA(200,",DR="20.2;20.3;.132;.138" D ^DIE
"RTN","XQ12",195,0)
 W !!,"  Sample: Yes(Y) or No(N) prompt."
"RTN","XQ12",196,0)
 W !,"     Entering Y will set the variable XUSQUIT to 1 and end your session."
"RTN","XQ12",197,0)
 W !,"     Entering anything else (including ^ or <CR>) will continue."
"RTN","XQ12",198,0)
 W !,"     Do you want to end your session now" D YN^DICN I %=1 S XUSQUIT=%
"RTN","XQ12",199,0)
 W !!,"  Sample: End of sample script."
"RTN","XQ12",200,0)
 Q
"RTN","XQ83")
0^3^B33804424^B32884553
"RTN","XQ83",1,0)
XQ83 ;SF-ISC.SEA/JLI/LUKE,ISD/HGW - FIND ^XUTL NODES NEEDING SURGERY ;05/01/12  09:43
"RTN","XQ83",2,0)
 ;;8.0;KERNEL;**60,157,286,593**;Jul 10, 1995;Build 7
"RTN","XQ83",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified
"RTN","XQ83",4,0)
 Q
"RTN","XQ83",5,0)
DQ ;TaskMan entry fired by CHEK below
"RTN","XQ83",6,0)
 ;
"RTN","XQ83",7,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",8,0)
 ;
"RTN","XQ83",9,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",10,0)
 .L +^DIC(19,"AXQ","P0"):DILOCKTM ;If we can lock it the flag is bogus ;P593
"RTN","XQ83",11,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",12,0)
 .Q
"RTN","XQ83",13,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",14,0)
 ;
"RTN","XQ83",15,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",16,0)
 .N X,Y,Z
"RTN","XQ83",17,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",18,0)
 .S Y=$H
"RTN","XQ83",19,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",20,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",21,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",22,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",23,0)
 .Q
"RTN","XQ83",24,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",25,0)
 ;
"RTN","XQ83",26,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H ;Set the 'I am working' flag.
"RTN","XQ83",27,0)
 ;
"RTN","XQ83",28,0)
 D NOW^%DTC ;Returns: %=3010706.131332, %H=58626,47612, X=3010706
"RTN","XQ83",29,0)
 S X=% S %XQT1=X H 2
"RTN","XQ83",30,0)
 S XQSTART=$$HTE^XLFDT($H) ;Returns: Jul 06, 2001@13:19:20
"RTN","XQ83",31,0)
 ;
"RTN","XQ83",32,0)
 S X1=X,X2=-21 D C^%DTC F %K=0:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K'<X)  K ^(%K) ;Kill of those that are 21 days old
"RTN","XQ83",33,0)
 S X=DT+2 F  S X=$O(^DIC(19,"AT",X)) Q:X'>0  S %K="" F  S %K=$O(^DIC(19,"AT",X,%K)) Q:%K=""  W !,X K ^(%K) S ^DIC(19,"AT",$$NOW^XLFDT(),%K)="" W " ",$$NOW^XLFDT()
"RTN","XQ83",34,0)
 ;Kill off old "AT" nodes
"RTN","XQ83",35,0)
 ;
"RTN","XQ83",36,0)
LOOP ;Main loop
"RTN","XQ83",37,0)
 ;
"RTN","XQ83",38,0)
 ;I $D(^DIC(19,"AXQ","P0","STOP")) G KILL
"RTN","XQ83",39,0)
 K ^TMP($J) S X=%XQT,%XQX="",N=0 F %K=X:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K>%XQT1)  S %XQT=%K,%Z="" F %J=0:0 S %Z=$O(^DIC(19,"AT",%K,%Z)) Q:%Z=""  S N=N+1,^TMP($J,N,%Z)="",^TMP($J,"A",%Z,N)=""
"RTN","XQ83",40,0)
 ;$O through "AT" and set up lists in ^TMP, ^TMP($J,"A" is the XREF
"RTN","XQ83",41,0)
 ;
"RTN","XQ83",42,0)
 I '$D(^TMP($J)) S XQN="P0",X=%XQT D H^%DTC S %XQT=%H_","_%T F %K=0:0 S XQN=$O(^XUTL("XQO",XQN)) Q:$E(XQN)'="P"  S ^(XQN,0)=%XQT
"RTN","XQ83",43,0)
 I '$D(^TMP($J)) G KILL
"RTN","XQ83",44,0)
 ;If nothing appears in TMP quit
"RTN","XQ83",45,0)
 ;
"RTN","XQ83",46,0)
 S %Z="" F %K=0:0 S %Z=$O(^TMP($J,"A",%Z)) Q:%Z=""  F N=0:0 S N=$O(^TMP($J,"A",%Z,N)) Q:N'>0  I $O(^(N))>0 K ^TMP($J,N)
"RTN","XQ83",47,0)
 ;F N=0:0 S N=$O(^TMP($J,N)) Q:N'>0  S %Z=$O(^(N,"")),%X1=+%Z,%XC=$E(%Z,$L(%X1)+1,99),%X2=$E(%XC,2,99),XJ=$S(%XC="DIFROM":"DNUL",%XC["I":"DINS",%XC["D":"DDEL",%Z=+%Z:"DREG",%XC["S":"DSYN",%XC["P":"DPRI",1:"DNUL") D @XJ
"RTN","XQ83",48,0)
 F XQXM=0:0 S XQXM=$O(^TMP($J,XQXM)) Q:XQXM'>0  S XQOP=$O(^(XQXM,"")),XQENT=$S(XQOP["S":"SYN",XQOP["I":"INS",XQOP["D":"DEL",XQOP["P":"PRI",1:"REG") D @XQENT
"RTN","XQ83",49,0)
 ;solve the entry for the type of operation needs to be performed and
"RTN","XQ83",50,0)
 ; to that code below.
"RTN","XQ83",51,0)
 ;Remove the "AT" nodes that we processed
"RTN","XQ83",52,0)
 F XQI=0:0 S XQI=$O(^DIC(19,"AT",XQI)) Q:(XQI'<%XQT1)!(XQI<1)  K ^(XQI)
"RTN","XQ83",53,0)
 D NOW^%DTC S %XQT=%XQT1 S:%=0 %="" S %XQT1=X H 2
"RTN","XQ83",54,0)
 G LOOP
"RTN","XQ83",55,0)
 ;
"RTN","XQ83",56,0)
DINS F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"D"_%X2)))!$D(^(%X1))!$D(^(%X2)) K ^TMP($J,N) Q
"RTN","XQ83",57,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",58,0)
 Q
"RTN","XQ83",59,0)
DDEL F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"I"_%X2))) K ^TMP($J,N) Q
"RTN","XQ83",60,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",61,0)
 Q
"RTN","XQ83",62,0)
DREG F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X[("I"_%X2)!(X[("S"_%X2)) K ^TMP($J,%M)
"RTN","XQ83",63,0)
 Q
"RTN","XQ83",64,0)
DSYN F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X=%X2!(X=(%X1_"I"_%X2)) K ^TMP($J,N) Q
"RTN","XQ83",65,0)
 Q
"RTN","XQ83",66,0)
DNUL K ^TMP($J,N)
"RTN","XQ83",67,0)
DPRI Q
"RTN","XQ83",68,0)
 ;
"RTN","XQ83",69,0)
DEL S XQC="D" D SPLIT D ^XQ83D Q
"RTN","XQ83",70,0)
 ;
"RTN","XQ83",71,0)
DIFROM S XQH=%XQT D QUE^XQ81
"RTN","XQ83",72,0)
 G KILL
"RTN","XQ83",73,0)
 ;
"RTN","XQ83",74,0)
INS S XQC="I" D SPLIT D ^XQ83A Q
"RTN","XQ83",75,0)
 ;
"RTN","XQ83",76,0)
SYN S XQC="S" D SPLIT D SYN^XQ83R Q
"RTN","XQ83",77,0)
 ;
"RTN","XQ83",78,0)
REG S XQC="" D REG^XQ83R Q
"RTN","XQ83",79,0)
 ;
"RTN","XQ83",80,0)
PRI ; Enter a new Primary menu
"RTN","XQ83",81,0)
 S XQC="P" D SPLIT S (A,XQDIC)="P"_XQOPM,XQVE=0,XQRB=0,XQFG1=1 K XQFG L +^XUTL("XQO",A):0 D PM1^XQ8 S ^XUTL("XQO",XQDIC,0)=%XQT1 L -^XUTL("XQO",XQDIC)
"RTN","XQ83",82,0)
 Q
"RTN","XQ83",83,0)
 ;
"RTN","XQ83",84,0)
SPLIT S XQOPM=+XQOP,XQOPI=+$P(XQOP,XQC,2),XQC1=XQOPM_","_XQOPI_",",XQC2=","_XQC1,XQOPI1=XQOPI_",",XQOPI2=","_XQOPI1 Q
"RTN","XQ83",85,0)
 ;
"RTN","XQ83",86,0)
 ;
"RTN","XQ83",87,0)
CHEKV ;First see if the compiled menus live on this system
"RTN","XQ83",88,0)
 ;If so fall through to CHEK, else quit (called by XQOO*)
"RTN","XQ83",89,0)
 Q:'$D(^XUTL("XQO"))
"RTN","XQ83",90,0)
 ;
"RTN","XQ83",91,0)
CHEK ;See if microsurgery needs to be run here
"RTN","XQ83",92,0)
 ;Called by XUS+25 and XUSG+18
"RTN","XQ83",93,0)
 ;Also kicked off by the option XQKICKMICRO
"RTN","XQ83",94,0)
 ;
"RTN","XQ83",95,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",96,0)
 ;
"RTN","XQ83",97,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",98,0)
 .L +^DIC(19,"AXQ","P0"):DILOCKTM ;If we can lock it the flag is bogus ;P593
"RTN","XQ83",99,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",100,0)
 .Q
"RTN","XQ83",101,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",102,0)
 ;
"RTN","XQ83",103,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",104,0)
 .N X,Y,Z
"RTN","XQ83",105,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",106,0)
 .S Y=$H
"RTN","XQ83",107,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",108,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",109,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",110,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",111,0)
 .Q
"RTN","XQ83",112,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",113,0)
 ;
"RTN","XQ83",114,0)
 ;If the compiled menus do not exist on "AXQ" rebuild all of them
"RTN","XQ83",115,0)
 S %XQH=$O(^DIC(19,"AXQ","P")) I %XQH'["P" D  Q
"RTN","XQ83",116,0)
 .;S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ83",117,0)
 .S ZTIO="",ZTDTH=$H,ZTRTN="QUE^XQ81",ZTSAVE("DUZ")=.5
"RTN","XQ83",118,0)
 .D SETVOL
"RTN","XQ83",119,0)
 .D ^%ZTLOAD
"RTN","XQ83",120,0)
 .Q
"RTN","XQ83",121,0)
 ;
"RTN","XQ83",122,0)
 Q:'$D(^XUTL("XQO",%XQH,0))  L ^XUTL("XQO",%XQH,0):DILOCKTM I '$T K %XQH Q  ;P593
"RTN","XQ83",123,0)
 ;If the first menu has a 0th node lock it, if it won't lock quit
"RTN","XQ83",124,0)
 N X S %H=$P(^XUTL("XQO",%XQH,0),U,1) D YMD^%DTC S:%>.001 %=%-.001 S:%=0 %="" S %XQT=X_%
"RTN","XQ83",125,0)
 ;Get date off first entry set %XQT (looks like: 3000414.081043)
"RTN","XQ83",126,0)
 S %XQX="",%ZO="" S:'$D(XQM) XQM=+$G(^VA(200,DUZ,201)) I XQM>0,'$D(^XUTL("XQO","P"_XQM)) S %XQX=XQM_"P",^DIC(19,"AT",%XQT+.0001,%XQX)=""
"RTN","XQ83",127,0)
 ;Set Primary menu of this user, if not there flag it in "AT" it looks
"RTN","XQ83",128,0)
 ;  like this: ^DIC(19,"AT",3000414.081143,9P)
"RTN","XQ83",129,0)
 ;I $O(^DIC(19,"AT",%XQT))>0
"RTN","XQ83",130,0)
 ;
"RTN","XQ83",131,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H,%XQX=1
"RTN","XQ83",132,0)
 S %TIM=$P($H,",")-1_","_$P($H,",",2)
"RTN","XQ83",133,0)
 L -^XUTL("XQO",%XQH,0)
"RTN","XQ83",134,0)
 ;
"RTN","XQ83",135,0)
 S ZTDESC="MICRO UPDATING XUTL",ZTRTN="DQ^XQ83",ZTSAVE("%XQT")="",ZTSAVE("DUZ")=.5,ZTDTH=%TIM,ZTIO="" D:'$D(ZTCPU) SETVOL D ^%ZTLOAD
"RTN","XQ83",136,0)
 ;Unlock the node and task off DQ above and quit
"RTN","XQ83",137,0)
 ;
"RTN","XQ83",138,0)
 Q
"RTN","XQ83",139,0)
SETVOL ;
"RTN","XQ83",140,0)
 X ^%ZOSF("UCI") S ZTCPU=$P(Y,",",2),ZTUCI=$P(Y,",")
"RTN","XQ83",141,0)
 Q
"RTN","XQ83",142,0)
 ;
"RTN","XQ83",143,0)
KILL D REPORT^XQ84("MICRO")
"RTN","XQ83",144,0)
 K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ83",145,0)
 ;
"RTN","XQ83",146,0)
 K %,%H,%J,%K,%M,%X1,%X2,%TIM,%XQT1,%XQH,%I,%T,%XQA,%XQX,%XQT,%XQX1,%XQX2,%XQY,A,B,I,I0,%Z,%ZO
"RTN","XQ83",147,0)
 K J,K,M,N,P,X1,X2,XQA,XQC,XQC1,XQC2,XQE,XQENT,XQK,XQOP,XQOPI,XQOPI1,XQOPI2
"RTN","XQ83",148,0)
 K XQI,XQH,XQFG1,XQM,XQN,XQOPM,XQOPS,XQP,XQRB,XQSTART,XQVE,XQXM,Y
"RTN","XQ83",149,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ83",150,0)
 Q
"RTN","XQTOC")
0^4^B17537937^B16630019
"RTN","XQTOC",1,0)
XQTOC ;SEA/MJM - Time Out/Continue/Jump Start ;05/02/12  16:46
"RTN","XQTOC",2,0)
 ;;8.0;KERNEL;**20,157,593**;Jul 10, 1995;Build 7
"RTN","XQTOC",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","XQTOC",4,0)
 ;
"RTN","XQTOC",5,0)
 S ^XUTL("XQ",$J,1)=XQY_XQPSM_U_XQY0,^("T")=1
"RTN","XQTOC",6,0)
 Q:XQJS=0
"RTN","XQTOC",7,0)
 S %=^VA(200,DUZ,202.1) K ^(202.1) S $P(XQJS,U,2)=%,XQY=+%,XQPSM=$P(%,XQY,2,99),XQDIC=$S(XQPSM[",":$P(XQPSM,",",2),1:XQPSM)
"RTN","XQTOC",8,0)
 I '$D(^XUTL("XQO",XQDIC,"^",XQY)) D NOGO Q
"RTN","XQTOC",9,0)
 D
"RTN","XQTOC",10,0)
 .N %
"RTN","XQTOC",11,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",12,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",13,0)
 .I %]"" S XQOPTN=$P(%,"^",1,99)
"RTN","XQTOC",14,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",15,0)
 .Q
"RTN","XQTOC",16,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",17,0)
 ;
"RTN","XQTOC",18,0)
 W !!,"You were last executing the '",$P(XQOPTN,U,3),"' menu option."
"RTN","XQTOC",19,0)
ASK W !,"Do you wish to resume" S %=1 D YN^DICN I '% W !!,"If you wish to continue at the last option you were executing, enter 'Y',",! G ASK
"RTN","XQTOC",20,0)
 I %=1
"RTN","XQTOC",21,0)
 E  D NOGO Q
"RTN","XQTOC",22,0)
 ;
"RTN","XQTOC",23,0)
 ;S XQY0=$P(^XUTL("XQO",XQDIC,"^",XQY),U,2,99)
"RTN","XQTOC",24,0)
 D
"RTN","XQTOC",25,0)
 .N %
"RTN","XQTOC",26,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",XQY))
"RTN","XQTOC",27,0)
 .I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY))
"RTN","XQTOC",28,0)
 .I %]"" S XQY0=$P(%,"^",2,99)
"RTN","XQTOC",29,0)
 .E  D NOGO S XQFAIL=""
"RTN","XQTOC",30,0)
 .Q
"RTN","XQTOC",31,0)
 I $D(XQFAIL) K XQFAIL Q
"RTN","XQTOC",32,0)
 ;
"RTN","XQTOC",33,0)
 I $D(^XUTL("XQO",XQDIC,"^",XQY,0)) D
"RTN","XQTOC",34,0)
 .S XQ=^(0)
"RTN","XQTOC",35,0)
 .F XQI=1:1:XQ D
"RTN","XQTOC",36,0)
 ..N %
"RTN","XQTOC",37,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",38,0)
 ..I %="" S %=$G(^DIC(19,"AXQ",XQDIC,"^",XQY,0,XQI))
"RTN","XQTOC",39,0)
 ..I %]"" S XQ(XQI)=% ;$P(^XUTL("XQO",XQDIC,"^",XQY,0,XQI),U)
"RTN","XQTOC",40,0)
 ..Q
"RTN","XQTOC",41,0)
 .Q
"RTN","XQTOC",42,0)
 E  S XQ=0
"RTN","XQTOC",43,0)
 Q
"RTN","XQTOC",44,0)
 ;
"RTN","XQTOC",45,0)
SET ;Set up variables to GO JUMP^XQ72.  Enter from ASK1+1^XQ
"RTN","XQTOC",46,0)
 S %=^XUTL("XQ",$J,1),XQSV=+%_U_+%_U_$P(%,U,2,99)
"RTN","XQTOC",47,0)
 K XQJS
"RTN","XQTOC",48,0)
 Q
"RTN","XQTOC",49,0)
 ;
"RTN","XQTOC",50,0)
LOOK ;Look up the Jump Start Entry
"RTN","XQTOC",51,0)
 F  Q:XQUR'[U  S XQUR=$P(XQUR,U,2)
"RTN","XQTOC",52,0)
 I '$L(XQUR) D NOGO Q
"RTN","XQTOC",53,0)
 D S^XQ75 I 'XQY D NOGO Q
"RTN","XQTOC",54,0)
 Q
"RTN","XQTOC",55,0)
 ;
"RTN","XQTOC",56,0)
NOGO ;Continue fails: reset to primary menu
"RTN","XQTOC",57,0)
 S XQY=^XUTL("XQ",$J,"XQM"),XQA3="",XQA=0 K XQCON,XQRE,XQJS,XQUR,XQOPTN
"RTN","XQTOC",58,0)
 D S1^XQCHK ; Reconstruct XQY0
"RTN","XQTOC",59,0)
 S $P(^XUTL("XQ",$J,0),U,3)=$P(^(0),U,3)_", NOGO"
"RTN","XQTOC",60,0)
 Q
"RTN","XQTOC",61,0)
 ;
"RTN","XQTOC",62,0)
 ;
"RTN","XQTOC",63,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQTOC",64,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQTOC",65,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQTOC",66,0)
 ;Modified - p593 to display <TEST ACCOUNT> if not a production VistA system
"RTN","XQTOC",67,0)
 S XQXQTEST=$S($D(DUZ("TEST")):" <TEST ACCOUNT>",1:"")
"RTN","XQTOC",68,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_XQXQTEST_" Option: " G ASK^XQ
"RTN","XQTOC",69,0)
 K XQXQTEST
"RTN","XQTOC",70,0)
 ;end of p593 modifications
"RTN","XQTOC",71,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQTOC",72,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQTOC",73,0)
 W !!,$P("Great^OK^All right^Well certainly^Fine","^",$R(5)+1),".  ",$P("See you later.^I'll be ready when you are.^Hurry back!^Have a nice lunch.","^",$R(3)+X+1)
"RTN","XQTOC",74,0)
 G H^XUS
"RTN","XQTOC",75,0)
 ;
"RTN","XQTOC",76,0)
SS ;Search Secondaries for a particular option.
"RTN","XQTOC",77,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQTOC",78,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=+^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQTOC",79,0)
 Q
"VER")
8.0^22.0
"BLD",1436,6)
^482
**END**
**END**
