Released PRC*5.1*159 SEQ #139
Extracted from mail message
**KIDS**:PRC*5.1*159^

**INSTALL NAME**
PRC*5.1*159
"BLD",6744,0)
PRC*5.1*159^IFCAP^0^3111013^y
"BLD",6744,1,0)
^^8^8^3111013^
"BLD",6744,1,1,0)
 
"BLD",6744,1,2,0)
1. Duplicate 'AB' cross references exist in file 442 [PROCUREMENT & 
"BLD",6744,1,3,0)
   ACCOUNTING TRANSACTIONS.
"BLD",6744,1,4,0)
 
"BLD",6744,1,5,0)
2. Modify IFCAP security key PRCSCPO 'Keep at Terminate' setting to 'NO'.
"BLD",6744,1,6,0)
 
"BLD",6744,1,7,0)
3. Option PRCB MONTHLY ACCRUAL creating multiple monthly accrual nodes in
"BLD",6744,1,8,0)
   file 440.7 [MONTHLY ACCRUAL].
"BLD",6744,4,0)
^9.64PA^^
"BLD",6744,6.3)
9
"BLD",6744,"ABPKG")
n
"BLD",6744,"INI")
START^PRC159P1
"BLD",6744,"INID")
^y^y
"BLD",6744,"INIT")
START^PRC159P
"BLD",6744,"KRN",0)
^9.67PA^779.2^20
"BLD",6744,"KRN",.4,0)
.4
"BLD",6744,"KRN",.401,0)
.401
"BLD",6744,"KRN",.402,0)
.402
"BLD",6744,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",6744,"KRN",.402,"NM",1,0)
PRCH DETAILED PURCHASE CARD    FILE #442^442^0
"BLD",6744,"KRN",.402,"NM","B","PRCH DETAILED PURCHASE CARD    FILE #442",1)

"BLD",6744,"KRN",.403,0)
.403
"BLD",6744,"KRN",.5,0)
.5
"BLD",6744,"KRN",.84,0)
.84
"BLD",6744,"KRN",3.6,0)
3.6
"BLD",6744,"KRN",3.8,0)
3.8
"BLD",6744,"KRN",9.2,0)
9.2
"BLD",6744,"KRN",9.8,0)
9.8
"BLD",6744,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6744,"KRN",9.8,"NM",1,0)
PRC159P^^0^B4980889
"BLD",6744,"KRN",9.8,"NM",2,0)
PRCB1F^^0^B41135411
"BLD",6744,"KRN",9.8,"NM",3,0)
PRCHNPO5^^0^B38701458
"BLD",6744,"KRN",9.8,"NM",4,0)
PRC159P1^^0^B6863193
"BLD",6744,"KRN",9.8,"NM","B","PRC159P",1)

"BLD",6744,"KRN",9.8,"NM","B","PRC159P1",4)

"BLD",6744,"KRN",9.8,"NM","B","PRCB1F",2)

"BLD",6744,"KRN",9.8,"NM","B","PRCHNPO5",3)

"BLD",6744,"KRN",19,0)
19
"BLD",6744,"KRN",19.1,0)
19.1
"BLD",6744,"KRN",101,0)
101
"BLD",6744,"KRN",409.61,0)
409.61
"BLD",6744,"KRN",771,0)
771
"BLD",6744,"KRN",779.2,0)
779.2
"BLD",6744,"KRN",870,0)
870
"BLD",6744,"KRN",8989.51,0)
8989.51
"BLD",6744,"KRN",8989.52,0)
8989.52
"BLD",6744,"KRN",8994,0)
8994
"BLD",6744,"KRN","B",.4,.4)

"BLD",6744,"KRN","B",.401,.401)

"BLD",6744,"KRN","B",.402,.402)

"BLD",6744,"KRN","B",.403,.403)

"BLD",6744,"KRN","B",.5,.5)

"BLD",6744,"KRN","B",.84,.84)

"BLD",6744,"KRN","B",3.6,3.6)

"BLD",6744,"KRN","B",3.8,3.8)

"BLD",6744,"KRN","B",9.2,9.2)

"BLD",6744,"KRN","B",9.8,9.8)

"BLD",6744,"KRN","B",19,19)

"BLD",6744,"KRN","B",19.1,19.1)

"BLD",6744,"KRN","B",101,101)

"BLD",6744,"KRN","B",409.61,409.61)

"BLD",6744,"KRN","B",771,771)

"BLD",6744,"KRN","B",779.2,779.2)

"BLD",6744,"KRN","B",870,870)

"BLD",6744,"KRN","B",8989.51,8989.51)

"BLD",6744,"KRN","B",8989.52,8989.52)

"BLD",6744,"KRN","B",8994,8994)

"BLD",6744,"QDEF")
^^^^^^^^^^YES
"BLD",6744,"QUES",0)
^9.62^^
"BLD",6744,"REQB",0)
^9.611^2^2
"BLD",6744,"REQB",1,0)
PRC*5.1*113^2
"BLD",6744,"REQB",2,0)
PRC*5.1*142^2
"BLD",6744,"REQB","B","PRC*5.1*113",1)

"BLD",6744,"REQB","B","PRC*5.1*142",2)

"INI")
START^PRC159P1
"INIT")
START^PRC159P
"KRN",.402,2663,-1)
0^1
"KRN",.402,2663,0)
PRCH DETAILED PURCHASE CARD^3110921.0901^^442^^^3110921
"KRN",.402,2663,"DIAB",1,0,442,6)
P.O. DATE//TODAY
"KRN",.402,2663,"DIAB",1,0,442,11)
DELIVERY DATE//TODAY+10
"KRN",.402,2663,"DIAB",3,0,442,7)
PCDO VENDOR;REQ
"KRN",.402,2663,"DIAB",7,0,442,2)
SUBSTATION;REQ
"KRN",.402,2663,"DIAB",10,1,442.01,8)
FEDERAL SUPPLY CLASSIFICATION;T
"KRN",.402,2663,"DR",1,442)
Q:'$D(PRC("SITE"))  S (PRCHN("SVC"),PRCHN("CC"),PRCHN("SC"),PRCHN("INV"))="",PRCHN("SFC")=+$P(^PRC(442,DA,0),U,19),PRCHN("FOB")=$S($D(^(1)):$P(^(1),U,6),1:""),PRCHN(12)=$S($D(^PRC(442,DA,12)):^(12),1:"");
"KRN",.402,2663,"DR",1,442,1)
S PRCHPONO=$P(^PRC(442,DA,0),U,1),PRCHSTN=$P(PRCHPONO,"-") S PRCHIEN=DA;S PRCX=$O(^PRC(411,PRC("SITE"),1,0)) S:$G(PRCX)]"" PRCY=$P($G(^PRC(411,PRC("SITE"),1,PRCX,0)),U) K PRCX;D EN2^PRCHNPO6;S PRCHDUZ=$P(^VA(200,DUZ,0),U,1);
"KRN",.402,2663,"DR",1,442,2)
16////^S X=DUZ;56////^S X=DUZ;.02///^S X=25;48///^S X="P";63///^S X=1;I '$D(^PRC(411,"UP",PRC("SITE"))) S Y="@46";31R~;S SUB=X;I $D(SUB) S PRCX=$O(^PRC(411,SUB,1,0)) S:$G(PRCX)]"" PRCY=$P($G(^PRC(411,SUB,1,PRCX,0)),U) K PRCX;@46;
"KRN",.402,2663,"DR",1,442,3)
S PRCHCDNO=$P($G(^PRC(442,DA,23)),U,8);S PRCHNN=0 F PRCHII=1:1 S PRCHNN=$O(^PRC(440.5,"C",DUZ,PRCHNN)) Q:'PRCHNN  S PRCHCDF=$P(^PRC(440.5,PRCHNN,0),U);S PRCHCDFT="" I PRCHII=2 S PRCHCDFT=PRCHCDF;D LOOK^PRCSPC;
"KRN",.402,2663,"DR",1,442,4)
I (X="")!(X["^") S ERRFLG=2,Y=0;I $G(PRCHXXX)="" S ERRFLG=2,Y=0;46////^S X=$G(PRCHXXX);I PRCHCDNO'="",X'=PRCHCDNO W !,?5,"Please verify the accounting information for the new Purchase Card.",!;
"KRN",.402,2663,"DR",1,442,5)
I X]"" S PRCHP0=^PRC(440.5,X,0),PRCHFCP=$P(PRCHP0,U,2),PRCHCC=$P(PRCHP0,U,3),PRCHBOC1=$P(PRCHP0,U,4),PRCHDLOC=$P(PRCHP0,U,7),PRCHCD=$P(PRCHP0,U),PRCHCDNO=+X,PRCHHLDR=$P(PRCHP0,U,8);61////^S X=PRCHHLDR;55///^S X=PRCHCD;Q;Q;Q;Q;
"KRN",.402,2663,"DR",1,442,6)
.1//^N %I,%H,% D NOW^%DTC;I +X<DT W $C(7),!!,"Enter TODAY or a future date only. Contact Fiscal or A&MM Service for ",!,"assistance with PO requiring prior date since an ET is required.",! D ODATE^PRCHNPO5 S Y=.1;
"KRN",.402,2663,"DR",1,442,7)
S PRCHN("MP")=$S($D(^PRCD(442.5,+X,0)):$P(^(0),U,3),1:""),PRCHN("INV")=$S(PRCHN("INV")]"":PRCHN("INV"),1:"VA FSC");.08//^S X="N";53R~;I $G(PRCFLAG)=1 S $P(^PRC(442,DA,23),U,14)="" K X S Y=53;S PRCHVEN=+X;5////^S X=PRCHVEN;
"KRN",.402,2663,"DR",1,442,8)
8//^S X="B";S PRCHN("MP")=$P(^PRC(442,DA,0),U,2);1//^S X=PRCHFCP;S PRC("CP")=X;S PRCHN("SFC")=$P(^PRC(442,DA,0),U,19);@2;I $G(PRC("BBFY"))="" S PRC("BBFY")=$$BBFY^PRCSUT(PRC("SITE"),PRC("FY"),$P(^PRC(442,DA,0),U,3));
"KRN",.402,2663,"DR",1,442,9)
26///^S X=PRC("BBFY");D EN2^PRCHNPO3;2//^S X=PRCHCC;5.2;52;@88;54;I X["N" S Y=6.4;5.6//^S X=PRCHDLOC;
"KRN",.402,2663,"DR",1,442,10)
I X="PATIENT",$P(^PRC(442,DA,0),U,19) I $P(^(0),U,19)!(PRCHN("MP")=2) W *7,!,"  PATIENT DELIVERY not valid for this type of order!" S Y=5.6;5.4//^S X=$G(PRCY);K DIC("DR");6.4//DESTINATION;S PRCHN("FOB")=X;Q;Q;Q;Q;
"KRN",.402,2663,"DR",1,442,11)
7//^N %I,%H,% D NOW^%DTC S X=X,X1=X,X2=+10,X="" D C^%DTC:X1;8.2//^S X="N/A";13;S PRCHSHP=+X;S:X']"" Y="@99";I $P(^PRC(442,DA,0),U,19)'=2 S Y="@98";S PRCHSBOC=$P($G(^PRCD(420.2,2299,0)),U);13.05////^S X=PRCHSBOC;S Y="@100";@98;
"KRN",.402,2663,"DR",1,442,12)
13.05;@100;I '(PRCHN("FOB")="O"&((PRCHSHP>250)!(PRCHSHP=0))) S Y="@99";13.2;13.4;13.3;@99;K PRCHDUZ;40;20;
"KRN",.402,2663,"DR",2,442.01)
S PRCHREC=DA;.01;K PRCSAVE;S PRCHINUM=DA,PRCHOLD=$P($G(^PRC(442,PRCHIEN,2,PRCHINUM,0)),U,2);1.5;I X=""&($L($P($G(^PRC(442,DA(1),2,DA,2)),U,3))=4) S PRCSAVE="G",Y="@101";
"KRN",.402,2663,"DR",2,442.01,1)
I X=""&($L($P($G(^PRC(442,DA(1),2,DA,2)),U,3))=5) S PRCSAVE="S",Y="@101";I X=""&($G(PRCSAVE)="") D ^PRCHAAC4 I $D(PRCHANS) S PRCSAVE=PRCHANS;@101;I $G(PRCSAVE)="^" K PRCHANS,PRCSAVE S Y=0;
"KRN",.402,2663,"DR",2,442.01,2)
I X'="",$G(PRCHN("SFC"))'=2 S PRCHMAND=$P($G(^PRC(441,X,0)),U,8) I $G(PRCHMAND),PRCHMAND'=$P($G(^PRC(442,DA(1),1)),U) W !,"This item can only be purchased from "_$P($G(^PRC(440,PRCHMAND,0)),U) S Y=1.5;1;
"KRN",.402,2663,"DR",2,442.01,3)
I '$D(^PRC(442,DA(1),2,DA,1)) W $C(7),!,"Description is Required!!" S Y=1;S (PRCHQUAN,Z)="" I $D(^PRC(442,DA(1),1)) S Z=$S($D(^PRC(441,+$P(^PRC(442,DA(1),2,DA,0),U,5),2,+^PRC(442,DA(1),1),0)):^(0),1:"");
"KRN",.402,2663,"DR",2,442.01,4)
I Z'="" W:$P(Z,U,12)'="" !,"    Minimum Order Qty.: ",$P(Z,U,12) W:$P(Z,U,9) !,"    Maximum Order Qty.: ",$P(Z,U,9) W:$P(Z,U,11) !,"    Required Order Multiple: ",$P(Z,U,11) S PRCHQUAN=Z K Z;
"KRN",.402,2663,"DR",2,442.01,5)
2//^S X=$S($P(PRCHQUAN,U,12)'="":$P(PRCHQUAN,U,12),$P(PRCHQUAN,U,11)'="":$P(PRCHQUAN,U,11),1:"");
"KRN",.402,2663,"DR",2,442.01,6)
I $P(PRCHQUAN,U,12)'="" I X<$P(PRCHQUAN,U,12) W !,"QUANTITY is less than the Minimum Order Quantity of ",$P(PRCHQUAN,U,12),$C(7) S Y=2;
"KRN",.402,2663,"DR",2,442.01,7)
I $P(PRCHQUAN,U,9)'="" I X>$P(PRCHQUAN,U,9) W !,"QUANTITY is more than the Maximum Order Quantity of ",$P(PRCHQUAN,U,9),$C(7) S Y=2;
"KRN",.402,2663,"DR",2,442.01,8)
I $P(PRCHQUAN,U,11)'="" I X#$P(PRCHQUAN,U,11)'=0 W !,"QUANTITY is not a Required Order Multiple value of ",$P(PRCHQUAN,U,11),$C(7) S Y=2;3;5;D TSTREQ1^PRCHNPO9;3.1;S DIE("NO^")="A";9.7;K DIE("NO^");9;8T~;
"KRN",.402,2663,"DR",2,442.01,9)
I $G(PRCSAVE)'="^" D EN10^PRCHNPO7;S PRCHFCP=+$P(^PRC(442,DA(1),0),U,3),PRCHN("COM")=$S($D(^PRC(441.2,+X,0)):$P(^(0),U,4),1:"") S:(PRCHN("COM")'=1)&($E($P($G(^PRC(420,PRCHSTN,1,PRCHFCP,0)),U,18),1,2)'=11) Y=4;4;
"KRN",.402,2663,"DR",2,442.01,10)
S PRCHIDA=+$P(^PRC(442,DA(1),2,DA,0),U,5);K PRCHBOCC;I PRCHN("SFC")=2 S ACCT=$$ACCT^PRCPUX1($E($$NSN^PRCPUX1(PRCHIDA),1,4)) S PRCHBOCC=$S(ACCT=1:2697,ACCT=2:2698,ACCT=3:2699,ACCT=6:2699,ACCT=8:2696,1:2699);
"KRN",.402,2663,"DR",2,442.01,11)
I '$G(PRCHBOCC) S Y="@87";S PRCHBOCC=$P($G(^PRCD(420.2,PRCHBOCC,0)),U);3.5////^S X=PRCHBOCC;S Y="@89";@87;3.5;@89;K PRCHBOCC,PRCHANS,PRCSAVE;
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
159^3111013
"PKG",455,22,1,"PAH",1,1,0)
^^8^8^3111013
"PKG",455,22,1,"PAH",1,1,1,0)
 
"PKG",455,22,1,"PAH",1,1,2,0)
1. Duplicate 'AB' cross references exist in file 442 [PROCUREMENT & 
"PKG",455,22,1,"PAH",1,1,3,0)
   ACCOUNTING TRANSACTIONS.
"PKG",455,22,1,"PAH",1,1,4,0)
 
"PKG",455,22,1,"PAH",1,1,5,0)
2. Modify IFCAP security key PRCSCPO 'Keep at Terminate' setting to 'NO'.
"PKG",455,22,1,"PAH",1,1,6,0)
 
"PKG",455,22,1,"PAH",1,1,7,0)
3. Option PRCB MONTHLY ACCRUAL creating multiple monthly accrual nodes in
"PKG",455,22,1,"PAH",1,1,8,0)
   file 440.7 [MONTHLY ACCRUAL].
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PRC159P")
0^1^B4980889^n/a
"RTN","PRC159P",1,0)
PRC159P ;VMP/RB - PRCSCPO key setting/audit ;08/01/11
"RTN","PRC159P",2,0)
 ;;5.1;IFCAP;**159**;Aug 1, 2011;Build 9
"RTN","PRC159P",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRC159P",4,0)
 ;;
"RTN","PRC159P",5,0)
 Q
"RTN","PRC159P",6,0)
START ;
"RTN","PRC159P",7,0)
 ;   Pre install to set key PRCSCPO terminate setting to 'NO" and
"RTN","PRC159P",8,0)
 ;   audit to look for terminated employees having PRCSCPO key.
"RTN","PRC159P",9,0)
 ;
"RTN","PRC159P",10,0)
 Q:$D(^XTMP("PRC159P"))
"RTN","PRC159P",11,0)
 K ^XTMP("PRC159P")
"RTN","PRC159P",12,0)
SETUP K ^XTMP("PRC159P") D NOW^%DTC S RMSTART=%,(T1,T2,T3)=0
"RTN","PRC159P",13,0)
 S ^XTMP("PRC159P","START COMPILE")=RMSTART
"RTN","PRC159P",14,0)
 S ^XTMP("PRC159P","END COMPILE")="RUNNING"
"RTN","PRC159P",15,0)
 S ^XTMP("PRC159P",0)=$$FMADD^XLFDT(RMSTART,120)_"^"_RMSTART
"RTN","PRC159P",16,0)
SET S CPOKEY=$O(^DIC(19.1,"B","PRCSCPO",0)) D:CPOKEY  I 'CPOKEY W !!,"** NO PRCSCPO KEY DEFINED AS IFCAP SECURITY KEY **" G EXIT
"RTN","PRC159P",17,0)
 . S R0=^DIC(19.1,CPOKEY,0)
"RTN","PRC159P",18,0)
 . S ^XTMP("PRC159P","KEY",0)=$P(R0,U,4)_U_"n"
"RTN","PRC159P",19,0)
 . S DA=CPOKEY,DIE="^DIC(19.1,",DR=".04///n" D ^DIE
"RTN","PRC159P",20,0)
AUDIT ;FIND EMPLOYEES IN ^VA(200) W/ KEY PRCSCPO
"RTN","PRC159P",21,0)
 S IEN=0,U="^"
"RTN","PRC159P",22,0)
1 S IEN=$O(^VA(200,IEN)) G EXIT:IEN=""!(IEN]"@")
"RTN","PRC159P",23,0)
 S R0=$G(^VA(200,IEN,0)) I R0="" S STS="X",T3=T3+1 D 3 G 1
"RTN","PRC159P",24,0)
2 S VAKEY=$O(^VA(200,IEN,51,"B",CPOKEY,0)) G 1:VAKEY=""!(VAKEY]"@")  D
"RTN","PRC159P",25,0)
 . S KR0=$G(^VA(200,IEN,51,VAKEY,0)) Q:$P(KR0,U)'=VAKEY
"RTN","PRC159P",26,0)
 . I $P(R0,U,11) S STS="T",T1=T1+1 D  D 3 Q
"RTN","PRC159P",27,0)
 .. S DA=VAKEY,DA(1)=IEN,DIK="^VA(200,"_DA(1)_",51," D ^DIK
"RTN","PRC159P",28,0)
 . S STS="A",T2=T2+1 D 3
"RTN","PRC159P",29,0)
 G 1
"RTN","PRC159P",30,0)
3 S ^XTMP("PRC159P",STS,IEN,0)=$P(R0,U)_U_$P(R0,U,11)
"RTN","PRC159P",31,0)
 Q
"RTN","PRC159P",32,0)
EXIT ;
"RTN","PRC159P",33,0)
 D NOW^%DTC S RMEND=%
"RTN","PRC159P",34,0)
 S ^XTMP("PRC159P","END COMPILE")=RMEND_U_T1_U_T2_U_T3
"RTN","PRC159P",35,0)
 W !!,"Number of TERMINATED employees with key PRCSCPO still assigned: ",T1
"RTN","PRC159P",36,0)
 W !!,"Number of ACTIVE employees with key PRCSCPO still assigned: ",T2
"RTN","PRC159P",37,0)
 W !!,"Number of employees with *NO* node 0 information: ",T3
"RTN","PRC159P",38,0)
 K RMEND,RMSTART,%,DR,DA,DIE,DIK,IEN,IENKEY,VAKEY,CPOKEY,T1,T2,T3,STS,R0,KR0
"RTN","PRC159P",39,0)
 Q
"RTN","PRC159P1")
0^4^B6863193^n/a
"RTN","PRC159P1",1,0)
PRC159P1 ;VMP/RB-PURGE ALL DUPLICATE PRC(442,"AB" ORDER DATE REFERENCES 
"RTN","PRC159P1",2,0)
 ;;5.1;IFCAP;**159**;Oct 01, 2009;Build 9
"RTN","PRC159P1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRC159P1",4,0)
 ;  Pre install routine in patch PRC*5.1*159 that will purge duplicate
"RTN","PRC159P1",5,0)
 ;  entries in cross reference ^PRC(442,"AB") that were left 
"RTN","PRC159P1",6,0)
 ;  unkilled when the order was edited on a subsequent date.
"RTN","PRC159P1",7,0)
 ;;
"RTN","PRC159P1",8,0)
 Q
"RTN","PRC159P1",9,0)
START ;Kill off extraneous index xref left behind when using CHANGE EXISTING TRANSACTION NUMBER option
"RTN","PRC159P1",10,0)
 N RMSTART,IEN442,RMEND,R0,R1,TOT,TOT1,TOT3,TOT4,TOT5,PRCODT,PRCODT0
"RTN","PRC159P1",11,0)
 I $D(^XTMP("PRC159P1")) Q
"RTN","PRC159P1",12,0)
 D NOW^%DTC S RMSTART=%
"RTN","PRC159P1",13,0)
 S ^XTMP("PRC159P1","START COMPILE")=RMSTART
"RTN","PRC159P1",14,0)
 S ^XTMP("PRC159P1","END COMPILE")="RUNNING"
"RTN","PRC159P1",15,0)
 S ^XTMP("PRC159P1",0)=$$FMADD^XLFDT(RMSTART,120)_"^"_RMSTART
"RTN","PRC159P1",16,0)
 S U="^",PRCODT=0,(TOT,TOT1,TOT3,TOT4,TOT5)=0
"RTN","PRC159P1",17,0)
1 S PRCODT=$O(^PRC(442,"AB",PRCODT)),IEN442=0 G 5:PRCODT=""
"RTN","PRC159P1",18,0)
2 S IEN442=$O(^PRC(442,"AB",PRCODT,IEN442)) G 1:IEN442=""
"RTN","PRC159P1",19,0)
 S TOT=TOT+1
"RTN","PRC159P1",20,0)
 I '$D(^PRC(442,IEN442,0)) D  G 2
"RTN","PRC159P1",21,0)
 . S TOT4=TOT4+1
"RTN","PRC159P1",22,0)
 . K ^PRC(442,"AB",PRCODT,IEN442)
"RTN","PRC159P1",23,0)
 . S ^XTMP("PRC159P1","M0",IEN442,PRCODT)=""
"RTN","PRC159P1",24,0)
 I '$D(^PRC(442,IEN442,1)) D  G 2
"RTN","PRC159P1",25,0)
 . S TOT5=TOT5+1
"RTN","PRC159P1",26,0)
 . K ^PRC(442,"AB",PRCODT,IEN442)
"RTN","PRC159P1",27,0)
 . S ^XTMP("PRC159P1","M1",IEN442,PRCODT)=""
"RTN","PRC159P1",28,0)
 S R0=$G(^PRC(442,IEN442,0)),R1=$G(^PRC(442,IEN442,1)),PRCODT0=$P(R1,U,15)
"RTN","PRC159P1",29,0)
 I PRCODT'=PRCODT0 D
"RTN","PRC159P1",30,0)
 . S TOT1=TOT1+1
"RTN","PRC159P1",31,0)
 . K ^PRC(442,"AB",PRCODT,IEN442)
"RTN","PRC159P1",32,0)
 . S ^XTMP("PRC159P1","D",IEN442,PRCODT)=PRCODT0
"RTN","PRC159P1",33,0)
 G 2
"RTN","PRC159P1",34,0)
 ;Insures that all file 442 entries have an 'AB' x-ref
"RTN","PRC159P1",35,0)
5 S IEN442=0
"RTN","PRC159P1",36,0)
6 S IEN442=$O(^PRC(442,IEN442)) G EXIT:IEN442=""
"RTN","PRC159P1",37,0)
 I '$D(^PRC(442,IEN442,1)) G 6
"RTN","PRC159P1",38,0)
 S R0=$G(^PRC(442,IEN442,0)),R1=$G(^PRC(442,IEN442,1)),PRCODT0=$P(R1,U,15)
"RTN","PRC159P1",39,0)
 I 'PRCODT0 G 6
"RTN","PRC159P1",40,0)
 I '$D(^PRC(442,"AB",PRCODT0,IEN442)) D
"RTN","PRC159P1",41,0)
 . S TOT3=TOT3+1
"RTN","PRC159P1",42,0)
 . S ^PRC(442,"AB",PRCODT0,IEN442)=""
"RTN","PRC159P1",43,0)
 . S ^XTMP("PRC159P1","S",IEN442,PRCODT0)=$P(R0,U)
"RTN","PRC159P1",44,0)
 G 6
"RTN","PRC159P1",45,0)
EXIT ;
"RTN","PRC159P1",46,0)
 D NOW^%DTC S RMEND=%
"RTN","PRC159P1",47,0)
 S ^XTMP("PRC159P1","TOTALS")=TOT_U_TOT1_U_TOT3_U_TOT4_U_TOT5
"RTN","PRC159P1",48,0)
 S ^XTMP("PRC159P1","END COMPILE")=RMEND
"RTN","PRC159P1",49,0)
 W !!,"Number of assigned 'AB' cross references: ",TOT
"RTN","PRC159P1",50,0)
 W !!,"Number of purged 'AB' x-ref with undefined node 0 in file 442: ",TOT4
"RTN","PRC159P1",51,0)
 W !!,"Number of purged 'AB' x-ref with undefined node 1 in file 442: ",TOT5
"RTN","PRC159P1",52,0)
 W !!,"Number of purged 'AB' x-ref with diff node 1 P.O. Date: ",TOT1
"RTN","PRC159P1",53,0)
 W !!,"Number of created 'AB' x-ref for 442 orders missing P.O. Date x-ref: ",TOT3
"RTN","PRC159P1",54,0)
 K %
"RTN","PRC159P1",55,0)
 Q
"RTN","PRCB1F")
0^2^B41135411^B39550550
"RTN","PRCB1F",1,0)
PRCB1F ;WISC/PLT-IFCAP MONTHLY ACCRUAL ;9/13/96  16:21
"RTN","PRCB1F",2,0)
V ;;5.1;IFCAP;**64,72,142,159**;Oct 20, 2000;Build 9
"RTN","PRCB1F",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCB1F",4,0)
 QUIT  ;invalid entry
"RTN","PRCB1F",5,0)
 ;
"RTN","PRCB1F",6,0)
 ;ZTQPARAM=999 if from schedule option
"RTN","PRCB1F",7,0)
EN ;monthly accrual
"RTN","PRCB1F",8,0)
 N PRCA,PRCB,PRCQCD,PRCOPT,PRCRI,PRCDI,PRCDUZ,PRC,PRCDES,PTCTD
"RTN","PRCB1F",9,0)
 N A,B,C
"RTN","PRCB1F",10,0)
 ; S PRCQCD=1 ;over lapping days
"RTN","PRCB1F",11,0)
 G Q4:$G(ZTQPARAM)=999!$G(ZTQUEUED)
"RTN","PRCB1F",12,0)
Q1 ;station
"RTN","PRCB1F",13,0)
 S PRCF("X")="AS" D ^PRCFSITE G:'% EXIT
"RTN","PRCB1F",14,0)
 S PRCRI(420)=+PRC("SITE"),PRCOPT=1
"RTN","PRCB1F",15,0)
Q4 ;accrual for month/year
"RTN","PRCB1F",16,0)
 S A=$$DATE^PRC0C("T","E")
"RTN","PRCB1F",17,0)
 S PRCTD=$P(A,"^",4)_"/"_$E($P(A,"^",3),3,4)_"^"_$P(A,"^",7)_"^"_$P(A,"^",8)
"RTN","PRCB1F",18,0)
 S A=$$DATE^PRC0C($P(A,"^",4)_"/1/"_$P(A,"^",3),"E"),$P(PRCTD,"^",4,6)=$P(A,"^",4)_"/"_$E($P(A,"^",3),3,4)_"^"_$P(A,"^",7)_"^"_$P(A,"^",8)
"RTN","PRCB1F",19,0)
 S A=$$DATE^PRC0C($P(A,"^",8)-15,"H")
"RTN","PRCB1F",20,0)
 S A=$$DATE^PRC0C($P(A,"^",4)_"/1/"_$P(A,"^",3),"E"),$P(PRCTD,"^",7,9)=$P(A,"^",4)_"/"_$E($P(A,"^",3),3,4)_"^"_$P(A,"^",7)_"^"_$P(A,"^",8)
"RTN","PRCB1F",21,0)
 G SCHED:$G(ZTQPARAM)=999!$G(ZTQUEUED)
"RTN","PRCB1F",22,0)
 S E="O^4:7^K:X'?1.2N1""/""2N&(X'?1.2N1""/""4N)!(X<1!(X>12)) X",Y(1)="Enter an accrual month/year in format: MM/YY or MM/YYYY. For example: 9/96 or 9/1996"
"RTN","PRCB1F",23,0)
 D FT^PRC0A(.X,.Y,"For Accrual Month/Year",E,$P(PRCTD,"^"))
"RTN","PRCB1F",24,0)
 G:X["^"!(X="")!(Y'?1.2N1"/"2.4N) EXIT
"RTN","PRCB1F",25,0)
 S $P(Y,"/",2)=+$$YEAR^PRC0C($P(Y,"/",2)),$P(Y,"/")=$E(100+Y,2,3)
"RTN","PRCB1F",26,0)
 S PRCA=Y,A=$$DATE^PRC0C(PRCA,"E"),$P(PRCA,"^",2,999)=A W "     Fiscal Month/Year: ",$P(PRCA,"^",10),"/",$P(PRCA,"^",2)
"RTN","PRCB1F",27,0)
 S $P(PRCA,"^",11)=$P(PRCA,"^",8)_"-"_PRC("SITE")
"RTN","PRCB1F",28,0)
 I $P(PRCA,"^",9)<$P(PRCTD,"^",9),$O(^PRCH(440.7,"B",$P(PRCA,"^",11),0))<1 D EN^DDIOL("Accrual report for "_$P(PRCA,"^")_" is NOT in file.") G Q4
"RTN","PRCB1F",29,0)
 I $P(PRCTD,"^",6)<$P(PRCA,"^",9) D EN^DDIOL("Too early to accrue for "_$P(PRCA,"^")) G Q4
"RTN","PRCB1F",30,0)
 S $P(PRCA,"^",12)=0
"RTN","PRCB1F",31,0)
Q40 S B="O^1:Compile/Print Monthly Accrual;2:Edit Monthly Accrual;3:Generate/Rebuild FMS SV-Document"
"RTN","PRCB1F",32,0)
 K X,Y S Y(1)="^W ""Enter an option number 1 to 3."""
"RTN","PRCB1F",33,0)
 D SC^PRC0A(.X,.Y,"Select Number",B,"")
"RTN","PRCB1F",34,0)
 S A=Y K X,Y
"RTN","PRCB1F",35,0)
 G Q4:A=""!(A["^")
"RTN","PRCB1F",36,0)
 S PRCOPT=+A
"RTN","PRCB1F",37,0)
 G Q45:PRCOPT=2,Q47:PRCOPT=3
"RTN","PRCB1F",38,0)
 I $O(^PRCH(440.6,"ST","N~",0)) D EN^DDIOL("Warning: An unregistered card exists in your file. Contact the P.C. Coordinator.")
"RTN","PRCB1F",39,0)
 I $P(PRCA,"^",9)'=$P(PRCTD,"^",6),$P(PRCA,"^",9)'=$P(PRCTD,"^",9) G Q5
"RTN","PRCB1F",40,0)
 S PRCRI(440.7)=$O(^PRCH(440.7,"B",$P(PRCA,"^",11),0)) G Q5:'PRCRI(440.7)
"RTN","PRCB1F",41,0)
 S A=^PRCH(440.7,PRCRI(440.7),0),B=$P(A,"^",2),B=$E(B,4,5)_"/"_$E(B,6,7)_"/"_$E(B,2,3)_"@"_$E(B,9,10)_":"_($E(B,11)\1)_($E(B,12)\1)
"RTN","PRCB1F",42,0)
 D EN^DDIOL("The last compiling date is "_B)
"RTN","PRCB1F",43,0)
 D:$P(A,"^",6) EN^DDIOL("Warning: Recompiling will overwrite all edited accrual amounts")
"RTN","PRCB1F",44,0)
Q41 D YN^PRC0A(.X,.Y,"Recompile Accrual Report:","O","NO")
"RTN","PRCB1F",45,0)
 I X["^" G Q4
"RTN","PRCB1F",46,0)
 L +^PRCH(440.7,PRCRI(440.7)):5 E  W !,"Another user has this Accrual File open, please try later" G Q40
"RTN","PRCB1F",47,0)
 S $P(PRCA,"^",12)=Y G Q5
"RTN","PRCB1F",48,0)
Q45 ;eidt accrual amount
"RTN","PRCB1F",49,0)
 I $P(PRCA,"^",9)'=$P(PRCTD,"^",6),$P(PRCA,"^",9)'=$P(PRCTD,"^",9) D EN^DDIOL("It is too late to edit accrual amounts") G Q4
"RTN","PRCB1F",50,0)
 S PRCRI(440.7)=$O(^PRCH(440.7,"B",$P(PRCA,"^",11),0))
"RTN","PRCB1F",51,0)
 I 'PRCRI(440.7) D EN^DDIOL("You need to select Compile/Print option first") G Q40
"RTN","PRCB1F",52,0)
 L +^PRCH(440.7,PRCRI(440.7)):5 E  W !,"Another user has this Accrual File open, please try later" G Q40
"RTN","PRCB1F",53,0)
 G Q5
"RTN","PRCB1F",54,0)
 ;
"RTN","PRCB1F",55,0)
Q47 ;generate sv-document
"RTN","PRCB1F",56,0)
 I $P(PRCA,"^",9)'=$P(PRCTD,"^",6),$P(PRCA,"^",9)'=$P(PRCTD,"^",9) D EN^DDIOL("It is too late to generate SV-documents") G Q4
"RTN","PRCB1F",57,0)
 S PRCRI(440.7)=$O(^PRCH(440.7,"B",$P(PRCA,"^",11),0))
"RTN","PRCB1F",58,0)
 I 'PRCRI(440.7) D EN^DDIOL("You need to select Compile/Print option first") G Q40
"RTN","PRCB1F",59,0)
 L +^PRCH(440.7,PRCRI(440.7)):5 E  W !,"Another user has this Accrual File open, please try later" G Q40
"RTN","PRCB1F",60,0)
 S A=^PRCH(440.7,PRCRI(440.7),0) D:$P(A,"^",7)]""
"RTN","PRCB1F",61,0)
 . N GECSDATA
"RTN","PRCB1F",62,0)
 . S A=$P($P(A,"^",7),"/",2),X="SV-"_A D DATA^GECSSGET(X,0)
"RTN","PRCB1F",63,0)
 . I '$G(GECSDATA) D EN^DDIOL(PRCPT_" NOT found!") QUIT
"RTN","PRCB1F",64,0)
 . S PRCRI(2100.1)=GECSDATA,PRCID=GECSDATA(2100.1,PRCRI(2100.1),.01,"E")
"RTN","PRCB1F",65,0)
 . D EN^DDIOL(" "),EN^DDIOL($J("FMS Document: ",15)_PRCID)
"RTN","PRCB1F",66,0)
 . D EN^DDIOL($J("Description: ",15)_GECSDATA(2100.1,PRCRI(2100.1),4,"E"))
"RTN","PRCB1F",67,0)
 . D EN^DDIOL($J("Status: ",15)_GECSDATA(2100.1,PRCRI(2100.1),3,"E"))
"RTN","PRCB1F",68,0)
 . D EN^DDIOL($J("Created: ",15)_GECSDATA(2100.1,PRCRI(2100.1),2,"E"))
"RTN","PRCB1F",69,0)
 . QUIT
"RTN","PRCB1F",70,0)
 G Q5
"RTN","PRCB1F",71,0)
Q5 D YN^PRC0A(.X,.Y,"Ready to "_$P("Compile/Print,Edit,Generate/Rebuild Document",",",PRCOPT),"O","NO")
"RTN","PRCB1F",72,0)
 I X["^"!(X="")!'Y G Q4
"RTN","PRCB1F",73,0)
 I PRCOPT=1 D ACCR G Q5X
"RTN","PRCB1F",74,0)
 L +^PRCH(440.7,PRCRI(440.7)):3 E  W !,"Another user has this Accrual file open, please try later" G Q4
"RTN","PRCB1F",75,0)
 I PRCOPT=2 D EDIT
"RTN","PRCB1F",76,0)
 I PRCOPT=3 D
"RTN","PRCB1F",77,0)
 . D EN^DDIOL("Generating the monthly accrual FMS SV-Document")
"RTN","PRCB1F",78,0)
 . S PRCB=$P(^PRCH(440.7,PRCRI(440.7),0),"^",7)
"RTN","PRCB1F",79,0)
 . D SV^PRCB8B(.X,PRCRI(440.7)_"^"_PRCA,$TR(PRCB,"/","^"))
"RTN","PRCB1F",80,0)
 . I X>0 D EDIT^PRC0B(.X,"440.7;^PRCH(440.7,;"_PRCRI(440.7),"2///^S X=""N"";6////"_X)
"RTN","PRCB1F",81,0)
 . QUIT
"RTN","PRCB1F",82,0)
Q5X I $G(PRCRI(440.7)) L -^PRCH(440.7,PRCRI(440.7))  ;PRC*5.1*159 insures previously compile file entry is unlocked when recompile is queued
"RTN","PRCB1F",83,0)
 D EN^DDIOL(" "),EN^DDIOL(" ") G Q4
"RTN","PRCB1F",84,0)
 ;
"RTN","PRCB1F",85,0)
EXIT QUIT
"RTN","PRCB1F",86,0)
 ;
"RTN","PRCB1F",87,0)
 ;
"RTN","PRCB1F",88,0)
ACCR ;start accrual
"RTN","PRCB1F",89,0)
 N PRCDUZ
"RTN","PRCB1F",90,0)
 S PRCDUZ=DUZ
"RTN","PRCB1F",91,0)
 S ZTDESC="IFCAP Monthly Accrual for Month/Year: "_$P(PRCA,"^")
"RTN","PRCB1F",92,0)
 S PRCDES=ZTDESC
"RTN","PRCB1F",93,0)
 S ZTRTN="TMEN^PRCB1F1" F A="PRCOPT","PRCA","PRCTD","PRCDUZ","PRCDES","DUZ*" S ZTSAVE(A)=""
"RTN","PRCB1F",94,0)
 D ^PRCFQ
"RTN","PRCB1F",95,0)
 QUIT
"RTN","PRCB1F",96,0)
 ;
"RTN","PRCB1F",97,0)
EDIT ;edit accrual amount
"RTN","PRCB1F",98,0)
 N PRCDI
"RTN","PRCB1F",99,0)
 N A,B,X,Y
"RTN","PRCB1F",100,0)
 D EDIT^PRC0B(.X,"440.7;^PRCH(440.7,;"_PRCRI(440.7),"5///T")
"RTN","PRCB1F",101,0)
Q21 D EN^DDIOL(" "),EN^DDIOL($TR($J("",78)," ","-")) S PRCDI="440.7;^PRCH(440.7,;"_PRCRI(440.7)_";1~440.701;^PRCH(440.7,"_PRCRI(440.7)_",50,"
"RTN","PRCB1F",102,0)
 D LOOKUP^PRC0B(.X,.Y,PRCDI,"AEMOQ","Select Fund or FCP/PRJ (ACC) Code: ")
"RTN","PRCB1F",103,0)
 I Y<0!(X="") K X QUIT
"RTN","PRCB1F",104,0)
 K X S PRCRI(440.701)=+Y,PRCAED=$P(Y,"^",3)
"RTN","PRCB1F",105,0)
 S PRCDI=";^PRCH(440.7,;"_PRCRI(440.7)_"~440.701;^PRCH(440.7,"_PRCRI(440.7)_",50,;"_PRCRI(440.701)
"RTN","PRCB1F",106,0)
 S A=^PRCH(440.7,PRCRI(440.7),50,PRCRI(440.701),0),B=$P(A,"^",2)-$P(A,"^",3)
"RTN","PRCB1F",107,0)
 D EN^DDIOL("Accrual Account: "_$P(A,"^",1))
"RTN","PRCB1F",108,0)
 D EN^DDIOL("Unpaid P.C.O Amount: "_$J($P(A,"^",2),0,2)_"         Unreconciled Amount: "_$J($P(A,"^",3),0,2))
"RTN","PRCB1F",109,0)
 D EN^DDIOL("Calculated Accrual Amount: "_$J(B,0,2))
"RTN","PRCB1F",110,0)
 D EDIT^PRC0B(.X,PRCDI,"4;5;6")
"RTN","PRCB1F",111,0)
 G Q21
"RTN","PRCB1F",112,0)
 ;
"RTN","PRCB1F",113,0)
SCHED ;compiling for all stations
"RTN","PRCB1F",114,0)
 S Y=$P(PRCTD,"^",7),$P(Y,"/",2)=+$$YEAR^PRC0C($P(Y,"/",2)),$P(Y,"/")=$E(100+Y,2,3)
"RTN","PRCB1F",115,0)
 S PRCA=Y,A=$$DATE^PRC0C(PRCA,"E"),$P(PRCA,"^",2,999)=A
"RTN","PRCB1F",116,0)
 S PRCRI(420)=0
"RTN","PRCB1F",117,0)
 F  S PRCRI(420)=$O(^PRC(420,PRCRI(420))) QUIT:'PRCRI(420)  S PRC("SITE")=$P($G(^PRC(420,PRCRI(420),0)),"^") I PRC("SITE") S $P(PRCA,"^",11)=$P(PRCA,"^",8)_"-"_PRC("SITE") D
"RTN","PRCB1F",118,0)
 . N PRCB,PRCD,PRCE,PRCG,PRCDI,PRCRICB,PRCLOCK,PRCRI,PRCID,PRCAMT,PRCBOC,PRAMTP,PRCAMTR,PRCSUBT,PRCAMTA
"RTN","PRCB1F",119,0)
 . N A,B,C
"RTN","PRCB1F",120,0)
 . S PRCID=$P(PRCA,"^",11),PRC("SITE")=$P(PRCID,"-",2)
"RTN","PRCB1F",121,0)
 . D ACCR^PRCB1F1(PRCA,PRCTD)
"RTN","PRCB1F",122,0)
 . QUIT
"RTN","PRCB1F",123,0)
 QUIT
"RTN","PRCHNPO5")
0^3^B38701458^B37990669
"RTN","PRCHNPO5",1,0)
PRCHNPO5 ;WISC/RSD,RHD/DL-INPUT TRANSFORM FOR FILE 440,441,442 ;9/5/00  10:59
"RTN","PRCHNPO5",2,0)
V ;;5.1;IFCAP;**113,159**;Oct 20, 2000;Build 9
"RTN","PRCHNPO5",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCHNPO5",4,0)
 ;
"RTN","PRCHNPO5",5,0)
EN1 ;FILE 442, FCP #1
"RTN","PRCHNPO5",6,0)
 I '$D(PRCHAMND),$D(^PRCS(410,+$P(^PRC(442,DA,0),U,12),0)),+$P(^(0),"-",4)'=+X W !,"Fund Control Point cannot be changed since 2237 has been selected." K X Q
"RTN","PRCHNPO5",7,0)
 S Z0=$E($P(^PRC(442,DA,0),"-",2),1,2),Z1=+X D EN4^PRCHNPO6 I '$T K X,Z0,Z1 Q
"RTN","PRCHNPO5",8,0)
 S DIC="^PRC(420,PRC(""SITE""),1,",DIC(0)="QEMNZ"
"RTN","PRCHNPO5",9,0)
 S:$D(PRCHPUSH) DIC("S")="I $P(^(0),U,12)=2"
"RTN","PRCHNPO5",10,0)
 I $G(PRCHPC)!$G(PRCHDELV) S DIC("S")="I $D(^PRC(420,""C"",DUZ,PRC(""SITE""),+Y))"
"RTN","PRCHNPO5",11,0)
 S D="B^C" D MIX^DIC1 K:Y<0!('$D(PRC("FY"))) X K DIC,PRCHCPO,Z0,Z1 Q:'$D(X)
"RTN","PRCHNPO5",12,0)
 N CCNODE S CCNODE=$G(^PRC(420,PRC("SITE"),1,+Y,2,0)) I $P(CCNODE,U,4)'>0!(CCNODE="") W !,"The Fund Control Point selected by you, does not have any",!,"Cost Centers listed under it.",!,$P(Y,U,2) K X Q
"RTN","PRCHNPO5",13,0)
 I $P(Y(0),U,12)'=2,$P(Y(0),U,18)="" W $C(7),!,"LOG Department Number is missing!!" K X Q
"RTN","PRCHNPO5",14,0)
 S Z0=$P(^PRC(442,DA,0),U,2),Z1=$P(Y(0),U,12) I Z1 I ((Z0=3)&(Z1=3)) S Z0=$P(^PRCD(442.5,Z0,0),U,1) W $C(7),!,"Fund Control Point not valid for a "_Z0_" order." K Z0,Z1,X Q
"RTN","PRCHNPO5",15,0)
 S Z0=$P(Y(0),U,1),PRC("FY")=$E(100+$E(PRC("FY"),2,3)+$E(PRC("FY"),4),2,3) S:$P(Y(0),U,10)]"" PRCHN("SVC")=$P($G(^DIC(49,+$P(Y(0),U,10),0)),U,1)
"RTN","PRCHNPO5",16,0)
 I $D(^PRC(420,PRC("SITE"),1,+Y,2,0)),$P(^(0),U,4)=1,$D(^($P(^(0),U,3),0)),$D(^PRCD(420.1,+^(0),0)) S PRCHN("CC")=$P(^(0)," ",1)
"RTN","PRCHNPO5",17,0)
 S PRC("APP")="",X=Z0,PRC("BBFY")=$$BBFY^PRCSUT(PRC("SITE"),PRC("FY"),+X) I PRC("BBFY")="" Q
"RTN","PRCHNPO5",18,0)
 S PRC("APP")=$P($$ACC^PRC0C(PRC("SITE"),+X_"^"_PRC("FY")_"^"_PRC("BBFY")),U,11) K Z0,Z1
"RTN","PRCHNPO5",19,0)
 I $P($G(^PRC(420,PRC("SITE"),1,+X,0)),U,19)=1 W !,"Sorry, this FCP is inactive!",! K X Q
"RTN","PRCHNPO5",20,0)
 Q
"RTN","PRCHNPO5",21,0)
 ;
"RTN","PRCHNPO5",22,0)
EN2 ;FILE 442, COST CENTER #2
"RTN","PRCHNPO5",23,0)
 S PRCFA("ALL")=1,DIC="^PRCD(420.1,",DIC(0)="QEMZ" D ^DIC K DIC,PRCFA("ALL") I Y'>0 W !,"The Cost Center entered by you is not in the COST CENTER FILE.",! K X,Y,Z0 Q
"RTN","PRCHNPO5",24,0)
 I $P(Y(0),U,2)=1 W !,"The Cost Center entered by you has been DEACTIVATED.",! K X,Y,Z0 Q
"RTN","PRCHNPO5",25,0)
 S X=+Y(0)
"RTN","PRCHNPO5",26,0)
 S Z1=$G(^PRC(420,PRC("SITE"),1,Z0,2,+Y(0),0)) I Z1'>0!(Z1="") W !,"This Cost Center isn't found in FCP "_$P(^PRC(420,PRC("SITE"),1,Z0,0),U,1)_".",! K X,Y,Z0,Z1 Q
"RTN","PRCHNPO5",27,0)
 N BOCNOD S BOCNOD=$G(^PRCD(420.1,+Y,1,0)) I $P(BOCNOD,U,4)'>0!(BOCNOD="") W !,"The Cost Center selected by you, does not have any BOCs listed",!,"under it.",! K X
"RTN","PRCHNPO5",28,0)
 K Y,Z0,Z1 Q
"RTN","PRCHNPO5",29,0)
 ;
"RTN","PRCHNPO5",30,0)
EN3 ;FILE 442, VENDOR #5
"RTN","PRCHNPO5",31,0)
 N REP,REP1
"RTN","PRCHNPO5",32,0)
 I DIE["PRC(442,",$D(DA),$D(^PRC(442,DA,2,"AE")) K X
"RTN","PRCHNPO5",33,0)
 Q:'$D(X)!$G(PRCHPC)
"RTN","PRCHNPO5",34,0)
 I '$G(PRCHDELV) D  Q:'$G(X)
"RTN","PRCHNPO5",35,0)
 . S DIC("S")="S Z0=+$P($G(^(2)),U,2) I "_$E("'",'$D(PRCHNRQ))_"Z0,'$D(^PRC(440,""AC"",""S"",Y))" I $D(PRCHPUSH) S DIC("S")=DIC("S")_",(Z0=1!(Z0=3))"
"RTN","PRCHNPO5",36,0)
 . D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X Q:'$D(X)  S PRCHNVF=Y
"RTN","PRCHNPO5",37,0)
 Q:'$D(^PRC(440,X,2))  S Z0=^(2) I $P(^PRC(442,DA,0),U,2)=4,$P(Z0,U,11)'="Y" W $C(7),!,"This Vendor is not set up as a GUARANTEED DELIVERY Vendor!." K X,Z0 Q
"RTN","PRCHNPO5",38,0)
 ;
"RTN","PRCHNPO5",39,0)
 ; SEE IF VENDOR IS INACTIVE.
"RTN","PRCHNPO5",40,0)
 ;
"RTN","PRCHNPO5",41,0)
 I $P($G(^PRC(440,X,10)),U,5)=1 K X Q
"RTN","PRCHNPO5",42,0)
 ;
"RTN","PRCHNPO5",43,0)
 ;
"RTN","PRCHNPO5",44,0)
 ;
"RTN","PRCHNPO5",45,0)
 K PRCHEDI I $P($G(^PRC(440,X,3)),U,2)="Y" S PRCHEDI="" ;CHECK FOR EDI VENDOR
"RTN","PRCHNPO5",46,0)
 I $D(^PRCD(420.8,+$P(Z0,U,2),0)) S PRCHN("SC")=$P(^(0),U,1)
"RTN","PRCHNPO5",47,0)
 K Z0
"RTN","PRCHNPO5",48,0)
 Q
"RTN","PRCHNPO5",49,0)
 ;
"RTN","PRCHNPO5",50,0)
EN4 ;FILE 442, EST. SHIPPING AND/OR HANDLING #13
"RTN","PRCHNPO5",51,0)
 S %A="   FOB is Destination, Are you sure you want Handling Charges ",%B="",%=1 D ^PRCFYN I %'=1 K X W !?3,"<DELETED>",$C(7)
"RTN","PRCHNPO5",52,0)
 Q
"RTN","PRCHNPO5",53,0)
 ;
"RTN","PRCHNPO5",54,0)
EN5 ;FILE 442, REPETITIVE (PR CARD) NO. #1.5
"RTN","PRCHNPO5",55,0)
 I $P(^PRC(442,DA(1),0),U,3)=""!($P(^(1),U,1)="") W !!,"Fund Control Point and Vendor must be entered before items !",$C(7) K X Q
"RTN","PRCHNPO5",56,0)
 S:'$D(PRC("SITE")) PRC("SITE")=+^PRC(442,DA(1),0) D LCK^PRCHCRD
"RTN","PRCHNPO5",57,0)
 Q
"RTN","PRCHNPO5",58,0)
 ;
"RTN","PRCHNPO5",59,0)
EN6 ;FILE 442, UNIT OF PURCHASE #3
"RTN","PRCHNPO5",60,0)
 D VEN Q:'$D(X)!($P(^PRC(442,DA(1),2,DA,0),U,5)="")
"RTN","PRCHNPO5",61,0)
 S:'$D(PRC("SITE")) PRC("SITE")=$P($P(^PRC(442,DA(1),0),U,1),"-",1) S PRCHCV=$P(^PRC(442,DA(1),1),U,1),PRCHCI=$P(^(2,DA,0),U,5),PRCHCPO=DA(1) D EN0^PRCHCRD
"RTN","PRCHNPO5",62,0)
 Q
"RTN","PRCHNPO5",63,0)
 ;
"RTN","PRCHNPO5",64,0)
EN8 ;FILE 442, CONTRACT FIELD #4
"RTN","PRCHNPO5",65,0)
 D VEN Q:'$D(X)  K DIC("S")
"RTN","PRCHNPO5",66,0)
 S Z0=$P(^PRC(442,DA(1),1),U,1),ZA=DA,ZA(1)=DA(1)
"RTN","PRCHNPO5",67,0)
 S DA(1)=Z0,DIC="^PRC(440,Z0,4,",DIC(0)="QELMZ",DLAYGO=440
"RTN","PRCHNPO5",68,0)
 I $G(PRCHPC)!$G(PRCHDELV) S DIC(0)="QEMZ"
"RTN","PRCHNPO5",69,0)
 D EN10,^DIC S X=$P(Y,U,2),DA=ZA,DA(1)=ZA(1) K ZA K:Y'>0 X
"RTN","PRCHNPO5",70,0)
 I $D(X),$D(DT),$P(Y(0),U,2)-DT<0 W !?10,"**CONTRACT HAS EXPIRED**",$C(7),$C(7) K X,DLAYGO Q
"RTN","PRCHNPO5",71,0)
 S:'$D(PRC("SITE")) PRC("SITE")=$P($P(^PRC(442,DA(1),0),U,1),"-",1) I $P(^PRC(442,DA(1),2,DA,0),U,5)]"" S PRCHCI=$P(^(0),U,5),PRCHCV=Z0,PRCHCPO=DA(1) D EN2^PRCHCRD
"RTN","PRCHNPO5",72,0)
 K DLAYGO
"RTN","PRCHNPO5",73,0)
 Q
"RTN","PRCHNPO5",74,0)
 ;
"RTN","PRCHNPO5",75,0)
EN9 ;FILE 442, ACTUAL UNIT COST #5
"RTN","PRCHNPO5",76,0)
 D VEN Q:'$D(X)!($P(^PRC(442,DA(1),2,DA,0),U,5)="")
"RTN","PRCHNPO5",77,0)
 S:'$D(PRC("SITE")) PRC("SITE")=$P($P(^PRC(442,DA(1),0),U,1),"-",1) S PRCHCV=$P(^PRC(442,DA(1),1),U,1),PRCHCI=$P(^(2,DA,0),U,5),PRCHCPO=DA(1) D EN1^PRCHCRD
"RTN","PRCHNPO5",78,0)
 Q
"RTN","PRCHNPO5",79,0)
 ;
"RTN","PRCHNPO5",80,0)
EN10 ;FILE 440 CONTRACT NUMBER
"RTN","PRCHNPO5",81,0)
 I $D(Z0) S:'$D(^PRC(440,Z0,4,0)) ^PRC(440,Z0,4,0)="^440.03I^^"
"RTN","PRCHNPO5",82,0)
 Q
"RTN","PRCHNPO5",83,0)
 ;
"RTN","PRCHNPO5",84,0)
EN11 ;FILE 441 CONTRACT
"RTN","PRCHNPO5",85,0)
 D EN10 S DIC="^PRC(440,Z0,4,",DIC(0)="QEMLZ",DLAYGO=440,ZD=DA(1),DA(1)=Z0 D ^DIC S X=+Y K:Y'>0 X S DA(1)=ZD K ZD,Z0,DIC
"RTN","PRCHNPO5",86,0)
 I $D(X),$D(DT),$P(Y(0),U,2)-DT<0 W !?10,"**CONTRACT HAS EXPIRED**",$C(7),$C(7) K X
"RTN","PRCHNPO5",87,0)
 K DLAYGO
"RTN","PRCHNPO5",88,0)
 Q
"RTN","PRCHNPO5",89,0)
 ;
"RTN","PRCHNPO5",90,0)
EN12 ;FILE 442, VENDOR STOCK NO.#9
"RTN","PRCHNPO5",91,0)
 D VEN Q:'$D(X)!($P(^PRC(442,DA(1),2,DA,0),U,5)="")
"RTN","PRCHNPO5",92,0)
 S:'$D(PRC("SITE")) PRC("SITE")=+^PRC(442,DA(1),0) S PRCHCV=+$P(^PRC(442,DA(1),1),U,1),PRCHCI=+$P(^(2,DA,0),U,5),PRCHCPO=DA(1) D EN6^PRCHCRD
"RTN","PRCHNPO5",93,0)
 Q
"RTN","PRCHNPO5",94,0)
 ;
"RTN","PRCHNPO5",95,0)
EN13 ;DIC("S") for a look-up in CONTRACT field (File 442.01,4)
"RTN","PRCHNPO5",96,0)
 S PRCHSCOD=$P($G(^PRC(442,D0,1)),U,7)
"RTN","PRCHNPO5",97,0)
 I $E(X)="?" S DIC("S")=$S(PRCHSCOD=2:"I $P(^PRC(440,Z0,4,+Y,0),U,6)'=""B""",1:"I 1")
"RTN","PRCHNPO5",98,0)
 Q
"RTN","PRCHNPO5",99,0)
 ;
"RTN","PRCHNPO5",100,0)
EN14 ;input transform of Contract Flag field 5, file 440
"RTN","PRCHNPO5",101,0)
 ;If PO exists, if source code=2 & contract flag is not 'C' set it 'C'
"RTN","PRCHNPO5",102,0)
 I $G(PRCHPO)>0 D
"RTN","PRCHNPO5",103,0)
 . S PRCHNOD1=$G(^PRC(442,PRCHPO,1))
"RTN","PRCHNPO5",104,0)
 . S PRCHSOCO=$P(PRCHNOD1,U,7)
"RTN","PRCHNPO5",105,0)
 . I PRCHSOCO=2 Q:X="C"  D  Q
"RTN","PRCHNPO5",106,0)
 . . S X="C"
"RTN","PRCHNPO5",107,0)
 . . S ARR(1)=""
"RTN","PRCHNPO5",108,0)
 . . S ARR(2)="     Note: "
"RTN","PRCHNPO5",109,0)
 . . S ARR(3)="     This PO's Source Code is Open Market, only Contract # is a valid entry."
"RTN","PRCHNPO5",110,0)
 . . S ARR(4)="     'C' has been entered for the Contract Flag prompt."
"RTN","PRCHNPO5",111,0)
 . . S ARR(5)="     'B' is not allowed, system allows only 'C'."
"RTN","PRCHNPO5",112,0)
 . . S ARR(6)=""
"RTN","PRCHNPO5",113,0)
 . . D EN^DDIOL(.ARR)
"RTN","PRCHNPO5",114,0)
 . . S XQH="PRCH CONTRACT FLAG HELP" D:$E(X)="??" EN^XQH
"RTN","PRCHNPO5",115,0)
 . . Q
"RTN","PRCHNPO5",116,0)
 . Q 
"RTN","PRCHNPO5",117,0)
 ; If Source code is not equal to 2, C or B is ok for contr. flag 
"RTN","PRCHNPO5",118,0)
 S MSG(1)=""
"RTN","PRCHNPO5",119,0)
 S MSG(2)="Enter 'C' if the Contract Number field is a Contract #."
"RTN","PRCHNPO5",120,0)
 S MSG(2,"F")="!,?5"
"RTN","PRCHNPO5",121,0)
 S MSG(3)="Otherwise enter 'B' if it is a Basic Ordering Agreement(BOA) #."
"RTN","PRCHNPO5",122,0)
 S MSG(3,"F")="!,?5"
"RTN","PRCHNPO5",123,0)
 S MSG(4)=""
"RTN","PRCHNPO5",124,0)
 ;I PRCHSOCO'=2 D EN^DDIOL(.MSG) H 2
"RTN","PRCHNPO5",125,0)
 ;any other route than via po
"RTN","PRCHNPO5",126,0)
 I X="B" D
"RTN","PRCHNPO5",127,0)
 . S Z=$P(^PRC(440,DA(1),4,DA,0),U)
"RTN","PRCHNPO5",128,0)
 . K:'(Z?.UN) X
"RTN","PRCHNPO5",129,0)
 . I '$D(X) S XQH="PRCH BOA" D EN^XQH
"RTN","PRCHNPO5",130,0)
 . K Z,XQH
"RTN","PRCHNPO5",131,0)
 . Q
"RTN","PRCHNPO5",132,0)
 Q
"RTN","PRCHNPO5",133,0)
 ;
"RTN","PRCHNPO5",134,0)
VEN I $S('$D(^PRC(442,DA(1),1)):1,$P(^(1),U,1)="":1,1:0) W !!,"Vendor must be entered before items ! ",$C(7) K X
"RTN","PRCHNPO5",135,0)
 Q
"RTN","PRCHNPO5",136,0)
 ;
"RTN","PRCHNPO5",137,0)
ODATE ;PRC*5.1*159 'old date' handler call for P.O. Date exception in input template [PRCH DETAILED PURCHASE CARD]
"RTN","PRCHNPO5",138,0)
 K ^PRC(442,"AB",+$P(^PRC(442,DA,1),U,15),DA)
"RTN","PRCHNPO5",139,0)
 S $P(^PRC(442,DA,1),U,15)=""
"RTN","PRCHNPO5",140,0)
 Q
"VER")
8.0^22.0
"BLD",6744,6)
^139
**END**
**END**
