Released PRC*5.1*138 SEQ #136
Extracted from mail message
**KIDS**:PRC*5.1*138^

**INSTALL NAME**
PRC*5.1*138
"BLD",5984,0)
PRC*5.1*138^IFCAP^0^3110920^y
"BLD",5984,1,0)
^^6^6^3110920^^
"BLD",5984,1,1,0)
1. Discount entries are not properly linking to item entries which is
"BLD",5984,1,2,0)
   causing amendment processing errors to occur.
"BLD",5984,1,3,0)
 
"BLD",5984,1,4,0)
2. The option 'Load IFCAP File 417 Data into PurgeMaster' there is a
"BLD",5984,1,5,0)
   misspelling of the word, "reconciliation'.  Currently, it reads as 
"BLD",5984,1,6,0)
   "reconilliation".
"BLD",5984,4,0)
^9.64PA^^0
"BLD",5984,6.3)
18
"BLD",5984,"ABPKG")
n
"BLD",5984,"INI")

"BLD",5984,"INID")
^^
"BLD",5984,"INIT")

"BLD",5984,"KRN",0)
^9.67PA^779.2^20
"BLD",5984,"KRN",.4,0)
.4
"BLD",5984,"KRN",.401,0)
.401
"BLD",5984,"KRN",.402,0)
.402
"BLD",5984,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",5984,"KRN",.403,0)
.403
"BLD",5984,"KRN",.5,0)
.5
"BLD",5984,"KRN",.84,0)
.84
"BLD",5984,"KRN",3.6,0)
3.6
"BLD",5984,"KRN",3.8,0)
3.8
"BLD",5984,"KRN",9.2,0)
9.2
"BLD",5984,"KRN",9.8,0)
9.8
"BLD",5984,"KRN",9.8,"NM",0)
^9.68A^10^3
"BLD",5984,"KRN",9.8,"NM",5,0)
PRCHSF3^^0^B17379017
"BLD",5984,"KRN",9.8,"NM",9,0)
PRCG239P^^0^B952278
"BLD",5984,"KRN",9.8,"NM",10,0)
PRCG239Q^^0^B13453904
"BLD",5984,"KRN",9.8,"NM","B","PRCG239P",9)

"BLD",5984,"KRN",9.8,"NM","B","PRCG239Q",10)

"BLD",5984,"KRN",9.8,"NM","B","PRCHSF3",5)

"BLD",5984,"KRN",19,0)
19
"BLD",5984,"KRN",19,"NM",0)
^9.68A^^
"BLD",5984,"KRN",19.1,0)
19.1
"BLD",5984,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",5984,"KRN",101,0)
101
"BLD",5984,"KRN",409.61,0)
409.61
"BLD",5984,"KRN",771,0)
771
"BLD",5984,"KRN",779.2,0)
779.2
"BLD",5984,"KRN",870,0)
870
"BLD",5984,"KRN",8989.51,0)
8989.51
"BLD",5984,"KRN",8989.52,0)
8989.52
"BLD",5984,"KRN",8994,0)
8994
"BLD",5984,"KRN","B",.4,.4)

"BLD",5984,"KRN","B",.401,.401)

"BLD",5984,"KRN","B",.402,.402)

"BLD",5984,"KRN","B",.403,.403)

"BLD",5984,"KRN","B",.5,.5)

"BLD",5984,"KRN","B",.84,.84)

"BLD",5984,"KRN","B",3.6,3.6)

"BLD",5984,"KRN","B",3.8,3.8)

"BLD",5984,"KRN","B",9.2,9.2)

"BLD",5984,"KRN","B",9.8,9.8)

"BLD",5984,"KRN","B",19,19)

"BLD",5984,"KRN","B",19.1,19.1)

"BLD",5984,"KRN","B",101,101)

"BLD",5984,"KRN","B",409.61,409.61)

"BLD",5984,"KRN","B",771,771)

"BLD",5984,"KRN","B",779.2,779.2)

"BLD",5984,"KRN","B",870,870)

"BLD",5984,"KRN","B",8989.51,8989.51)

"BLD",5984,"KRN","B",8989.52,8989.52)

"BLD",5984,"KRN","B",8994,8994)

"BLD",5984,"QDEF")
^^^^YES
"BLD",5984,"QUES",0)
^9.62^^
"BLD",5984,"REQB",0)
^9.611^7^2
"BLD",5984,"REQB",6,0)
PRC*5.1*118^2
"BLD",5984,"REQB",7,0)
PRC*5.1*95^2
"BLD",5984,"REQB","B","PRC*5.1*118",6)

"BLD",5984,"REQB","B","PRC*5.1*95",7)

"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
138^3110920
"PKG",455,22,1,"PAH",1,1,0)
^^6^6^3110920
"PKG",455,22,1,"PAH",1,1,1,0)
1. Discount entries are not properly linking to item entries which is
"PKG",455,22,1,"PAH",1,1,2,0)
   causing amendment processing errors to occur.
"PKG",455,22,1,"PAH",1,1,3,0)
 
"PKG",455,22,1,"PAH",1,1,4,0)
2. The option 'Load IFCAP File 417 Data into PurgeMaster' there is a
"PKG",455,22,1,"PAH",1,1,5,0)
   misspelling of the word, "reconciliation'.  Currently, it reads as 
"PKG",455,22,1,"PAH",1,1,6,0)
   "reconilliation".
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PRCG239P")
0^9^B952278^B952278
"RTN","PRCG239P",1,0)
PRCG239P ;WISC/BGJ - IFCAP 442 FILE CLEANUP (PURGE); 11/5/99 12:22pm ;9/20/00  12:56
"RTN","PRCG239P",2,0)
V ;;5.1;IFCAP;**95,138**;Oct 20, 2000;Build 18
"RTN","PRCG239P",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCG239P",4,0)
 ;This routine is installed by patch PRC*5.1*95.
"RTN","PRCG239P",5,0)
 ;The purpose of this routine is to clean up FMS reconciliation data
"RTN","PRCG239P",6,0)
 ;in file 417 that were not purged by running the Archive/Purge
"RTN","PRCG239P",7,0)
 ;functionality.  Routine PRCG239Q is a routine installed by patch
"RTN","PRCG239P",8,0)
 ;95 that queues entries into PurgeMaster for purging.  Those entries
"RTN","PRCG239P",9,0)
 ;are then purged by this routine as PurgeMaster cycles through file
"RTN","PRCG239P",10,0)
 ;443.1 (PurgeMaster Worklist).
"RTN","PRCG239P",11,0)
 ;
"RTN","PRCG239P",12,0)
417(X) ;
"RTN","PRCG239P",13,0)
 N DA,KDA,BEGDA,ENDA,PODATE,DTPOASN,SITE,DATE,ZERONODE,MOP
"RTN","PRCG239P",14,0)
 D UNLOAD
"RTN","PRCG239P",15,0)
 F  S DA=$O(^PRCS(417,DA)) Q:'DA!(DA>ENDA)  D
"RTN","PRCG239P",16,0)
 . S ZERONODE=$G(^PRCS(417,DA,0)) Q:ZERONODE=""
"RTN","PRCG239P",17,0)
 . S PODATE=$P($G(^PRCS(417,DA,0)),"^",22)
"RTN","PRCG239P",18,0)
 . I PODATE>DATE Q
"RTN","PRCG239P",19,0)
 . S KDA=DA D KILL417(KDA)
"RTN","PRCG239P",20,0)
 Q
"RTN","PRCG239P",21,0)
UNLOAD ;
"RTN","PRCG239P",22,0)
 S BEGDA=$P(X,"-",1),ENDA=+$P(X,"-",2),SITE=$P(X,";",2)
"RTN","PRCG239P",23,0)
 S DATE=$P(X,";",3)
"RTN","PRCG239P",24,0)
 S DA=BEGDA-.1
"RTN","PRCG239P",25,0)
 Q
"RTN","PRCG239P",26,0)
KILL417(DA) ;
"RTN","PRCG239P",27,0)
 Q:'$D(^PRCS(417,DA,0))
"RTN","PRCG239P",28,0)
 S DIK="^PRCS(417," D ^DIK
"RTN","PRCG239P",29,0)
 K DIK
"RTN","PRCG239P",30,0)
 Q
"RTN","PRCG239Q")
0^10^B13453904^B13467421
"RTN","PRCG239Q",1,0)
PRCG239Q ;WISC/BGJ-IFCAP 410 FILE CLEANUP (QUEUE) ;11/8/99
"RTN","PRCG239Q",2,0)
V ;;5.1;IFCAP;**95,138**;Oct 20, 2000;Build 18
"RTN","PRCG239Q",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCG239Q",4,0)
 ;This routine is installed by patch PRC*5.1*95.
"RTN","PRCG239Q",5,0)
 ;This routine creates entries in file 443.1 for background processing
"RTN","PRCG239Q",6,0)
 ;by PurgeMaster.  Entries are created for file 417.
"RTN","PRCG239Q",7,0)
 ;Routine PRCG239P will be utilized by PurgeMaster to actually purge the
"RTN","PRCG239Q",8,0)
 ;entries in this file.
"RTN","PRCG239Q",9,0)
 ;
"RTN","PRCG239Q",10,0)
 W @IOF,!
"RTN","PRCG239Q",11,0)
 D MSG
"RTN","PRCG239Q",12,0)
 S %A="Are you ready to continue",%A(0)="!",%=1
"RTN","PRCG239Q",13,0)
 D ^PRCFYN Q:%'=1
"RTN","PRCG239Q",14,0)
 S PRCF("X")="AS" D ^PRCFSITE G OUT:'%
"RTN","PRCG239Q",15,0)
 D NOW^%DTC K %H,%,%I
"RTN","PRCG239Q",16,0)
 S CFY=$E(X,1,3)+1700,CFY=$S(+$E(X,4,5)>9:CFY+1,1:CFY)
"RTN","PRCG239Q",17,0)
 S PFY=CFY-1700-1_"0930"
"RTN","PRCG239Q",18,0)
 S X="Date/Fiscal Year thru which FMS reconciliation data in file 417 will be purged."
"RTN","PRCG239Q",19,0)
 D DATE
"RTN","PRCG239Q",20,0)
 I +OUT G OUT
"RTN","PRCG239Q",21,0)
 I $E(Y,4,7)="0000" S Y=$E(Y,1,3)_"0930"
"RTN","PRCG239Q",22,0)
 S PRC("DATE")=Y
"RTN","PRCG239Q",23,0)
 K OUT
"RTN","PRCG239Q",24,0)
DQ ;
"RTN","PRCG239Q",25,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PRCG239Q",26,0)
 F I=1:1 S X=$T(LOAD+I) Q:$P(X,";",3)=""  D
"RTN","PRCG239Q",27,0)
 . S FILE(I)=$P(X,";",3),GLO(I)=$P(X,";",4),REF(I)=$P(X,";",5),ADDVAR(I)=$P(X,";",6)
"RTN","PRCG239Q",28,0)
 S N=0,TREC=0
"RTN","PRCG239Q",29,0)
 F  S N=$O(GLO(N)) Q:'N  D
"RTN","PRCG239Q",30,0)
 . S X="S REC(N)=$P("_GLO(N)_"0),U,4)" X X S TREC=TREC+REC(N)
"RTN","PRCG239Q",31,0)
 S OGET=TREC\1000+1
"RTN","PRCG239Q",32,0)
 S MESSAGE="CREATING PURGEMASTER ENTRIES FOR FILE CLEANUP"
"RTN","PRCG239Q",33,0)
 D BEGIN^PRCGU
"RTN","PRCG239Q",34,0)
 S LEVEL=0
"RTN","PRCG239Q",35,0)
 F  S LEVEL=$O(GLO(LEVEL)) Q:LEVEL=""  D
"RTN","PRCG239Q",36,0)
 . S GLO=GLO(LEVEL),REF=REF(LEVEL),ADDVAR=""
"RTN","PRCG239Q",37,0)
 . S:ADDVAR(LEVEL)]"" @("ADDVAR="_ADDVAR(LEVEL))
"RTN","PRCG239Q",38,0)
 . S NEXT=0
"RTN","PRCG239Q",39,0)
 . F  D  S XCOUNT=XCOUNT+COUNT D PERCENT^PRCGU Q:'NEXT
"RTN","PRCG239Q",40,0)
 . . S COUNT=0
"RTN","PRCG239Q",41,0)
 . . F  D  Q:'NEXT!(COUNT>LREC)
"RTN","PRCG239Q",42,0)
 . . . S GET=($S((LREC-COUNT)>OGET:OGET,1:(LREC-COUNT)+2))-1
"RTN","PRCG239Q",43,0)
 . . . I GET<1 S GET=1
"RTN","PRCG239Q",44,0)
 . . . D GET
"RTN","PRCG239Q",45,0)
 . . . Q:'NEXT
"RTN","PRCG239Q",46,0)
 . . . S COUNT=COUNT+ICOUNT
"RTN","PRCG239Q",47,0)
 . . . S Z="",ROUTINE=REF_"^PRCG239P",VARIABLE=BEGDA_"-"_ENDA_";"_PRC("SITE")
"RTN","PRCG239Q",48,0)
 . . . I ADDVAR]"" S VARIABLE=VARIABLE_";"_ADDVAR
"RTN","PRCG239Q",49,0)
 . . . D ADD^PRCGPM1(ROUTINE,VARIABLE,.Z)
"RTN","PRCG239Q",50,0)
 D END^PRCGU
"RTN","PRCG239Q",51,0)
 ;
"RTN","PRCG239Q",52,0)
OUT ;
"RTN","PRCG239Q",53,0)
 K A,ADDVAR,ATERM,BEGDA,BTIME,CFY,COUNT,CURSOR,DX,DY,ENDA,FILE,GET,GLO,HOURS,ICOUNT,LEVEL,LINE,LREC,MIN,NEXT,OGET,OUT,PERCENT,PFY,REC,REF,ROUTINE,RTIME,SEC,TIME,TREC,TTIME,VARIABLE,X,XCOUNT,XPOS,Y,Z,PRC
"RTN","PRCG239Q",54,0)
 D KILL^%ZISS
"RTN","PRCG239Q",55,0)
 Q
"RTN","PRCG239Q",56,0)
GET ;
"RTN","PRCG239Q",57,0)
 S (BEGDA,ENDA)=NEXT+1,ICOUNT=1
"RTN","PRCG239Q",58,0)
 S @("NEXT=$O("_GLO_"NEXT))")
"RTN","PRCG239Q",59,0)
 I 'NEXT S NEXT="" Q
"RTN","PRCG239Q",60,0)
 S BEGDA=NEXT,(NEXT,ENDA)=NEXT+GET,ICOUNT=ENDA-BEGDA+1
"RTN","PRCG239Q",61,0)
 Q
"RTN","PRCG239Q",62,0)
MSG ;
"RTN","PRCG239Q",63,0)
 S X="This will schedule records in file 417 for review in the "
"RTN","PRCG239Q",64,0)
 S X=X_"background by PurgeMaster (file 443.1 will be populated).  "
"RTN","PRCG239Q",65,0)
 S X=X_"FMS reconciliation data in file 417 will be purged by "
"RTN","PRCG239Q",66,0)
 S X=X_"PurgeMaster based on the date that you will enter."
"RTN","PRCG239Q",67,0)
 D MSG^PRCFQ W !
"RTN","PRCG239Q",68,0)
 S X="The date you are about to enter MUST be confirmed with A&MM "
"RTN","PRCG239Q",69,0)
 S X=X_"or Fiscal staff.  FAILURE TO DO SO MAY RESULT IN DATA "
"RTN","PRCG239Q",70,0)
 S X=X_"CORRUPTION." D MSG^PRCFQ W $C(7),$C(7),$C(7)
"RTN","PRCG239Q",71,0)
 Q
"RTN","PRCG239Q",72,0)
DATE ;Select fiscal year
"RTN","PRCG239Q",73,0)
 S DIR(0)="DA^:"_PFY_":EA"
"RTN","PRCG239Q",74,0)
 S DIR("A")="Select DATE/FISCAL YEAR: "
"RTN","PRCG239Q",75,0)
 S DIR("A",1)=X
"RTN","PRCG239Q",76,0)
 S DIR("?")="You may only select for purging those documents which are not in the current Fiscal Year."
"RTN","PRCG239Q",77,0)
 D ^DIR
"RTN","PRCG239Q",78,0)
 S OUT=$G(DTOUT)_$G(DUOUT)_$G(DIRUT)_$G(DIROUT)
"RTN","PRCG239Q",79,0)
 K DTOUT,DUOUT,DIRUT,DIROUT,DIR
"RTN","PRCG239Q",80,0)
 Q
"RTN","PRCG239Q",81,0)
LOAD ;
"RTN","PRCG239Q",82,0)
 ;;417;^PRCS(417,;417;PRC("DATE")
"RTN","PRCG239Q",83,0)
 ;;;
"RTN","PRCHSF3")
0^5^B17379017^B15319520
"RTN","PRCHSF3",1,0)
PRCHSF3 ;WISC/DJM-UPDATING THE LINE ITEM DISCOUNTS ON THE 'AMENDED' 443.6 RECORD ;8/31/95  11:29 AM
"RTN","PRCHSF3",2,0)
V ;;5.1;IFCAP;**118,138**;Oct 20, 2000;Build 18
"RTN","PRCHSF3",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCHSF3",4,0)
 ;GO THROUGH ALL LINE ITEMS AND CREATE 'PRCH("AM",PRCHCN)' ARRAY
"RTN","PRCHSF3",5,0)
 ;PRCHCN CAN BE A 'CONTRACT NUMBER' OR '.OM'.
"RTN","PRCHSF3",6,0)
 ;PRCH("AM",PRCHCN) HAS 3 "^" PARTS.
"RTN","PRCHSF3",7,0)
 ;    PART 1 = NUMBER OF LINE ITEMS IN THIS ARRAY ELEMENT.
"RTN","PRCHSF3",8,0)
 ;    PART 2 = TOTAL $AMOUNT OF ALL LINE ITEMS IN ARRAY ELEMENT.
"RTN","PRCHSF3",9,0)
 ;    PART 3 = LISTING OF ALL LINE NUMBERS IN THIS ARRAY ELEMENT.
"RTN","PRCHSF3",10,0)
 ;THE LISTING IS SAVED IN THE FORMAT NEEDED TO USE WITHIN A MUMPS
"RTN","PRCHSF3",11,0)
 ;'FOR' COMMAND.  FOR EXAMPLE: 1:1:2,4,6,8:11,
"RTN","PRCHSF3",12,0)
 ;
"RTN","PRCHSF3",13,0)
 N PRCH,PRCHDSC,PRCHEC,I,PRCHAMX,PRCHCN,PRCHLI,PRCHLCNT,K,TOT,K2,SHIP,OTOT,DIF,PRCHL0,PRCHL3,J,PRCHL1,PRCHL2,PRCHAC
"RTN","PRCHSF3",14,0)
 N PRCHACT,PRCHP,PRCHAMT,Y,PRCHN,PRCHD,PRCHDA,PRCHX,RDIS
"RTN","PRCHSF3",15,0)
 S PRCHPO=$S($D(PRCHPO):PRCHPO,1:D0),PRCHAM=$S($D(PRCHAM):PRCHAM,1:D1)
"RTN","PRCHSF3",16,0)
 D MVDIS^PRCHMA3
"RTN","PRCHSF3",17,0)
 ;REALIGN CONTRACT #/DISCOUNT ENTRIES - added via patch PRC*5.1*138
"RTN","PRCHSF3",18,0)
A1 S PRCH=0 F  S PRCH=$O(^PRC(443.6,PRCHPO,2,PRCH)),PRCHDSC=0 Q:+PRCH'>0  D
"RTN","PRCHSF3",19,0)
 . S PRCHCN=$P($G(^PRC(443.6,PRCHPO,2,PRCH,2)),U,2)
"RTN","PRCHSF3",20,0)
 . F  S PRCHDSC=$O(^PRC(443.6,PRCHPO,3,PRCHDSC)) Q:+PRCHDSC'>0  D
"RTN","PRCHSF3",21,0)
 .. S RDIS=$G(^PRC(443.6,PRCHPO,3,PRCHDSC,0)) Q:RDIS=""
"RTN","PRCHSF3",22,0)
 .. I +RDIS=PRCH,PRCHCN'=$P(RDIS,U,5) S $P(^PRC(443.6,PRCHPO,3,PRCHDSC,0),U,5)=PRCHCN
"RTN","PRCHSF3",23,0)
 K PRCH,PRCHDSC,PRCHCN,RDIS
"RTN","PRCHSF3",24,0)
B ;LOOP THROUGH ALL LINE ITEM ENTRIES AND ADD/UPDATE THE 'PRCH("AM",PRCHCN)' ARRAY.
"RTN","PRCHSF3",25,0)
 S (PRCH,PRCHEC)=0
"RTN","PRCHSF3",26,0)
 F I=1:1 S PRCH=$O(^PRC(443.6,PRCHPO,2,PRCH)) Q:PRCH=""!(PRCH'>0)  D
"RTN","PRCHSF3",27,0)
 .S PRCHAMX=$G(^PRC(443.6,PRCHPO,2,PRCH,2)) I PRCHAMX]""  D
"RTN","PRCHSF3",28,0)
 ..S $P(PRCHAMX,U,6)="",^PRC(443.6,PRCHPO,2,PRCH,2)=PRCHAMX
"RTN","PRCHSF3",29,0)
 ..S PRCHCN=$P(PRCHAMX,U,2),PRCHAMX=+$P(PRCHAMX,U),PRCHLI=I
"RTN","PRCHSF3",30,0)
 ..D CN:PRCHCN]"",OM:PRCHCN=""
"RTN","PRCHSF3",31,0)
 ..Q
"RTN","PRCHSF3",32,0)
 .Q
"RTN","PRCHSF3",33,0)
 S PRCHLCNT=I-1 S:$D(^PRC(443.6,PRCHPO,2,0)) $P(^(0),U,3,4)="1^"_PRCHLCNT
"RTN","PRCHSF3",34,0)
 D UP
"RTN","PRCHSF3",35,0)
TOT ;NOW LETS GET THE TOTAL FOR THIS DOCUMENT.
"RTN","PRCHSF3",36,0)
 S (K,TOT)=0 F  S K=$O(^PRC(443.6,PRCHPO,2,K)) Q:K'>0  S K2=$G(^(K,2)) I K2]"" S TOT=TOT+$P(K2,U)-$P(K2,U,6)
"RTN","PRCHSF3",37,0)
 S SHIP=$P(^PRC(443.6,PRCHPO,0),U,13),TOT=TOT+SHIP,OTOT=$P(^PRC(442,PRCHPO,0),U,15),DIF=TOT-OTOT
"RTN","PRCHSF3",38,0)
 S $P(^PRC(443.6,PRCHPO,6,PRCHAM,0),U,3)=DIF
"RTN","PRCHSF3",39,0)
 S $P(^PRC(443.6,PRCHPO,0),U,15)=TOT
"RTN","PRCHSF3",40,0)
 Q
"RTN","PRCHSF3",41,0)
 ;
"RTN","PRCHSF3",42,0)
LI ;CREAT THE ENTRY FOR THE 3rd "^" PIECE OF PRCH("AM",PRCHCN) HERE.
"RTN","PRCHSF3",43,0)
 S PRCHL0=$P(PRCH("AM",PRCHL3),U,3) Q:PRCHL0=""  F J=1:1 S PRCHL1=$E(PRCHL0,$L(PRCHL0)-J) Q:PRCHL1'=+PRCHL1
"RTN","PRCHSF3",44,0)
 S PRCHL2=$E(PRCHL0,$L(PRCHL0)-J+1,$L(PRCHL0)-1),PRCHL2=PRCHL2+1 I PRCHL2'=PRCHLI S PRCHLI=PRCHL0_PRCHLI Q
"RTN","PRCHSF3",45,0)
 I PRCHL1=":" S PRCHLI=$E(PRCHL0,1,$L(PRCHL0)-J)_PRCHLI Q
"RTN","PRCHSF3",46,0)
 S PRCHLI=$E(PRCHL0,1,$L(PRCHL0)-1)_":1:"_PRCHLI
"RTN","PRCHSF3",47,0)
 Q
"RTN","PRCHSF3",48,0)
 ;
"RTN","PRCHSF3",49,0)
CN ;CREATE THE 'PRCH("AM",PRCHCN)' ARRAY ELEMENT HERE, ALL THREE PARTS, FOR LINE ITEMS WITH A CONTRACT NUMBER.
"RTN","PRCHSF3",50,0)
 S:'$D(PRCH("AM",PRCHCN)) PRCH("AM",PRCHCN)="",PRCHEC=PRCHEC+1 S PRCHL3=PRCHCN
"RTN","PRCHSF3",51,0)
 D LI S PRCH("AM",PRCHCN)=($P(PRCH("AM",PRCHCN),U,1)+1)_U_($P(PRCH("AM",PRCHCN),U,2)+PRCHAMX)_U_PRCHLI_",",^PRC(443.6,PRCHPO,2,"AC",$E(PRCHCN,1,30),PRCH)=""
"RTN","PRCHSF3",52,0)
 Q
"RTN","PRCHSF3",53,0)
 ;
"RTN","PRCHSF3",54,0)
OM ;CREATE THE 'PRCH("AM",PRCHCN)' ARRAY ELEMENT HERE, ALL THREE PARTS, FOR LINE ITEMS WITHOUT A CONTRACT NUMBER.
"RTN","PRCHSF3",55,0)
 S:'$D(PRCH("AM",".OM")) PRCH("AM",".OM")="",PRCHEC=PRCHEC+1 S PRCHL3=".OM" D LI S PRCH("AM",".OM")=($P(PRCH("AM",".OM"),U,1)+1)_U_($P(PRCH("AM",".OM"),U,2)+PRCHAMX)_U_PRCHLI_","
"RTN","PRCHSF3",56,0)
 Q
"RTN","PRCHSF3",57,0)
 ;
"RTN","PRCHSF3",58,0)
UP ;NOW LETS DO THE ACTUAL UPDATING OF THE DISCOUNT FOR EACH LINE ITEM.
"RTN","PRCHSF3",59,0)
 ;
"RTN","PRCHSF3",60,0)
 S PRCH=0
"RTN","PRCHSF3",61,0)
 F I=1:1 S PRCH=$O(^PRC(443.6,PRCHPO,3,PRCH)) Q:PRCH=""!(PRCH'>0)  S PRCHCN=$S($P(^(PRCH,0),U,5)]"":$P(^(0),U,5),1:".OM"),PRCHAC=$P(^(0),U,1),PRCHACT=$P(^(0),U,4),PRCHP=$P(^(0),U,2) D SET
"RTN","PRCHSF3",62,0)
 Q
"RTN","PRCHSF3",63,0)
 ;
"RTN","PRCHSF3",64,0)
SET ;DECIDE THE LINE ITEM NUMBERS TO DO THE DISCOUNT ADJUSTMENT.
"RTN","PRCHSF3",65,0)
 G:PRCHAC="Q" PCTQ
"RTN","PRCHSF3",66,0)
 I PRCHAC[":" S PRCHAC=$P(PRCHAC,":",1)_":1:"_$P(PRCHAC,":",2)
"RTN","PRCHSF3",67,0)
 ;
"RTN","PRCHSF3",68,0)
PCT ;FOR EACH 'LINE ITEM NUMBER' WITH A DISCOUNT DO IT HERE.
"RTN","PRCHSF3",69,0)
 S PRCHAMT=0,Y="F J="_PRCHAC_" S PRCHN=J D PCT1" X Y
"RTN","PRCHSF3",70,0)
 S PRCHAMT=PRCHAMT*100+.5\1/100,$P(PRCH("AM",PRCHCN),U,2)=$P(PRCH("AM",PRCHCN),U,2)-PRCHAMT
"RTN","PRCHSF3",71,0)
 Q
"RTN","PRCHSF3",72,0)
 ;
"RTN","PRCHSF3",73,0)
PCT1 S PRCHN=$O(^PRC(443.6,PRCHPO,2,"B",PRCHN,0)),PRCHD=+$P($G(^PRC(443.6,PRCHPO,2,PRCHN,2)),U,1)
"RTN","PRCHSF3",74,0)
 I $E(PRCHP,1)="$" S PRCHDA=$P(PRCHP,"$",2)/PRCHACT
"RTN","PRCHSF3",75,0)
 E  S PRCHDA=$J(PRCHD*(PRCHP/100),0,2)
"RTN","PRCHSF3",76,0)
 S PRCHAMT=PRCHAMT+PRCHDA,$P(^PRC(443.6,PRCHPO,2,PRCHN,2),U,6)=PRCHDA
"RTN","PRCHSF3",77,0)
 Q
"RTN","PRCHSF3",78,0)
 ;
"RTN","PRCHSF3",79,0)
PCTQ ;COME HERE IF THE USER SELECTED A 'QUANTITY' DISCOUNT.
"RTN","PRCHSF3",80,0)
 ;
"RTN","PRCHSF3",81,0)
 S (PRCHAMT,PRCHCN,PRCHX)=0,PRCHACT=PRCHLCNT F K=0:0 S PRCHCN=$O(PRCH("AM",PRCHCN)) Q:PRCHCN=""  S PRCHAC=$E($P(PRCH("AM",PRCHCN),U,3),1,$L($P(PRCH("AM",PRCHCN),U,3))-1) D PCT S PRCHX=PRCHX+PRCHAMT
"RTN","PRCHSF3",82,0)
 S $P(^PRC(443.6,PRCHPO,3,PRCH,0),U,3)=PRCHX
"RTN","PRCHSF3",83,0)
 Q
"VER")
8.0^22.0
"BLD",5984,6)
^136
**END**
**END**
