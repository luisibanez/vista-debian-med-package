Released PRC*5.1*157 SEQ #141
Extracted from mail message
**KIDS**:PRC*5.1*157^

**INSTALL NAME**
PRC*5.1*157
"BLD",6612,0)
PRC*5.1*157^IFCAP^0^3110808^y
"BLD",6612,1,0)
^^6^6^3110712^
"BLD",6612,1,1,0)
1. Site reported that they were able to cancel a Purchase Card order 
"BLD",6612,1,2,0)
   before the reconciliation charges were removed.
"BLD",6612,1,3,0)
 
"BLD",6612,1,4,0)
2. In File Description information for file #410 [CONTROL POINT ACTIVITY],
"BLD",6612,1,5,0)
   #442 [PROCUREMENT & ACCOUNTING TRANSACTIONS] AND #443.6 [AMENDMENTS] 
"BLD",6612,1,6,0)
   add informational warning: *********DO NOT RE-INDEX THIS FILE**********
"BLD",6612,4,0)
^9.64PA^^0
"BLD",6612,6.3)
2
"BLD",6612,"ABPKG")
n
"BLD",6612,"INID")
^y
"BLD",6612,"INIT")
SET^PRC157P
"BLD",6612,"KRN",0)
^9.67PA^779.2^20
"BLD",6612,"KRN",.4,0)
.4
"BLD",6612,"KRN",.401,0)
.401
"BLD",6612,"KRN",.402,0)
.402
"BLD",6612,"KRN",.403,0)
.403
"BLD",6612,"KRN",.5,0)
.5
"BLD",6612,"KRN",.84,0)
.84
"BLD",6612,"KRN",3.6,0)
3.6
"BLD",6612,"KRN",3.8,0)
3.8
"BLD",6612,"KRN",9.2,0)
9.2
"BLD",6612,"KRN",9.8,0)
9.8
"BLD",6612,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6612,"KRN",9.8,"NM",1,0)
PRCHINQ^^0^B10133496
"BLD",6612,"KRN",9.8,"NM",2,0)
PRCHMA^^0^B77711518
"BLD",6612,"KRN",9.8,"NM",3,0)
PRCHMA1^^0^B47127085
"BLD",6612,"KRN",9.8,"NM",4,0)
PRC157P^^0^B945489
"BLD",6612,"KRN",9.8,"NM","B","PRC157P",4)

"BLD",6612,"KRN",9.8,"NM","B","PRCHINQ",1)

"BLD",6612,"KRN",9.8,"NM","B","PRCHMA",2)

"BLD",6612,"KRN",9.8,"NM","B","PRCHMA1",3)

"BLD",6612,"KRN",19,0)
19
"BLD",6612,"KRN",19.1,0)
19.1
"BLD",6612,"KRN",101,0)
101
"BLD",6612,"KRN",409.61,0)
409.61
"BLD",6612,"KRN",771,0)
771
"BLD",6612,"KRN",779.2,0)
779.2
"BLD",6612,"KRN",870,0)
870
"BLD",6612,"KRN",8989.51,0)
8989.51
"BLD",6612,"KRN",8989.52,0)
8989.52
"BLD",6612,"KRN",8994,0)
8994
"BLD",6612,"KRN","B",.4,.4)

"BLD",6612,"KRN","B",.401,.401)

"BLD",6612,"KRN","B",.402,.402)

"BLD",6612,"KRN","B",.403,.403)

"BLD",6612,"KRN","B",.5,.5)

"BLD",6612,"KRN","B",.84,.84)

"BLD",6612,"KRN","B",3.6,3.6)

"BLD",6612,"KRN","B",3.8,3.8)

"BLD",6612,"KRN","B",9.2,9.2)

"BLD",6612,"KRN","B",9.8,9.8)

"BLD",6612,"KRN","B",19,19)

"BLD",6612,"KRN","B",19.1,19.1)

"BLD",6612,"KRN","B",101,101)

"BLD",6612,"KRN","B",409.61,409.61)

"BLD",6612,"KRN","B",771,771)

"BLD",6612,"KRN","B",779.2,779.2)

"BLD",6612,"KRN","B",870,870)

"BLD",6612,"KRN","B",8989.51,8989.51)

"BLD",6612,"KRN","B",8989.52,8989.52)

"BLD",6612,"KRN","B",8994,8994)

"BLD",6612,"QDEF")
^^^^NO^^^^NO^^YES
"BLD",6612,"QUES",0)
^9.62^^
"BLD",6612,"REQB",0)
^9.611^2^2
"BLD",6612,"REQB",1,0)
PRC*5.1*113^2
"BLD",6612,"REQB",2,0)
PRC*5.1*126^2
"BLD",6612,"REQB","B","PRC*5.1*113",1)

"BLD",6612,"REQB","B","PRC*5.1*126",2)

"INIT")
SET^PRC157P
"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
157^3110808
"PKG",455,22,1,"PAH",1,1,0)
^^6^6^3110808
"PKG",455,22,1,"PAH",1,1,1,0)
1. Site reported that they were able to cancel a Purchase Card order 
"PKG",455,22,1,"PAH",1,1,2,0)
   before the reconciliation charges were removed.
"PKG",455,22,1,"PAH",1,1,3,0)
 
"PKG",455,22,1,"PAH",1,1,4,0)
2. In File Description information for file #410 [CONTROL POINT ACTIVITY],
"PKG",455,22,1,"PAH",1,1,5,0)
   #442 [PROCUREMENT & ACCOUNTING TRANSACTIONS] AND #443.6 [AMENDMENTS] 
"PKG",455,22,1,"PAH",1,1,6,0)
   add informational warning: *********DO NOT RE-INDEX THIS FILE**********
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PRC157P")
0^4^B945489^n/a
"RTN","PRC157P",1,0)
PRC157P ;VMP/RB - ADD WARNING TO FILE DESCRIPTIONS #410, #442, #443.6 ;08/01/11
"RTN","PRC157P",2,0)
 ;;5.1;IFCAP;**157**;Jul 1, 2011;Build 2
"RTN","PRC157P",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRC157P",4,0)
 ;;
"RTN","PRC157P",5,0)
 ;
"RTN","PRC157P",6,0)
 ; Post install to add warning '*********DO NOT RE-INDEX THIS FILE
"RTN","PRC157P",7,0)
 ; *********' to file description for file#: 410, 442, and 443.6.
"RTN","PRC157P",8,0)
 ;
"RTN","PRC157P",9,0)
 Q
"RTN","PRC157P",10,0)
SET ;set files
"RTN","PRC157P",11,0)
 S TMP("WP",1)="    *********DO NOT RE-INDEX THIS FILE**********"
"RTN","PRC157P",12,0)
 D WP^DIE(1,"410,",4,"A","TMP(""WP"")")
"RTN","PRC157P",13,0)
 D WP^DIE(1,"442,",4,"A","TMP(""WP"")")
"RTN","PRC157P",14,0)
 D WP^DIE(1,"443.6,",4,"A","TMP(""WP"")")
"RTN","PRC157P",15,0)
EXIT ;
"RTN","PRC157P",16,0)
 W !!,"FILE 410, 442 AND 443.6 SET WITH 'DO NOT RE-INDEX' WARNING IN FILE DESCRIPTION",!!
"RTN","PRC157P",17,0)
 K TMP,DIE
"RTN","PRC157P",18,0)
 Q
"RTN","PRCHINQ")
0^1^B10133496^B9819590
"RTN","PRCHINQ",1,0)
PRCHINQ ;WISC/AKS-Add/Edit Surrogate Users and inquire Card Info ;6/8/96  13:38
"RTN","PRCHINQ",2,0)
 ;;5.1;IFCAP;**18,117,126,157**;Oct 20, 2000;Build 2
"RTN","PRCHINQ",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCHINQ",4,0)
 QUIT
"RTN","PRCHINQ",5,0)
 ;
"RTN","PRCHINQ",6,0)
INQ ;Display purchase card information and allow add/editting of users
"RTN","PRCHINQ",7,0)
 ;
"RTN","PRCHINQ",8,0)
 N PRCHDA
"RTN","PRCHINQ",9,0)
 S DIC="^PRC(440.5,",DIC(0)="AEQM"
"RTN","PRCHINQ",10,0)
 S DIC("S")="I $P(^PRC(440.5,+Y,0),U,8)=DUZ"
"RTN","PRCHINQ",11,0)
 D ^DIC W !
"RTN","PRCHINQ",12,0)
 S (PRCHDA,DA)=+Y,DR="0:49" D EN^DIQ,EN^DDIOL("REPLACEMENT CHARGE CARD NUMBER: "_$P($G(^PRC(440.5,DA,50)),"^")):$P($G(^PRC(440.5,DA,50)),"^")]"" G:Y=-1 EXIT
"RTN","PRCHINQ",13,0)
 S %A="Would you like to add/delete a surrogate",%B="",%=2
"RTN","PRCHINQ",14,0)
 D ^PRCFYN G:%<1!(%=2) EXIT
"RTN","PRCHINQ",15,0)
MORE S DA(1)=PRCHDA,DIC="^PRC(440.5,"_DA(1)_",1,",DIC(0)="AEQLM"
"RTN","PRCHINQ",16,0)
 S DIC("S")="I +Y'=DUZ"
"RTN","PRCHINQ",17,0)
 D ^DIC K DIC
"RTN","PRCHINQ",18,0)
 I $P(Y,U,3)'=1 D
"RTN","PRCHINQ",19,0)
 . S DA=+Y,DIK="^PRC(440.5,"_DA(1)_",1,"
"RTN","PRCHINQ",20,0)
 . D ^DIK K Y,DA,DIK
"RTN","PRCHINQ",21,0)
 S %A="Would you like to add/delete another surrogate",%B="",%=2
"RTN","PRCHINQ",22,0)
 D ^PRCFYN G:%<1!(%=2) EXIT G MORE
"RTN","PRCHINQ",23,0)
 QUIT
"RTN","PRCHINQ",24,0)
STAT ;Amendment/Adjustment statuses from the dd, called from field #50, sub-
"RTN","PRCHINQ",25,0)
 ;field #9 of file #443.6
"RTN","PRCHINQ",26,0)
 N MOPPC S MOPPC=0
"RTN","PRCHINQ",27,0)
 I $P($G(^PRC(443.6,PRCHPO,0)),U,2)=25 S MOPPC=1
"RTN","PRCHINQ",28,0)
 S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=41:1,Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",29,0)
 S:MOPPC DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",30,0)
 ;I $G(PRCHAUTH)=1 S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=41:1,Z1=44:1,Z1=47:1,Z1=49:1,Z1=51:1,1:0)"
"RTN","PRCHINQ",31,0)
 I $G(PRCHAUTH)=1 D
"RTN","PRCHINQ",32,0)
 . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=23:1,Z1=26:1,Z1=31:1,1:0)"
"RTN","PRCHINQ",33,0)
 . S PRCHOLD=$P($G(^PRC(443.6,PRCHPO,7)),U)
"RTN","PRCHINQ",34,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Paid " D
"RTN","PRCHINQ",35,0)
 . . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=29:1,Z1=34:1,Z1=38:1,1:0)"
"RTN","PRCHINQ",36,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Partial Payment " D
"RTN","PRCHINQ",37,0)
 . . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",38,0)
 D ^DIC K DIC,PRCHOLD,MOPPC S DIC=DIE,X=+Y K:Y<0 X
"RTN","PRCHINQ",39,0)
 QUIT
"RTN","PRCHINQ",40,0)
EXIT ;Kill variables and quit
"RTN","PRCHINQ",41,0)
 K Y,%A,%B,%,DIC
"RTN","PRCHINQ",42,0)
 QUIT
"RTN","PRCHINQ",43,0)
STAT1 ;Called from field #50, subfield #9, file #443.6
"RTN","PRCHINQ",44,0)
 N MOPPC S MOPPC=0
"RTN","PRCHINQ",45,0)
 I $P($G(^PRC(443.6,PRCHPO,0)),U,2)=25 S MOPPC=1
"RTN","PRCHINQ",46,0)
 S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=41:1,Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",47,0)
 S:MOPPC DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",48,0)
 ;I $G(PRCHAUTH)=1 S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=21:1,Z1=23:1,Z1=26:1,Z1=29:1,Z1=31:1,Z1=34:1,Z1=41:1,Z1=44:1,Z1=47:1,Z1=49:1,Z1=51:1,1:0)"
"RTN","PRCHINQ",49,0)
 I $G(PRCHAUTH)=1 D
"RTN","PRCHINQ",50,0)
 . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=23:1,Z1=26:1,Z1=31:1,1:0)"
"RTN","PRCHINQ",51,0)
 . S PRCHOLD=$P($G(^PRC(443.6,PRCHPO,7)),U)
"RTN","PRCHINQ",52,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Paid " D
"RTN","PRCHINQ",53,0)
 . . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=29:1,Z1=34:1,Z1=38:1,1:0)"
"RTN","PRCHINQ",54,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Partial Payment " D
"RTN","PRCHINQ",55,0)
 . . S DIC("S")="S Z1=$P(^(0),U,2) I $S(Z1=44:1,Z1=47:1,Z1=49:1,1:0)"
"RTN","PRCHINQ",56,0)
 K PRCHOLD,MOPPC
"RTN","PRCHINQ",57,0)
 QUIT
"RTN","PRCHINQ",58,0)
PAID ;To check if there is any payment made for this PO
"RTN","PRCHINQ",59,0)
 ;PRC*5.1*157 in addition to "Paid" status check, check added to insure there are no reconciliation charges linked to order that should prevent PO cancelling.
"RTN","PRCHINQ",60,0)
 I $G(PRCHAUTH)=1!($P(^PRC(442,PRCHPO,0),U,2)=25) D
"RTN","PRCHINQ",61,0)
 . S PRCHOLD=$P($G(^PRC(443.6,PRCHPO,7)),U)
"RTN","PRCHINQ",62,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Paid " S PAID=1
"RTN","PRCHINQ",63,0)
 . I $P($G(^PRCD(442.3,PRCHOLD,0)),"(")="Partial Payment " S PAID=1
"RTN","PRCHINQ",64,0)
 . I $G(PAID)'=1,$O(^PRCH(440.6,"PO",PRCHPO,0)) S PAID=1
"RTN","PRCHINQ",65,0)
 QUIT
"RTN","PRCHMA")
0^2^B77711518^B76984326
"RTN","PRCHMA",1,0)
PRCHMA ;WISC/AKS-Amend to PO, req ;6/10/96  14:07
"RTN","PRCHMA",2,0)
 ;;5.1;IFCAP;**21,79,100,113,157**;Oct 20, 2000;Build 2
"RTN","PRCHMA",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCHMA",4,0)
REQ N PRCHREQ
"RTN","PRCHMA",5,0)
 S PRCHREQ=1
"RTN","PRCHMA",6,0)
PO N PRCF,RETURN,PRCHAM,PRCHPO,PRCHNEW,OUT,CAN,PRCHAU,PRCHER,PRCHON,A,B,ER,FL,FIS,DELIVER,PRCHAMDA,PRCHAV,PRCHL1,PRCHLN,PRCHRET,LCNT
"RTN","PRCHMA",7,0)
 N PRCHL2,ROU,DIC,I,PRCHAMT,PRCHAREC,PRCHEDI,X,Y,PRCHN,PRCHO,SFUND,PRCHX,PRCHIMP,PRCHNRQ,PRCHP,REPO,PRCHNORE,%,%A,%B,D0,D1,J
"RTN","PRCHMA",8,0)
 N PRCFL,MSG
"RTN","PRCHMA",9,0)
LOOP D KILL^PRCHMA1 S PRCHNEW="",PRCHNORE=1,CAN=0
"RTN","PRCHMA",10,0)
 ; See routine PRCHAMXA for information on variable PRCHNORE and undefined DIK, var PRCHPO is the basic premise of locks applied to amendments
"RTN","PRCHMA",11,0)
 S PRCF("X")="S" D ^PRCFSITE Q:'$D(PRC("SITE"))
"RTN","PRCHMA",12,0)
 ; Lock simultaneous entry of users in amend. module for the same record.  Var Y is saved in PRCHPO at the end of GETPO subrtn, when we start
"RTN","PRCHMA",13,0)
 ; the process(AMENDNO) of amending the record we must have var PRCHPO.
"RTN","PRCHMA",14,0)
 S PRCFL=0
"RTN","PRCHMA",15,0)
 W !! D GETPO^PRCHAMU
"RTN","PRCHMA",16,0)
 ; If no record is selected or time-out or up-arrow out then exit without unlocking a record.
"RTN","PRCHMA",17,0)
 I $D(DTOUT)!$D(DUOUT)!$G(OUT)=1 G EXIT1
"RTN","PRCHMA",18,0)
 I PRCFL=1 G LOOP
"RTN","PRCHMA",19,0)
 I '$G(PRCHPO)!$D(FIS) G EXIT
"RTN","PRCHMA",20,0)
 I '$$VERIFY^PRCHES5(PRCHPO) W !!,?5,"This purchase order has been tampered with.",!,?5,"Please notify IFCAP APPLICATION COORDINATOR.",! G EXIT
"RTN","PRCHMA",21,0)
 D AMENDNO^PRCHAMU G:'$G(PRCHAM) EXIT
"RTN","PRCHMA",22,0)
 S PRCHAMT=0,FL=0
"RTN","PRCHMA",23,0)
 D INFO^PRCHAMU G:$D(PRCHAV)!ER EXIT
"RTN","PRCHMA",24,0)
 S X=$P($G(^PRC(443.6,PRCHPO,0)),U,16) D EN2^PRCHAMXB
"RTN","PRCHMA",25,0)
 I PRCHNEW="" S DA(1)=PRCHPO,DA=PRCHAM,PRCHX=X,X=0,PRCHAMDA=34 D EN8^PRCHAMXB S X=PRCHX
"RTN","PRCHMA",26,0)
 I $P(^PRC(443.6,PRCHPO,6,PRCHAM,0),U,4)=5!($P(^(0),U,4)=15) S CAN=1
"RTN","PRCHMA",27,0)
 I PRCHNEW=111&($G(CAN)=0) D REV
"RTN","PRCHMA",28,0)
 I $G(CAN)>0 D ENC G:ER EXIT I $G(NOCAN)=0 S DA(1)=PRCHPO,DA=PRCHAM,PRCHAMDA=34,PRCHX=X,X=0 D EN8^PRCHAMXB S X=PRCHX G CAN1
"RTN","PRCHMA",29,0)
ASK K NOCAN,DTOUT,DUOUT,REPONUM D ASK^PRCHAMU
"RTN","PRCHMA",30,0)
 G:$D(REPONUM)=1 CAN1
"RTN","PRCHMA",31,0)
 I ER=0 D  G:'$D(REPO)&($G(CAN)=0) ASK
"RTN","PRCHMA",32,0)
 . D @ROU
"RTN","PRCHMA",33,0)
 . I $G(PRCHAMDA)=31 D MSG^PRCHAMU Q
"RTN","PRCHMA",34,0)
 . I $G(PRCHAMDA)=24,$G(X)=2 D MSG1^PRCHAMU S SCE=1 Q
"RTN","PRCHMA",35,0)
 I $P(^PRC(443.6,PRCHPO,6,PRCHAM,0),U,4)=5!($P(^(0),U,4)=15) S CAN=1
"RTN","PRCHMA",36,0)
 I $D(DTOUT)!($D(DUOUT)) G EXIT
"RTN","PRCHMA",37,0)
 I $G(NOCAN)=1 G ASK
"RTN","PRCHMA",38,0)
 G:$P($G(^PRC(443.6,PRCHPO,6,PRCHAM,3,0)),U,4)'>1 EXIT
"RTN","PRCHMA",39,0)
CAN1 S BFLAG=0
"RTN","PRCHMA",40,0)
 S:$P($G(^PRC(443.6,PRCHPO,1)),U,7)'=6 BFLAG=1
"RTN","PRCHMA",41,0)
 I $P($G(^PRC(443.6,PRCHPO,1)),U,7)=6  D
"RTN","PRCHMA",42,0)
 .S THISHLD=0
"RTN","PRCHMA",43,0)
 .F  S THISHLD=$O(^PRC(443.6,PRCHPO,2,THISHLD)) Q:'THISHLD!(BFLAG=1)  D
"RTN","PRCHMA",44,0)
 ..S:$P($G(^PRC(443.6,PRCHPO,2,THISHLD,2)),U,2)'="" BFLAG=1
"RTN","PRCHMA",45,0)
 .Q:BFLAG=1
"RTN","PRCHMA",46,0)
 .S THISHLD=0
"RTN","PRCHMA",47,0)
 .F  S THISHLD=$O(^PRC(442,PRCHPO,2,THISHLD)) Q:'THISHLD!(BFLAG=1)  D
"RTN","PRCHMA",48,0)
 ..S:$P($G(^PRC(442,PRCHPO,2,THISHLD,2)),U,2)'="" BFLAG=1
"RTN","PRCHMA",49,0)
 W:BFLAG=0 !,"This is now a contract order.  You must add a contract to this orders item(s)",!,"before approving the amendment.",!
"RTN","PRCHMA",50,0)
 G:BFLAG=0 EXIT
"RTN","PRCHMA",51,0)
 D:BFLAG=1 UPDATE^PRCHAMU G:$D(Y) EXIT
"RTN","PRCHMA",52,0)
CHK I '$$VERIFY^PRCHES5(PRCHPO) W !!,?5,"This purchase order has been tampered with.",!,?5,"Please notify IFCAP APPLICATION COORDINATOR." G EXIT
"RTN","PRCHMA",53,0)
 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,1)),U,4)']"" W !!,?5,"There is no Amendment Status." D
"RTN","PRCHMA",54,0)
 .S POSTAT=+$G(^PRC(443.6,PRCHPO,7))
"RTN","PRCHMA",55,0)
 .S AMSTAT=$S(POSTAT=25:26,POSTAT=30:31,POSTAT=40:71,POSTAT=6:83,POSTAT=84:85,POSTAT=86:87,POSTAT=90:91,POSTAT=92:93,POSTAT=94:95,POSTAT=96:97,POSTAT=45:45,1:POSTAT)
"RTN","PRCHMA",56,0)
 .S AMSTAT=$P(^PRCD(442.3,AMSTAT,0),U)
"RTN","PRCHMA",57,0)
 .S DIE="^PRC(443.6,PRCHPO,6,",DA(1)=PRCHPO,DA=PRCHAM,DR="9//^S X=AMSTAT"
"RTN","PRCHMA",58,0)
 .D ^DIE K DIE,AMSTAT,POSTAT
"RTN","PRCHMA",59,0)
 K PRCHER S LCNT=1 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,1)),U,4)']"" W !!,?5,"There is no Amendment Status.",! S PRCHER=""
"RTN","PRCHMA",60,0)
 I $P($G(^PRC(443.6,PRCHPO,2,0)),U,4)>0 D  G:$D(PRCHER) ERR
"RTN","PRCHMA",61,0)
 .N END S END=IOSL-3
"RTN","PRCHMA",62,0)
 .S PRCH=0 F  S PRCH=$O(^PRC(443.6,PRCHPO,2,PRCH)) Q:PRCH=""!(PRCH'>0)  D
"RTN","PRCHMA",63,0)
 ..S PRCHLN=$G(^PRC(443.6,PRCHPO,2,PRCH,0)) D  Q
"RTN","PRCHMA",64,0)
 ...I $P(PRCHLN,U,4)="" D:LCNT>END TOP W !!,?5,"Line item ",+$P(PRCHLN,U)," is missing BOC !",$C(7) S PRCHER="",LCNT=LCNT+2
"RTN","PRCHMA",65,0)
 ...I $G(PRCHAUTH)'=1,$G(PRCHREQ) I $P(PRCHLN,U,13)="" D:LCNT>END TOP W !!,?5,"Line item ",+$P(PRCHLN,U)," is missing NSN!",$C(7) S PRCHER="",LCNT=LCNT+2
"RTN","PRCHMA",66,0)
 ...S J=0 S J=$O(^PRC(443.6,PRCHPO,2,PRCH,1,J)) I J'>0 D:LCNT>END TOP W !!,?5,"Line item ",+$P(PRCHLN,U)," is missing its description!",$C(7) S PRCHER="",LCNT=LCNT+2
"RTN","PRCHMA",67,0)
 ...I $P($G(^PRC(442,PRCHPO,23)),U,11)="D",$P($G(^PRC(443.6,PRCHPO,2,PRCH,2)),U,2)="" D:LCNT>END TOP W !!,?5,"Line item ",+$P(PRCHLN,U)," is missing contract number.",$C(7) S PRCHER="",LCNT=LCNT+2
"RTN","PRCHMA",68,0)
 ...; PRC*5.1*79 - Check line items of PC orders with source code=6 to make sure that a contract number is entered
"RTN","PRCHMA",69,0)
 ...D PCD^PRCHMA1
"RTN","PRCHMA",70,0)
 ...Q
"RTN","PRCHMA",71,0)
 ..Q
"RTN","PRCHMA",72,0)
 .I $D(PRCHER) I LCNT>END N DIR S DIR(0)="E" D ^DIR S LCNT=1
"RTN","PRCHMA",73,0)
 .Q
"RTN","PRCHMA",74,0)
 D EN106^PRCHNPO7 I $G(ERROR)=1 G EXIT
"RTN","PRCHMA",75,0)
 I $P($G(^PRC(443.6,PRCHPO,0)),U,13)>0 I $P($G(^PRC(443.6,PRCHPO,23)),U)="" W !!,?5,"This amendment has Est. Shipping and/or Handling charges without any",!,?5,"Est. Shipping BOC." S PRCHER=""
"RTN","PRCHMA",76,0)
 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,0)),U,4)=5!($P($G(^(0)),U,4)=15) S CAN=1
"RTN","PRCHMA",77,0)
 I $G(CAN)'=1 D CHECK^PRCHAMDF(PRCHPO,PRCHAM,.PRCHER)
"RTN","PRCHMA",78,0)
 I $G(PRCHAUTH)=1!($P($G(^PRC(443.6,PRCHPO,0)),U,2)=25) S FILE=443.6 D  I $G(ERROR) S PRCHER="" K ERROR,FILE
"RTN","PRCHMA",79,0)
 .D ^PRCHSF3
"RTN","PRCHMA",80,0)
 .D ADJ1^PRCHCD0
"RTN","PRCHMA",81,0)
 .D LIMIT^PRCHCD0
"RTN","PRCHMA",82,0)
 ;
"RTN","PRCHMA",83,0)
ERR I $D(PRCHER) W !!,?5,"This amendment needs to be re-edited before it can be signed.",!,"**REMINDER** Unsigned amendments are deleted from the system after 7 days." D:LCNT>20  G EXIT
"RTN","PRCHMA",84,0)
 .N DIR S DIR(0)="E" D ^DIR
"RTN","PRCHMA",85,0)
 .Q
"RTN","PRCHMA",86,0)
 D REV:'$G(PRCPROST),APP G:%'=1 EXIT
"RTN","PRCHMA",87,0)
 S PRCHRET=$$ASK^PRCHAM8(PRCHPO,PRCHAM) G:PRCHRET'=1 EXIT
"RTN","PRCHMA",88,0)
 S RETURN="" D COMMIT^PRCHAM8(PRCHPO,PRCHAM,.RETURN)
"RTN","PRCHMA",89,0)
 G:RETURN'=1 EXIT
"RTN","PRCHMA",90,0)
 S DIE="^PRC(443.6,"_PRCHPO_",6,",DA=PRCHAM,DR="15///TODAY+4" D ^DIE
"RTN","PRCHMA",91,0)
 D ^PRCHSF3
"RTN","PRCHMA",92,0)
 I $P(^PRC(443.6,PRCHPO,0),U,2)'=25 S PRCHQ="^PRCHPAM8",PRCHQ("DEST")="F",D0=PRCHPO,D1=PRCHAM D ^PRCHQUE
"RTN","PRCHMA",93,0)
 I '($P(^PRC(443.6,PRCHPO,0),U,2)=25!($P(^PRC(443.6,PRCHPO,0),U,19)=2)) D
"RTN","PRCHMA",94,0)
 . W !?3,"SEND TO SUPPLY " S PRCHQ="^PRCHPAM8",D0=PRCHPO,D1=PRCHAM D ^PRCHQUE
"RTN","PRCHMA",95,0)
 . S FILE=443.6 D:$D(PRCHPO) CHECK^PRCHSWCH
"RTN","PRCHMA",96,0)
 . I $G(PRCHOBL)=1 D SUPP^PRCFFM2M K FILE Q
"RTN","PRCHMA",97,0)
 . I $G(PRCHOBL)=2 S PRCOPODA=PRCHPO D ^PRCOEDI K FILE,PRCOPODA Q
"RTN","PRCHMA",98,0)
 I $P($G(^PRC(443.6,PRCHPO,0)),U,2)=25 D  S:$G(PRCPROST) PRCPROST=PRCPROST+0.9 G EXIT
"RTN","PRCHMA",99,0)
 .S MTOPDA=1
"RTN","PRCHMA",100,0)
 .D SUPP^PRCFFM2M ;I $P($G(^PRC(442,PRCHPO,23)),"^",11)="P" W !!,"...now generating the PHA transaction..." S PRCOPODA=PRCHPO D NEW^PRCOEDI K PRCOPODA W !!
"RTN","PRCHMA",101,0)
 .S PPTEMP=0,PP410=$P($G(^PRC(442,PRCHPO,0)),"^",12),PPAMT=$P($G(^PRC(442,PRCHPO,0)),"^",16) I PP410'="" S PPTEMP=$P($G(^PRCS(410,PP410,4)),"^",8),PPTEMP=-(PPAMT-PPTEMP)
"RTN","PRCHMA",102,0)
 .I $P($G(^PRC(442,PRCHPO,7)),"^",2)=45 S PPTEMP=PPAMT,PPAMT=0
"RTN","PRCHMA",103,0)
 .I PP410'="" S $P(^PRCS(410,PP410,4),"^",3)=0
"RTN","PRCHMA",104,0)
 .I PP410'="" S $P(^PRCS(410,PP410,4),"^",8)=PPAMT
"RTN","PRCHMA",105,0)
 .S A=$$DATE^PRC0C($P(PRCOAMT,"^",3),"I"),$P(PRCOAMT,"^",3,4)=$E(A,3,4)_"^"_$P(A,"^",2),$P(PRCOAMT,"^",5)=PPTEMP D EBAL^PRCSEZ(PRCOAMT,"O")
"RTN","PRCHMA",106,0)
 .I PP410'="",$P($G(^PRC(442,PRCHPO,7)),"^",2)=45 S $P(^PRCS(410,PP410,0),"^",2)="CA" D ERS410^PRC0G(PP410_"^C")
"RTN","PRCHMA",107,0)
 .D REMOVE^PRCSC2(PP410),ENCODE^PRCSC2(PP410,DUZ,.MESSAGE) K MESSAGE
"RTN","PRCHMA",108,0)
 .I '$G(PRCPROST) W !?3,"SEND TO SUPPLY " S PRCHQ="^PRCHPAM",D0=PRCHPO,D1=PRCHAM D ^PRCHQUE
"RTN","PRCHMA",109,0)
 .; Update file #440.5 after amendment has been approved. Consider orders created and amended in the same month and year and the user either
"RTN","PRCHMA",110,0)
 .; cancels the order or enters other type of amendment that changes the final amount of the order. No credit is given for orders from a
"RTN","PRCHMA",111,0)
 .; previous month and year. DT is the current date, system-supplied.
"RTN","PRCHMA",112,0)
 .S PRCHCD=$P($G(^PRC(442,PRCHPO,23)),U,8)
"RTN","PRCHMA",113,0)
 .S PRCNODE=$G(^PRC(442,PRCHPO,6,0)),PRCAMD=$P(PRCNODE,U,3)
"RTN","PRCHMA",114,0)
 .S PRCCHG=$P($G(^PRC(442,PRCHPO,6,PRCAMD,0)),U,3)
"RTN","PRCHMA",115,0)
 .S POSTAT=$P($G(^PRC(442,PRCHPO,7)),"^",2)
"RTN","PRCHMA",116,0)
 .I $E($P(^PRC(442,PRCHPO,1),U,15),1,5)=$E(DT,1,5),POSTAT'=45 D
"RTN","PRCHMA",117,0)
 ..I $G(PPAMT)<0 Q
"RTN","PRCHMA",118,0)
 ..S $P(^PRC(440.5,PRCHCD,2),U)=$P($G(^PRC(440.5,PRCHCD,2)),U)+$G(PRCCHG)
"RTN","PRCHMA",119,0)
 ..I $P($G(^PRC(440.5,PRCHCD,2)),U)<0 S $P(^PRC(440.5,PRCHCD,2),U)=0
"RTN","PRCHMA",120,0)
 .;
"RTN","PRCHMA",121,0)
 .I $E($P(^PRC(442,PRCHPO,1),U,15),1,5)=$E(DT,1,5),POSTAT=45 D
"RTN","PRCHMA",122,0)
 ..I $G(PPTEMP)<0 Q
"RTN","PRCHMA",123,0)
 ..S $P(^PRC(440.5,PRCHCD,2),U)=$P($G(^PRC(440.5,PRCHCD,2)),U)-$G(PPTEMP)
"RTN","PRCHMA",124,0)
 ..I $P($G(^PRC(440.5,PRCHCD,2)),U)<0 S $P(^PRC(440.5,PRCHCD,2),U)=0
"RTN","PRCHMA",125,0)
 .;
"RTN","PRCHMA",126,0)
 .; Update file #440.5 only if the amendment is for non-cancellation
"RTN","PRCHMA",127,0)
 .; of an order from a previous month regardless of the year.
"RTN","PRCHMA",128,0)
 .I $E($P(^PRC(442,PRCHPO,1),U,15),1,5)'=$E(DT,1,5),POSTAT'=45 D
"RTN","PRCHMA",129,0)
 ..I $G(PPAMT)<0 Q
"RTN","PRCHMA",130,0)
 ..S $P(^PRC(440.5,PRCHCD,2),U)=$P($G(^PRC(440.5,PRCHCD,2)),U)+$G(PPAMT)
"RTN","PRCHMA",131,0)
 .K DA,MTOPDA,PRCAMD,PRCHCD,PRCCHG,PRCNODE,POSTAT,PPTEMP,PPAMT,PP410
"RTN","PRCHMA",132,0)
 S SFUND="" I $P($G(^PRC(443.6,PRCHPO,0)),U,19)=2 D SUPP^PRCFFM2M S SFUND=1
"RTN","PRCHMA",133,0)
 I SFUND=1 W !?3,"SEND TO SUPPLY " S PRCHQ="^PRCHPAM",D0=PRCHPO,D1=PRCHAM D ^PRCHQUE
"RTN","PRCHMA",134,0)
 D SOURCE^PRCHAMU:$G(SCE)
"RTN","PRCHMA",135,0)
 G EXIT
"RTN","PRCHMA",136,0)
ENC S ER=0
"RTN","PRCHMA",137,0)
 D CAN^PRCHMA3
"RTN","PRCHMA",138,0)
 ;PRC*5.1*157   insures that if the user does not use Amendment to Purchase Card option
"RTN","PRCHMA",139,0)
 ;              an order using a credit card (MOP=25) will also be checked for any recon charges 
"RTN","PRCHMA",140,0)
 ;              still attached to order attempting to be cancelled
"RTN","PRCHMA",141,0)
 I $G(NOCAN)=1 W !?5,$S($D(PRCHREQ):"REQUISITION",1:"PURCHASE ORDER")_" HAS BEEN RECEIVED, CANNOT CANCEL !",$C(7) S ER=1 Q
"RTN","PRCHMA",142,0)
 I $G(PRCHAUTH)=1!($P(^PRC(442,PRCHPO,0),U,2)=25) D PAID^PRCHINQ I $G(PAID)=1 D  S ER=1 K PAID Q
"RTN","PRCHMA",143,0)
 . W !,?5,"THERE HAS BEEN PAYMENT MADE FOR THIS PURCHASE CARD ORDER, CANNOT CANCEL !",$C(7)
"RTN","PRCHMA",144,0)
 S %="",%A="     SURE YOU WANT TO CANCEL THIS ORDER ",%B="" D ^PRCFYN
"RTN","PRCHMA",145,0)
 I %'=1 W ?40,"    <NOTHING CANCELLED>" D  Q
"RTN","PRCHMA",146,0)
 .I $D(PRCHAU) D
"RTN","PRCHMA",147,0)
 ..S $P(^PRC(443.6,PRCHPO,6,PRCHAM,0),U,4)=PRCHAU
"RTN","PRCHMA",148,0)
 ..S $P(^PRC(443.6,PRCHPO,6,PRCHAM,1),U,4)=""
"RTN","PRCHMA",149,0)
 .S NOCAN=1
"RTN","PRCHMA",150,0)
 S DA(1)=PRCHPO,DIE="^PRC(443.6,"_DA(1)_",6,",DA=PRCHAM,DR="9////^S X=$O(^PRCD(442.3,""C"",45,0))"
"RTN","PRCHMA",151,0)
 D ^DIE K DIE,DA,DR S CAN=1
"RTN","PRCHMA",152,0)
 S PRCHAMT=-$P(^PRC(443.6,PRCHPO,0),U,15) W !
"RTN","PRCHMA",153,0)
 QUIT
"RTN","PRCHMA",154,0)
APP S %A="   Approve Amendment number "_PRCHAM_": ",%B="",%=$S($G(PRCPROST):1,1:2) D ^PRCFYN
"RTN","PRCHMA",155,0)
 Q
"RTN","PRCHMA",156,0)
REV N PRCH
"RTN","PRCHMA",157,0)
 S %=1,%B="",%A="   Review Amendment " D ^PRCHSF3 W ! D ^PRCFYN
"RTN","PRCHMA",158,0)
 I %=1 S D0=PRCHPO,D1=PRCHAM,PRCH="^PRC(443.6," D ^PRCHDAM
"RTN","PRCHMA",159,0)
 Q
"RTN","PRCHMA",160,0)
EXIT L -^PRC(442,PRCENTRY)
"RTN","PRCHMA",161,0)
EXIT1 K ERROR,FIS,REPO,DEL
"RTN","PRCHMA",162,0)
 QUIT:$G(PRCPROST)
"RTN","PRCHMA",163,0)
 I $G(OUT)'=1 G LOOP
"RTN","PRCHMA",164,0)
 QUIT
"RTN","PRCHMA",165,0)
FLAG I $G(FLAG)=1 K FLAG Q
"RTN","PRCHMA",166,0)
 Q
"RTN","PRCHMA",167,0)
NOSIGN S $P(^PRC(443.6,PRCHPO,6,PRCHAM,0),U,4)=PRCHAU
"RTN","PRCHMA",168,0)
NOSIGN1 S DA(1)=PRCHPO,DIE="^PRC(443.6,"_DA(1)_",6,",DA=PRCHAM,DR="9///@"
"RTN","PRCHMA",169,0)
 D ^DIE K DIE,DA,DR
"RTN","PRCHMA",170,0)
 Q
"RTN","PRCHMA",171,0)
TOP ;PAUSE AT BOTTOM OF SCREEN
"RTN","PRCHMA",172,0)
 N DIR S DIR(0)="E"
"RTN","PRCHMA",173,0)
 D ^DIR
"RTN","PRCHMA",174,0)
 S LCNT=1
"RTN","PRCHMA",175,0)
 Q
"RTN","PRCHMA1")
0^3^B47127085^B46254767
"RTN","PRCHMA1",1,0)
PRCHMA1 ;WISC/AKS/DWA-Amendments to purchase orders and requisitions ;6/8/96  13:42
"RTN","PRCHMA1",2,0)
 ;;5.1;IFCAP;**22,40,79,157**;Oct 20, 2000;Build 2
"RTN","PRCHMA1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PRCHMA1",4,0)
EN4 ;Line Item edit
"RTN","PRCHMA1",5,0)
 ;
"RTN","PRCHMA1",6,0)
 ;MOP=Method of Processing
"RTN","PRCHMA1",7,0)
 ;SSO=Supply Status Order
"RTN","PRCHMA1",8,0)
 ;
"RTN","PRCHMA1",9,0)
 N DIC,DIE,DA,DR,PRCHSTN,PRCHI,PRCHI1,PRCHO,PRCHEDI,PRCHSTN,PRCHPONO,DIE,DR,PRCHN,PRCHAREC,MOP,SSO
"RTN","PRCHMA1",10,0)
 S MOP=$P($G(^PRC(442,PRCHPO,0)),U,2),SSO=$P($G(^PRC(442,PRCHPO,7)),U,2)
"RTN","PRCHMA1",11,0)
 I ".27.28.33.25.26.30.31.40.41.32.34.37.38.46.47.48.49.96.97."[("."_SSO_".") D
"RTN","PRCHMA1",12,0)
 . I MOP=25,$P(^PRC(442,PRCHPO,23),U,15)'="Y" Q
"RTN","PRCHMA1",13,0)
 . I ".2.4.7.26."[("."_MOP_".") Q
"RTN","PRCHMA1",14,0)
 . W !!
"RTN","PRCHMA1",15,0)
 . W !,?15,"****************** TAKE NOTE!! ********************"
"RTN","PRCHMA1",16,0)
 . W !,?15,"*                                                 *"
"RTN","PRCHMA1",17,0)
 . W !,?15,"*  This order has a Receiving Report previously   *"
"RTN","PRCHMA1",18,0)
 . W !,?15,"*  processed.  If this amendment will alter the   *"
"RTN","PRCHMA1",19,0)
 . W !,?15,"*  Total Cost of any line item on the order       *"
"RTN","PRCHMA1",20,0)
 . W !,?15,"*  remember to back out the previous Receiving    *"
"RTN","PRCHMA1",21,0)
 . W !,?15,"*  Report with an Adjustment Voucher, process     *"
"RTN","PRCHMA1",22,0)
 . W !,?15,"*  the amendment, and rerun the Receiving         *"
"RTN","PRCHMA1",23,0)
 . W !,?15,"*  Report.                                        *"
"RTN","PRCHMA1",24,0)
 . W !,?15,"*                                                 *"
"RTN","PRCHMA1",25,0)
 . W !,?15,"***************************************************"
"RTN","PRCHMA1",26,0)
 . W !!
"RTN","PRCHMA1",27,0)
 . Q
"RTN","PRCHMA1",28,0)
 K MOP,SSO
"RTN","PRCHMA1",29,0)
 D MV^PRCHMA0 I $G(PRCPROST)=6 S PRCHI=$O(^PRC(443.6,PRCRI(443.6),2,0)),PRCHI1=PRCHI,X=1,$P(PRCHI,U,2)=$P(^(PRCHI,0),U) G EN4A
"RTN","PRCHMA1",30,0)
 S DA(1)=PRCHPO,DIC="^PRC(443.6,"_DA(1)_",2,",DIC(0)="AEQZ" D ^DIC Q:Y<0  S PRCHI=Y,PRCHI1=$P(Y,U,2)
"RTN","PRCHMA1",31,0)
EN4A ;Called from routine PRCHMA2B for chenge vendor amendments to enable
"RTN","PRCHMA1",32,0)
 ;line item edits for vendor specific information.
"RTN","PRCHMA1",33,0)
 S PRCHO=+$G(^PRC(443.6,PRCHPO,2,+PRCHI,2))
"RTN","PRCHMA1",34,0)
 S PRCHEDI=$G(^PRC(440,$P(^PRC(443.6,PRCHPO,1),U),3)) S:PRCHEDI]"" PRCHEDI=$P(PRCHEDI,U,2)
"RTN","PRCHMA1",35,0)
 S PRCHSTN=$P($P(^PRC(443.6,PRCHPO,0),U),"-")
"RTN","PRCHMA1",36,0)
 S PRCHPONO=$P(^PRC(443.6,PRCHPO,0),U)
"RTN","PRCHMA1",37,0)
 I $G(PRCPROST)=6 D  G EN4B
"RTN","PRCHMA1",38,0)
 . N X
"RTN","PRCHMA1",39,0)
 . S PRCRI(443.61)=$O(^PRC(443.6,PRCRI(443.6),2,0))
"RTN","PRCHMA1",40,0)
 . I PRCRI(443.61) D EDIT^PRC0B(.X,"443.6;^PRC(443.6,;"_PRCRI(443.6)_"~443.61;^PRC(443.6,"_PRCRI(443.6)_",2,;"_PRCRI(443.61),"5///"_PRCPAMT)
"RTN","PRCHMA1",41,0)
 . QUIT
"RTN","PRCHMA1",42,0)
 S DIE="^PRC(443.6,",DA=PRCHPO
"RTN","PRCHMA1",43,0)
 S DR=$S($D(PRCHREQ):"[PRCHRQITM]",1:"[PRCHLINE]"),DIE("NO^")="BACK"
"RTN","PRCHMA1",44,0)
 ;I $G(PRCHVFLG)>0 S DR=$S($D(PRCHREQ):"[PRCH CHNGVEND RQ",1:"[PRCH CHNGVEND PO]"),DIE("NO^")="BACK"
"RTN","PRCHMA1",45,0)
 I $G(PRCHAUTH)=1 S DR="[PRCH PURCHASE CARD AMEND]"
"RTN","PRCHMA1",46,0)
 I $G(PRCHAUTH)=2 S DR="[PRCH DELIVERY ORDER AMEND]"
"RTN","PRCHMA1",47,0)
 D ^DIE K DIE
"RTN","PRCHMA1",48,0)
EN4B ;Called from routine PRCHMA2C for change vendor amendments to enable
"RTN","PRCHMA1",49,0)
 ;line item edits if required information is missing.
"RTN","PRCHMA1",50,0)
 S PRCHN=+$G(^PRC(443.6,PRCHPO,2,+PRCHI,2))
"RTN","PRCHMA1",51,0)
 I PRCHO'=PRCHN S PRCHAMT=PRCHAMT+(PRCHN-PRCHO)
"RTN","PRCHMA1",52,0)
 I $D(^PRC(443.6,PRCHPO,2,+PRCHI,2)),$P(^(2),U,6)>0 S PRCHAREC=1
"RTN","PRCHMA1",53,0)
 I $P($G(^PRC(443.6,PRCHPO,2,+PRCHI,0)),U,2)'>$P($G(^(2)),U,8) D
"RTN","PRCHMA1",54,0)
 .S PRCHX($P(PRCHI,U,2),"@")="^PRC(442,PRCHPO,2,""C"",X,"_+PRCHI_")"
"RTN","PRCHMA1",55,0)
 E  S PRCHX($P(PRCHI,U,2),$P(PRCHI,U,2))="^PRC(442,PRCHPO,2,""C"",X,"_+PRCHI_")"
"RTN","PRCHMA1",56,0)
 S DELIVER=1 W !
"RTN","PRCHMA1",57,0)
 D ERCHK,EN0^PRCHAMXH
"RTN","PRCHMA1",58,0)
 K PRCHI
"RTN","PRCHMA1",59,0)
 QUIT
"RTN","PRCHMA1",60,0)
EN5 ;Source Code edit
"RTN","PRCHMA1",61,0)
 N DIE,DR
"RTN","PRCHMA1",62,0)
 S DIC="^PRCD(420.8,",DIC(0)="AEQ"
"RTN","PRCHMA1",63,0)
 S:$D(PRCHREQ) DIC("S")="I ""134590""[$E(^(0))"
"RTN","PRCHMA1",64,0)
 S:$P($G(^PRC(443.6,PRCHPO,1)),U,7)>0 DIC("B")=$P(^PRCD(420.8,$P(^(1),U,7),0),"^")
"RTN","PRCHMA1",65,0)
 D ^DIC K DIC Q:Y<0
"RTN","PRCHMA1",66,0)
 S DIE="^PRC(443.6,",DA=PRCHPO,DR="8////"_+Y D ^DIE K DIE W !
"RTN","PRCHMA1",67,0)
 QUIT
"RTN","PRCHMA1",68,0)
EN6 ;Edit Mail Invoice to
"RTN","PRCHMA1",69,0)
 N DA,DIE,DR
"RTN","PRCHMA1",70,0)
 S DA=PRCHPO,DIE="^PRC(443.6,",DR=.04 D ^DIE W !
"RTN","PRCHMA1",71,0)
 QUIT
"RTN","PRCHMA1",72,0)
EN7 ;Edit Method of Payment
"RTN","PRCHMA1",73,0)
 N DA,DIE,DR
"RTN","PRCHMA1",74,0)
 S DA=PRCHPO,DIE="^PRC(443.6,",DR=.02 D ^DIE W !
"RTN","PRCHMA1",75,0)
 QUIT
"RTN","PRCHMA1",76,0)
EN8 ;Administrative Certification add
"RTN","PRCHMA1",77,0)
 N DIE,DA,DR,DLAYGO
"RTN","PRCHMA1",78,0)
 D MVADM S DA(1)=PRCHPO
"RTN","PRCHMA1",79,0)
 S DIC="^PRC(443.6,"_DA(1)_",15,",DIC(0)="AEQL",DLAYGO=443.6 D ^DIC K DIC
"RTN","PRCHMA1",80,0)
 W !
"RTN","PRCHMA1",81,0)
 QUIT
"RTN","PRCHMA1",82,0)
EN9 ;Administrative Certification delete
"RTN","PRCHMA1",83,0)
 N DIE,DA,DR
"RTN","PRCHMA1",84,0)
 D MVADM S DA(1)=PRCHPO
"RTN","PRCHMA1",85,0)
 S DIC="^PRC(443.6,"_DA(1)_",15,",DIC(0)="AEQ" D ^DIC K DIC
"RTN","PRCHMA1",86,0)
 S DIE="^PRC(443.6,"_DA(1)_",15,",DA=+Y,DR=".01////@" D ^DIE K DIE
"RTN","PRCHMA1",87,0)
 QUIT
"RTN","PRCHMA1",88,0)
EN13 ;Replace P.O. Number
"RTN","PRCHMA1",89,0)
 N X,I,PRCH0,PRCHO,PRCHNRQ,PRCHN,ER,OK,P2237
"RTN","PRCHMA1",90,0)
 S (I,ER)=0,X=""
"RTN","PRCHMA1",91,0)
 ;F  S I=$O(^PRC(442,PRCHPO,11,I)) Q:'I  I $D(^(I,0)) S X=$P(^(0),U,8) Q:X]""
"RTN","PRCHMA1",92,0)
 D CAN^PRCHMA3
"RTN","PRCHMA1",93,0)
 I $G(NOCAN)=1 W !?5,$S($D(PRCHREQ):"REQUISITION",1:"PURCHASE ORDER")_" HAS BEEN RECEIVED, CANNOT CANCEL !",$C(7) Q
"RTN","PRCHMA1",94,0)
 ;PRC*5.1*157   insures that if the user does not use Amendment to Purchase Card option
"RTN","PRCHMA1",95,0)
 ;              an order using a credit card (MOP=25) will also be checked for any recon charges 
"RTN","PRCHMA1",96,0)
 ;              still attached to order attempting to be cancelled
"RTN","PRCHMA1",97,0)
 I $G(PRCHAUTH)=1!($P(^PRC(442,PRCHPO,0),U,2)=25) D PAID^PRCHINQ I $G(PAID)=1 D  K PAID Q
"RTN","PRCHMA1",98,0)
 . W !,?5,"THERE HAS BEEN PAYMENT MADE FOR THIS PURCHASE CARD ORDER, CANNOT CANCEL !",$C(7)
"RTN","PRCHMA1",99,0)
 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,3,0)),U,4)>2 D ERR Q
"RTN","PRCHMA1",100,0)
 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,3,0)),U,4)=2 I $P($G(^PRC(443.6,PRCHPO,6,PRCHAM,3,2,0)),U,2)'=34 D ERR Q
"RTN","PRCHMA1",101,0)
 S P2237=$P(^PRC(443.6,PRCHPO,0),U,12),OK=1 D:P2237>0  Q:OK=0
"RTN","PRCHMA1",102,0)
 .I '$$VERIFY^PRCSC2(P2237) W !!,?5,"This requisition has been tampered with.",!,?5,"Please notify IFCAP APPLICATION COORDINATOR.",! S OK=0
"RTN","PRCHMA1",103,0)
 I $D(PRCHREQ) S PRCHNRQ=PRCHREQ
"RTN","PRCHMA1",104,0)
 S PRCH0=$G(^PRC(443.6,PRCHPO,0))
"RTN","PRCHMA1",105,0)
 S PRCHO=$P(PRCH0,U),PRCH=PRCHPO D
"RTN","PRCHMA1",106,0)
 .I $D(PRCHNRQ) S PRCHP("A")="REQUISITION NUMBER",PRCHP("T")=8,PRCHP("S")=1 D EN^PRCHPAT Q
"RTN","PRCHMA1",107,0)
 .I $D(PRCHIMP) S PRCHP("A")="IMPREST FUND P.O.NO.: ",PRCHP("T")=7,PRCHP("S")=3 D EN^PRCHPAT Q
"RTN","PRCHMA1",108,0)
 .D ENPO^PRCHUTL Q
"RTN","PRCHMA1",109,0)
 I '$D(PRCHPO) S PRCHPO=PRCH Q
"RTN","PRCHMA1",110,0)
 S PRCHN=$P(^PRC(442,PRCHPO,0),U),NDOC=$P(^(18),U,3)
"RTN","PRCHMA1",111,0)
 N %X,%Y,DIE,DR,DA
"RTN","PRCHMA1",112,0)
 S %X="^PRC(442,PRCH,",%Y="^PRC(443.6,PRCHPO," D %XY^%RCR
"RTN","PRCHMA1",113,0)
 F I=6,10,11 K ^PRC(443.6,PRCHPO,I)
"RTN","PRCHMA1",114,0)
 S DIE="^PRC(443.6,",DA=PRCHPO
"RTN","PRCHMA1",115,0)
 S DR=".01///^S X=PRCHN;27///^S X=PRCHO;102///^S X=NDOC"
"RTN","PRCHMA1",116,0)
 D ^DIE K DIE,DA,DR,NDOC
"RTN","PRCHMA1",117,0)
 S DIE="^PRC(443.6,",DA=PRCH,DR="28///^S X=PRCHN" D ^DIE K DIE,DA,DR
"RTN","PRCHMA1",118,0)
 S X=0,PRCHPO=PRCH D EN4^PRCHAMXB
"RTN","PRCHMA1",119,0)
 S DA(1)=PRCH,DIE="^PRC(443.6,"_DA(1)_",6,",DA=PRCHAM,DR="9////^S X=$O(^PRCD(442.3,""C"",45,0))"
"RTN","PRCHMA1",120,0)
 D ^DIE
"RTN","PRCHMA1",121,0)
 S DELIVER=1,REPO=1,PRCHPO=PRCH,CAN=1 W !
"RTN","PRCHMA1",122,0)
 QUIT
"RTN","PRCHMA1",123,0)
MVADM ;Move Administrative Certifications from file 442
"RTN","PRCHMA1",124,0)
 Q:$D(^PRC(443.6,PRCHPO,15,0))&($P($G(^(0)),U,4)>0)  D WAIT^DICD
"RTN","PRCHMA1",125,0)
 N %X,%Y
"RTN","PRCHMA1",126,0)
 S %X="^PRC(442,PRCHPO,15,",%Y="^PRC(443.6,PRCHPO,15," D %XY^%RCR
"RTN","PRCHMA1",127,0)
 S $P(^PRC(443.6,PRCHPO,15,0),U,2)=$P(^DD(443.6,24,0),U,2)
"RTN","PRCHMA1",128,0)
 QUIT
"RTN","PRCHMA1",129,0)
ERCHK N NODE0
"RTN","PRCHMA1",130,0)
 S ERROR=0,NODE0=^PRC(443.6,PRCHPO,2,+PRCHI,0)
"RTN","PRCHMA1",131,0)
 I '$O(^PRC(443.6,PRCHPO,2,+PRCHI,1,0)) W !,"Line item ",+NODE0," is missing its description!",! S ERROR=1
"RTN","PRCHMA1",132,0)
 I $P(NODE0,U,4)="" W !,"Line item ",+NODE0," is missing BOC !",! S ERROR=1
"RTN","PRCHMA1",133,0)
 I $G(PRCHAUTH)'=1,$D(PRCHREQ),$P(NODE0,U,13)="" W !,"Line item ",+NODE0," is missing NSN !",! S ERROR=1
"RTN","PRCHMA1",134,0)
 I '$D(^PRC(443.6,PRCHPO,2,+PRCHI,2)) W !,"Line item ",+NODE0," is incomplete !",! S ERROR=1
"RTN","PRCHMA1",135,0)
 I $P($G(^PRC(442,PRCHPO,23)),U,11)="D",$P($G(^PRC(443.6,PRCHPO,2,+PRCHI,2)),U,2)="" W !,"Line item ",+NODE0," does contain contract number.",! S ERROR=1
"RTN","PRCHMA1",136,0)
 ;W:ERROR !,"Editing of the line item is required !",!
"RTN","PRCHMA1",137,0)
 Q
"RTN","PRCHMA1",138,0)
KILL ;Kill
"RTN","PRCHMA1",139,0)
 K PRCF,RETURN,PRCHAM,PRCHPO,PRCHNEW,OUT,A,B,ER,FL,FIS,DELIVER,PRCHAMDA
"RTN","PRCHMA1",140,0)
 K PRCHAV,PRCHL1,PRCHL2,ROU,DIC,I,PRCHAMT,PRCHAREC,PRCHEDI,X,Y,PRCHN
"RTN","PRCHMA1",141,0)
 K PRCHO,PRCHX,PRCHIMP,PRCHNRQ,PRCHP,PRCHPO,REPO,PRCHNORE,%,%A,%B,D0,D1
"RTN","PRCHMA1",142,0)
 K PRCHU,PRCHER,PRCHLN,PRCHRET,PRCHQ,AA,PRCHVN
"RTN","PRCHMA1",143,0)
 Q
"RTN","PRCHMA1",144,0)
ERR W !!?5,"To "_$S($D(PRCHREQ):$P(^PRCD(441.6,32,0),U,2),1:$P(^PRCD(442.2,32,0),U,2))_" it must be the ONLY change you",!?5,"are making on the amendment."
"RTN","PRCHMA1",145,0)
 Q
"RTN","PRCHMA1",146,0)
 ;
"RTN","PRCHMA1",147,0)
PCD ;PRC*5.1*79 - Check line items of Detailed PC orders with source code=6
"RTN","PRCHMA1",148,0)
 ;for missing contract number, called from PRCHMA.
"RTN","PRCHMA1",149,0)
 I $P($G(^PRC(442,PRCHPO,23)),U,11)="P",$P($G(^PRC(442,PRCHPO,1)),U,7)=6,$P($G(^PRC(443.6,PRCHPO,2,PRCH,2)),U,2)="" D:LCNT>END TOP^PRCHMA W !!,?5,"Line item ",+$P(PRCHLN,U)," is missing a required contract number.",$C(7) S PRCHER="",LNCT=LCNT+2
"RTN","PRCHMA1",150,0)
 Q 
"VER")
8.0^22.0
"BLD",6612,6)
^141
**END**
**END**
