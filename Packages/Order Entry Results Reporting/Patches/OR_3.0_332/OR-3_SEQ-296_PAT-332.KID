Released OR*3*332 SEQ #296
Extracted from mail message
**KIDS**:OR*3.0*332^

**INSTALL NAME**
OR*3.0*332
"BLD",7994,0)
OR*3.0*332^ORDER ENTRY/RESULTS REPORTING^0^3110519^y
"BLD",7994,1,0)
^^1^1^3041201^^^^
"BLD",7994,1,1,0)
Refer to the patch description on the patch message.
"BLD",7994,4,0)
^9.64PA^^0
"BLD",7994,6)
^279
"BLD",7994,6.3)
44
"BLD",7994,"ABNS",0)
^9.66A^^
"BLD",7994,"ABPKG")
n^n^
"BLD",7994,"INI")
PRE^ORY332
"BLD",7994,"INID")
^n^n
"BLD",7994,"INIT")
POST^ORY332
"BLD",7994,"KRN",0)
^9.67PA^779.2^21
"BLD",7994,"KRN",.4,0)
.4
"BLD",7994,"KRN",.4,"NM",0)
^9.68A^^
"BLD",7994,"KRN",.401,0)
.401
"BLD",7994,"KRN",.402,0)
.402
"BLD",7994,"KRN",.403,0)
.403
"BLD",7994,"KRN",.5,0)
.5
"BLD",7994,"KRN",.84,0)
.84
"BLD",7994,"KRN",.84,"NM",0)
^9.68A^^
"BLD",7994,"KRN",3.6,0)
3.6
"BLD",7994,"KRN",3.8,0)
3.8
"BLD",7994,"KRN",9.2,0)
9.2
"BLD",7994,"KRN",9.8,0)
9.8
"BLD",7994,"KRN",9.8,"NM",0)
^9.68A^13^13
"BLD",7994,"KRN",9.8,"NM",1,0)
ORWDXVB1^^0^B62395957
"BLD",7994,"KRN",9.8,"NM",2,0)
ORWDXVB2^^0^B13660185
"BLD",7994,"KRN",9.8,"NM",3,0)
ORWLR1^^0^B40020805
"BLD",7994,"KRN",9.8,"NM",4,0)
ORWLR^^0^B9107402
"BLD",7994,"KRN",9.8,"NM",5,0)
ORCDVBEC^^0^B78567106
"BLD",7994,"KRN",9.8,"NM",6,0)
ORCSEND2^^0^B33762828
"BLD",7994,"KRN",9.8,"NM",7,0)
ORMVBEC^^0^B25556094
"BLD",7994,"KRN",9.8,"NM",8,0)
ORWLR3^^0^B130594951
"BLD",7994,"KRN",9.8,"NM",9,0)
ORWDXVB^^0^B45633676
"BLD",7994,"KRN",9.8,"NM",10,0)
ORWLR4^^0^B35348336
"BLD",7994,"KRN",9.8,"NM",11,0)
ORWRPL^^0^B49132980
"BLD",7994,"KRN",9.8,"NM",12,0)
ORWRPP^^0^B42549274
"BLD",7994,"KRN",9.8,"NM",13,0)
ORWRP2^^0^B30528782
"BLD",7994,"KRN",9.8,"NM","B","ORCDVBEC",5)

"BLD",7994,"KRN",9.8,"NM","B","ORCSEND2",6)

"BLD",7994,"KRN",9.8,"NM","B","ORMVBEC",7)

"BLD",7994,"KRN",9.8,"NM","B","ORWDXVB",9)

"BLD",7994,"KRN",9.8,"NM","B","ORWDXVB1",1)

"BLD",7994,"KRN",9.8,"NM","B","ORWDXVB2",2)

"BLD",7994,"KRN",9.8,"NM","B","ORWLR",4)

"BLD",7994,"KRN",9.8,"NM","B","ORWLR1",3)

"BLD",7994,"KRN",9.8,"NM","B","ORWLR3",8)

"BLD",7994,"KRN",9.8,"NM","B","ORWLR4",10)

"BLD",7994,"KRN",9.8,"NM","B","ORWRP2",13)

"BLD",7994,"KRN",9.8,"NM","B","ORWRPL",11)

"BLD",7994,"KRN",9.8,"NM","B","ORWRPP",12)

"BLD",7994,"KRN",19,0)
19
"BLD",7994,"KRN",19,"NM",0)
^9.68A^^
"BLD",7994,"KRN",19.1,0)
19.1
"BLD",7994,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",7994,"KRN",101,0)
101
"BLD",7994,"KRN",101,"NM",0)
^9.68A^^0
"BLD",7994,"KRN",409.61,0)
409.61
"BLD",7994,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",7994,"KRN",771,0)
771
"BLD",7994,"KRN",779.2,0)
779.2
"BLD",7994,"KRN",869.2,0)
869.2
"BLD",7994,"KRN",870,0)
870
"BLD",7994,"KRN",8989.51,0)
8989.51
"BLD",7994,"KRN",8989.51,"NM",0)
^9.68A^4^4
"BLD",7994,"KRN",8989.51,"NM",1,0)
OR VBECS REASON SORT ALPHA^^0
"BLD",7994,"KRN",8989.51,"NM",2,0)
OR VBECS REASON FOR REQUEST^^0
"BLD",7994,"KRN",8989.51,"NM",3,0)
OR VBECS AVAIL UNITS FORMAT^^0
"BLD",7994,"KRN",8989.51,"NM",4,0)
OR VBECS LOC ABBREV BB REPORT^^0
"BLD",7994,"KRN",8989.51,"NM","B","OR VBECS AVAIL UNITS FORMAT",3)

"BLD",7994,"KRN",8989.51,"NM","B","OR VBECS LOC ABBREV BB REPORT",4)

"BLD",7994,"KRN",8989.51,"NM","B","OR VBECS REASON FOR REQUEST",2)

"BLD",7994,"KRN",8989.51,"NM","B","OR VBECS REASON SORT ALPHA",1)

"BLD",7994,"KRN",8989.52,0)
8989.52
"BLD",7994,"KRN",8994,0)
8994
"BLD",7994,"KRN","B",.4,.4)

"BLD",7994,"KRN","B",.401,.401)

"BLD",7994,"KRN","B",.402,.402)

"BLD",7994,"KRN","B",.403,.403)

"BLD",7994,"KRN","B",.5,.5)

"BLD",7994,"KRN","B",.84,.84)

"BLD",7994,"KRN","B",3.6,3.6)

"BLD",7994,"KRN","B",3.8,3.8)

"BLD",7994,"KRN","B",9.2,9.2)

"BLD",7994,"KRN","B",9.8,9.8)

"BLD",7994,"KRN","B",19,19)

"BLD",7994,"KRN","B",19.1,19.1)

"BLD",7994,"KRN","B",101,101)

"BLD",7994,"KRN","B",409.61,409.61)

"BLD",7994,"KRN","B",771,771)

"BLD",7994,"KRN","B",779.2,779.2)

"BLD",7994,"KRN","B",869.2,869.2)

"BLD",7994,"KRN","B",870,870)

"BLD",7994,"KRN","B",8989.51,8989.51)

"BLD",7994,"KRN","B",8989.52,8989.52)

"BLD",7994,"KRN","B",8994,8994)

"BLD",7994,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7994,"QUES",0)
^9.62^^
"BLD",7994,"REQB",0)
^9.611^2^2
"BLD",7994,"REQB",1,0)
OR*3.0*309^2
"BLD",7994,"REQB",2,0)
OR*3.0*109^2
"BLD",7994,"REQB","B","OR*3.0*109",2)

"BLD",7994,"REQB","B","OR*3.0*309",1)

"INI")
PRE^ORY332
"INIT")
POST^ORY332
"KRN",8989.5,5295,0)
110;DIC(9.4,^OR VBECS REASON FOR REQUEST^5
"KRN",8989.5,5295,1)
Transfuse
"KRN",8989.5,5296,0)
110;DIC(9.4,^OR VBECS REASON FOR REQUEST^10
"KRN",8989.5,5296,1)
Hold for OR
"KRN",8989.5,5297,0)
110;DIC(9.4,^OR VBECS REASON FOR REQUEST^15
"KRN",8989.5,5297,1)
Hold until MD gives order
"KRN",8989.5,5298,0)
110;DIC(9.4,^OR VBECS REASON FOR REQUEST^20
"KRN",8989.5,5298,1)
See COMMENT for justification
"KRN",8989.51,482,-1)
0^2
"KRN",8989.51,482,0)
OR VBECS REASON FOR REQUEST^List of Reasons for Request^1^Sequence^Reason
"KRN",8989.51,482,1)
F^1:75^Enter a reason for request
"KRN",8989.51,482,6)
N^1:99:2^Enter the sequence in which the reason should appear in the selection list
"KRN",8989.51,482,20,0)
^8989.512^1^1^3101216^^^^
"KRN",8989.51,482,20,1,0)
This parameter allows local configuration of the Reasons for Request.
"KRN",8989.51,482,30,0)
^8989.513I^3^3
"KRN",8989.51,482,30,1,0)
5^4.2
"KRN",8989.51,482,30,2,0)
10^9.4
"KRN",8989.51,482,30,3,0)
3^4
"KRN",8989.51,577,-1)
0^1
"KRN",8989.51,577,0)
OR VBECS REASON SORT ALPHA^Sort VBECS Reasons Alphabetically^^^Yes/No
"KRN",8989.51,577,1)
Y^Y:yes;N:no^Enter 'yes' to sort Reasons for Request Alphabetically
"KRN",8989.51,577,20,0)
^8989.512^1^1^3100713^^^^
"KRN",8989.51,577,20,1,0)
'Yes' indicates that VBECS Reasons for Request will be sorted Alphabetically.
"KRN",8989.51,577,30,0)
^8989.513I^4^3
"KRN",8989.51,577,30,2,0)
2^4
"KRN",8989.51,577,30,3,0)
3^4.2
"KRN",8989.51,577,30,4,0)
1^9.4
"KRN",8989.51,591,-1)
0^3
"KRN",8989.51,591,0)
OR VBECS AVAIL UNITS FORMAT^Display/Print Format for Available Units^^^Display/Print Format for Available Units
"KRN",8989.51,591,1)
S^0:HORIZONTAL;1:VERTICAL;2:SPLIT HORIZONTAL^0=Horizontal, 1=Vertical, 2=Split Horizontal
"KRN",8989.51,591,20,0)
^8989.512^29^29^3110202^^^^
"KRN",8989.51,591,20,1,0)
This parameter determines the format that Available Units is displayed
"KRN",8989.51,591,20,2,0)
on the Blood Bank Report and the Patient Information screen on the
"KRN",8989.51,591,20,3,0)
Blood Bank Order Dialog.
"KRN",8989.51,591,20,4,0)
 0:HORIZONTAL - Displays fields across the page, one line per date/time.
"KRN",8989.51,591,20,5,0)
                Printed reports splits line if longer than 79 characters.
"KRN",8989.51,591,20,6,0)
 1:VERTICAL   - Displays fields down the page in sections per date/time.
"KRN",8989.51,591,20,7,0)
              - Printed report looks the same.
"KRN",8989.51,591,20,8,0)
 2:SPLIT HORIZONTAL - 
"KRN",8989.51,591,20,9,0)
   Patient Information Screen - Same as HORIZONTAL format
"KRN",8989.51,591,20,10,0)
   Report - Splits line in 2 if longer than 79 characters.
"KRN",8989.51,591,20,11,0)
   Printed Report - Splits line in 2 if longer than 79 characters.
"KRN",8989.51,591,20,12,0)
 
"KRN",8989.51,591,20,13,0)
This parameter was created to address issues found when printing
"KRN",8989.51,591,20,14,0)
the Blood Bank report in the horizontal format. The option of 
"KRN",8989.51,591,20,15,0)
displaying/printing Available units vertically has been created.
"KRN",8989.51,591,20,16,0)
 
"KRN",8989.51,591,20,17,0)
As more fields are added to this portion of the report with
"KRN",8989.51,591,20,18,0)
variable lengths, the length of the line may go beyond the 80
"KRN",8989.51,591,20,19,0)
character limit for printing. This is not as big of an issue in
"KRN",8989.51,591,20,20,0)
the Windows display. The Patient Information Screen cannot be 
"KRN",8989.51,591,20,21,0)
printed, so no attempt has been made to split the line when it
"KRN",8989.51,591,20,22,0)
goes beyond 79 characters. It functions the same when either
"KRN",8989.51,591,20,23,0)
HORIZONTAL or SPLIT HORIZONTAL is selected.
"KRN",8989.51,591,20,24,0)
 
"KRN",8989.51,591,20,25,0)
For both HORIZONTAL display formats the length of the line 
"KRN",8989.51,591,20,26,0)
expands or contracts depending on the column width of each field
"KRN",8989.51,591,20,27,0)
and the length of the longest line. Because of this it is
"KRN",8989.51,591,20,28,0)
possible, though not likely, that the line will not split even
"KRN",8989.51,591,20,29,0)
if SPLIT HORIZONTAL is selected.
"KRN",8989.51,591,30,0)
^8989.513I^3^3
"KRN",8989.51,591,30,1,0)
10^9.4
"KRN",8989.51,591,30,2,0)
5^4.2
"KRN",8989.51,591,30,3,0)
3^4
"KRN",8989.51,592,-1)
0^4
"KRN",8989.51,592,0)
OR VBECS LOC ABBREV BB REPORT^Abbreviate Location on Blood Bank Report^^^Yes/No
"KRN",8989.51,592,1)
Y^Y:yes;N:no^Enter 'yes' to use location abbreviation on Blood Bank Report
"KRN",8989.51,592,20,0)
^8989.512^2^2^3110202^^^^
"KRN",8989.51,592,20,1,0)
Enter 'Yes' to display Location abbreviation instead of Location
"KRN",8989.51,592,20,2,0)
Name on Blood Bank Report.
"KRN",8989.51,592,30,0)
^8989.513I^4^3
"KRN",8989.51,592,30,2,0)
2^4
"KRN",8989.51,592,30,3,0)
3^4.2
"KRN",8989.51,592,30,4,0)
1^9.4
"MBREQ")
0
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3;;PAR1DEL^XPDIA3(%)
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",110,-1)
1^1
"PKG",110,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",110,20,0)
^9.402P^^
"PKG",110,22,0)
^9.49I^1^1
"PKG",110,22,1,0)
3.0^2971217
"PKG",110,22,1,"PAH",1,0)
332^3110519
"PKG",110,22,1,"PAH",1,1,0)
^^1^1^3110519
"PKG",110,22,1,"PAH",1,1,1,0)
Refer to the patch description on the patch message.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","ORCDVBEC")
0^5^B78567106^B70656296
"RTN","ORCDVBEC",1,0)
ORCDVBEC ;SLC/MKB-Utility functions for VBECS dialogs ;2/11/08  11:04
"RTN","ORCDVBEC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**212,309,332**;Dec 17, 1997;Build 44
"RTN","ORCDVBEC",3,0)
 ;
"RTN","ORCDVBEC",4,0)
 ; External References:
"RTN","ORCDVBEC",5,0)
 ;   OEAPI^VBECA3       #4766
"RTN","ORCDVBEC",6,0)
 ;   RR^LR7OR1          #2503
"RTN","ORCDVBEC",7,0)
 ;   GCOM^LR7OR3        #2428
"RTN","ORCDVBEC",8,0)
 ;   $$SITE^VASITE      #10112
"RTN","ORCDVBEC",9,0)
 ;   $$HL7TFM^XLFDT     #10103
"RTN","ORCDVBEC",10,0)
 ;   $$UP^XLFSTR        #10104
"RTN","ORCDVBEC",11,0)
 ;
"RTN","ORCDVBEC",12,0)
PTR(X) ; -- Returns pointer to #101.41 of prompt OR GTX X
"RTN","ORCDVBEC",13,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORCDVBEC",14,0)
 ;
"RTN","ORCDVBEC",15,0)
EN ; -- entry action
"RTN","ORCDVBEC",16,0)
 I '$L($T(OEAPI^VBECA3)) W $C(7),!!,"Blood Bank orders are not available yet!" H 2 S ORQUIT=1 Q
"RTN","ORCDVBEC",17,0)
 N DIV,ORSTN,C,N,X S DIV=+$P($G(^SC(+$G(ORL),0)),U,15)
"RTN","ORCDVBEC",18,0)
 S ORSTN=$P($$SITE^VASITE(DT,DIV),U,3)
"RTN","ORCDVBEC",19,0)
 I $G(ORTYPE)'="Z" D OEAPI^VBECA3(.ORVB,+ORVP,ORSTN),PTINFO^ORCDVBC1
"RTN","ORCDVBEC",20,0)
 I $G(OREVENT) S ORVB("SPECIMEN")="" ;assume no specimen if delayed
"RTN","ORCDVBEC",21,0)
 S C=0 F  S C=$O(ORVB(C)) Q:C<1  S N=0 F  S N=$O(ORVB(C,"MSBOS",N)) Q:N<1  S X=$G(ORVB(C,"MSBOS",N)),ORMSBOS(C,$P(X,U))=$P(X,U,2) ;sort
"RTN","ORCDVBEC",22,0)
 ;get initial state: ORCOMP/ORTEST = id^id^ ^id, ORTAS = 1 or 0:
"RTN","ORCDVBEC",23,0)
 S (ORCOMP,ORTEST,ORTAS)="" I $D(OREDIT)!$G(OREWRITE) D
"RTN","ORCDVBEC",24,0)
 . N P,I,X,X0 S P=$$PTR("ORDERABLE ITEM")
"RTN","ORCDVBEC",25,0)
 . S I=0 F  S I=$O(ORDIALOG(P,I)) Q:I<1  S X=+$G(ORDIALOG(P,I)) D
"RTN","ORCDVBEC",26,0)
 .. S X0=$G(^ORD(101.43,X,"VB")),X=+$P($G(^(0)),U,2)
"RTN","ORCDVBEC",27,0)
 .. I $P(X0,U) S ORCOMP=ORCOMP_$S($L(ORCOMP):U,1:"")_X Q
"RTN","ORCDVBEC",28,0)
 .. S ORTEST=ORTEST_$S($L(ORTEST):U,1:"")_X
"RTN","ORCDVBEC",29,0)
 Q
"RTN","ORCDVBEC",30,0)
 ;
"RTN","ORCDVBEC",31,0)
EX ; -- exit action
"RTN","ORCDVBEC",32,0)
 K ORITM,ORCOMP,ORTEST,ORTAS,ORMSBOS,ORTIME,ORIMTIME,ORDIV,ORCOLLCT,ORVB,ORASK,ORSURG
"RTN","ORCDVBEC",33,0)
 I $G(ORXL) S ORL=ORXL K ORXL
"RTN","ORCDVBEC",34,0)
 Q
"RTN","ORCDVBEC",35,0)
 ;
"RTN","ORCDVBEC",36,0)
XHELP ; -- display OI's in groups
"RTN","ORCDVBEC",37,0)
 N INDEX,CNT,SCREEN,X,Y,SYN,Y0,D,Z,DONE
"RTN","ORCDVBEC",38,0)
 S CNT=1,SCREEN=$G(ORDIALOG(PROMPT,"S"))
"RTN","ORCDVBEC",39,0)
 F INDEX="S.VBC","S.VBT" D  Q:$G(DONE)
"RTN","ORCDVBEC",40,0)
 . W !!,$S(INDEX["C":"Choose from Blood Components:",1:"or Diagnostic Tests:")
"RTN","ORCDVBEC",41,0)
 . S X="" F  S X=$O(^ORD(101.43,INDEX,X)) Q:X=""  S Y=0 D  Q:$G(DONE)
"RTN","ORCDVBEC",42,0)
 .. F  S Y=$O(^ORD(101.43,INDEX,X,Y)) Q:Y'>0  S SYN=$G(^(Y)) I 'SYN D  Q:$G(DONE)
"RTN","ORCDVBEC",43,0)
 ... S Y0=$G(^ORD(101.43,Y,0)),D=INDEX X:$L(SCREEN) SCREEN Q:'$T
"RTN","ORCDVBEC",44,0)
 ... W !,"   "_X ;W:SYN "     "_$P(SYN,U,4) ; echo .01 if synonym
"RTN","ORCDVBEC",45,0)
 ... S CNT=CNT+1 Q:CNT'>(IOSL-5)  S CNT=0
"RTN","ORCDVBEC",46,0)
 ... W !,"   '^' TO STOP: " R Z:DTIME S:'$T!(Z["^") DONE=1
"RTN","ORCDVBEC",47,0)
 W !
"RTN","ORCDVBEC",48,0)
 Q
"RTN","ORCDVBEC",49,0)
 ;
"RTN","ORCDVBEC",50,0)
PSAOI ; -- set ORASK flags or show GenWrdInstructions for OI instance
"RTN","ORCDVBEC",51,0)
 I $$DUP^ORCD(PROMPT,ORI) K DONE W $C(7),!,"This component or test has already been selected!",! Q
"RTN","ORCDVBEC",52,0)
 N X0,NAME,ORT,ORWRD,WRD,I
"RTN","ORCDVBEC",53,0)
 S ORASK=+$G(^ORD(101.43,+$G(Y),"VB")),X0=$G(^(0)) ;VBEC OI
"RTN","ORCDVBEC",54,0)
 Q:ORASK  Q:$G(ORESET)=+$G(Y)  ;get ward instr for new tests
"RTN","ORCDVBEC",55,0)
 S NAME=$P(X0,U,8),ORT=+$$TEST^ORCSEND2(NAME) ;corresponding Lab OI
"RTN","ORCDVBEC",56,0)
 S ORT=+$P($G(^ORD(101.43,ORT,0)),U,2) ;#60 ien
"RTN","ORCDVBEC",57,0)
 D GCOM^LR7OR3(ORT,.ORWRD) S WRD="GenWardInstructions"
"RTN","ORCDVBEC",58,0)
 I $O(ORWRD(WRD,0)) W !! S I=0 F  S I=$O(ORWRD(WRD,I)) Q:I'>0  W ORWRD(WRD,I,0),!
"RTN","ORCDVBEC",59,0)
 Q
"RTN","ORCDVBEC",60,0)
 ;
"RTN","ORCDVBEC",61,0)
MOD ; -- get allowable modifier values
"RTN","ORCDVBEC",62,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  N ORX,I,X
"RTN","ORCDVBEC",63,0)
 D GETLST^XPAR(.ORX,"ALL","OR VBECS MODIFIERS","Q")
"RTN","ORCDVBEC",64,0)
 S I=0 F  S I=$O(ORX(I)) Q:I<1  D
"RTN","ORCDVBEC",65,0)
 . S X=$P($G(ORX(I)),U,2) Q:'$L(X)
"RTN","ORCDVBEC",66,0)
 . S ORDIALOG(PROMPT,"LIST",I)=X_U_X
"RTN","ORCDVBEC",67,0)
 . S ORDIALOG(PROMPT,"LIST","B",$$UP^XLFSTR(X))=X
"RTN","ORCDVBEC",68,0)
 S:ORX ORDIALOG(PROMPT,"LIST")=ORX_"^1"
"RTN","ORCDVBEC",69,0)
 Q
"RTN","ORCDVBEC",70,0)
 ;
"RTN","ORCDVBEC",71,0)
PSAMT ; -- Post-Selection Action for Amount, to validate and format
"RTN","ORCDVBEC",72,0)
 ;   only allow numeric entry for now, until GUI can accept volume
"RTN","ORCDVBEC",73,0)
 N X,X1,X2
"RTN","ORCDVBEC",74,0)
 I +Y'=Y W !,$C(7),"Enter the number of units needed, from 1-99." K DONE Q
"RTN","ORCDVBEC",75,0)
 S X=$$UP^XLFSTR(Y),X1=+X ;,X2=$$STRIP($P(X,X1,2))
"RTN","ORCDVBEC",76,0)
 ;I X2="ML" S ORDIALOG(PROMPT,ORI)=X1_"ml" Q
"RTN","ORCDVBEC",77,0)
 I (X1<1)!(X1>99) W !,$C(7),"Enter the number of units needed, from 1-99." K DONE Q  ;!("UNITS"'[X2)
"RTN","ORCDVBEC",78,0)
 S ORDIALOG(PROMPT,ORI)=X1 ;_" unit"_$S(X1>1:"s",1:"")
"RTN","ORCDVBEC",79,0)
 Q
"RTN","ORCDVBEC",80,0)
 ;
"RTN","ORCDVBEC",81,0)
SPCSTS ; -- set Specimen Status by component [Entry Action]
"RTN","ORCDVBEC",82,0)
 I '$G(ORASK) K ORDIALOG(PROMPT,INST) Q  ;not a component
"RTN","ORCDVBEC",83,0)
 N OI,X S OI=+$G(ORDIALOG($$PTR("ORDERABLE ITEM"),INST))
"RTN","ORCDVBEC",84,0)
 S X=+$P($G(^ORD(101.43,OI,0)),U,2)
"RTN","ORCDVBEC",85,0)
 S ORDIALOG(PROMPT,INST)=$G(ORVB(X,"SPECIMEN"))_U_$G(ORVB("SPECIMEN"))
"RTN","ORCDVBEC",86,0)
 Q
"RTN","ORCDVBEC",87,0)
 ;
"RTN","ORCDVBEC",88,0)
EXOI ; -- setup dialog parameters for selected items
"RTN","ORCDVBEC",89,0)
 N ORI,X,X0,TEST,COMP
"RTN","ORCDVBEC",90,0)
 S (ORTAS,TEST,COMP)="" K ORASK
"RTN","ORCDVBEC",91,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(PROMPT,ORI)) Q:ORI<1  D
"RTN","ORCDVBEC",92,0)
 . S X=+$G(ORDIALOG(PROMPT,ORI)),X0=$G(^ORD(101.43,X,"VB")),X=+$P($G(^(0)),U,2)
"RTN","ORCDVBEC",93,0)
 . I $P(X0,U) S COMP=COMP_$S($L(COMP):U,1:"")_X Q
"RTN","ORCDVBEC",94,0)
 . S TEST=TEST_$S($L(TEST):U,1:"")_X S:$P(X0,U,2)>1 ORTAS=1
"RTN","ORCDVBEC",95,0)
 I ORTEST'=TEST S ORTEST=TEST K ORTEST("Lab CollSamp")
"RTN","ORCDVBEC",96,0)
 I ORCOMP'=COMP S ORCOMP=COMP D CHANGED:'FIRST,COMP:COMP
"RTN","ORCDVBEC",97,0)
 I ORCOMP,U[$G(ORVB("ABORH")),'ORTAS,$G(ORTYPE)'="Z" D ADDTAS
"RTN","ORCDVBEC",98,0)
 Q
"RTN","ORCDVBEC",99,0)
 ;
"RTN","ORCDVBEC",100,0)
COMP ; -- Handle component-specific tasks [from EXOI]
"RTN","ORCDVBEC",101,0)
 ;    Uses ORCOMP, ORVB(comp)
"RTN","ORCDVBEC",102,0)
 Q:$G(ORTYPE)="Z"  ;QO editor
"RTN","ORCDVBEC",103,0)
 N ORP,ORI,ORT,ORTST,ORTMP,ORTDT,ORZ,ORHDR,OROOT,N
"RTN","ORCDVBEC",104,0)
 F ORI=1:1:$L(ORCOMP,U) S ORC=$P(ORCOMP,U,ORI) D
"RTN","ORCDVBEC",105,0)
 . S N=0 F  S N=$O(ORVB(ORC,"TEST",N)) Q:N<1  S ORT=+$G(ORVB(ORC,"TEST",N)),ORTST(ORT)=""
"RTN","ORCDVBEC",106,0)
 . I $G(ORVB(ORC,"SPECIMEN")),$P($G(ORVB("SPECIMEN")),U,2)="",'ORTAS D ADDTAS
"RTN","ORCDVBEC",107,0)
C1 S ORP=$$PTR("RESULTS"),(ORI,ORT)=0 F  S ORT=+$O(ORTST(ORT)) Q:ORT<1  D
"RTN","ORCDVBEC",108,0)
 . K ^TMP("LRRR",$J) D RR^LR7OR1(+ORVP,,,,,ORT,,1)
"RTN","ORCDVBEC",109,0)
 . ;S ORTMP="^TMP(""LRRR"",$J,+ORVP)",ORTMP=$Q(@ORTMP)
"RTN","ORCDVBEC",110,0)
 . ;Q:$P(ORTMP,",",1,3)'=("^TMP(""LRRR"","_$J_","_+ORVP)
"RTN","ORCDVBEC",111,0)
 . S ORTMP=$$FIRST(+ORVP,ORT) Q:'$L(ORTMP)
"RTN","ORCDVBEC",112,0)
 . S ORTDT=9999999-+$P(ORTMP,",",5),ORZ=@ORTMP
"RTN","ORCDVBEC",113,0)
 . S ORI=ORI+1,ORDIALOG(ORP,ORI)=$P(ORZ,U,1,6)_U_ORTDT
"RTN","ORCDVBEC",114,0)
 . W:'$G(ORHDR) !!,"RECENT LAB RESULTS:",!,"Test       Result    Units      Range     Collected       Accession     Sts"
"RTN","ORCDVBEC",115,0)
 . W:'$G(ORHDR) !,"----       ------    -----      -----     ---------       ---------     ---"
"RTN","ORCDVBEC",116,0)
 . W !,$$PAD^ORCHTAB($P(ORZ,U,15),8)_$J($P(ORZ,U,2),9)_" "_$$PAD^ORCHTAB($P(ORZ,U,3),3)_$$PAD^ORCHTAB($P(ORZ,U,4),11)_$$PAD^ORCHTAB($P(ORZ,U,5),10)_$$DATETIME^ORCHTAB(ORTDT)_"  "_$$PAD^ORCHTAB($P(ORZ,U,16),15)_$P(ORZ,U,6)
"RTN","ORCDVBEC",117,0)
 . S ORHDR=1,OROOT=$P(ORTMP,",",1,5)_",""N""" ;ck for comments
"RTN","ORCDVBEC",118,0)
 . F  S ORTMP=$Q(@ORTMP) Q:$P(ORTMP,",",1,6)'=OROOT  W !," "_@ORTMP
"RTN","ORCDVBEC",119,0)
 W:$G(ORHDR) ! K ^TMP("LRRR",$J)
"RTN","ORCDVBEC",120,0)
 W !!,"NOTE: The nursing blood administration order must be entered separately."
"RTN","ORCDVBEC",121,0)
 Q
"RTN","ORCDVBEC",122,0)
 ;
"RTN","ORCDVBEC",123,0)
FIRST(DFN,TEST) ; -- returns array reference to first data node 
"RTN","ORCDVBEC",124,0)
 ;    in ^TMP("LRRR",$J,DFN) for TEST
"RTN","ORCDVBEC",125,0)
 N Y,IDT,DA S Y=""
"RTN","ORCDVBEC",126,0)
 S IDT=0 F  S IDT=$O(^TMP("LRRR",$J,DFN,"CH",IDT)) Q:IDT<1  D  Q:Y
"RTN","ORCDVBEC",127,0)
 . S DA=0 F  S DA=$O(^TMP("LRRR",$J,DFN,"CH",IDT,DA)) Q:DA<1  I +$G(^(DA))=TEST S Y=1 Q
"RTN","ORCDVBEC",128,0)
 I Y S Y=$NA(^TMP("LRRR",$J,DFN,"CH",IDT,DA))
"RTN","ORCDVBEC",129,0)
 Q Y
"RTN","ORCDVBEC",130,0)
 ;
"RTN","ORCDVBEC",131,0)
ADDTAS ; -- adds T&S to order, sets ORTAS=1
"RTN","ORCDVBEC",132,0)
 ;    Expects PROMPT=OI, ORTEST
"RTN","ORCDVBEC",133,0)
 N ORI S ORI=$O(ORDIALOG(PROMPT,"?"),-1),ORI=ORI+1
"RTN","ORCDVBEC",134,0)
 S ORDIALOG(PROMPT,ORI)=+$O(^ORD(101.43,"ID","1;99VBC",0))
"RTN","ORCDVBEC",135,0)
 W !!,"Type & Screen added for new specimen."
"RTN","ORCDVBEC",136,0)
 S ORTAS=1,ORTEST=$G(ORTEST)_$S($L($G(ORTEST)):U,1:"")_"1"
"RTN","ORCDVBEC",137,0)
 Q
"RTN","ORCDVBEC",138,0)
 ;
"RTN","ORCDVBEC",139,0)
CHANGED ; -- Kill dependent values when Component changes
"RTN","ORCDVBEC",140,0)
 N PTR,I,J
"RTN","ORCDVBEC",141,0)
 F I="FREE TEXT","RESULTS" S PTR=$$PTR(I) I PTR D
"RTN","ORCDVBEC",142,0)
 . S J=0 F  S J=$O(ORDIALOG(PTR,J)) Q:J<1  K ORDIALOG(PTR,J)
"RTN","ORCDVBEC",143,0)
 . K ORDIALOG(PTR,"LIST")
"RTN","ORCDVBEC",144,0)
 Q
"RTN","ORCDVBEC",145,0)
 ;
"RTN","ORCDVBEC",146,0)
DTW ; -- Comp D/T Wanted to specimen exp d/t for TAS [DTW Exit Action]
"RTN","ORCDVBEC",147,0)
 Q:'$G(ORVB("SPECIMEN"))  Q:$G(ORTYPE)="Z"
"RTN","ORCDVBEC",148,0)
 N X,Y,%DT,EXP,OK
"RTN","ORCDVBEC",149,0)
 S X=$G(ORDIALOG(PROMPT,INST)),%DT="T" D ^%DT Q:Y<1
"RTN","ORCDVBEC",150,0)
 S EXP=$$HL7TFM^XLFDT(+$G(ORVB("SPECIMEN"))),OK=1
"RTN","ORCDVBEC",151,0)
 I EXP<Y D:'$G(ORTAS) ADDTAS S OK=0
"RTN","ORCDVBEC",152,0)
 D UID(OK) ;[re]set Specimen UID
"RTN","ORCDVBEC",153,0)
 Q
"RTN","ORCDVBEC",154,0)
 ;
"RTN","ORCDVBEC",155,0)
UID(OK) ; -- [re]set the Specimen UID if DTW changes
"RTN","ORCDVBEC",156,0)
 N SPCSTS,I,X
"RTN","ORCDVBEC",157,0)
 S SPCSTS=$$PTR("SPECIMEN STATUS")
"RTN","ORCDVBEC",158,0)
 S I=0 F  S I=$O(ORDIALOG(SPCSTS,I)) Q:I<1  D
"RTN","ORCDVBEC",159,0)
 . S X=$P(ORDIALOG(SPCSTS,I),U)_U_$S($G(OK):$G(ORVB("SPECIMEN")),1:"^")
"RTN","ORCDVBEC",160,0)
 . S ORDIALOG(SPCSTS,I)=X
"RTN","ORCDVBEC",161,0)
 Q
"RTN","ORCDVBEC",162,0)
 ;
"RTN","ORCDVBEC",163,0)
REASON ; -- get allowable reasons
"RTN","ORCDVBEC",164,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  N ORX,I,X
"RTN","ORCDVBEC",165,0)
 D GETLST^XPAR(.ORX,"ALL","OR VBECS REASON FOR REQUEST","Q")
"RTN","ORCDVBEC",166,0)
 S I=0 F  S I=$O(ORX(I)) Q:I<1  D
"RTN","ORCDVBEC",167,0)
 . S X=$P($G(ORX(I)),U,2) Q:'$L(X)
"RTN","ORCDVBEC",168,0)
 . S ORDIALOG(PROMPT,"LIST",I)=X_U_X
"RTN","ORCDVBEC",169,0)
 . S ORDIALOG(PROMPT,"LIST","B",$$UP^XLFSTR(X))=X
"RTN","ORCDVBEC",170,0)
 S:ORX ORDIALOG(PROMPT,"LIST")=ORX ;_"^1"
"RTN","ORCDVBEC",171,0)
 Q
"RTN","ORCDVBEC",172,0)
 ;
"RTN","ORCDVBEC",173,0)
ENTYPE ; -- set up Coll Type
"RTN","ORCDVBEC",174,0)
 I '$D(ORTEST("Lab CollSamp")) D
"RTN","ORCDVBEC",175,0)
 . N I,V,T,LC S LC=1
"RTN","ORCDVBEC",176,0)
 . F I=1:1:$L(ORTEST,U) S V=+$P(ORTEST,U,I) D  Q:'LC  ;no LC samp
"RTN","ORCDVBEC",177,0)
 .. S T=$$LAB60(V) ;VBECS ID -> #60 ien
"RTN","ORCDVBEC",178,0)
 .. I '$P($G(^LAB(60,T,0)),U,9) S LC=0 Q
"RTN","ORCDVBEC",179,0)
 . S ORTEST("Lab CollSamp")=LC
"RTN","ORCDVBEC",180,0)
 I '$D(ORTIME),'$D(ORIMTIME) D GETIMES^ORCDLR1
"RTN","ORCDVBEC",181,0)
 Q
"RTN","ORCDVBEC",182,0)
 ;
"RTN","ORCDVBEC",183,0)
LAB60(X) ; -- Return file 60 ien for VBECS OI ID
"RTN","ORCDVBEC",184,0)
 N Y,I,NM
"RTN","ORCDVBEC",185,0)
 S I=$O(^ORD(101.43,"ID",+X_";99VBC",0)),NM=$P($G(^ORD(101.43,+I,0)),U)_" - LAB"
"RTN","ORCDVBEC",186,0)
 S Y=+$O(^LAB(60,"B",NM,0))
"RTN","ORCDVBEC",187,0)
 Q Y
"RTN","ORCDVBEC",188,0)
 ;
"RTN","ORCDVBEC",189,0)
ENSURG ; -- Get list of surgeries from ORVB("SURGERY")
"RTN","ORCDVBEC",190,0)
 S:$P($G(^ORD(101.42,+$$VAL^ORCD("URGENCY"),0)),U,2)="P" REQD=1
"RTN","ORCDVBEC",191,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  K ORSURG
"RTN","ORCDVBEC",192,0)
 N I,CNT,X S (I,CNT)=0
"RTN","ORCDVBEC",193,0)
 F  S I=$O(ORVB("SURGERY",I)) Q:I'>0  S X=$G(ORVB("SURGERY",I)) D
"RTN","ORCDVBEC",194,0)
 . S ORSURG($P(X,U))=$P(X,U,2),X=$P(X,U) ;ORSURG(name)=NoBloodReqd
"RTN","ORCDVBEC",195,0)
 . S CNT=CNT+1,ORDIALOG(PROMPT,"LIST",CNT)=X_U_X
"RTN","ORCDVBEC",196,0)
 . S ORDIALOG(PROMPT,"LIST","B",$$UP^XLFSTR(X))=X
"RTN","ORCDVBEC",197,0)
 S:CNT ORDIALOG(PROMPT,"LIST")=CNT_"^1"
"RTN","ORCDVBEC",198,0)
 Q
"RTN","ORCDVBEC",199,0)
 ;
"RTN","ORCDVBEC",200,0)
CKMSBOS ; -- check if MSBOS limit exists, was exceeded [from PSA]
"RTN","ORCDVBEC",201,0)
 Q:'$L($G(Y))  N OI,AMT,I,X,COMP,LIMIT
"RTN","ORCDVBEC",202,0)
 I ORCOMP,$G(ORSURG($P(Y,U))) W !,"  >> No blood is required for this procedure!",! Q
"RTN","ORCDVBEC",203,0)
 S OI=$$PTR("ORDERABLE ITEM"),AMT=$$PTR("AMOUNT")
"RTN","ORCDVBEC",204,0)
 S I=0 F  S I=$O(ORDIALOG(OI,I)) Q:I<1  D
"RTN","ORCDVBEC",205,0)
 . S X=ORDIALOG(OI,I),COMP=+$P($G(^ORD(101.43,+X,0)),U,2)
"RTN","ORCDVBEC",206,0)
 . S LIMIT=$G(ORMSBOS(COMP,$P(Y,U))) Q:LIMIT=""
"RTN","ORCDVBEC",207,0)
 . Q:$G(ORDIALOG(AMT,I))'>LIMIT
"RTN","ORCDVBEC",208,0)
 . W !,"  >> Requested #units of "_$P($G(^ORD(101.43,+X,0)),U)_" exceeds MSBOS limit of "_LIMIT_"!",!
"RTN","ORCDVBEC",209,0)
 Q
"RTN","ORCDVBEC",210,0)
 ;
"RTN","ORCDVBEC",211,0)
ENURG ; -- Get list of urgencies from #101.42, parameter
"RTN","ORCDVBEC",212,0)
 Q:$G(ORDIALOG(PROMPT,"LIST"))  N I,CNT,X S CNT=0
"RTN","ORCDVBEC",213,0)
 S X="" F  S X=$O(^ORD(101.42,"S.VBEC",X)) Q:X=""  D
"RTN","ORCDVBEC",214,0)
 . ;I X="STAT" Q:'$$GET^XPAR("ALL","OR VBECS STAT USER")
"RTN","ORCDVBEC",215,0)
 . ;I X="STAT",'$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q
"RTN","ORCDVBEC",216,0)
 . S I=0 F  S I=$O(^ORD(101.42,"S.VBEC",X,I)) Q:I<1  D
"RTN","ORCDVBEC",217,0)
 .. S CNT=CNT+1,ORDIALOG(PROMPT,"LIST",CNT)=I_U_X
"RTN","ORCDVBEC",218,0)
 .. S ORDIALOG(PROMPT,"LIST","B",$$UP^XLFSTR(X))=I
"RTN","ORCDVBEC",219,0)
 S:CNT ORDIALOG(PROMPT,"LIST")=CNT_"^1"
"RTN","ORCDVBEC",220,0)
 Q
"RTN","ORCDVBEC",221,0)
 ;
"RTN","ORCDVBEC",222,0)
ASKURG() ; -- ask unless PreOp, set default
"RTN","ORCDVBEC",223,0)
 N Y S Y=1
"RTN","ORCDVBEC",224,0)
 I FIRST,'$D(ORDIALOG(PROMPT,INST)),$G(ORTYPE)'="Z" D
"RTN","ORCDVBEC",225,0)
 . I $$PREOP S ORDIALOG(PROMPT,INST)=+$O(^ORD(101.42,"C","P",0)),Y=0 Q
"RTN","ORCDVBEC",226,0)
 . S ORDIALOG(PROMPT,INST)=9 ;default
"RTN","ORCDVBEC",227,0)
 Q Y
"RTN","ORCDVBEC",228,0)
 ;
"RTN","ORCDVBEC",229,0)
PREOP() ; -- Returns 1 or 0, if order is for pre-op
"RTN","ORCDVBEC",230,0)
 N DIR,X,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","ORCDVBEC",231,0)
 S DIR(0)="YAO",DIR("A")="Is this order for pre-op? "
"RTN","ORCDVBEC",232,0)
 S DIR("?")="If YES, the urgency will be set to PRE-OP and a surgery name will be required"
"RTN","ORCDVBEC",233,0)
 S DIR("B")="NO" D ^DIR S:$D(DTOUT)!($D(DUOUT)) ORQUIT=1
"RTN","ORCDVBEC",234,0)
 Q +Y
"RTN","ORCSEND2")
0^6^B33762828^B33504777
"RTN","ORCSEND2",1,0)
ORCSEND2 ;SLC/MKB - Release cont ;2/11/08  11:04
"RTN","ORCSEND2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**212,332**;Dec 17, 1997;Build 44
"RTN","ORCSEND2",3,0)
 ;
"RTN","ORCSEND2",4,0)
PTR(NAME) ; -- Returns ptr value of prompt in Dialog file
"RTN","ORCSEND2",5,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_NAME,0))
"RTN","ORCSEND2",6,0)
 ;
"RTN","ORCSEND2",7,0)
EN ; -- Spawn child orders from ORIFN, send to VBECS [from VBEC^ORCSEND1]
"RTN","ORCSEND2",8,0)
 N ORPARENT,OR0,ORDIALOG,ORNP,ORDUZ,ORLOG,ORCAT,ORTS,ORDG,ORPKG,ORPRINT
"RTN","ORCSEND2",9,0)
 N ORESP,ORTIME,ORSTRT,ORI,ORIT,ORITX,ORFLDS,ORP,P,ORCHLD,ORLAST,X,STS,ORLAB,ORLRIFN
"RTN","ORCSEND2",10,0)
 N ORPITEM,ORPRBCM,ORPUNIT,ORPDTW,ORPREAS,ORPMSBS,ORPINFC,ORPURG,ORPTYPE,ORPCOLL,ORPCOMM,ORPRSLT,ORPSPEC,ORPLAB
"RTN","ORCSEND2",11,0)
 S ORPARENT=+ORIFN,OR0=$G(^OR(100,ORIFN,0))
"RTN","ORCSEND2",12,0)
 S ORDIALOG=+$P(OR0,U,5),ORNP=+$P(OR0,U,4),ORDUZ=+$P(OR0,U,6)
"RTN","ORCSEND2",13,0)
 S ORLOG=$P(OR0,U,7),ORCAT=$P(OR0,U,12),ORTS=$P(OR0,U,13)
"RTN","ORCSEND2",14,0)
 S ORDG=+$P(OR0,U,11),ORPKG=$P(OR0,U,14),ORPRINT=0
"RTN","ORCSEND2",15,0)
 D GETDLG1^ORCD(ORDIALOG),GETORDER^ORCD(ORIFN,"ORESP"),GETIMES^ORCDLR1
"RTN","ORCSEND2",16,0)
 M ^TMP($J,"ORVBDLG")=ORDIALOG S ORPITEM=$$PTR("ORDERABLE ITEM")
"RTN","ORCSEND2",17,0)
 S ORPRBCM=$$PTR("RBC MODIFIERS"),ORPUNIT=$$PTR("AMOUNT")
"RTN","ORCSEND2",18,0)
 S ORPDTW=$$PTR("DATE/TIME"),ORPREAS=$$PTR("REASON")
"RTN","ORCSEND2",19,0)
 S ORPMSBS=$$PTR("TEXT"),ORPINFC=$$PTR("YES/NO")
"RTN","ORCSEND2",20,0)
 S ORPTYPE=$$PTR("COLLECTION TYPE"),ORPCOLL=$$PTR("START DATE/TIME")
"RTN","ORCSEND2",21,0)
 S ORPURG=$$PTR("URGENCY"),ORPCOMM=$$PTR("FREE TEXT 1")
"RTN","ORCSEND2",22,0)
 S ORPSPEC=$$PTR("SPECIMEN STATUS"),ORPRSLT=$$PTR("RESULTS")
"RTN","ORCSEND2",23,0)
 S ORPLAB=$$PTR("LAB ORDER") D START ;resolve ORSTRT dates
"RTN","ORCSEND2",24,0)
EN1 S ORI=0 F  S ORI=$O(ORESP(ORPITEM,ORI)) Q:ORI<1  D  Q:$G(ORERR)
"RTN","ORCSEND2",25,0)
 . N ORL S ORL=$P(OR0,U,10) ;protect ORL from calling routine
"RTN","ORCSEND2",26,0)
 . S ORIT=+$G(ORESP(ORPITEM,ORI)),ORITX=$G(^ORD(101.43,ORIT,"VB"))
"RTN","ORCSEND2",27,0)
 . D LABTST I $G(ORERR) D CANCEL(ORPARENT,$P(ORERR,U,2)) Q
"RTN","ORCSEND2",28,0)
 . K ORDIALOG M ORDIALOG=^TMP($J,"ORVBDLG") S ORDIALOG(ORPITEM,1)=ORIT
"RTN","ORCSEND2",29,0)
 . S ORFLDS=$S(ORITX:"ORPRBCM^ORPUNIT^ORPSPEC^ORPMSBS^ORPINFC",$P(ORITX,U,2)=1:"ORPTYPE^ORPCOLL",$P(ORITX,U,2)=2:"ORPMSBS^ORPINFC^ORPTYPE^ORPCOLL",1:"")_"^ORPDTW^ORPREAS^ORPURG^ORPCOMM"
"RTN","ORCSEND2",30,0)
 . F ORP=1:1:$L(ORFLDS,U) S P=$P(ORFLDS,U,ORP) Q:'$L(P)  S ORDIALOG(@P,1)=$S($D(ORESP(@P,ORI)):ORESP(@P,ORI),1:$G(ORESP(@P,1))) ;set values
"RTN","ORCSEND2",31,0)
 . S:$G(ORLRIFN) ORDIALOG(ORPLAB,1)=ORLRIFN
"RTN","ORCSEND2",32,0)
 . K ORIFN,ORIT D EN^ORCSAVE
"RTN","ORCSEND2",33,0)
 . I '$G(ORIFN) S ORERR="1^Unable to create order" Q
"RTN","ORCSEND2",34,0)
 . S X=ORSTRT($S(ORITX:"DTW",1:"COLL")) D DATES^ORCSAVE2(ORIFN,X)
"RTN","ORCSEND2",35,0)
 . D RELEASE^ORCSAVE2(ORIFN,1,ORNOW,DUZ,$G(NATURE)),LINK
"RTN","ORCSEND2",36,0)
 . D NW^ORMBLDVB(ORIFN)
"RTN","ORCSEND2",37,0)
 S:$G(ORCHLD) ^OR(100,ORPARENT,2,0)="^100.002PA^"_ORLAST_U_ORCHLD
"RTN","ORCSEND2",38,0)
 D RELEASE^ORCSAVE2(ORPARENT,1,ORNOW,DUZ,$G(NATURE))
"RTN","ORCSEND2",39,0)
 ;D STATUS^ORCSAVE2(ORPARENT,5) ;testing
"RTN","ORCSEND2",40,0)
 S ORIFN=ORPARENT,ORQUIT=1,STS=$P(^OR(100,ORIFN,3),U,3)
"RTN","ORCSEND2",41,0)
EN2 I STS'=11,STS'=13 D  ;successful
"RTN","ORCSEND2",42,0)
 . D RESULTS^ORMBLDVB(ORPARENT)
"RTN","ORCSEND2",43,0)
 . Q:'$O(ORPRINT(0))  N PAT,LOC,NATR
"RTN","ORCSEND2",44,0)
 . S PAT=$P(OR0,U,2),LOC=$S($G(ORL):ORL,1:$P(OR0,U,10))
"RTN","ORCSEND2",45,0)
 . S NATR=$$WORK^ORCSIGN($G(NATURE))
"RTN","ORCSEND2",46,0)
 . D PRINT^ORPR02(PAT,.ORPRINT,,LOC,"0^1^1^1^"_NATR) ;labels/req's
"RTN","ORCSEND2",47,0)
 I $$UNRL(ORPARENT) S ORERR="1^Unable to release order due to an HL7 network error: queued for delivery to VBECS"
"RTN","ORCSEND2",48,0)
 I STS=13 S ORERR="1^This order was rejected by VBECS and will NOT be acted upon: see the Order Details for more information and contact the Blood Bank for assistance!"
"RTN","ORCSEND2",49,0)
 K ^TMP($J,"ORVBDLG"),^TMP($J,"ORLRDLG")
"RTN","ORCSEND2",50,0)
 Q
"RTN","ORCSEND2",51,0)
 ;
"RTN","ORCSEND2",52,0)
UNRL(DAD) ; -- ck for any unreleased child orders
"RTN","ORCSEND2",53,0)
 N Y,I,STS S Y=0
"RTN","ORCSEND2",54,0)
 S I=0 F  S I=+$O(^OR(100,+$G(DAD),2,I)) Q:I<1  D  Q:Y
"RTN","ORCSEND2",55,0)
 . S STS=$P($G(^OR(100,I,3)),U,3)
"RTN","ORCSEND2",56,0)
 . I STS=10!(STS=11) S Y=1 Q
"RTN","ORCSEND2",57,0)
 Q Y
"RTN","ORCSEND2",58,0)
 ;
"RTN","ORCSEND2",59,0)
START ; -- Define ORSTRT(), set Start Date in ORPARENT
"RTN","ORCSEND2",60,0)
 N X,Y,%DT,STRT S ORSTRT("COLL")="",ORSTRT("DTW")="",%DT="TX",STRT=""
"RTN","ORCSEND2",61,0)
 S X=$G(ORESP(ORPDTW,1)) I $L(X) D ^%DT S:Y>0 ORSTRT("DTW")=Y,STRT=Y
"RTN","ORCSEND2",62,0)
 S X=$G(ORESP(ORPCOLL,1)) I $L(X) D
"RTN","ORCSEND2",63,0)
 . D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT" ;return X
"RTN","ORCSEND2",64,0)
 . D ^%DT S:Y>0 ORSTRT("COLL")=Y,STRT=Y
"RTN","ORCSEND2",65,0)
 I '$P(OR0,U,8) D DATES^ORCSAVE2(+ORIFN,STRT)
"RTN","ORCSEND2",66,0)
 Q
"RTN","ORCSEND2",67,0)
 ;
"RTN","ORCSEND2",68,0)
LINK ; -- set up ORPARENT/ORIFN links, ORLAST in ORCHLD()
"RTN","ORCSEND2",69,0)
 ;    Uses ORVP,ORLOG in xref
"RTN","ORCSEND2",70,0)
 S ORCHLD=+$G(ORCHLD)+1,^OR(100,ORPARENT,2,ORIFN,0)=ORIFN,ORLAST=ORIFN
"RTN","ORCSEND2",71,0)
 S $P(^OR(100,ORIFN,3),U,8,9)="1^"_ORPARENT
"RTN","ORCSEND2",72,0)
 S $P(^OR(100,ORIFN,8,1,0),U,4)=8 K ^OR(100,"AS",ORVP,9999999-ORLOG,ORIFN,1) ;signature on parent only
"RTN","ORCSEND2",73,0)
 Q
"RTN","ORCSEND2",74,0)
 ;
"RTN","ORCSEND2",75,0)
LABTST ; -- Create Lab order for VBECS blood component or test
"RTN","ORCSEND2",76,0)
 ;    Expects var's from above, Returns ORLAB & ORLRIFN
"RTN","ORCSEND2",77,0)
 N ORDIALOG,ORDG,ORPKG,ORIFN,X,P,LRT K ORLAB,ORLRIFN
"RTN","ORCSEND2",78,0)
 I $G(^TMP($J,"ORLRDLG")) M ORDIALOG=^TMP($J,"ORLRDLG")
"RTN","ORCSEND2",79,0)
 E  D  ;build for now, later reuse
"RTN","ORCSEND2",80,0)
 . S ORDIALOG=+$O(^ORD(101.41,"AB","LR OTHER LAB TESTS",0))
"RTN","ORCSEND2",81,0)
 . D GETDLG1^ORCD(ORDIALOG) M ^TMP($J,"ORLRDLG")=ORDIALOG
"RTN","ORCSEND2",82,0)
 S ORDG=+$O(^ORD(100.98,"B","BB",0)),X=$P($G(^ORD(101.43,ORIT,0)),U,8)
"RTN","ORCSEND2",83,0)
 S X=+$$TEST(X) I X<1 S ORERR="1^Missing or invalid Lab workload test" Q
"RTN","ORCSEND2",84,0)
 S ORDIALOG(ORPITEM,1)=X,LRT=+$P($G(^ORD(101.43,X,0)),U,2)
"RTN","ORCSEND2",85,0)
 S ORDIALOG(ORPTYPE,1)=$S($D(ORESP(ORPTYPE,1)):ORESP(ORPTYPE,1),1:"SP")
"RTN","ORCSEND2",86,0)
 S ORDIALOG(ORPCOLL,1)=$S($D(ORESP(ORPCOLL,1)):ORESP(ORPCOLL,1),1:$G(ORESP(ORPDTW,1)))
"RTN","ORCSEND2",87,0)
LT1 ; VALIDATE??
"RTN","ORCSEND2",88,0)
 S X=+$O(^LAB(60,LRT,3,0)),X=+$G(^(X,0)) ;default/unique sample
"RTN","ORCSEND2",89,0)
 S ORDIALOG($$PTR("COLLECTION SAMPLE"),1)=X
"RTN","ORCSEND2",90,0)
 S:'ORITX ORDIALOG($$PTR("SPECIMEN"),1)=$P($G(^LAB(62,X,0)),U,2)
"RTN","ORCSEND2",91,0)
 S X=+$G(ORESP(ORPURG,1)),X=$P($G(^ORD(101.42,X,0)),U)
"RTN","ORCSEND2",92,0)
 S X=$S($L(X):+$O(^LAB(62.05,"B",X,0)),1:9) S:'X X=9
"RTN","ORCSEND2",93,0)
 S ORDIALOG($$PTR("LAB URGENCY"),1)=X D
"RTN","ORCSEND2",94,0)
 . N ORIT D EN^ORCSAVE ;Isolate ORIT before creating child orders
"RTN","ORCSEND2",95,0)
 I '$G(ORIFN) S ORERR="1^Unable to create lab order" Q
"RTN","ORCSEND2",96,0)
 S X=$S($D(ORSTRT("COLL")):ORSTRT("COLL"),1:$G(ORSTRT("DTW")))
"RTN","ORCSEND2",97,0)
 D DATES^ORCSAVE2(ORIFN,X),LINK
"RTN","ORCSEND2",98,0)
 D RELEASE^ORCSAVE2(ORIFN,1,ORNOW,DUZ,$G(NATURE)),NEW^ORMBLD(ORIFN)
"RTN","ORCSEND2",99,0)
 S ORLAB=$G(^OR(100,ORIFN,4))_";"_$G(LRT),ORLRIFN=ORIFN ;for VBECS msg
"RTN","ORCSEND2",100,0)
 I '$G(ORLAB) S ORERR="1^"_$$WHY^ORCSEND(ORIFN,1) Q
"RTN","ORCSEND2",101,0)
 S ORPRINT=+$G(ORPRINT)+1,ORPRINT(ORPRINT)=ORIFN_";1"
"RTN","ORCSEND2",102,0)
 ;D STATUS^ORCSAVE2(ORIFN,5) S ORLAB="ORLAB" ;for testing
"RTN","ORCSEND2",103,0)
 ;N ORZTEST S ORZTEST=1 D NEW^ORMBLD(ORIFN) ZW ORZTEST
"RTN","ORCSEND2",104,0)
 Q
"RTN","ORCSEND2",105,0)
 ;
"RTN","ORCSEND2",106,0)
TEST(X) ; -- find corresponding Lab test for VBECS item X, in #101.43
"RTN","ORCSEND2",107,0)
 N NM,I,Y S NM=X_" - LAB",Y=0
"RTN","ORCSEND2",108,0)
 S I=0 F  S I=+$O(^ORD(101.43,"B",$E(NM,1,30),I)) Q:I<1  I $P($G(^ORD(101.43,I,0)),U,8)=NM S Y=I Q
"RTN","ORCSEND2",109,0)
 Q Y
"RTN","ORCSEND2",110,0)
 ;
"RTN","ORCSEND2",111,0)
CANCEL(ORDAD,OREASON) ; -- Cancel parent order
"RTN","ORCSEND2",112,0)
 Q:'$G(ORDAD)  N NATR,NOW,ORCHLD
"RTN","ORCSEND2",113,0)
 S ORCHLD=0 F  S ORCHLD=+$O(^OR(100,ORDAD,2,ORCHLD)) Q:ORCHLD<1  D
"RTN","ORCSEND2",114,0)
 . Q:"^1^2^13^"[(U_$P($G(^OR(100,ORCHLD,3)),U,3)_U)  ;already done
"RTN","ORCSEND2",115,0)
 . D MSG^ORMBLD(ORCHLD,"CA",OREASON)
"RTN","ORCSEND2",116,0)
 S NATR=+$O(^ORD(100.02,"C","X",0)),NOW=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSEND2",117,0)
 S ^OR(100,ORDAD,6)=NATR_U_U_NOW_U_U_$G(OREASON),$P(^(8,1,0),U,15)=13 S:$L($G(OREASON)) ^(1)=OREASON
"RTN","ORCSEND2",118,0)
 D STATUS^ORCSAVE2(ORDAD,13) ;cancel
"RTN","ORCSEND2",119,0)
 Q
"RTN","ORMVBEC")
0^7^B25556094^B25262194
"RTN","ORMVBEC",1,0)
ORMVBEC ; SLC/MKB - Process VBECS order msgs ;2/11/08  11:05
"RTN","ORMVBEC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**212,309,332**;Dec 17, 1997;Build 44
"RTN","ORMVBEC",3,0)
 ;
"RTN","ORMVBEC",4,0)
EN ; -- entry point for VBEC messages from ORMHLREC
"RTN","ORMVBEC",5,0)
 ;M ^MKB(+ORIFN)=@ORMSG ;for testing
"RTN","ORMVBEC",6,0)
 I '$L($T(@ORDCNTRL)) Q  ;S ORERR="1^Invalid order control code" Q
"RTN","ORMVBEC",7,0)
 I '$G(ORIFN)!'$D(^OR(100,+$G(ORIFN),0)) S ORERR="1^Invalid order number" Q
"RTN","ORMVBEC",8,0)
 S:$G(ORLOG)<1 ORLOG=+$E($$NOW^XLFDT,1,12)
"RTN","ORMVBEC",9,0)
 D @ORDCNTRL
"RTN","ORMVBEC",10,0)
 Q
"RTN","ORMVBEC",11,0)
 ;
"RTN","ORMVBEC",12,0)
ACK(ORIFN) ; -- process DIRECT^HLMA acknowledgment [from ORMBLDVB]
"RTN","ORMVBEC",13,0)
 N ORMSG,I,J,MSH,MSA,ORC,ORTYPE,ORLOG,OREASON,ORNATR,ORDCNTRL,PKGIFN,X
"RTN","ORMVBEC",14,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D  ;get,parse message from HL7 package
"RTN","ORMVBEC",15,0)
 . S ORMSG(I)=HLNODE,J=0 ;Get segment node
"RTN","ORMVBEC",16,0)
 . ; Get continuation nodes for long segments, if any
"RTN","ORMVBEC",17,0)
 . F  S J=$O(HLNODE(J)) Q:'J  S ORMSG(I,J)=HLNODE(J)
"RTN","ORMVBEC",18,0)
 ;I '$O(ORMSG(0)) D EN^ORERR("Missing HL7 message",.ORMSG) Q
"RTN","ORMVBEC",19,0)
 S MSH=0 F  S MSH=$O(ORMSG(MSH)) Q:MSH'>0  Q:$E(ORMSG(MSH),1,3)="MSH"
"RTN","ORMVBEC",20,0)
 I 'MSH S ORERR="1^Missing or invalid MSH segment" D ERR Q
"RTN","ORMVBEC",21,0)
 S MSA=+$O(ORMSG(MSH)) I 'MSA!($E($G(ORMSG(MSA)),1,3)'="MSA") D  Q
"RTN","ORMVBEC",22,0)
 . S ORERR="1^Missing or invalid MSA segment" D ERR
"RTN","ORMVBEC",23,0)
 S ORTYPE=$P(ORMSG(MSH),"|",9),MSA=MSA_U_ORMSG(MSA)
"RTN","ORMVBEC",24,0)
 S ORLOG=+$E($$NOW^XLFDT,1,12),OREASON=U_$P(MSA,"|",4),ORNATR=""
"RTN","ORMVBEC",25,0)
 I $P(MSA,"|",2)'="AA",'$O(ORMSG(+MSA)) D  Q  ;unsuccessful, no order#
"RTN","ORMVBEC",26,0)
 . S ORERR="1^"_$P(OREASON,U,2) D UA,ERR
"RTN","ORMVBEC",27,0)
 S ORC=+MSA F  S ORC=$O(ORMSG(+ORC)) Q:ORC<1  I $E(ORMSG(ORC),1,3)="ORC" D
"RTN","ORMVBEC",28,0)
 . S X=ORMSG(ORC),ORDCNTRL=$P(X,"|",2),PKGIFN=+$P(X,"|",4)
"RTN","ORMVBEC",29,0)
 . I '$G(ORIFN) S ORIFN=+$P(X,"|",3) I ORDCNTRL["U" D  ;find action to cancel
"RTN","ORMVBEC",30,0)
 .. N DA,CODE S CODE=$S(ORDCNTRL="UC":"DC",1:"NW")
"RTN","ORMVBEC",31,0)
 .. S DA=$O(^OR(100,DA,8,"C",CODE,"?"),-1) S:DA<1 DA=1
"RTN","ORMVBEC",32,0)
 .. S ORIFN=ORIFN_";"_DA
"RTN","ORMVBEC",33,0)
 . D @ORDCNTRL
"RTN","ORMVBEC",34,0)
 Q
"RTN","ORMVBEC",35,0)
 ;
"RTN","ORMVBEC",36,0)
ERR ; -- Log an error
"RTN","ORMVBEC",37,0)
 N X S X=$P(ORERR,U,2)
"RTN","ORMVBEC",38,0)
 D EN^ORERR(X,.ORMSG)
"RTN","ORMVBEC",39,0)
 Q
"RTN","ORMVBEC",40,0)
 ;
"RTN","ORMVBEC",41,0)
STATUS(X) ; -- Returns Order Status for HL7 code X
"RTN","ORMVBEC",42,0)
 N Y S Y=$S(X="DC":1,X="OC":1,X="CM":2,X="IP":5,X="SC":6,X="ZE":7,X="CA":7,1:"") ;phase out ZE,OC
"RTN","ORMVBEC",43,0)
 Q Y
"RTN","ORMVBEC",44,0)
 ;
"RTN","ORMVBEC",45,0)
OK ; -- Order accepted, VBECS order # assigned [reply]
"RTN","ORMVBEC",46,0)
 S ^OR(100,+ORIFN,4)=PKGIFN ;VBECS identifier
"RTN","ORMVBEC",47,0)
 D STATUS^ORCSAVE2(+ORIFN,5) ;pending
"RTN","ORMVBEC",48,0)
 Q
"RTN","ORMVBEC",49,0)
 ;
"RTN","ORMVBEC",50,0)
SC ; -- Status changed
"RTN","ORMVBEC",51,0)
 N ORSTS S ORSTS=$$STATUS(ORDSTS)
"RTN","ORMVBEC",52,0)
 I ORSTS=1 D OC Q  ;Cancel
"RTN","ORMVBEC",53,0)
 D STATUS^ORCSAVE2(+ORIFN,ORSTS)
"RTN","ORMVBEC",54,0)
 D:ORSTS=6 DATES^ORCSAVE2(+ORIFN,ORLOG)                  ;Start Time
"RTN","ORMVBEC",55,0)
 D:ORSTS=7 DATES^ORCSAVE2(+ORIFN,,+$E($$NOW^XLFDT,1,12)) ;Stop Time
"RTN","ORMVBEC",56,0)
 Q
"RTN","ORMVBEC",57,0)
 ;
"RTN","ORMVBEC",58,0)
OC ; -- Cancelled
"RTN","ORMVBEC",59,0)
 G:ORTYPE["ORG" UA ;reject reply
"RTN","ORMVBEC",60,0)
 S:ORNATR="" ORNATR=+$O(^ORD(100.02,"C","X",0)) ;Rejected
"RTN","ORMVBEC",61,0)
 S ^OR(100,+ORIFN,6)=ORNATR_U_ORDUZ_U_ORLOG_U_U_$E($P(OREASON,U,2),1,80)
"RTN","ORMVBEC",62,0)
 D UPDATE(1,"DC"),LAB D  ;set parent's 6-node
"RTN","ORMVBEC",63,0)
 . N DAD S DAD=+$P($G(^OR(100,+ORIFN,3)),U,9)
"RTN","ORMVBEC",64,0)
 . I DAD,$P($G(^OR(100,DAD,3)),U,3)=1,'$D(^(6)) S ^OR(100,DAD,6)=^OR(100,+ORIFN,6)
"RTN","ORMVBEC",65,0)
 Q
"RTN","ORMVBEC",66,0)
 ;
"RTN","ORMVBEC",67,0)
CR ; -- Cancelled [reply]
"RTN","ORMVBEC",68,0)
 D STATUS^ORCSAVE2(+ORIFN,1)
"RTN","ORMVBEC",69,0)
 Q
"RTN","ORMVBEC",70,0)
 ;
"RTN","ORMVBEC",71,0)
UA ; -- Unable to accept [reply]
"RTN","ORMVBEC",72,0)
 S:'ORNATR ORNATR=$O(^ORD(100.02,"C","X",0)) ;rejected
"RTN","ORMVBEC",73,0)
 S ^OR(100,+ORIFN,6)=ORNATR_U_U_ORLOG_U_U_$E($P(OREASON,U,2),1,80)
"RTN","ORMVBEC",74,0)
 D STATUS^ORCSAVE2(+ORIFN,13),CANCEL ;cancel associated orders
"RTN","ORMVBEC",75,0)
UC ; -- Unable to cancel [reply]
"RTN","ORMVBEC",76,0)
DE ; -- Data Error [reply]
"RTN","ORMVBEC",77,0)
 N DA S DA=$P(ORIFN,";",2) Q:'DA
"RTN","ORMVBEC",78,0)
 S $P(^OR(100,+ORIFN,8,DA,0),U,15)=13 ;request rejected
"RTN","ORMVBEC",79,0)
 S:$L($P(OREASON,U,2)) ^OR(100,+ORIFN,8,DA,1)=$E($P(OREASON,U,2),1,240)
"RTN","ORMVBEC",80,0)
 Q
"RTN","ORMVBEC",81,0)
 ;
"RTN","ORMVBEC",82,0)
CANCEL ; -- cancel associated lab, parent orders
"RTN","ORMVBEC",83,0)
 N ORDAD
"RTN","ORMVBEC",84,0)
 S ORDAD=+$P($G(^OR(100,+ORIFN,3)),U,9) Q:'ORDAD
"RTN","ORMVBEC",85,0)
 D CANCEL^ORCSEND2(ORDAD,$P(OREASON,U,2)) ;cancel parent+children
"RTN","ORMVBEC",86,0)
 Q
"RTN","ORMVBEC",87,0)
 ;
"RTN","ORMVBEC",88,0)
UPDATE(ORSTS,ORACT) ; -- continue processing
"RTN","ORMVBEC",89,0)
 N DA,ORX,ORCMMT,ORP
"RTN","ORMVBEC",90,0)
 ;D DATES^ORCSAVE2(+ORIFN,ORSTRT,ORSTOP) ;DC stop set in $$STATUS
"RTN","ORMVBEC",91,0)
 D:$G(ORSTS) STATUS^ORCSAVE2(+ORIFN,ORSTS)
"RTN","ORMVBEC",92,0)
 S ORCMMT=$E($P(OREASON,U,2),1,240),ORX=$$CREATE^ORX1(ORNATR) D:ORX
"RTN","ORMVBEC",93,0)
 . S DA=$$ACTION^ORCSAVE(ORACT,+ORIFN,ORNP,ORCMMT,ORLOG,ORDUZ)
"RTN","ORMVBEC",94,0)
 . I DA'>0 S ORERR="1^Cannot create new order action" Q
"RTN","ORMVBEC",95,0)
 . D RELEASE^ORCSAVE2(+ORIFN,DA,ORLOG,ORDUZ,ORNATR)
"RTN","ORMVBEC",96,0)
 . D SIGSTS^ORCSAVE2(+ORIFN,DA)
"RTN","ORMVBEC",97,0)
 . I $G(ORL) S ORP(1)=+ORIFN_";"_DA_"^1" D PRINTS^ORWD1(.ORP,+ORL)
"RTN","ORMVBEC",98,0)
 . S $P(^OR(100,+ORIFN,3),U,7)=DA
"RTN","ORMVBEC",99,0)
 I '$$ACTV^ORX1(ORNATR) S $P(^OR(100,+ORIFN,3),U,7)=0
"RTN","ORMVBEC",100,0)
 D:ORACT="DC" CANCEL^ORCSEND(+ORIFN) ;cancel unreleased actions
"RTN","ORMVBEC",101,0)
 Q
"RTN","ORMVBEC",102,0)
 ;
"RTN","ORMVBEC",103,0)
ZP ; -- Purged
"RTN","ORMVBEC",104,0)
 Q:'ORIFN  Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORMVBEC",105,0)
 S $P(^OR(100,+ORIFN,4),";",1,3)=";;" I "^5^6^"[(U_$P($G(^(3)),U,3)_U) D STATUS^ORCSAVE2(+ORIFN,$S($P(^(4),";",5):2,1:14)) ; Remove pkg reference, sts=lapsed if still active
"RTN","ORMVBEC",106,0)
 Q
"RTN","ORMVBEC",107,0)
 ;
"RTN","ORMVBEC",108,0)
ZR ; -- Purged as requested [reply]
"RTN","ORMVBEC",109,0)
 D DELETE^ORCSAVE2(+ORIFN)
"RTN","ORMVBEC",110,0)
 Q
"RTN","ORMVBEC",111,0)
 ;
"RTN","ORMVBEC",112,0)
ZU ; -- Unable to purge [reply]
"RTN","ORMVBEC",113,0)
 S $P(^OR(100,+ORIFN,3),U)=$$NOW^XLFDT ; update Last Activity
"RTN","ORMVBEC",114,0)
 Q
"RTN","ORMVBEC",115,0)
 ;
"RTN","ORMVBEC",116,0)
LAB ; -- find and cancel ORIFN'S associated Lab order
"RTN","ORMVBEC",117,0)
 N ORLRIFN S ORLRIFN=$$VALUE^ORX8(ORIFN,"LAB")
"RTN","ORMVBEC",118,0)
 I 'ORLRIFN D  ;search children for match
"RTN","ORMVBEC",119,0)
 . N ORDAD,ORIT,ORLAB,ORI,ORX
"RTN","ORMVBEC",120,0)
 . S ORDAD=+$P($G(^OR(100,+ORIFN,3)),U,9) Q:'ORDAD
"RTN","ORMVBEC",121,0)
 . S ORIT=$$VALUE^ORX8(ORIFN,"ORDERABLE",1,"E") Q:'$L(ORIT)
"RTN","ORMVBEC",122,0)
 . S ORLAB=$$PKG^ORMPS1("LR"),(ORLRIFN,ORI)=0
"RTN","ORMVBEC",123,0)
 . F  S ORI=+$O(^OR(100,ORDAD,2,+ORI)) Q:'ORI  I ORI'=+ORIFN D  Q:ORLRIFN
"RTN","ORMVBEC",124,0)
 .. Q:$P($G(^OR(100,ORI,0)),U,14)'=ORLAB
"RTN","ORMVBEC",125,0)
 .. S ORX=$$VALUE^ORX8(ORI,"ORDERABLE",1,"E")
"RTN","ORMVBEC",126,0)
 .. I ORX[ORIT S ORLRIFN=ORI Q
"RTN","ORMVBEC",127,0)
 D:ORLRIFN MSG^ORMBLD(ORLRIFN,"CA")
"RTN","ORMVBEC",128,0)
 Q
"RTN","ORWDXVB")
0^9^B45633676^B44657724
"RTN","ORWDXVB",1,0)
ORWDXVB ;slc/dcm - Order dialog utilities for Blood Bank ;12/7/05  17:11
"RTN","ORWDXVB",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**215,243,212,309,332**;Dec 17 1997;Build 44
"RTN","ORWDXVB",3,0)
 ;
"RTN","ORWDXVB",4,0)
 ; DBIA 2503   RR^LR7OR1   ^TMP("LRRR",$J)
"RTN","ORWDXVB",5,0)
 ; 
"RTN","ORWDXVB",6,0)
GETPAT(ORX,DFN,ORL) ;Get Patient data from VBECS
"RTN","ORWDXVB",7,0)
 ;Needs patient DFN and Location (ORL)
"RTN","ORWDXVB",8,0)
 N ORSTN,DIV
"RTN","ORWDXVB",9,0)
 S DIV=+$P($G(^SC(+$G(ORL),0)),U,15),ORSTN=$P($$SITE^VASITE(DT,DIV),U,3)
"RTN","ORWDXVB",10,0)
 D OEAPI^VBECA3(.ORX,DFN,ORSTN)
"RTN","ORWDXVB",11,0)
 Q
"RTN","ORWDXVB",12,0)
PTINFO(OROOT,ORX) ;Format patient BB info
"RTN","ORWDXVB",13,0)
 Q:'$D(ORX)
"RTN","ORWDXVB",14,0)
 D PTINFO^ORWDXVB1
"RTN","ORWDXVB",15,0)
 Q
"RTN","ORWDXVB",16,0)
RESULTS(OROOT,DFN,ORX) ;Get test results
"RTN","ORWDXVB",17,0)
 Q:'$O(ORX(0))  ;ORX contains a list of tests to retrieve results for
"RTN","ORWDXVB",18,0)
 N ORCOM,ORT,ORTST,ORTDT,ORTMP,GCNT,CCNT,GIOSL,GIOM,I,ORZ
"RTN","ORWDXVB",19,0)
 S GCNT=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWDXVB",20,0)
 S OROOT=$NA(^TMP("ORVBEC",$J))
"RTN","ORWDXVB",21,0)
 K ^TMP("ORVBEC",$J)
"RTN","ORWDXVB",22,0)
 D LN
"RTN","ORWDXVB",23,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"RECENT LAB RESULTS:",.CCNT)
"RTN","ORWDXVB",24,0)
 D LN
"RTN","ORWDXVB",25,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Test    Result    Units      Range     Collected       Accession     Sts",.CCNT)
"RTN","ORWDXVB",26,0)
 D LN
"RTN","ORWDXVB",27,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"----    ------    -----      -----     ---------       ---------     ---",.CCNT)
"RTN","ORWDXVB",28,0)
 S ORT=0 F  S ORT=$O(ORX(ORT)) Q:'ORT  S ORTST=$P(ORX(ORT),"^",1) D
"RTN","ORWDXVB",29,0)
 . K ^TMP("LRRR",$J) D RR^LR7OR1(DFN,,,,,ORTST,,1)  ;DBIA 2503
"RTN","ORWDXVB",30,0)
 . S ORTMP=$$FIRST^ORCDVBEC(DFN,ORTST) Q:'$L(ORTMP)
"RTN","ORWDXVB",31,0)
 . S ORTDT=9999999-+$P(ORTMP,",",5),ORZ=@ORTMP
"RTN","ORWDXVB",32,0)
 . D LN
"RTN","ORWDXVB",33,0)
 . S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,$P(ORZ,"^",15),.CCNT)_$$S^ORU4(8,CCNT,$J($P(ORZ,"^",2),7),.CCNT)_$$S^ORU4(16,CCNT,$P(ORZ,"^",3),.CCNT)_$$S^ORU4(19,CCNT,$P(ORZ,"^",4),.CCNT)_$$S^ORU4(30,CCNT,$P(ORZ,"^",5),.CCNT)
"RTN","ORWDXVB",34,0)
 . S ^(0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(40,CCNT,$$DATETIME^ORCHTAB(ORTDT),.CCNT)_$$S^ORU4(56,CCNT,$P(ORZ,"^",16),.CCNT)_$$S^ORU4(71,CCNT,$P(ORZ,"^",6),.CCNT)
"RTN","ORWDXVB",35,0)
 . S ORCOM=$P(ORTMP,",",1,5)_",""N""" ;check for comments
"RTN","ORWDXVB",36,0)
 . F  S ORTMP=$Q(@ORTMP) Q:$P(ORTMP,",",1,6)'=ORCOM  D
"RTN","ORWDXVB",37,0)
 .. D LN
"RTN","ORWDXVB",38,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,@ORTMP,.CCNT)
"RTN","ORWDXVB",39,0)
 I GCNT<4 K ^TMP("ORVBEC",$J)
"RTN","ORWDXVB",40,0)
 K ^TMP("LRRR",$J)
"RTN","ORWDXVB",41,0)
 Q
"RTN","ORWDXVB",42,0)
RAW(OROOT,DFN,ORX) ;Get RAW test results
"RTN","ORWDXVB",43,0)
 Q:'$O(ORX(0))  ;ORX contains a list of tests to retrieve results for
"RTN","ORWDXVB",44,0)
 N ORCOM,ORT,ORTST,ORTDT,ORTMP,GCNT,CCNT,GIOSL,GIOM,I
"RTN","ORWDXVB",45,0)
 S GCNT=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWDXVB",46,0)
 S OROOT=$NA(^TMP("ORVBEC",$J))
"RTN","ORWDXVB",47,0)
 K ^TMP("ORVBEC",$J)
"RTN","ORWDXVB",48,0)
 S ORT=0 F  S ORT=$O(ORX(ORT)) Q:'ORT  S ORTST=$P(ORX(ORT),"^",1) D
"RTN","ORWDXVB",49,0)
 . K ^TMP("LRRR",$J) D RR^LR7OR1(DFN,,,,,ORTST,,1)
"RTN","ORWDXVB",50,0)
 . S ORTMP="^TMP(""LRRR"",$J,DFN)",ORTMP=$Q(@ORTMP)
"RTN","ORWDXVB",51,0)
 . Q:$P(ORTMP,",",1,3)'=("^TMP(""LRRR"","_$J_","_DFN)
"RTN","ORWDXVB",52,0)
 . S ORTDT=9999999-+$P(ORTMP,",",5),ORZ=@ORTMP
"RTN","ORWDXVB",53,0)
 . D LN
"RTN","ORWDXVB",54,0)
 . S ^TMP("ORVBEC",$J,GCNT,0)=$P(ORZ,"^",1,6)_"^"_ORTDT
"RTN","ORWDXVB",55,0)
 K ^TMP("LRRR",$J)
"RTN","ORWDXVB",56,0)
 Q
"RTN","ORWDXVB",57,0)
SURG(OROOT,ORX) ;Get list of surgeries
"RTN","ORWDXVB",58,0)
 N I,CNT,X
"RTN","ORWDXVB",59,0)
 S (I,CNT)=0
"RTN","ORWDXVB",60,0)
 F  S I=$O(ORX("SURGERY",I)) Q:'I  S X=$G(ORX("SURGERY",I)) D
"RTN","ORWDXVB",61,0)
 . S CNT=CNT+1,OROOT(CNT)=X_U_X
"RTN","ORWDXVB",62,0)
 Q
"RTN","ORWDXVB",63,0)
LN ;Increment counts
"RTN","ORWDXVB",64,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWDXVB",65,0)
 Q
"RTN","ORWDXVB",66,0)
PATINFO(OROOT,DFN,LOC) ;Test ^TMP global output
"RTN","ORWDXVB",67,0)
 N ORX
"RTN","ORWDXVB",68,0)
 D GETPAT(.ORX,DFN,LOC)
"RTN","ORWDXVB",69,0)
 I $L($G(ORX("SPECIMEN"))) S:$P(ORX("SPECIMEN"),"^") $P(ORX("SPECIMEN"),"^")=$$HL7TFM^XLFDT($P(ORX("SPECIMEN"),"^"))
"RTN","ORWDXVB",70,0)
 D PTINFO(.OROOT,.ORX)
"RTN","ORWDXVB",71,0)
 ;S I=0 F  S I=$O(@OROOT@(I)) Q:'I  W !,^(I,0)
"RTN","ORWDXVB",72,0)
 ;K @OROOT
"RTN","ORWDXVB",73,0)
 Q
"RTN","ORWDXVB",74,0)
GETALL(OROOT,DFN,LOC) ;Get all data in one call and let the GUI divide it up
"RTN","ORWDXVB",75,0)
 N ORX,INFO,CNT,I,J,K,OREAS,OREASON
"RTN","ORWDXVB",76,0)
 S OROOT=$NA(^TMP("ORVBECINFO",$J)),CNT=1
"RTN","ORWDXVB",77,0)
 D GETPAT(.ORX,DFN,LOC)
"RTN","ORWDXVB",78,0)
 ;S ^TMP("ORVBECINFO",$J,CNT)="~RAWDATA",I=0
"RTN","ORWDXVB",79,0)
 ;F  S I=$O(ORX(I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)=ORX(I)
"RTN","ORWDXVB",80,0)
 I $L($G(ORX("SPECIMEN"))) S:$P(ORX("SPECIMEN"),"^") $P(ORX("SPECIMEN"),"^")=$$HL7TFM^XLFDT($P(ORX("SPECIMEN"),"^")) S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~SPECIMEN",CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_ORX("SPECIMEN")
"RTN","ORWDXVB",81,0)
 I $L($G(ORX("ABORH"))) S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~ABORH",CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_ORX("ABORH")
"RTN","ORWDXVB",82,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~TYPE AND SCREEN",CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_$O(^ORD(101.43,"ID","1;99VBC",0))
"RTN","ORWDXVB",83,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~OTHER",CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_$O(^ORD(101.43,"ID","6;99VBC",0))
"RTN","ORWDXVB",84,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~SPECIMENS",I=0
"RTN","ORWDXVB",85,0)
 F  S I=$O(ORX(I)) Q:'I  S J="" F  S J=$O(ORX(I,J)) Q:J=""  I J="SPECIMEN" S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_I_"^"_ORX(I,J)
"RTN","ORWDXVB",86,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~TESTS",I=0
"RTN","ORWDXVB",87,0)
 F  S I=$O(ORX(I)) Q:'I  S J="" F  S J=$O(ORX(I,J)) Q:J=""  I J="TEST" S K=0 F  S K=$O(ORX(I,J,K)) Q:'K  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_I_"^"_K_"^"_ORX(I,J,K)
"RTN","ORWDXVB",88,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~MSBOS",I=0
"RTN","ORWDXVB",89,0)
 F  S I=$O(ORX(I)) Q:'I  S J="" F  S J=$O(ORX(I,J)) Q:J=""  I J="MSBOS" S K=0 F  S K=$O(ORX(I,J,K)) Q:'K  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_I_"^"_K_"^"_ORX(I,J,K),$P(^(CNT),"^",4)=+$P(ORX(I,J,K),"^",2)
"RTN","ORWDXVB",90,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~SURGERIES",I=0
"RTN","ORWDXVB",91,0)
 F  S I=$O(ORX("SURGERY",I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_I_"^"_ORX("SURGERY",I)
"RTN","ORWDXVB",92,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~URGENCIES",I=""
"RTN","ORWDXVB",93,0)
 F  S I=$O(^ORD(101.42,"S.VBEC",I)) Q:I=""  S J=0 F  S J=$O(^ORD(101.42,"S.VBEC",I,J)) Q:'J  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_J_"^"_I
"RTN","ORWDXVB",94,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~MODIFIERS",I=""
"RTN","ORWDXVB",95,0)
 N ORMODS D GETLST^XPAR(.ORMODS,"ALL","OR VBECS MODIFIERS","I")
"RTN","ORWDXVB",96,0)
 F  S I=$O(ORMODS(I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_ORMODS(I)
"RTN","ORWDXVB",97,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~REASONS",I=""
"RTN","ORWDXVB",98,0)
 N ORMODS D GETLST^XPAR(.ORMODS,"ALL","OR VBECS REASON FOR REQUEST","I")
"RTN","ORWDXVB",99,0)
 S OREASON=$$GET^XPAR("DIV^SYS^PKG","OR VBECS REASON SORT ALPHA",1,"Q")
"RTN","ORWDXVB",100,0)
 I OREASON D
"RTN","ORWDXVB",101,0)
 . F  S I=$O(ORMODS(I)) Q:'I  S OREAS(" "_$$UP^XLFSTR(ORMODS(I)))=ORMODS(I)
"RTN","ORWDXVB",102,0)
 . S I="" F  S I=$O(OREAS(I)) Q:I=""  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_OREAS(I)
"RTN","ORWDXVB",103,0)
 I 'OREASON D
"RTN","ORWDXVB",104,0)
 . F  S I=$O(ORMODS(I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_ORMODS(I)
"RTN","ORWDXVB",105,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~INFO"
"RTN","ORWDXVB",106,0)
 D PTINFO(.INFO,.ORX)
"RTN","ORWDXVB",107,0)
 S I=0 F  S I=$O(^TMP("ORVBEC",$J,I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_^TMP("ORVBEC",$J,I,0)
"RTN","ORWDXVB",108,0)
 S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="~TNS ORDERS"
"RTN","ORWDXVB",109,0)
 N ORMODS D PULL^ORWDXVB2(.ORMODS,DFN)
"RTN","ORWDXVB",110,0)
 S I=0 F  S I=$O(ORMODS(I)) Q:'I  S CNT=CNT+1,^TMP("ORVBECINFO",$J,CNT)="i"_ORMODS(I)
"RTN","ORWDXVB",111,0)
 K ^TMP("ORVBEC",$J)
"RTN","ORWDXVB",112,0)
 Q
"RTN","ORWDXVB",113,0)
STATALOW(OROOT,DFN) ;Allow stat for ORES ORELSE users
"RTN","ORWDXVB",114,0)
 S OROOT=$D(^XUSEC("ORES",DUZ))!($D(^XUSEC("ORELSE",DUZ)))
"RTN","ORWDXVB",115,0)
 Q
"RTN","ORWDXVB",116,0)
NURSADMN(OROOT) ;Suppress Nursing Adiminstration Order Prompt
"RTN","ORWDXVB",117,0)
 S OROOT=+$$GET^XPAR("DIV^SYS^PKG","OR VBECS SUPPRESS NURS ADMIN")
"RTN","ORWDXVB",118,0)
 Q
"RTN","ORWDXVB",119,0)
VBTNS(RETURN) ;RPC to get Days back to check for Type & Screen order
"RTN","ORWDXVB",120,0)
 S RETURN=$$GET^XPAR("ALL","ORWDXVB VBECS TNS CHECK",1,"I")
"RTN","ORWDXVB",121,0)
 Q
"RTN","ORWDXVB",122,0)
COMPORD(OROOT) ;Get sequence order of Blood Components
"RTN","ORWDXVB",123,0)
 N ORLIST,I,X
"RTN","ORWDXVB",124,0)
 D GETLST^XPAR(.ORLIST,"ALL","OR VBECS COMPONENT ORDER")
"RTN","ORWDXVB",125,0)
 S I=0 F  S I=$O(ORLIST(I)) Q:'I  S X=ORLIST(I) I $D(^ORD(101.43,$P(X,"^",2),0)) S OROOT(I)=$P(X,"^",2)_"^"_$P(^(0),"^",1)_"^"_$P(^(0),"^",1)
"RTN","ORWDXVB",126,0)
 Q
"RTN","ORWDXVB",127,0)
SUBCHK(OROOT,TSTNM) ;Check to see if selected test is a Blood Component or a Diagnostic Test
"RTN","ORWDXVB",128,0)
 S OROOT=""
"RTN","ORWDXVB",129,0)
 Q:'$L($G(TSTNM))
"RTN","ORWDXVB",130,0)
 I $O(^ORD(101.43,"S.VBT",TSTNM,0)) S OROOT="t"
"RTN","ORWDXVB",131,0)
 I $O(^ORD(101.43,"S.VBC",TSTNM,0)) S OROOT="c"
"RTN","ORWDXVB",132,0)
 Q
"RTN","ORWDXVB",133,0)
TESTR ;Test results call
"RTN","ORWDXVB",134,0)
 N ORX
"RTN","ORWDXVB",135,0)
 S ORX(3)="3" ;HGB
"RTN","ORWDXVB",136,0)
 S ORX(4)="4" ;HCT
"RTN","ORWDXVB",137,0)
 S ORX(1)="1" ;WBC
"RTN","ORWDXVB",138,0)
 S ORX(113)="113" ;FERRITIN
"RTN","ORWDXVB",139,0)
 D RESULTS(.OROOT,66,.ORX)
"RTN","ORWDXVB",140,0)
 S I=0 F  S I=$O(@OROOT@(I)) Q:'I  W !,^(I,0)
"RTN","ORWDXVB",141,0)
 K @OROOT
"RTN","ORWDXVB",142,0)
 Q
"RTN","ORWDXVB1")
0^1^B62395957^B33294455
"RTN","ORWDXVB1",1,0)
ORWDXVB1 ;slc/dcm - Order dialog utilities for Blood Bank Cont.;3/2/04  09:31 ;12/7/05  17:20
"RTN","ORWDXVB1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**215,243,309,332**;Dec 17 1997;Build 44
"RTN","ORWDXVB1",3,0)
 ;
"RTN","ORWDXVB1",4,0)
PTINFO ;Format patient BB info
"RTN","ORWDXVB1",5,0)
 N GCNT,CCNT,GIOSL,GIOM,I,TYPE,ORUA,VBERROR,ABFND,LINE1,LINE2,NOABO,NOPAT,TREQFND
"RTN","ORWDXVB1",6,0)
 S (GCNT,NOPAT,NOABO)=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWDXVB1",7,0)
 S OROOT=$NA(^TMP("ORVBEC",$J))
"RTN","ORWDXVB1",8,0)
 K ^TMP("ORVBEC",$J)
"RTN","ORWDXVB1",9,0)
 ;
"RTN","ORWDXVB1",10,0)
 I +$G(ORX("ERROR")) D ERROR^ORWDXVB2("^TMP(""ORVBEC"",$J)") Q
"RTN","ORWDXVB1",11,0)
 ; Patient Demographics
"RTN","ORWDXVB1",12,0)
 D LN
"RTN","ORWDXVB1",13,0)
 I '$D(ORX("PATIENT")) D  Q
"RTN","ORWDXVB1",14,0)
 . D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",15,0)
 . S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(10,CCNT,"There is no previous record of this patient in VBECS.",.CCNT) Q
"RTN","ORWDXVB1",16,0)
 ;
"RTN","ORWDXVB1",17,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Name",.CCNT)_$$S^ORU4(27,CCNT,"SSN",.CCNT)_$$S^ORU4(42,CCNT,"ABO/Rh",.CCNT)
"RTN","ORWDXVB1",18,0)
 D LN
"RTN","ORWDXVB1",19,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"----",.CCNT)_$$S^ORU4(27,CCNT,"---",.CCNT)_$$S^ORU4(42,CCNT,"------",.CCNT) D
"RTN","ORWDXVB1",20,0)
 . D LN
"RTN","ORWDXVB1",21,0)
 . S X=ORX("PATIENT"),^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,$P(X,"^",3)_", "_$P(X,"^",2),.CCNT)_$$S^ORU4(27,CCNT,$P(X,"^",4),.CCNT)
"RTN","ORWDXVB1",22,0)
 . I $P(ORX("ABORH"),"^")']"" S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(42,CCNT,"unknown",.CCNT) Q
"RTN","ORWDXVB1",23,0)
 . S X=ORX("ABORH"),^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(42,CCNT,$$STRIP^XLFSTR($P(X,"^")," ")_" "_$S($$STRIP^XLFSTR($P(X,"^",2)," ")="P":"Pos",$$STRIP^XLFSTR($P(X,"^",2)," ")="N":"Neg",1:"unknown"),.CCNT) Q
"RTN","ORWDXVB1",24,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",25,0)
 ;
"RTN","ORWDXVB1",26,0)
 ; Available Specimens
"RTN","ORWDXVB1",27,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Lab Specimen ID",.CCNT)_$$S^ORU4(27,CCNT,"Expiration Date",.CCNT)
"RTN","ORWDXVB1",28,0)
 D LN
"RTN","ORWDXVB1",29,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"----------------------",.CCNT)_$$S^ORU4(27,CCNT,"---------------",.CCNT) D
"RTN","ORWDXVB1",30,0)
 . I '$D(ORX("SPECIMEN")) D LN S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT," none",.CCNT) Q
"RTN","ORWDXVB1",31,0)
 . D LN
"RTN","ORWDXVB1",32,0)
 . S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(2,CCNT,$P(ORX("SPECIMEN"),"^",2),.CCNT)_$$S^ORU4(27,CCNT,$$DATETIME^ORCHTAB($P(ORX("SPECIMEN"),"^")),.CCNT) Q
"RTN","ORWDXVB1",33,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",34,0)
 D UNITS
"RTN","ORWDXVB1",35,0)
 ; Antibodies Identified section
"RTN","ORWDXVB1",36,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Antibodies Identified",.CCNT)
"RTN","ORWDXVB1",37,0)
 D LN
"RTN","ORWDXVB1",38,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"---------------------",.CCNT) D
"RTN","ORWDXVB1",39,0)
 . I '$O(ORX("ABHIS",0)) D LN S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT," none",.CCNT) Q
"RTN","ORWDXVB1",40,0)
 . D LN
"RTN","ORWDXVB1",41,0)
 . S ABFND=0
"RTN","ORWDXVB1",42,0)
 . S I=0 F  S I=$O(ORX("ABHIS",I)) Q:I<1  D
"RTN","ORWDXVB1",43,0)
 .. S X=ORX("ABHIS",I)
"RTN","ORWDXVB1",44,0)
 .. I ABFND S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(2,CCNT,", "_$P(X,"^"),.CCNT) Q
"RTN","ORWDXVB1",45,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(2,CCNT,$P(X,"^"),.CCNT),ABFND=1
"RTN","ORWDXVB1",46,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",47,0)
 ;
"RTN","ORWDXVB1",48,0)
 ; Transfusion Requirements section
"RTN","ORWDXVB1",49,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Transfusion Requirements",.CCNT)
"RTN","ORWDXVB1",50,0)
 D LN
"RTN","ORWDXVB1",51,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"------------------------",.CCNT) D
"RTN","ORWDXVB1",52,0)
 . I '$O(ORX("TRREQ",0)) D LN S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT," none",.CCNT) Q
"RTN","ORWDXVB1",53,0)
 . D LN
"RTN","ORWDXVB1",54,0)
 . S TREQFND=0
"RTN","ORWDXVB1",55,0)
 . S I=0 F  S I=$O(ORX("TRREQ",I)) Q:I<1  D
"RTN","ORWDXVB1",56,0)
 .. S X=ORX("TRREQ",I)
"RTN","ORWDXVB1",57,0)
 .. I TREQFND S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(2,CCNT,", "_X,.CCNT) Q
"RTN","ORWDXVB1",58,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(2,CCNT,X,.CCNT),TREQFND=1
"RTN","ORWDXVB1",59,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",60,0)
 ;
"RTN","ORWDXVB1",61,0)
 ; Transfusion Reactions section
"RTN","ORWDXVB1",62,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Transfusion Reactions",.CCNT)_$$S^ORU4(27,CCNT,"Date/Time",.CCNT)
"RTN","ORWDXVB1",63,0)
 D LN
"RTN","ORWDXVB1",64,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"---------------------",.CCNT)_$$S^ORU4(27,CCNT,"---------",.CCNT) D
"RTN","ORWDXVB1",65,0)
 . I '$O(ORX("TRHX",0)) D LN S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT," none",.CCNT) Q
"RTN","ORWDXVB1",66,0)
 . S I=0 F  S I=$O(ORX("TRHX",I)) Q:I<1  D
"RTN","ORWDXVB1",67,0)
 .. D LN
"RTN","ORWDXVB1",68,0)
 .. S X=ORX("TRHX",I),^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(2,CCNT,$P(X,"^"),.CCNT)_$$S^ORU4(27,CCNT,$$DATETIME($P(X,"^",2)),.CCNT)
"RTN","ORWDXVB1",69,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",70,0)
 ;
"RTN","ORWDXVB1",71,0)
 Q
"RTN","ORWDXVB1",72,0)
UNITS ; New Units section
"RTN","ORWDXVB1",73,0)
 N INDEX,UNT,ORY,I,CNT,J,K,L,M,X,T,ORASSDT,OREXPDT,ORI,ID,PARAM,ORLOCAB
"RTN","ORWDXVB1",74,0)
 S CNT=0,PARAM=+$$GET^XPAR("DIV^SYS^PKG","OR VBECS AVAIL UNITS FORMAT"),ORLOCAB=0
"RTN","ORWDXVB1",75,0)
 I +$$GET^XPAR("DIV^SYS^PKG","OR VBECS LOC ABBREV BB REPORT"),PARAM'=1 S ORLOCAB=1 ;Location Abbreviation flag
"RTN","ORWDXVB1",76,0)
 K ^TMP("ORUTMP",$J)
"RTN","ORWDXVB1",77,0)
 F INDEX="A","D","C","S" I $O(ORX("UNIT",INDEX,0)) D  ; A:Autologous D:Directed C:Crossmatched A:Assigned
"RTN","ORWDXVB1",78,0)
 . S I=0 F  S I=$O(ORX("UNIT",INDEX,I)) Q:I<1  D
"RTN","ORWDXVB1",79,0)
 .. S X=ORX("UNIT",INDEX,I),CNT=CNT+1,ORY("~"_$P(X,"^"),"~"_$P(X,"^",2),"~"_INDEX,"~"_$P(X,"^",4),CNT)=X
"RTN","ORWDXVB1",80,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"Units Available",.CCNT)
"RTN","ORWDXVB1",81,0)
 D LN
"RTN","ORWDXVB1",82,0)
 S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(1,CCNT,"---------------",.CCNT)
"RTN","ORWDXVB1",83,0)
 D LN
"RTN","ORWDXVB1",84,0)
 ;ORM(i)=Minimum column width
"RTN","ORWDXVB1",85,0)
 D AVUNIT^VBECA4(DFN,"LRB") ;New Improved Format
"RTN","ORWDXVB1",86,0)
 I $O(^TMP("LRB",$J,0)) D
"RTN","ORWDXVB1",87,0)
 . K ^TMP("ORUTMP",$J)
"RTN","ORWDXVB1",88,0)
 . N ORI,ORL,ORDIV,ORASSDT,ORX,X,ORCNT,ORM,I,C1,C2,C3,C4,C5,C6,C7,C8,Y
"RTN","ORWDXVB1",89,0)
 . S ORM(1)=13,ORM(2)=7,ORM(3)=7,ORM(4)=9,ORM(5)=6,ORM(6)=9,ORM(7)=$S(ORLOCAB:6,1:8),ORM(8)=8
"RTN","ORWDXVB1",90,0)
 . S (ORCNT,ORI)=0 F  S ORI=$O(^TMP("LRB",$J,ORI)) Q:ORI<1  S ID=^(ORI) D
"RTN","ORWDXVB1",91,0)
 .. S ORX(1)=$$FMTE^XLFDT(9999999-ORI,"5M") ;Assigned Date/Time
"RTN","ORWDXVB1",92,0)
 .. S ORX(2)=$P(ID,"^",3) ; Unit ID
"RTN","ORWDXVB1",93,0)
 .. S ORX(3)=$P(ID,"^",11) ; Product ID
"RTN","ORWDXVB1",94,0)
 .. S ORX(4)=$P(ID,"^",4) ; Component
"RTN","ORWDXVB1",95,0)
 .. S X=$S($P(ID,"^",7)="P":"Pos",$P(ID,"^",7)="N":"Neg",1:$P(ID,"^",7)) S ORX(5)=$P(ID,"^",6)_" "_X ;ABO/Rh
"RTN","ORWDXVB1",96,0)
 .. S ORX(6)=$P(ID,"^",2) ;Expiration Date
"RTN","ORWDXVB1",97,0)
 .. S ORX(7)=$P(ID,"^",10)
"RTN","ORWDXVB1",98,0)
 .. I ORLOCAB D
"RTN","ORWDXVB1",99,0)
 ... S X=ORX(7)
"RTN","ORWDXVB1",100,0)
 ... I $L(X) S Y=$O(^SC("B",X,0)) I Y S X=$S($L($P($G(^SC(Y,0)),"^",2)):$P(^(0),"^",2),1:$E(X,1,7)) S ORX(7)=X ;Location
"RTN","ORWDXVB1",101,0)
 ... E  S ORX(7)=$E(X,1,7)
"RTN","ORWDXVB1",102,0)
 .. S ORX(8)=$P(ID,"^",9) ;Division
"RTN","ORWDXVB1",103,0)
 .. S ORCNT=ORCNT+1,^TMP("ORUTMP",$J,ORCNT)=ORX(1)_"^"_ORX(2)_"^"_ORX(3)_"^"_ORX(4)_"^"_ORX(5)_"^"_ORX(6)_"^"_ORX(7)_"^"_ORX(8)
"RTN","ORWDXVB1",104,0)
 .. F I=1:1:8 I $L(ORX(I))>ORM(I) S ORM(I)=$L(ORX(I)) ;Expand column width to fit data size
"RTN","ORWDXVB1",105,0)
 . I PARAM'=1 D
"RTN","ORWDXVB1",106,0)
 .. F I=1:1:8 S ORM(I)=ORM(I)+1 ;Add 1 space between columns
"RTN","ORWDXVB1",107,0)
 .. S C1=2,C2=C1+ORM(1),C3=C2+ORM(2),C4=C3+ORM(3),C5=C4+ORM(4),C6=C5+ORM(5),C7=C6+ORM(6),C8=C7+ORM(7)
"RTN","ORWDXVB1",108,0)
 .. D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM)
"RTN","ORWDXVB1",109,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,"Date Assigned",.CCNT)_$$S^ORU4(C2,.CCNT,"Unit ID",.CCNT)_$$S^ORU4(C3,.CCNT,"Prod ID",.CCNT)_$$S^ORU4(C4,.CCNT,"Component",.CCNT)_$$S^ORU4(C5,.CCNT,"ABO/Rh",.CCNT)
"RTN","ORWDXVB1",110,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,"Exp. Date",.CCNT)_$$S^ORU4(C7,.CCNT,$S(ORLOCAB:"Locale",1:"Location"),.CCNT)_$$S^ORU4(C8,.CCNT,"Division",.CCNT)
"RTN","ORWDXVB1",111,0)
 .. D LN
"RTN","ORWDXVB1",112,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,"-------------",.CCNT)_$$S^ORU4(C2,.CCNT,"-------",.CCNT)_$$S^ORU4(C3,.CCNT,"-------",.CCNT)_$$S^ORU4(C4,.CCNT,"---------",.CCNT)_$$S^ORU4(C5,.CCNT,"------",.CCNT)
"RTN","ORWDXVB1",113,0)
 .. S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,"---------",.CCNT)_$$S^ORU4(C7,.CCNT,$S(ORLOCAB:"------",1:"--------"),.CCNT)_$$S^ORU4(C8,.CCNT,"--------",.CCNT)
"RTN","ORWDXVB1",114,0)
 .. D LN
"RTN","ORWDXVB1",115,0)
 . S ORI=0 F  S ORI=$O(^TMP("ORUTMP",$J,ORI)) Q:'ORI  S ID=^(ORI) D
"RTN","ORWDXVB1",116,0)
 .. I PARAM'=1 D
"RTN","ORWDXVB1",117,0)
 ... D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM)
"RTN","ORWDXVB1",118,0)
 ... S ^TMP("ORVBEC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,$P(ID,"^"),.CCNT)_$$S^ORU4(C2,.CCNT,$P(ID,"^",2),.CCNT)_$$S^ORU4(C3,.CCNT,$P(ID,"^",3),.CCNT)_$$S^ORU4(C4,.CCNT,$P(ID,"^",4),.CCNT)_$$S^ORU4(C5,.CCNT,$P(ID,"^",5),.CCNT)
"RTN","ORWDXVB1",119,0)
 ... S ^TMP("ORVBEC",$J,GCNT,0)=^TMP("ORVBEC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,$P(ID,"^",6),.CCNT)_$$S^ORU4(C7,.CCNT,$P(ID,"^",7),.CCNT)_$$S^ORU4(C8,.CCNT,$P(ID,"^",8),.CCNT)
"RTN","ORWDXVB1",120,0)
 .. I PARAM=1 D
"RTN","ORWDXVB1",121,0)
 ... D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM)
"RTN","ORWDXVB1",122,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Date/Time Assigned: "_$$S^ORU4(1,.CCNT,$P(ID,"^",1),.CCNT)
"RTN","ORWDXVB1",123,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Unit ID           : "_$$S^ORU4(1,.CCNT,$P(ID,"^",2),.CCNT)
"RTN","ORWDXVB1",124,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Product ID        : "_$$S^ORU4(1,.CCNT,$P(ID,"^",3),.CCNT)
"RTN","ORWDXVB1",125,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Component         : "_$$S^ORU4(1,.CCNT,$P(ID,"^",4),.CCNT)
"RTN","ORWDXVB1",126,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" ABO/Rh            : "_$$S^ORU4(1,.CCNT,$P(ID,"^",5),.CCNT)
"RTN","ORWDXVB1",127,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Expiration Date   : "_$$S^ORU4(1,.CCNT,$P(ID,"^",6),.CCNT)
"RTN","ORWDXVB1",128,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Location          : "_$$S^ORU4(1,.CCNT,$P(ID,"^",7),.CCNT)
"RTN","ORWDXVB1",129,0)
 ... D LN S ^TMP("ORVBEC",$J,GCNT,0)=" Division          : "_$$S^ORU4(1,.CCNT,$P(ID,"^",8),.CCNT)
"RTN","ORWDXVB1",130,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB1",131,0)
 K ^TMP("LRB",$J),^TMP("ORUTMP",$J)
"RTN","ORWDXVB1",132,0)
 Q
"RTN","ORWDXVB1",133,0)
LN ;Increment counts
"RTN","ORWDXVB1",134,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWDXVB1",135,0)
 Q
"RTN","ORWDXVB1",136,0)
DATETIME(X) ; -- Return external form of YYYYMMDDHHNNSS date
"RTN","ORWDXVB1",137,0)
 N Y
"RTN","ORWDXVB1",138,0)
 S Y=$$HL7TFM^XLFDT(X),Y=$$DATETIME^ORCHTAB(Y)
"RTN","ORWDXVB1",139,0)
 Q Y
"RTN","ORWDXVB2")
0^2^B13660185^B17319895
"RTN","ORWDXVB2",1,0)
ORWDXVB2 ;slc/dcm - Order dialog utilities for Blood Bank Cont.;3/2/04  09:31
"RTN","ORWDXVB2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**215,243,212,309,332**;Dec 17 1997;Build 44
"RTN","ORWDXVB2",3,0)
 ;
"RTN","ORWDXVB2",4,0)
ERROR(OROOT) ;Process error
"RTN","ORWDXVB2",5,0)
 N ORERR,ORI,X,Y,I
"RTN","ORWDXVB2",6,0)
 S VBERROR=$P(ORX("ERROR"),"^",2) D LN
"RTN","ORWDXVB2",7,0)
 D GETWP^XPAR(.ORERR,"ALL","OR VBECS ERROR MESSAGE")
"RTN","ORWDXVB2",8,0)
 S ORI=0,Y="" F  S ORI=$O(ORERR(ORI)) Q:ORI<1  D
"RTN","ORWDXVB2",9,0)
 . S Y=$G(ORERR(ORI,0))
"RTN","ORWDXVB2",10,0)
 . D WRAP^ORU2(.Y,79)
"RTN","ORWDXVB2",11,0)
 . F I=1:1 S X=$P(Y,"|",I) Q:'$L(X)  D
"RTN","ORWDXVB2",12,0)
 .. S @OROOT@(GCNT,0)=$$S^ORU4($S(I=1:2,1:1),CCNT,X,.CCNT) D LN
"RTN","ORWDXVB2",13,0)
 D WRAP^ORU2(.VBERROR,77)
"RTN","ORWDXVB2",14,0)
 I X'?1."*" S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"********************************************************************************",.CCNT) D LN
"RTN","ORWDXVB2",15,0)
 S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"*                                                                              *",.CCNT) D LN
"RTN","ORWDXVB2",16,0)
 S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"*                                Error Message                                 *",.CCNT) D LN
"RTN","ORWDXVB2",17,0)
 S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"*                                                                              *",.CCNT) D LN
"RTN","ORWDXVB2",18,0)
 F I=1:1 S X=$P(VBERROR,"|",I) Q:'$L(X)  D
"RTN","ORWDXVB2",19,0)
 . S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"*",.CCNT)
"RTN","ORWDXVB2",20,0)
 . S @OROOT@(GCNT,0)=@OROOT@(GCNT,0)_$$S^ORU4(80-$L(X)/2,CCNT,X,.CCNT)
"RTN","ORWDXVB2",21,0)
 . S @OROOT@(GCNT,0)=@OROOT@(GCNT,0)_$$S^ORU4(80,CCNT,"*",.CCNT) D LN
"RTN","ORWDXVB2",22,0)
 S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"*                                                                              *",.CCNT) D LN
"RTN","ORWDXVB2",23,0)
 S @OROOT@(GCNT,0)=$$S^ORU4(1,CCNT,"********************************************************************************",.CCNT) D LN
"RTN","ORWDXVB2",24,0)
 D LINE^ORU4("^TMP(""ORVBEC"",$J)",GIOM),LN
"RTN","ORWDXVB2",25,0)
 Q
"RTN","ORWDXVB2",26,0)
PULL(OROOT,ORVP,ITEMID,SDATE,EDATE) ;Get list of orders matching ITEM
"RTN","ORWDXVB2",27,0)
 ;ITEM = Orderable Item ID e.g. "1;99VBC" for Type and Screen
"RTN","ORWDXVB2",28,0)
 ;SDATE = Start Date for search
"RTN","ORWDXVB2",29,0)
 ;EDATE = End Date for search
"RTN","ORWDXVB2",30,0)
 Q:'$G(ORVP)
"RTN","ORWDXVB2",31,0)
 N ORTNSB
"RTN","ORWDXVB2",32,0)
 I $P(ORVP,";",2)="" S ORVP=ORVP_";DPT("
"RTN","ORWDXVB2",33,0)
 S ORTNSB=$$GET^XPAR("ALL","ORWDXVB VBECS TNS CHECK",1,"I")
"RTN","ORWDXVB2",34,0)
 S:'ORTNSB ORTNSB=3 ;Use Default of DT-3 or Parameter [ORWDXVB VBECS TNS CHECK] if no start date passed in
"RTN","ORWDXVB2",35,0)
 S ITEMID=$S($D(ITEMID):ITEMID,1:"1;99VBC") ;Default to Type and Screen if nothing passed in
"RTN","ORWDXVB2",36,0)
 S SDATE=$S($D(SDATE):SDATE,1:$$FMADD^XLFDT(DT-ORTNSB))
"RTN","ORWDXVB2",37,0)
 S EDATE=$S($D(EDATE):EDATE,1:DT) ;Default to DT if no End date passed in
"RTN","ORWDXVB2",38,0)
 N ORDG,FLG,ORLIST,ORX0,ORX3,ORSTAT,ORIFN,I,X,J,CNT,ITEM,ITEMNM,ORLOC,DIV
"RTN","ORWDXVB2",39,0)
 S ITEM=+$O(^ORD(101.43,"ID",ITEMID,0)),ITEMNM=$P($G(^ORD(101.43,ITEM,0)),"^")
"RTN","ORWDXVB2",40,0)
 S CNT=0,ORDG=$O(^ORD(100.98,"B","VBEC",0)) Q:'ORDG
"RTN","ORWDXVB2",41,0)
 F FLG=4,23 D  ;Get completed, active/pending
"RTN","ORWDXVB2",42,0)
 . K ^TMP("ORR",$J)
"RTN","ORWDXVB2",43,0)
 . D EN^ORQ1(ORVP,ORDG,FLG,0,SDATE,EDATE)
"RTN","ORWDXVB2",44,0)
 . I '$O(^TMP("ORR",$J,ORLIST,0)) Q
"RTN","ORWDXVB2",45,0)
 . S I=0
"RTN","ORWDXVB2",46,0)
 . F  S I=$O(^TMP("ORR",$J,ORLIST,I)) Q:'I  S X=^(I) D
"RTN","ORWDXVB2",47,0)
 .. S ORIFN=+X,J=0,DIV=""
"RTN","ORWDXVB2",48,0)
 .. Q:'$D(^OR(100,ORIFN,0))  S ORX0=^(0),ORX3=^(3)
"RTN","ORWDXVB2",49,0)
 .. I (($P(ORX3,"^",3)=2)!($P(ORX3,"^",3)=7)),'$L($G(ORX("SPECIMEN"))) Q  ;Test completed/expired, yet VBECS doesn't have a specimen
"RTN","ORWDXVB2",50,0)
 .. S ORSTAT=$S($D(^ORD(100.01,+$P(ORX3,"^",3),0)):$P(^(0),"^"),1:""),ORLOC=$S($L($P($G(^SC(+$P(ORX0,"^",10),0)),"^")):$P(^(0),"^"),1:"UNKNOWN")
"RTN","ORWDXVB2",51,0)
 .. I +$P(ORX0,"^",10) S DIV=$P($G(^SC(+$P(ORX0,"^",10),0)),U,15),DIV=$S(DIV:$P($$SITE^VASITE(DT,DIV),"^",2),1:"")
"RTN","ORWDXVB2",52,0)
 .. F  S J=$O(^OR(100,ORIFN,4.5,"ID","ORDERABLE",J)) Q:'J  I +$G(^OR(100,ORIFN,4.5,J,1))=ITEM D
"RTN","ORWDXVB2",53,0)
 ... S CNT=CNT+1,OROOT(CNT)="Duplicate order: "_ITEMNM_" entered "_$$FMTE^XLFDT($P(ORX0,"^",7))_" Div/Loc: "_DIV_":"_ORLOC_" ["_ORSTAT_"]"
"RTN","ORWDXVB2",54,0)
 Q
"RTN","ORWDXVB2",55,0)
LN ;Increment counts
"RTN","ORWDXVB2",56,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWDXVB2",57,0)
 Q
"RTN","ORWLR")
0^4^B9107402^B9469804
"RTN","ORWLR",1,0)
ORWLR ; SLC/KCM,ALB/MJK - Lab Calls ;7/20/96  15:02
"RTN","ORWLR",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,332**;Dec 17, 1997;Build 44
"RTN","ORWLR",3,0)
 ;
"RTN","ORWLR",4,0)
LIST(OROOT) ; -- return lists for list boxes
"RTN","ORWLR",5,0)
 ;  RPC: ORWLR REPORT LIST
"RTN","ORWLR",6,0)
 N EOF
"RTN","ORWLR",7,0)
 S EOF="$$END",OROOT=$NA(^TMP($J,"ORLABLIST"))
"RTN","ORWLR",8,0)
 K @OROOT
"RTN","ORWLR",9,0)
 D GETRPTS(.OROOT,.EOF) ; -- get list of reports
"RTN","ORWLR",10,0)
 D GETDT^ORWRP(.OROOT,.EOF) ; -- get list of date ranges
"RTN","ORWLR",11,0)
 Q
"RTN","ORWLR",12,0)
GETRPTS(OROOT,EOF) ;  -- get list of reports
"RTN","ORWLR",13,0)
 N I,X,Z,Y,RPTDEF
"RTN","ORWLR",14,0)
 S RPTDEF="^^Y^N^80"
"RTN","ORWLR",15,0)
 D SETITEM^ORWRP(.OROOT,"[REPORT LIST]")
"RTN","ORWLR",16,0)
 D GET64^LR7OSUM(.ORLIST)
"RTN","ORWLR",17,0)
 S X="" F  S X=$O(ORLIST(X)) Q:X=""  D
"RTN","ORWLR",18,0)
 . S Y=""
"RTN","ORWLR",19,0)
 . F I=1:1 S Z=$P(X," ",I) Q:Z=""  D
"RTN","ORWLR",20,0)
 . . S Y=Y_$S($L(Z)>2:$E(Z)_$$LOW^XLFSTR($E(Z,2,999)),1:Z)_" "
"RTN","ORWLR",21,0)
 . S $P(RPTDEF,U,1)=X,$P(RPTDEF,U,2)=Y
"RTN","ORWLR",22,0)
 . D SETITEM^ORWRP(.OROOT,RPTDEF)
"RTN","ORWLR",23,0)
 D SETITEM^ORWRP(.OROOT,.EOF)
"RTN","ORWLR",24,0)
 Q
"RTN","ORWLR",25,0)
RPT(OROOT,DFN,RPTID,DTRANGE,SECTION) ; -- return cum report text
"RTN","ORWLR",26,0)
 ;  RPC: ORWLR REPORT TEXT
"RTN","ORWLR",27,0)
 IF $G(SECTION),$D(^TMP("ORLABDATA",$J,SECTION)) D  G RPTQ
"RTN","ORWLR",28,0)
 . S OROOT=$NA(^TMP("ORLABDATA",$J,SECTION))
"RTN","ORWLR",29,0)
 N LINES,ORSUB
"RTN","ORWLR",30,0)
 K ^TMP("ORLABDATA",$J)
"RTN","ORWLR",31,0)
 D CUMB(DFN,RPTID,DTRANGE)
"RTN","ORWLR",32,0)
 S LINES=$S($D(^TMP("LRH",$J,RPTID)):+^(RPTID),1:0)
"RTN","ORWLR",33,0)
 IF LINES<241 D
"RTN","ORWLR",34,0)
 . S OROOT=$NA(^TMP("LRC",$J))
"RTN","ORWLR",35,0)
 . S @OROOT@(.001)="1^1"
"RTN","ORWLR",36,0)
 ELSE  D
"RTN","ORWLR",37,0)
 . S ORSUB="ORLABDATA",OROOT=$NA(^TMP(ORSUB,$J,1))
"RTN","ORWLR",38,0)
 . D BUILD
"RTN","ORWLR",39,0)
RPTQ Q
"RTN","ORWLR",40,0)
 ;
"RTN","ORWLR",41,0)
CUMB(DFN,RPTID,DTRANGE) ; -- build tmp global w/cumulative data
"RTN","ORWLR",42,0)
 N X,X1,IOST,IOM,ORBEG,OREND,ORSBHEAD
"RTN","ORWLR",43,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J)
"RTN","ORWLR",44,0)
 S IOST="C-",IOM=80,X1=DT
"RTN","ORWLR",45,0)
 S X2=-$S(DTRANGE:DTRANGE-1,1:0)
"RTN","ORWLR",46,0)
 D C^%DTC
"RTN","ORWLR",47,0)
 S ORBEG=X-.7641,OREND=DT+.2359
"RTN","ORWLR",48,0)
 IF RPTID'="ALL" D
"RTN","ORWLR",49,0)
 . S ORSBHEAD=$NA(ORSBHEAD)
"RTN","ORWLR",50,0)
 . S ORSBHEAD(RPTID)=""
"RTN","ORWLR",51,0)
 D EN^LR7OSUM(.OROOT,DFN,ORBEG,OREND,"",IOM,.ORSBHEAD)
"RTN","ORWLR",52,0)
 Q
"RTN","ORWLR",53,0)
BUILD ; -- build tmp global for report
"RTN","ORWLR",54,0)
 N INC,CNT,MAX,SECTION,OROOT,ORI
"RTN","ORWLR",55,0)
 S SECTION=0,MAX=20000
"RTN","ORWLR",56,0)
 D INIT^ORWRP
"RTN","ORWLR",57,0)
 S ORI=0
"RTN","ORWLR",58,0)
 F  S ORI=$O(^TMP("LRC",$J,ORI)) Q:'ORI  S X=$G(^(ORI,0)) D
"RTN","ORWLR",59,0)
 . I (CNT+250)>MAX D INIT^ORWRP
"RTN","ORWLR",60,0)
 . S INC=INC+1,@OROOT@(INC)=X
"RTN","ORWLR",61,0)
 . S CNT=CNT+$L(X)
"RTN","ORWLR",62,0)
 D FINAL^ORWRP
"RTN","ORWLR",63,0)
 Q
"RTN","ORWLR",64,0)
CUM(OROOT,DFN,DAYS,ALPHA,OMEGA) ; Return cumulative report
"RTN","ORWLR",65,0)
 N I,X,X1,X2,C,LINES,IOST,IOM,ROOT
"RTN","ORWLR",66,0)
 S ROOT=$$SET^ORWLRR()
"RTN","ORWLR",67,0)
 S IOST="C-",IOM=80,OROOT=$NA(^TMP("LRC",$J))
"RTN","ORWLR",68,0)
 K ^TMP("LRC",$J),^TMP("LRH",$J)
"RTN","ORWLR",69,0)
 Q:'$G(DFN)
"RTN","ORWLR",70,0)
 I $L($G(DAYS)),'$G(ALPHA) S ALPHA=$$FMADD^XLFDT(DT,-DAYS),OMEGA=$$NOW^XLFDT
"RTN","ORWLR",71,0)
 Q:'$G(ALPHA)  Q:'$G(OMEGA)
"RTN","ORWLR",72,0)
 I $$REMOTE^ORWLRR(.DFN,.ROOT) D EN^LR7OSUM(.OROOT,DFN,ALPHA,OMEGA)
"RTN","ORWLR",73,0)
 ;S (I,C)=0 F  S I=$O(^TMP("LRC",$J,I)) Q:I'>0  S C=C+$L(^(I,0))
"RTN","ORWLR",74,0)
 S I=0
"RTN","ORWLR",75,0)
 I $L($O(^TMP("LRH",$J,0))) S I=.001,^TMP("LRC",$J,I)="[HIDDEN TEXT]^" D
"RTN","ORWLR",76,0)
 . S X="",C=2 F  S X=$O(^TMP("LRH",$J,X)) Q:X=""  S LINES(^(X))=X,C=C+1
"RTN","ORWLR",77,0)
 . S $P(^TMP("LRC",$J,.001),"^",2)=C
"RTN","ORWLR",78,0)
 . S X="" F  S X=$O(LINES(X)) Q:X=""  D
"RTN","ORWLR",79,0)
 .. S I=I+.001,^TMP("LRC",$J,I)=X_"^"_LINES(X)
"RTN","ORWLR",80,0)
 . S I=I+.001,^TMP("LRC",$J,I)="[REPORT TEXT]"
"RTN","ORWLR",81,0)
 D CLEAN^ORWLRR(.OROOT,ROOT)
"RTN","ORWLR",82,0)
 Q
"RTN","ORWLR1")
0^3^B40020805^B37372130
"RTN","ORWLR1",1,0)
ORWLR1 ; slc/dcm -  VBEC Blood Bank Report ;01/16/03  15:02
"RTN","ORWLR1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**172,212,309,332**;Dec 17, 1997;Build 44
"RTN","ORWLR1",3,0)
 ;Re-write of ^LR7OSBR
"RTN","ORWLR1",4,0)
EN(DFN) ;Get Blood Bank Report
"RTN","ORWLR1",5,0)
 Q:'$G(DFN)
"RTN","ORWLR1",6,0)
 N GCNT,CCNT,GIOSL,GIOM,ORABORH,PATID,PATNAM,PATDOB,ORN
"RTN","ORWLR1",7,0)
 S PATID="`"_DFN,PATNAM=$P(^DPT(DFN,0),"^"),PATDOB=$P(^(0),"^",3) ;Why PATNAM and PATDOB???
"RTN","ORWLR1",8,0)
 K ^TMP("ORLRC",$J)
"RTN","ORWLR1",9,0)
 S GCNT=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWLR1",10,0)
 S ORABORH=$$ABORH^VBECA1(PATID,PATNAM,PATDOB) ;Get ABO/RH
"RTN","ORWLR1",11,0)
 I $E(ORABORH,1,2)="1^" S ORX("ERROR")=ORABORH D  Q  ;Isolate error condition
"RTN","ORWLR1",12,0)
 . N GCNT,CCNT,GIOSL,GIOM,I,TYPE,ORUA,VBERROR,ABFND,LINE1,LINE2,NOABO,NOPAT,TREQFND
"RTN","ORWLR1",13,0)
 . S (GCNT,NOPAT,NOABO)=0,CCNT=1,GIOSL=999999,GIOM=80
"RTN","ORWLR1",14,0)
 . S OROOT=$NA(^TMP("ORVBEC",$J))
"RTN","ORWLR1",15,0)
 . D ERROR^ORWDXVB2("^TMP(""ORLRC"",$J)")
"RTN","ORWLR1",16,0)
 S ORN(2.91)="DIRECT AHG TEST COMMENT",ORN(8)="ANTIBODY SCREEN COMMENT"
"RTN","ORWLR1",17,0)
 S ORN(10.3)="ABO TESTING COMMENT",ORN(11.3)="RH TESTING COMMENT"
"RTN","ORWLR1",18,0)
 D EN^ORWLR2
"RTN","ORWLR1",19,0)
 Q
"RTN","ORWLR1",20,0)
REPORT ;Blood Bank Report for M reports menu
"RTN","ORWLR1",21,0)
 Q:'$G(DFN)
"RTN","ORWLR1",22,0)
 N DIC,ID,ORDFN,ORY,PAGE,XQORNOD,ORDAYSBK
"RTN","ORWLR1",23,0)
 S ORDFN=DFN,ID=2
"RTN","ORWLR1",24,0)
 D BLR^ORWRP1(.ORY,.ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDAYSBK,.REMOTE)
"RTN","ORWLR1",25,0)
 Q:'$L(ORY)
"RTN","ORWLR1",26,0)
 S PAGE=1
"RTN","ORWLR1",27,0)
 D HEAD^ORWRPP1(ORDFN,PAGE,"PATIENT BLOOD BANK REPORT",$G(STATION))
"RTN","ORWLR1",28,0)
 D HURL^ORWRPP1(.ORY,ORDFN,"PATIENT BLOOD BANK REPORT",,,1)
"RTN","ORWLR1",29,0)
 Q
"RTN","ORWLR1",30,0)
GETPAT(ERR) ;Setup Patient Variables
"RTN","ORWLR1",31,0)
 N ORPNM
"RTN","ORWLR1",32,0)
 S ERR=0
"RTN","ORWLR1",33,0)
 D EN2^ORUDPA
"RTN","ORWLR1",34,0)
 I 'ORVP S ERR=1 Q
"RTN","ORWLR1",35,0)
 S PATID="`"_+ORVP,PATNAM=ORPNM,PATDOB=$P(^DPT(+ORVP,0),"^",3)
"RTN","ORWLR1",36,0)
 D PAT^VBECA1A
"RTN","ORWLR1",37,0)
 W !,LRDFN
"RTN","ORWLR1",38,0)
 I $O(VBECERR(0)) D  S ERR=1 Q
"RTN","ORWLR1",39,0)
 . S ERR=0 F  S ERR=$O(VBECERR(ERR)) Q:'ERR  W !?5," ERR:"_VBECERR(1)
"RTN","ORWLR1",40,0)
 Q
"RTN","ORWLR1",41,0)
TEST ;Test calls
"RTN","ORWLR1",42,0)
 N ORVP,PATID,PATNAM,PATDOB,LRDFN,ERR,ABORH,ID,ID1,ID2,ARR,GMI,DI2,BPN,VBECERR,ERROR
"RTN","ORWLR1",43,0)
 D GETPAT(.ERROR)
"RTN","ORWLR1",44,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",45,0)
 D ABORH,ABID,TRRX,DFN,CPRS,TRAN
"RTN","ORWLR1",46,0)
 I $O(^TMP("VBDATA",$J,"CROSSMATCH",0)) D
"RTN","ORWLR1",47,0)
 . W !,"Crossmatched Units: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"CROSSMATCH",ID)) Q:'ID  W !?2,^(ID)
"RTN","ORWLR1",48,0)
 K ^TMP("VBDATA",$J),^TMP("TRRX",$J),^TMP("TRAN",$J)
"RTN","ORWLR1",49,0)
 Q
"RTN","ORWLR1",50,0)
OEAPI ;Test call to OEAPI^VBECA3
"RTN","ORWLR1",51,0)
 N DIV,ORSTN,ERROR,ORVB
"RTN","ORWLR1",52,0)
 D GETPAT^ORWLR1(.ERROR)
"RTN","ORWLR1",53,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",54,0)
 S DIV=+$P($G(^SC(+$G(ORL),0)),U,15),ORSTN=$P($$SITE^VASITE(DT,DIV),U,3)
"RTN","ORWLR1",55,0)
 D OEAPI^VBECA3(.ORVB,+ORVP,ORSTN)
"RTN","ORWLR1",56,0)
 I $O(ORVB(0)) D
"RTN","ORWLR1",57,0)
 . W !,"Array returned from OEAPI^VBECA3 API in ORVB():",!
"RTN","ORWLR1",58,0)
 . ;ZW ORVB
"RTN","ORWLR1",59,0)
 K ^TMP("OR",$J),^TMP("VBECRPC",$J),^TMP("VBECS_XML_RES",$J),^TMP("VBEC_OE_DATA",$J)
"RTN","ORWLR1",60,0)
 Q
"RTN","ORWLR1",61,0)
ABORH ;Test call to ABORH^VBECA1 for ABO/Rh - DBIA 3181
"RTN","ORWLR1",62,0)
 N ERROR
"RTN","ORWLR1",63,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",64,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",65,0)
 S ABORH=$$ABORH^VBECA1(PATID,PATNAM,PATDOB) W !,"ABO/RH: "_ABORH
"RTN","ORWLR1",66,0)
 Q
"RTN","ORWLR1",67,0)
ABID ;Test call to ABID^VBECA1 for Antibodies Identified - DBIA 3181, 3184
"RTN","ORWLR1",68,0)
 N ID,ERROR,ORPARNT
"RTN","ORWLR1",69,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",70,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",71,0)
 D ABID^VBECA1(PATID,PATNAM,PATDOB,.ORPARNT,.ORARR) I $O(ARR("ABID",0)) D
"RTN","ORWLR1",72,0)
 . W !,"Antibodies Identified: " S ID=0 F  S ID=$O(ARR("ABID",ID)) Q:'ID  W !?2,ARR("ABID",ID)
"RTN","ORWLR1",73,0)
 Q
"RTN","ORWLR1",74,0)
DFN ;Test call to DFN^VBECA3A - DBIA 3879
"RTN","ORWLR1",75,0)
 N ID,ID1,ID2,ERROR
"RTN","ORWLR1",76,0)
 K ^TMP("VBDATA",$J)
"RTN","ORWLR1",77,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",78,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",79,0)
 D DFN^VBECA3A(DFN)
"RTN","ORWLR1",80,0)
 I $O(^TMP("VBDATA",$J,"COMPONENT REQUEST",0)) D
"RTN","ORWLR1",81,0)
 . W !,"Component request: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"COMPONENT REQUEST",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",82,0)
 .. S ID1=0 F  S ID1=$O(^TMP("VBDATA",$J,"COMPONENT REQUEST",ID,ID1)) Q:'ID1  W !,"."_^(ID1)
"RTN","ORWLR1",83,0)
 I $O(^TMP("VBDATA",$J,"SPECIMEN",0)) D
"RTN","ORWLR1",84,0)
 . W !,"Specimen: " S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"SPECIMEN",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",85,0)
 .. S ID1=0 F  S ID1=$O(^TMP("VBDATA",$J,"SPECIMEN",ID,ID1)) Q:'ID1  W:$D(^(ID1))#2 !,"."_^(ID1) D
"RTN","ORWLR1",86,0)
 ... S ID2=0 F  S ID2=$O(^TMP("VBDATA",$J,"SPECIMEN",ID,ID1,ID2)) Q:'ID2  W:$D(^(ID2))#2 !,".."_^(ID2)
"RTN","ORWLR1",87,0)
 I $O(^TMP("VBDATA",$J,"UNIT",0)) D
"RTN","ORWLR1",88,0)
 . W !,"Available Units: "
"RTN","ORWLR1",89,0)
 . S ID=0 F  S ID=$O(^TMP("VBDATA",$J,"UNIT",ID)) Q:'ID  W !?2,^(ID)
"RTN","ORWLR1",90,0)
 Q
"RTN","ORWLR1",91,0)
CPRS ;Test call to CPRS^VBECA3B - DBIA 3880
"RTN","ORWLR1",92,0)
 N ID,ID1,ID2,ERROR
"RTN","ORWLR1",93,0)
 K ^TMP("BBD",$J)
"RTN","ORWLR1",94,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",95,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",96,0)
 D CPRS^VBECA3B
"RTN","ORWLR1",97,0)
 I $O(^TMP("BBD",$J,"SPECIMEN",0)) D
"RTN","ORWLR1",98,0)
 . W !,"Specimen: " S ID=0 F  S ID=$O(^TMP("BBD",$J,"SPECIMEN",ID)) Q:'ID  W !?2,^(ID) D
"RTN","ORWLR1",99,0)
 .. S ID1=0 F  S ID1=$O(^TMP("BBD",$J,"SPECIMEN",ID,ID1)) Q:'ID1  W:$D(^(ID1))#2 !,"."_^(ID1) D
"RTN","ORWLR1",100,0)
 ... S ID2=0 F  S ID2=$O(^TMP("BBD",$J,"SPECIMEN",ID,ID1,ID2)) Q:'ID2  W:$D(^(ID2))#2 !,".."_^(ID2)
"RTN","ORWLR1",101,0)
 Q
"RTN","ORWLR1",102,0)
TRAN ;Test call to TRAN^VBECA4 for Tranfused Units - DBIA 3176
"RTN","ORWLR1",103,0)
 N BPN,ID,GMI,GMR,ERROR,CNT,ORAY,COMP,COMPSEQ,X,TD
"RTN","ORWLR1",104,0)
 K ^TMP("TRAN",$J),^TMP("ZTRAN",$J)
"RTN","ORWLR1",105,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",106,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",107,0)
 D TRAN^VBECA4(+ORVP,"TRAN")
"RTN","ORWLR1",108,0)
 ;^TMP("TRAN",$J,InverseDate)="Date^Number of Units\Product Type"
"RTN","ORWLR1",109,0)
 ;^TMP("TRAN",$J,"Product Type")="Product Type Print Name"
"RTN","ORWLR1",110,0)
 S CNT=0 F ID="RBC","FFP","PLT","CRY","PLA","SER","GRA","WB" S CNT=CNT+1,ORAY(ID)=CNT
"RTN","ORWLR1",111,0)
 S ID=0 F  S ID=$O(^TMP("TRAN",$J,ID)) Q:'ID  S GMR=^(ID),COMP=$P(GMR,"^",2),COMP=$P(COMP,"\",2),COMP=$E($P(COMP,";"),1,3),COMPSEQ=$S($D(ORAY(COMP)):ORAY(COMP),1:99) D
"RTN","ORWLR1",112,0)
 . I '$D(^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ)) S ^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ)=GMR_"^"_1 Q
"RTN","ORWLR1",113,0)
 . S CNT=$P(^TMP("ZTRAN",$J,$P(ID,"."),COMPSEQ),"^",3),$P(^(COMPSEQ),"^",3)=CNT+1
"RTN","ORWLR1",114,0)
 I $O(^TMP("ZTRAN",$J,0)) D
"RTN","ORWLR1",115,0)
 . W !,"Sorted/grouped Transfused Units: ",! S ID=0
"RTN","ORWLR1",116,0)
 . F  S ID=$O(^TMP("ZTRAN",$J,ID)) Q:'ID  S COMP="" F  S COMP=$O(^TMP("ZTRAN",$J,ID,COMP)) Q:COMP=""  S GMR=^(COMP) D
"RTN","ORWLR1",117,0)
 .. I $P(GMR,"^",3) S $P(GMR,"^",2)=$P(GMR,"^",3)_"\"_$P($P(GMR,"^",2),"\",2)
"RTN","ORWLR1",118,0)
 .. D PARSE,WRT
"RTN","ORWLR1",119,0)
 I $O(^TMP("TRAN",$J,0)) D
"RTN","ORWLR1",120,0)
 . W !,"Transfused Units (from VBECS API): ",! S ID=0
"RTN","ORWLR1",121,0)
 . F  S ID=$O(^TMP("TRAN",$J,ID)) Q:'ID  S GMR=^(ID) D
"RTN","ORWLR1",122,0)
 .. D PARSE,WRT
"RTN","ORWLR1",123,0)
 . I $O(^TMP("TRAN",$J,"A"))'="" D
"RTN","ORWLR1",124,0)
 .. W !," Blood Product Key: "
"RTN","ORWLR1",125,0)
 . S GMI="A" F  S GMI=$O(^TMP("TRAN",$J,GMI)) Q:GMI=""  D
"RTN","ORWLR1",126,0)
 .. W ?22,GMI," = ",$G(^TMP("TRAN",$J,GMI)),!
"RTN","ORWLR1",127,0)
 Q
"RTN","ORWLR1",128,0)
TRRX ;Test call to TRRX^VBECA1 for Transfusion Reactions - DBIA 3181, 3187
"RTN","ORWLR1",129,0)
 N ARR,ID,ERROR,ORPARNT
"RTN","ORWLR1",130,0)
 I '$G(ORVP) D GETPAT(.ERROR)
"RTN","ORWLR1",131,0)
 I $G(ERROR) W !,"Error on Patient lookup" Q
"RTN","ORWLR1",132,0)
 D TRRX^VBECA1(PATID,PATNAM,PATDOB,.ORPARNT,.ORARR) I $O(ARR("TRRX",0)) D
"RTN","ORWLR1",133,0)
 . W !,"Transfusion reactions: " S ID=0 F  S ID=$O(ARR("TRRX",ID)) Q:'ID  W !?2,ARR("TRRX",ID)
"RTN","ORWLR1",134,0)
 Q
"RTN","ORWLR1",135,0)
PARSE ;Parse Record
"RTN","ORWLR1",136,0)
 N GMI,X
"RTN","ORWLR1",137,0)
 S TD=$$FMTE^XLFDT(+GMR)
"RTN","ORWLR1",138,0)
 S GMA(1)=$P(GMR,U,2),BPN=$L(GMA(1),";")
"RTN","ORWLR1",139,0)
 I $P(GMA(1),";",BPN)="" S BPN=BPN-1
"RTN","ORWLR1",140,0)
 F GMI=2:1:BPN S GMA(GMI)="("_$P($P(GMA(1),";",GMI),"\")_") "_$P($P(GMA(1),";",GMI),"\",2)
"RTN","ORWLR1",141,0)
 S GMA(1)="("_$P($P(GMA(1),";",1),"\")_") "_$P($P(GMA(1),";",1),"\",2)
"RTN","ORWLR1",142,0)
 Q
"RTN","ORWLR1",143,0)
WRT ; Writes the Transfusion Record for each day
"RTN","ORWLR1",144,0)
 N GML,GMI1,GMI2,GMM,GMJ
"RTN","ORWLR1",145,0)
 S GMM=$S(BPN#4:1,1:0),GML=BPN\4+GMM
"RTN","ORWLR1",146,0)
 W TD
"RTN","ORWLR1",147,0)
 F GMI1=1:1:GML D
"RTN","ORWLR1",148,0)
 . F GMI2=1:1:($S((GMI1=GML)&(BPN#4):BPN#4,1:4)) D
"RTN","ORWLR1",149,0)
 .. S GMJ=((GMI1-1)*4)+GMI2
"RTN","ORWLR1",150,0)
 .. W ?(((GMI2-1)*15)+13),GMA(GMJ)
"RTN","ORWLR1",151,0)
 .. I $S(GMI2#4=0:1,GMI2=BPN:1,GMI2+(4*(GMI1-1))=BPN:1,1:0) W !
"RTN","ORWLR1",152,0)
 Q
"RTN","ORWLR3")
0^8^B130594951^B46485364
"RTN","ORWLR3",1,0)
ORWLR3 ; slc/dcm - VBEC Blood Bank Report cont. ;11/13/07  15:19
"RTN","ORWLR3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**212,309,332**;Dec 17, 1997;Build 44
"RTN","ORWLR3",3,0)
RPT ;Pull report data from VBECS
"RTN","ORWLR3",4,0)
 N ORI,ORJ,ORK,ORT,ORL,ORRY,REQX,CMT,C,ID,T,CFAG,CNTR,BUMP,OR4
"RTN","ORWLR3",5,0)
 K ^TMP("VBDATA",$J),^TMP("ORCAN",$J)
"RTN","ORWLR3",6,0)
 ;Antibodies
"RTN","ORWLR3",7,0)
 D ABID^VBECA1(PATID,PATNAM,PATDOB,.ORPARENT,.ORRY)
"RTN","ORWLR3",8,0)
 I $O(ORRY("ABID",0)) D
"RTN","ORWLR3",9,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",10,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,"ANTIBODIES IDENTIFIED: ",.CCNT),ID=0
"RTN","ORWLR3",11,0)
 . D LN F  S ID=$O(ORRY("ABID",ID)) Q:'ID  D
"RTN","ORWLR3",12,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,$G(ORRY("ABID",ID)),.CCNT)
"RTN","ORWLR3",13,0)
 .. I $O(ORRY("ABID",ID,0)) D
"RTN","ORWLR3",14,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,"COMMENT:",.CCNT) D LN
"RTN","ORWLR3",15,0)
 ... S CMT=0 F  S CMT=$O(ORRY("ABID",ID,CMT)) Q:'CMT  S C=ORRY("ABID",ID,CMT) D
"RTN","ORWLR3",16,0)
 .... D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,C,.CCNT)
"RTN","ORWLR3",17,0)
 ... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",18,0)
 ;Transfusion reactions 
"RTN","ORWLR3",19,0)
 D TRRX^VBECA1(PATID,PATNAM,PATDOB,.ORPARENT,.ORRY)
"RTN","ORWLR3",20,0)
 I $O(ORRY("TRRX",0)) D
"RTN","ORWLR3",21,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",22,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,"TRANSFUSION REACTIONS:",.CCNT) D LN
"RTN","ORWLR3",23,0)
 . S ID=0 F  S ID=$O(ORRY("TRRX",ID)) Q:'ID  S X=ORRY("TRRX",ID) D
"RTN","ORWLR3",24,0)
 .. S Y=$TR($$FMTE^XLFDT(+X,"M"),"@"," ") D LN
"RTN","ORWLR3",25,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(3,.CCNT,"Type:  "_$S($P(X,U,2)]"":$P(X,U,2),1:"Unknown"),.CCNT) D LN
"RTN","ORWLR3",26,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(6,.CCNT,"Date/Time",.CCNT)_$$S^ORU4(35,.CCNT,"Unit ID",.CCNT)_$$S^ORU4(66,.CCNT,"Component",.CCNT) D LN
"RTN","ORWLR3",27,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(6,.CCNT,"---------",.CCNT)_$$S^ORU4(35,.CCNT,"-------",.CCNT)_$$S^ORU4(66,.CCNT,"---------",.CCNT) D LN
"RTN","ORWLR3",28,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(6,.CCNT,$S(Y]"":Y,1:"Unknown"),.CCNT)_$$S^ORU4(35,.CCNT,$S($P(X,U,3)]"":$P(X,U,3),1:"Unknown"),.CCNT)_$$S^ORU4(66,.CCNT,$S($P(X,U,4)]"":$P(X,U,4),1:"Unknown"),.CCNT)
"RTN","ORWLR3",29,0)
 .. I $O(ORRY("TRRX",ID,0)) D
"RTN","ORWLR3",30,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(6,.CCNT,"Comment:",.CCNT) D LN
"RTN","ORWLR3",31,0)
 ... S CMT=0 F  S CMT=$O(ORRY("TRRX",ID,CMT)) Q:'CMT  S C=ORRY("TRRX",ID,CMT) D
"RTN","ORWLR3",32,0)
 .... D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(6,.CCNT,C,.CCNT)
"RTN","ORWLR3",33,0)
 .. D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",34,0)
 D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",35,0)
 ;Xmatched units, Component requests, Diagnostic test results
"RTN","ORWLR3",36,0)
 D DFN^VBECA3A(DFN)
"RTN","ORWLR3",37,0)
 ;Available Units
"RTN","ORWLR3",38,0)
 D AVUNIT^VBECA4(DFN,"LRB") ;New Improved Format
"RTN","ORWLR3",39,0)
 N INDEX,UNT,ORY,I,CNT,J,K,L,M,X,T,ORASSDT,OREXPDT,ORI,ID,PARAM,ORLOCAB
"RTN","ORWLR3",40,0)
 S CNT=0,PARAM=+$$GET^XPAR("DIV^SYS^PKG","OR VBECS AVAIL UNITS FORMAT"),ORLOCAB=0
"RTN","ORWLR3",41,0)
 I $D(ORPRTING)!(+$$GET^XPAR("DIV^SYS^PKG","OR VBECS LOC ABBREV BB REPORT")),PARAM'=1 S ORLOCAB=1 ;Location Abbreviation flag
"RTN","ORWLR3",42,0)
 K ^TMP("ORUTMP",$J)
"RTN","ORWLR3",43,0)
 I $O(^TMP("LRB",$J,0)) D
"RTN","ORWLR3",44,0)
 . K ^TMP("ORUTMP",$J)
"RTN","ORWLR3",45,0)
 . N ORI,ORL,ORDIV,ORASSDT,ORX,X,ORCNT,ORM,I,C1,C2,C3,C4,C5,C6,C7,C8,Y,H1,H2,H3,H4,H5,H6,H7,H8
"RTN","ORWLR3",46,0)
 . N ROWSIZ,ORSPLIT
"RTN","ORWLR3",47,0)
 . S ORSPLIT=0
"RTN","ORWLR3",48,0)
 . S ORM(1)=14,ORM(2)=7,ORM(3)=7,ORM(4)=9,ORM(5)=6,ORM(6)=9,ORM(7)=$S(ORLOCAB:6,1:8),ORM(8)=8
"RTN","ORWLR3",49,0)
 . S ORM(1,1)=14,ORM(1,2)=11,ORM(1,4)=9,ORM(2,5)=6,ORM(2,6)=9,ORM(2,7)=$S(ORLOCAB:6,1:8),ORM(2,8)=8
"RTN","ORWLR3",50,0)
 . S (ORCNT,ORI)=0 F  S ORI=$O(^TMP("LRB",$J,ORI)) Q:ORI<1  S ID=^(ORI) D
"RTN","ORWLR3",51,0)
 .. S ORX(1)=$$FMTE^XLFDT(9999999-ORI,"5M") ;Assigned Date/Time
"RTN","ORWLR3",52,0)
 .. S ORX(2)=$P(ID,"^",3) ;Unit ID
"RTN","ORWLR3",53,0)
 .. S ORX(3)=$P(ID,"^",11) ; Product ID
"RTN","ORWLR3",54,0)
 .. S ORX(4)=$P(ID,"^",4) ;Component
"RTN","ORWLR3",55,0)
 .. S X=$S($P(ID,"^",7)="P":"Pos",$P(ID,"^",7)="N":"Neg",1:$P(ID,"^",7)) S ORX(5)=$P(ID,"^",6)_" "_X ;ABO/Rh
"RTN","ORWLR3",56,0)
 .. S ORX(6)=$P(ID,"^",2) ;Expiration Date
"RTN","ORWLR3",57,0)
 .. S ORX(7)=$P(ID,"^",10) ;Location
"RTN","ORWLR3",58,0)
 .. S ORX(8)=$P(ID,"^",9) ;Division NAME
"RTN","ORWLR3",59,0)
 .. I ORLOCAB D
"RTN","ORWLR3",60,0)
 ... S X=ORX(7)
"RTN","ORWLR3",61,0)
 ... I $L(X) S Y=$O(^SC("B",X,0)) I Y S X=$S($L($P($G(^SC(Y,0)),"^",2)):$P(^(0),"^",2),1:$E(X,1,7)) S ORX(7)=X ;Location
"RTN","ORWLR3",62,0)
 ... E  S ORX(7)=$E(X,1,7)
"RTN","ORWLR3",63,0)
 .. S X=$$LKUP^XUAF4(ORX(8)) I X,PARAM'=1,$D(ORPRTING) S X=$$NS^XUAF4(X) I $L($P(X,"^",2)) S ORX(8)=$P(X,"^",2) ;Get Division #
"RTN","ORWLR3",64,0)
 .. S ORCNT=ORCNT+1,^TMP("ORUTMP",$J,ORCNT)=ORX(1)_"^"_ORX(2)_"^"_ORX(3)_"^"_ORX(4)_"^"_ORX(5)_"^"_ORX(6)_"^"_ORX(7)_"^"_ORX(8)
"RTN","ORWLR3",65,0)
 .. F I=1:1:8 I $L(ORX(I))>ORM(I) S:ORM(I)<$L(ORX(I)) ORM(I)=$L(ORX(I)) ;Expand column width to fit data size
"RTN","ORWLR3",66,0)
 .. S C1=1,C2=C1+ORM(1),C3=C2+ORM(2),C4=C3+ORM(3),C5=C4+ORM(4),C6=C5+ORM(5),C7=C6+ORM(6),C8=C7+ORM(7)
"RTN","ORWLR3",67,0)
 .. S ROWSIZ=C8+$L(ORX(8))+8
"RTN","ORWLR3",68,0)
 .. I ROWSIZ>79,'ORSPLIT S:PARAM=0 ORSPLIT=0 S:PARAM=2 ORSPLIT=1 S:$D(ORPRTING) ORSPLIT=1
"RTN","ORWLR3",69,0)
 .. I ORSPLIT D
"RTN","ORWLR3",70,0)
 ... F I=1,2,4 I $L(ORX(I))>ORM(1,I) S ORM(1,I)=$L(ORX(I)) ;Expand 1st Row column width to fit data
"RTN","ORWLR3",71,0)
 ... I $L(ORX(3))>$L(ORX(2)) S:$L(ORX(3))>ORM(1,2) ORM(1,2)=$L(ORX(3)) ;Get larger of 2 stacked columns
"RTN","ORWLR3",72,0)
 ... I $L(ORX(2))>$L(ORX(3)) S:$L(ORX(2))>ORM(1,2) ORM(1,2)=$L(ORX(2))
"RTN","ORWLR3",73,0)
 ... F I=5:1:8 I $L(ORX(I))>ORM(2,I) S ORM(2,I)=$L(ORX(I)) ;Expand 2nd Row column width to fit data
"RTN","ORWLR3",74,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",75,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,"AVAILABLE/ISSUED UNITS:",.CCNT)
"RTN","ORWLR3",76,0)
 . I PARAM'=1 D
"RTN","ORWLR3",77,0)
 .. D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",78,0)
 .. I 'ORSPLIT D
"RTN","ORWLR3",79,0)
 ... F I=1:1:8 S ORM(I)=ORM(I)+1 ;Add 1 space between columns
"RTN","ORWLR3",80,0)
 ... S C1=1,C2=C1+ORM(1),C3=C2+ORM(2),C4=C3+ORM(3),C5=C4+ORM(4),C6=C5+ORM(5),C7=C6+ORM(6),C8=C7+ORM(7)
"RTN","ORWLR3",81,0)
 ... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",82,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,"Date Assigned",.CCNT)_$$S^ORU4(C2,.CCNT,"Unit ID",.CCNT)_$$S^ORU4(C3,.CCNT,"Prod ID",.CCNT)_$$S^ORU4(C4,.CCNT,"Component",.CCNT)_$$S^ORU4(C5,.CCNT,"ABO/Rh",.CCNT)
"RTN","ORWLR3",83,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,"Exp. Date",.CCNT)_$$S^ORU4(C7,.CCNT,$S(ORLOCAB:"Locale",1:"Location"),.CCNT)_$$S^ORU4(C8,.CCNT,$S($D(ORPRTING):"Div #",1:"Division"),.CCNT)
"RTN","ORWLR3",84,0)
 ... D LN
"RTN","ORWLR3",85,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,"-------------",.CCNT)_$$S^ORU4(C2,.CCNT,"-------",.CCNT)_$$S^ORU4(C3,.CCNT,"-------",.CCNT)_$$S^ORU4(C4,.CCNT,"---------",.CCNT)_$$S^ORU4(C5,.CCNT,"------",.CCNT)
"RTN","ORWLR3",86,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,"---------",.CCNT)_$$S^ORU4(C7,.CCNT,$S(ORLOCAB:"------",1:"--------"),.CCNT)_$$S^ORU4(C8,.CCNT,$S($D(ORPRTING):"-----",1:"--------"),.CCNT)
"RTN","ORWLR3",87,0)
 ... D LN
"RTN","ORWLR3",88,0)
 .. I ORSPLIT D
"RTN","ORWLR3",89,0)
 ... F I=1,2,4 S ORM(1,I)=ORM(1,I)+1 ;Add 1 spaces between columns 1st Row
"RTN","ORWLR3",90,0)
 ... F I=5:1:8 S ORM(2,I)=ORM(2,I)+1 ;Add 1 spaces between columns 2nd Row
"RTN","ORWLR3",91,0)
 ... S H1=1,H2=H1+ORM(1,1)+1,H3=H2+ORM(1,2),H4=H3+17,H5=H4+ORM(2,5),H6=H5+ORM(2,6),H7=H6+ORM(2,7),H8=H7+ORM(2,8)
"RTN","ORWLR3",92,0)
 ... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",93,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(H1,.CCNT,"Date Assigned",.CCNT)_$$S^ORU4(H2,.CCNT,"Unit/Prod #",.CCNT)_$$S^ORU4(H3,.CCNT,"Component",.CCNT)_$$S^ORU4($S(CCNT<29:29,1:H4),.CCNT,"ABO/Rh",.CCNT)
"RTN","ORWLR3",94,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(CCNT<46:46,1:H5),.CCNT,"Exp. Date",.CCNT)_$$S^ORU4($S(CCNT<57:57,1:H6),.CCNT,$S(ORLOCAB:"Locale",1:"Location"),.CCNT)
"RTN","ORWLR3",95,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(CCNT<65:65,1:H7),.CCNT,$S($D(ORPRTING):"Div #",1:"Division"),.CCNT)
"RTN","ORWLR3",96,0)
 ... D LN
"RTN","ORWLR3",97,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(H1,.CCNT,"---------------",.CCNT)_$$S^ORU4(H2,.CCNT,"-----------",.CCNT)_$$S^ORU4(H3,.CCNT,"---------",.CCNT)_$$S^ORU4($S(CCNT<29:29,1:H4),.CCNT,"------",.CCNT)
"RTN","ORWLR3",98,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(CCNT<46:46,1:H5),.CCNT,"----------",.CCNT)_$$S^ORU4($S(CCNT<57:57,1:H6),.CCNT,$S(ORLOCAB:"------",1:"--------"),.CCNT)
"RTN","ORWLR3",99,0)
 ... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(CCNT<65:65,1:H7),.CCNT,$S($D(ORPRTING):"-----",1:"--------"),.CCNT)
"RTN","ORWLR3",100,0)
 ... D LN
"RTN","ORWLR3",101,0)
 . S ORI=0 F  S ORI=$O(^TMP("ORUTMP",$J,ORI)) Q:'ORI  S ID=^(ORI) D
"RTN","ORWLR3",102,0)
 .. I PARAM'=1 D
"RTN","ORWLR3",103,0)
 ... I 'ORSPLIT D
"RTN","ORWLR3",104,0)
 .... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",105,0)
 .... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(C1,.CCNT,$P(ID,"^"),.CCNT)_$$S^ORU4(C2,.CCNT,$P(ID,"^",2),.CCNT)_$$S^ORU4(C3,.CCNT,$P(ID,"^",3),.CCNT)_$$S^ORU4(C4,.CCNT,$P(ID,"^",4),.CCNT)_$$S^ORU4(C5,.CCNT,$P(ID,"^",5),.CCNT)
"RTN","ORWLR3",106,0)
 .... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4(C6,.CCNT,$P(ID,"^",6),.CCNT)_$$S^ORU4(C7,.CCNT,$P(ID,"^",7),.CCNT)_$$S^ORU4(C8,.CCNT,$P(ID,"^",8),.CCNT)
"RTN","ORWLR3",107,0)
 ... I ORSPLIT D
"RTN","ORWLR3",108,0)
 .... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",109,0)
 .... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(H1,.CCNT,$P(ID,"^"),.CCNT)_$$S^ORU4(H2,.CCNT,$P(ID,"^",2),.CCNT)_$$S^ORU4(H3,.CCNT,$P(ID,"^",4),.CCNT)
"RTN","ORWLR3",110,0)
 .... D LN
"RTN","ORWLR3",111,0)
 .... S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(H1,.CCNT,"",.CCNT)_$$S^ORU4(H2,.CCNT,$P(ID,"^",3),.CCNT)_$$S^ORU4(H3,.CCNT,"",.CCNT)_$$S^ORU4($S(CCNT<29:29,1:H4),.CCNT,$P(ID,"^",5),.CCNT)
"RTN","ORWLR3",112,0)
 .... S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(CCNT<46:46,1:H5),.CCNT,$P(ID,"^",6),.CCNT)_$$S^ORU4($S(CCNT<57:57,1:H6),.CCNT,$P(ID,"^",7),.CCNT)_$$S^ORU4($S(CCNT<65:65,1:H7),.CCNT,$P(ID,"^",8),.CCNT)
"RTN","ORWLR3",113,0)
 .... D LN
"RTN","ORWLR3",114,0)
 .. I PARAM=1 D
"RTN","ORWLR3",115,0)
 ... D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",116,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Date/Time Assigned: "_$$S^ORU4(1,.CCNT,$P(ID,"^",1),.CCNT)
"RTN","ORWLR3",117,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Unit ID           : "_$$S^ORU4(1,.CCNT,$P(ID,"^",2),.CCNT)
"RTN","ORWLR3",118,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Product ID        : "_$$S^ORU4(1,.CCNT,$P(ID,"^",3),.CCNT)
"RTN","ORWLR3",119,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Component         : "_$$S^ORU4(1,.CCNT,$P(ID,"^",4),.CCNT)
"RTN","ORWLR3",120,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" ABO/Rh            : "_$$S^ORU4(1,.CCNT,$P(ID,"^",5),.CCNT)
"RTN","ORWLR3",121,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Expiration Date   : "_$$S^ORU4(1,.CCNT,$P(ID,"^",6),.CCNT)
"RTN","ORWLR3",122,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Location          : "_$$S^ORU4(1,.CCNT,$P(ID,"^",7),.CCNT)
"RTN","ORWLR3",123,0)
 ... D LN S ^TMP("ORLRC",$J,GCNT,0)=" Division          : "_$$S^ORU4(1,.CCNT,$P(ID,"^",8),.CCNT)
"RTN","ORWLR3",124,0)
 D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM)
"RTN","ORWLR3",125,0)
 K ^TMP("LRB",$J),^TMP("ORUTMP",$J)
"RTN","ORWLR3",126,0)
 ;Specimen Tests
"RTN","ORWLR3",127,0)
 D SPEC^ORWLR4
"RTN","ORWLR3",128,0)
 ;Component Requests
"RTN","ORWLR3",129,0)
 N A,F,%DT,Y,SORT,CNT
"RTN","ORWLR3",130,0)
 I $O(^TMP("VBDATA",$J,"COMPONENT REQUEST",0)) D
"RTN","ORWLR3",131,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",132,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",133,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,"COMPONENT REQUESTS:",.CCNT)
"RTN","ORWLR3",134,0)
 . D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",135,0)
 . S X="Component Type"
"RTN","ORWLR3",136,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,X,.CCNT)_$$S^ORU4(22,.CCNT,"Units",.CCNT)_$$S^ORU4(28,.CCNT,"Request date",.CCNT)_$$S^ORU4(48,.CCNT,"Date wanted",.CCNT)_$$S^ORU4(68,.CCNT,"Requestor",.CCNT)_$$S^ORU4(78,.CCNT,"By",.CCNT) D LN
"RTN","ORWLR3",137,0)
 . S Y="--------------"
"RTN","ORWLR3",138,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,Y,.CCNT)_$$S^ORU4(22,.CCNT,"-----",.CCNT)_$$S^ORU4(28,.CCNT,"------------",.CCNT)_$$S^ORU4(48,.CCNT,"-----------",.CCNT)_$$S^ORU4(68,.CCNT,"---------",.CCNT)_$$S^ORU4(78,.CCNT,"--",.CCNT) D LN
"RTN","ORWLR3",139,0)
 . S CNT=0,A=0 F  S A=$O(^TMP("VBDATA",$J,"COMPONENT REQUEST",A)) Q:'A  D
"RTN","ORWLR3",140,0)
 .. S F=^TMP("VBDATA",$J,"COMPONENT REQUEST",A),T="",%DT="T",X=$P(F,"^",3),Y=-1
"RTN","ORWLR3",141,0)
 .. I $L(X) D ^%DT
"RTN","ORWLR3",142,0)
 .. I Y'=-1 S T=Y D T^ORWLR2
"RTN","ORWLR3",143,0)
 .. S CNT=CNT+1,SORT=$S($P(F,"^",3):$P(F,"^",3),$P(F,"^",4):$P(F,"^",4),1:0),^TMP("ORTMP",$J,9999999-SORT,CNT,0)=F
"RTN","ORWLR3",144,0)
 . S ORI=0 F  S ORI=$O(^TMP("ORTMP",$J,ORI)) Q:'ORI  S CNT=0 F  S CNT=$O(^TMP("ORTMP",$J,ORI,CNT)) Q:'CNT  I $D(^(CNT,0)) S F=^(0) D
"RTN","ORWLR3",145,0)
 .. D LN
"RTN","ORWLR3",146,0)
 .. S T="",%DT="T",X=$P(F,"^",3),Y=-1
"RTN","ORWLR3",147,0)
 .. I $L(X) D ^%DT
"RTN","ORWLR3",148,0)
 .. I Y'=-1 S T=Y D T^ORWLR2
"RTN","ORWLR3",149,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,$E($P(F,"^"),1,25),.CCNT)_$$S^ORU4(22,.CCNT,$J($P(F,"^",2),3),.CCNT)_$$S^ORU4(28,.CCNT,T,.CCNT)
"RTN","ORWLR3",150,0)
 .. S T="",%DT="T",X=$P(F,"^",4),Y=-1
"RTN","ORWLR3",151,0)
 .. I $L(X) D ^%DT
"RTN","ORWLR3",152,0)
 .. I Y'=-1 S T=Y D T^ORWLR2
"RTN","ORWLR3",153,0)
 .. S X=$S($P(F,"^",6):$P(F,"^",6)_",",1:""),X=$S($L(X):$$GET1^DIQ(200,X,1),1:$P(F,"^",6))
"RTN","ORWLR3",154,0)
 .. S REQX=$S($P(F,"^",5):$P(F,"^",5)_",",1:""),REQX=$S($L(REQX):$$GET1^DIQ(200,REQX,1),1:$P(F,"^",5))
"RTN","ORWLR3",155,0)
 .. S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4(48,.CCNT,T,.CCNT)_$$S^ORU4(68,.CCNT,REQX,.CCNT)_$$S^ORU4(78,.CCNT,X,.CCNT)
"RTN","ORWLR3",156,0)
 K ^TMP("ORTMP",$J)
"RTN","ORWLR3",157,0)
 ;Transfused Units
"RTN","ORWLR3",158,0)
 D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR3",159,0)
 D TRAN^ORWLR2
"RTN","ORWLR3",160,0)
 Q
"RTN","ORWLR3",161,0)
CAN(OROOT,COL) ;Take data from OROOT and build ^TMP("ORCAN",$J)
"RTN","ORWLR3",162,0)
 N START,STOP,INPUT,OUTPUT,CCNT,CNT,WORD,ORX,NEX,CJ,CTR,ORX,ICNT
"RTN","ORWLR3",163,0)
 D SPACE(OROOT)
"RTN","ORWLR3",164,0)
 S CCNT=1,CNT=$S($O(^TMP("ORCAN",$J,0)):$O(^TMP("ORCAN",$J,99999999),-1),1:0)
"RTN","ORWLR3",165,0)
 S OUTPUT="",ORK=3
"RTN","ORWLR3",166,0)
 F  S ORK=$O(@OROOT@(ORK)) Q:'ORK  S X=@OROOT@(ORK) D
"RTN","ORWLR3",167,0)
 . I ORK=4 S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,CFAG,.CCNT)
"RTN","ORWLR3",168,0)
 . S INPUT=OUTPUT_X,START=$S($E(INPUT)=" ":2,1:1),OUTPUT="",STOP=$L(INPUT," ")
"RTN","ORWLR3",169,0)
 . I $L(INPUT) F ICNT=START:1:STOP S WORD=$P(INPUT," ",ICNT) D
"RTN","ORWLR3",170,0)
 .. I $L(WORD)<1,$L(OUTPUT) S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT="" Q
"RTN","ORWLR3",171,0)
 .. I ICNT=$L(INPUT," "),+$O(@OROOT@(ORK))<1,'$L($P(INPUT," ",ICNT+1)),$L(OUTPUT) D  Q
"RTN","ORWLR3",172,0)
 ... S OUTPUT=$S($L(OUTPUT):OUTPUT_" "_WORD,1:WORD),CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT=""
"RTN","ORWLR3",173,0)
 .. I $L(WORD)>COL D  S OUTPUT="" Q
"RTN","ORWLR3",174,0)
 ... I $L(WORD," ")=1 S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,WORD,.CCNT) Q
"RTN","ORWLR3",175,0)
 ... F CJ=1:COL S OUTPUT=$E(WORD,CJ,CJ+99) Q:'$L(OUTPUT)  S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT)
"RTN","ORWLR3",176,0)
 .. I $L(OUTPUT)+$L(WORD)>COL S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT="" D  Q
"RTN","ORWLR3",177,0)
 ... I $L(WORD)>COL D
"RTN","ORWLR3",178,0)
 .... I $L(WORD," ")=1 S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,WORD,.CCNT) Q
"RTN","ORWLR3",179,0)
 .... F CJ=1:COL S OUTPUT=$E(WORD,CJ,CJ+99) Q:'$L(OUTPUT)  S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT)
"RTN","ORWLR3",180,0)
 .... S OUTPUT=""
"RTN","ORWLR3",181,0)
 ... E  S OUTPUT=OUTPUT_$S($L(OUTPUT):" ",1:"")_WORD D
"RTN","ORWLR3",182,0)
 .... I ICNT=$L(INPUT," ") D
"RTN","ORWLR3",183,0)
 ..... I +$O(@OROOT@(ORK))<1 S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT="" Q
"RTN","ORWLR3",184,0)
 .. S OUTPUT=$S($L(OUTPUT):OUTPUT_" "_WORD,1:WORD)
"RTN","ORWLR3",185,0)
 .. I $L(OUTPUT)>COL S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT=""
"RTN","ORWLR3",186,0)
 .. I ICNT=$L(INPUT," ") D
"RTN","ORWLR3",187,0)
 ... I +$O(@OROOT@(ORK))<1 S CNT=CNT+1,^TMP("ORCAN",$J,CNT,0)=$$S^ORU4(1,.CCNT,OUTPUT,.CCNT),OUTPUT=""
"RTN","ORWLR3",188,0)
 Q
"RTN","ORWLR3",189,0)
SPACE(OROOT) ;Move Trailing spaces to next line
"RTN","ORWLR3",190,0)
 N ORI,CTR,X
"RTN","ORWLR3",191,0)
 S ORI=0
"RTN","ORWLR3",192,0)
 F  S ORI=$O(@OROOT@(ORI)) Q:'ORI  D
"RTN","ORWLR3",193,0)
 . S X=$RE(@OROOT@(ORI)),CTR=0 F  S:$E(X)=" " X=$E(X,2,999),CTR=CTR+1 Q:$E(X)'=" "  Q:'$L(X)  ;trailing spaces removed
"RTN","ORWLR3",194,0)
 . I CTR S @OROOT@(ORI)=$RE(X) I $O(@OROOT@(ORI)) S NEX=$O(@OROOT@(ORI)),ORX(NEX)=$E("               ",1,CTR)_ORX(NEX) ;move spaces to front of next line
"RTN","ORWLR3",195,0)
 Q
"RTN","ORWLR3",196,0)
LN ;Increment counts
"RTN","ORWLR3",197,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWLR3",198,0)
 Q
"RTN","ORWLR3",199,0)
TRIM(X) ;Trim leading and trailing spaces
"RTN","ORWLR3",200,0)
 S X=$RE(X) F  S:$E(X)=" " X=$E(X,2,999) Q:$E(X)'=" "  Q:'$L(X)  ;trail
"RTN","ORWLR3",201,0)
 S X=$RE(X) F  S:$E(X)=" " X=$E(X,2,999) Q:$E(X)'=" "  Q:'$L(X)  ;lead
"RTN","ORWLR3",202,0)
 Q X
"RTN","ORWLR4")
0^10^B35348336^B61036559
"RTN","ORWLR4",1,0)
ORWLR4 ; slc/dcm - VBEC Blood Bank Report cont. ;1/15/09  06:56
"RTN","ORWLR4",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**309,332**;Dec 17, 1997;Build 44
"RTN","ORWLR4",3,0)
SPEC ;Specimen Tests (cont.) from ORWLR3
"RTN","ORWLR4",4,0)
 D HORZ
"RTN","ORWLR4",5,0)
 Q
"RTN","ORWLR4",6,0)
HORZ ;Horizontal display of results
"RTN","ORWLR4",7,0)
 Q:'$O(^TMP("VBDATA",$J,"SPECIMEN",0))
"RTN","ORWLR4",8,0)
 K ^TMP("ORTMP",$J),^TMP("ORCOM",$J)
"RTN","ORWLR4",9,0)
 N SCOL,ALPHA,ORI,ORJ,TST,ORT,CI,CJ,CX,CY,CZ,X,Y,ORY,ORAY,CNT,IDT,ID,ORX,ORCL,CNTR,BUMP,CNUM,ORTM,COM
"RTN","ORWLR4",10,0)
 N C,I,ORCOL,ORCNT,ORINIT,ORNAM,ORNAME,C1,C2,C3,C4,C6,C8,LINE,FRONT,COMSP,ORDIV,ARRAY
"RTN","ORWLR4",11,0)
 K ^TMP("ORTMP",$J)
"RTN","ORWLR4",12,0)
 F ORI=1:1 S X=$P($T(TXT+ORI),";",3) Q:X=""  S ORAY(X)=ORI
"RTN","ORWLR4",13,0)
 S SCOL=19,ORI="",BUMP=0,CNUM="",CFAG="",ALPHA=0,ORTM=$S(ALPHA:96,1:0),C=1,ORINIT="5,5,5,6,7,6,7,6,7" ;Change Alpha to 1 for Alpha comment flag
"RTN","ORWLR4",14,0)
 F I=3,3,3,5,5,4,5,5,5,0,8 S C=C+1,ORCOL(C)=I ;Initialize column size
"RTN","ORWLR4",15,0)
 F  S ORI=$O(^TMP("VBDATA",$J,"SPECIMEN",ORI),-1) Q:ORI=""  S ID=^(ORI) I $L($P(ID,"^",8)),$L($P(ID,"^",5)) D
"RTN","ORWLR4",16,0)
 . ; ID=CPRS Order#^Division^Tech ID^Test Name^Print Name^Requestor ID^Result^Date/time
"RTN","ORWLR4",17,0)
 . S IDT=9999999-$P(ID,"^",8)
"RTN","ORWLR4",18,0)
 . I $P(ID,"^",7)="No Agglutination" S $P(ID,"^",7)="0" ; Translate result: "No Agg..." to 0 (zero)
"RTN","ORWLR4",19,0)
 . I '$D(^TMP("ORTMP",$J,IDT)) S ^(IDT)=ORI
"RTN","ORWLR4",20,0)
 . D F4^XUAF4($$STRIP^XLFSTR($P(ID,"^",2)," "),.ARRAY,"","")
"RTN","ORWLR4",21,0)
 . S ORDIV=$S($G(ARRAY("NAME"))]"":$G(ARRAY("NAME")),1:"Unknown")
"RTN","ORWLR4",22,0)
 . S $P(^TMP("ORTMP",$J,IDT),"^",12)=$S($P(ID,"^",2)&'$D(ORPRTING):ORDIV,1:$P(ID,"^",2))
"RTN","ORWLR4",23,0)
 . I $D(ORAY($P(ID,"^",5))) S $P(^TMP("ORTMP",$J,IDT),"^",ORAY($P(ID,"^",5))+1)=$P(ID,"^",7),^(IDT,"IFN",ORI)=$P(ID,"^",5)
"RTN","ORWLR4",24,0)
 . I $O(^TMP("VBDATA",$J,"SPECIMEN",ORI,3))>3 D  ;Flag canned comment
"RTN","ORWLR4",25,0)
 .. S CNTR=$S($O(^TMP("ORCOM",$J,99999999),-1):$O(^(99999999),-1),1:0),BUMP=0,OR4=$G(^TMP("VBDATA",$J,"SPECIMEN",ORI,4))
"RTN","ORWLR4",26,0)
 .. S ORK="" F  S ORK=$O(^TMP("ORCOM",$J,ORK)) Q:'ORK  I ^(ORK)=OR4 S BUMP=ORK Q
"RTN","ORWLR4",27,0)
 .. I BUMP S CNUM=$S(ALPHA:$C(BUMP+96),1:BUMP),CFAG=$S($L(CFAG)&(CFAG'[CNUM):CFAG_",("_CNUM_")",1:"("_CNUM_")"),$P(^TMP("ORTMP",$J,IDT),"^",11)=CFAG Q
"RTN","ORWLR4",28,0)
 .. I $L(OR4) S CNTR=CNTR+1,^TMP("ORCOM",$J,CNTR)=^TMP("VBDATA",$J,"SPECIMEN",ORI,4)
"RTN","ORWLR4",29,0)
 .. S ORTM=ORTM+1,CNUM=$S(ALPHA:$C(ORTM),1:ORTM),CFAG=$S($L(CFAG)&(CFAG'[CNUM):CFAG_",("_CNUM_")",1:"("_CNUM_")"),$P(^TMP("ORTMP",$J,IDT),"^",11)=CFAG
"RTN","ORWLR4",30,0)
 . D:'$G(BUMP) CAN^ORWLR3("^TMP(""VBDATA"",$J,""SPECIMEN"",ORI)",79)
"RTN","ORWLR4",31,0)
 S ORI="" F  S ORI=$O(^TMP("ORTMP",$J,ORI)) Q:ORI=""  S X=^(ORI) F I=2:1:10 S:$L($P(X,"^",I))>ORCOL(I) ORCOL(I)=($L($P(X,"^",I)))
"RTN","ORWLR4",32,0)
 S ORCNT=SCOL+$L(CFAG),ORCL="",ORI="",$P(ORCL,";")=ORCNT+1
"RTN","ORWLR4",33,0)
 F  S ORI=$O(ORCOL(ORI)) Q:ORI=""  S $P(ORCL,";",ORI)=(ORCOL(ORI)+ORCNT+2),ORCNT=$P(ORCL,";",ORI)
"RTN","ORWLR4",34,0)
 D LINE^ORU4("^TMP(""ORLRC"",$J)",GIOM),LN
"RTN","ORWLR4",35,0)
 S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(0,.CCNT,"DIAGNOSTIC TESTS:",.CCNT) D LN
"RTN","ORWLR4",36,0)
 S C8=$$COL(5,10),C4=$$COL(2,4)
"RTN","ORWLR4",37,0)
 S X="",$P(X," ",C4)="",I="",$P(I," ",19)="",FRONT=$E("            ",1,$L(CFAG))_I_X
"RTN","ORWLR4",38,0)
 S I=C8-7\2,X="",$P(X,"-",I)="",Y="|"_X_" DAT "_X_"|",Y=FRONT_Y
"RTN","ORWLR4",39,0)
 S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,Y,.CCNT) D LN
"RTN","ORWLR4",40,0)
 S C1=$$COL(5,6),C2=$$COL(7,8),C3=$$COL(9,10),LINE=FRONT
"RTN","ORWLR4",41,0)
 S I=C1-7/2,X="",$P(X,"-",I)="",Y="|"_X_" Poly "_X_"|  ",LINE=LINE_Y
"RTN","ORWLR4",42,0)
 S I=C2-7/2,X="",$P(X,"-",I)="",Y="|"_X_" IgG "_X_"|  ",LINE=LINE_Y
"RTN","ORWLR4",43,0)
 S I=C3-7/2,X="",$P(X,"-",I)="",Y="|"_X_" Comp "_X_"|",LINE=LINE_Y
"RTN","ORWLR4",44,0)
 S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,LINE,.CCNT) D LN
"RTN","ORWLR4",45,0)
 S I=1,X=$E("            ",1,$L(CFAG))_"Date/Time        ",ORY=$E("            ",1,$L(CFAG))_"                     "
"RTN","ORWLR4",46,0)
 F ORI="ABO","Rh ","ABS","Test","Intrp","Test ","Intrp","Test","Intrp",$S($D(ORPRTING):"Div #",1:"Division") S I=I+1,X=X_ORI_$E(ORY,1,ORCOL(I)-$L(ORI)+$S(I>3:2,1:1))
"RTN","ORWLR4",47,0)
 S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,X,.CCNT) D LN
"RTN","ORWLR4",48,0)
 S I=1,X=$E("            ",1,$L(CFAG))_"---------------  "
"RTN","ORWLR4",49,0)
 F ORI="---","---","---","----","-----","----","-----","----","-----",$S($D(ORPRTING):"-----",1:"--------") S I=I+1,X=X_ORI_$E(ORY,1,ORCOL(I)-$L(ORI)+$S(I>3:2,1:1))
"RTN","ORWLR4",50,0)
 S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(2,.CCNT,X,.CCNT) D LN
"RTN","ORWLR4",51,0)
 S ORJ="",COMSP=$S($L(CFAG):7,1:3)
"RTN","ORWLR4",52,0)
 F  S ORJ=$O(^TMP("ORTMP",$J,ORJ)) Q:ORJ=""  S ORX=^(ORJ) D
"RTN","ORWLR4",53,0)
 . S COM=$P(ORX,"^",11)
"RTN","ORWLR4",54,0)
 . D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(1,.CCNT,COM_$S($L(COM):$E("       ",1,$L(COM)-5),1:" "),.CCNT)
"RTN","ORWLR4",55,0)
 . S T=9999999-ORJ,ORY=$E("            ",1,$L(CFAG)),T=$$FMTE^XLFDT(T,"5MZ"),T=$S($L(COM):" "_T,1:ORY_T)
"RTN","ORWLR4",56,0)
 . S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($L(COM)+1,.CCNT,T,.CCNT) ;,ORCL="28;31;36;41;59;77;95;113;131;149;156"
"RTN","ORWLR4",57,0)
 . F ORT=1:1:9,11 S ^TMP("ORLRC",$J,GCNT,0)=^TMP("ORLRC",$J,GCNT,0)_$$S^ORU4($S(ORT=11:$P(ORCL,";",ORT)-4,ORT=1:$P(ORCL,";",ORT),ORT=2:$P(ORCL,";",ORT)-1,1:$P(ORCL,";",ORT)-2),.CCNT,$P($P(ORX,"^",2,99),"^",ORT),.CCNT)
"RTN","ORWLR4",58,0)
 . S ORI="",ORNAME="" F  S ORI=$O(^TMP("ORTMP",$J,ORJ,"IFN",ORI)) Q:ORI=""  S ORNAM=^(ORI) D
"RTN","ORWLR4",59,0)
 .. F I=1:1 S X=$P($T(TXT+I),";",3) Q:X=""  I X=ORNAM S ORNAME=$P($T(TXT+I),";",4) Q
"RTN","ORWLR4",60,0)
 .. S ORK="",CZ="" F  S ORK=$O(^TMP("VBDATA",$J,"SPECIMEN",ORI,ORK)) Q:'ORK  S CX=CZ_^(ORK) I $L(CX) D
"RTN","ORWLR4",61,0)
 ... I ORK>3 Q
"RTN","ORWLR4",62,0)
 ... S CZ="" F CI=1:1:$L(CX," ") S CY=$P(CX," ",CI) D
"RTN","ORWLR4",63,0)
 .... I $L(CY)>52 D  S CZ="" Q
"RTN","ORWLR4",64,0)
 ..... F CJ=1:52 S CZ=$E(CY,CJ,CJ+79) Q:'$L(CZ)  D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT)
"RTN","ORWLR4",65,0)
 .... I $L(CZ)+$L(CY)>52 D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT),CZ="" D  Q
"RTN","ORWLR4",66,0)
 ..... I $L(CY)>52 D
"RTN","ORWLR4",67,0)
 ...... F CJ=1:52 S CZ=$E(CY,CJ,CJ+79) Q:'$L(CZ)  D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT)
"RTN","ORWLR4",68,0)
 ...... S CZ=""
"RTN","ORWLR4",69,0)
 ..... E  S CZ=CY D
"RTN","ORWLR4",70,0)
 ...... I CI=$L(CX," ") D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT),CZ=""
"RTN","ORWLR4",71,0)
 .... S CZ=$S($L(CZ):CZ_" "_CY,1:CY) I $L(CZ)>80 D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT),CZ=""
"RTN","ORWLR4",72,0)
 .... I CI=$L(CX," ") D LN S ^TMP("ORLRC",$J,GCNT,0)=$$S^ORU4(COMSP,.CCNT,"Comment ("_ORNAME_"): "_CZ,.CCNT),CZ=""
"RTN","ORWLR4",73,0)
 I $O(^TMP("ORCAN",$J,0)) D
"RTN","ORWLR4",74,0)
 . D LN S ^TMP("ORLRC",$J,GCNT,0)=" " D LN S ^TMP("ORLRC",$J,GCNT,0)="   ----- STANDARD COMMENTS FOR DIAGNOSTIC TESTS ABOVE -----"
"RTN","ORWLR4",75,0)
 . S ORI="" F  S ORI=$O(^TMP("ORCAN",$J,ORI)) Q:'ORI  I $D(^(ORI,0)) D LN S X=^(0),^TMP("ORLRC",$J,GCNT,0)=X
"RTN","ORWLR4",76,0)
 K ^TMP("ORTMP",$J),^TMP("ORCAN",$J)
"RTN","ORWLR4",77,0)
 Q
"RTN","ORWLR4",78,0)
COL(A,B) ; Calculate Column Width
"RTN","ORWLR4",79,0)
 ;A=Beginning column, B=Ending Column, COL=Width of column (depends on length of data)
"RTN","ORWLR4",80,0)
 Q:'$G(A) 1 Q:'$G(B) 1
"RTN","ORWLR4",81,0)
 N I,C
"RTN","ORWLR4",82,0)
 S C=0 F I=A:1:B S C=C+ORCOL(I)+2
"RTN","ORWLR4",83,0)
 Q C
"RTN","ORWLR4",84,0)
LN ;Increment counts
"RTN","ORWLR4",85,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWLR4",86,0)
 Q
"RTN","ORWLR4",87,0)
TXT ;Test Names passed in from VBECS API - Sequence of this list is significant
"RTN","ORWLR4",88,0)
 ;;ABO Interp;ABO
"RTN","ORWLR4",89,0)
 ;;Rh Interp;Rh
"RTN","ORWLR4",90,0)
 ;;Antibody Screen Interp;ABS
"RTN","ORWLR4",91,0)
 ;;DAT Poly AHG;DAT Poly
"RTN","ORWLR4",92,0)
 ;;DAT Poly Interp;Poly INTRP
"RTN","ORWLR4",93,0)
 ;;DAT IgG  AHG;DAT IgG
"RTN","ORWLR4",94,0)
 ;;DAT IgG Interp;IgG INTRP
"RTN","ORWLR4",95,0)
 ;;DAT Comp AHG;DAT Comp
"RTN","ORWLR4",96,0)
 ;;DAT Comp Interp;Comp INTRP
"RTN","ORWLR4",97,0)
 ;;
"RTN","ORWLR4",98,0)
 Q
"RTN","ORWRP2")
0^13^B30528782^B11410581
"RTN","ORWRP2",1,0)
ORWRP2 ; dcm/slc - Health Summary adhoc RPC's
"RTN","ORWRP2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,109,212,309,332**Dec 17, 1997;;Build 44
"RTN","ORWRP2",3,0)
BB ;Continuation of Blood Bank Report
"RTN","ORWRP2",4,0)
 N DFN,ORY,ORSBHEAD,GCNT,GIOM
"RTN","ORWRP2",5,0)
 S DFN=ORDFN,GCNT=0,GIOM=80
"RTN","ORWRP2",6,0)
 K ^TMP("LRC",$J)
"RTN","ORWRP2",7,0)
 S ROOT=$NA(^TMP("LRC",$J))
"RTN","ORWRP2",8,0)
 D BLEG
"RTN","ORWRP2",9,0)
 Q
"RTN","ORWRP2",10,0)
BLEG ;Legacy VISTA Blood Bank Report
"RTN","ORWRP2",11,0)
 S ORSBHEAD("BLOOD BANK")=""
"RTN","ORWRP2",12,0)
 D EN^LR7OSUM(.ORY,DFN,,,,GIOM,.ORSBHEAD),TRAN
"RTN","ORWRP2",13,0)
 I '$O(^TMP("LRC",$J,0)) S GCNT=GCNT+1,^TMP("LRC",$J,GCNT,0)="",GCNT=GCNT+1,^TMP("LRC",$J,GCNT,0)="No Blood Bank report available..."
"RTN","ORWRP2",14,0)
 Q
"RTN","ORWRP2",15,0)
COMP(ORY) ;Get ADHOC sub components (FILE 142.1)
"RTN","ORWRP2",16,0)
 ;RPC => ORWRP2 HS COMPONENTS
"RTN","ORWRP2",17,0)
 ;Y(i)=(1)I;IFN^(2)Component Name [Abb]^(3)Occ Limit^(4)Time Limit^(5)Header Name^
"RTN","ORWRP2",18,0)
 ;     (6)Hosp Loc Disp^(7)ICD Text Disp^(8)Prov Narr Disp^(9)Summary Order
"RTN","ORWRP2",19,0)
 D COMP^GMTSADH5(.ORY)
"RTN","ORWRP2",20,0)
 Q
"RTN","ORWRP2",21,0)
 ;
"RTN","ORWRP2",22,0)
COMPABV(ORY) ;Get ADHOD sub components listed by Abbreviation
"RTN","ORWRP2",23,0)
 N I,X,X1,X2,X3
"RTN","ORWRP2",24,0)
 D COMP^GMTSADH5(.ORY)
"RTN","ORWRP2",25,0)
 S I=0
"RTN","ORWRP2",26,0)
 F  S I=$O(ORY(I)) Q:'I  S X=ORY(I) D
"RTN","ORWRP2",27,0)
 . S X1=$P($P(X,"^",2),"["),X1=$E(X1,1,$L(X1)-1),X2=$P($P(X,"^",2),"[",2),X2=$E(X2,1,$L(X2)-1)
"RTN","ORWRP2",28,0)
 . S X3=X2_"   - "_$P(X,"^",5)_" ",$P(ORY(I),"^",2)=X3
"RTN","ORWRP2",29,0)
 Q
"RTN","ORWRP2",30,0)
COMPDISP(ORY) ;Get ADHOD sub components listed by Display Name
"RTN","ORWRP2",31,0)
 N I,X,X1,X2,X3
"RTN","ORWRP2",32,0)
 D COMP^GMTSADH5(.ORY)
"RTN","ORWRP2",33,0)
 S I=0
"RTN","ORWRP2",34,0)
 F  S I=$O(ORY(I)) Q:'I  S X=ORY(I) D
"RTN","ORWRP2",35,0)
 . S X1=$P($P(X,"^",2),"["),X1=$E(X1,1,$L(X1)-1),X2=$P($P(X,"^",2),"[",2),X2=$E(X2,1,$L(X2)-1)
"RTN","ORWRP2",36,0)
 . S X3=$P(X,"^",5)_"   ["_X2_"]",$P(ORY(I),"^",2)=X3
"RTN","ORWRP2",37,0)
 Q
"RTN","ORWRP2",38,0)
COMPSUB(ORY,ORSUB) ;Get subitems from a predefined Adhoc component
"RTN","ORWRP2",39,0)
 I '$L($T(COMPSUB^GMTSADH5)) Q
"RTN","ORWRP2",40,0)
 D COMPSUB^GMTSADH5(.ORY,ORSUB)
"RTN","ORWRP2",41,0)
 Q
"RTN","ORWRP2",42,0)
 ;
"RTN","ORWRP2",43,0)
SAVLKUP(OK,VAL) ;save Adhoc lookup selection
"RTN","ORWRP2",44,0)
 N ORERR
"RTN","ORWRP2",45,0)
 S OK=""
"RTN","ORWRP2",46,0)
 D EN^XPAR(DUZ_";VA(200,","ORWRP ADHOC LOOKUP",1,VAL,.ORERR)
"RTN","ORWRP2",47,0)
 I ORERR S OK=VAL_":"_ORERR
"RTN","ORWRP2",48,0)
 Q
"RTN","ORWRP2",49,0)
GETLKUP(ORY) ;Get Adhoc lookup selection
"RTN","ORWRP2",50,0)
 S ORY=$$GET^XPAR("ALL","ORWRP ADHOC LOOKUP",1,"I")
"RTN","ORWRP2",51,0)
 Q
"RTN","ORWRP2",52,0)
FILES(ORY,ORCOMP) ;Get Files to select from for a component
"RTN","ORWRP2",53,0)
 ;RPC => ORWRP2 HS COMP FILES
"RTN","ORWRP2",54,0)
 D FILES^GMTSADH5(.ORY,ORCOMP)
"RTN","ORWRP2",55,0)
 Q
"RTN","ORWRP2",56,0)
 ;
"RTN","ORWRP2",57,0)
FILESEL(OROOT,ORFILE,ORFROM,ORDIR) ;Get file entries for Combobox
"RTN","ORWRP2",58,0)
 ;RPC => ORWRP2 HS FILE LOOKUP
"RTN","ORWRP2",59,0)
 D FILESEL^GMTSADH5(.OROOT,ORFILE,ORFROM,ORDIR)
"RTN","ORWRP2",60,0)
 Q
"RTN","ORWRP2",61,0)
 ;
"RTN","ORWRP2",62,0)
REPORT(OROOT,ORCOMPS,ORDFN) ;Build Report from array of Components passed in COMPS
"RTN","ORWRP2",63,0)
 ;RPC => ORWRP2 HS REPORT TEXT
"RTN","ORWRP2",64,0)
 ;ORCOMPS(i)=array of subcomponents chosen, value is pointer at ^GMT(142,DA(1),1,DA)
"RTN","ORWRP2",65,0)
 Q:'$G(ORDFN)
"RTN","ORWRP2",66,0)
 N GMTSEGC,GMTSEG,ORGMTSEG,ORSEGC,ORSEGI
"RTN","ORWRP2",67,0)
 K ^TMP("ORDATA",$J)
"RTN","ORWRP2",68,0)
 D REPORT^GMTSADH5(.ORGMTSEG,.ORSEGC,.ORSEGI,.ORCOMPS,.ORDFN)
"RTN","ORWRP2",69,0)
 Q:'$O(ORGMTSEG(0))
"RTN","ORWRP2",70,0)
 D START^ORWRP(80,"REPORT1^ORWRP2(.ORGMTSEG,.ORSEGC,.ORSEGI,ORDFN)")
"RTN","ORWRP2",71,0)
 S OROOT=$NA(^TMP("ORDATA",$J,1))
"RTN","ORWRP2",72,0)
 Q
"RTN","ORWRP2",73,0)
REPORT1(GMTSEG,GMTSEGC,GMTSEGI,DFN) ;
"RTN","ORWRP2",74,0)
 N GMTS,GMTS1,GMTS2,GMTSAGE,GMTSDOB,GMTSDTM,GMTSLO,GMTSLPG,GMTSPHDR,GMTSPNM,GMTSRB,GMTSSN,GMTSWRD
"RTN","ORWRP2",75,0)
 N CNT,INC,ORVP,ROOT,SEX,VADM,VAERR,VAIN
"RTN","ORWRP2",76,0)
 S ORVP=DFN
"RTN","ORWRP2",77,0)
 D ADHOC^ORPRS13
"RTN","ORWRP2",78,0)
 Q
"RTN","ORWRP2",79,0)
 ;
"RTN","ORWRP2",80,0)
SUBITEM(ORY,ORTEST) ;Get Subitems for a Test Panel
"RTN","ORWRP2",81,0)
 ;RPC => ORWRP2 HS SUBITEMS
"RTN","ORWRP2",82,0)
 D SUBITEM^GMTSADH5(.ORY,ORTEST)
"RTN","ORWRP2",83,0)
 Q
"RTN","ORWRP2",84,0)
PREPORT(OROOT,ORCOMPS,ORDFN) ;Build Report & Print
"RTN","ORWRP2",85,0)
 ;Called from File|Print on Reports Tab after selecting ADHOC Health Summary
"RTN","ORWRP2",86,0)
 ;COMPS(i)=array of subcomponents chosen, value is pointer at ^GMT(142,DA(1),1,DA)
"RTN","ORWRP2",87,0)
 Q:'$G(ORDFN)
"RTN","ORWRP2",88,0)
 N GMTSEGC,GMTSEG,ORGMTSEG,ORSEGC,ORSEGI
"RTN","ORWRP2",89,0)
 D REPORT^GMTSADH5(.ORGMTSEG,.ORSEGC,.ORSEGI,.ORCOMPS,.ORDFN)
"RTN","ORWRP2",90,0)
 Q:'$O(ORGMTSEG(0))
"RTN","ORWRP2",91,0)
 M GMTSEG=ORGMTSEG,GMTSEGC=ORSEGC,GMTSEGI=ORSEGI
"RTN","ORWRP2",92,0)
 N GMTS,GMTS1,GMTS2,GMTSAGE,GMTSDOB,GMTSDTM,GMTSLO,GMTSLPG,GMTSPHDR,GMTSPNM,GMTSRB,GMTSSN,GMTSWRD
"RTN","ORWRP2",93,0)
 N CNT,INC,ORVP,ROOT,SEX,VADM,VAERR,VAIN
"RTN","ORWRP2",94,0)
 S ORVP=ORDFN
"RTN","ORWRP2",95,0)
 D ADHOC^ORPRS13
"RTN","ORWRP2",96,0)
 Q
"RTN","ORWRP2",97,0)
TRAN ;Get Transfused Units
"RTN","ORWRP2",98,0)
 N LRDFN,IDT,CNTR,TR,PN,PRODUCT,IX,GMI,X,BPN
"RTN","ORWRP2",99,0)
 S:'$D(GMTS1) GMTS1=6666666 S:'$D(GMTS2) GMTS2=9999999
"RTN","ORWRP2",100,0)
 K ^TMP("LRT",$J)
"RTN","ORWRP2",101,0)
 Q:'$D(^DPT(DFN,"LR"))  S LRDFN=+^DPT(DFN,"LR"),IDT=GMTS1-1
"RTN","ORWRP2",102,0)
 I '$D(^LR(LRDFN)) Q
"RTN","ORWRP2",103,0)
 S IDT=0 F  S IDT=$O(^LR(LRDFN,1.6,IDT)) Q:+IDT'>0  D
"RTN","ORWRP2",104,0)
 . S TR=$G(^LR(LRDFN,1.6,IDT,0)) D SET
"RTN","ORWRP2",105,0)
 S IDT=0 F  S IDT=$O(CNTR(IDT)) Q:+IDT'>0  D
"RTN","ORWRP2",106,0)
 . S ^TMP("LRT",$J,IDT)=9999999-IDT_U,PN=0
"RTN","ORWRP2",107,0)
 . F  S PN=$O(CNTR(IDT,PN)) Q:PN'>0  D
"RTN","ORWRP2",108,0)
 .. S PRODUCT=$G(^LAB(66,+PN,0)),^TMP("LRT",$J,$P(PRODUCT,U,2))=$P(PRODUCT,U)
"RTN","ORWRP2",109,0)
 .. S ^TMP("LRT",$J,IDT)=^TMP("LRT",$J,IDT)_CNTR(IDT,PN)_"\"_$P(PRODUCT,U,2)_";"
"RTN","ORWRP2",110,0)
 Q:'$O(^TMP("LRT",$J,0))
"RTN","ORWRP2",111,0)
 S GCNT=+$O(^TMP("LRC",$J,999999999),-1)
"RTN","ORWRP2",112,0)
 D LINE,LN
"RTN","ORWRP2",113,0)
 S ^TMP("LRC",$J,GCNT,0)=$$S(0,CCNT,"Transfused Units"),IX=""
"RTN","ORWRP2",114,0)
 F  S IX=$O(^TMP("LRT",$J,IX)) Q:IX=""  D
"RTN","ORWRP2",115,0)
 . S GMR=^TMP("LRT",$J,IX),TD=$$FMTE^XLFDT(+GMR)
"RTN","ORWRP2",116,0)
 . Q:TD=0
"RTN","ORWRP2",117,0)
 . S GMA(1)=$P(GMR,U,2),BPN=$L(GMA(1),";")
"RTN","ORWRP2",118,0)
 . I $P(GMA(1),";",BPN)="" S BPN=BPN-1
"RTN","ORWRP2",119,0)
 . F GMI=2:1:BPN S GMA(GMI)="("_$P($P(GMA(1),";",GMI),"\")_") "_$P($P(GMA(1),";",GMI),"\",2)
"RTN","ORWRP2",120,0)
 . S GMA(1)="("_$P($P(GMA(1),";",1),"\")_") "_$P($P(GMA(1),";",1),"\",2)
"RTN","ORWRP2",121,0)
 . D WRT
"RTN","ORWRP2",122,0)
 D KEY
"RTN","ORWRP2",123,0)
 K ^TMP("LRT",$J)
"RTN","ORWRP2",124,0)
 Q
"RTN","ORWRP2",125,0)
WRT ; Writes the Transfusion Record for each day
"RTN","ORWRP2",126,0)
 N GML,GMI1,GMI2,GMM,GMJ,CL
"RTN","ORWRP2",127,0)
 S GMM=$S(BPN#4:1,1:0),GML=BPN\4+GMM
"RTN","ORWRP2",128,0)
 D LN S ^TMP("LRC",$J,GCNT,0)=$$S(2,.CCNT,TD)
"RTN","ORWRP2",129,0)
 F GMI1=1:1:GML D
"RTN","ORWRP2",130,0)
 . F GMI2=1:1:($S((GMI1=GML)&(BPN#4):BPN#4,1:4)) D
"RTN","ORWRP2",131,0)
 .. S GMJ=((GMI1-1)*4)+GMI2,CL=(((GMI2-1)*15)+14)
"RTN","ORWRP2",132,0)
 .. S ^TMP("LRC",$J,GCNT,0)=$G(^TMP("LRC",$J,GCNT,0))_$$S(CL,.CCNT,GMA(GMJ))
"RTN","ORWRP2",133,0)
 .. I $S(GMI2#4=0:1,GMI2=BPN:1,GMI2+(4*(GMI1-1))=BPN:1,1:0) D LN
"RTN","ORWRP2",134,0)
 Q
"RTN","ORWRP2",135,0)
SET ; Save Appropriate Data
"RTN","ORWRP2",136,0)
 N COMP,UNITS,TDT,ITDT
"RTN","ORWRP2",137,0)
 S TDT=9999999-IDT,ITDT=9999999-$P(TDT,".")
"RTN","ORWRP2",138,0)
 S UNITS=+$P(TR,U,7) S:UNITS'>0 UNITS=1
"RTN","ORWRP2",139,0)
 S CNTR(ITDT,+$P(TR,U,2))=+$G(CNTR(ITDT,+$P(TR,U,2)))+UNITS
"RTN","ORWRP2",140,0)
 Q
"RTN","ORWRP2",141,0)
KEY ;
"RTN","ORWRP2",142,0)
 I $O(^TMP("LRT",$J,"A"))'="" D
"RTN","ORWRP2",143,0)
 . D LN
"RTN","ORWRP2",144,0)
 . S ^TMP("LRC",$J,GCNT,0)=$$S(0,CCNT,"  Blood Product Key: ")
"RTN","ORWRP2",145,0)
 S GMI="A" F  S GMI=$O(^TMP("LRT",$J,GMI)) Q:GMI=""  D
"RTN","ORWRP2",146,0)
 . S ^TMP("LRC",$J,GCNT,0)=^TMP("LRC",$J,GCNT,0)_$$S(22,CCNT,GMI_" = "_$G(^TMP("LRT",$J,GMI)))
"RTN","ORWRP2",147,0)
 . D LN
"RTN","ORWRP2",148,0)
 . S ^TMP("LRC",$J,GCNT,0)=""
"RTN","ORWRP2",149,0)
 Q
"RTN","ORWRP2",150,0)
LN ;
"RTN","ORWRP2",151,0)
 S GCNT=GCNT+1,CCNT=1
"RTN","ORWRP2",152,0)
 Q
"RTN","ORWRP2",153,0)
LINE ;Fill in the global with bank lines
"RTN","ORWRP2",154,0)
 N X
"RTN","ORWRP2",155,0)
 D LN
"RTN","ORWRP2",156,0)
 S X="",$P(X," ",GIOM)="",^TMP("LRC",$J,GCNT,0)=X
"RTN","ORWRP2",157,0)
 Q
"RTN","ORWRP2",158,0)
S(X,Y,Z) ;Pad over
"RTN","ORWRP2",159,0)
 ;X=Column #
"RTN","ORWRP2",160,0)
 ;Y=Current length
"RTN","ORWRP2",161,0)
 ;Z=Text
"RTN","ORWRP2",162,0)
 ;SP=TEXT SENT
"RTN","ORWRP2",163,0)
 ;CCNT=Line position after input text
"RTN","ORWRP2",164,0)
 I '$D(Z) Q ""
"RTN","ORWRP2",165,0)
 S SP=Z I X,Y,X>Y S SP=$E("                                ",1,X-Y)_Z
"RTN","ORWRP2",166,0)
 S CCNT=$$INC(CCNT,SP)
"RTN","ORWRP2",167,0)
 Q SP
"RTN","ORWRP2",168,0)
INC(X,Y) ;Character position count
"RTN","ORWRP2",169,0)
 ;X=Current count
"RTN","ORWRP2",170,0)
 ;Y=Text
"RTN","ORWRP2",171,0)
 S INC=X+$L(Y)
"RTN","ORWRP2",172,0)
 Q INC
"RTN","ORWRPL")
0^11^B49132980^B48063470
"RTN","ORWRPL",1,0)
ORWRPL ; slc/dcm - Background GUI Lab Print Driver;10:36 AM  14 Jan 2000 ; 08 Feb 2001  09:02AM [7/2/01 7:27am]
"RTN","ORWRPL",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,109,332**;Dec 17, 1997;Build 44
"RTN","ORWRPL",3,0)
RPTLIST ; -- list of Lab reports
"RTN","ORWRPL",4,0)
 ; <ID> ^ <report name> ^ <qualifier type> ^
"RTN","ORWRPL",5,0)
 ; <qualifier type> = 0:none,2:DateTime
"RTN","ORWRPL",6,0)
 ;;21^Cumulative^2
"RTN","ORWRPL",7,0)
 ;;3^Interim^2
"RTN","ORWRPL",8,0)
 ;;4^Interim for Selected Tests^2
"RTN","ORWRPL",9,0)
 ;;20^Anatomic Path Report^0
"RTN","ORWRPL",10,0)
 ;;2^Blood Bank Report^0
"RTN","ORWRPL",11,0)
 ;;9^Microbiology Report^2
"RTN","ORWRPL",12,0)
 ;;10^Lab Status Report^2
"RTN","ORWRPL",13,0)
 ;;$$END
"RTN","ORWRPL",14,0)
 ;
"RTN","ORWRPL",15,0)
PRINT(ORY,ORIO,ORDFN,RPTID,ORDAYSBK,ORTESTS,ORALPHA,OROMEGA)        ; -- print report entry point
"RTN","ORWRPL",16,0)
 ;  See RPC definition for details on input and output parameters
"RTN","ORWRPL",17,0)
 IF '$$CHK() G PRINTQ
"RTN","ORWRPL",18,0)
 N ZTDTH,ZTRTN,ZTSK,ZTDESC,ZTSAVE
"RTN","ORWRPL",19,0)
 S ZTIO=ORIO,ZTDTH=$H
"RTN","ORWRPL",20,0)
 S ZTDESC="GUI Lab Report Print"
"RTN","ORWRPL",21,0)
 S ZTRTN="DEQUE^ORWRPL"
"RTN","ORWRPL",22,0)
 S ZTSAVE("ORDFN")="",ZTSAVE("RPTID")="",ZTSAVE("ORDAYSBK")="",ZTSAVE("DUZ(")="",ZTSAVE("ORTESTS(")="",ZTSAVE("ORALPHA")="",ZTSAVE("OROMEGA")=""
"RTN","ORWRPL",23,0)
 D ^%ZTLOAD
"RTN","ORWRPL",24,0)
 I $D(ZTSK) D
"RTN","ORWRPL",25,0)
 . S ORY="0^Report queued. (Task #"_ZTSK_")"
"RTN","ORWRPL",26,0)
 E  D
"RTN","ORWRPL",27,0)
 . S ORY="99^Task Rejected."
"RTN","ORWRPL",28,0)
PRINTQ Q
"RTN","ORWRPL",29,0)
REMOTE(ORY,ORIO,ORDFN,RPTID,ORHANDS) ;Print data for remote sites
"RTN","ORWRPL",30,0)
 ;  RPC: ORWRP PRINT REMOTE REPORT
"RTN","ORWRPL",31,0)
 N ZTDTH,ZTRTN,ZTSK,ZTDESC,ZTSAVE,I
"RTN","ORWRPL",32,0)
 S ZTIO=ORIO,ZTDTH=$H
"RTN","ORWRPL",33,0)
 S ZTDESC="Remote Lab Report Print"
"RTN","ORWRPL",34,0)
 S ZTRTN="DEQUE^ORWRPL"
"RTN","ORWRPL",35,0)
 F I="ORDFN","RPTID","ORHANDS(" S ZTSAVE(I)=""
"RTN","ORWRPL",36,0)
 D ^%ZTLOAD
"RTN","ORWRPL",37,0)
 I $D(ZTSK) D
"RTN","ORWRPL",38,0)
 . S ORY="0^Report queued. (Task #"_ZTSK_")"
"RTN","ORWRPL",39,0)
 E  D
"RTN","ORWRPL",40,0)
 . S ORY="99^Task Rejected."
"RTN","ORWRPL",41,0)
 Q
"RTN","ORWRPL",42,0)
 ;
"RTN","ORWRPL",43,0)
PRINTW(ORTEXT,ORDFN,RPTID,ORDAYSBK,ORTESTS,ORALPHA,OROMEGA) ;Windows device print
"RTN","ORWRPL",44,0)
 N ZTQUEUED,ORHFS,ORSUB,ROOT,ORIO
"RTN","ORWRPL",45,0)
 N IOM,IOSL,IOST,IOF,IOT,IOS
"RTN","ORWRPL",46,0)
 S (ORSUB,ROOT)="ORDATA",ORIO="OR WINDOWS HFS"
"RTN","ORWRPL",47,0)
 S ORTEXT=$NA(^TMP(ORSUB,$J,1))
"RTN","ORWRPL",48,0)
 I '$$CHK() S @ORTEXT@(0)=ORY G PRINTWQ
"RTN","ORWRPL",49,0)
 S ORHFS=$$HFS^ORWRP()
"RTN","ORWRPL",50,0)
 D HFSOPEN^ORWRP("ORWRP",ORHFS,"W")
"RTN","ORWRPL",51,0)
 I POP D  Q
"RTN","ORWRPL",52,0)
 . I $D(ROOT) D SETITEM^ORWRP(.ROOT,"ERROR: Unable to open HFS file")
"RTN","ORWRPL",53,0)
 D IOVAR^ORWRP(.ORIO,,,"P-WINHFS80")
"RTN","ORWRPL",54,0)
 N $ETRAP,$ESTACK
"RTN","ORWRPL",55,0)
 S $ETRAP="D ERR^ORWRP Q"
"RTN","ORWRPL",56,0)
 U IO
"RTN","ORWRPL",57,0)
 D DEQUE
"RTN","ORWRPL",58,0)
 D HFSCLOSE^ORWRP("ORWRP",ORHFS)
"RTN","ORWRPL",59,0)
PRINTWQ Q
"RTN","ORWRPL",60,0)
PRINTWR(ORTEXT,ORDFN,RPTID,ORHANDS) ;Windows Remote device print
"RTN","ORWRPL",61,0)
 N ZTQUEUED,ORHFS,ORSUB,ROOT,ORIO,ORHANDLE
"RTN","ORWRPL",62,0)
 N IOM,IOSL,IOST,IOF,IOT,IOS
"RTN","ORWRPL",63,0)
 S (ORSUB,ROOT)="ORDATA",ORIO="OR WINDOWS HFS",ORTEXT=$NA(^TMP(ORSUB,$J,1)),ORHANDLE="ORWRP"
"RTN","ORWRPL",64,0)
 S ORHFS=$$HFS^ORWRP()
"RTN","ORWRPL",65,0)
 D HFSOPEN^ORWRP(ORHANDLE,ORHFS,"W")
"RTN","ORWRPL",66,0)
 I POP D  Q
"RTN","ORWRPL",67,0)
 . I $D(ROOT) D SETITEM^ORWRP(.ROOT,"ERROR: Unable to open HFS file")
"RTN","ORWRPL",68,0)
 D IOVAR^ORWRP(.ORIO,,,"P-WINHFS80")
"RTN","ORWRPL",69,0)
 N $ETRAP,$ESTACK
"RTN","ORWRPL",70,0)
 S $ETRAP="D ERR^ORWRP Q"
"RTN","ORWRPL",71,0)
 U IO
"RTN","ORWRPL",72,0)
 D DEQUE
"RTN","ORWRPL",73,0)
 D HFSCLOSE^ORWRP(ORHANDLE,ORHFS)
"RTN","ORWRPL",74,0)
 Q
"RTN","ORWRPL",75,0)
CHK() ; -- do checks for required data
"RTN","ORWRPL",76,0)
 N OROK,FALSE,TRUE,ORRPT,TXT
"RTN","ORWRPL",77,0)
 S FALSE=0,TRUE=1
"RTN","ORWRPL",78,0)
 IF $G(ORIO)']"" S OROK=FALSE,ORY="1^No device selected." G CHKQ
"RTN","ORWRPL",79,0)
 IF '$G(RPTID) S OROK=FALSE,ORY="2^No report specified." G CHKQ
"RTN","ORWRPL",80,0)
 ; -- get report definition
"RTN","ORWRPL",81,0)
 S (TXT,ORRPT)=""
"RTN","ORWRPL",82,0)
 F I=3:1 S TXT=$P($TEXT(RPTLIST+I),";;",2) Q:TXT="$$END"!(TXT="")  I +TXT=RPTID S ORRPT=TXT Q
"RTN","ORWRPL",83,0)
 IF +ORRPT'=RPTID S OROK=FALSE,ORY="3^Report type specified is not valid." G CHKQ
"RTN","ORWRPL",84,0)
 IF $P(ORRPT,U,3)=2,'$G(ORDAYSBK),'$G(ORALPHA) S OROK=FALSE,ORY="4^No date range specified." G CHKQ
"RTN","ORWRPL",85,0)
 IF '$D(^DPT(+$G(ORDFN),0)) S OROK=FALSE,ORY="6^Patient specified is not valid." G CHKQ
"RTN","ORWRPL",86,0)
 S OROK=TRUE
"RTN","ORWRPL",87,0)
CHKQ Q OROK
"RTN","ORWRPL",88,0)
 ;
"RTN","ORWRPL",89,0)
DEQUE ; -- logic to print queued report
"RTN","ORWRPL",90,0)
 ; -- call build report logic
"RTN","ORWRPL",91,0)
 N ORPRTING ;Printing Flag, used when creating report
"RTN","ORWRPL",92,0)
 S ORPRTING=1
"RTN","ORWRPL",93,0)
 I '$O(ORHANDS(0)) D LOOP Q
"RTN","ORWRPL",94,0)
 N ORI,ORX
"RTN","ORWRPL",95,0)
 S ORI=0
"RTN","ORWRPL",96,0)
 F  S ORI=$O(ORHANDS(ORI)) Q:'ORI  S ORX=ORHANDS(ORI) D
"RTN","ORWRPL",97,0)
 . N ORY,PAGE,ORALPHA,OROMEGA,ORID
"RTN","ORWRPL",98,0)
 . D RTNDATA^XWBDRPC(.ORY,$P(ORX,"^",2))
"RTN","ORWRPL",99,0)
 . S:ORY="" ORY="ORY"
"RTN","ORWRPL",100,0)
 . S PAGE=1,ORALPHA=$P(ORX,"^",3),OROMEGA=$P(ORX,"^",4),ORID=$$ID(RPTID)
"RTN","ORWRPL",101,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,ORID,$P(ORX,"^"))
"RTN","ORWRPL",102,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,ORID,1,$P(ORX,"^"))
"RTN","ORWRPL",103,0)
 Q
"RTN","ORWRPL",104,0)
ID(ID) ;Get Report ID
"RTN","ORWRPL",105,0)
 I ID=21 Q "LAB CUMULATIVE ("_ORALPHA_" - "_OROMEGA_")"
"RTN","ORWRPL",106,0)
 I ID=3 Q "LAB INTERIM ("_ORALPHA_" - "_OROMEGA_")"
"RTN","ORWRPL",107,0)
 I ID=4 Q "LAB INTERIM FOR SELECTED TESTS ("_ORALPHA_" - "_OROMEGA_")"
"RTN","ORWRPL",108,0)
 I ID=20 Q "PATIENT ANATOMIC PATHOLOGY REPORT"
"RTN","ORWRPL",109,0)
 I ID=2 Q "PATIENT BLOOD BANK REPORT"
"RTN","ORWRPL",110,0)
 I ID=9 Q "MICROBIOLOGY REPORT ("_ORALPHA_" - "_OROMEGA_")"
"RTN","ORWRPL",111,0)
 I ID=10 Q "PATIENT LAB ORDER STATUS REPORT ("_ORALPHA_" - "_OROMEGA_")"
"RTN","ORWRPL",112,0)
 Q ""
"RTN","ORWRPL",113,0)
LOOP ;
"RTN","ORWRPL",114,0)
 IF RPTID=21 D  G DEQUEQ
"RTN","ORWRPL",115,0)
 . N ORY,PAGE,TEXT,X1,X2,X
"RTN","ORWRPL",116,0)
 . D CUM^ORWLR(.ORY,.ORDFN,.ORDAYSBK,.ORALPHA,.OROMEGA)
"RTN","ORWRPL",117,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",118,0)
 . S PAGE=1,X1=DT,X2=-$G(ORDAYSBK,7)
"RTN","ORWRPL",119,0)
 . D C^%DTC
"RTN","ORWRPL",120,0)
 . S TEXT="LAB CUMULATIVE ("_$$FMTE^XLFDT(ORALPHA)_" - "_$$FMTE^XLFDT(OROMEGA)_")"
"RTN","ORWRPL",121,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,TEXT,$G(STATION))
"RTN","ORWRPL",122,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,TEXT)
"RTN","ORWRPL",123,0)
 IF RPTID=3 D  G DEQUEQ
"RTN","ORWRPL",124,0)
 . N ORY,PAGE,TEXT,X
"RTN","ORWRPL",125,0)
 . I $L(ORDAYSBK),'$G(ORALPHA) S ORALPHA=$$FMADD^XLFDT(DT,-ORDAYSBK),OROMEGA=$$NOW^XLFDT
"RTN","ORWRPL",126,0)
 . Q:'$G(ORALPHA)  Q:'$G(OROMEGA)
"RTN","ORWRPL",127,0)
 . D INTERIM^ORWLRR(.ORY,.ORDFN,OROMEGA,.ORALPHA)
"RTN","ORWRPL",128,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",129,0)
 . S PAGE=1,TEXT="LAB INTERIM ("_$$FMTE^XLFDT(ORALPHA)_" - "_$$FMTE^XLFDT(OROMEGA)_")"
"RTN","ORWRPL",130,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,TEXT,$G(STATION))
"RTN","ORWRPL",131,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,TEXT,1)
"RTN","ORWRPL",132,0)
 IF RPTID=4 D  G DEQUEQ
"RTN","ORWRPL",133,0)
 . N ORY,PAGE,TEXT,X
"RTN","ORWRPL",134,0)
 . I $L(ORDAYSBK),'$G(ORALPHA) S ORALPHA=$$FMADD^XLFDT(DT,-ORDAYSBK),OROMEGA=$$NOW^XLFDT
"RTN","ORWRPL",135,0)
 . Q:'$G(ORALPHA)  Q:'$G(OROMEGA)
"RTN","ORWRPL",136,0)
 . D INTERIMS^ORWLRR(.ORY,.ORDFN,.OROMEGA,.ORALPHA,.ORTESTS)
"RTN","ORWRPL",137,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",138,0)
 . S PAGE=1,TEXT="LAB INTERIM FOR SELECTED TESTS ("_$$FMTE^XLFDT(ORALPHA)_" - "_$$FMTE^XLFDT(OROMEGA)_")"
"RTN","ORWRPL",139,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,TEXT,$G(STATION))
"RTN","ORWRPL",140,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,TEXT,1)
"RTN","ORWRPL",141,0)
 IF RPTID=20 D  G DEQUEQ
"RTN","ORWRPL",142,0)
 . N ORY,PAGE
"RTN","ORWRPL",143,0)
 . D AP^ORWRP1(.ORY,.ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDTRNG,.REMOTE)
"RTN","ORWRPL",144,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",145,0)
 . S PAGE=1
"RTN","ORWRPL",146,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,"PATIENT ANATOMIC PATHOLOGY REPORT",$G(STATION))
"RTN","ORWRPL",147,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,"PATIENT ANATOMIC PATHOLOGY REPORT")
"RTN","ORWRPL",148,0)
 IF RPTID=2 D  G DEQUEQ
"RTN","ORWRPL",149,0)
 . N ORY,PAGE
"RTN","ORWRPL",150,0)
 . D BLR^ORWRP1(.ORY,.ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDAYSBK,.REMOTE)
"RTN","ORWRPL",151,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",152,0)
 . S PAGE=1
"RTN","ORWRPL",153,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,"PATIENT BLOOD BANK REPORT",$G(STATION))
"RTN","ORWRPL",154,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,"PATIENT BLOOD BANK REPORT")
"RTN","ORWRPL",155,0)
 IF RPTID=9 D  G DEQUEQ
"RTN","ORWRPL",156,0)
 . N ORY,PAGE,TEXT,X
"RTN","ORWRPL",157,0)
 . I $L(ORDAYSBK),'$G(ORALPHA) S ORALPHA=$$FMADD^XLFDT(DT,-ORDAYSBK),OROMEGA=$$NOW^XLFDT
"RTN","ORWRPL",158,0)
 . Q:'$G(ORALPHA)  Q:'$G(OROMEGA)
"RTN","ORWRPL",159,0)
 . D MICRO^ORWLRR(.ORY,.ORDFN,.OROMEGA,.ORALPHA)
"RTN","ORWRPL",160,0)
 . Q:'$L(ORY)
"RTN","ORWRPL",161,0)
 . S PAGE=1,TEXT="MICROBIOLOGY REPORT ("_$$FMTE^XLFDT(ORALPHA)_" - "_$$FMTE^XLFDT(OROMEGA)_")"
"RTN","ORWRPL",162,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,TEXT,$G(STATION))
"RTN","ORWRPL",163,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,TEXT,1)
"RTN","ORWRPL",164,0)
 IF RPTID=10 D  G DEQUEQ
"RTN","ORWRPL",165,0)
 . N ORY,PAGE,TEXT,X,ORVP
"RTN","ORWRPL",166,0)
 . S ORVP=ORDFN_";DPT("
"RTN","ORWRPL",167,0)
 . D EN1^LR7OSOS1(.ORY,ORVP,.ORALPHA,.OROMEGA,.ORDAYSBK)
"RTN","ORWRPL",168,0)
 . I '$O(^TMP("ORDATA",$J,1,0)) S ^TMP("ORDATA",$J,1,1,0)="",^TMP("ORDATA",$J,1,2,0)="No Orders found..."
"RTN","ORWRPL",169,0)
 . S PAGE=1,TEXT="PATIENT LAB ORDER STATUS REPORT ("_$$FMTE^XLFDT(ORALPHA)_" - "_$$FMTE^XLFDT(OROMEGA)_")"
"RTN","ORWRPL",170,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,TEXT,$G(STATION))
"RTN","ORWRPL",171,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,TEXT)
"RTN","ORWRPL",172,0)
DEQUEQ Q
"RTN","ORWRPP")
0^12^B42549274^B42317280
"RTN","ORWRPP",1,0)
ORWRPP ; ALB/MJK - Background Report Print Driver ; 08 Feb 2001  09:02AM
"RTN","ORWRPP",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,109,192,332**;Dec 17, 1997;Build 44
"RTN","ORWRPP",3,0)
PRINT(ORY,ORIO,ORDFN,ORRPTID,ORHSTYPE,ORDTRNG,OREXAMID,ORCOMP,ORALPHA,OROMEGA)        ; -- print report entry point
"RTN","ORWRPP",4,0)
 ;  RPC: ORWRP PRINT REPORT
"RTN","ORWRPP",5,0)
 ;  See RPC definition for details on input and output parameters
"RTN","ORWRPP",6,0)
 N ORHSTAG
"RTN","ORWRPP",7,0)
 S ORHSTAG=$P($G(ORRPTID),"~",2),ORRPTID=$P($G(ORRPTID),"~"),ORRPTID=$P($P(ORRPTID,";"),":")
"RTN","ORWRPP",8,0)
 IF '$$CHK() G PRINTQ
"RTN","ORWRPP",9,0)
 N ZTDTH,ZTRTN,ZTSK,ZTDESC,ZTSAVE,I,ZTIO
"RTN","ORWRPP",10,0)
 S ZTIO=ORIO,ZTDTH=$H
"RTN","ORWRPP",11,0)
 S ZTDESC="Report Print"
"RTN","ORWRPP",12,0)
 S ZTRTN="DEQUE^ORWRPP"
"RTN","ORWRPP",13,0)
 F I="ORDFN","ORRPTID","ORHSTYPE","ORDTRNG","OREXAMID","DUZ(","ORCOMP(","ORALPHA","OROMEGA","ORHSTAG" S ZTSAVE(I)=""
"RTN","ORWRPP",14,0)
 D ^%ZTLOAD
"RTN","ORWRPP",15,0)
 I $D(ZTSK) D
"RTN","ORWRPP",16,0)
 . S ORY="0^Report queued. (Task #"_ZTSK_")"
"RTN","ORWRPP",17,0)
 E  D
"RTN","ORWRPP",18,0)
 . S ORY="99^Task Rejected."
"RTN","ORWRPP",19,0)
PRINTQ Q
"RTN","ORWRPP",20,0)
REMOTE(ORY,ORIO,ORDFN,ORRPTID,ORHANDS) ;Print data for remote sites
"RTN","ORWRPP",21,0)
 ;  RPC: ORWRP PRINT REMOTE REPORT
"RTN","ORWRPP",22,0)
 N ZTDTH,ZTRTN,ZTSK,ZTDESC,ZTSAVE,I,ORHSTAG,ZTIO
"RTN","ORWRPP",23,0)
 S ORHSTAG=$P($G(ORRPTID),"~",2),ORRPTID=$P($G(ORRPTID),"~"),ORRPTID=$P($P(ORRPTID,";"),":")
"RTN","ORWRPP",24,0)
 S ZTIO=ORIO,ZTDTH=$H
"RTN","ORWRPP",25,0)
 S ZTDESC="Remote Report Print"
"RTN","ORWRPP",26,0)
 S ZTRTN="DEQUE^ORWRPP"
"RTN","ORWRPP",27,0)
 F I="ORDFN","ORRPTID","ORHANDS(","ORHSTAG" S ZTSAVE(I)=""
"RTN","ORWRPP",28,0)
 D ^%ZTLOAD
"RTN","ORWRPP",29,0)
 I $D(ZTSK) D
"RTN","ORWRPP",30,0)
 . S ORY="0^Report queued. (Task #"_ZTSK_")"
"RTN","ORWRPP",31,0)
 E  D
"RTN","ORWRPP",32,0)
 . S ORY="99^Task Rejected."
"RTN","ORWRPP",33,0)
 Q
"RTN","ORWRPP",34,0)
PRINTW(ORTEXT,ORDFN,ORRPTID,ORHSTYPE,ORDTRNG,OREXAMID,ORCOMP,ORALPHA,OROMEGA) ;Windows device print
"RTN","ORWRPP",35,0)
 N ZTQUEUED,ORHFS,ORSUB,ROOT,ORIO,ORHANDLE,ORWINDEV
"RTN","ORWRPP",36,0)
 N IOM,IOSL,IOST,IOF,IOT,IOS,ORHSTAG,POP
"RTN","ORWRPP",37,0)
 S ORHSTAG=$P($G(ORRPTID),"~",2),ORRPTID=$P($G(ORRPTID),"~"),ORRPTID=$P($P(ORRPTID,";"),":")
"RTN","ORWRPP",38,0)
 S (ORSUB,ROOT)="ORDATA",ORIO="OR WINDOWS HFS",ORTEXT=$NA(^TMP(ORSUB,$J,1)),ORHANDLE="ORWRP"
"RTN","ORWRPP",39,0)
 I '$$CHK() S @ORTEXT@(0)=ORY G PRINTWQ
"RTN","ORWRPP",40,0)
 S ORHFS=$$HFS^ORWRP(),ORWINDEV=1 ;Flag for printing to windows device
"RTN","ORWRPP",41,0)
 D HFSOPEN^ORWRP(ORHANDLE,ORHFS,"W")
"RTN","ORWRPP",42,0)
 I POP D  Q
"RTN","ORWRPP",43,0)
 . I $D(ROOT) D SETITEM^ORWRP(.ROOT,"ERROR: Unable to open HFS file")
"RTN","ORWRPP",44,0)
 D IOVAR^ORWRP(.ORIO,,,"P-WINHFS80")
"RTN","ORWRPP",45,0)
 N $ETRAP,$ESTACK
"RTN","ORWRPP",46,0)
 S $ETRAP="D ERR^ORWRP Q"
"RTN","ORWRPP",47,0)
 U IO
"RTN","ORWRPP",48,0)
 D DEQUE
"RTN","ORWRPP",49,0)
 D HFSCLOSE^ORWRP(ORHANDLE,ORHFS)
"RTN","ORWRPP",50,0)
PRINTWQ Q
"RTN","ORWRPP",51,0)
PRINTWR(ORTEXT,ORDFN,ORRPTID,ORHANDS) ;Windows Remote device print
"RTN","ORWRPP",52,0)
 N ZTQUEUED,ORHFS,ORSUB,ROOT,ORIO,ORHANDLE,ORWINDEV
"RTN","ORWRPP",53,0)
 N IOM,IOSL,IOST,IOF,IOT,IOS,ORHSTAG,POP
"RTN","ORWRPP",54,0)
 S ORHSTAG=$P($G(ORRPTID),"~",2),ORRPTID=$P($G(ORRPTID),"~"),ORRPTID=$P($P(ORRPTID,";"),":")
"RTN","ORWRPP",55,0)
 S (ORSUB,ROOT)="ORDATA",ORIO="OR WINDOWS HFS",ORTEXT=$NA(^TMP(ORSUB,$J,1)),ORHANDLE="ORWRP"
"RTN","ORWRPP",56,0)
 S ORHFS=$$HFS^ORWRP(),ORWINDEV=1 ;Flag for printing to windows device
"RTN","ORWRPP",57,0)
 D HFSOPEN^ORWRP(ORHANDLE,ORHFS,"W")
"RTN","ORWRPP",58,0)
 I POP D  Q
"RTN","ORWRPP",59,0)
 . I $D(ROOT) D SETITEM^ORWRP(.ROOT,"ERROR: Unable to open HFS file")
"RTN","ORWRPP",60,0)
 D IOVAR^ORWRP(.ORIO,,,"P-WINHFS80")
"RTN","ORWRPP",61,0)
 N $ETRAP,$ESTACK
"RTN","ORWRPP",62,0)
 S $ETRAP="D ERR^ORWRP Q"
"RTN","ORWRPP",63,0)
 U IO
"RTN","ORWRPP",64,0)
 D DEQUE
"RTN","ORWRPP",65,0)
 D HFSCLOSE^ORWRP(ORHANDLE,ORHFS)
"RTN","ORWRPP",66,0)
 Q
"RTN","ORWRPP",67,0)
CHK() ; -- do checks for required data
"RTN","ORWRPP",68,0)
 N OROK,FALSE,TRUE,ORRPT,TXT,I,J,REPORT
"RTN","ORWRPP",69,0)
 S FALSE=0,TRUE=1,I="",REPORT=""
"RTN","ORWRPP",70,0)
 IF $G(ORIO)']"" S OROK=FALSE,ORY="1^No device selected." G CHKQ
"RTN","ORWRPP",71,0)
 IF '$L($G(ORRPTID)) S OROK=FALSE,ORY="2^No report specified." G CHKQ
"RTN","ORWRPP",72,0)
 ; -- get report definition
"RTN","ORWRPP",73,0)
 F  S I=$O(^ORD(101.24,"AC",I)) Q:I=""  S J=0 F  S J=$O(^ORD(101.24,"AC",I,J)) Q:'J  D
"RTN","ORWRPP",74,0)
 . I $P($G(^ORD(101.24,J,0)),"^",2)=ORRPTID,$P(^(0),"^",8)="R" S REPORT=^(0)
"RTN","ORWRPP",75,0)
 I '$L(REPORT) S OROK=FALSE,ORY="2^Report not available." G CHKQ
"RTN","ORWRPP",76,0)
 S (TXT,ORRPT)=""
"RTN","ORWRPP",77,0)
 IF $P(REPORT,U,7)=1!($P(REPORT,U,7)=3),'$L($G(ORDTRNG)),'$G(ORALPHA) S OROK=FALSE,ORY="4^No date range specified." G CHKQ
"RTN","ORWRPP",78,0)
 IF $P(REPORT,U,4)=1,$G(ORHSTYPE)=0,'$O(ORCOMP(0)) S OROK=FALSE,ORY="10^No Adhoc components specified." G CHKQ
"RTN","ORWRPP",79,0)
 IF $P(REPORT,U,4)=1,'$G(ORHSTYPE),$P($G(ORHSTYPE),":")'=0 S OROK=FALSE,ORY="5^No health summary type specified." G CHKQ
"RTN","ORWRPP",80,0)
 IF $P(REPORT,U,4)=3,'$G(OREXAMID) S OROK=FALSE,ORY="7^No exam identified" G CHKQ
"RTN","ORWRPP",81,0)
 IF $P(REPORT,U,4)=4,'$L($G(OREXAMID)) S OROK=FALSE,ORY="9^No assessment identified" G CHKQ
"RTN","ORWRPP",82,0)
 IF $P(REPORT,U,4)=19,'$L($G(OREXAMID)) S OROK=FALSE,ORY="8^No procedure date identified" G CHKQ
"RTN","ORWRPP",83,0)
 IF '$D(^DPT(+$G(ORDFN),0)) S OROK=FALSE,ORY="6^Patient specified is not valid." G CHKQ
"RTN","ORWRPP",84,0)
 S OROK=TRUE
"RTN","ORWRPP",85,0)
CHKQ Q OROK
"RTN","ORWRPP",86,0)
 ;
"RTN","ORWRPP",87,0)
DEQUE ; -- logic to print queued report
"RTN","ORWRPP",88,0)
 ; -- call build report logic
"RTN","ORWRPP",89,0)
 N I,J,X0,X1,X2,X4,SITE,RTN,ENT,ID,ORID,ORHEADER,ORI,ORX,ORVP,OUT,PENT,POUT,PRTN,ROOT,MAX,ORPRTING
"RTN","ORWRPP",90,0)
 S ORVP=ORDFN_";DPT(",ROOT="ORDATA",POUT="",ORPRTING=1
"RTN","ORWRPP",91,0)
 S I=0,(X1,X2,ORID,REPORT)="",SITE=$$SITE^VASITE,SITE=$P(SITE,"^",2)_";"_$P(SITE,"^",3)
"RTN","ORWRPP",92,0)
 F  S I=$O(^ORD(101.24,"AC",I)) Q:I=""  S J=0 F  S J=$O(^ORD(101.24,"AC",I,J)) Q:'J  D
"RTN","ORWRPP",93,0)
 . I $P($G(^ORD(101.24,J,0)),"^",2)=ORRPTID,$P(^(0),"^",8)="R" S X0=^(0),X2=$G(^(2)),ORID=$P(X2,"^",3),ORFHIE=$G(^(4)),X4=$P(ORFHIE,"^",2),ORFHIE=$P(ORFHIE,"^",3)
"RTN","ORWRPP",94,0)
 I '$L(X0) D NOTYET(.ROOT) Q
"RTN","ORWRPP",95,0)
 S RTN=$P(X0,"^",5),ENT=$P(X0,"^",6)
"RTN","ORWRPP",96,0)
 I '$L(RTN)!'$L(ENT) D NOTYET(.ROOT) Q
"RTN","ORWRPP",97,0)
 I '$L($T(@(ENT_"^"_RTN))) D NOTYET(.ROOT) Q
"RTN","ORWRPP",98,0)
 S PRTN=$P(X2,"^",7),PENT=$P(X2,"^",6)
"RTN","ORWRPP",99,0)
 I $G(ORALPHA) S X=ORALPHA-$G(OROMEGA) D
"RTN","ORWRPP",100,0)
 . I X<0 S X=X*(-1)
"RTN","ORWRPP",101,0)
 . I X4,X>X4 S:ORALPHA>OROMEGA OROMEGA=$$FMADD^XLFDT(ORALPHA,-X4) S:ORALPHA'>OROMEGA ORALPHA=$$FMADD^XLFDT(OROMEGA,-X4) S ORDTRNG=""
"RTN","ORWRPP",102,0)
 I X4,$G(ORDTRNG)>X4 S ORDTRNG=X4,ORALPHA=""
"RTN","ORWRPP",103,0)
 I $L($G(ORDTRNG)),'$G(ORALPHA) S ORALPHA=$$FMADD^XLFDT(DT,-ORDTRNG),OROMEGA=DT_".235959"
"RTN","ORWRPP",104,0)
 I $G(OROMEGA),$E(OROMEGA,8)'="." S OROMEGA=OROMEGA_".235959"
"RTN","ORWRPP",105,0)
 S ID=$G(ORHSTAG),$P(ID,";",5,8)=SITE_";"_$P(X2,"^",8)_";"_$P(X2,"^",9)
"RTN","ORWRPP",106,0)
 I $L($P($G(ORHSTAG),";",4)) S MAX=$P(ORHSTAG,";",4)
"RTN","ORWRPP",107,0)
 I $L($G(ORHSTYPE)) M ID=ORHSTYPE
"RTN","ORWRPP",108,0)
 I $L($G(OREXAMID)) M ID=OREXAMID
"RTN","ORWRPP",109,0)
 I $L(PRTN),$L(PENT),$L($T(@(PENT_"^"_PRTN))) S POUT=PENT_"^"_PRTN_"(.ROOT,ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDTRNG,.REMOTE,.MAX,.ORFHIE)"
"RTN","ORWRPP",110,0)
 S OUT=ENT_"^"_RTN_"(.ROOT,ORDFN,.ID,.ORALPHA,.OROMEGA,.ORDTRNG,.REMOTE,.MAX,.ORFHIE)"
"RTN","ORWRPP",111,0)
 I '$O(ORHANDS(0)) D  G OUT
"RTN","ORWRPP",112,0)
 . N ORY,PAGE
"RTN","ORWRPP",113,0)
 . I $L(POUT) D @POUT Q  ;Go to non-standard print routine
"RTN","ORWRPP",114,0)
 . D @OUT
"RTN","ORWRPP",115,0)
 . Q:'$L(ROOT)
"RTN","ORWRPP",116,0)
 . S PAGE=1
"RTN","ORWRPP",117,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,ORID,$G(STATION))
"RTN","ORWRPP",118,0)
 . D HURL^ORWRPP1(.ROOT,ORDFN,ORID)
"RTN","ORWRPP",119,0)
 S ORI=0
"RTN","ORWRPP",120,0)
 F  S ORI=$O(ORHANDS(ORI)) Q:'ORI  S ORX=ORHANDS(ORI) D
"RTN","ORWRPP",121,0)
 . N ORY,PAGE,ORALPHA,OROMEGA
"RTN","ORWRPP",122,0)
 . D RTNDATA^XWBDRPC(.ORY,$P(ORX,"^",2))
"RTN","ORWRPP",123,0)
 . S:ORY="" ORY="ORY"
"RTN","ORWRPP",124,0)
 . S PAGE=1,ORALPHA=$P(ORX,"^",3),OROMEGA=$P(ORX,"^",4)
"RTN","ORWRPP",125,0)
 . D HEAD^ORWRPP1(ORDFN,PAGE,ORID,$P(ORX,"^"))
"RTN","ORWRPP",126,0)
 . D HURL^ORWRPP1(.ORY,ORDFN,ORID,1,$P(ORX,"^"))
"RTN","ORWRPP",127,0)
OUT I $L($G(ROOT)) K @ROOT
"RTN","ORWRPP",128,0)
 Q
"RTN","ORWRPP",129,0)
SITE(ORSTA)   ;Print Station info
"RTN","ORWRPP",130,0)
 N X
"RTN","ORWRPP",131,0)
 I $G(ORSTA) S ORSTA=$$IEN^XUAF4(ORSTA)
"RTN","ORWRPP",132,0)
 S:'$L($G(ORSTA)) ORSTA=$G(DUZ(2))
"RTN","ORWRPP",133,0)
 S X="Report from: "_$$GET1^DIQ(4,+ORSTA,.01,"E")_"    Station #"_$$GET1^DIQ(4,+ORSTA,99,"E")
"RTN","ORWRPP",134,0)
 W !?(IOM/2-($L(X)/2)),X
"RTN","ORWRPP",135,0)
 Q
"RTN","ORWRPP",136,0)
NOTYET(ROOT) ; -- standard not available display text
"RTN","ORWRPP",137,0)
 D SETITEM(.ROOT,"Report not available at this time.")
"RTN","ORWRPP",138,0)
 Q
"RTN","ORWRPP",139,0)
SETITEM(ROOT,X) ; -- set item in list
"RTN","ORWRPP",140,0)
 S @ROOT@($O(@ROOT@(9999),-1)+1)=X
"RTN","ORWRPP",141,0)
 Q
"RTN","ORY332")
0^^B212213^n/a
"RTN","ORY332",1,0)
ORY332 ;;SLCOIFO - Pre and Post-init for patch OR*3*332
"RTN","ORY332",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**332**;;Build 44
"RTN","ORY332",3,0)
 ;
"RTN","ORY332",4,0)
PRE ;Pre-Init Entry Point
"RTN","ORY332",5,0)
 D PARVAL
"RTN","ORY332",6,0)
 Q
"RTN","ORY332",7,0)
POST ;Post-Init Entry Point
"RTN","ORY332",8,0)
 Q
"RTN","ORY332",9,0)
PARVAL ;Set Param Val
"RTN","ORY332",10,0)
 Q
"RTN","ORY332",11,0)
SENDDLG(ANAME) ; Return true if the current order dialog should be sent
"RTN","ORY332",12,0)
 I ANAME="VBEC BLOOD BANK" Q 1
"RTN","ORY332",13,0)
 Q 0
"VER")
8.0^22.0
"BLD",7994,6)
^296
**END**
**END**
