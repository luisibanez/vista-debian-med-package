Released OR*3*329 SEQ #295
Extracted from mail message
**KIDS**:OR*3.0*329^

**INSTALL NAME**
OR*3.0*329
"BLD",7776,0)
OR*3.0*329^ORDER ENTRY/RESULTS REPORTING^0^3110210^y
"BLD",7776,1,0)
^^5^5^3110124^^
"BLD",7776,1,1,0)
Unseen orders are being auto-unflagged when processing a flagged orders 
"BLD",7776,1,2,0)
alert.
"BLD",7776,1,3,0)
 
"BLD",7776,1,4,0)
A flagged order recipient doesn't see a notification if an order is 
"BLD",7776,1,5,0)
flagged too soon after a previous flagged order.
"BLD",7776,4,0)
^9.64PA^^
"BLD",7776,6.3)
8
"BLD",7776,"ABPKG")
n
"BLD",7776,"KRN",0)
^9.67PA^779.2^20
"BLD",7776,"KRN",.4,0)
.4
"BLD",7776,"KRN",.401,0)
.401
"BLD",7776,"KRN",.402,0)
.402
"BLD",7776,"KRN",.403,0)
.403
"BLD",7776,"KRN",.5,0)
.5
"BLD",7776,"KRN",.84,0)
.84
"BLD",7776,"KRN",3.6,0)
3.6
"BLD",7776,"KRN",3.8,0)
3.8
"BLD",7776,"KRN",9.2,0)
9.2
"BLD",7776,"KRN",9.8,0)
9.8
"BLD",7776,"KRN",9.8,"NM",0)
^9.68A^3^2
"BLD",7776,"KRN",9.8,"NM",1,0)
ORWORB^^0^B72691529
"BLD",7776,"KRN",9.8,"NM",3,0)
ORB31^^0^B34930090
"BLD",7776,"KRN",9.8,"NM","B","ORB31",3)

"BLD",7776,"KRN",9.8,"NM","B","ORWORB",1)

"BLD",7776,"KRN",19,0)
19
"BLD",7776,"KRN",19.1,0)
19.1
"BLD",7776,"KRN",101,0)
101
"BLD",7776,"KRN",409.61,0)
409.61
"BLD",7776,"KRN",771,0)
771
"BLD",7776,"KRN",779.2,0)
779.2
"BLD",7776,"KRN",870,0)
870
"BLD",7776,"KRN",8989.51,0)
8989.51
"BLD",7776,"KRN",8989.52,0)
8989.52
"BLD",7776,"KRN",8994,0)
8994
"BLD",7776,"KRN","B",.4,.4)

"BLD",7776,"KRN","B",.401,.401)

"BLD",7776,"KRN","B",.402,.402)

"BLD",7776,"KRN","B",.403,.403)

"BLD",7776,"KRN","B",.5,.5)

"BLD",7776,"KRN","B",.84,.84)

"BLD",7776,"KRN","B",3.6,3.6)

"BLD",7776,"KRN","B",3.8,3.8)

"BLD",7776,"KRN","B",9.2,9.2)

"BLD",7776,"KRN","B",9.8,9.8)

"BLD",7776,"KRN","B",19,19)

"BLD",7776,"KRN","B",19.1,19.1)

"BLD",7776,"KRN","B",101,101)

"BLD",7776,"KRN","B",409.61,409.61)

"BLD",7776,"KRN","B",771,771)

"BLD",7776,"KRN","B",779.2,779.2)

"BLD",7776,"KRN","B",870,870)

"BLD",7776,"KRN","B",8989.51,8989.51)

"BLD",7776,"KRN","B",8989.52,8989.52)

"BLD",7776,"KRN","B",8994,8994)

"BLD",7776,"QUES",0)
^9.62^^
"BLD",7776,"REQB",0)
^9.611^1^1
"BLD",7776,"REQB",1,0)
OR*3.0*296^2
"BLD",7776,"REQB","B","OR*3.0*296",1)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
329^3110210
"PKG",170,22,1,"PAH",1,1,0)
^^5^5^3110210
"PKG",170,22,1,"PAH",1,1,1,0)
Unseen orders are being auto-unflagged when processing a flagged orders 
"PKG",170,22,1,"PAH",1,1,2,0)
alert.
"PKG",170,22,1,"PAH",1,1,3,0)
 
"PKG",170,22,1,"PAH",1,1,4,0)
A flagged order recipient doesn't see a notification if an order is 
"PKG",170,22,1,"PAH",1,1,5,0)
flagged too soon after a previous flagged order.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ORB31")
0^3^B34930090^B31957768
"RTN","ORB31",1,0)
ORB31 ; slc/CLA - Routine to support OE/RR 3 notifications ;6/28/00  12:00 [ 04/02/97  11:12 AM ]
"RTN","ORB31",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,31,88,105,139,173,220,215,329**;Dec 17, 1997;Build 8
"RTN","ORB31",3,0)
QUEUE(ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA,ORBH,ORBD,ORDGPMA) ;
"RTN","ORB31",4,0)
 ;queue up notif for Taskman processing
"RTN","ORB31",5,0)
 ;ORN       notification ien from file 100.9
"RTN","ORB31",6,0)
 ;ORBDFN    patient dfn from file 2
"RTN","ORB31",7,0)
 ;ORNUM     order number from file 100
"RTN","ORB31",8,0)
 ;ORBADUZ   array of potential user recipients (iens from file 100)
"RTN","ORB31",9,0)
 ;ORBPMSG   alert message from triggering process
"RTN","ORB31",10,0)
 ;ORBPDATA  data potentially used in alert follow-up action
"RTN","ORB31",11,0)
 ;ORBH      $H formatted time to begin Taskman process
"RTN","ORB31",12,0)
 ;ORBD      process description for Taskman
"RTN","ORB31",13,0)
 ;ORDGPMA   DGPMA if alert triggered by A/D/T event
"RTN","ORB31",14,0)
 ;
"RTN","ORB31",15,0)
 N ZTCPU,ZTDESC,ZTDTH,ZTIO,ZTPAR,ZTPRE,ZTPRI,ZTREQ,ZTRTN,ZTSAVE,ZTSK,ZTUCI,X,Y,DIC
"RTN","ORB31",16,0)
 ;
"RTN","ORB31",17,0)
 S DIC="3.5",X="ORB NOTIFICATION RESOURCE",DIC(0)="X" D ^DIC
"RTN","ORB31",18,0)
 I (Y) S ZTIO=$P(Y,U,2)
"RTN","ORB31",19,0)
 E  S ZTIO=""
"RTN","ORB31",20,0)
 S ZTDTH=ORBH,ZTRTN="ZTSK^ORB3"
"RTN","ORB31",21,0)
 S ZTDESC=ORBD
"RTN","ORB31",22,0)
 S ZTDESC=ZTDESC_"for ("_ORBDFN_") "_$P($G(^DPT(+ORBDFN,0)),U,1)
"RTN","ORB31",23,0)
 K ZTSAVE,ZTCPU,ZTUCI,ZTPRI,ZTPAR,ZTPRE,DIC,Y,DTOUT,DUOUT
"RTN","ORB31",24,0)
 ;
"RTN","ORB31",25,0)
 S ZTSAVE("ORN")=""
"RTN","ORB31",26,0)
 S ZTSAVE("ORBDFN")=""
"RTN","ORB31",27,0)
 S ZTSAVE("ORNUM")=""
"RTN","ORB31",28,0)
 S ZTSAVE("ORBADUZ(")=""
"RTN","ORB31",29,0)
 S ZTSAVE("ORBPMSG")=""
"RTN","ORB31",30,0)
 S ZTSAVE("ORBPDATA")=""
"RTN","ORB31",31,0)
 S ZTSAVE("ORDGPMA")=""
"RTN","ORB31",32,0)
 D ^%ZTLOAD
"RTN","ORB31",33,0)
 Q
"RTN","ORB31",34,0)
DUP(ORN,ORBDFN,ORBPMSG,ORNUM) ;ext funct return "1" if a duplicate notif w/in 1 min.
"RTN","ORB31",35,0)
 N ORBDUP,ORBNOW,ORBLAST,ORLNUM,ORSAMEP,ORSAMEREC
"RTN","ORB31",36,0)
 S ORBDUP=0
"RTN","ORB31",37,0)
 S ORSAMEP=0
"RTN","ORB31",38,0)
 S ORBNOW=$$NOW^XLFDT
"RTN","ORB31",39,0)
 S ^XTMP("ORBDUP",0)=$$FMADD^XLFDT(ORBNOW,1,"","","")_"^"_ORBNOW
"RTN","ORB31",40,0)
 I '$L($G(^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG))) S ^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG)=ORBNOW_"^"_$G(ORNUM)
"RTN","ORB31",41,0)
 E  D
"RTN","ORB31",42,0)
 .S ORBLAST=$G(^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG))
"RTN","ORB31",43,0)
 .S ORLNUM=$P(ORBLAST,"^",2)
"RTN","ORB31",44,0)
 .S ORBLAST=$P(ORBLAST,"^")
"RTN","ORB31",45,0)
 .I $L($G(ORNUM)),$L($G(ORLNUM)),($$ORDERER^ORQOR2(ORNUM)=$$ORDERER^ORQOR2(ORLNUM)) S ORSAMEP=1 ;same provider as last order that triggered this notif
"RTN","ORB31",46,0)
 .S ORSAMEREC=1 I ORN=6,($$RECIP($G(ORNUM))'=$$RECIP($G(ORLNUM))) S ORSAMEREC=0
"RTN","ORB31",47,0)
 .;if last occurrence of this "NOT" notif was w/in past 1 min, its a dup
"RTN","ORB31",48,0)
 .I ORBNOW<$$FMADD^XLFDT(ORBLAST,"","",1,""),ORSAMEP=1,ORSAMEREC=1 S ORBDUP=1  ;dup
"RTN","ORB31",49,0)
 .E  S ^XTMP("ORBDUP",ORBDFN_";"_ORN_";"_ORBPMSG)=ORBNOW_"^"_ORNUM  ;refresh last pt/noti occ.
"RTN","ORB31",50,0)
 D DUPCLN(ORBNOW)  ;clean up old ^XTMP("ORBUP") entries
"RTN","ORB31",51,0)
 Q ORBDUP
"RTN","ORB31",52,0)
RECIP(ORNUM) N ORI,RECIP
"RTN","ORB31",53,0)
 Q:'ORNUM 0
"RTN","ORB31",54,0)
 S ORI=0 F  S ORI=$O(^OR(100,ORNUM,8,ORI)) Q:'ORI  D
"RTN","ORB31",55,0)
 .I '$P($G(^OR(100,ORNUM,8,ORI,3)),U,6)&($P($G(^OR(100,ORNUM,8,ORI,3)),U,9)) S RECIP=$P($G(^OR(100,ORNUM,8,ORI,3)),U,9)
"RTN","ORB31",56,0)
 Q $G(RECIP)
"RTN","ORB31",57,0)
REGDEV(ORBDA) ;send to regular recipient devices
"RTN","ORB31",58,0)
 N ORBDT,ORBD
"RTN","ORB31",59,0)
 S ORBD=""
"RTN","ORB31",60,0)
 S ORBDT=$$NOW^XLFDT
"RTN","ORB31",61,0)
 F   S ORBD=$O(ORBDA(ORBD)) Q:ORBD=""  D
"RTN","ORB31",62,0)
 .S ZTRTN="PRINTD^ORB31",ZTDESC="Print Notification to Device",ZTDTH=$H
"RTN","ORB31",63,0)
 .S ZTIO=ORBD,ZTSAVE("XQAMSG")="",ZTSAVE("ORBDT")=""
"RTN","ORB31",64,0)
 .D ^%ZTLOAD
"RTN","ORB31",65,0)
 Q
"RTN","ORB31",66,0)
PRINTD ;print queued notification to device - setup via REGDEV^ORB3
"RTN","ORB31",67,0)
 I $G(ZTSK) D KILL^%ZTLOAD
"RTN","ORB31",68,0)
 I IOT="HFS" W XQAMSG Q  ;write msg to a file then quit
"RTN","ORB31",69,0)
 W !!!,"          ***** NOTIFICATION PROCESSED *****",!!
"RTN","ORB31",70,0)
 W $$FMTE^XLFDT(ORBDT),"   "
"RTN","ORB31",71,0)
 W XQAMSG
"RTN","ORB31",72,0)
 I $E(IOST,1,2)'="C-" W @IOF
"RTN","ORB31",73,0)
 Q
"RTN","ORB31",74,0)
FWD(ORY,ORBLST,ORBRECIP,ORBTYPE,ORBCOMNT) ; forward a notification
"RTN","ORB31",75,0)
 I ORBLST="" S ORY=0 Q
"RTN","ORB31",76,0)
 S ORBLST(1)=ORBLST
"RTN","ORB31",77,0)
 D FORWARD^XQALFWD(.ORBLST,.ORBRECIP,ORBTYPE,ORBCOMNT)
"RTN","ORB31",78,0)
 S ORY=1
"RTN","ORB31",79,0)
 Q
"RTN","ORB31",80,0)
RENEW(ORY,XQAID) ; renew/restore an alert/notification
"RTN","ORB31",81,0)
 Q:$L($G(XQAID))<1
"RTN","ORB31",82,0)
 K XQAKILL
"RTN","ORB31",83,0)
 I '$D(^XTV(8992,"AXQA",XQAID,DUZ)) D RESTORE^XQALERT1 ;DBIA #4100
"RTN","ORB31",84,0)
 S ORY=1
"RTN","ORB31",85,0)
 Q
"RTN","ORB31",86,0)
TERMLKUP(OCXARR,OCXTERM) ; extrinsic function returns the local terms
"RTN","ORB31",87,0)
 ; linked to the nat'l OCX term in an array and the file where those
"RTN","ORB31",88,0)
 ; array terms can be found. The value of the extrinsic function is the
"RTN","ORB31",89,0)
 ; file pointed to for the local terms.
"RTN","ORB31",90,0)
 ;
"RTN","ORB31",91,0)
 ; OCXARR  - Array of local terms
"RTN","ORB31",92,0)
 ; OCXTERM - OCX nat'l term from file ^OCXS(860.9
"RTN","ORB31",93,0)
 ;
"RTN","ORB31",94,0)
 N OCXI,OCXJ,FILE,I
"RTN","ORB31",95,0)
 S OCXI="",OCXJ=0,FILE="",I=1
"RTN","ORB31",96,0)
 S OCXI=$O(^OCXS(860.9,"B",OCXTERM,OCXI))
"RTN","ORB31",97,0)
 I +$G(OCXI)>0 D
"RTN","ORB31",98,0)
 .S FILE=$P(^OCXS(860.9,OCXI,0),U,2)
"RTN","ORB31",99,0)
 .F  S OCXJ=$O(^OCXS(860.9,OCXI,1,OCXJ)) Q:+OCXJ<1  D
"RTN","ORB31",100,0)
 ..S OCXARR(I)=$P(^OCXS(860.9,OCXI,1,OCXJ,0),U,2)_U_$P(^(0),U)
"RTN","ORB31",101,0)
 ..S OCXARR=I,I=I+1
"RTN","ORB31",102,0)
 Q FILE
"RTN","ORB31",103,0)
DUPCLN(ORBNOW) ;clean up old entires in ^XTMP("ORBDUP")
"RTN","ORB31",104,0)
 N ORBX,ORBDT,ORNDT
"RTN","ORB31",105,0)
 S ORNDT=$$FMADD^XLFDT(ORBNOW,"","",-5,"")  ;entries older than 5 minutes
"RTN","ORB31",106,0)
 S ORBX=0
"RTN","ORB31",107,0)
 F  S ORBX=$O(^XTMP("ORBDUP",ORBX)) Q:ORBX=""  D
"RTN","ORB31",108,0)
 .S ORBDT=+$G(^XTMP("ORBDUP",ORBX))
"RTN","ORB31",109,0)
 .I $L(ORBDT),(ORBDT<ORNDT) K ^XTMP("ORBDUP",ORBX)
"RTN","ORB31",110,0)
 Q
"RTN","ORB31",111,0)
TMDEV(ORBTM) ;returns Device for a team in format device ien^device name
"RTN","ORB31",112,0)
 N ORBTDEV,ORBTDEVN
"RTN","ORB31",113,0)
 S ORBTDEVN=""
"RTN","ORB31",114,0)
 Q:'$L($G(ORBTM)) ""
"RTN","ORB31",115,0)
 Q:'$D(^OR(100.21,ORBTM,0)) ""
"RTN","ORB31",116,0)
 S ORBTDEV=$P(^OR(100.21,ORBTM,0),U,4)  ;get Team's device
"RTN","ORB31",117,0)
 Q:+$G(ORBTDEV)<1 ""
"RTN","ORB31",118,0)
 S X="`"_ORBTDEV,DIC=3.5,DIC(0)="" D ^DIC  ;DBIA #10114
"RTN","ORB31",119,0)
 Q:+Y<1 ""
"RTN","ORB31",120,0)
 S ORBTDEVN=$P(Y,U,2)
"RTN","ORB31",121,0)
 K DIC,Y,X
"RTN","ORB31",122,0)
 Q ORBTDEV_U_ORBTDEVN
"RTN","ORB31",123,0)
ENTITY(ORNUM) ;ext funct. rtns entity for parameter use
"RTN","ORB31",124,0)
 N ORBENT
"RTN","ORB31",125,0)
 S ORBENT="DIV^SYS^PKG"
"RTN","ORB31",126,0)
 I $L($G(ORNUM)) D  ;if order number use pt's location division
"RTN","ORB31",127,0)
 .N ORDIV
"RTN","ORB31",128,0)
 .S ORDIV=0,ORDIV=$$ORDIV(ORNUM)
"RTN","ORB31",129,0)
 .I +$G(ORDIV)>0 S ORBENT=ORDIV_";DIC(4,^SYS^PKG"
"RTN","ORB31",130,0)
 Q ORBENT
"RTN","ORB31",131,0)
 ;
"RTN","ORB31",132,0)
ADT(ORN,ORBDFN,ORBPRIM,ORBATTD,ORDGPMA) ;get inpt primary and attending for ADT notifs
"RTN","ORB31",133,0)
 N ORBADTDT,VAINDT
"RTN","ORB31",134,0)
 ;if notif is deceased or discharge use prev visit d/t:
"RTN","ORB31",135,0)
 I (ORN=20)!(ORN=35) D
"RTN","ORB31",136,0)
 .S ORBADTDT=$S($D(ORDGPMA):$P(ORDGPMA,U),1:$P($G(^DPT(ORBDFN,.35)),U))
"RTN","ORB31",137,0)
 .I $L(ORBADTDT) S VAINDT=$$FMADD^XLFDT(ORBADTDT,"","","","-1")
"RTN","ORB31",138,0)
 ;
"RTN","ORB31",139,0)
 I ORN=18 S VAINDT=$P($G(ORDGPMA),U)  ;if admission use this visit d/t
"RTN","ORB31",140,0)
 ;
"RTN","ORB31",141,0)
 I $L($G(VAINDT)) D
"RTN","ORB31",142,0)
 .D INP^VADPT  ;get new VAIN array for appropriate visit
"RTN","ORB31",143,0)
 .S ORBPRIM=+$P(VAIN(2),U),ORBATTD=+$P(VAIN(11),U)
"RTN","ORB31",144,0)
 Q
"RTN","ORB31",145,0)
 ;
"RTN","ORB31",146,0)
DEFDIV(ORDUZ) ; Return user's default division, if specified.
"RTN","ORB31",147,0)
 ;
"RTN","ORB31",148,0)
 N ORDD,ORDIV,ORGOOD,ORZ,ORZERR
"RTN","ORB31",149,0)
 ;
"RTN","ORB31",150,0)
 S ORDIV=""
"RTN","ORB31",151,0)
 S Y=0,(ORDD,ORGOOD)=0             ; Initialize variables.
"RTN","ORB31",152,0)
 ;
"RTN","ORB31",153,0)
 ; Get list of divisions from NEW PERSON file multiple:
"RTN","ORB31",154,0)
 D LIST^DIC(200.02,","_ORDUZ_",","@;.01;1","QP","","","","","","","ORZ","ORZERR")
"RTN","ORB31",155,0)
 I $P(ORZ("DILIST",0),U)=0 Q       ; No Divisions listed.
"RTN","ORB31",156,0)
 ;
"RTN","ORB31",157,0)
 F  S ORDD=$O(ORZ("DILIST",ORDD)) Q:+ORDD=0!'($L(ORDD))  D  Q:ORGOOD
"RTN","ORB31",158,0)
 .; See if current entry being processed is "Default" (done if so):
"RTN","ORB31",159,0)
 .I $P(ORZ("DILIST",ORDD,0),U,3)["Y" S ORDIV=$P(ORZ("DILIST",ORDD,0),U,1,2),ORGOOD=1
"RTN","ORB31",160,0)
 Q ORDIV
"RTN","ORB31",161,0)
 ;
"RTN","ORB31",162,0)
ORDIV(ORNUM) ; Return order's division based upon patient's location when order was placed
"RTN","ORB31",163,0)
 ;
"RTN","ORB31",164,0)
 Q:+$G(ORNUM)<1 ""
"RTN","ORB31",165,0)
 Q:'$D(^OR(100,ORNUM,0)) ""
"RTN","ORB31",166,0)
 N ORDIV,PTLOC
"RTN","ORB31",167,0)
 S ORDIV=""
"RTN","ORB31",168,0)
 S PTLOC=+$P(^OR(100,ORNUM,0),U,10)
"RTN","ORB31",169,0)
 Q:$G(PTLOC)<1 ""
"RTN","ORB31",170,0)
 S ORDIV=$P(^SC(PTLOC,0),U,4)  ;DBIA #10040
"RTN","ORB31",171,0)
 Q ORDIV
"RTN","ORWORB")
0^1^B72691529^B69468448
"RTN","ORWORB",1,0)
ORWORB ; slc/dee/REV/CLA,WAT - RPC functions which return user alert ;10:12 am JAN 31, 2001
"RTN","ORWORB",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,116,148,173,190,215,243,296,329**;Dec 17, 1997;Build 8
"RTN","ORWORB",3,0)
 ;
"RTN","ORWORB",4,0)
 ;This routine invokes to following ICR(s):
"RTN","ORWORB",5,0)
 ;ICR 4156     ;REGISTRATION, COMBAT VETERAN STATUS
"RTN","ORWORB",6,0)
 ;
"RTN","ORWORB",7,0)
URGENLST(ORY) ;return array of the  urgency for the notification
"RTN","ORWORB",8,0)
 N ORSRV,ORERROR
"RTN","ORWORB",9,0)
 S ORSRV=$G(^VA(200,DUZ,5)) I +ORSRV>0 S ORSRV=$P(ORSRV,U)
"RTN","ORWORB",10,0)
 D GETLST^XPAR(.ORY,"USR^SRV.`"_$G(ORSRV)_"^DIV^SYS^PKG","ORB URGENCY","I",.ORERROR)
"RTN","ORWORB",11,0)
 Q
"RTN","ORWORB",12,0)
 ;
"RTN","ORWORB",13,0)
FASTUSER(ORY) ;return current user's notifications across all patients
"RTN","ORWORB",14,0)
 N STRTDATE,STOPDATE,ORTOT,I,ORURG,URG,ORN,SORT,ORN0,URGLIST,REMLIST,REM,NONORLST,NONOR
"RTN","ORWORB",15,0)
 N ALRT,ALRTDT,ALRTPT,ALRTMSG,ALRTI,ALRTLOC,ALRTXQA,J,FWDBY,PRE,ALRTDFN
"RTN","ORWORB",16,0)
 K ^TMP("ORBG",$J)
"RTN","ORWORB",17,0)
 S STRTDATE="",STOPDATE="",FWDBY="Forwarded by: "
"RTN","ORWORB",18,0)
 D GETUSER1^XQALDATA("^TMP(""ORB"",$J)",DUZ,STRTDATE,STOPDATE)
"RTN","ORWORB",19,0)
 S ORTOT=^TMP("ORB",$J)
"RTN","ORWORB",20,0)
 D URGLIST^ORQORB(.URGLIST)
"RTN","ORWORB",21,0)
 D REMLIST^ORQORB(.REMLIST)
"RTN","ORWORB",22,0)
 D REMNONOR^ORQORB(.NONORLST)
"RTN","ORWORB",23,0)
 S J=0
"RTN","ORWORB",24,0)
 F I=1:1:ORTOT D
"RTN","ORWORB",25,0)
 .S ALRTDFN=""
"RTN","ORWORB",26,0)
 .S ALRT=^TMP("ORB",$J,I)
"RTN","ORWORB",27,0)
 .S PRE=$E(ALRT,1,1)
"RTN","ORWORB",28,0)
 .S ALRTXQA=$P(ALRT,U,2)  ;XQAID
"RTN","ORWORB",29,0)
 .S NONOR="" F  S NONOR=$O(NONORLST(NONOR)) Q:NONOR=""  D
"RTN","ORWORB",30,0)
 ..I ALRTXQA[NONOR S REM=1  ;allow this type of alert to be Removed
"RTN","ORWORB",31,0)
 .S ALRTMSG=$P($P(ALRT,U),PRE_"  ",2)
"RTN","ORWORB",32,0)
 .I $E(ALRT,4,8)'="-----" D  ;not forwarded alert info/comment
"RTN","ORWORB",33,0)
 ..S ORURG="n/a"
"RTN","ORWORB",34,0)
 ..S ALRTI=$P(ALRT,"  ")
"RTN","ORWORB",35,0)
 ..S ALRTPT=""
"RTN","ORWORB",36,0)
 ..S ALRTLOC=""
"RTN","ORWORB",37,0)
 ..I $E($P(ALRTXQA,";"),1,3)="TIU" S ORURG="Moderate"
"RTN","ORWORB",38,0)
 ..I $P(ALRTXQA,",")="OR" D
"RTN","ORWORB",39,0)
 ...S ORN=$P($P(ALRTXQA,";"),",",3)
"RTN","ORWORB",40,0)
 ...S URG=$G(URGLIST(ORN))
"RTN","ORWORB",41,0)
 ...S ORURG=$S(URG=1:"HIGH",URG=2:"Moderate",1:"low")
"RTN","ORWORB",42,0)
 ...S REM=$G(REMLIST(ORN))
"RTN","ORWORB",43,0)
 ...S ORN0=^ORD(100.9,ORN,0)
"RTN","ORWORB",44,0)
 ...S ALRTI=$S($P(ORN0,U,6)="INFODEL":"I",1:"")
"RTN","ORWORB",45,0)
 ...S ALRTDFN=$P(ALRTXQA,",",2)
"RTN","ORWORB",46,0)
 ...S ALRTLOC=$G(^DPT(+$G(ALRTDFN),.1))
"RTN","ORWORB",47,0)
 ..S ALRTI=$S(ALRTI="I":"I",1:"")
"RTN","ORWORB",48,0)
 ..I (ALRT["): ")!($G(ORN)=27&(ALRT[") CV")) D  ;WAT
"RTN","ORWORB",49,0)
 ...S ALRTPT=$P(ALRT,": ")
"RTN","ORWORB",50,0)
 ...S ALRTPT=$E(ALRTPT,4,$L(ALRTPT))
"RTN","ORWORB",51,0)
 ...I $G(ORN)=27&(ALRT[") CV") S ALRTMSG=$P($P(ALRT,U),": ",2) ;WAT
"RTN","ORWORB",52,0)
 ...E  S ALRTMSG=$P($P(ALRT,U),"): ",2) ;WAT
"RTN","ORWORB",53,0)
 ...I $E(ALRTMSG,1,1)="[" D
"RTN","ORWORB",54,0)
 ....S:'$L(ALRTLOC) ALRTLOC=$P($P(ALRTMSG,"]"),"[",2)
"RTN","ORWORB",55,0)
 ....S ALRTMSG=$P(ALRTMSG,"] ",2)
"RTN","ORWORB",56,0)
 ..I '$L($G(ALRTPT)) S ALRTPT="no patient"
"RTN","ORWORB",57,0)
 ..S ALRTDT=$P(ALRTXQA,";",3)
"RTN","ORWORB",58,0)
 ..S ALRTDT=$P(ALRTDT,".")_"."_$E($P(ALRTDT,".",2)_"0000",1,4)
"RTN","ORWORB",59,0)
 ..S ALRTDT=$E(ALRTDT,4,5)_"/"_$E(ALRTDT,6,7)_"/"_($E(ALRTDT,1,3)+1700)_"@"_$E($P(ALRTDT,".",2),1,2)_":"_$E($P(ALRTDT,".",2),3,4)
"RTN","ORWORB",60,0)
 ..;S ALRTDT=($E(ALRTDT,1,3)+1700)_"/"_$E(ALRTDT,4,5)_"/"_$E(ALRTDT,6,7)_"@"_$E($P(ALRTDT,".",2),1,2)_":"_$E($P(ALRTDT,".",2),3,4)
"RTN","ORWORB",61,0)
 ..S J=J+1,^TMP("ORBG",$J,J)=ALRTI_U_ALRTPT_U_ALRTLOC_U_ORURG_U_ALRTDT_U
"RTN","ORWORB",62,0)
 ..S ^TMP("ORBG",$J,J)=^TMP("ORBG",$J,J)_ALRTMSG_U_U_ALRTXQA_U_$G(REM)_U
"RTN","ORWORB",63,0)
 .;
"RTN","ORWORB",64,0)
 .;if alert forward info/comment:
"RTN","ORWORB",65,0)
 .I $E(ALRTMSG,1,5)="-----" D
"RTN","ORWORB",66,0)
 ..S ALRTMSG=$P(ALRTMSG,"-----",2)
"RTN","ORWORB",67,0)
 ..I $E(ALRTMSG,1,14)=FWDBY D
"RTN","ORWORB",68,0)
 ...S J=J+1,^TMP("ORBG",$J,J)=FWDBY_U_$P($P(ALRTMSG,FWDBY,2),"Generated: ")_$P($P(ALRTMSG,FWDBY,2),"Generated: ",2)
"RTN","ORWORB",69,0)
 ..E  S ^TMP("ORBG",$J,J)=^TMP("ORBG",$J,J)_U_""""_ALRTMSG_""""
"RTN","ORWORB",70,0)
 S ^TMP("ORBG",$J)=""
"RTN","ORWORB",71,0)
 S ORY=$NA(^TMP("ORBG",$J))
"RTN","ORWORB",72,0)
 Q
"RTN","ORWORB",73,0)
 ;
"RTN","ORWORB",74,0)
GETDATA(ORY,XQAID) ; return XQADATA for an alert
"RTN","ORWORB",75,0)
 N SHOWADD
"RTN","ORWORB",76,0)
 S ORY=""
"RTN","ORWORB",77,0)
 Q:$G(XQAID)=""!('$D(^XTV(8992,"AXQA",XQAID)))
"RTN","ORWORB",78,0)
 D GETACT^XQALERT(XQAID)
"RTN","ORWORB",79,0)
 S ORY=XQADATA
"RTN","ORWORB",80,0)
 I ($E(XQAID,1,3)="TIU"),(+ORY>0) D
"RTN","ORWORB",81,0)
 . S SHOWADD=1
"RTN","ORWORB",82,0)
 . S ORY=ORY_$$RESOLVE^TIUSRVLO(+ORY)
"RTN","ORWORB",83,0)
 K XQAID,XQADATA,XQAOPT,XQAROU
"RTN","ORWORB",84,0)
 Q
"RTN","ORWORB",85,0)
 ;
"RTN","ORWORB",86,0)
KILUNSNO(Y,ORVP) ; Delete unsigned order alerts if no unsigned orders remaining
"RTN","ORWORB",87,0)
 S ORVP=ORVP_";DPT("
"RTN","ORWORB",88,0)
 D UNOTIF^ORCSIGN
"RTN","ORWORB",89,0)
 Q
"RTN","ORWORB",90,0)
 ;
"RTN","ORWORB",91,0)
UNFLORD(ORY,DFN,XQAID) ; -- auto-unflag orders?/delete alert
"RTN","ORWORB",92,0)
 Q:'$L(DFN)!('$L(XQAID))
"RTN","ORWORB",93,0)
 N ORI,ORIFN,ORA,XQAKILL,ORN,ORBY,ORAUTO,ORUNF
"RTN","ORWORB",94,0)
 S ORN=+$O(^ORD(100.9,"B","FLAGGED ORDERS",0))
"RTN","ORWORB",95,0)
 ;S XQAKILL=$$XQAKILL^ORB3F1(ORN)
"RTN","ORWORB",96,0)
 D LIST^ORQOR1(.ORBY,DFN,"ALL",12,"","")
"RTN","ORWORB",97,0)
 S ORAUTO=+$$GET^XPAR("ALL","ORPF AUTO UNFLAG")
"RTN","ORWORB",98,0)
 S ORI=0 F  S ORI=$O(ORBY(ORI)) Q:ORI'>0  D
"RTN","ORWORB",99,0)
 . I ORAUTO D  ; unflag
"RTN","ORWORB",100,0)
 . . ;DJE-VM *329 - use GUI RPC call to make it run the proper code, only run it if the user sees it.
"RTN","ORWORB",101,0)
 . . ;S ORUNF=+$E($$NOW^XLFDT,1,12)_U_DUZ_"^Auto-Unflagged"
"RTN","ORWORB",102,0)
 . . ;S ORIFN=$P(ORBY(ORI),U),ORA=+$P(ORIFN,";",2)
"RTN","ORWORB",103,0)
 . . ;I ORIFN,$D(^OR(100,+ORIFN,0)) S $P(^(8,ORA,3),U)=0,$P(^(3),U,6,8)=ORUNF D MSG^ORCFLAG(ORIFN) ; unflag
"RTN","ORWORB",104,0)
 . . S ORIFN=+ORBY(ORI)
"RTN","ORWORB",105,0)
 . . I $D(^OR(100,ORIFN,0)),'$$FLAGRULE^ORWORR1(ORIFN) D UNFLAG^ORWDXA(.ORUNF,$P(ORBY(ORI),U),"Auto-Unflagged")
"RTN","ORWORB",106,0)
 ;DJE-VM *329 - ORWDXA is smarter and deletes the appropriate alert(s)
"RTN","ORWORB",107,0)
 ;I (ORAUTO)!(+$G(ORBY(1))=0) D DELETE^XQALERT
"RTN","ORWORB",108,0)
 Q
"RTN","ORWORB",109,0)
KILEXMED(Y,ORDFN)  ; -- Delete expiring meds notification if no expiring meds remaining
"RTN","ORWORB",110,0)
 N ORDG,ORLST S ORDG=$$DG^ORQOR1("RX")
"RTN","ORWORB",111,0)
 D AGET^ORWORR(.ORLST,ORDFN,5,ORDG)
"RTN","ORWORB",112,0)
 Q:+(@ORLST@(.1))  ;more left
"RTN","ORWORB",113,0)
 N XQAKILL,ORNIFN,ORVP,ORIO S OROI=""
"RTN","ORWORB",114,0)
 F OROI="INPT","OUTPT" D
"RTN","ORWORB",115,0)
 .S ORNIFN=$O(^ORD(100.9,"B","MEDICATIONS EXPIRING - "_OROI,0)),ORVP=ORDFN_";DPT("
"RTN","ORWORB",116,0)
 .Q:'$L($G(ORNIFN))
"RTN","ORWORB",117,0)
 .S XQAKILL=$$XQAKILL^ORB3F1(ORNIFN) ; expiring meds notif
"RTN","ORWORB",118,0)
 .I $D(XQAID) D DELETE^XQALERT
"RTN","ORWORB",119,0)
 .I '$D(XQAID) S XQAID=$P($G(^ORD(100.9,ORNIFN,0)),U,2)_","_+ORVP_","_ORNIFN D DELETEA^XQALERT K XQAID
"RTN","ORWORB",120,0)
 Q
"RTN","ORWORB",121,0)
KILEXOI(Y,ORDFN,ORNIFN)  ; -- Delete expiring flagged OI notification if no flagged expiring OI remaining
"RTN","ORWORB",122,0)
 N ORDG,ORLST S ORDG=$$DG^ORQOR1("ALL")
"RTN","ORWORB",123,0)
 D AGET^ORWORR(.ORLST,ORDFN,5,ORDG)
"RTN","ORWORB",124,0)
 Q:+(@ORLST@(.1))  ;more left
"RTN","ORWORB",125,0)
 N XQAKILL,ORVP
"RTN","ORWORB",126,0)
 S ORVP=ORDFN_";DPT("
"RTN","ORWORB",127,0)
 S XQAKILL=$$XQAKILL^ORB3F1(ORNIFN) ; flagged expiring OI notifications
"RTN","ORWORB",128,0)
 I $D(XQAID) D DELETE^XQALERT
"RTN","ORWORB",129,0)
 I '$D(XQAID) S XQAID=$P($G(^ORD(100.9,ORNIFN,0)),U,2)_","_+ORVP_","_ORNIFN D DELETEA^XQALERT K XQAID
"RTN","ORWORB",130,0)
 Q
"RTN","ORWORB",131,0)
KILUNVOR(Y,ORDFN)  ; -- Delete UNVERIFIED ORDER notification if none remaining within current admission/30 days
"RTN","ORWORB",132,0)
 N DFN,ORDG,ORLST,ORBDT,OREDT,ORDDT S ORDG=$$DG^ORQOR1("ALL")
"RTN","ORWORB",133,0)
 S OREDT=$$NOW^XLFDT
"RTN","ORWORB",134,0)
 S ORDDT=$$FMADD^XLFDT(OREDT,"-90")
"RTN","ORWORB",135,0)
 ;get current admission date/time:
"RTN","ORWORB",136,0)
 S DFN=ORDFN,VA200="" D INP^VADPT
"RTN","ORWORB",137,0)
 S ORBDT=$P($G(VAIN(7)),U)
"RTN","ORWORB",138,0)
 S ORBDT=$S('$L($G(ORBDT)):$$FMADD^XLFDT(OREDT,"-30"),1:ORBDT)  ;<= if no admission use past 30 days
"RTN","ORWORB",139,0)
 S ORBDT=$S(ORDDT>ORBDT:ORDDT,1:ORBDT)  ;max past days to use is 90 days
"RTN","ORWORB",140,0)
 D AGET^ORWORR(.ORLST,ORDFN,9,ORDG,ORBDT,OREDT)
"RTN","ORWORB",141,0)
 Q:+(@ORLST@(.1))  ;more left
"RTN","ORWORB",142,0)
 N XQAKILL,ORVP,ORNIFN
"RTN","ORWORB",143,0)
 S ORNIFN=$O(^ORD(100.9,"B","UNVERIFIED ORDER",0)),ORVP=ORDFN_";DPT("
"RTN","ORWORB",144,0)
 S XQAKILL=$$XQAKILL^ORB3F1(ORNIFN)
"RTN","ORWORB",145,0)
 I $D(XQAID) D DELETE^XQALERT
"RTN","ORWORB",146,0)
 I '$D(XQAID) S XQAID=$P($G(^ORD(100.9,ORNIFN,0)),U,2)_","_+ORVP_","_ORNIFN D DELETEA^XQALERT K XQAID
"RTN","ORWORB",147,0)
 Q
"RTN","ORWORB",148,0)
KILUNVMD(Y,ORDFN)  ; -- Delete UNVERIFIED MEDS notification if none remaining within current admission/30 days
"RTN","ORWORB",149,0)
 N DFN,ORDG,ORLST,ORBDT,OREDT,ORDDT S ORDG=$$DG^ORQOR1("RX")
"RTN","ORWORB",150,0)
 S OREDT=$$NOW^XLFDT
"RTN","ORWORB",151,0)
 S ORDDT=$$FMADD^XLFDT(OREDT,"-90")
"RTN","ORWORB",152,0)
 ;get current admission date/time:
"RTN","ORWORB",153,0)
 S DFN=ORDFN,VA200="" D INP^VADPT
"RTN","ORWORB",154,0)
 S ORBDT=$P($G(VAIN(7)),U)
"RTN","ORWORB",155,0)
 S ORBDT=$S('$L($G(ORBDT)):$$FMADD^XLFDT(OREDT,"-30"),1:ORBDT)  ;<= if no admission use past 30 days
"RTN","ORWORB",156,0)
 S ORBDT=$S(ORDDT>ORBDT:ORDDT,1:ORBDT)  ;max past days to use is 90 days
"RTN","ORWORB",157,0)
 D AGET^ORWORR(.ORLST,ORDFN,9,ORDG,ORBDT,OREDT)
"RTN","ORWORB",158,0)
 Q:+(@ORLST@(.1))  ;more left
"RTN","ORWORB",159,0)
 N XQAKILL,ORVP,ORNIFN
"RTN","ORWORB",160,0)
 S ORNIFN=$O(^ORD(100.9,"B","UNVERIFIED MEDICATION ORDER",0)),ORVP=ORDFN_";DPT("
"RTN","ORWORB",161,0)
 S XQAKILL=$$XQAKILL^ORB3F1(ORNIFN)
"RTN","ORWORB",162,0)
 I $D(XQAID) D DELETE^XQALERT
"RTN","ORWORB",163,0)
 I '$D(XQAID) S XQAID=$P($G(^ORD(100.9,ORNIFN,0)),U,2)_","_+ORVP_","_ORNIFN D DELETEA^XQALERT K XQAID
"RTN","ORWORB",164,0)
 Q
"RTN","ORWORB",165,0)
ESORD(ORY,XQAID)   ;order(s) requiring electronic signature follow-up
"RTN","ORWORB",166,0)
 K XQAKILL
"RTN","ORWORB",167,0)
 N ORPT,ORDG,ORBXQAID,ORY,ORX,ORZ,ORDERS,ORDNUM,ORQUIT,ORBLMDEL
"RTN","ORWORB",168,0)
 S ORBXQAID=XQAID,ORDERS=0,ORQUIT=0
"RTN","ORWORB",169,0)
 S ORPT=$P($P(XQAID,";"),",",2)  ;get pt dfn from xqaid
"RTN","ORWORB",170,0)
 S ORDG=$$DG^ORQOR1("ALL")
"RTN","ORWORB",171,0)
 ;the FLG code for UNSIGNED orders in ORQ1 is '11'
"RTN","ORWORB",172,0)
 ;get unsigned orders - if none exist, delete alert then quit:
"RTN","ORWORB",173,0)
 D EN^ORQ1(ORPT_";DPT(",ORDG,11,"","","",0,0)
"RTN","ORWORB",174,0)
 S ORX="",ORX=$O(^TMP("ORR",$J,ORX)) Q:ORX=""  I +$G(^TMP("ORR",$J,ORX,"TOT"))<1 D DEL^ORB3FUP1(.ORY,ORBXQAID) K ^TMP("ORR",$J) Q
"RTN","ORWORB",175,0)
 ;
"RTN","ORWORB",176,0)
 ;user does not have ORES key, delete user's alert:
"RTN","ORWORB",177,0)
 I '$D(^XUSEC("ORES",DUZ)) S XQAKILL=1 D DEL^ORB3FUP1(.ORY,ORBXQAID) K ^TMP("ORR",$J) Q
"RTN","ORWORB",178,0)
 ;
"RTN","ORWORB",179,0)
 ;if prov is NOT linked to pt via attending, primary or teams:
"RTN","ORWORB",180,0)
 I $$PPLINK^ORQPTQ1(DUZ,ORPT)=0 D
"RTN","ORWORB",181,0)
 .S ORX="" F  S ORX=$O(^TMP("ORR",$J,ORX)) Q:ORX=""!(ORDERS=1)  D
"RTN","ORWORB",182,0)
 ..S ORZ="" F  S ORZ=$O(^TMP("ORR",$J,ORX,ORZ)) Q:+ORZ=0!(ORDERS=1)  D
"RTN","ORWORB",183,0)
 ...S ORDNUM=^TMP("ORR",$J,ORX,ORZ)
"RTN","ORWORB",184,0)
 ...;quit if this unsigned order's last action was made by the user
"RTN","ORWORB",185,0)
 ...I DUZ=+$$UNSIGNOR^ORQOR2(ORDNUM) S ORDERS=1
"RTN","ORWORB",186,0)
 .I ORDERS'=1 D  ;provider has no outstanding unsigned orders for pt
"RTN","ORWORB",187,0)
 ..S XQAKILL=1 D DEL^ORB3FUP1(.ORY,ORBXQAID)  ;delete alert for this user
"RTN","ORWORB",188,0)
 K ^TMP("ORR",$J)
"RTN","ORWORB",189,0)
 Q
"RTN","ORWORB",190,0)
 ;
"RTN","ORWORB",191,0)
TXTFUP(ROOT,DFN,NOTIF,XQADATA) ; Follow-up for text messages
"RTN","ORWORB",192,0)
 ;
"RTN","ORWORB",193,0)
 I NOTIF=67 D CHGRAD
"RTN","ORWORB",194,0)
 Q
"RTN","ORWORB",195,0)
 ;
"RTN","ORWORB",196,0)
CHGRAD ;GUI follow-up for Imaging Request Changed (#67)
"RTN","ORWORB",197,0)
 S ROOT=$NA(^TMP($J,"RAE4"))
"RTN","ORWORB",198,0)
 K @ROOT
"RTN","ORWORB",199,0)
 D SET1^RAO7PC4  ;DBIA #3563
"RTN","ORWORB",200,0)
 Q
"RTN","ORWORB",201,0)
 ;
"RTN","ORWORB",202,0)
GETSORT(ORY) ;return notification sort method^direction for user/division/system/pkg
"RTN","ORWORB",203,0)
 S ORY=$$GET^XPAR("ALL","ORB SORT METHOD",1,"I")_U_$$GET^XPAR("ALL","ORB SORT DIRECTION",1,"I")
"RTN","ORWORB",204,0)
 Q
"RTN","ORWORB",205,0)
 ;
"RTN","ORWORB",206,0)
SETSORT(ORERR,SORT,DIR) ;set notification sort method^direction for user
"RTN","ORWORB",207,0)
 D EN^XPAR(DUZ_";VA(200,","ORB SORT METHOD",1,SORT,.ORERR)
"RTN","ORWORB",208,0)
 I $L($G(DIR)) D EN^XPAR(DUZ_";VA(200,","ORB SORT DIRECTION",1,DIR,.ORERR)
"RTN","ORWORB",209,0)
 Q
"VER")
8.0^22.0
"BLD",7776,6)
^295
**END**
**END**
