EMERGENCY Released OR*3*346 SEQ #292
Extracted from mail message
**KIDS**:OR*3.0*346^

**INSTALL NAME**
OR*3.0*346
"BLD",8055,0)
OR*3.0*346^ORDER ENTRY/RESULTS REPORTING^0^3110727^y
"BLD",8055,4,0)
^9.64PA^^
"BLD",8055,6)
2^
"BLD",8055,6.3)
5
"BLD",8055,"ABPKG")
n
"BLD",8055,"KRN",0)
^9.67PA^779.2^20
"BLD",8055,"KRN",.4,0)
.4
"BLD",8055,"KRN",.401,0)
.401
"BLD",8055,"KRN",.402,0)
.402
"BLD",8055,"KRN",.403,0)
.403
"BLD",8055,"KRN",.5,0)
.5
"BLD",8055,"KRN",.84,0)
.84
"BLD",8055,"KRN",3.6,0)
3.6
"BLD",8055,"KRN",3.8,0)
3.8
"BLD",8055,"KRN",9.2,0)
9.2
"BLD",8055,"KRN",9.8,0)
9.8
"BLD",8055,"KRN",9.8,"NM",0)
^9.68A^8^8
"BLD",8055,"KRN",9.8,"NM",1,0)
ORCHECK^^0^B109156050
"BLD",8055,"KRN",9.8,"NM",2,0)
ORQ2^^0^B51979169
"BLD",8055,"KRN",9.8,"NM",3,0)
OROCAPI1^^0^B44857555
"BLD",8055,"KRN",9.8,"NM",4,0)
ORCSAVE2^^0^B84601504
"BLD",8055,"KRN",9.8,"NM",5,0)
ORKCHK6^^0^B26376206
"BLD",8055,"KRN",9.8,"NM",6,0)
ORWDXC^^0^B61402104
"BLD",8055,"KRN",9.8,"NM",7,0)
ORKPS1^^0^B71033645
"BLD",8055,"KRN",9.8,"NM",8,0)
ORKPS^^0^B67862708
"BLD",8055,"KRN",9.8,"NM","B","ORCHECK",1)

"BLD",8055,"KRN",9.8,"NM","B","ORCSAVE2",4)

"BLD",8055,"KRN",9.8,"NM","B","ORKCHK6",5)

"BLD",8055,"KRN",9.8,"NM","B","ORKPS",8)

"BLD",8055,"KRN",9.8,"NM","B","ORKPS1",7)

"BLD",8055,"KRN",9.8,"NM","B","OROCAPI1",3)

"BLD",8055,"KRN",9.8,"NM","B","ORQ2",2)

"BLD",8055,"KRN",9.8,"NM","B","ORWDXC",6)

"BLD",8055,"KRN",19,0)
19
"BLD",8055,"KRN",19.1,0)
19.1
"BLD",8055,"KRN",101,0)
101
"BLD",8055,"KRN",409.61,0)
409.61
"BLD",8055,"KRN",771,0)
771
"BLD",8055,"KRN",779.2,0)
779.2
"BLD",8055,"KRN",870,0)
870
"BLD",8055,"KRN",8989.51,0)
8989.51
"BLD",8055,"KRN",8989.52,0)
8989.52
"BLD",8055,"KRN",8994,0)
8994
"BLD",8055,"KRN","B",.4,.4)

"BLD",8055,"KRN","B",.401,.401)

"BLD",8055,"KRN","B",.402,.402)

"BLD",8055,"KRN","B",.403,.403)

"BLD",8055,"KRN","B",.5,.5)

"BLD",8055,"KRN","B",.84,.84)

"BLD",8055,"KRN","B",3.6,3.6)

"BLD",8055,"KRN","B",3.8,3.8)

"BLD",8055,"KRN","B",9.2,9.2)

"BLD",8055,"KRN","B",9.8,9.8)

"BLD",8055,"KRN","B",19,19)

"BLD",8055,"KRN","B",19.1,19.1)

"BLD",8055,"KRN","B",101,101)

"BLD",8055,"KRN","B",409.61,409.61)

"BLD",8055,"KRN","B",771,771)

"BLD",8055,"KRN","B",779.2,779.2)

"BLD",8055,"KRN","B",870,870)

"BLD",8055,"KRN","B",8989.51,8989.51)

"BLD",8055,"KRN","B",8989.52,8989.52)

"BLD",8055,"KRN","B",8994,8994)

"BLD",8055,"QUES",0)
^9.62^^
"BLD",8055,"REQB",0)
^9.611^1^1
"BLD",8055,"REQB",1,0)
OR*3.0*272^2
"BLD",8055,"REQB","B","OR*3.0*272",1)

"MBREQ")
0
"PKG",170,-1)
1^1
"PKG",170,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",170,20,0)
^9.402P^^
"PKG",170,22,0)
^9.49I^1^1
"PKG",170,22,1,0)
3.0^2971217^2980917^11712
"PKG",170,22,1,"PAH",1,0)
346^3110727^10000000191
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","ORCHECK")
0^1^B109156050^B109684735
"RTN","ORCHECK",1,0)
ORCHECK ;SLC/MKB-Order checking calls ;07/26/11  13:23
"RTN","ORCHECK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,70,94,141,215,243,293,280,346**;Dec 17, 1997;Build 5
"RTN","ORCHECK",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCHECK",4,0)
DISPLAY ; -- DISPLAY event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",5,0)
 ;    Expects ORVP, ORNMSP, ORTAB, [ORWARD]
"RTN","ORCHECK",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",7,0)
 N ORX,ORY,I
"RTN","ORCHECK",8,0)
 I ORNMSP="PS" D  ;reset to PSJ, PSJI, or PSO
"RTN","ORCHECK",9,0)
 . I $G(ORDG) S I=$P($G(^ORD(100.98,+ORDG,0)),U,3),I=$P(I," ") Q:'$L(I)  S ORNMSP="PS"_$S(I="UD":"I",1:I) Q
"RTN","ORCHECK",10,0)
 . I $G(ORXFER) S I=$P($P(^TMP("OR",$J,ORTAB,0),U,3),";",3) S:I="" I=$G(ORWARD) S ORNMSP="PS"_$S(I:"O",1:"I") ;opposite of list
"RTN","ORCHECK",11,0)
 S ORX(1)="|"_ORNMSP,ORX=1
"RTN","ORCHECK",12,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"DISPLAY") Q:'$D(ORY)
"RTN","ORCHECK",13,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  W !,$P(ORY(I),U,4) ; display only
"RTN","ORCHECK",14,0)
 Q
"RTN","ORCHECK",15,0)
 ;
"RTN","ORCHECK",16,0)
SELECT ; -- SELECT event
"RTN","ORCHECK",17,0)
 ;    Expects ORVP, ORDAILOG(PROMPT,ORI), ORNMSP
"RTN","ORCHECK",18,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",19,0)
 N ORX,ORY,OI
"RTN","ORCHECK",20,0)
 S OI=+$G(ORDIALOG(PROMPT,ORI))
"RTN","ORCHECK",21,0)
 S ORX=1,ORX(1)=OI_"|"_ORNMSP_"|"_$$USID^ORMBLD(OI)
"RTN","ORCHECK",22,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,"SELECT"),RETURN:$D(ORY)
"RTN","ORCHECK",23,0)
 Q
"RTN","ORCHECK",24,0)
 ;
"RTN","ORCHECK",25,0)
ACCEPT(MODE) ; -- ACCEPT event [called from ORCDLG,ORCACT4,ORCMED]
"RTN","ORCHECK",26,0)
 ;    Expects ORVP, ORDIALOG(), ORNMSP
"RTN","ORCHECK",27,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",28,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",29,0)
 N ORX,ORY,ORZ,OI,ORSTRT,ORI,ORIT,ORID,ORSP
"RTN","ORCHECK",30,0)
 S:'$L($G(MODE)) MODE="ACCEPT"
"RTN","ORCHECK",31,0)
 S OI=$$PTR^ORCD("OR GTX ORDERABLE ITEM"),ORSTRT=$$START,ORX=0
"RTN","ORCHECK",32,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",33,0)
 I $G(ORDG)=+$O(^ORD(100.98,"B","IV RX",0)) S OI=$$PTR^ORCD("OR GTX ADDITIVE"),ORI=0 F  S ORI=$O(ORDIALOG(OI,ORI)) Q:ORI'>0  D STUF
"RTN","ORCHECK",34,0)
 D EN^ORKCHK(.ORY,+ORVP,.ORX,MODE),RETURN:$D(ORY),FDBDOWN(0)
"RTN","ORCHECK",35,0)
 Q
"RTN","ORCHECK",36,0)
STUF S ORIT=ORDIALOG(OI,ORI),ORSP=""
"RTN","ORCHECK",37,0)
 S:ORNMSP="LR" ORSP=+$G(ORDIALOG($$PTR^ORCD("OR GTX SPECIMEN"),ORI))
"RTN","ORCHECK",38,0)
 S ORID=$S($E(ORNMSP,1,2)="PS":$$DRUG(ORIT,OI),1:$$USID^ORMBLD(ORIT))
"RTN","ORCHECK",39,0)
 S ORZ=1,ORZ(1)=ORIT_"|"_ORNMSP_"|"_ORID
"RTN","ORCHECK",40,0)
 I MODE'="ALL" D EN^ORKCHK(.ORY,+ORVP,.ORZ,"SELECT"),RETURN:$D(ORY)
"RTN","ORCHECK",41,0)
 S ORX=ORX+1,ORX(ORX)=ORZ(1)_"|"_ORSTRT_"||"_ORSP K ORY,ORZ
"RTN","ORCHECK",42,0)
 Q
"RTN","ORCHECK",43,0)
 ;
"RTN","ORCHECK",44,0)
DELAY(MODE) ; -- Delayed ACCEPT event [called from ORMEVNT]
"RTN","ORCHECK",45,0)
 ;    Expects ORVP, ORIFN
"RTN","ORCHECK",46,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",47,0)
 N ORX,ORY,ORCHECK S:'$L($G(MODE)) MODE="NOTIF"
"RTN","ORCHECK",48,0)
 D BLD(+ORIFN),EN^ORKCHK(.ORY,+ORVP,.ORX,MODE) Q:'$D(ORY)
"RTN","ORCHECK",49,0)
 D RETURN I MODE="NOTIF" S ORCHECK("OK")="Notification sent to provider" D OC^ORCSAVE2 Q  ; silent
"RTN","ORCHECK",50,0)
 Q
"RTN","ORCHECK",51,0)
 ;
"RTN","ORCHECK",52,0)
BLD(ORDER) ; -- Build new ORX(#) for ORDER
"RTN","ORCHECK",53,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,ORDER,0))  ;Q:$P($G(^(3)),U,11)  ;edit/renew
"RTN","ORCHECK",54,0)
 N PKG,START,ORI,ITEM,USID,SPEC,ORDG,PTR,INST
"RTN","ORCHECK",55,0)
 S ORDG=$P(^OR(100,ORDER,0),U,11),PKG=$$GET1^DIQ(9.4,$P(^(0),U,14)_",",1)
"RTN","ORCHECK",56,0)
 I PKG="PS",$G(ORDG) S ORI=$P($G(^ORD(100.98,+ORDG,0)),U,3),ORI=$P(ORI," "),PKG=PKG_$S(ORI="UD":"I",1:ORI)
"RTN","ORCHECK",57,0)
 S START=$$START(ORDER),ORI=0
"RTN","ORCHECK",58,0)
 F  S ORI=$O(^OR(100,ORDER,4.5,"ID","ORDERABLE",ORI)) Q:ORI'>0  D
"RTN","ORCHECK",59,0)
 . S INST=$P($G(^OR(100,ORDER,4.5,ORI,0)),U,3),PTR=$P($G(^(0)),U,2),ITEM=+$G(^(1))
"RTN","ORCHECK",60,0)
 . S USID=$S(PKG?1"PS".E:$$DRUG(ITEM,PTR,ORDER),1:$$USID^ORMBLD(ITEM))
"RTN","ORCHECK",61,0)
 . S SPEC=$S(PKG="LR":$$VALUE^ORCSAVE2(ORDER,"SPECIMEN",INST),1:"")
"RTN","ORCHECK",62,0)
 . S ORX=+$G(ORX)+1,ORX(ORX)=ITEM_"|"_PKG_"|"_USID_"|"_START_"|"_ORDER_"|"_SPEC
"RTN","ORCHECK",63,0)
 Q
"RTN","ORCHECK",64,0)
 ;
"RTN","ORCHECK",65,0)
REMDUPS ;
"RTN","ORCHECK",66,0)
 N IFN,CDL,I
"RTN","ORCHECK",67,0)
 S IFN=0 F  S IFN=$O(ORCHECK(IFN)) Q:'IFN  D
"RTN","ORCHECK",68,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORCHECK",69,0)
 . . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORCHECK",70,0)
 . . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $TR($P($G(ORCHECK(IFN,CDL,I)),U,3),";",",")=$TR($P($G(ORCHECK(IFN,CDL,J)),U,3),";",",") K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORCHECK",71,0)
 Q
"RTN","ORCHECK",72,0)
START(DA) ; -- Returns start date/time
"RTN","ORCHECK",73,0)
 N I,X,Y,%DT S Y=""
"RTN","ORCHECK",74,0)
 I $G(DA) S X=$O(^OR(100,DA,4.5,"ID","START",0)),X=$G(^OR(100,DA,4.5,+X,1))
"RTN","ORCHECK",75,0)
 E  D  ; look in ORDIALOG instead
"RTN","ORCHECK",76,0)
 . S I=0 F  S I=$O(ORDIALOG(I)) Q:I'>0  Q:$P(ORDIALOG(I),U,2)="START"
"RTN","ORCHECK",77,0)
 . S X=$S(I:$G(ORDIALOG(I,1)),1:"")
"RTN","ORCHECK",78,0)
 D AM^ORCSAVE2:X="AM",NEXT^ORCSAVE2:X="NEXT"
"RTN","ORCHECK",79,0)
 D ADMIN^ORCSAVE2("NEXT"):X="NEXTA",ADMIN^ORCSAVE2("CLOSEST"):X="CLOSEST"
"RTN","ORCHECK",80,0)
 I $L(X) S %DT="TX" D ^%DT S:Y'>0 Y=""
"RTN","ORCHECK",81,0)
 Q Y
"RTN","ORCHECK",82,0)
 ;
"RTN","ORCHECK",83,0)
DRUG(OI,PTR,IFN) ; -- Returns 6 ^-piece identifier for Dispense Drug
"RTN","ORCHECK",84,0)
 N ORDD,ORNDF,Y
"RTN","ORCHECK",85,0)
 I ORDG=+$O(^ORD(100.98,"B","IV RX",0)) S ORDD=$$IV G D1
"RTN","ORCHECK",86,0)
 I $G(IFN) S ORDD=$O(^OR(100,IFN,4.5,"ID","DRUG",0)),ORDD=+$G(^OR(100,IFN,4.5,+ORDD,1))
"RTN","ORCHECK",87,0)
 E  S ORDD=+$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORCHECK",88,0)
D1 Q:'ORDD "" S ORNDF=$$ENDCM^PSJORUTL(ORDD)
"RTN","ORCHECK",89,0)
 S Y=$P(ORNDF,U,3)_"^^99NDF^"_ORDD_U_$$NAME50^ORPEAPI(ORDD)_"^99PSD"
"RTN","ORCHECK",90,0)
 Q Y
"RTN","ORCHECK",91,0)
 ;
"RTN","ORCHECK",92,0)
IV() ; -- Get Dispense Drug for IV orderable
"RTN","ORCHECK",93,0)
 N PSOI,TYPE,VOL,ORY
"RTN","ORCHECK",94,0)
 S PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2),VOL=""
"RTN","ORCHECK",95,0)
 S TYPE=$S(PTR=$$PTR^ORCD("OR GTX ADDITIVE"):"A",1:"B")
"RTN","ORCHECK",96,0)
 S:TYPE="B" VOL=$S($G(IFN):$$VALUE^ORCSAVE2(IFN,"VOLUME"),1:+$G(ORDIALOG($$PTR^ORCD("OR GTX VOLUME"),1)))
"RTN","ORCHECK",97,0)
 D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORY)
"RTN","ORCHECK",98,0)
 Q +$G(ORY)
"RTN","ORCHECK",99,0)
 ;
"RTN","ORCHECK",100,0)
LIST(IFN) ; -- Displays list of ORCHECK(IFN) checks
"RTN","ORCHECK",101,0)
 N ORI,ORJ,ORZ,ORMAX,ORTX,ON,OFF
"RTN","ORCHECK",102,0)
 S ORZ=0 F  S ORZ=$O(ORCHECK(IFN,ORZ)) Q:ORZ'>0  D
"RTN","ORCHECK",103,0)
 . S:ORZ=1 ON=IOINHI,OFF=IOINORM S:ORZ'=1 (ON,OFF)="" ; use bold if High
"RTN","ORCHECK",104,0)
 . S ORI=0 F  S ORI=$O(ORCHECK(IFN,ORZ,ORI)) Q:ORI'>0  D
"RTN","ORCHECK",105,0)
 . . S X=$P(ORCHECK(IFN,ORZ,ORI),U,3) I $L(X)<75 W !,ON_">>>  "_X_OFF Q
"RTN","ORCHECK",106,0)
 . . S ORMAX=74 K ORTX D TXT^ORCHTAB Q:'$G(ORTX)  ; wrap
"RTN","ORCHECK",107,0)
 . . F ORJ=1:1:ORTX W !,ON_$S(ORJ=1:">>>  ",1:"      ")_ORTX(ORJ)_OFF
"RTN","ORCHECK",108,0)
 W !
"RTN","ORCHECK",109,0)
 Q
"RTN","ORCHECK",110,0)
 ;
"RTN","ORCHECK",111,0)
CANCEL() ; -- Returns 1 or 0: Cancel order(s)?
"RTN","ORCHECK",112,0)
 N X,Y,DIR,NUM
"RTN","ORCHECK",113,0)
 S NUM=+$G(ORCHECK("IFN")),DIR(0)="YA"
"RTN","ORCHECK",114,0)
 S DIR("A")="Do you want to cancel "_$S(NUM>1:"any of the new orders? ",1:"the new order? ")
"RTN","ORCHECK",115,0)
 S DIR("?",1)="Enter YES to cancel "_$S(NUM>1:"an",1:"the")_" order.  If you wish to override these order checks"
"RTN","ORCHECK",116,0)
 S DIR("?",2)="and release "_$S(NUM>1:"these orders",1:"this order")_", enter NO; you will be prompted for a justification",DIR("?")="if there are any highlighted critical order checks."
"RTN","ORCHECK",117,0)
 D ^DIR
"RTN","ORCHECK",118,0)
 Q +Y
"RTN","ORCHECK",119,0)
 ;
"RTN","ORCHECK",120,0)
REASON() ; -- Reason for overriding order checks
"RTN","ORCHECK",121,0)
 ; I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)) Q  ??
"RTN","ORCHECK",122,0)
 N X,Y,DIR
"RTN","ORCHECK",123,0)
 S DIR(0)="FA^2:80^K:X?1."" "" X",DIR("A")="REASON FOR OVERRIDE: "
"RTN","ORCHECK",124,0)
 S DIR("?")="Enter a justification for overriding these order checks, up to 80 characters"
"RTN","ORCHECK",125,0)
 D ^DIR I $D(DTOUT)!$D(DUOUT) S Y="^"
"RTN","ORCHECK",126,0)
 Q Y
"RTN","ORCHECK",127,0)
 ;
"RTN","ORCHECK",128,0)
SESSION ; -- SESSION event [called from ORCSIGN]
"RTN","ORCHECK",129,0)
 ;    Expects ORVP, ORES()
"RTN","ORCHECK",130,0)
 K ^TMP($J,"ORK XTRA TXT")
"RTN","ORCHECK",131,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")'="E"
"RTN","ORCHECK",132,0)
 N ORX,ORY,ORIFN,I,X,Y,ORGLOB
"RTN","ORCHECK",133,0)
 S ORGLOB=$H
"RTN","ORCHECK",134,0)
 K ^TMP($J,ORGLOB)
"RTN","ORCHECK",135,0)
 S ORIFN=0 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  I +$P(ORIFN,";",2)'>1 D
"RTN","ORCHECK",136,0)
 . I "^14^13^11^10^"'[(U_$P($G(^OR(100,+ORIFN,3)),U,3)_U) Q  ;unreleased
"RTN","ORCHECK",137,0)
 . D BLD(+ORIFN) K ^TMP($J,"OCDATA") Q:'$$OCAPI^ORCHECK(+ORIFN,"OCDATA")
"RTN","ORCHECK",138,0)
 . S ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1
"RTN","ORCHECK",139,0)
 . S I=0 F  S I=$O(^TMP($J,"OCDATA",I)) Q:'I  D
"RTN","ORCHECK",140,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=32,$$ALGASS(+ORIFN)=1 Q
"RTN","ORCHECK",141,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC NUMBER"))=3 Q
"RTN","ORCHECK",142,0)
 . . I $G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." Q
"RTN","ORCHECK",143,0)
 . . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",144,0)
 . . I $O(^TMP($J,"OCDATA",I,"OC TEXT",1)) D
"RTN","ORCHECK",145,0)
 . . . S ORCHECK(+ORIFN,$S($G(^TMP($J,"OCDATA",I,"OC LEVEL")):^TMP($J,"OCDATA",I,"OC LEVEL"),1:99),ORCHECK)=$G(^TMP($J,"OCDATA",I,"OC NUMBER"))_U_$G(^TMP($J,"OCDATA",I,"OC LEVEL"))_U_"||"_ORGLOB_"&"_$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))_U_1
"RTN","ORCHECK",146,0)
 . . . N ORI S ORI=0 F  S ORI=$O(^TMP($J,"OCDATA",I,"OC TEXT",ORI)) Q:'ORI  S ^TMP($J,"ORK XTRA TXT",ORGLOB,^TMP($J,"OCDATA",I,"OC TEXT",1,0),ORI)=^TMP($J,"OCDATA",I,"OC TEXT",ORI,0)
"RTN","ORCHECK",147,0)
 . . I $D(^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)) D
"RTN","ORCHECK",148,0)
 . . . N ORMONOI S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",""),-1)+1
"RTN","ORCHECK",149,0)
 . . . M ^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),16)
"RTN","ORCHECK",150,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")=^ORD(100.05,^TMP($J,"OCDATA",I,"OC INSTANCE"),17)
"RTN","ORCHECK",151,0)
 . . . S ^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")=$G(^TMP($J,"OCDATA",I,"OC TEXT",1,0))
"RTN","ORCHECK",152,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORCHECK",153,0)
 I $D(ORX) D EN^ORKCHK(.ORY,+ORVP,.ORX,"SESSION"),RETURN:$D(ORY),FDBDOWN(1),REMDUPS
"RTN","ORCHECK",154,0)
 Q
"RTN","ORCHECK",155,0)
 ;
"RTN","ORCHECK",156,0)
FDBDOWN(ORX) ; -- Checks to see if the FDB was down and if so set appropriate OC
"RTN","ORCHECK",157,0)
 ; expects ORCHECK array of order checks
"RTN","ORCHECK",158,0)
 ; if ORX is 1 then this is getting called from SESSION order checks
"RTN","ORCHECK",159,0)
 Q:'$D(ORCHECK)
"RTN","ORCHECK",160,0)
 ;look for the "not able to be performed" OCs for each type (DSG and ENH), set flag for each to 1 if found and remove them from ORCHECK
"RTN","ORCHECK",161,0)
 N I S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORCHECK",162,0)
 .N ORNEXT,ORDSG,ORENH,ORTHERE
"RTN","ORCHECK",163,0)
 .S ORDSG=0,ORENH=0,ORTHERE=0
"RTN","ORCHECK",164,0)
 .N J S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORCHECK",165,0)
 ..N K S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORCHECK",166,0)
 ...S ORNEXT=K+1
"RTN","ORCHECK",167,0)
 ...I $G(ORCHECK(I,J,K))["Drug Dosage checks were not able to be performed." K ORCHECK(I,J,K) S ORDSG=1
"RTN","ORCHECK",168,0)
 ...I $G(ORCHECK(I,J,K))["Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed." K ORCHECK(I,J,K) S ORENH=1
"RTN","ORCHECK",169,0)
 ...I $G(ORCHECK(I,J,K))["These checks could not be completed for this patient:" S ORTHERE=1
"RTN","ORCHECK",170,0)
 .;if DSG or ENH flag is set then add to ORY
"RTN","ORCHECK",171,0)
 .I ORDSG!(ORENH) D
"RTN","ORCHECK",172,0)
 ..;look to see if message already exists
"RTN","ORCHECK",173,0)
 ..I ORTHERE Q
"RTN","ORCHECK",174,0)
 ..N ORKGLOB S ORKGLOB=$H
"RTN","ORCHECK",175,0)
 ..N ORMAIN S ORMAIN="These checks could not be completed for this patient:"
"RTN","ORCHECK",176,0)
 ..S ORCHECK(I,2,ORNEXT)="25^2^||"_ORKGLOB_"&"_ORMAIN
"RTN","ORCHECK",177,0)
 ..I $G(ORX) S ^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,0)=ORMAIN
"RTN","ORCHECK",178,0)
 ..N ORCNT S ORCNT=1
"RTN","ORCHECK",179,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Drug Interactions"
"RTN","ORCHECK",180,0)
 ..I ORENH S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Duplicate Therapy"
"RTN","ORCHECK",181,0)
 ..I '$G(ORX),ORDSG S ORCNT=ORCNT+1,^TMP($J,"ORK XTRA TXT",ORKGLOB,ORMAIN,ORCNT)="      Dosing Warnings"
"RTN","ORCHECK",182,0)
 Q
"RTN","ORCHECK",183,0)
 ;
"RTN","ORCHECK",184,0)
RETURN ; -- Return checks in ORCHECK(ORIFN,CDL,#)
"RTN","ORCHECK",185,0)
 N I,IFN,CDL S I=0 F  S I=$O(ORY(I)) Q:I'>0  D
"RTN","ORCHECK",186,0)
 . S IFN=+$P(ORY(I),U) S:'IFN IFN="NEW"
"RTN","ORCHECK",187,0)
 . S CDL=+$P(ORY(I),U,3) S:'CDL CDL=99
"RTN","ORCHECK",188,0)
 . S:'$D(ORCHECK(IFN)) ORCHECK("IFN")=+$G(ORCHECK("IFN"))+1 ; count
"RTN","ORCHECK",189,0)
 . S ORCHECK=+$G(ORCHECK)+1,ORCHECK(IFN,CDL,ORCHECK)=$P(ORY(I),U,2,4)
"RTN","ORCHECK",190,0)
 Q
"RTN","ORCHECK",191,0)
 ;
"RTN","ORCHECK",192,0)
ALGASS(ORIFN) ;see if patient from order has an allergy assessment
"RTN","ORCHECK",193,0)
 N ORDFN S ORDFN=+$P(^OR(100,ORIFN,0),U,2)
"RTN","ORCHECK",194,0)
 K ORARRAY D EN1^GMRAOR1(ORDFN,"ORARRAY")
"RTN","ORCHECK",195,0)
 I ORARRAY'="" Q 1
"RTN","ORCHECK",196,0)
 Q 0
"RTN","ORCHECK",197,0)
OCAPI(IFN,ORPLACE) ;IA #4859
"RTN","ORCHECK",198,0)
 ;LOOK AT ROUTINE OROCAPI1 FOR MORE DETAILED APIS
"RTN","ORCHECK",199,0)
 ;API to get the order checking info for a specific order (IFN)
"RTN","ORCHECK",200,0)
 ;info is stored in ^TMP($J,ORPLACE)
"RTN","ORCHECK",201,0)
 ;               ^TMP($J,ORPLACE,D0,"OC LEVEL")="order check level"
"RTN","ORCHECK",202,0)
 ;                                                 ,"OC NUMBER")="file 100.8 ien"
"RTN","ORCHECK",203,0)
 ;                                                 ,"OC TEXT")="order check text"
"RTN","ORCHECK",204,0)
 ;                                                 ,"OR REASON")="over ride reason text"
"RTN","ORCHECK",205,0)
 ;                                                 ,"OR PROVIDER")="provider DUZ who entered over ride reason"
"RTN","ORCHECK",206,0)
 ;                                                 ,"OR DT")="date/time over ride reason was entered"
"RTN","ORCHECK",207,0)
 ; NOTE on OC LEVEL: 1 is HIGH, 2 is MODERATE, 3 is LOW
"RTN","ORCHECK",208,0)
 N RET,ORN,CNT,I,ORFLAG
"RTN","ORCHECK",209,0)
 S ORN=+IFN,CNT=0,ORFLAG=0
"RTN","ORCHECK",210,0)
 ;if the order is not released then show ACCEPTANCE_CPRS ocs
"RTN","ORCHECK",211,0)
 I "^14^13^11^10^"[(U_$P($G(^OR(100,ORN,3)),U,3)_U) D GETOC5^OROCAPI1(ORN,"ACCEPTANCE_CPRS",.RET) S ORFLAG=1
"RTN","ORCHECK",212,0)
 ;if it has been signed then show SIGNATURE_CPRS ocs
"RTN","ORCHECK",213,0)
 I 'ORFLAG D GETOC5^OROCAPI1(ORN,"SIGNATURE_CPRS",.RET)
"RTN","ORCHECK",214,0)
 I $D(RET) S I=0 F  S I=$O(RET(ORN,"DATA",I)) Q:'I  S CNT=CNT+1 D
"RTN","ORCHECK",215,0)
 .S ^TMP($J,ORPLACE,CNT,"OC NUMBER")=$P($G(RET(ORN,"DATA",I,1)),U)
"RTN","ORCHECK",216,0)
 .S ^TMP($J,ORPLACE,CNT,"OC LEVEL")=$P($G(RET(ORN,"DATA",I,1)),U,2)
"RTN","ORCHECK",217,0)
 .M ^TMP($J,ORPLACE,CNT,"OC TEXT")=RET(ORN,"DATA",I,"OC")
"RTN","ORCHECK",218,0)
 .S ^TMP($J,ORPLACE,CNT,"OR REASON")=$G(RET(ORN,"DATA",I,"OR",1,0))
"RTN","ORCHECK",219,0)
 .S ^TMP($J,ORPLACE,CNT,"OR PROVIDER")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,4),1:"")
"RTN","ORCHECK",220,0)
 .S ^TMP($J,ORPLACE,CNT,"OR DT")=$S($L(^TMP($J,ORPLACE,CNT,"OR REASON")):$P($G(RET(ORN,"DATA",I,0)),U,5),1:"")
"RTN","ORCHECK",221,0)
 .S ^TMP($J,ORPLACE,CNT,"OR STATUS")=$P($G(RET(ORN,"DATA",I,0)),U,2)
"RTN","ORCHECK",222,0)
 .S ^TMP($J,ORPLACE,CNT,"OC INSTANCE")=I
"RTN","ORCHECK",223,0)
 Q CNT
"RTN","ORCHECK",224,0)
 ;
"RTN","ORCHECK",225,0)
ISMONO(ORY) ;returns 1 if there is monograph data for the orderchecks being presented to the user
"RTN","ORCHECK",226,0)
 S ORY=0
"RTN","ORCHECK",227,0)
 Q:'$$PATCH^XPDUTL("OR*3.0*272")
"RTN","ORCHECK",228,0)
 I $D(^TMP($J,"ORMONOGRAPH")) S ORY=1
"RTN","ORCHECK",229,0)
 Q
"RTN","ORCHECK",230,0)
GETMONOL(ORY) ;returns a list of monographs available for the orderchecks being presented to the user
"RTN","ORCHECK",231,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH"))
"RTN","ORCHECK",232,0)
 N I S I=0
"RTN","ORCHECK",233,0)
 F  S I=$O(^TMP($J,"ORMONOGRAPH",I)) Q:'I  D
"RTN","ORCHECK",234,0)
 .S ORY($G(^TMP($J,"ORMONOGRAPH",I,"INT")))=I_U_$G(^TMP($J,"ORMONOGRAPH",I,"INT"))
"RTN","ORCHECK",235,0)
 Q
"RTN","ORCHECK",236,0)
GETMONO(ORY,ORMONO) ;return a monograph
"RTN","ORCHECK",237,0)
 Q:'$D(^TMP($J,"ORMONOGRAPH",ORMONO))
"RTN","ORCHECK",238,0)
 K ^TMP($J,"ORMONORPC")
"RTN","ORCHECK",239,0)
 M ^TMP($J,"ORMONORPC")=^TMP($J,"ORMONOGRAPH",ORMONO,"DATA")
"RTN","ORCHECK",240,0)
 K ^TMP($J,"ORMONORPC",0)
"RTN","ORCHECK",241,0)
 S ORY=$NA(^TMP($J,"ORMONORPC")),@ORY=""
"RTN","ORCHECK",242,0)
 Q
"RTN","ORCHECK",243,0)
DELMONO(ORY) ;delete monograph data
"RTN","ORCHECK",244,0)
 K ^TMP($J,"ORMONOGRAPH"),^TMP($J,"ORMONORPC")
"RTN","ORCHECK",245,0)
 Q
"RTN","ORCHECK",246,0)
GETXTRA(ORY,ORGL,ORRULE) ;get extra text for an order check
"RTN","ORCHECK",247,0)
 ;^TMP($J,"ORK XTRA TXT") stores the text of order checks that are longer than a single line (reminder order checks)
"RTN","ORCHECK",248,0)
 Q:'$D(^TMP($J,"ORK XTRA TXT",ORGL,ORRULE))
"RTN","ORCHECK",249,0)
 M ORY=^TMP($J,"ORK XTRA TXT",ORGL,ORRULE)
"RTN","ORCHECK",250,0)
 Q
"RTN","ORCSAVE2")
0^4^B84601504^B84878914
"RTN","ORCSAVE2",1,0)
ORCSAVE2 ;SLC/MKB-Utilities to update an order ;03/16/11  10:47
"RTN","ORCSAVE2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**4,27,56,70,94,116,190,157,215,265,243,293,280,346**;Dec 17, 1997;Build 5
"RTN","ORCSAVE2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCSAVE2",4,0)
 ;
"RTN","ORCSAVE2",5,0)
STATUS(IFN,ST) ; -- Update status of order
"RTN","ORCSAVE2",6,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:$P($G(^(3)),U,3)=$G(ST)  ;no change
"RTN","ORCSAVE2",7,0)
 Q:'$G(ST)  Q:'$D(^ORD(100.01,+ST,0))
"RTN","ORCSAVE2",8,0)
 N NODE0,NODE3,ORNOW,DA,XACT,PROV,ORVP
"RTN","ORCSAVE2",9,0)
 S NODE3=$G(^OR(100,+IFN,3)),ORVP=$P($G(^(0)),U,2),ORNOW=$$NOW^XLFDT
"RTN","ORCSAVE2",10,0)
 S $P(NODE3,U)=ORNOW,$P(NODE3,U,3)=ST,^OR(100,+IFN,3)=NODE3
"RTN","ORCSAVE2",11,0)
 I (ST<3)!(ST=12)!(ST=13),$G(ORDCNTRL)'="ZC" D DATES(+IFN,,+$E(ORNOW,1,12))
"RTN","ORCSAVE2",12,0)
 I "^1^2^7^12^13^15^"[(U_ST_U) D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN
"RTN","ORCSAVE2",13,0)
 I $P(NODE3,U,9) D CKPARENT($P(NODE3,U,9)) ; ck siblings to update parent
"RTN","ORCSAVE2",14,0)
 D SETALL^ORDD100(+IFN)
"RTN","ORCSAVE2",15,0)
 Q
"RTN","ORCSAVE2",16,0)
 ;
"RTN","ORCSAVE2",17,0)
CKPARENT(ORIFN) ; -- Update status of parent order, if appropriate
"RTN","ORCSAVE2",18,0)
 N ORSTS,ALLRELSD,ALLDONE,DC,COMP,CH,CHSTS,ACTIVE,LAPS
"RTN","ORCSAVE2",19,0)
 Q:'$D(^OR(100,ORIFN,0))  S ORSTS=$P($G(^(3)),U,3)
"RTN","ORCSAVE2",20,0)
 I (ORSTS=11)!(ORSTS=10) S ALLRELSD=1 D  Q  ;Parent unrel'd - ck children
"RTN","ORCSAVE2",21,0)
 . F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLRELSD
"RTN","ORCSAVE2",22,0)
 . . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",23,0)
 . . S CHSTS=$P($G(^OR(100,CH,3)),U,3) S:CHSTS=11 ALLRELSD=0
"RTN","ORCSAVE2",24,0)
 . I ALLRELSD D STATUS(ORIFN,5) ; update Parent order to pending
"RTN","ORCSAVE2",25,0)
 S ALLDONE=1,(DC,COMP,LAPS,ACTIVE)=0
"RTN","ORCSAVE2",26,0)
 F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLDONE
"RTN","ORCSAVE2",27,0)
 . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",28,0)
 . S CHSTS=$P($G(^OR(100,CH,3)),U,3) I CHSTS=14 S LAPS=1 Q
"RTN","ORCSAVE2",29,0)
 . I "^1^12^13^"[(U_CHSTS_U) S DC=1 Q
"RTN","ORCSAVE2",30,0)
 . I "^2^7^"[(U_CHSTS_U) S COMP=1 Q
"RTN","ORCSAVE2",31,0)
 . S ALLDONE=0 S:CHSTS=6 ACTIVE=1
"RTN","ORCSAVE2",32,0)
 I ALLDONE S ORSTS=$S(COMP:2,DC:1,LAPS:14,1:"") D:ORSTS STATUS(ORIFN,ORSTS) Q
"RTN","ORCSAVE2",33,0)
 I ACTIVE,ORSTS'=6 D STATUS(ORIFN,6) ;at least child active
"RTN","ORCSAVE2",34,0)
 Q
"RTN","ORCSAVE2",35,0)
 ;
"RTN","ORCSAVE2",36,0)
RELEASE(ORDER,ACTION,WHEN,WHO,NATURE) ; -- Mark order as released to service
"RTN","ORCSAVE2",37,0)
 S:'$G(ACTION) ACTION=1 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE2",38,0)
 Q:'$G(ORDER)  N OR0 S OR0=$G(^OR(100,ORDER,8,ACTION,0))
"RTN","ORCSAVE2",39,0)
 S:$L($G(NATURE)) $P(OR0,U,12)=$S(NATURE:NATURE,1:+$O(^ORD(100.02,"C",NATURE,0)))
"RTN","ORCSAVE2",40,0)
 S:($P(OR0,U,15)=10)!($P(OR0,U,15)=11) $P(OR0,U,15)=""
"RTN","ORCSAVE2",41,0)
 ;S $P(OR0,U,16,17)=WHEN_U_WHO,^OR(100,"AR",ORVP,9999999-WHEN,ORDER,ACTION)=""
"RTN","ORCSAVE2",42,0)
 S $P(OR0,U,16,17)=WHEN_U_WHO
"RTN","ORCSAVE2",43,0)
 S ^OR(100,ORDER,8,ACTION,0)=OR0
"RTN","ORCSAVE2",44,0)
 I $P(OR0,U,2)="NW",'$P(^OR(100,ORDER,0),U,8) D STARTDT(ORDER)
"RTN","ORCSAVE2",45,0)
 ;Set the "AR" index.
"RTN","ORCSAVE2",46,0)
 D RS^ORDD100(ORDER,ACTION,ORVP,WHEN)
"RTN","ORCSAVE2",47,0)
 Q
"RTN","ORCSAVE2",48,0)
 ;
"RTN","ORCSAVE2",49,0)
STARTDT(DA) ; -- resolve Start and Stop dates from Responses
"RTN","ORCSAVE2",50,0)
 N X,Y,%DT,ORDG,ORT,ORLAB
"RTN","ORCSAVE2",51,0)
 S ORDG=$P($G(^ORD(100.98,+$P(^OR(100,DA,0),U,11),0)),U,3)
"RTN","ORCSAVE2",52,0)
 S ORLAB="^LAB^CH^HEMA^MI^AP^AU^EM^SP^CY^BB^"[(U_ORDG_U),ORT=""
"RTN","ORCSAVE2",53,0)
 S:ORDG="E/L T" ORT=$$VALUE(DA,"TIME") S:ORDG="MEAL" ORT=$$MEALTIME^ORCDFHO(DA)
"RTN","ORCSAVE2",54,0)
STRT S X=$$VALUE(DA,"START") I '$L(X) D WS^ORDD100 Q  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",55,0)
 D AM:X="AM",NEXT:X="NEXT",ADMIN("NEXT"):X="NEXTA",ADMIN("CLOSEST"):X="CLOSEST"
"RTN","ORCSAVE2",56,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",57,0)
 S $P(^OR(100,DA,0),U,8)=Y D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",58,0)
STOP I ORLAB S X=$$VALUE(DA,"DAYS") Q:X'>1  S X=$$FMADD^XLFDT(Y,(X-1))
"RTN","ORCSAVE2",59,0)
 I 'ORLAB S X=$$VALUE(DA,"STOP") Q:'$L(X)  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",60,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",61,0)
 S $P(^OR(100,DA,0),U,9)=Y D ES^ORDD100A
"RTN","ORCSAVE2",62,0)
 Q
"RTN","ORCSAVE2",63,0)
 ;
"RTN","ORCSAVE2",64,0)
NEXT ; -- Resolve next lab collection to FM date/time
"RTN","ORCSAVE2",65,0)
 N ORTIME,ORDAY,NOW,NEXT,ENT
"RTN","ORCSAVE2",66,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",67,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",68,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",69,0)
 S NOW=$P($H,",",2),ORDAY=$S($O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",70,0)
 S ORDAY=$$NEXTCOLL^ORCDLR1(ORDAY) S:ORDAY["+" NOW=0
"RTN","ORCSAVE2",71,0)
 S NEXT=$O(ORTIME(NOW)),X=ORDAY_"@"_$P($G(ORTIME(+NEXT)),U)
"RTN","ORCSAVE2",72,0)
 Q
"RTN","ORCSAVE2",73,0)
 ;
"RTN","ORCSAVE2",74,0)
AM ; -- Resolve AM lab collection to FM date/time
"RTN","ORCSAVE2",75,0)
 N ORTIME,ORDAY,AM,NOW,ENT
"RTN","ORCSAVE2",76,0)
 ;is referenced by DBIA #964
"RTN","ORCSAVE2",77,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"
"RTN","ORCSAVE2",78,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",79,0)
 S AM=$O(ORTIME(0)),NOW=$P($H,",",2)
"RTN","ORCSAVE2",80,0)
 S ORDAY=$S(AM=$O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",81,0)
 S X=$$NEXTCOLL^ORCDLR1(ORDAY)_"@"_$P($G(ORTIME(+AM)),U)
"RTN","ORCSAVE2",82,0)
 Q
"RTN","ORCSAVE2",83,0)
 ;
"RTN","ORCSAVE2",84,0)
ADMIN(START) ; -- Resolve next/closest administration times to FM date/time
"RTN","ORCSAVE2",85,0)
 N PAT,SCH,OI,LOC,Y,I
"RTN","ORCSAVE2",86,0)
 I $G(DA) D  ;get data from order DA
"RTN","ORCSAVE2",87,0)
 . S PAT=+$P($G(^OR(100,DA,0)),U,2),LOC=""
"RTN","ORCSAVE2",88,0)
 . S I=+$O(^OR(100,DA,4.5,"ID","INSTR",0)),I=+$P($G(^OR(100,DA,4.5,I,0)),U,3) ;first
"RTN","ORCSAVE2",89,0)
 . S SCH=$$VALUE(DA,"SCHEDULE",I),OI=$$VALUE(DA,"ORDERABLE")
"RTN","ORCSAVE2",90,0)
 I '$G(DA) D  ;or look in ORDIALOG() instead
"RTN","ORCSAVE2",91,0)
 . S I=+$O(ORDIALOG($$PTR^ORCD("OR GTX INSTRUCTIONS"),0))
"RTN","ORCSAVE2",92,0)
 . S PAT=$G(ORVP),SCH=$G(ORDIALOG($$PTR^ORCD("OR GTX SCHEDULE"),I))
"RTN","ORCSAVE2",93,0)
 . S OI=$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1)),LOC=""
"RTN","ORCSAVE2",94,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2) ;PSOI
"RTN","ORCSAVE2",95,0)
 ;is referenced by DBIA #3167
"RTN","ORCSAVE2",96,0)
 S Y=$$RESOLVE^PSJORPOE(PAT,SCH,OI,START,LOC),X=$P(Y,U,2)
"RTN","ORCSAVE2",97,0)
 Q
"RTN","ORCSAVE2",98,0)
 ;
"RTN","ORCSAVE2",99,0)
SIGN(DA,WHO,WHEN,HOW,WHAT) ; -- affix ES to order
"RTN","ORCSAVE2",100,0)
 Q:'$G(DA)  S:'$G(WHAT) WHAT=1
"RTN","ORCSAVE2",101,0)
 N X S X=$G(^OR(100,DA,8,WHAT,0)) D S2^ORDD100(DA,WHAT) ; kill AS xref
"RTN","ORCSAVE2",102,0)
 S $P(X,U,4,7)=$G(HOW)_U_$G(WHO)_U_$E($G(WHEN),1,12)_U_$S(HOW=0:DUZ,1:"")
"RTN","ORCSAVE2",103,0)
 ; S:$G(WHO) $P(X,U,3)=WHO ; reset provider to signer
"RTN","ORCSAVE2",104,0)
 S ^OR(100,DA,8,WHAT,0)=X
"RTN","ORCSAVE2",105,0)
 D:$G(HOW)=2 S1^ORDD100(DA,WHAT) ; reset AS xref
"RTN","ORCSAVE2",106,0)
 Q
"RTN","ORCSAVE2",107,0)
 ;
"RTN","ORCSAVE2",108,0)
SIGSTS(IFN,ACT) ; -- Set SigSts for backdoor orders [Called from ^ORM* rtns]
"RTN","ORCSAVE2",109,0)
 ; Expects ORNATR, ORVP, ORNP to be defined
"RTN","ORCSAVE2",110,0)
 Q:'$G(IFN)  Q:'$G(ACT)  N X,OR0 S OR0=+$P($G(^OR(100,+IFN,8,ACT,0)),U)
"RTN","ORCSAVE2",111,0)
 S X=$S($$SIGNREQD^ORCACT1(+IFN):$$SIGSTS^ORX1(ORNATR),1:3)
"RTN","ORCSAVE2",112,0)
 K ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)
"RTN","ORCSAVE2",113,0)
 S $P(^OR(100,+IFN,8,ACT,0),U,4)=X
"RTN","ORCSAVE2",114,0)
 I X=2 S ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)="" D NOTIF^ORCSIGN
"RTN","ORCSAVE2",115,0)
 Q
"RTN","ORCSAVE2",116,0)
 ;
"RTN","ORCSAVE2",117,0)
UNVEIL(IFN) ; -- unveil new order
"RTN","ORCSAVE2",118,0)
 S $P(^OR(100,IFN,3),U,8)=""
"RTN","ORCSAVE2",119,0)
 Q
"RTN","ORCSAVE2",120,0)
 ;
"RTN","ORCSAVE2",121,0)
DELETE(ORDER) ; -- delete order [action]
"RTN","ORCSAVE2",122,0)
 N DIK,DA,DAD
"RTN","ORCSAVE2",123,0)
 I $P(ORDER,";",2)>1 S DA=+$P(ORDER,";",2),DA(1)=+ORDER,DIK="^OR(100,"_DA(1)_",8," D:DA ^DIK Q
"RTN","ORCSAVE2",124,0)
 S DAD=+$P($G(^OR(100,+ORDER,3)),U,9) I DAD S DIK="^OR(100,"_DAD_",2,",DA(1)=DAD,DA=+ORDER D ^DIK ; remove link to child from parent
"RTN","ORCSAVE2",125,0)
 K DA S DA=+ORDER,DIK="^OR(100," D ^DIK ;remove order, text
"RTN","ORCSAVE2",126,0)
 D DELETE^OROCAPI1(+ORDER)
"RTN","ORCSAVE2",127,0)
 Q
"RTN","ORCSAVE2",128,0)
 ;
"RTN","ORCSAVE2",129,0)
VERIFY(IFN,DA,TYPE,WHO,WHEN) ; -- order verified
"RTN","ORCSAVE2",130,0)
 Q:'$G(IFN)  Q:'$G(DA)  Q:"^N^C^R^"'[(U_$G(TYPE)_U)
"RTN","ORCSAVE2",131,0)
 N FLD S FLD=$S(TYPE="N":8,TYPE="C":10,1:18)
"RTN","ORCSAVE2",132,0)
 S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",133,0)
 S $P(^OR(100,IFN,8,DA,0),U,FLD,FLD+1)=WHO_U_WHEN
"RTN","ORCSAVE2",134,0)
 D:$L($T(VER^EDPFMON)) VER^EDPFMON(IFN)
"RTN","ORCSAVE2",135,0)
 Q
"RTN","ORCSAVE2",136,0)
 ;
"RTN","ORCSAVE2",137,0)
COMP(IFN,WHO,WHEN) ; -- order completed
"RTN","ORCSAVE2",138,0)
 Q:'$G(IFN)  S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",139,0)
 D DATES(+IFN,,WHEN),STATUS(+IFN,2)
"RTN","ORCSAVE2",140,0)
 S $P(^OR(100,+IFN,6),U,6,7)=WHEN_U_WHO
"RTN","ORCSAVE2",141,0)
 D:$L($T(COMP^EDPFMON)) COMP^EDPFMON(IFN)
"RTN","ORCSAVE2",142,0)
 Q
"RTN","ORCSAVE2",143,0)
 ;
"RTN","ORCSAVE2",144,0)
DATES(DA,START,STOP) ; -- Update start/stop dates for order DA
"RTN","ORCSAVE2",145,0)
 Q:'$G(DA)  I $G(START) D
"RTN","ORCSAVE2",146,0)
 . Q:START=$P(^OR(100,DA,0),U,8)
"RTN","ORCSAVE2",147,0)
 . D SK^ORDD100,WK^ORDD100,OI2^ORDD100A(DA)
"RTN","ORCSAVE2",148,0)
 . S $P(^OR(100,DA,0),U,8)=START
"RTN","ORCSAVE2",149,0)
 . D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",150,0)
 I $G(STOP) D
"RTN","ORCSAVE2",151,0)
 . ;Q:STOP=$P(^OR(100,DA,0),U,9)  ;ck xref anyway
"RTN","ORCSAVE2",152,0)
 . D EK^ORDD100A S $P(^OR(100,DA,0),U,9)=STOP D ES^ORDD100A
"RTN","ORCSAVE2",153,0)
 Q
"RTN","ORCSAVE2",154,0)
 ;
"RTN","ORCSAVE2",155,0)
OC ; -- Save order checks in ORCHECK() in ^OR(100,+ORIFN,9) ON SIGNATURE IN CPRS
"RTN","ORCSAVE2",156,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))
"RTN","ORCSAVE2",157,0)
 D DELOCC^OROCAPI1(+ORIFN,"SIGNATURE_CPRS")
"RTN","ORCSAVE2",158,0)
 N I,J,ORK,CNT,OC,OROCRET,ORKI
"RTN","ORCSAVE2",159,0)
 S CNT=0
"RTN","ORCSAVE2",160,0)
 S I=0 F  S I=$O(ORCHECK(+ORIFN,I)) Q:'I  D
"RTN","ORCSAVE2",161,0)
 . S J=0 F  S J=$O(ORCHECK(+ORIFN,I,J)) Q:'J  D
"RTN","ORCSAVE2",162,0)
 . . S OC=ORCHECK(+ORIFN,I,J)
"RTN","ORCSAVE2",163,0)
 . . S CNT=CNT+1
"RTN","ORCSAVE2",164,0)
 . . S ORK(CNT,1)=+ORIFN_U_"SIGNATURE_CPRS"_U_DUZ_U_$$NOW^XLFDT_U_+OC_U_I
"RTN","ORCSAVE2",165,0)
 . . S ORK(CNT,2)=$P(OC,U,3)
"RTN","ORCSAVE2",166,0)
 . . S ORK(CNT,3)=$S(I=1:$G(ORCHECK("OK")),1:"")
"RTN","ORCSAVE2",167,0)
 . . I $E(ORK(CNT,2),0,2)="||" D
"RTN","ORCSAVE2",168,0)
 . . . N ORGLOB,ORRULE,ORI
"RTN","ORCSAVE2",169,0)
 . . . S ORGLOB=$P($P(ORK(CNT,2),"||",2),"&"),ORRULE=$P($P(ORK(CNT,2),"||",2),"&",2)
"RTN","ORCSAVE2",170,0)
 . . . S ORK(CNT,2)=ORRULE
"RTN","ORCSAVE2",171,0)
 . . . N ORICNT S ORICNT=0
"RTN","ORCSAVE2",172,0)
 . . . S ORI=1 F  S ORI=$O(^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)) Q:'ORI  S ORICNT=ORICNT+1,ORK(CNT,2,ORICNT)=^TMP($J,"ORK XTRA TXT",ORGLOB,ORRULE,ORI)
"RTN","ORCSAVE2",173,0)
 I $D(ORK) D SAVEOC^OROCAPI1(.ORK,.OROCRET)
"RTN","ORCSAVE2",174,0)
 S ORKI=0 F  S ORKI=$O(ORK(ORKI)) Q:'ORKI  D
"RTN","ORCSAVE2",175,0)
 . N OCINST,OCTXT S OCTXT=$G(ORK(ORKI,2))
"RTN","ORCSAVE2",176,0)
 . S OCINST=$O(OROCRET(ORKI,0))
"RTN","ORCSAVE2",177,0)
 . N ORMONOI,ORMONOQ S ORMONOI=0,ORMONOQ=0 F  Q:ORMONOQ=1  S ORMONOI=$O(^TMP($J,"ORMONOGRAPH",ORMONOI)) Q:'ORMONOI  D
"RTN","ORCSAVE2",178,0)
 . . I OCTXT[$G(^TMP($J,"ORMONOGRAPH",ORMONOI,"OC")) D
"RTN","ORCSAVE2",179,0)
 . . . S ORMONOQ=1
"RTN","ORCSAVE2",180,0)
 . . . S ^ORD(100.05,OCINST,17)=^TMP($J,"ORMONOGRAPH",ORMONOI,"INT")
"RTN","ORCSAVE2",181,0)
 . . . M ^ORD(100.05,OCINST,16)=^TMP($J,"ORMONOGRAPH",ORMONOI,"DATA")
"RTN","ORCSAVE2",182,0)
 . . . S ^ORD(100.05,OCINST,16,0)="^^"_$O(^ORD(100.05,OCINST,16,""),-1)_U_$O(^ORD(100.05,OCINST,16,""),-1)_U_+$$NOW^XLFDT_U
"RTN","ORCSAVE2",183,0)
 K ^TMP($J,"ORMONOGRAPH")
"RTN","ORCSAVE2",184,0)
 Q
"RTN","ORCSAVE2",185,0)
 ;
"RTN","ORCSAVE2",186,0)
VALUE(IFN,ID,INST) ; -- Returns value of prompt by identifier ID
"RTN","ORCSAVE2",187,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0)))!($G(ID)="") Q ""
"RTN","ORCSAVE2",188,0)
 N I,Y S I=0,Y="" S:'$G(INST) INST=1
"RTN","ORCSAVE2",189,0)
 F  S I=$O(^OR(100,IFN,4.5,"ID",ID,I)) Q:I'>0  I $P($G(^OR(100,IFN,4.5,+I,0)),U,3)=INST S Y=$G(^(1)) Q
"RTN","ORCSAVE2",190,0)
 Q Y
"RTN","ORCSAVE2",191,0)
 ;
"RTN","ORCSAVE2",192,0)
SC(ORX,ORIFN) ; -- save responses to SC questions
"RTN","ORCSAVE2",193,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  ;invalid order number
"RTN","ORCSAVE2",194,0)
 N OR5,I,P S OR5=$G(^OR(100,+ORIFN,5)),P=0
"RTN","ORCSAVE2",195,0)
 F I="SC","MST","AO","IR","EC","HNC","CV","SHD" S P=P+1 S:$D(ORX(I)) $P(OR5,U,P)=ORX(I)
"RTN","ORCSAVE2",196,0)
 S ^OR(100,+ORIFN,5)=OR5
"RTN","ORCSAVE2",197,0)
 Q
"RTN","ORCSAVE2",198,0)
 ;
"RTN","ORCSAVE2",199,0)
CANCEL(ORDER) ; -- cancel order [action]
"RTN","ORCSAVE2",200,0)
 N ORA,DIE,DA,DR,ORX
"RTN","ORCSAVE2",201,0)
 S ORDER=$G(ORDER),ORA=+$P(ORDER,";",2) Q:'ORA!('ORDER)
"RTN","ORCSAVE2",202,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",203,0)
 .S ORX="Unsigned/unreleased order cancelled by provider"
"RTN","ORCSAVE2",204,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",205,0)
 .S DR="4////5;15////13;1////^S X=ORX" D ^DIE
"RTN","ORCSAVE2",206,0)
 I ORA=1 D
"RTN","ORCSAVE2",207,0)
 .K DA S DIE="^OR(100,",DA=+ORDER,DR="5////13" D ^DIE
"RTN","ORCSAVE2",208,0)
 Q
"RTN","ORCSAVE2",209,0)
 ;
"RTN","ORCSAVE2",210,0)
LAPSE(ORDER) ; -- lapse order [action]
"RTN","ORCSAVE2",211,0)
 N ORA S ORA=+$P(ORDER,";",2)
"RTN","ORCSAVE2",212,0)
 Q:'$D(^OR(100,+ORDER,0))  Q:'ORA!('ORDER)
"RTN","ORCSAVE2",213,0)
 I $D(^OR(100,+ORDER,8,ORA)) D
"RTN","ORCSAVE2",214,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",215,0)
 .S DIE="^OR(100,"_+ORDER_",8,",DA=ORA,DA(1)=+ORDER
"RTN","ORCSAVE2",216,0)
 .S DR="4////5;15////14" D ^DIE,DELALRT^ORCSAVE1(ORDER) ; DELALRT call added to fix CQ #17536 (TC). [v28.1]
"RTN","ORCSAVE2",217,0)
 I ORA=1 D
"RTN","ORCSAVE2",218,0)
 .N DIE,DA,DR
"RTN","ORCSAVE2",219,0)
 .S DIE="^OR(100,",DA=+ORDER,DR="5////14"
"RTN","ORCSAVE2",220,0)
 .D ^DIE,ALPS(DA,ORA)
"RTN","ORCSAVE2",221,0)
 Q
"RTN","ORCSAVE2",222,0)
ALPS(DA,ORACT,TYPE) ;set the lapse index ^OR(100,"ALPS")
"RTN","ORCSAVE2",223,0)
 N ORVP,X,OR0,ORLOG
"RTN","ORCSAVE2",224,0)
 S OR0=$G(^OR(100,DA,8,ORACT,0))
"RTN","ORCSAVE2",225,0)
 S ORLOG=$P(OR0,U),ORVP=$P($G(^OR(100,DA,0)),U,2)
"RTN","ORCSAVE2",226,0)
 I ORVP,ORLOG S ^OR(100,"ALPS",ORVP,9999999-ORLOG,DA,ORACT)=$G(TYPE)
"RTN","ORCSAVE2",227,0)
 S ^OR(100,DA,10)=$$NOW^XLFDT
"RTN","ORCSAVE2",228,0)
 Q
"RTN","ORCSAVE2",229,0)
 ;
"RTN","ORCSAVE2",230,0)
RESP(IFN,PRMT,VAL,INST) ; -- update a single Response VALue
"RTN","ORCSAVE2",231,0)
 S IFN=+$G(IFN),VAL=$G(VAL),PRMT=+$O(^ORD(101.41,"AB",PRMT,0))
"RTN","ORCSAVE2",232,0)
 N ID,DA,DIK S:'$G(INST) INST=1
"RTN","ORCSAVE2",233,0)
 S ID=$P($G(^ORD(101.41,PRMT,1)),U,3) Q:'$L(ID)
"RTN","ORCSAVE2",234,0)
 S DA=0 F  S DA=$O(^OR(100,IFN,4.5,"ID",ID,DA)) Q:DA<1  Q:$P($G(^OR(100,IFN,4.5,DA,0)),U,3)=INST
"RTN","ORCSAVE2",235,0)
 I 'DA D:$L(VAL)  Q  ;add
"RTN","ORCSAVE2",236,0)
 . N DO,DIC,DLG,X
"RTN","ORCSAVE2",237,0)
 . S DIC="^OR(100,"_IFN_",4.5,",DA(1)=IFN,DIC(0)="FL"
"RTN","ORCSAVE2",238,0)
 . S DIC("DR")=".02///"_PRMT_";.03///"_INST_";.04///"_ID
"RTN","ORCSAVE2",239,0)
 . S DLG=+$P($G(^OR(100,IFN,0)),U,5)
"RTN","ORCSAVE2",240,0)
 . S X=+$O(^ORD(101.41,DLG,10,"D",PRMT,0))
"RTN","ORCSAVE2",241,0)
 . D FILE^DICN S:Y ^OR(100,IFN,4.5,+Y,1)=VAL
"RTN","ORCSAVE2",242,0)
 I $L(VAL) S ^OR(100,IFN,4.5,DA,1)=VAL Q  ;change
"RTN","ORCSAVE2",243,0)
 S DIK="^OR(100,"_IFN_",4.5,",DA(1)=IFN D ^DIK ;delete
"RTN","ORCSAVE2",244,0)
 Q
"RTN","ORKCHK6")
0^5^B26376206^B26186989
"RTN","ORKCHK6",1,0)
ORKCHK6 ; slc/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;03/16/11  10:48
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123,162,190,249,280,272,346**;Dec 17, 1997;Build 5
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKT,ORKTXT,ORKPDATA,ORIFN
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 S ORIFN=ORNUM
"RTN","ORKCHK6",16,0)
 ;
"RTN","ORKCHK6",17,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",19,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",20,0)
 Q
"RTN","ORKCHK6",21,0)
 ;
"RTN","ORKCHK6",22,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",23,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK6",24,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD,ORALLRN,ORALLRF,ORALLRD,ORDUPCN
"RTN","ORKCHK6",25,0)
 ;
"RTN","ORKCHK6",26,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK6",27,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",28,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",29,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",30,0)
 D PARAMS("DUPLICATE DRUG THERAPY",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",31,0)
 ;
"RTN","ORKCHK6",32,0)
 ;dispense drug selected:
"RTN","ORKCHK6",33,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",34,0)
 .D RXOCS
"RTN","ORKCHK6",35,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",36,0)
 ;
"RTN","ORKCHK6",37,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",38,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",39,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",40,0)
 .I ORPSPKG="H" S ORPSPKG="X"  ;change to "X" if "H"erbal/non-VA med
"RTN","ORKCHK6",41,0)
 .I "IOX"[ORPSPKG D OI2DD^ORKPS(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK6",42,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK6",43,0)
 ..;S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK6",44,0)
 ..S HL7LTXT=$P($G(^ORD(101.43,OI,0)),U)
"RTN","ORKCHK6",45,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK6",46,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK6",47,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",48,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",49,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",50,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",51,0)
 ..D RXOCS
"RTN","ORKCHK6",52,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",53,0)
 Q
"RTN","ORKCHK6",54,0)
 ;
"RTN","ORKCHK6",55,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",56,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF_ORALLRF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",57,0)
 N ORKRX,ORPSNUM
"RTN","ORKCHK6",58,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",59,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR_U_HL7LTXT,OI,ORKPDATA,ORKDG)
"RTN","ORKCHK6",60,0)
 .N CHK,XX S CHK=0,XX=""
"RTN","ORKCHK6",61,0)
 .F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",62,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",63,0)
 ..;
"RTN","ORKCHK6",64,0)
 ..;get errors/exceptions/checks not done
"RTN","ORKCHK6",65,0)
 ..I $P(XX,U)="ERR" S ORKS("ORK",ORNUM_","_2_$E($P(XX,U,2),1,225))=ORNUM_U_25_U_3_U_$P(XX,U,2)
"RTN","ORKCHK6",66,0)
 ..;
"RTN","ORKCHK6",67,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",68,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="CRITICAL" D
"RTN","ORKCHK6",69,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",70,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",71,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",72,0)
 ...S ORKMSG=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,6)
"RTN","ORKCHK6",73,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKTXT
"RTN","ORKCHK6",74,0)
 ..;
"RTN","ORKCHK6",75,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",76,0)
 ..I $P(XX,U)="DI",$P(XX,U,2)="SIGNIFICANT" D
"RTN","ORKCHK6",77,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",78,0)
 ...S ORPSNUM=$P(XX,U,3)
"RTN","ORKCHK6",79,0)
 ...S ORKTXT=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,5)
"RTN","ORKCHK6",80,0)
 ...S ORKMSG=$P(XX,U,2)_" drug-drug interaction: "_$P(XX,U,6)
"RTN","ORKCHK6",81,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKTXT
"RTN","ORKCHK6",82,0)
 ..;
"RTN","ORKCHK6",83,0)
 ..;duplicate drug:
"RTN","ORKCHK6",84,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",85,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",86,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",87,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$FULLTEXT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK6",88,0)
 ...E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",89,0)
 ...S ORKMSG="Duplicate drug order: "_ORKTXT
"RTN","ORKCHK6",90,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate drug order: "_$E($P(XX,U,3),1,200))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",91,0)
 ..;
"RTN","ORKCHK6",92,0)
 ..;duplicate class: NOW DRUG THERAPY
"RTN","ORKCHK6",93,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",94,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",95,0)
 ...S ORPSNUM=$P(XX,U,2)  ;get the associated order number
"RTN","ORKCHK6",96,0)
 ...S ORKMSG=$P(XX,U,4)
"RTN","ORKCHK6",97,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG
"RTN","ORKCHK6",98,0)
 Q:ORALLRF="D"
"RTN","ORKCHK6",99,0)
 N ORKAL
"RTN","ORKCHK6",100,0)
 I $L($G(HL7NPTR)),($G(HL7NCOD)="99NDF") D
"RTN","ORKCHK6",101,0)
 .D RXN^ORQQAL(.ORKAL,ORKDFN,"DR",HL7NPTR,$G(HL7LPTR)) I (ORKAL>0) D
"RTN","ORKCHK6",102,0)
 ..Q:$L($P(ORKAL,U,2))<1
"RTN","ORKCHK6",103,0)
 ..S ORKMSG="Previous adverse reaction to: "_$P(ORKAL,U,2)
"RTN","ORKCHK6",104,0)
 ..S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK6",105,0)
 Q
"RTN","ORKCHK6",106,0)
 ;
"RTN","ORKCHK6",107,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",108,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",109,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",110,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",111,0)
 Q
"RTN","ORKPS")
0^8^B67862708^B59221403
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;07/27/11  07:10
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123,141,190,232,316,272,346**;Dec 17, 1997;Build 5
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG) ; return drug order checks
"RTN","ORKPS",5,0)
 ;YY:    returned array of data
"RTN","ORKPS",6,0)
 ;DFN:   patient id
"RTN","ORKPS",7,0)
 ;MED:   drug ien [file #50]
"RTN","ORKPS",8,0)
 ;OI:    orderable item ien [file #101.43
"RTN","ORKPS",9,0)
 ;ORKDG: display group (should be PSI, PSIV, PSO or PSH)
"RTN","ORKPS",10,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",11,0)
 K ^TMP($J,"OROCOUT"),^TMP($J,"DD")
"RTN","ORKPS",12,0)
 N ORDFN,ORKA,ORPTY,ORPHOI S ORDFN=DFN
"RTN","ORKPS",13,0)
 S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",14,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",15,0)
 I $$PRE^PSSDSAPK(ORPHOI)=0,($$SOLUT^ORKPS(OI)) Q  ; Dont do checks if the drug is a solution but not a premix
"RTN","ORKPS",16,0)
 ;I $D(ORMOCHAT) N ORMOCHAN S ORMOCHAN=$O(@ORMOCHAT@("ENH",""),-1)+1,$P(@ORMOCHAT@("ENH",ORMOCHAN),U,1)=$ZH
"RTN","ORKPS",17,0)
 S ORKA(1)=MED_U_$$GETPSNM(+MED) D CPRS^PSODDPR4(ORDFN,"OROCOUT",.ORKA,ORPTY_+$G(^OR(100,+$G(ORIFN),4)))
"RTN","ORKPS",18,0)
 ;I $D(ORMOCHAT) S $P(@ORMOCHAT@("ENH",ORMOCHAN),U,2)=$ZH
"RTN","ORKPS",19,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+ORKA(1),"OROCOUT")
"RTN","ORKPS",20,0)
 K ^TMP($J,"OROCOUT"),^TMP($J,"DD")
"RTN","ORKPS",21,0)
 Q
"RTN","ORKPS",22,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG) ; return drug order checks for session
"RTN","ORKPS",23,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI,ORPHOI
"RTN","ORKPS",24,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORKDD,ORSNUM,ORNUM,DUPX,DUPORN,ORPTY
"RTN","ORKPS",25,0)
 N ORDFN S ORDFN=DFN
"RTN","ORKPS",26,0)
 S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",27,0)
 I '$D(^TMP($J,"OROCOUT"_ORPTY)) D
"RTN","ORKPS",28,0)
 .S ORKFLG=0
"RTN","ORKPS",29,0)
 .S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",30,0)
 .S ORPHOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORKPS",31,0)
 .I $$PRE^PSSDSAPK(ORPHOI)=0,($$SOLUT^ORKPS(OI)) Q  ; Dont do checks if the drug is a solution but not a premix
"RTN","ORKPS",32,0)
 .;
"RTN","ORKPS",33,0)
 .;get other session med orders:
"RTN","ORKPS",34,0)
 .I $D(^TMP("ORKA",$J)) D
"RTN","ORKPS",35,0)
 ..S CNT=^TMP("ORKA",$J) F CNTX=1:1:CNT D
"RTN","ORKPS",36,0)
 ...S ORSESS=$G(^TMP("ORKA",$J,CNTX))
"RTN","ORKPS",37,0)
 ...Q:'$L(ORSESS)
"RTN","ORKPS",38,0)
 ...S ORPSPKG=$P(ORSESS,"|",2)
"RTN","ORKPS",39,0)
 ...Q:'$L(ORPSPKG)
"RTN","ORKPS",40,0)
 ...Q:$E(ORPSPKG,1,2)'="PS"
"RTN","ORKPS",41,0)
 ...S ORSNUM=$P(ORSESS,"|",5)
"RTN","ORKPS",42,0)
 ...S ORKOI=$P(ORSESS,"|")
"RTN","ORKPS",43,0)
 ...;quit if same order/oi:
"RTN","ORKPS",44,0)
 ...Q:((+$G(ORNUM)=+$G(ORSNUM))&(+$G(OI)=+$G(ORKOI)))
"RTN","ORKPS",45,0)
 ...S:ORPSPKG="PSJ" ORPSPKG="PSI"
"RTN","ORKPS",46,0)
 ...S ORKDRUG=$P($P(ORSESS,"|",3),U,4)
"RTN","ORKPS",47,0)
 ...;
"RTN","ORKPS",48,0)
 ...;if no disp drug selected get disp drug(s) from OI:
"RTN","ORKPS",49,0)
 ...I +$G(ORKDRUG)<1,$L(ORKOI) D
"RTN","ORKPS",50,0)
 ....I "IOH"[$E(ORPSPKG,3) D OI2DD(.ORPSA,ORKOI,$E(ORPSPKG,3)) D
"RTN","ORKPS",51,0)
 .....S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKPS",52,0)
 ......S ORKDRUG=+ORKDD
"RTN","ORKPS",53,0)
 ......S:+$G(ORKDRUG)>0 ORKDRUGA(ORKDRUG_";"_ORPSPKG_";"_ORSNUM)=ORSNUM_U_$P($G(^ORD(101.43,ORKOI,0)),U),ORKDRUG=0
"RTN","ORKPS",54,0)
 ....K ORPSA  ;need to clean out between calls to OI2DD
"RTN","ORKPS",55,0)
 ...;
"RTN","ORKPS",56,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",57,0)
 ...;if dispense drug selected add to array:
"RTN","ORKPS",58,0)
 ...S ORKDRUGA(ORKDRUG_";"_ORPSPKG_";"_ORSNUM)=ORSNUM_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",59,0)
 .;
"RTN","ORKPS",60,0)
 .;get unsigned medication orders:
"RTN","ORKPS",61,0)
 .S HOR=0,SEQ=0
"RTN","ORKPS",62,0)
 .S HOR=$O(^TMP("ORR",$J,HOR)) I +$G(HOR)>0 D
"RTN","ORKPS",63,0)
 ..F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",64,0)
 ...S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U),DUPORN=0
"RTN","ORKPS",65,0)
 ...Q:+$G(ORKORN)<1
"RTN","ORKPS",66,0)
 ...Q:+ORKORN=+ORNUM
"RTN","ORKPS",67,0)
 ...Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",68,0)
 ...Q:$P(^ORD(100.01,$P(^OR(100,+ORKORN,3),U,3),0),U)="DISCONTINUED"
"RTN","ORKPS",69,0)
 ...S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",70,0)
 ...;only process vs. unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",71,0)
 ...Q:+$G(ORKDRUG)<1
"RTN","ORKPS",72,0)
 ...S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",73,0)
 ...S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",ORPSPKG="NON-VA MEDICATIONS":"PSH",1:"")
"RTN","ORKPS",74,0)
 ...S DUPX="" F  S DUPX=$O(ORKDRUGA(DUPX)) Q:'DUPX!(DUPORN=1)  D
"RTN","ORKPS",75,0)
 ....S:ORKORN=ORKDRUGA(DUPX) DUPORN=1
"RTN","ORKPS",76,0)
 ...Q:DUPORN=1  ;quit if already processed drug order
"RTN","ORKPS",77,0)
 ...S ORKDRUGA(+ORKDRUG_";"_ORPSPKG_";"_ORKORN)=ORKORN_U_$$GETPSNM(+ORKDRUG)
"RTN","ORKPS",78,0)
 .;S ORPTY=$S($G(ORKDG)="PSI":"I;",$G(ORKDG)="PSIV":"I;",$G(ORKDG)="PSO":"O;",$G(ORKDG)="PSH":"O;",1:"O;")
"RTN","ORKPS",79,0)
 .K ^TMP($J,"DD"),^TMP($J,"OROCOUT")
"RTN","ORKPS",80,0)
 .N ORPROSP,CNT
"RTN","ORKPS",81,0)
 .S CNT=1
"RTN","ORKPS",82,0)
 .S ORPROSP(CNT)=MED_U_$$GETPSNM(+MED)_U_+$G(ORNUM)
"RTN","ORKPS",83,0)
 .;N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S CNT=CNT+1,ORPROSP(CNT)=+I_U_$$GETPSNM(+I)
"RTN","ORKPS",84,0)
 .N I S I="" F  S I=$O(ORKDRUGA(I)) Q:'I  S CNT=CNT+1,ORPROSP(CNT)=+I_U_$P(ORKDRUGA(I),U,2)_U_$P(ORKDRUGA(I),U,1)
"RTN","ORKPS",85,0)
 .;I $D(ORMOCHAT) N ORMOCHAN S ORMOCHAN=$O(@ORMOCHAT@("ENH",""),-1)+1,$P(@ORMOCHAT@("ENH",ORMOCHAN),U,1)=$ZH
"RTN","ORKPS",86,0)
 .D SHRNKPR
"RTN","ORKPS",87,0)
 .D CPRS^PSODDPR4(DFN,"OROCOUT"_ORPTY,.ORPROSP,ORPTY_+$G(^OR(100,+$G(ORNUM),4)))
"RTN","ORKPS",88,0)
 .;I $D(ORMOCHAT) S $P(@ORMOCHAT@("ENH",ORMOCHAN),U,2)=$ZH
"RTN","ORKPS",89,0)
 D PROCESS^ORKPS1(OI,ORDFN,ORKDG,+MED,"OROCOUT"_ORPTY)
"RTN","ORKPS",90,0)
 Q
"RTN","ORKPS",91,0)
SHRNKPR ;REMOVE DUPLICATS FROM PROSPECTIVE LIST
"RTN","ORKPS",92,0)
 Q:'$D(ORPROSP)
"RTN","ORKPS",93,0)
 N ORX,ORI S ORI=0 F  S ORI=$O(ORPROSP(ORI)) Q:'ORI  S ORX=ORPROSP(ORI) D
"RTN","ORKPS",94,0)
 .N ORJ S ORJ=ORI F  S ORJ=$O(ORPROSP(ORJ)) Q:'ORJ  I ORX=ORPROSP(ORJ) K ORPROSP(ORJ)
"RTN","ORKPS",95,0)
 Q
"RTN","ORKPS",96,0)
GETPSNM(ORIEN) ;GET THE FILE 50 .01 FIELD FROM A FILE 50 IEN
"RTN","ORKPS",97,0)
 N RET K ^TMP($J,"ORRETNM")
"RTN","ORKPS",98,0)
 D NDF^PSS50(ORIEN,,,,,"ORRETNM") S RET=$G(^TMP($J,"ORRETNM",ORIEN,.01))
"RTN","ORKPS",99,0)
 K ^TMP($J,"ORRETNM")
"RTN","ORKPS",100,0)
 Q RET
"RTN","ORKPS",101,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",102,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",103,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",104,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",105,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",106,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",107,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",108,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",109,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",110,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",111,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",112,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",113,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",114,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",115,0)
 ..I $L(ORKMEDP),($$UP^XLFSTR(ORKARX)[ORKMEDP) S ORKRSLT="1^"_ORKARX ;DJE/VM *316 use uppercase in comparison
"RTN","ORKPS",116,0)
 Q ORKRSLT
"RTN","ORKPS",117,0)
SOLUT(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",118,0)
 ; a solution (IV Base)
"RTN","ORKPS",119,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",120,0)
 N OITEXT
"RTN","ORKPS",121,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",122,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",123,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",124,0)
 Q:$D(^ORD(101.43,"S.IVB RX",OITEXT)) 1
"RTN","ORKPS",125,0)
 Q ""
"RTN","ORKPS",126,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",127,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",128,0)
 S ORSLT=0
"RTN","ORKPS",129,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",130,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",131,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",132,0)
 K VA200,VAIN
"RTN","ORKPS",133,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",134,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",135,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",136,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",137,0)
 Q ORSLT
"RTN","ORKPS",138,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",139,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",140,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",141,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",142,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",143,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN
"RTN","ORKPS",144,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",145,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",146,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",147,0)
 D NOW^%DTC
"RTN","ORKPS",148,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",149,0)
 K %
"RTN","ORKPS",150,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",151,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",152,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",153,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",154,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",155,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",156,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",157,0)
 F ORI=1:1:ORY I +$G(CREARSLT)<1 D
"RTN","ORKPS",158,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",159,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",160,0)
 .F ORJ=1:1:ORX I +$G(CREARSLT)<1 D
"RTN","ORKPS",161,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",162,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",163,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",164,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",165,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",166,0)
 ..I CDT'<BDT S CREARSLT=1
"RTN","ORKPS",167,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",168,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",169,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for
"RTN","ORKPS",170,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",171,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",172,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",173,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",174,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",175,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",176,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",177,0)
 K VA200,VAIN
"RTN","ORKPS",178,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",179,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",180,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",181,0)
 Q ""
"RTN","ORKPS",182,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",183,0)
 ; a supply
"RTN","ORKPS",184,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",185,0)
 N OITEXT
"RTN","ORKPS",186,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",187,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",188,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",189,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",190,0)
 Q ""
"RTN","ORKPS",191,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",192,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW
"RTN","ORKPS",193,0)
 S NUMRX=0
"RTN","ORKPS",194,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",195,0)
 ;
"RTN","ORKPS",196,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",197,0)
 D ADM^VADPT2
"RTN","ORKPS",198,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",199,0)
 ;
"RTN","ORKPS",200,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",201,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",202,0)
 N X
"RTN","ORKPS",203,0)
 S X=0
"RTN","ORKPS",204,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",205,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",206,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",207,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",208,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",209,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",210,0)
 .Q:+ORX<1
"RTN","ORKPS",211,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",212,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",213,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",214,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",215,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",216,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",217,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",218,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",219,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",220,0)
 Q NUMRX
"RTN","ORKPS",221,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",222,0)
 N PSOI,ORTMP1,ORTMP2,ORRET
"RTN","ORKPS",223,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKPS",224,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKPS",225,0)
 Q:+$G(PSOI)<1
"RTN","ORKPS",226,0)
 S:ORPSPKG="H" ORPSPKG="X"  ;if non-va med need to pass api "X"
"RTN","ORKPS",227,0)
 S ORRET=$$DRG^PSSDSAPM(PSOI,ORPSPKG)
"RTN","ORKPS",228,0)
 I +ORRET S ORPSA(ORRET)=""
"RTN","ORKPS",229,0)
 Q
"RTN","ORKPS1")
0^7^B71033645^B67186878
"RTN","ORKPS1",1,0)
ORKPS1 ; slc/CLA - Order checking support procedures for medications ;07/27/11  07:10
"RTN","ORKPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**232,272,346**;Dec 17, 1997;Build 5
"RTN","ORKPS1",3,0)
 Q
"RTN","ORKPS1",4,0)
PROCESS(OI,DFN,ORKDG,ORPROSP,ORGLOBL) ;process data from pharmacy order check API
"RTN","ORKPS1",5,0)
 ;ORPROSP = the med that is being checked
"RTN","ORKPS1",6,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS1",7,0)
 ;K ^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",8,0)
 N II,XX,ZZ,ZZD,ORMTYPE,ORN,ORZ,RCNT,GL,I,J,K,L,M,TDATA,VADMVT,ORX,ORY
"RTN","ORKPS1",9,0)
 S II=1,XX=0,ZZ="",ZZD="",RCNT=0
"RTN","ORKPS1",10,0)
 I $G(^TMP($J,ORGLOBL,"OUT",0))<0 D  Q
"RTN","ORKPS1",11,0)
 .S YY(II)="ERR^Drug-Drug order checks (Duplicate Therapy, Duplicate Drug, Drug Interaction) were not able to be performed. "_$P($G(^TMP($J,ORGLOBL,"OUT",0)),U,2)
"RTN","ORKPS1",12,0)
 .S II=II+1
"RTN","ORKPS1",13,0)
 I $D(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS")) D
"RTN","ORKPS1",14,0)
 .S ORX="" F  S ORX=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX)) Q:'$L(ORX)  D
"RTN","ORKPS1",15,0)
 ..S ORY=0 F  S ORY=$O(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)) Q:'ORY  D
"RTN","ORKPS1",16,0)
 ...S YY(II)="ERR^"_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,7)
"RTN","ORKPS1",17,0)
 ...I $L($P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10))>0 S YY(II)=YY(II)_"("_$P($G(^TMP($J,ORGLOBL,"OUT","EXCEPTIONS",ORX,ORY)),U,10)_")"
"RTN","ORKPS1",18,0)
 ...S II=II+1
"RTN","ORKPS1",19,0)
 S ORX="" F ORX="DRUGDRUG","THERAPY" D
"RTN","ORKPS1",20,0)
 .Q:'$D(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR"))
"RTN","ORKPS1",21,0)
 .S ORY="" F  S ORY=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY)) Q:'$L(ORY)  D
"RTN","ORKPS1",22,0)
 ..S ORZ=0 F  S ORZ=$O(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ)) Q:'ORZ  D
"RTN","ORKPS1",23,0)
 ...S YY(II)="ERR^"_$$UPPER^ORWDPS32($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"SEV")))_": "_$P($G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,0)),U)_" - "_$G(^TMP($J,ORGLOBL,"OUT",ORX,"ERROR",ORY,ORZ,"TEXT"))
"RTN","ORKPS1",24,0)
 ...S II=II+1
"RTN","ORKPS1",25,0)
 ;set info about the drug being ordered
"RTN","ORKPS1",26,0)
 S TDATA("NEW","TXT")=""
"RTN","ORKPS1",27,0)
 S I="" F  S I=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)) Q:'$L(I)  D
"RTN","ORKPS1",28,0)
 .I $P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,3)=ORPROSP S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",29,0)
 .;I $P(I,";",4)=1 S TDATA("NEW","TXT")=$P($G(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",I)),U,4)
"RTN","ORKPS1",30,0)
 I $L(ORKDG) S TDATA("NEW","PTYPE")=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",$G(ORKDG)="PSH":"O",1:"")
"RTN","ORKPS1",31,0)
 I '$L(TDATA("NEW","PTYPE")) D  ;if no display group
"RTN","ORKPS1",32,0)
 .D ADM^VADPT2
"RTN","ORKPS1",33,0)
 .S TDATA("NEW","PTYPE")=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS1",34,0)
 .K VADMVT
"RTN","ORKPS1",35,0)
 S TDATA("NEW","OTYPE")=TDATA("NEW","PTYPE")
"RTN","ORKPS1",36,0)
 N ORPI S ORPI=0 F  S ORPI=$O(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",ORPI)) Q:'$L(ORPI)  I $P(^TMP($J,ORGLOBL,"IN","PROSPECTIVE",ORPI),U,3)=+ORPROSP S TDATA("NEW","PROSP")=$P(ORPI,";",3,4)
"RTN","ORKPS1",37,0)
 Q:'$L($G(TDATA("NEW","PROSP")))
"RTN","ORKPS1",38,0)
 I $L(ORKDG) S TDATA("NEW","OTYPE")=$S($G(ORKDG)="PSI":"UD",$G(ORKDG)="PSO":"OP",$G(ORKDG)="PSIV":"IV",$G(ORKDG)="PSH":"NV",1:"")
"RTN","ORKPS1",39,0)
 D DI(.TDATA),DD(.TDATA),DT(.TDATA)
"RTN","ORKPS1",40,0)
 Q
"RTN","ORKPS1",41,0)
 ;
"RTN","ORKPS1",42,0)
DI(TDATA) ;add drug interaction checks
"RTN","ORKPS1",43,0)
 N GL
"RTN","ORKPS1",44,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","DRUGDRUG"))
"RTN","ORKPS1",45,0)
 S J="" F  S J=$O(@GL@(J)) Q:'$L(J)  D
"RTN","ORKPS1",46,0)
 .S K="" F  S K=$O(@GL@(J,K)) Q:'$L(K)  D
"RTN","ORKPS1",47,0)
 ..S L=0 F  S L=$O(@GL@(J,K,L)) Q:'$L(L)  D
"RTN","ORKPS1",48,0)
 ...S M=0 F  S M=$O(@GL@(J,K,L,M)) Q:'M  D
"RTN","ORKPS1",49,0)
 ....N ORTXT,ORNUM,ORSEV,ORDNAME,ORZ,CNT,ORSTAT,ORMON,ORWHICH
"RTN","ORKPS1",50,0)
 ....S ORWHICH=""
"RTN","ORKPS1",51,0)
 ....I $P($P(@GL@(J,K,L,M),U),";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",52,0)
 .....S ORWHICH=K
"RTN","ORKPS1",53,0)
 .....I $P(L,";",3)="PROSPECTIVE" S ORWHICH=ORWHICH_" [UNRELEASED]" Q
"RTN","ORKPS1",54,0)
 .....S ORWHICH=ORWHICH_" ["_$$PHSTAT(DFN,$P(L,";",1,2))_"]"
"RTN","ORKPS1",55,0)
 ....I $P(L,";",3,4)=TDATA("NEW","PROSP") D
"RTN","ORKPS1",56,0)
 .....S ORWHICH=$P(@GL@(J,K,L,M),U,4)
"RTN","ORKPS1",57,0)
 .....I $P($P(@GL@(J,K,L,M),U),";",3)="PROSPECTIVE" S ORWHICH=ORWHICH_" [UNRELEASED]" Q
"RTN","ORKPS1",58,0)
 .....S ORWHICH=ORWHICH_" ["_$$PHSTAT(DFN,$P($P(@GL@(J,K,L,M),U),";",1,2))_"]"
"RTN","ORKPS1",59,0)
 ....Q:$L(ORWHICH)<2
"RTN","ORKPS1",60,0)
 ....;get the associated order number
"RTN","ORKPS1",61,0)
 ....S ORNUM=$P(L,";",1,2)
"RTN","ORKPS1",62,0)
 ....;get text
"RTN","ORKPS1",63,0)
 ....S ORTXT=TDATA("NEW","TXT")_" and "_ORWHICH_" - "_$P($G(@GL@(J,K,L,M,"CLIN")),"CLINICAL EFFECTS:  ",2)
"RTN","ORKPS1",64,0)
 ....;loop through the PMON nodes to get the CLINICAL EFFECTS
"RTN","ORKPS1",65,0)
 ....;N PMON S PMON=0 F  S PMON=$O(@GL@(J,K,L,M,"PMON",PMON)) Q:'PMON  D
"RTN","ORKPS1",66,0)
 ....;.I $L($G(@GL@(J,K,L,M,"PMON",PMON,0)),"CLINICAL EFFECTS:  ")>1 S ORTXT=TDATA("NEW","TXT")_" & "_K_$S($P(L,";")="P":"[PENDING]",ORNUM:"["_$$PHSTAT(DFN,ORNUM)_"]",1:"")_" - "_$P(@GL@(J,K,L,M,"PMON",PMON,0),"CLINICAL EFFECTS:  ",2)
"RTN","ORKPS1",67,0)
 ....;set the monograph into the temp global
"RTN","ORKPS1",68,0)
 ....I $D(@GL@(J,K,L,M,"PMON")) D
"RTN","ORKPS1",69,0)
 .....S ^TMP($J,"ORMONOGRAPH")=1+$G(^TMP($J,"ORMONOGRAPH"))
"RTN","ORKPS1",70,0)
 .....S ORMON=^TMP($J,"ORMONOGRAPH")
"RTN","ORKPS1",71,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"OC")=ORTXT
"RTN","ORKPS1",72,0)
 .....S ^TMP($J,"ORMONOGRAPH",ORMON,"INT")=@GL@(J,K,L,M,"INT")
"RTN","ORKPS1",73,0)
 .....M ^TMP($J,"ORMONOGRAPH",ORMON,"DATA")=@GL@(J,K,L,M,"PMON")
"RTN","ORKPS1",74,0)
 ....;get the severity
"RTN","ORKPS1",75,0)
 ....S ORSEV=$$UPPER^ORU($G(@GL@(J,K,L,M,"SEV")))
"RTN","ORKPS1",76,0)
 ....;get the drug name
"RTN","ORKPS1",77,0)
 ....S ORDNAME=K
"RTN","ORKPS1",78,0)
 ....;if the status of the associated order is DISCONTINUED then don't add
"RTN","ORKPS1",79,0)
 ....S ORSTAT=$$PHSTAT(DFN,ORNUM)
"RTN","ORKPS1",80,0)
 ....Q:ORSTAT="DISCONTINUED"
"RTN","ORKPS1",81,0)
 ....;set info into order check array
"RTN","ORKPS1",82,0)
 ....S YY(II)="DI^"_ORSEV_U_ORNUM_U_ORDNAME_U_ORTXT_" - Monograph Available"_U_$G(@GL@(J,K,L,M,"INT"))
"RTN","ORKPS1",83,0)
 ....S II=II+1
"RTN","ORKPS1",84,0)
 Q
"RTN","ORKPS1",85,0)
 ;
"RTN","ORKPS1",86,0)
DD(TDATA) ;add duplicate drug checks
"RTN","ORKPS1",87,0)
 Q:$$SOLUT^ORKPS(OI)  ;quit if the orderable item is a solution
"RTN","ORKPS1",88,0)
 ;require that we do not perform dup drug/class OCs for solutions)
"RTN","ORKPS1",89,0)
 S XX=0,ZZ=""
"RTN","ORKPS1",90,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS1",91,0)
 .N ORREM
"RTN","ORKPS1",92,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS1",93,0)
 .S ORREM=$P($P(ZZ,U,4),";") I (ORREM["Z"),$D(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM)) D
"RTN","ORKPS1",94,0)
 ..N ORTXT,ORREM1,ORREMSIG
"RTN","ORKPS1",95,0)
 ..S ORREM1=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM))
"RTN","ORKPS1",96,0)
 ..S ORREMSIG=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",+ORREM,"SIG",0))
"RTN","ORKPS1",97,0)
 ..S ORTXT=" "_ORREMSIG_" ["_$P(ORREM1,U,4)_" -  Last Fill: "_$P(ORREM1,U,6)_"  Quantity Dispensed: "_$P(ORREM1,U,8)_"] >>"_$P(ORREM1,U)
"RTN","ORKPS1",98,0)
 ..S $P(ZZ,U,2)=$P(ZZ,U,2)_ORTXT
"RTN","ORKPS1",99,0)
 .I $G(TDATA("NEW","PTYPE"))'=$G(ORMTYPE),'$L($G(^TMP($J,"DD",XX,1))) Q
"RTN","ORKPS1",100,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS1",101,0)
 .I $L($G(ORN))>0,+$G(ORN)=+$G(ORIFN) Q  ;QUIT if dup med ord # = current ord #
"RTN","ORKPS1",102,0)
 .I +$G(ORIFN),+$G(ORN)=$P(^OR(100,+ORIFN,3),U,5) Q  ;QUIT if dup med ord # = the current order #'s REPLACED ORDER (changing an order)
"RTN","ORKPS1",103,0)
 .Q:ORPROSP'=+ZZ
"RTN","ORKPS1",104,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS1",105,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS1",106,0)
 .I $L(ORN),$P(^ORD(100.01,$P(^OR(100,ORN,3),U,3),0),U)="DISCONTINUED" Q
"RTN","ORKPS1",107,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS1",108,0)
 .S ^TMP($J,"DD",XX,"OC")="" ;set this if this DD entry turned into an OC
"RTN","ORKPS1",109,0)
 Q
"RTN","ORKPS1",110,0)
 ;
"RTN","ORKPS1",111,0)
DT(TDATA) ;add duplicate therapy checks
"RTN","ORKPS1",112,0)
 N I
"RTN","ORKPS1",113,0)
 Q:$$SUPPLY^ORKPS(OI)  ;quit if the orderable item is a supply
"RTN","ORKPS1",114,0)
 S GL=$NA(^TMP($J,ORGLOBL,"OUT","THERAPY"))
"RTN","ORKPS1",115,0)
 S I=0 F  S I=$O(@GL@(I)) Q:'I  D
"RTN","ORKPS1",116,0)
 .;get all drug names
"RTN","ORKPS1",117,0)
 .N ORDRUGS,ORCLASS,ORF,ORPROSCNT,ORPROFCNT,DRUGS,ORRETSTR S ORDRUGS="",ORCLASS="",ORF=0,ORPROSCNT=0,ORPROFCNT=0
"RTN","ORKPS1",118,0)
 .S J=0 F  S J=$O(@GL@(I,"DRUGS",J)) Q:'J  D
"RTN","ORKPS1",119,0)
 ..;keep count of PROSPECTIVE drugs
"RTN","ORKPS1",120,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)=TDATA("NEW","PROSP") S ORF=1
"RTN","ORKPS1",121,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROSPECTIVE" D
"RTN","ORKPS1",122,0)
 ...S ORPROSCNT=1+$G(ORPROSCNT)
"RTN","ORKPS1",123,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3,4)'=TDATA("NEW","PROSP") S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" [UNRELEASED]",DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))=""
"RTN","ORKPS1",124,0)
 ..;-check each PROFILE drug to see if it is not the same order as the prospective (ORIFN)
"RTN","ORKPS1",125,0)
 ..I $P($P($G(@GL@(I,"DRUGS",J)),U),";",3)="PROFILE" D
"RTN","ORKPS1",126,0)
 ...;if not the same then set ORNUM=THE PROFILE DRUG "O;PSNUM"
"RTN","ORKPS1",127,0)
 ...I $P($P($G(@GL@(I,"DRUGS",J)),U),";",2)'=$G(^OR(100,+$G(ORIFN),4)) D
"RTN","ORKPS1",128,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=$P($G(^OR(100,+$G(ORIFN),3)),U,5)) Q
"RTN","ORKPS1",129,0)
 ....I $L($P($G(@GL@(I,"DRUGS",J)),U,4))>0,(+$P($G(@GL@(I,"DRUGS",J)),U,4)=+$G(ORIFN)) Q
"RTN","ORKPS1",130,0)
 ....I $E($G(@GL@(I,"DRUGS",J)),1)="R" S $P(@GL@(I,"DRUGS",J),U,5)="O"
"RTN","ORKPS1",131,0)
 ....I $G(TDATA("NEW","PTYPE"))'=$P($G(@GL@(I,"DRUGS",J)),U,5) Q
"RTN","ORKPS1",132,0)
 ....S ORNUM=$P($P($G(@GL@(I,"DRUGS",J)),U),";",1,2)
"RTN","ORKPS1",133,0)
 ....S ORDRUGS=ORDRUGS_$S($L(ORDRUGS):", ",1:"")_$P($G(@GL@(I,"DRUGS",J)),U,3)_" ["_$$PHSTAT(DFN,ORNUM)_"]"
"RTN","ORKPS1",134,0)
 ....S DRUGS($P($G(@GL@(I,"DRUGS",J)),U,3))="",ORPROFCNT=ORPROFCNT+1
"RTN","ORKPS1",135,0)
 .Q:'$$CHKDD(.DRUGS)
"RTN","ORKPS1",136,0)
 .;quit if ORNUM is not set and PROSPECTIVE count <=1
"RTN","ORKPS1",137,0)
 .Q:('$L($G(ORNUM))&(ORPROSCNT<2))
"RTN","ORKPS1",138,0)
 .;get all classes
"RTN","ORKPS1",139,0)
 .I ORF S J=0 F  S J=$O(@GL@(I,J)) Q:'J  D
"RTN","ORKPS1",140,0)
 ..S ORCLASS=ORCLASS_$S($L(ORCLASS):", ",1:"")_$G(@GL@(I,J,"CLASS"))
"RTN","ORKPS1",141,0)
 .;assemble return string ("DC"+ORNUM_U_Classes_U_Classes (drugs))
"RTN","ORKPS1",142,0)
 .S ORRETSTR="Duplicate Therapy: Order(s) exist for {"_ORDRUGS_"} in the same therapeutic categor(ies): "_ORCLASS
"RTN","ORKPS1",143,0)
 .I ORF S YY(II)="DC"_U_$G(ORNUM)_U_ORCLASS_U_ORRETSTR,II=II+1
"RTN","ORKPS1",144,0)
 Q
"RTN","ORKPS1",145,0)
 ;
"RTN","ORKPS1",146,0)
PHSTAT(DFN,ORNUM) ;get the status of the order
"RTN","ORKPS1",147,0)
 N RET,J,I
"RTN","ORKPS1",148,0)
 S RET=""
"RTN","ORKPS1",149,0)
 I $P(ORNUM,";")="P" Q "PENDING"
"RTN","ORKPS1",150,0)
 I $P(ORNUM,";")="N" Q "NON-VA"
"RTN","ORKPS1",151,0)
 I $P(ORNUM,";")="O" D  Q RET
"RTN","ORKPS1",152,0)
 .K ^TMP($J,"OROCLST") D RX^PSO52API(DFN,"OROCLST",$P(ORNUM,";",2),,"ST")
"RTN","ORKPS1",153,0)
 .S RET=$P($G(^TMP($J,"OROCLST",DFN,$P(ORNUM,";",2),100)),U,2)
"RTN","ORKPS1",154,0)
 .K ^TMP($J,"OROCLST")
"RTN","ORKPS1",155,0)
 I $P(ORNUM,";")="I" D  Q RET
"RTN","ORKPS1",156,0)
 .N ORLAST,ORPHNUM
"RTN","ORKPS1",157,0)
 .S ORLAST=$E(ORNUM,$L(ORNUM))
"RTN","ORKPS1",158,0)
 .I ORLAST="P" S RET="PENDING" Q
"RTN","ORKPS1",159,0)
 .S ORPHNUM=+$P(ORNUM,";",2)
"RTN","ORKPS1",160,0)
 .I ORLAST="U" D  Q
"RTN","ORKPS1",161,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS431^PSS55(DFN,ORPHNUM,"","","OR GET STATUS")
"RTN","ORKPS1",162,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,28)),U,2)
"RTN","ORKPS1",163,0)
 .I ORLAST="V" D  Q
"RTN","ORKPS1",164,0)
 ..K ^TMP($J,"OR GET STATUS") D PSS436^PSS55(DFN,ORPHNUM,"OR GET STATUS")
"RTN","ORKPS1",165,0)
 ..S RET=$P($G(^TMP($J,"OR GET STATUS",ORPHNUM,100)),U,2)
"RTN","ORKPS1",166,0)
 I $P(ORNUM,";")="R" D  Q RET
"RTN","ORKPS1",167,0)
 .N ORREMOTE S ORREMOTE=$G(^TMP($J,ORGLOBL,"OUT","REMOTE",$P(ORNUM,";",2)))
"RTN","ORKPS1",168,0)
 .S RET=$P(ORREMOTE,U,4)_" >> "_$P(ORREMOTE,U)
"RTN","ORKPS1",169,0)
 Q RET
"RTN","ORKPS1",170,0)
 ;
"RTN","ORKPS1",171,0)
CHKDD(DARRAY) ;check the duplicate drug OCs returned
"RTN","ORKPS1",172,0)
 ;if all drugs in DARRAY are already displayed in a DD OC then don't show the DT OC (return 0)
"RTN","ORKPS1",173,0)
 ;check the ^TMP($J,"DD"I,"OC") node to see if the DD entry turned into an OC
"RTN","ORKPS1",174,0)
 N I S I=0 F  S I=$O(^TMP($J,"DD",I)) Q:'I  D
"RTN","ORKPS1",175,0)
 .I $D(DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))),$D(^TMP($J,"DD",I,"OC")) D
"RTN","ORKPS1",176,0)
 ..K DARRAY($P($G(^TMP($J,"DD",I,0)),U,2))
"RTN","ORKPS1",177,0)
 Q $D(DARRAY)
"RTN","ORKPS1",178,0)
 ;
"RTN","OROCAPI1")
0^3^B44857555^B44849780
"RTN","OROCAPI1",1,0)
OROCAPI1 ; JMH - ORDER CHECK INSTANCES File APIs;8/24/07 ;03/14/11  09:32
"RTN","OROCAPI1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**293,346**;Dec 17, 1997;Build 5
"RTN","OROCAPI1",3,0)
SAVEOC(ORL,RET) ;SAVE A GROUP OF ORDER CHECKS
"RTN","OROCAPI1",4,0)
         ;ORL=LIST OF ORDER CHECKS
"RTN","OROCAPI1",5,0)
         ;(D0,1)=ORDER NUMBER (FILE 100)^
"RTN","OROCAPI1",6,0)
         ;       OCCURANCE DESCRIPTOR^
"RTN","OROCAPI1",7,0)
         ;       USER (FILE 200)^
"RTN","OROCAPI1",8,0)
         ;       OCCURANCE D/T^
"RTN","OROCAPI1",9,0)
         ;       ORDER CHECK NUMBER (FILE 100.8)^
"RTN","OROCAPI1",10,0)
         ;       CLINICAL DANGER LEVEL
"RTN","OROCAPI1",11,0)
         ;   (D0,2)=ORDER CHECK NARRATIVE
"RTN","OROCAPI1",12,0)
         ;   (D0,3)=OVERRIDE REASON
"RTN","OROCAPI1",13,0)
         ;RET=RETURN ARRAY OF IENS BY ORL(D0)
"RTN","OROCAPI1",14,0)
         ;    RET(D0,IEN)=""
"RTN","OROCAPI1",15,0)
         N I S I=0 F  S I=$O(ORL(I)) Q:'I  D
"RTN","OROCAPI1",16,0)
         .N DA,DR,DIC,X,Y,DIE,ORSTATUS,ORN,ORDANG,DW,DV,%,D,DC,DE,DH,DI,DIEL,DIFLD,DIP,DK,DM,DP,DQ
"RTN","OROCAPI1",17,0)
         .S ORN=+ORL(I,1)
"RTN","OROCAPI1",18,0)
         .Q:'ORN!('$D(^OR(100,ORN)))
"RTN","OROCAPI1",19,0)
         .Q:'$P(ORL(I,1),U,5)  ;QUIT IF NO ORDER CHECK NUMBER
"RTN","OROCAPI1",20,0)
         .Q:'$L($G(ORL(I,2)))  ;QUIT IF NO ORDER CHECK TEXT
"RTN","OROCAPI1",21,0)
         .S DIC="^ORD(100.05,",DIC(0)="F",X=ORN D FILE^DICN
"RTN","OROCAPI1",22,0)
         .Q:'DA
"RTN","OROCAPI1",23,0)
         .S RET(I,DA)=""
"RTN","OROCAPI1",24,0)
         .S DIE=DIC,ORSTATUS=$P($G(^OR(100,ORN,3)),U,3),ORDANG=$S($P($G(ORL(I,1)),U,6):$P($G(ORL(I,1)),U,6),1:$$GET^XPAR("ALL","ORK CLINICAL DANGER LEVEL",$P($G(ORL(I,1)),U,5),"I"))
"RTN","OROCAPI1",25,0)
         .S DR="1////"_ORSTATUS_";2////"_$P($G(ORL(I,1)),U,2)_";3////"_$P($G(ORL(I,1)),U,3)_";4////"_$P($G(ORL(I,1)),U,4)_";5////"_$P($G(ORL(I,1)),U,5)_";6////"_ORDANG_";8///"_$TR($G(ORL(I,2)),";",",")_";7///"_$TR($G(ORL(I,3)),";",",")
"RTN","OROCAPI1",26,0)
         .D ^DIE
"RTN","OROCAPI1",27,0)
         .;set ^ORD(100.05,DA,2) if ORL(DO,2,1) exists
"RTN","OROCAPI1",28,0)
         .I $D(ORL(I,2))=11 N J S J=0 F  S J=$O(ORL(I,2,J)) Q:'J  S ^ORD(100.05,DA,2,J+1,0)=ORL(I,2,J)
"RTN","OROCAPI1",29,0)
         Q
"RTN","OROCAPI1",30,0)
GETOC1(IEN,RET) ;GET A SINGLE ORDER CHECK
"RTN","OROCAPI1",31,0)
         ;IEN = 100.05 IEN
"RTN","OROCAPI1",32,0)
         ;RET = RETURNED 100.05 DATA FOR IEN
"RTN","OROCAPI1",33,0)
         K RET
"RTN","OROCAPI1",34,0)
         Q:'$G(IEN)
"RTN","OROCAPI1",35,0)
         Q:'$D(^ORD(100.05,IEN))
"RTN","OROCAPI1",36,0)
         S RET(IEN,0)=$G(^ORD(100.05,IEN,0))
"RTN","OROCAPI1",37,0)
         S RET(IEN,1)=$G(^ORD(100.05,IEN,1))
"RTN","OROCAPI1",38,0)
         M RET(IEN,"OC")=^ORD(100.05,IEN,2)
"RTN","OROCAPI1",39,0)
         K RET(IEN,"OC",0)
"RTN","OROCAPI1",40,0)
         M RET(IEN,"OR")=^ORD(100.05,IEN,3)
"RTN","OROCAPI1",41,0)
         K RET(IEN,"OR",0)
"RTN","OROCAPI1",42,0)
         Q
"RTN","OROCAPI1",43,0)
GETOC2(ORD,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER
"RTN","OROCAPI1",44,0)
         ;ORD = 100 IEN
"RTN","OROCAPI1",45,0)
         ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",46,0)
         K RET
"RTN","OROCAPI1",47,0)
         Q:'$G(ORD)
"RTN","OROCAPI1",48,0)
         N I S I=0 F  S I=$O(^ORD(100.05,"B",ORD,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",49,0)
         Q
"RTN","OROCAPI1",50,0)
GETOC3(ORD,OCC,RET) ;GET ALL 100.05 IENS FOR A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",51,0)
         ;ORD = 100 IEN
"RTN","OROCAPI1",52,0)
         ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",53,0)
         ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",54,0)
         K RET
"RTN","OROCAPI1",55,0)
         Q:'$G(ORD)
"RTN","OROCAPI1",56,0)
         Q:'$L(OCC)
"RTN","OROCAPI1",57,0)
         N I S I=0 F  S I=$O(^ORD(100.05,"C",ORD,OCC,I)) Q:'I  S RET(ORD,I)=""
"RTN","OROCAPI1",58,0)
         Q
"RTN","OROCAPI1",59,0)
GETOC4(ORD,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER
"RTN","OROCAPI1",60,0)
         ;ORD = 100 IEN
"RTN","OROCAPI1",61,0)
         ;RET = LIST OF 100.05 IENS
"RTN","OROCAPI1",62,0)
         K RET
"RTN","OROCAPI1",63,0)
         Q:'$G(ORD)
"RTN","OROCAPI1",64,0)
         N RET2
"RTN","OROCAPI1",65,0)
         D GETOC2(ORD,.RET)
"RTN","OROCAPI1",66,0)
         Q:'$D(RET)
"RTN","OROCAPI1",67,0)
         N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",68,0)
         .D GETOC1(I,.RET2)
"RTN","OROCAPI1",69,0)
         .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",70,0)
         Q
"RTN","OROCAPI1",71,0)
GETOC5(ORD,OCC,RET) ;GET DATA FOR ALL 100.05 RECORDS OF A SPECIFIC ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",72,0)
         ;ORD = 100 IEN
"RTN","OROCAPI1",73,0)
         ;OCC = OCCURANCE STRING
"RTN","OROCAPI1",74,0)
         ;RET = LIST OF 100.05 IENS WITH DATA
"RTN","OROCAPI1",75,0)
         K RET
"RTN","OROCAPI1",76,0)
         Q:'$G(ORD)
"RTN","OROCAPI1",77,0)
         Q:'$L(OCC)
"RTN","OROCAPI1",78,0)
         N RET2
"RTN","OROCAPI1",79,0)
         D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",80,0)
         Q:'$D(RET)
"RTN","OROCAPI1",81,0)
         N I S I=0 F  S I=$O(RET(ORD,I)) Q:'I  D
"RTN","OROCAPI1",82,0)
         .D GETOC1(I,.RET2)
"RTN","OROCAPI1",83,0)
         .M RET(ORD,"DATA")=RET2
"RTN","OROCAPI1",84,0)
         Q
"RTN","OROCAPI1",85,0)
CONVERT ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05
"RTN","OROCAPI1",86,0)
 N I,J,ORK,DESC
"RTN","OROCAPI1",87,0)
 S I=0
"RTN","OROCAPI1",88,0)
 I $G(^XTMP("ORK FILE CONVERSION")) S I=+^XTMP("ORK FILE CONVERSION")
"RTN","OROCAPI1",89,0)
 F  S I=$O(^OR(100,I)) Q:'I  I $D(^OR(100,I,9)) I '$D(^ORD(100.05,"B",I)) D CONVERT1(I)
"RTN","OROCAPI1",90,0)
 S I=0
"RTN","OROCAPI1",91,0)
 F  S I=$O(^XTMP("ORK FILE CONVERSION","ERRORS",I)) Q:'I  D DELETE(I)
"RTN","OROCAPI1",92,0)
 K ^XTMP("ORK FILE CONVERSION","LAST ERRORS")
"RTN","OROCAPI1",93,0)
 M ^XTMP("ORK FILE CONVERSION","LAST ERRORS")=^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",94,0)
 K ^XTMP("ORK FILE CONVERSION","ERRORS")
"RTN","OROCAPI1",95,0)
 S ^XTMP("ORK FILE CONVERSION")=0
"RTN","OROCAPI1",96,0)
 D MAIL
"RTN","OROCAPI1",97,0)
 Q
"RTN","OROCAPI1",98,0)
CONVERT1(I) ;CONVERT EXISTING FILE 100 NODE 9 ENTRIES OVER TO FILE 100.05 FOR 1 ORDER
"RTN","OROCAPI1",99,0)
 N $ETRAP,$ESTACK
"RTN","OROCAPI1",100,0)
 S $ETRAP="D ERR^OROCAPI1 Q"
"RTN","OROCAPI1",101,0)
 N J,ORK,DESC,RET
"RTN","OROCAPI1",102,0)
 S DESC="SIGNATURE_CPRS"
"RTN","OROCAPI1",103,0)
 S ^XTMP("ORK FILE CONVERSION",0)=$$FMADD^XLFDT($$NOW^XLFDT,90)_U_$$NOW^XLFDT
"RTN","OROCAPI1",104,0)
 I ",11,13,14,"[(","_$P($G(^OR(100,I,3)),U,3)_",") S DESC="ACCEPTANCE_CPRS"
"RTN","OROCAPI1",105,0)
 S J=0 F  S J=$O(^OR(100,I,9,J)) Q:'J  D
"RTN","OROCAPI1",106,0)
 .N X0,X1 S X0=$G(^OR(100,I,9,J,0)),X1=$G(^OR(100,I,9,J,1))
"RTN","OROCAPI1",107,0)
 .N ORKDT S ORKDT=$S($P(X0,U,6):$P(X0,U,6),1:$P($G(^OR(100,I,0)),U,7))
"RTN","OROCAPI1",108,0)
 .S ORK(J,1)=I_U_DESC_U_$P(X0,U,5)_U_ORKDT_U_$P(X0,U)
"RTN","OROCAPI1",109,0)
 .S ORK(J,2)=X1
"RTN","OROCAPI1",110,0)
 .S ORK(J,3)=$P(X0,U,4)
"RTN","OROCAPI1",111,0)
 I $D(ORK) D SAVEOC^OROCAPI1(.ORK,.RET)
"RTN","OROCAPI1",112,0)
 S ^XTMP("ORK FILE CONVERSION")=I
"RTN","OROCAPI1",113,0)
 Q
"RTN","OROCAPI1",114,0)
COPY(ORD1,ORD2) ;COPY THE ORDER CHECKS FROM ORDER 1 TO ORDER 2
"RTN","OROCAPI1",115,0)
 N RET,ORK,I
"RTN","OROCAPI1",116,0)
 D GETOC4(ORD1,.RET) S I=0 F  S I=$O(RET(ORD1,"DATA",I)) Q:'I  D
"RTN","OROCAPI1",117,0)
 .S ORK(I,1)=ORD2_U_$P($G(RET(ORD1,"DATA",I,0)),U,3)_U_$P($G(RET(ORD1,"DATA",I,0)),U,4)_U_$P($G(RET(ORD1,"DATA",I,0)),U,5)_U_$P($G(RET(ORD1,"DATA",I,1)),U,1)
"RTN","OROCAPI1",118,0)
 .S ORK(I,2)=$G(RET(ORD1,"DATA",I,"OC",1,0))
"RTN","OROCAPI1",119,0)
 .S ORK(I,3)=$G(RET(ORD1,"DATA",I,"OR",1,0))
"RTN","OROCAPI1",120,0)
 D SAVEOC(.ORK)
"RTN","OROCAPI1",121,0)
 Q
"RTN","OROCAPI1",122,0)
OCCNT(ORD) ;RETURN 1 IF THERE ARE ORDER CHECKS AND 0 IF NOT
"RTN","OROCAPI1",123,0)
 N RET,Y D GETOC2(ORD,.RET)
"RTN","OROCAPI1",124,0)
 S Y=0 I $D(RET) S Y=1
"RTN","OROCAPI1",125,0)
 Q Y
"RTN","OROCAPI1",126,0)
DELETE(ORD) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER
"RTN","OROCAPI1",127,0)
 N RET,I,DIK,DA D GETOC2(ORD,.RET)
"RTN","OROCAPI1",128,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",129,0)
 Q
"RTN","OROCAPI1",130,0)
DELOCC(ORD,OCC) ;DELETE ALL OF THE OC INSTANCES FOR AN ORDER/OCCURANCE PAIR
"RTN","OROCAPI1",131,0)
 N RET,I,DIK,DA D GETOC3(ORD,OCC,.RET)
"RTN","OROCAPI1",132,0)
 S I=0 F  S I=$O(RET(ORD,I)) Q:'I  S DA=I,DIK="^ORD(100.05," D ^DIK
"RTN","OROCAPI1",133,0)
 Q
"RTN","OROCAPI1",134,0)
ERR ;
"RTN","OROCAPI1",135,0)
 S ^XTMP("ORK FILE CONVERSION","ERRORS",ORN)=""
"RTN","OROCAPI1",136,0)
 S ^XTMP("ORK FILE CONVERSION")=ORN
"RTN","OROCAPI1",137,0)
 D UNWIND^%ZTER
"RTN","OROCAPI1",138,0)
 Q
"RTN","OROCAPI1",139,0)
MAIL ;send mail message to installer if any errors encountered during conversion process
"RTN","OROCAPI1",140,0)
 Q:'$D(^XTMP("ORK FILE CONVERSION","LAST ERRORS"))
"RTN","OROCAPI1",141,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,XMMG,ORTXT,I,J
"RTN","OROCAPI1",142,0)
 S XMDUZ="PATCH OR*3*293 ORDER CHECK CONVERSION" S:$G(DUZ) XMY(^XTMP("ORK FILE CONVERSION","INSTALLER"))=""
"RTN","OROCAPI1",143,0)
 S I=0,I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",144,0)
 S I=I+1,^TMP($J,"ORTXT",I)="While converting order check information from file 100 node 9 over to file"
"RTN","OROCAPI1",145,0)
 S I=I+1,^TMP($J,"ORTXT",I)="100.05, data errors were discovered for the order numbers listed below."
"RTN","OROCAPI1",146,0)
 S I=I+1,^TMP($J,"ORTXT",I)="All other order data converted appropriately."
"RTN","OROCAPI1",147,0)
 S I=I+1,^TMP($J,"ORTXT",I)="We recommend correcting the data, and then re-running the"
"RTN","OROCAPI1",148,0)
 S I=I+1,^TMP($J,"ORTXT",I)="conversion utility from programmer prompt as follows:"
"RTN","OROCAPI1",149,0)
 S I=I+1,^TMP($J,"ORTXT",I)="    D CONVERT^OROCAPI1"
"RTN","OROCAPI1",150,0)
 S I=I+1,^TMP($J,"ORTXT",I)="NOTE: re-running the conversion utility will only convert those orders that"
"RTN","OROCAPI1",151,0)
 S I=I+1,^TMP($J,"ORTXT",I)="did not convert properly the first time."
"RTN","OROCAPI1",152,0)
 S I=I+1,^TMP($J,"ORTXT",I)=""
"RTN","OROCAPI1",153,0)
 S I=I+1,^TMP($J,"ORTXT",I)="LIST OF ORDERS WITH CORRUPTED ORDER CHECK DATA"
"RTN","OROCAPI1",154,0)
 S I=I+1,^TMP($J,"ORTXT",I)="=============================================="
"RTN","OROCAPI1",155,0)
 S J=0 F  S J=$O(^XTMP("ORK FILE CONVERSION","LAST ERRORS",J)) Q:'J  S I=I+1,^TMP($J,"ORTXT",I)=J
"RTN","OROCAPI1",156,0)
 S XMTEXT="^TMP($J,""ORTXT"",",XMSUB="PATCH OR*3*293 CONVERSION ERRORS!"
"RTN","OROCAPI1",157,0)
 D ^XMD
"RTN","OROCAPI1",158,0)
 Q
"RTN","ORQ2")
0^2^B51979169^B52016905
"RTN","ORQ2",1,0)
ORQ2 ; SLC/MKB/GSS - Detailed Order Report ;03/14/11  09:33
"RTN","ORQ2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**12,56,75,94,141,213,195,243,282,293,280,346**;Dec 17, 1997;Build 5
"RTN","ORQ2",3,0)
 ;
"RTN","ORQ2",4,0)
 ;
"RTN","ORQ2",5,0)
 ;Reference to ^DIC(45.7 supported by IA #519
"RTN","ORQ2",6,0)
 ;Reference to OERR^VADPT supported by IA #4325
"RTN","ORQ2",7,0)
 ;
"RTN","ORQ2",8,0)
DETAIL(ORY,ORIFN) ; -- Returns details of order ORIFN in ORY(#)
"RTN","ORQ2",9,0)
 N X,X2,I,CNT,ORDIALOG,OR0,OR3,OR6,SEQ,ITEM,PRMT,MULT,FIRST,TITLE,INST,DIWL,DIWR,DIWF,ACTION,VAIN,ORIGVIEW,ORNMSP,ORYT
"RTN","ORQ2",10,0)
 S CNT=0,ORIFN=+ORIFN,OR0=$G(^OR(100,ORIFN,0)),OR3=$G(^(3)),OR6=$G(^(6))
"RTN","ORQ2",11,0)
 S ORNMSP=$$NMSP^ORCD($P(OR0,U,14))
"RTN","ORQ2",12,0)
 K @ORY,ORYT S ORIGVIEW=1 D TEXT^ORQ12(.ORYT,+ORIFN_";"_+$P(OR3,U,7),80) ;CurrTx
"RTN","ORQ2",13,0)
 M @ORY=ORYT ;Move text to global
"RTN","ORQ2",14,0)
 S I=0 F CNT=1:1 S I=$O(ORYT(I)) Q:I'>0  D:$D(IORVON) SETVIDEO(I,1,$L(ORYT(I)),IORVON,IORVOFF)
"RTN","ORQ2",15,0)
 S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",16,0)
D1 I $O(^OR(100,+ORIFN,2,0)) D
"RTN","ORQ2",17,0)
 . S CNT=CNT+1,@ORY@(CNT)="Sub Orders:"
"RTN","ORQ2",18,0)
 . D:$D(IOUON) SETVIDEO(CNT,1,11,IOUON,IOUOFF)
"RTN","ORQ2",19,0)
 . N IFN S IFN=0
"RTN","ORQ2",20,0)
 . F  S IFN=+$O(^OR(100,+ORIFN,2,IFN)) Q:IFN<1  I $D(^OR(100,IFN,0)) D SUB(IFN)
"RTN","ORQ2",21,0)
 . S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",22,0)
 I $P(OR3,U,9),$D(^OR(100,+$P(OR3,U,9),0)) D
"RTN","ORQ2",23,0)
 . S CNT=CNT+1,@ORY@(CNT)="Parent Order:"
"RTN","ORQ2",24,0)
 . D:$D(IOUON) SETVIDEO(CNT,1,12,IOUON,IOUOFF)
"RTN","ORQ2",25,0)
 . D SUB(+$P(OR3,U,9))
"RTN","ORQ2",26,0)
 . S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",27,0)
 I $P(OR3,U,11)=1,$P(OR3,U,5) D  ;Changed - show previous order
"RTN","ORQ2",28,0)
 . S CNT=CNT+1,@ORY@(CNT)="Previous Order:"
"RTN","ORQ2",29,0)
 . D:$D(IOUON) SETVIDEO(CNT,1,15,IOUON,IOUOFF) ;prev order original text
"RTN","ORQ2",30,0)
 . N ORZ,I,ORIGVIEW S ORIGVIEW=2 D TEXT^ORQ12(.ORZ,+$P(OR3,U,5),55)
"RTN","ORQ2",31,0)
 . S CNT=CNT+1,@ORY@(CNT)="     Order Text:        "_$G(ORZ(1))
"RTN","ORQ2",32,0)
 . S I=1 F  S I=$O(ORZ(I)) Q:I'>0  S CNT=CNT+1,@ORY@(CNT)=$$REPEAT^XLFSTR(" ",24)_$G(ORZ(I))
"RTN","ORQ2",33,0)
D2 S CNT=CNT+1,@ORY@(CNT)="Activity:"
"RTN","ORQ2",34,0)
 D:$D(IOUON) SETVIDEO(CNT,1,9,IOUON,IOUOFF)
"RTN","ORQ2",35,0)
 S DIWL=1,DIWR=64,DIWF="C64",ORI=0 K ^UTILITY($J,"W")
"RTN","ORQ2",36,0)
 F  S ORI=$O(^OR(100,ORIFN,8,ORI)) Q:ORI'>0  S ACTION=$G(^(ORI,0)) D ACT^ORQ20
"RTN","ORQ2",37,0)
 I "^1^12^13^"[(U_$P(OR3,U,3)_U),$L(OR6),$P(ACTION,U,2)'="DC" D DC^ORQ20
"RTN","ORQ2",38,0)
 I $P(OR3,U,3)=2,$P(OR6,U,6) S CNT=CNT+1,@ORY@(CNT)=$$DATE^ORQ20($P(OR6,U,6))_"  Completed"_$S($P(OR6,U,7):" by "_$$USER^ORQ20($P(OR6,U,7)),1:"")
"RTN","ORQ2",39,0)
 S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",40,0)
D3 S CNT=CNT+1,@ORY@(CNT)="Current Data:"
"RTN","ORQ2",41,0)
 D:$D(IOUON) SETVIDEO(CNT,1,13,IOUON,IOUOFF)
"RTN","ORQ2",42,0)
 D VA I $G(VAIN(2)) S CNT=CNT+1,@ORY@(CNT)="Current Primary Provider:     "_$P(VAIN(2),"^",2)
"RTN","ORQ2",43,0)
 I $G(VAIN(11)) S CNT=CNT+1,@ORY@(CNT)="Current Attending Physician:  "_$P(VAIN(11),"^",2)
"RTN","ORQ2",44,0)
 S CNT=CNT+1,@ORY@(CNT)="Treating Specialty:           "_$P($G(^DIC(45.7,+$P(OR0,U,13),0)),U)
"RTN","ORQ2",45,0)
 S CNT=CNT+1,@ORY@(CNT)="Ordering Location:            "_$P($G(^SC(+$P(OR0,U,10),0)),U)
"RTN","ORQ2",46,0)
 S CNT=CNT+1,@ORY@(CNT)="Start Date/Time:              "_$S($P(OR0,U,8):$$DATE^ORQ20($P(OR0,U,8)),1:"")
"RTN","ORQ2",47,0)
 I $P(OR3,U,5),$P(OR3,U,11)=2 S X=$$ORIG(ORIFN),@ORY@(CNT)=@ORY@(CNT)_" (originally "_$$DATE^ORQ20(X)_")"
"RTN","ORQ2",48,0)
 S CNT=CNT+1,@ORY@(CNT)="Stop Date/Time:               "_$S($P(OR0,U,9):$$DATE^ORQ20($P(OR0,U,9)),1:"")
"RTN","ORQ2",49,0)
 I $P(OR3,U,3)=1,$P(OR6,U,6) S @ORY@(CNT)=@ORY@(CNT)_"  (expired "_$$DATE^ORQ20($P(OR6,U,6))_")"
"RTN","ORQ2",50,0)
 S CNT=CNT+1,@ORY@(CNT)="Current Status:               "_$S($D(^ORD(100.01,+$P(OR3,U,3),0)):$P(^(0),"^"),1:"-")
"RTN","ORQ2",51,0)
 I $$GET^XPAR("ALL","ORPF SHOW STATUS DESCRIPTION",1,"I"),$P(OR3,U,3),$D(^ORD(100.01,$P(OR3,U,3),0)) N J S J=0 F  S J=$O(^ORD(100.01,$P(OR3,U,3),1,J)) Q:J<1  S CNT=CNT+1,@ORY@(CNT)="  "_^(J,0)
"RTN","ORQ2",52,0)
 S CNT=CNT+1,@ORY@(CNT)="Order #"_ORIFN
"RTN","ORQ2",53,0)
 S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",54,0)
D4 S CNT=CNT+1,@ORY@(CNT)="Order:" D:$D(IOUON) SETVIDEO(CNT,1,6,IOUON,IOUOFF)
"RTN","ORQ2",55,0)
 I '$O(^OR(100,ORIFN,4.5,0)),ORNMSP="RA" D RAD^ORQ21("") Q
"RTN","ORQ2",56,0)
 S ORDIALOG=$P(OR0,U,5) Q:$P(ORDIALOG,";",2)="ORD(101,"  ; 2.5 order
"RTN","ORQ2",57,0)
 D GETDLG^ORCD(+ORDIALOG),GETORDER^ORCD(ORIFN)
"RTN","ORQ2",58,0)
 S DIWL=1,DIWR=50,DIWF="C50"
"RTN","ORQ2",59,0)
 S SEQ=0 F  S SEQ=$O(^ORD(101.41,+ORDIALOG,10,"B",SEQ)) Q:SEQ'>0  S DA=0 F  S DA=$O(^ORD(101.41,+ORDIALOG,10,"B",SEQ,DA)) Q:'DA  D
"RTN","ORQ2",60,0)
 . S ITEM=$G(^ORD(101.41,+ORDIALOG,10,DA,0)) Q:$P(ITEM,U,11)  ; child
"RTN","ORQ2",61,0)
 . S PRMT=$P(ITEM,U,2),MULT=$P(ITEM,U,7) Q:$P(ITEM,U,9)["*"  ;hide
"RTN","ORQ2",62,0)
 . S FIRST=$O(ORDIALOG(PRMT,0)) Q:'FIRST  ; no values
"RTN","ORQ2",63,0)
 . S TITLE=$S(MULT&$L($G(ORDIALOG(PRMT,"TTL"))):ORDIALOG(PRMT,"TTL"),1:ORDIALOG(PRMT,"A"))
"RTN","ORQ2",64,0)
 . S TITLE=TITLE_$$REPEAT^XLFSTR(" ",30-$L(TITLE))
"RTN","ORQ2",65,0)
 . S INST=0 F  S INST=$O(ORDIALOG(PRMT,INST)) Q:INST'>0  D
"RTN","ORQ2",66,0)
 . . I $E(ORDIALOG(PRMT,0))="W" D WP Q
"RTN","ORQ2",67,0)
 . . K ^UTILITY($J,"W") S X=$$EXT^ORCD(PRMT,INST) I TITLE["Infusion Rate"&(X'="")&(X'["ml/hr") S TITLE="Infuse Over Time:",TITLE=TITLE_$$REPEAT^XLFSTR(" ",30-$L(TITLE))
"RTN","ORQ2",68,0)
 . . D ^DIWP
"RTN","ORQ2",69,0)
 . . D:$D(^ORD(101.41,+ORDIALOG,10,"DAD",PRMT)) CHILDREN(PRMT)
"RTN","ORQ2",70,0)
 . . S I=0 F  S I=$O(^UTILITY($J,"W",DIWL,I)) Q:I'>0  S CNT=CNT+1,@ORY@(CNT)=$S((INST=FIRST)&(I=1):TITLE,1:$$REPEAT^XLFSTR(" ",30))_^(I,0)
"RTN","ORQ2",71,0)
 I ORNMSP="GMRC",$G(^OR(100,ORIFN,4)) S CNT=CNT+1,@ORY@(CNT)="Consult No.:                  "_+^(4)
"RTN","ORQ2",72,0)
 S CNT=CNT+1,@ORY@(CNT)="   " ;blank
"RTN","ORQ2",73,0)
 D RAD^ORQ21(1):ORNMSP="RA",MED^ORQ21:ORNMSP="PS" ;add'l data
"RTN","ORQ2",74,0)
 D BA^ORQ21 ;call for CIDC data
"RTN","ORQ2",75,0)
D5 K ^TMP($J,"OCDATA") I $$OCAPI^ORCHECK(+ORIFN,"OCDATA") D
"RTN","ORQ2",76,0)
 . N CK,OK,X0,X,CDL,I S CNT=CNT+1,@ORY@(CNT)="Order Checks:"
"RTN","ORQ2",77,0)
 . D:$D(IOUON) SETVIDEO(CNT,1,13,IOUON,IOUOFF)
"RTN","ORQ2",78,0)
 . S CK=0 F  S CK=$O(^TMP($J,"OCDATA",CK)) Q:CK'>0  D
"RTN","ORQ2",79,0)
 .. S X0=^TMP($J,"OCDATA",CK,"OC NUMBER")_U_^TMP($J,"OCDATA",CK,"OC LEVEL")_U_U_^TMP($J,"OCDATA",CK,"OR REASON")_U_^TMP($J,"OCDATA",CK,"OR PROVIDER")_U_^TMP($J,"OCDATA",CK,"OR DT")
"RTN","ORQ2",80,0)
 .. S X=^TMP($J,"OCDATA",CK,"OC TEXT",1,0)
"RTN","ORQ2",81,0)
 .. S CDL=$$CDL($P(X0,U,2)) I $P(X0,U,6),'$D(OK) S OK=$P(X0,U,4,6)
"RTN","ORQ2",82,0)
 .. I $L(X)'>68 S CNT=CNT+1,@ORY@(CNT)=CDL_X D XTRA Q
"RTN","ORQ2",83,0)
 .. S DIWL=1,DIWR=68,DIWF="C68" K ^UTILITY($J,"W") D ^DIWP
"RTN","ORQ2",84,0)
 .. S I=0 F  S I=$O(^UTILITY($J,"W",DIWL,I)) Q:I'>0  S CNT=CNT+1,@ORY@(CNT)=CDL_^(I,0),CDL="            "
"RTN","ORQ2",85,0)
 .. D XTRA
"RTN","ORQ2",86,0)
 . K ^TMP($J,"OCDATA")
"RTN","ORQ2",87,0)
 . Q:'$L($G(OK))  S CNT=CNT+1,@ORY@(CNT)="Override:   "_$S($P(OK,U,2):$$USER^ORQ20($P(OK,U,2))_" on ",1:"")_$$DATE^ORQ20($P(OK,U,3))
"RTN","ORQ2",88,0)
 . I $L($P(OK,U))'>68 S CNT=CNT+1,@ORY@(CNT)="            "_$P(OK,U) Q
"RTN","ORQ2",89,0)
 . S DIWL=1,DIWR=68,DIWF="C68",X=$P(OK,U) K ^UTILITY($J,"W") D ^DIWP
"RTN","ORQ2",90,0)
 . S I=0 F  S I=$O(^UTILITY($J,"W",DIWL,I)) Q:I'>0  S CNT=CNT+1,@ORY@(CNT)="            "_^(I,0)
"RTN","ORQ2",91,0)
 K ^TMP("ORWORD",$J),^UTILITY($J,"W")
"RTN","ORQ2",92,0)
 Q
"RTN","ORQ2",93,0)
 ;
"RTN","ORQ2",94,0)
XTRA ;
"RTN","ORQ2",95,0)
 I $O(^TMP($J,"OCDATA",CK,"OC TEXT",1)) N ORXT S ORXT=1 F  S ORXT=$O(^TMP($J,"OCDATA",CK,"OC TEXT",ORXT)) Q:'ORXT  D
"RTN","ORQ2",96,0)
 . S X=^TMP($J,"OCDATA",CK,"OC TEXT",ORXT,0),CDL="              "
"RTN","ORQ2",97,0)
 . I $L(X)'>68 S CNT=CNT+1,@ORY@(CNT)=CDL_X Q
"RTN","ORQ2",98,0)
 . S DIWL=1,DIWR=68,DIWF="C68" K ^UTILITY($J,"W") D ^DIWP
"RTN","ORQ2",99,0)
 . S I=0 F  S I=$O(^UTILITY($J,"W",DIWL,I)) Q:I'>0  S CNT=CNT+1,@ORY@(CNT)=CDL_^(I,0),CDL="              "
"RTN","ORQ2",100,0)
 I $O(^TMP($J,"OCDATA",CK,"OC TEXT",1)) S X="",CNT=CNT+1,@ORY@(CNT)="              "
"RTN","ORQ2",101,0)
 Q
"RTN","ORQ2",102,0)
 ;
"RTN","ORQ2",103,0)
SUB(IFN) ; -- add suborder or parent
"RTN","ORQ2",104,0)
 N ORCY,STS,STRT,IG,A,STOP,SCHED D TEXT^ORQ12(.ORCY,IFN,58)
"RTN","ORQ2",105,0)
 S STS=$G(^ORD(100.01,+$P($G(^OR(100,IFN,3)),U,3),.1))
"RTN","ORQ2",106,0)
 S A=^OR(100,IFN,0),STRT=$P(A,U,8),STOP=$P(A,U,9)
"RTN","ORQ2",107,0)
 S SCHED=$$VALUE^ORX8(IFN,"SCHEDULE",1,"E")
"RTN","ORQ2",108,0)
 S:STRT'="" STRT=$$DATE^ORQ20(STRT) I ORNMSP="LR" S:STOP]"" STOP=$$DATE^ORQ20(STOP)
"RTN","ORQ2",109,0)
 S IG=0 F  S IG=$O(ORCY(IG)) Q:IG<1  S CNT=CNT+1,@ORY@(CNT)=$J(STS,4)_" "_ORCY(IG)_" "_STRT,(STS,STRT)=" "
"RTN","ORQ2",110,0)
 I ORNMSP="LR",STOP]"" S CNT=CNT+1,@ORY@(CNT)=$J("How often: ",16)_SCHED_"   Stops:  "_STOP
"RTN","ORQ2",111,0)
 Q
"RTN","ORQ2",112,0)
 ;
"RTN","ORQ2",113,0)
WP ; -- add word-processing
"RTN","ORQ2",114,0)
 N WP,ORI,X M WP=@ORDIALOG(PRMT,INST)
"RTN","ORQ2",115,0)
 S CNT=CNT+1,@ORY@(CNT)=TITLE
"RTN","ORQ2",116,0)
 S ORI=0 F  S ORI=$O(WP(ORI)) Q:ORI'>0  S X=WP(ORI,0) S:X'="" CNT=CNT+1,@ORY@(CNT)="  "_X
"RTN","ORQ2",117,0)
 Q
"RTN","ORQ2",118,0)
 ;
"RTN","ORQ2",119,0)
CHILDREN(PARENT) ; -- add children
"RTN","ORQ2",120,0)
 N SEQ,DA,ITM,PRMT,TYPE,X
"RTN","ORQ2",121,0)
 S SEQ=0 F  S SEQ=$O(^ORD(101.41,+ORDIALOG,10,"DAD",PARENT,SEQ)) Q:SEQ'>0  S DA=$O(^(SEQ,0)) D
"RTN","ORQ2",122,0)
 . S ITM=$G(^ORD(101.41,+ORDIALOG,10,DA,0)),PRMT=$P(ITM,U,2)
"RTN","ORQ2",123,0)
 . Q:$G(ORDIALOG(PRMT,INST))=""  Q:$P(ITM,U,9)["*"  ;no value or hide
"RTN","ORQ2",124,0)
 . S TYPE=$E(ORDIALOG(PRMT,0)) D:TYPE="W" WP
"RTN","ORQ2",125,0)
 . I TYPE'="W" D
"RTN","ORQ2",126,0)
 . . S X=$$EXT^ORCD(PRMT,INST)
"RTN","ORQ2",127,0)
 . . I $L(X,"|")=2 S X=$$REPLACE^ORHLESC(X,"|","||")
"RTN","ORQ2",128,0)
 . . D ^DIWP
"RTN","ORQ2",129,0)
 Q
"RTN","ORQ2",130,0)
 ;
"RTN","ORQ2",131,0)
SETVIDEO(LINE,COL,WIDTH,ON,OFF) ; -- set video attributes
"RTN","ORQ2",132,0)
 S ORY("VIDEO",LINE,COL,WIDTH)=ON
"RTN","ORQ2",133,0)
 S ORY("VIDEO",LINE,COL+WIDTH,0)=OFF
"RTN","ORQ2",134,0)
 Q
"RTN","ORQ2",135,0)
 ;
"RTN","ORQ2",136,0)
VA ; -- Call VADPT
"RTN","ORQ2",137,0)
 N ORY,DFN,Y S DFN=+$P(OR0,"^",2) D OERR^VADPT
"RTN","ORQ2",138,0)
 Q
"RTN","ORQ2",139,0)
 ;
"RTN","ORQ2",140,0)
CDL(X) ; -- Returns Clinical Danger Level X
"RTN","ORQ2",141,0)
 N Y S Y=$S(X=1:"HIGH:",X=2:"MODERATE:",X=3:"LOW:",1:"NONE:")
"RTN","ORQ2",142,0)
 S Y=$E(Y_"        ",1,12)
"RTN","ORQ2",143,0)
 Q Y
"RTN","ORQ2",144,0)
 ;
"RTN","ORQ2",145,0)
ORIG(IFN) ; -- Return original start date of [renewal] order
"RTN","ORQ2",146,0)
 N I,Y,X3,DONE
"RTN","ORQ2",147,0)
 S I=IFN,Y=$P($G(^OR(100,IFN,0)),U,8),DONE=0
"RTN","ORQ2",148,0)
 F  S X3=$G(^OR(100,I,3)) D  Q:DONE
"RTN","ORQ2",149,0)
 . I $P(X3,U,11)=2,$P(X3,U,5) S I=$P(X3,U,5) Q  ;loop
"RTN","ORQ2",150,0)
 . S Y=$P($G(^OR(100,I,0)),U,8),DONE=1
"RTN","ORQ2",151,0)
 Q Y
"RTN","ORWDXC")
0^6^B61402104^B52838872
"RTN","ORWDXC",1,0)
ORWDXC ; SLC/KCM - Utilities for Order Checking ;07/27/11  07:10
"RTN","ORWDXC",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,141,221,243,280,346**;Dec 17, 1997;Build 5
"RTN","ORWDXC",3,0)
 ;
"RTN","ORWDXC",4,0)
ORMOCHAT ;PARSE MOCHA METRICS
"RTN","ORWDXC",5,0)
 ;N ORMDT
"RTN","ORWDXC",6,0)
 ;S ORMDT=0 F  S ORMDT=$O(^XTMP("ORMOCHAT",ORMDT)) Q:'ORMDT  D
"RTN","ORWDXC",7,0)
 ;.N ORMX
"RTN","ORWDXC",8,0)
 ;.S ORMX="" F  S ORMX=$O(^XTMP("ORMOCHAT",ORMDT,ORMX)) Q:'ORMX  D
"RTN","ORWDXC",9,0)
 ;..S $P(^XTMP("ORMOCHAT",ORMDT,ORMX),U,5)=$P(^XTMP("ORMOCHAT",ORMDT,ORMX,"TOTAL"),U,2)-$P(^XTMP("ORMOCHAT",ORMDT,ORMX,"TOTAL"),U)
"RTN","ORWDXC",10,0)
 ;..N ORMENHT,ORMENHC,ORMENHX S ORMENHT=0,ORMENHC=0,ORMENHX=0
"RTN","ORWDXC",11,0)
 ;..F  S ORMENHC=$O(^XTMP("ORMOCHAT",ORMDT,ORMX,"ENH",ORMENHC)) Q:'ORMENHC  S ORMENHT=ORMENHT+$P(^XTMP("ORMOCHAT",ORMDT,ORMX,"ENH",ORMENHC),U,2)-$P(^XTMP("ORMOCHAT",ORMDT,ORMX,"ENH",ORMENHC),U),ORMENHX=ORMENHC
"RTN","ORWDXC",12,0)
 ;..S $P(^XTMP("ORMOCHAT",ORMDT,ORMX),U,6)=ORMENHT
"RTN","ORWDXC",13,0)
 ;..S $P(^XTMP("ORMOCHAT",ORMDT,ORMX),U,7)=ORMENHX
"RTN","ORWDXC",14,0)
 ;..N ORDIFF S ORDIFF=$ZH-ORMX
"RTN","ORWDXC",15,0)
 ;..S $P(^XTMP("ORMOCHAT",ORMDT,ORMX),U,8)=$$FMADD^XLFDT($$NOW^XLFDT,"","","",-ORDIFF)
"RTN","ORWDXC",16,0)
 ;..S $P(^XTMP("ORMOCHAT",ORMDT,ORMX),U,9)="||"
"RTN","ORWDXC",17,0)
 ;..W !,^XTMP("ORMOCHAT",ORMDT,ORMX)
"RTN","ORWDXC",18,0)
 Q
"RTN","ORWDXC",19,0)
ON(VAL) ; returns E if order checking enabled, otherwise D
"RTN","ORWDXC",20,0)
 S VAL=$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE")
"RTN","ORWDXC",21,0)
 Q
"RTN","ORWDXC",22,0)
FILLID(VAL,DLG) ; Return the FillerID (namespace) for a dialog
"RTN","ORWDXC",23,0)
 N DGRP
"RTN","ORWDXC",24,0)
 S VAL="",DGRP=$P($G(^ORD(101.41,DLG,0)),U,5) Q:'DGRP
"RTN","ORWDXC",25,0)
 S DLG=$$DEFDLG^ORWDXQ(DGRP)
"RTN","ORWDXC",26,0)
 S VAL=$P($G(^ORD(101.41,DLG,0)),U,7),VAL=$$NMSP^ORCD(VAL)
"RTN","ORWDXC",27,0)
 I VAL="PS" D
"RTN","ORWDXC",28,0)
 . N X
"RTN","ORWDXC",29,0)
 . S X=$P($P($G(^ORD(100.98,DGRP,0)),U,3)," ")
"RTN","ORWDXC",30,0)
 . I $L(X) S VAL="PS"_$S(X="UD":"I",1:X)
"RTN","ORWDXC",31,0)
 Q
"RTN","ORWDXC",32,0)
DISPLAY(LST,DFN,FID) ; Return list of Order Checks for a FillerID (namespace)
"RTN","ORWDXC",33,0)
 N I,ORX,ORY
"RTN","ORWDXC",34,0)
 S ORX=1,ORX(1)="|"_FID
"RTN","ORWDXC",35,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"DISPLAY")
"RTN","ORWDXC",36,0)
 S I=0 F  S I=$O(ORY(I)) Q:I'>0  S LST(I)=$P(ORY(I),U,4)
"RTN","ORWDXC",37,0)
 Q
"RTN","ORWDXC",38,0)
ACCEPT(LST,DFN,FID,STRT,ORL,OIL,ORIFN,ORREN)    ; Return list of Order Checks on Accept Order
"RTN","ORWDXC",39,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",40,0)
 ; ORREN - IF ORREN IS SET TO 1 THEN ORIFN IS THE ORDER GETTING RENEWED
"RTN","ORWDXC",41,0)
 ;S ^XTMP("ORMOCHAT",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT N ORMOCHAT S ORMOCHAT=$NA(^XTMP("ORMOCHAT",$$NOW^XLFDT,$ZH)) S @ORMOCHAT="ORWDXC ACCEPT"_U_$J_U_DFN_U_DUZ,$P(@ORMOCHAT@("TOTAL"),U,1)=$ZH
"RTN","ORWDXC",42,0)
 N X,Y,USID,ORCHECK,ORI,ORX,ORY
"RTN","ORWDXC",43,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",44,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",45,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",46,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",47,0)
 ; do the SELECT order checks
"RTN","ORWDXC",48,0)
 S ORI=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",49,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",50,0)
 . S USID=$$USID(OIL(ORI))
"RTN","ORWDXC",51,0)
 . S OIL(ORI,"USID")=USID
"RTN","ORWDXC",52,0)
 . S ORX=1,ORX(1)=+OIL(ORI)_"|"_FID_"|"_USID
"RTN","ORWDXC",53,0)
 . D EN^ORKCHK(.ORY,DFN,.ORX,"SELECT")
"RTN","ORWDXC",54,0)
 . I $D(ORY) D RETURN^ORCHECK ; expects ORY, ORCHECK
"RTN","ORWDXC",55,0)
 . K ORX,ORY
"RTN","ORWDXC",56,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",57,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",58,0)
 . Q:'OIL(ORI)
"RTN","ORWDXC",59,0)
 . S ORX=ORX+1
"RTN","ORWDXC",60,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_OIL(ORI,"USID")_"|"_STRT
"RTN","ORWDXC",61,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",62,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ACCEPT",.OIL)
"RTN","ORWDXC",63,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",64,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",65,0)
 D FDBDOWN^ORCHECK(0)
"RTN","ORWDXC",66,0)
 D OPOS(DFN)
"RTN","ORWDXC",67,0)
 D CHK2LST
"RTN","ORWDXC",68,0)
 ;I $D(ORMOCHAT) S $P(@ORMOCHAT@("TOTAL"),U,2)=$ZH
"RTN","ORWDXC",69,0)
 Q
"RTN","ORWDXC",70,0)
DELAY(LST,DFN,FID,STRT,ORL,OIL) ; Return list of Order Checks on Accept Delayed
"RTN","ORWDXC",71,0)
 ; OIL(n)=OIptr^PS|PSIV|LR^PkgInfo
"RTN","ORWDXC",72,0)
 N X,Y,ORCHECK,ORI,ORX,ORY
"RTN","ORWDXC",73,0)
 ; convert relative start date to real start date
"RTN","ORWDXC",74,0)
 S ORL=ORL_";SC(",X=STRT,STRT=""
"RTN","ORWDXC",75,0)
 D:X="AM" AM^ORCSAVE2 D:X="NEXT" NEXT^ORCSAVE2
"RTN","ORWDXC",76,0)
 I $L(X) S %DT="FTX" D ^%DT S:Y'>0 Y="" S STRT=Y
"RTN","ORWDXC",77,0)
 ; do the ACCEPT order checks
"RTN","ORWDXC",78,0)
 S (ORI,ORX)=0 F  S ORI=$O(OIL(ORI)) Q:'ORI  D
"RTN","ORWDXC",79,0)
 . S ORX=ORX+1
"RTN","ORWDXC",80,0)
 . S ORX(ORX)=+OIL(ORI)_"|"_FID_"|"_$$USID(OIL(ORI))_"|"_STRT
"RTN","ORWDXC",81,0)
 . I $P(OIL(ORI),U,2)="LR" S $P(ORX(ORX),"|",6)=$P(OIL(ORI),U,3)
"RTN","ORWDXC",82,0)
 D EN^ORKCHK(.ORY,DFN,.ORX,"ALL")
"RTN","ORWDXC",83,0)
 I $D(ORY) D RETURN^ORCHECK   ; expects ORY, ORCHECK
"RTN","ORWDXC",84,0)
 ; return ORCHECK as 1 dimensional list
"RTN","ORWDXC",85,0)
 D CHK2LST
"RTN","ORWDXC",86,0)
 Q
"RTN","ORWDXC",87,0)
SESSION(LST,ORVP,ORLST)  ; Return list of Order Checks on Release Order
"RTN","ORWDXC",88,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",89,0)
 ;S ^XTMP("ORMOCHAT",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT N ORMOCHAT S ORMOCHAT=$NA(^XTMP("ORMOCHAT",$$NOW^XLFDT,$ZH)) S @ORMOCHAT="ORWDXC SESSION"_U_$J_U_ORVP_U_DUZ,$P(@ORMOCHAT@("TOTAL"),U,1)=$ZH
"RTN","ORWDXC",90,0)
 N ORES,ORCHECK
"RTN","ORWDXC",91,0)
 S ORVP=+ORVP_";DPT("
"RTN","ORWDXC",92,0)
 S I=0 F  S I=$O(ORLST(I)) Q:'I  D
"RTN","ORWDXC",93,0)
 . I +$P(ORLST(I),";",2)'=1 Q  ; order not new
"RTN","ORWDXC",94,0)
 . I $P(ORLST(I),U,3)="0" Q    ; order not being released
"RTN","ORWDXC",95,0)
 . S ORES($P(ORLST(I),U))=""
"RTN","ORWDXC",96,0)
 D SESSION^ORCHECK
"RTN","ORWDXC",97,0)
 D OPOS(+ORVP)
"RTN","ORWDXC",98,0)
 D CHK2LST
"RTN","ORWDXC",99,0)
 D CHECKIT(.LST)
"RTN","ORWDXC",100,0)
 ;I $D(ORMOCHAT) S $P(@ORMOCHAT@("TOTAL"),U,2)=$ZH
"RTN","ORWDXC",101,0)
 K ^TMP($J,"OROCOUTO;"),^TMP($J,"OROCOUTI;"),^TMP($J,"DD")
"RTN","ORWDXC",102,0)
 Q
"RTN","ORWDXC",103,0)
SAVECHK(OK,ORVP,RSN,LST)    ; Save order checks for session
"RTN","ORWDXC",104,0)
 N ORCHECK,ORIFN S OK=1
"RTN","ORWDXC",105,0)
 D LST2CHK
"RTN","ORWDXC",106,0)
 I $L(RSN)>0 S ORCHECK("OK")=RSN
"RTN","ORWDXC",107,0)
 S ORIFN=0 F  S ORIFN=$O(ORCHECK(ORIFN)) Q:'ORIFN  D OC^ORCSAVE2
"RTN","ORWDXC",108,0)
 Q
"RTN","ORWDXC",109,0)
DELORD(OK,ORIFN)      ; Delete order
"RTN","ORWDXC",110,0)
 N STS,DIK,DA
"RTN","ORWDXC",111,0)
 S STS=$P(^OR(100,+ORIFN,8,1,0),U,15),OK=0
"RTN","ORWDXC",112,0)
 I (STS=10)!(STS=11) D  Q  ; makes sure it's an unreleased order
"RTN","ORWDXC",113,0)
 . S DA=+ORIFN,DIK="^OR(100," Q:'DA
"RTN","ORWDXC",114,0)
 . D ^DIK
"RTN","ORWDXC",115,0)
 . S OK=1
"RTN","ORWDXC",116,0)
 . D DELETE^OROCAPI1(+ORIFN)
"RTN","ORWDXC",117,0)
 Q
"RTN","ORWDXC",118,0)
USID(ORITMX) ; Return universal svc ID for an orderable item
"RTN","ORWDXC",119,0)
 ; ORITMX = OI^NMSP^PKGINFO
"RTN","ORWDXC",120,0)
 N RSLT,ORDRUG S RSLT=""
"RTN","ORWDXC",121,0)
 I $E($P(ORITMX,U,2),1,2)="PS" D
"RTN","ORWDXC",122,0)
 . I $P(ORITMX,U,2)="PSIV" D
"RTN","ORWDXC",123,0)
 . . N PSOI,TYPE,VOL S VOL=""
"RTN","ORWDXC",124,0)
 . . S PSOI=+$P($G(^ORD(101.43,+ORITMX,0)),U,2)
"RTN","ORWDXC",125,0)
 . . S TYPE=$P($P(ORITMX,U,3),";")
"RTN","ORWDXC",126,0)
 . . I TYPE="B" S VOL=$P($P(ORITMX,U,3),";",2)
"RTN","ORWDXC",127,0)
 . . D ENDDIV^PSJORUTL(PSOI,TYPE,VOL,.ORDRUG)
"RTN","ORWDXC",128,0)
 . . S ORDRUG=+ORDRUG
"RTN","ORWDXC",129,0)
 . E  S ORDRUG=+$P(ORITMX,U,3)
"RTN","ORWDXC",130,0)
 . S RSLT=$$ENDCM^PSJORUTL(ORDRUG)
"RTN","ORWDXC",131,0)
 . S RSLT=$P(RSLT,U,3)_"^^99NDF^"_ORDRUG_U_$$NAME50^ORPEAPI(ORDRUG)_"^99PSD"
"RTN","ORWDXC",132,0)
 E  S RSLT=$$USID^ORMBLD(+ORITMX)
"RTN","ORWDXC",133,0)
 I +$P(RSLT,U)=0,+($P(RSLT,U,4)=0) S RSLT="" ; has to be null (why?)
"RTN","ORWDXC",134,0)
 Q RSLT
"RTN","ORWDXC",135,0)
 ;
"RTN","ORWDXC",136,0)
CHK2LST ; creates list that can be passed to broker from ORCHECK array
"RTN","ORWDXC",137,0)
 ; expects ORCHECK to be present and populates LST
"RTN","ORWDXC",138,0)
 D REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",139,0)
 N ORIFN,ORID,CDL,I,ILST,LASTIFN,RESERVED,ORCHECK2,ORNUM,OLIST S ILST=0,LASTIFN=0,RESERVED=0,OLIST=0
"RTN","ORWDXC",140,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",141,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",142,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",143,0)
 . . . S ORCHECK2(ORIFN,CDL,+ORCHECK(ORIFN,CDL,I),I)=ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",144,0)
 K ORCHECK
"RTN","ORWDXC",145,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK2(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",146,0)
 . S CDL=0 F  S CDL=$O(ORCHECK2(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",147,0)
 . . S ORNUM=0 F  S ORNUM=$O(ORCHECK2(ORIFN,CDL,ORNUM)) Q:'ORNUM  D
"RTN","ORWDXC",148,0)
 . . . S I=0 F  S I=$O(ORCHECK2(ORIFN,CDL,ORNUM,I)) Q:'I  D
"RTN","ORWDXC",149,0)
 . . . . S OLIST=OLIST+1,ORCHECK(ORIFN,CDL,OLIST)=ORCHECK2(ORIFN,CDL,ORNUM,I)
"RTN","ORWDXC",150,0)
 S ORIFN="" F  S ORIFN=$O(ORCHECK(ORIFN)) Q:ORIFN=""  D
"RTN","ORWDXC",151,0)
 . S CDL=0 F  S CDL=$O(ORCHECK(ORIFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",152,0)
 . . S I=0 F  S I=$O(ORCHECK(ORIFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",153,0)
 . . . I LASTIFN'=ORIFN S LASTIFN=ORIFN,RESERVED=ILST+1,ILST=ILST+1 ; saves a spot for the RDI warning at the top of each order's checks
"RTN","ORWDXC",154,0)
 . . . S ORID=ORIFN I +ORID,(+ORID=ORID) S ORID=ORID_";1"
"RTN","ORWDXC",155,0)
 . . . I '$P(ORCHECK(ORIFN,CDL,I),U,2) Q  ; CDL="" means don't show
"RTN","ORWDXC",156,0)
 . . . I $P(ORCHECK(ORIFN,CDL,I),U,1)=99 S LST(RESERVED)=ORID_U_ORCHECK(ORIFN,CDL,I) Q  ;Put RDI warning at the top of each order's checks
"RTN","ORWDXC",157,0)
 . . . S ILST=ILST+1,LST(ILST)=ORID_U_ORCHECK(ORIFN,CDL,I)
"RTN","ORWDXC",158,0)
 Q
"RTN","ORWDXC",159,0)
LST2CHK ; create ORCHECK array from list passed by broker
"RTN","ORWDXC",160,0)
 N ORIFN,CDL,I,ILST S I=0
"RTN","ORWDXC",161,0)
 S ILST="" F  S ILST=$O(LST("ORCHECKS",ILST)) Q:$L(ILST)'>0  D
"RTN","ORWDXC",162,0)
 . I $D(LST("ORCHECKS",ILST,0)) D
"RTN","ORWDXC",163,0)
 . . N J S J=0 S X=LST("ORCHECKS",ILST,J) F  S J=$O(LST("ORCHECKS",ILST,J)) Q:'J  S X=X_LST("ORCHECKS",ILST,J)
"RTN","ORWDXC",164,0)
 . I '$D(LST("ORCHECKS",ILST,0)) S X=LST("ORCHECKS",ILST)
"RTN","ORWDXC",165,0)
 . S ORIFN=$P(X,U),CDL=$P(X,U,3)
"RTN","ORWDXC",166,0)
 . I +$G(ORIFN)>0,+$G(CDL)>0 D  ;cla 12/16/03
"RTN","ORWDXC",167,0)
 . . S I=I+1,ORCHECK(+ORIFN,CDL,I)=$P(X,U,2,4)
"RTN","ORWDXC",168,0)
 Q
"RTN","ORWDXC",169,0)
CHECKIT(X) ;remove uncessesary duplication of Duplicate Therapy checks
"RTN","ORWDXC",170,0)
 N I,J,Y
"RTN","ORWDXC",171,0)
 S I=0 F  S I=$O(X(I)) Q:'I  I $P(X(I),U,2)=17 D
"RTN","ORWDXC",172,0)
 .Q:$P($G(^ORD(100.8,17,0)),U)'="DUPLICATE DRUG THERAPY"
"RTN","ORWDXC",173,0)
 .N STR S STR=$P($P(X(I),"{",2),"}")
"RTN","ORWDXC",174,0)
 .S J=0 F  S J=J+1 Q:J>$L(STR,", ")  S Y(+X(I),I,J)=$P(STR,", ",J)
"RTN","ORWDXC",175,0)
 S I=0 F  S I=$O(Y(I)) Q:'I  D
"RTN","ORWDXC",176,0)
 .S J=0 F  S J=$O(Y(I,J)) Q:'J  D
"RTN","ORWDXC",177,0)
 ..S K=J F  S K=$O(Y(I,K)) Q:'K  D
"RTN","ORWDXC",178,0)
 ...N A,B M A=Y(I,J),B=Y(I,K)
"RTN","ORWDXC",179,0)
 ...I $$AINB(.A,.B) K X(J)
"RTN","ORWDXC",180,0)
 ...I $$AINB(.B,.A) K X(K)
"RTN","ORWDXC",181,0)
 Q
"RTN","ORWDXC",182,0)
AINB(A,B) ;if array A is a subset of array B then return 1, else return 0
"RTN","ORWDXC",183,0)
 N I,RET
"RTN","ORWDXC",184,0)
 S RET=1
"RTN","ORWDXC",185,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I '$$XINA(A(I),.B) S RET=0 Q
"RTN","ORWDXC",186,0)
 Q RET
"RTN","ORWDXC",187,0)
XINA(X,A) ;if string X is an entry in array A then return 1, else return 0
"RTN","ORWDXC",188,0)
 N I,RET
"RTN","ORWDXC",189,0)
 S RET=0
"RTN","ORWDXC",190,0)
 S I=0 F  S I=$O(A(I)) Q:'I  I X=A(I) S RET=1 Q
"RTN","ORWDXC",191,0)
 Q RET
"RTN","ORWDXC",192,0)
REMDUPS ;similar to REMDUPS^ORCHECK
"RTN","ORWDXC",193,0)
 N IFN,CDL,I S IFN="NEW"
"RTN","ORWDXC",194,0)
 S CDL=0 F  S CDL=$O(ORCHECK(IFN,CDL)) Q:'CDL  D
"RTN","ORWDXC",195,0)
 . S I=0 F  S I=$O(ORCHECK(IFN,CDL,I)) Q:'I  D
"RTN","ORWDXC",196,0)
 . . S J=I F  S J=$O(ORCHECK(IFN,CDL,J)) Q:'J  I $G(ORCHECK(IFN,CDL,I))=$G(ORCHECK(IFN,CDL,J)) K ORCHECK(IFN,CDL,J) S ORCHECK=$G(ORCHECK)-1
"RTN","ORWDXC",197,0)
 Q
"RTN","ORWDXC",198,0)
OPOS(DFN) ;handles saving and removing order checks that should only be displayed once per cprs session
"RTN","ORWDXC",199,0)
 ; expects ORCHECK
"RTN","ORWDXC",200,0)
 ; sets these order checks into the "Once Per cprs Session" global ^TMP($J,"OC-OPOS",DFN)
"RTN","ORWDXC",201,0)
 N I,J,K
"RTN","ORWDXC",202,0)
 S I="" F  S I=$O(ORCHECK(I)) Q:'$L(I)  D
"RTN","ORWDXC",203,0)
 .S J=0 F  S J=$O(ORCHECK(I,J)) Q:'J  D
"RTN","ORWDXC",204,0)
 ..S K=0 F  S K=$O(ORCHECK(I,J,K)) Q:'K  D
"RTN","ORWDXC",205,0)
 ...Q:(ORCHECK(I,J,K)'["These checks will NOT be performed for this patient")
"RTN","ORWDXC",206,0)
 ...I $L(ORCHECK(I,J,K),"&")>1  I $D(^TMP($J,"OC-OPOS",DFN,$E($P(ORCHECK(I,J,K),"&",2),1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",207,0)
 ...I $D(^TMP($J,"OC-OPOS",DFN,$E(ORCHECK(I,J,K),1,225))) K ORCHECK(I,J,K) Q
"RTN","ORWDXC",208,0)
 ...I $L(ORCHECK(I,J,K),"&")>1 S ^TMP($J,"OC-OPOS",DFN,$E($P(ORCHECK(I,J,K),"&",2),1,225))="" Q
"RTN","ORWDXC",209,0)
 ...S ^TMP($J,"OC-OPOS",DFN,$E(ORCHECK(I,J,K),1,225))=""
"RTN","ORWDXC",210,0)
 Q
"VER")
8.0^22.0
"BLD",8055,6)
^292
**END**
**END**
