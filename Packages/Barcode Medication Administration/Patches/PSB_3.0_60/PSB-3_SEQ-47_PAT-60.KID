Released PSB*3*60 SEQ #47
Extracted from mail message
**KIDS**:PSB*3.0*60^

**INSTALL NAME**
PSB*3.0*60
"BLD",8603,0)
PSB*3.0*60^BAR CODE MED ADMIN^0^3110615^y
"BLD",8603,1,0)
^^10^10^3110131^
"BLD",8603,1,1,0)
This Patch Addresses 3 issues:
"BLD",8603,1,2,0)
 
"BLD",8603,1,3,0)
1.     The  error "<SUBSCRIPT>ADM+3^PSBCSUTX" occurs
"BLD",8603,1,4,0)
when selecting the BCMA Coversheet tab if the patient
"BLD",8603,1,5,0)
only has an IV Order and no Unit Dose Orders.
"BLD",8603,1,6,0)
2.     The BCMA Medication Variance Report does not paginate
"BLD",8603,1,7,0)
correctly.
"BLD",8603,1,8,0)
3.     The BCMA Medication Variance Report displays a variance
"BLD",8603,1,9,0)
when a patch is removed, even if the patch was given on
"BLD",8603,1,10,0)
time.
"BLD",8603,4,0)
^9.64PA^^
"BLD",8603,6.3)
12
"BLD",8603,"KRN",0)
^9.67PA^779.2^20
"BLD",8603,"KRN",.4,0)
.4
"BLD",8603,"KRN",.401,0)
.401
"BLD",8603,"KRN",.402,0)
.402
"BLD",8603,"KRN",.403,0)
.403
"BLD",8603,"KRN",.5,0)
.5
"BLD",8603,"KRN",.84,0)
.84
"BLD",8603,"KRN",3.6,0)
3.6
"BLD",8603,"KRN",3.8,0)
3.8
"BLD",8603,"KRN",9.2,0)
9.2
"BLD",8603,"KRN",9.8,0)
9.8
"BLD",8603,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",8603,"KRN",9.8,"NM",1,0)
PSBCSUTL^^0^B137031860
"BLD",8603,"KRN",9.8,"NM",2,0)
PSBOMV^^0^B49401054
"BLD",8603,"KRN",9.8,"NM","B","PSBCSUTL",1)

"BLD",8603,"KRN",9.8,"NM","B","PSBOMV",2)

"BLD",8603,"KRN",19,0)
19
"BLD",8603,"KRN",19.1,0)
19.1
"BLD",8603,"KRN",101,0)
101
"BLD",8603,"KRN",409.61,0)
409.61
"BLD",8603,"KRN",771,0)
771
"BLD",8603,"KRN",779.2,0)
779.2
"BLD",8603,"KRN",870,0)
870
"BLD",8603,"KRN",8989.51,0)
8989.51
"BLD",8603,"KRN",8989.52,0)
8989.52
"BLD",8603,"KRN",8994,0)
8994
"BLD",8603,"KRN","B",.4,.4)

"BLD",8603,"KRN","B",.401,.401)

"BLD",8603,"KRN","B",.402,.402)

"BLD",8603,"KRN","B",.403,.403)

"BLD",8603,"KRN","B",.5,.5)

"BLD",8603,"KRN","B",.84,.84)

"BLD",8603,"KRN","B",3.6,3.6)

"BLD",8603,"KRN","B",3.8,3.8)

"BLD",8603,"KRN","B",9.2,9.2)

"BLD",8603,"KRN","B",9.8,9.8)

"BLD",8603,"KRN","B",19,19)

"BLD",8603,"KRN","B",19.1,19.1)

"BLD",8603,"KRN","B",101,101)

"BLD",8603,"KRN","B",409.61,409.61)

"BLD",8603,"KRN","B",771,771)

"BLD",8603,"KRN","B",779.2,779.2)

"BLD",8603,"KRN","B",870,870)

"BLD",8603,"KRN","B",8989.51,8989.51)

"BLD",8603,"KRN","B",8989.52,8989.52)

"BLD",8603,"KRN","B",8994,8994)

"BLD",8603,"QUES",0)
^9.62^^
"BLD",8603,"REQB",0)
^9.611^1^1
"BLD",8603,"REQB",1,0)
PSB*3.0*50^2
"BLD",8603,"REQB","B","PSB*3.0*50",1)

"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
60^3110615
"PKG",550,22,1,"PAH",1,1,0)
^^10^10^3110615
"PKG",550,22,1,"PAH",1,1,1,0)
This Patch Addresses 3 issues:
"PKG",550,22,1,"PAH",1,1,2,0)
 
"PKG",550,22,1,"PAH",1,1,3,0)
1.     The  error "<SUBSCRIPT>ADM+3^PSBCSUTX" occurs
"PKG",550,22,1,"PAH",1,1,4,0)
when selecting the BCMA Coversheet tab if the patient
"PKG",550,22,1,"PAH",1,1,5,0)
only has an IV Order and no Unit Dose Orders.
"PKG",550,22,1,"PAH",1,1,6,0)
2.     The BCMA Medication Variance Report does not paginate
"PKG",550,22,1,"PAH",1,1,7,0)
correctly.
"PKG",550,22,1,"PAH",1,1,8,0)
3.     The BCMA Medication Variance Report displays a variance
"PKG",550,22,1,"PAH",1,1,9,0)
when a patch is removed, even if the patch was given on
"PKG",550,22,1,"PAH",1,1,10,0)
time.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSBCSUTL")
0^1^B137031860^B132423549
"RTN","PSBCSUTL",1,0)
PSBCSUTL ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES ;Mar 2004
"RTN","PSBCSUTL",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,13,38,32,50,60**;Mar 2004;Build 12
"RTN","PSBCSUTL",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBCSUTL",4,0)
 ;
"RTN","PSBCSUTL",5,0)
 ; Reference/IA
"RTN","PSBCSUTL",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBCSUTL",7,0)
 ; IN5^VADPT/10061
"RTN","PSBCSUTL",8,0)
 ; $$GET^XPAR/2263
"RTN","PSBCSUTL",9,0)
 ; ^%DTC/10000
"RTN","PSBCSUTL",10,0)
 ; $$FMADD^XLFDT/10103
"RTN","PSBCSUTL",11,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTL",12,0)
 ; EN1^GMVDCEXT/4251
"RTN","PSBCSUTL",13,0)
RPC(RESULTS,DFN,EXPWIN) ;
"RTN","PSBCSUTL",14,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBCSUTL",15,0)
 S PSBXWIN=$G(EXPWIN,24)
"RTN","PSBCSUTL",16,0)
 S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",17,0)
 N PSBCNT S PSBTRFL=0,PSBDFNX=DFN
"RTN","PSBCSUTL",18,0)
 D PAINCMT(DFN) ;;Correct Comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals. (PSB*3*50)
"RTN","PSBCSUTL",19,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBCSUTL",20,0)
 K ^TMP("PSB",$J,PSBTAB) S ^TMP("PSB",$J,PSBTAB,0)=1 D LIGHTS(PSBDFNX)
"RTN","PSBCSUTL",21,0)
 S ^TMP("PSB",$J,PSBTAB,0)=1,^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,PSBTAB,1)
"RTN","PSBCSUTL",22,0)
 Q:$P(^TMP("PSB",$J,PSBTAB,1),U,4)=-1
"RTN","PSBCSUTL",23,0)
 D NOW^%DTC S PSBNOW=+$E(%,1,10),PSBDT=$P(%,".",1)
"RTN","PSBCSUTL",24,0)
 ;set range
"RTN","PSBCSUTL",25,0)
 S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-PSBXWIN),PSBWEND=$$FMADD^XLFDT(PSBNOW,"",PSBXWIN)
"RTN","PSBCSUTL",26,0)
 S PSBTBEG=$$FMADD^XLFDT(PSBNOW,"",-12),PSBTEND=$$FMADD^XLFDT(PSBNOW,"",12)
"RTN","PSBCSUTL",27,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE"),PSBMHBCK=$$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B") I +PSBMHBCK=0 S PSBMHBCK=30
"RTN","PSBCSUTL",28,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM),PSBMHBCK=$$FMADD^XLFDT(%,-1*(PSBMHBCK))
"RTN","PSBCSUTL",29,0)
 ;use lst movemnt for API
"RTN","PSBCSUTL",30,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBCSUTL",31,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBCSUTL",32,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBCSUTL",33,0)
 S X1=$P(PSBNOW,"."),X2=-3 D C^%DTC
"RTN","PSBCSUTL",34,0)
 D EN^PSJBCMA(PSBDFNX,X,$S(PSBMHBCK<PSBWBEG:PSBMHBCK,PSBWBEG<PSBMHBCK:PSBWBEG,1:PSBMHBCK))
"RTN","PSBCSUTL",35,0)
 ;Devlop Outp
"RTN","PSBCSUTL",36,0)
 S PSBTBOUT=0
"RTN","PSBCSUTL",37,0)
 I ^TMP("PSJ",$J,1,0)>0 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:('PSBX)!(PSBTBOUT)  D
"RTN","PSBCSUTL",38,0)
 .S:(PSBTAB'="CVRSHT")&($G(^TMP("PSB",$J,"CVRSHT",2))>0) PSBTBOUT=1
"RTN","PSBCSUTL",39,0)
 .D CLEAN^PSBVT,PSJ^PSBVT(PSBX),NOW^%DTC
"RTN","PSBCSUTL",40,0)
 .Q:PSBONX["P"  Q:(PSBOSP<PSBWBEG)&'(PSBONX["V")  ;in rnge?
"RTN","PSBCSUTL",41,0)
 .S (PSBREC,PSBONTAB)=""
"RTN","PSBCSUTL",42,0)
 .S $P(PSBREC,U,1)=PSBDFN ;Dfn
"RTN","PSBCSUTL",43,0)
 .S $P(PSBREC,U,2)=PSBONX ;OrdX 
"RTN","PSBCSUTL",44,0)
 .S $P(PSBREC,U,3)=PSBON ;Ord#
"RTN","PSBCSUTL",45,0)
 .S $P(PSBREC,U,4)=PSBOTYP ;v/u/p
"RTN","PSBCSUTL",46,0)
 .S $P(PSBREC,U,5)=PSBSCHT ;Schtyp
"RTN","PSBCSUTL",47,0)
 .S $P(PSBREC,U,6)=PSBSCH ;Sch
"RTN","PSBCSUTL",48,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; slfmed
"RTN","PSBCSUTL",49,0)
 .S $P(PSBREC,U,8)=PSBOITX ;Drgnm
"RTN","PSBCSUTL",50,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ;Dose
"RTN","PSBCSUTL",51,0)
 .S $P(PSBREC,U,10)=PSBMR ;med route
"RTN","PSBCSUTL",52,0)
 .;Lst Gvn -AOIP xRef
"RTN","PSBCSUTL",53,0)
 .S (PSBCNT,PSBFLAG)=0,(Y,PSBSTUS)="" K PSBHSTA,PSBHSTAX
"RTN","PSBCSUTL",54,0)
 .F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",55,0)
 ..S:Y>0 $P(PSBREC,U,11)=Y
"RTN","PSBCSUTL",56,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",PSBDFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",57,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) S:$G(PSBSTUS)="" PSBSTUS="X" I (PSBSTUS'="N") S PSBFLAG=1,PSBHSTA(Y,$G(PSBSTUS))="ORIG"_U_X
"RTN","PSBCSUTL",58,0)
 ...D:PSBSTUS="N"
"RTN","PSBCSUTL",59,0)
 ....S ($P(PSBREC,U,11),Z)=""
"RTN","PSBCSUTL",60,0)
 ....F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",61,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",62,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",63,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R" D LAST^PSBVDLU1
"RTN","PSBCSUTL",64,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H" D LAST^PSBVDLU1
"RTN","PSBCSUTL",65,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M" D LAST^PSBVDLU1
"RTN","PSBCSUTL",66,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM" D LAST^PSBVDLU1
"RTN","PSBCSUTL",67,0)
 .....I PSBFLAG=1,'$D(PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))) S PSBHSTA($P(PSBREC,U,11),$G(PSBSTUS))=Z_U_X
"RTN","PSBCSUTL",68,0)
 .I $D(PSBHSTA) S $P(PSBREC,U,11)=$O(PSBHSTA(""),-1),PSBSTUS=$O(PSBHSTA($P(PSBREC,U,11),""),-1) M PSBHSTAX(PSBOIT)=PSBHSTA K PSBHSTA  ;last action date/time
"RTN","PSBCSUTL",69,0)
 .S $P(PSBREC,U,12)="" ;ien - below
"RTN","PSBCSUTL",70,0)
 .S $P(PSBREC,U,13)="" ;sttus - below
"RTN","PSBCSUTL",71,0)
 .S $P(PSBREC,U,14)="" ;admn dte - below
"RTN","PSBCSUTL",72,0)
 .S $P(PSBREC,U,15)=PSBOIT ;OI Pointer
"RTN","PSBCSUTL",73,0)
 .S $P(PSBREC,U,16)=PSBNJECT  ;njctble med route flag
"RTN","PSBCSUTL",74,0)
 .;Var dosg
"RTN","PSBCSUTL",75,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBCSUTL",76,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBCSUTL",77,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ;DosgFrm
"RTN","PSBCSUTL",78,0)
 .D PSJ1^PSBVT(PSBDFN,PSBONX)
"RTN","PSBCSUTL",79,0)
 .S PSBPB=$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,+$G(PSBIVPSH)),PSBLVIV=0
"RTN","PSBCSUTL",80,0)
 .Q:PSBPB&(PSBOSP<PSBWBEG)
"RTN","PSBCSUTL",81,0)
 .S:(PSBONX["V"&'PSBPB) PSBLVIV=1
"RTN","PSBCSUTL",82,0)
 .S $P(PSBREC,U,19)=$S(PSBVNI]"":PSBVNI,PSBVNI']"":"***") ;VerfNrsInts
"RTN","PSBCSUTL",83,0)
 .S $P(PSBREC,U,20)=PSBSTUS S:$P(PSBREC,U,11)="" $P(PSBREC,U,20)=""  ;LstActn
"RTN","PSBCSUTL",84,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBCSUTL",85,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBCSUTL",86,0)
 .S $P(PSBREC,U,25)=0 I $G(PSBTRFL),$P(PSBREC,U,11)]"",$P(PSBREC,U,11)'<$G(PSBNTDT),$P(PSBREC,U,11)'>$G(PSBTRDT) S $P(PSBREC,U,25)=1
"RTN","PSBCSUTL",87,0)
 .S $P(PSBREC,U,26)=PSBOSP  ;OrdStpDt/Tm
"RTN","PSBCSUTL",88,0)
 .S $P(PSBREC,U,27)=$$LASTG($P(PSBREC,U,1),$P(PSBREC,U,15))
"RTN","PSBCSUTL",89,0)
 .S $P(PSBREC,U,28)=$S((PSBONX["U")&('PSBPB):1,PSBPB:2,(PSBONX["V")&'PSBPB:3,1:"")
"RTN","PSBCSUTL",90,0)
 .;get all Admn(s) - DD info.
"RTN","PSBCSUTL",91,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBCSUTL",92,0)
 .;PSB*3*60 adds additional checks to ensure an expired order is within the coversheet time parameter and an "END" is only added to the temp global after an order is added
"RTN","PSBCSUTL",93,0)
 .I PSBLVIV D XFERBAGS^PSBCSUTY,LVIV^PSBCSUTY I $G(PSBEXPRD) S X1=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,X1)'="END"&(X1>1) ^TMP("PSB",$J,PSBTAB,X1+1)="END" Q  ;PSB*3*60
"RTN","PSBCSUTL",94,0)
 .D GETADMX^PSBCSUTY
"RTN","PSBCSUTL",95,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBCSUTL",96,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1  ;drug nactvt
"RTN","PSBCSUTL",97,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ;nactv
"RTN","PSBCSUTL",98,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBCSUTL",99,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4),$P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBCSUTL",100,0)
 .;OnCa O PRN
"RTN","PSBCSUTL",101,0)
 .I ("^O^OC^P^"[(U_PSBSCHT_U))!(PSBLVIV) D  S ($P(PSBREC,U,12),$P(PSBREC,U,14))=""  Q
"RTN","PSBCSUTL",102,0)
 ..S (PSBIENX,PSBGOT1)="",PSBADMTM="" F  S PSBADMTM=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM)) Q:(PSBADMTM="")  D
"RTN","PSBCSUTL",103,0)
 ...Q:(PSBADMTM<PSBMHBCK)&'PSBLVIV
"RTN","PSBCSUTL",104,0)
 ...F  S PSBIENX=$O(^PSB(53.79,"AORDX",PSBDFNX,PSBONX,PSBADMTM,PSBIENX)) Q:PSBIENX=""  D
"RTN","PSBCSUTL",105,0)
 ....S $P(PSBREC,U,12)=PSBIENX,$P(PSBREC,U,14)=PSBADMTM,$P(PSBREC,U,23)=$$GET1^DIQ(53.79,PSBIENX_",","IV UNIQUE ID")
"RTN","PSBCSUTL",106,0)
 ....S PSBQRR=1 I PSBWBEG<PSBOSP D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBADMTM,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1 ;PSB*3*60
"RTN","PSBCSUTL",107,0)
 ..I ('+PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",108,0)
 ..I ('+PSBGOT1)&($D(PSBADMX(PSBONX)))&(PSBWBEG<PSBOSP) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") ;PSB*3*60
"RTN","PSBCSUTL",109,0)
 ..S PSBGLBX=$O(^TMP("PSB",$J,PSBTAB,""),-1) S:^TMP("PSB",$J,PSBTAB,PSBGLBX)'="END"&(PSBGLBX>1) ^TMP("PSB",$J,PSBTAB,PSBGLBX+1)="END" ;PSB*3*60
"RTN","PSBCSUTL",110,0)
 .;cont - proces AdmnTm
"RTN","PSBCSUTL",111,0)
 .S (PSBYES,PSBODD,PSBYTF)=0 S:$$PSBDCHK1^PSBVT1(PSBSCH) PSBYES=1
"RTN","PSBCSUTL",112,0)
 .I PSBYES,PSBADST="" Q
"RTN","PSBCSUTL",113,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1,PSBYTF=1
"RTN","PSBCSUTL",114,0)
 .I PSBSCHT="C",PSBYTF="1",PSBADST="" Q
"RTN","PSBCSUTL",115,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBCSUTL",116,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBCSUTL",117,0)
 .I PSBFREQ="D" S PSBFREQ=""
"RTN","PSBCSUTL",118,0)
 .S:PSBLVIV PSBYES=1
"RTN","PSBCSUTL",119,0)
 .I 'PSBYES,PSBFREQ<1 Q
"RTN","PSBCSUTL",120,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1(PSBTAB) Q
"RTN","PSBCSUTL",121,0)
 .I +PSBFREQ>0 I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBCSUTL",122,0)
 .I PSBODD,PSBADST'="" Q
"RTN","PSBCSUTL",123,0)
 .S PSBDTX=PSBWBEG\1,PSBGOT1=0
"RTN","PSBCSUTL",124,0)
 .F PSBXX=1:1:2 D  S PSBDTX=$$FMADD^XLFDT(PSBDTX,"",24)  ;incrmnt 1 day!
"RTN","PSBCSUTL",125,0)
 ..F PSBY=1:1:$L(PSBADST,"-") Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBCSUTL",126,0)
 ...S PSB=+(PSBDTX_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",127,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",128,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",129,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",130,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",131,0)
 ...S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBCSUTL",132,0)
 ...I (PSB'<PSBWBEG)&(PSB'>PSBWEND) D  ;wndow?
"RTN","PSBCSUTL",133,0)
 ....D:(PSB'<PSBOST)&(PSB<PSBOSP)    ;actv?
"RTN","PSBCSUTL",134,0)
 .....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ;dt?
"RTN","PSBCSUTL",135,0)
 ......D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"CVRSHT") S PSBGOT1=1
"RTN","PSBCSUTL",136,0)
 .I ('PSBGOT1)&(PSBOSP'<PSBWBEG) D ADD^PSBVDLU1(PSBREC,PSBOTXT,+(PSBWEND\1_"."_$P(PSBADST,"-")),PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTL",137,0)
 .K PSBSTUS
"RTN","PSBCSUTL",138,0)
 D EN^PSBVDLPA
"RTN","PSBCSUTL",139,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S PSBI1=$O(^TMP("PSB",$J,PSBTAB,""),-1) I ^TMP("PSB",$J,PSBTAB,PSBI1)'="END" S ^TMP("PSB",$J,PSBTAB,PSBI1+1)="END"
"RTN","PSBCSUTL",140,0)
 S ^TMP("PSB",$J,PSBTAB,0)=$O(^TMP("PSB",$J,PSBTAB,""),-1)
"RTN","PSBCSUTL",141,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))']"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="-1^No orders To display on Coversheet"
"RTN","PSBCSUTL",142,0)
 I $G(^TMP("PSB",$J,PSBTAB,2))]"" S $P(^TMP("PSB",$J,PSBTAB,1),U,4)="1^COVERSHEET DATA FOLLOWS" D ADD^PSBCSUTX
"RTN","PSBCSUTL",143,0)
 D CLEAN
"RTN","PSBCSUTL",144,0)
 Q
"RTN","PSBCSUTL",145,0)
LASTG(PSBPATPT,PSBOIPT) ;LstGvn-(inpt: DFN,OrItm IEN)
"RTN","PSBCSUTL",146,0)
 K PSBHSTG S Y="",LASTG="" F XZ=1:1:20 S Y=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y),-1),(PSBCNT,PSBFLAG)=0 Q:Y=""  D
"RTN","PSBCSUTL",147,0)
 .S:Y>0 LASTG="",X="" F  S X=$O(^PSB(53.79,"AOIP",PSBPATPT,PSBOIPT,Y,X),-1) Q:X=""  D
"RTN","PSBCSUTL",148,0)
 ..S PSBSTX=$P(^PSB(53.79,X,0),U,9) S:PSBSTX']"" PSBHSTG(Y)=-1 I PSBSTX="G"  S PSBHSTG(Y)="G"
"RTN","PSBCSUTL",149,0)
 ..Q:PSBSTX="N"
"RTN","PSBCSUTL",150,0)
 ..D:(PSBSTX'="G")
"RTN","PSBCSUTL",151,0)
 ...S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBCSUTL",152,0)
 ....I (PSBDATA["Set to 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",153,0)
 ....I (PSBDATA["STATUS 'GIVEN'") S PSBCNT=PSBCNT+1
"RTN","PSBCSUTL",154,0)
 ....I PSBCNT#2=0,PSBDATA'["'GIVEN'" Q
"RTN","PSBCSUTL",155,0)
 ....I '$D(PSBHSTG($P(PSBDATA,U))) S PSBFLAG=1,PSBHSTG($P(PSBDATA,U))=""
"RTN","PSBCSUTL",156,0)
 I $D(PSBHSTG) S LASTG="" F  S LASTG=$O(PSBHSTG(LASTG),-1) Q:+LASTG=0  Q:PSBHSTG(LASTG)="G"  I PSBHSTG(LASTG)=-1 S LASTG="" Q
"RTN","PSBCSUTL",157,0)
 Q LASTG
"RTN","PSBCSUTL",158,0)
PAINCMT(DFN) ;;Add comment if Pain Score entered in BCMA was marked "Entered in Error" in Vitals.
"RTN","PSBCSUTL",159,0)
 ;;This will run through all the patients appointments, check their comments to see if they had a Pain Vital entered  through BCMA, and check if that Vital was marked "Entered in Error."
"RTN","PSBCSUTL",160,0)
 Q:'$D(^DPT(DFN,0))
"RTN","PSBCSUTL",161,0)
 N PSBCMT,PSBGMR,PSBCMTGLB,PSBIEN,PSBCMTM,PSBVITM,PSBTMDF,PSBBDT,PSBEDT,PSBEFTM,PSBCMFL,PSBEXTM,PSBERFL,PSBPNSC,PSBNOW,PSBDFN,PSBPRNDT,PSBSTRTDT,PSBMDHST,PSBEFFL,PSBCOMMENT,X,X1,X2
"RTN","PSBCSUTL",162,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",163,0)
 D NOW^%DTC S PSBEDT=%
"RTN","PSBCSUTL",164,0)
 S PSBMDHST=+($$GET^XPAR("ALL","PSB MED HIST DAYS BACK",,"B")) S:+$G(PSBMDHST)=0 PSBMDHST=30
"RTN","PSBCSUTL",165,0)
 S X1=$P(PSBEDT,"."),X2=-(PSBMDHST) D C^%DTC S PSBMDHST=X
"RTN","PSBCSUTL",166,0)
 S PSBSTRTDT=$S($G(PSBSTRT)]0:PSBSTRT,1:PSBMDHST)
"RTN","PSBCSUTL",167,0)
 S PSBPRNDT=PSBSTRTDT F  S PSBPRNDT=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT)) Q:'PSBPRNDT  D
"RTN","PSBCSUTL",168,0)
 .S PSBIEN=0 F  S PSBIEN=$O(^PSB(53.79,"APRN",DFN,PSBPRNDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBCSUTL",169,0)
 ..S PSBCMT=0 F  S PSBCMT=$O(^PSB(53.79,PSBIEN,.3,PSBCMT)) Q:'PSBCMT  S PSBCMTGLB=^PSB(53.79,PSBIEN,.3,PSBCMT,0) D
"RTN","PSBCSUTL",170,0)
 ...I $P($G(PSBCMTGLB),U)["Pain Score of" D
"RTN","PSBCSUTL",171,0)
 ....I $E($P($G(PSBCMTGLB),U),1,14)="*Pain Score of" S PSBCMFL=""
"RTN","PSBCSUTL",172,0)
 ....I $E($P($G(PSBCMTGLB),U),1,15)="**Pain Score of" S PSBEFFL=""
"RTN","PSBCSUTL",173,0)
 ....S PSBCMTM=$P($G(PSBCMTGLB),U,3)
"RTN","PSBCSUTL",174,0)
 ....S PSBBDT=$E(PSBCMTM,1,12)
"RTN","PSBCSUTL",175,0)
 ....S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",176,0)
 ....I '$D(^TMP("PSBGMV",$J)) D EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",177,0)
 ....S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",178,0)
 .....S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",179,0)
 .....S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBCMTM,2)
"RTN","PSBCSUTL",180,0)
 .....I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3) D
"RTN","PSBCSUTL",181,0)
 ......I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL=""
"RTN","PSBCSUTL",182,0)
 ..I $D(PSBERFL),'$D(PSBCMFL) S PSBCOMMENT="*Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D COMMENT^PSBML(PSBIEN,PSBCOMMENT)
"RTN","PSBCSUTL",183,0)
 ..K PSBCMFL,PSBERFL
"RTN","PSBCSUTL",184,0)
 ..S PSBEFTM=$P($G(^PSB(53.79,PSBIEN,.2)),U,4) Q:PSBEFTM=""
"RTN","PSBCSUTL",185,0)
 ..S PSBBDT=$E(PSBEFTM,1,12)
"RTN","PSBCSUTL",186,0)
 ..S PSBEXTM=$$FMTE^XLFDT(PSBBDT,"5Z")
"RTN","PSBCSUTL",187,0)
 ..D:'$D(^TMP("PSBGMV",$J)) EN1^GMVDCEXT("^TMP(""PSBGMV"",$J)",DFN,2,,1,PSBSTRTDT,PSBEDT,,1)
"RTN","PSBCSUTL",188,0)
 ..S PSBGMR=0 F  S PSBGMR=$O(^TMP("PSBGMV",$J,PSBGMR)) Q:PSBGMR=""  I $P(^TMP("PSBGMV",$J,PSBGMR),U,4)="PN" D
"RTN","PSBCSUTL",189,0)
 ...S PSBVITM=$P(^TMP("PSBGMV",$J,PSBGMR),U,5)
"RTN","PSBCSUTL",190,0)
 ...S PSBTMDF=$$FMDIFF^XLFDT(PSBVITM,PSBEFTM,2)
"RTN","PSBCSUTL",191,0)
 ...I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3)  D
"RTN","PSBCSUTL",192,0)
 ....I $P(^TMP("PSBGMV",$J,PSBGMR),U,9)=1 S PSBPNSC=$P(^TMP("PSBGMV",$J,PSBGMR),U,8),PSBERFL=""
"RTN","PSBCSUTL",193,0)
 ..I $D(PSBERFL),'$D(PSBEFFL) S PSBCOMMENT="**Pain Score of "_PSBPNSC_" entered in Vitals via BCMA at "_PSBEXTM_" may have been marked 'Entered in Error'. See Vitals Package for an updated Score." D COMMENT^PSBML(PSBIEN,PSBCOMMENT)
"RTN","PSBCSUTL",194,0)
 ..K PSBERFL,PSBEFFL
"RTN","PSBCSUTL",195,0)
 K ^TMP("PSBGMV",$J)
"RTN","PSBCSUTL",196,0)
 Q
"RTN","PSBCSUTL",197,0)
LIGHTS(PSBDFN) ;
"RTN","PSBCSUTL",198,0)
 D RPC^PSBVDLTB(,PSBDFN,"NO TAB",) S PSBTAB="CVRSHT"
"RTN","PSBCSUTL",199,0)
 M ^TMP("PSB",$J,PSBTAB,1)=^TMP("PSB",$J,"NO TAB",1) K ^TMP("PSB",$J,"NO TAB")
"RTN","PSBCSUTL",200,0)
 Q
"RTN","PSBCSUTL",201,0)
CLEAN ;
"RTN","PSBCSUTL",202,0)
 D CLEAN^PSBVT
"RTN","PSBCSUTL",203,0)
 K PSBACT,PSBACTBY,PSBACTDT,PSBACTPT,PSBADDS,PSBBAGID,PSBCHDT,PSBCHKV,PSBCNT1,PSBCNT2,PSBDDS,PSBDFNX,PSBWEND
"RTN","PSBCSUTL",204,0)
 K PSBDT,PSBFLAG,PSBHSTAX,PSBI1,PSBIEN,PSBIENX,PSBLSTS,PSBMAUD,PSBMVTYP,PSBMWC,PSBNOW,PSBNTDT,PSBONMBR,PSBY,PSBXX
"RTN","PSBCSUTL",205,0)
 K PSBONXS,PSBORREC,PSBPDT,PSBPRNRE,PSBPTTR,PSBQR,PSBRDOW,PSBREC,PSBRECHD,PSBSCHBR,PSBSCHTM,PSBSOLS,PSBTAB,PSBADMTM,PSBDTX
"RTN","PSBCSUTL",206,0)
 K PSBTBOUT,PSBTRDT,PSBTRFL,PSBTRTYP,PSBUID,PSBUIDS,PSBX,PSBXIEN,PSBX2,PSBYEA,PSBYEA1,PSBYTF,PSBYES,VAIP,PSBWADM,PSBWBEG
"RTN","PSBCSUTL",207,0)
 K PSBXREC,PSBGOT1,PSBCDT,PSBQUIT,PSBUSED,PSBLST4X,PSBADMX,PSBI2,PSBXXX,PSBI,PSBPB,PSBSHWTB,PSBONTAB,PSBDONE,^TMP("PSJ",$J)
"RTN","PSBCSUTL",208,0)
 K PSBNXTDU,LASTG,LSTTIME,PSBMHBCK,PSBHSTG,PSBNXTDT,NEXTADM,PSBLVIV
"RTN","PSBCSUTL",209,0)
 Q
"RTN","PSBOMV")
0^2^B49401054^B41185550
"RTN","PSBOMV",1,0)
PSBOMV ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;Mar 2004
"RTN","PSBOMV",2,0)
 ;;3.0;BAR CODE MED ADMIN;**60**;Mar 2004;Build 12
"RTN","PSBOMV",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBOMV",4,0)
 ;
"RTN","PSBOMV",5,0)
 ; Reference/IA
"RTN","PSBOMV",6,0)
 ; ^DPT/10035
"RTN","PSBOMV",7,0)
 ; ^NURSF(211.4/1409
"RTN","PSBOMV",8,0)
 ;
"RTN","PSBOMV",9,0)
EN ;
"RTN","PSBOMV",10,0)
 N CNT,PSBHDR,PSBPT,PSBINDX,DFN,PSBY,PSBSORT,PSBPRINT,PSBDT,PSBEV,PSBLOG,PSBPRCX,PSBRB,PSBSTOP,PSBSTRT,PSBTIME,PSBWLF,PSBWRD,PSBWRDA,PSBX,PSBY,PSBXX
"RTN","PSBOMV",11,0)
 ;
"RTN","PSBOMV",12,0)
 K ^TMP("PSBO",$J)
"RTN","PSBOMV",13,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOMV",14,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOMV",15,0)
 S CNT=0,PSBPRINT=$P($G(PSBRPT(.1)),U)
"RTN","PSBOMV",16,0)
 I PSBPRINT="P" S PSBPT=$P(PSBRPT(.1),U,2)
"RTN","PSBOMV",17,0)
 I PSBPRINT="W" S PSBSORT=$P($G(PSBRPT(.1)),U,5),PSBWRD=$P(PSBRPT(.1),U,3) Q:'PSBWRD  D WARD^NURSUT5("L^"_PSBWRD,.PSBWRDA)
"RTN","PSBOMV",18,0)
 ;
"RTN","PSBOMV",19,0)
RANGE ;Locate data between date range.
"RTN","PSBOMV",20,0)
 N PSBTMDF
"RTN","PSBOMV",21,0)
 S PSBX=PSBSTRT F  S PSBX=$O(^PSB(53.78,"ADT",PSBX)) Q:'PSBX!(PSBX>PSBSTOP)  D
"RTN","PSBOMV",22,0)
 .F PSBY=0:0 S PSBY=$O(^PSB(53.78,"ADT",PSBX,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",23,0)
 ..S DFN=+^PSB(53.78,PSBY,0),PSBWLF=$P($G(^(0)),U,9),PSBTIME=$P($G(^(0)),U,4),PSBLOG=$P($G(^(0)),U,8)
"RTN","PSBOMV",24,0)
CHECK ..;Ward IEN must exist in Ward Field # 9.
"RTN","PSBOMV",25,0)
 ..Q:'$G(PSBWLF)
"RTN","PSBOMV",26,0)
 ..Q:'$G(PSBLOG)
"RTN","PSBOMV",27,0)
 ..;PSB*3*60 adds code to allow a variance equal to system variable DILOCKTM when checking for removal of a patch
"RTN","PSBOMV",28,0)
 ..S PSBTMDF=$$FMDIFF^XLFDT($P($G(^PSB(53.79,PSBLOG,0)),U,6),$G(PSBTIME),2) ;PSB*3*60
"RTN","PSBOMV",29,0)
 ..I PSBTMDF>=-($S($G(DILOCKTM)>0:DILOCKTM,1:3)),PSBTMDF<=$S($G(DILOCKTM)>0:DILOCKTM,1:3),$P($G(^PSB(53.79,PSBLOG,0)),U,9)="RM" Q  ;PSB*3*60
"RTN","PSBOMV",30,0)
 ..;Quit if Ward IEN is not in Nurse Location file.
"RTN","PSBOMV",31,0)
 ..I PSBPRINT="W",'$O(^NURSF(211.4,"C",PSBWLF,PSBWRD,0)) Q
"RTN","PSBOMV",32,0)
 ..;Compare date/time and Quit if order status set to Remove.
"RTN","PSBOMV",33,0)
 ..;
"RTN","PSBOMV",34,0)
BUILD ..I $G(PSBSORT)'="B" S ^TMP("PSBO",$J,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",35,0)
 ..I PSBPRINT="P",DFN=PSBPT S ^TMP("PSBO",$J,"B",$P(^DPT(DFN,0),U),DFN)="" Q
"RTN","PSBOMV",36,0)
 ..S ^TMP("PSBO",$J,DFN,0)=^DPT(DFN,0)
"RTN","PSBOMV",37,0)
 ..I PSBPRINT="W" D SORTING
"RTN","PSBOMV",38,0)
 ;
"RTN","PSBOMV",39,0)
BYWDPT ;Print by Ward and Sort by Patient.
"RTN","PSBOMV",40,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)'="B" D
"RTN","PSBOMV",41,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",42,0)
 .W $$WRDHDR()
"RTN","PSBOMV",43,0)
 .S PSBINDX=""
"RTN","PSBOMV",44,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",45,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",46,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",47,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",48,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",49,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",50,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",51,0)
 .....W !,PSBRB
"RTN","PSBOMV",52,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",53,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",54,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",55,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",56,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",57,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",58,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",59,0)
 .....W !?52
"RTN","PSBOMV",60,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",61,0)
 ;
"RTN","PSBOMV",62,0)
BYWDRB ;Print by Ward and Sort by Room and Bed.
"RTN","PSBOMV",63,0)
 I $G(PSBPRINT)="W",$G(PSBSORT)="B" D
"RTN","PSBOMV",64,0)
 .;Print report by the selected ward name.
"RTN","PSBOMV",65,0)
 .W $$WRDHDR()
"RTN","PSBOMV",66,0)
 .S PSBINDX=""
"RTN","PSBOMV",67,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",68,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",69,0)
 ...W:$Y>(IOSL-10) $$WRDHDR()
"RTN","PSBOMV",70,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",71,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",72,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",73,0)
 .....S PSBRB=$$GET1^DIQ(53.78,PSBY_",",.02)
"RTN","PSBOMV",74,0)
 .....W !,PSBRB
"RTN","PSBOMV",75,0)
 .....W ?20,$P(^TMP("PSBO",$J,DFN,0),U,1)
"RTN","PSBOMV",76,0)
 .....W ?48,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",77,0)
 .....W ?75,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",78,0)
 .....W ?95,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",79,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",80,0)
 .....W ?102,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",81,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",82,0)
 .....W !?52
"RTN","PSBOMV",83,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",84,0)
 ;
"RTN","PSBOMV",85,0)
BYDFN ;Print by Patient.
"RTN","PSBOMV",86,0)
 D:$G(PSBPRINT)="P"
"RTN","PSBOMV",87,0)
 .W $$PTHDR()
"RTN","PSBOMV",88,0)
 .S PSBINDX=""
"RTN","PSBOMV",89,0)
 .F  S PSBINDX=$O(^TMP("PSBO",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOMV",90,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOMV",91,0)
 ...W:$Y>(IOSL-10) $$PTHDR()
"RTN","PSBOMV",92,0)
 ...F PSBDT=0:0 S PSBDT=$O(^TMP("PSBO",$J,DFN,PSBDT)) Q:'PSBDT  D
"RTN","PSBOMV",93,0)
 ....F PSBY=0:0 S PSBY=$O(^TMP("PSBO",$J,DFN,PSBDT,PSBY)) Q:'PSBY  D
"RTN","PSBOMV",94,0)
 .....D EVENTS  ;Set Total Number of Events
"RTN","PSBOMV",95,0)
 .....W !,$$GET1^DIQ(53.78,PSBY_",",.04)
"RTN","PSBOMV",96,0)
 .....W ?23,$$GET1^DIQ(53.78,PSBY_",",.05)
"RTN","PSBOMV",97,0)
 .....W ?43,$$GET1^DIQ(53.78,PSBY_",",.06)
"RTN","PSBOMV",98,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",",.07)
"RTN","PSBOMV",99,0)
 .....W ?50,$$GET1^DIQ(53.78,PSBY_",","MED LOG PTR:ADMINISTRATION MEDICATION")
"RTN","PSBOMV",100,0)
 .....D VCOM ;Print Ward and Comments from Med Log.
"RTN","PSBOMV",101,0)
 .W !!  D EVEPRNT
"RTN","PSBOMV",102,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOMV",103,0)
 Q
"RTN","PSBOMV",104,0)
 ;
"RTN","PSBOMV",105,0)
WRDHDR() ;
"RTN","PSBOMV",106,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG"
"RTN","PSBOMV",107,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR)
"RTN","PSBOMV",108,0)
 W !,"Rm-Bed",?20,"Patient Name",?48,"Event Date/Time",?75,"Event",?95,"Var",?102,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",109,0)
 Q ""
"RTN","PSBOMV",110,0)
 ;
"RTN","PSBOMV",111,0)
PTHDR() ;
"RTN","PSBOMV",112,0)
 S PSBHDR(1)="MEDICATION VARIANCE LOG"
"RTN","PSBOMV",113,0)
 D PT^PSBOHDR(PSBDFN,.PSBHDR)
"RTN","PSBOMV",114,0)
 W !,"Event Date/Time",?23,"Event",?43,"Var",?50,"Medication",!,$TR($J("",IOM)," ","-")
"RTN","PSBOMV",115,0)
 Q ""
"RTN","PSBOMV",116,0)
 ;
"RTN","PSBOMV",117,0)
VCOM ;Print Ward and Comments from Med Log on Variance Report.
"RTN","PSBOMV",118,0)
 N PSBCOM,PSBML,Y
"RTN","PSBOMV",119,0)
 Q:'$P($G(^PSB(53.78,PSBY,0)),"^",8)  S PSBML=$P(^(0),"^",8)
"RTN","PSBOMV",120,0)
 I $P(PSBRPT(.1),U)="P" W !,?23,"Ward:      ",?34 D
"RTN","PSBOMV",121,0)
 .I $P($G(^PSB(53.79,PSBML,0)),U,2)=""  W "<No Ward>" Q
"RTN","PSBOMV",122,0)
 .W $P($G(^PSB(53.79,PSBML,0)),U,2)
"RTN","PSBOMV",123,0)
 W !,?23,"Comments:  ",?34 I '$O(^PSB(53.79,PSBML,.3,0))  W "<No Comments>" I $Y>(IOSL-10) D  Q  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",124,0)
 .I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",125,0)
 .I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",126,0)
 F PSBCOM=0:0 S PSBCOM=$O(^PSB(53.79,PSBML,.3,PSBCOM)) Q:'PSBCOM  D
"RTN","PSBOMV",127,0)
 .W:$X>34 !?34
"RTN","PSBOMV",128,0)
 .S Y=$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,3)+.0000001
"RTN","PSBOMV",129,0)
 .W $E(Y,4,5),"/",$E(Y,6,7),"/",$E(Y,2,3)," ",$E(Y,9,10),":",$E(Y,11,12),?50,"By: ",$$GET1^DIQ(53.793,PSBCOM_","_PSBML_",","ENTERED BY:INITIAL"),$$WRAP^PSBO(60,75,$P(^PSB(53.79,PSBML,.3,PSBCOM,0),U,1))
"RTN","PSBOMV",130,0)
 .I $Y>(IOSL-10) D  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",131,0)
 ..I $G(PSBPRINT)="P" W $$PTFTR^PSBOHDR(),!,$$PTHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",132,0)
 ..I $G(PSBPRINT)="W" W !,$$WRDHDR()  ;correct page breaks, PSB*3*60
"RTN","PSBOMV",133,0)
 Q
"RTN","PSBOMV",134,0)
 ;
"RTN","PSBOMV",135,0)
EVENTS ;Record total number of events.
"RTN","PSBOMV",136,0)
 S PSBEV=$P($G(^PSB(53.78,PSBY,0)),U,5) Q:'$G(PSBEV)
"RTN","PSBOMV",137,0)
 S ^TMP("PSBO",$J,"EVENTS",PSBEV,0)=$P($G(^TMP("PSBO",$J,"EVENTS",PSBEV,0)),U)+1
"RTN","PSBOMV",138,0)
 S CNT=CNT+1,^TMP("PSBO",$J,"EVENTSTOT",0)=CNT
"RTN","PSBOMV",139,0)
 Q
"RTN","PSBOMV",140,0)
EVEPRNT ;Display Total and Percentage of Events.
"RTN","PSBOMV",141,0)
 ;
"RTN","PSBOMV",142,0)
 Q:'$D(^TMP("PSBO",$J,"EVENTSTOT"))  ;Quit if there are no events
"RTN","PSBOMV",143,0)
 W !,"Total Number of Events for the reporting period is: "_$P(^TMP("PSBO",$J,"EVENTSTOT",0),U)_".",!
"RTN","PSBOMV",144,0)
 F PSBXX=0:0 S PSBXX=$O(^TMP("PSBO",$J,"EVENTS",PSBXX)) Q:'PSBXX  D
"RTN","PSBOMV",145,0)
 .W !,"Total number of "_$$EXTERNAL^DILFD(53.78,.05,"",PSBXX)_" events is "_$P($G(^TMP("PSBO",$J,"EVENTS",PSBXX,0)),U)_"."
"RTN","PSBOMV",146,0)
 .S PSBPRCX=$E($FN($P(^TMP("PSBO",$J,"EVENTS",PSBXX,0),U)/$P(^TMP("PSBO",$J,"EVENTSTOT",0),U),"",2),3,4)
"RTN","PSBOMV",147,0)
 .W !,"Percentage of Total Events: "_$S(PSBPRCX="00":"100",1:PSBPRCX)_"%",!
"RTN","PSBOMV",148,0)
 Q
"RTN","PSBOMV",149,0)
 ;
"RTN","PSBOMV",150,0)
SORTING ;Sort by Patient or Room and Bed Information
"RTN","PSBOMV",151,0)
 ;
"RTN","PSBOMV",152,0)
 I $G(PSBSORT)="P"!($G(PSBSORT)="") S PSBINDX=$P(^DPT(DFN,0),U),^TMP("PSBO",$J,"B",PSBINDX,DFN)="" Q
"RTN","PSBOMV",153,0)
 I $G(PSBSORT)="B" S PSBINDX=$P($G(^PSB(53.78,+PSBY,0)),U,2) S:PSBINDX="" PSBINDX="** NO ROOM/BED **" S ^TMP("PSBO",$J,"B",PSBINDX,DFN,PSBX,PSBY)=""
"RTN","PSBOMV",154,0)
 Q 
"VER")
8.0^22.0
"BLD",8603,6)
^47
**END**
**END**
