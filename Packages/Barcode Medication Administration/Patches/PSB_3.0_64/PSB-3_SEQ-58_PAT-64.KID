Released PSB*3*64 SEQ #58
Extracted from mail message
**KIDS**:PSB*3.0*64^

**INSTALL NAME**
PSB*3.0*64
"BLD",8751,0)
PSB*3.0*64^BAR CODE MED ADMIN^0^3130321^y
"BLD",8751,1,0)
^^10^10^3130321^
"BLD",8751,1,1,0)
This Patch Addresses 3 issues:
"BLD",8751,1,2,0)
 
"BLD",8751,1,3,0)
1.  An order with an Unknown Action status is unavailable
"BLD",8751,1,4,0)
    when using the Edit Med Log option if another user runs
"BLD",8751,1,5,0)
    the BCMA Medication Administration History (MAH) report.
"BLD",8751,1,6,0)
2.  A fatal error occurs when using the Unable to Scan function
"BLD",8751,1,7,0)
    in BCMA and then scanning another medication. 
"BLD",8751,1,8,0)
3.  A fatal error occurs when clicking on the BCMA Coversheet if 
"BLD",8751,1,9,0)
    a patient's only current order is an IV Piggyback which has a 
"BLD",8751,1,10,0)
    day of the week schedule.
"BLD",8751,4,0)
^9.64PA^^
"BLD",8751,6.3)
14
"BLD",8751,"ABPKG")
n
"BLD",8751,"KRN",0)
^9.67PA^779.2^20
"BLD",8751,"KRN",.4,0)
.4
"BLD",8751,"KRN",.401,0)
.401
"BLD",8751,"KRN",.402,0)
.402
"BLD",8751,"KRN",.403,0)
.403
"BLD",8751,"KRN",.5,0)
.5
"BLD",8751,"KRN",.84,0)
.84
"BLD",8751,"KRN",3.6,0)
3.6
"BLD",8751,"KRN",3.8,0)
3.8
"BLD",8751,"KRN",9.2,0)
9.2
"BLD",8751,"KRN",9.8,0)
9.8
"BLD",8751,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",8751,"KRN",9.8,"NM",1,0)
PSBOMH1^^0^B83153329
"BLD",8751,"KRN",9.8,"NM",2,0)
PSBCSUTY^^0^B43766281
"BLD",8751,"KRN",9.8,"NM",3,0)
PSBVDLU3^^0^B91879754
"BLD",8751,"KRN",9.8,"NM","B","PSBCSUTY",2)

"BLD",8751,"KRN",9.8,"NM","B","PSBOMH1",1)

"BLD",8751,"KRN",9.8,"NM","B","PSBVDLU3",3)

"BLD",8751,"KRN",19,0)
19
"BLD",8751,"KRN",19.1,0)
19.1
"BLD",8751,"KRN",101,0)
101
"BLD",8751,"KRN",409.61,0)
409.61
"BLD",8751,"KRN",771,0)
771
"BLD",8751,"KRN",779.2,0)
779.2
"BLD",8751,"KRN",870,0)
870
"BLD",8751,"KRN",8989.51,0)
8989.51
"BLD",8751,"KRN",8989.52,0)
8989.52
"BLD",8751,"KRN",8994,0)
8994
"BLD",8751,"KRN","B",.4,.4)

"BLD",8751,"KRN","B",.401,.401)

"BLD",8751,"KRN","B",.402,.402)

"BLD",8751,"KRN","B",.403,.403)

"BLD",8751,"KRN","B",.5,.5)

"BLD",8751,"KRN","B",.84,.84)

"BLD",8751,"KRN","B",3.6,3.6)

"BLD",8751,"KRN","B",3.8,3.8)

"BLD",8751,"KRN","B",9.2,9.2)

"BLD",8751,"KRN","B",9.8,9.8)

"BLD",8751,"KRN","B",19,19)

"BLD",8751,"KRN","B",19.1,19.1)

"BLD",8751,"KRN","B",101,101)

"BLD",8751,"KRN","B",409.61,409.61)

"BLD",8751,"KRN","B",771,771)

"BLD",8751,"KRN","B",779.2,779.2)

"BLD",8751,"KRN","B",870,870)

"BLD",8751,"KRN","B",8989.51,8989.51)

"BLD",8751,"KRN","B",8989.52,8989.52)

"BLD",8751,"KRN","B",8994,8994)

"BLD",8751,"QUES",0)
^9.62^^
"BLD",8751,"REQB",0)
^9.611^3^2
"BLD",8751,"REQB",2,0)
PSB*3.0*67^2
"BLD",8751,"REQB",3,0)
PSB*3.0*32^2
"BLD",8751,"REQB","B","PSB*3.0*32",3)

"BLD",8751,"REQB","B","PSB*3.0*67",2)

"MBREQ")
0
"PKG",550,-1)
1^1
"PKG",550,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",550,20,0)
^9.402P^^
"PKG",550,22,0)
^9.49I^1^1
"PKG",550,22,1,0)
3.0^3040224^3040311^66481
"PKG",550,22,1,"PAH",1,0)
64^3130321
"PKG",550,22,1,"PAH",1,1,0)
^^10^10^3130321
"PKG",550,22,1,"PAH",1,1,1,0)
This Patch Addresses 3 issues:
"PKG",550,22,1,"PAH",1,1,2,0)
 
"PKG",550,22,1,"PAH",1,1,3,0)
1.  An order with an Unknown Action status is unavailable
"PKG",550,22,1,"PAH",1,1,4,0)
    when using the Edit Med Log option if another user runs
"PKG",550,22,1,"PAH",1,1,5,0)
    the BCMA Medication Administration History (MAH) report.
"PKG",550,22,1,"PAH",1,1,6,0)
2.  A fatal error occurs when using the Unable to Scan function
"PKG",550,22,1,"PAH",1,1,7,0)
    in BCMA and then scanning another medication. 
"PKG",550,22,1,"PAH",1,1,8,0)
3.  A fatal error occurs when clicking on the BCMA Coversheet if 
"PKG",550,22,1,"PAH",1,1,9,0)
    a patient's only current order is an IV Piggyback which has a 
"PKG",550,22,1,"PAH",1,1,10,0)
    day of the week schedule.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSBCSUTY")
0^2^B43766281^B43368080
"RTN","PSBCSUTY",1,0)
PSBCSUTY ;BIRMINGHAM/TEJ- BCMA-HSC COVER SHEET UTILITIES 3 ;Mar 2004
"RTN","PSBCSUTY",2,0)
 ;;3.0;BAR CODE MED ADMIN;**16,32,64**;Mar 2004;Build 14
"RTN","PSBCSUTY",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBCSUTY",4,0)
 ;
"RTN","PSBCSUTY",5,0)
 ; Reference/IA
"RTN","PSBCSUTY",6,0)
 ; $$GET1^DIQ/2056
"RTN","PSBCSUTY",7,0)
 ; File 200/10060
"RTN","PSBCSUTY",8,0)
CMT ; Comment per admin.
"RTN","PSBCSUTY",9,0)
 S (PSBIENX,PSBPRNRE)="",PSBIENX=+$P(PSBADMS(PSBONMBR,PSBSCHTM),U,3),PSBPRNRE=$P(PSBADMS(PSBONMBR,PSBSCHTM),U,8)
"RTN","PSBCSUTY",10,0)
 D:+$O(^PSB(53.79,PSBIENX,.3,""),-1)>0
"RTN","PSBCSUTY",11,0)
 .S PSBI2=0 F  S PSBI2=$O(^PSB(53.79,PSBIENX,.3,PSBI2)) Q:PSBI2=""  D
"RTN","PSBCSUTY",12,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U)="CMT",$P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,2)=$P(^PSB(53.79,PSBIENX,.3,PSBI2,0),U)
"RTN","PSBCSUTY",13,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,4)=$P(^PSB(53.79,PSBIENX,.3,PSBI2,0),U,2)
"RTN","PSBCSUTY",14,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,5)=$$GET1^DIQ(200,$P(^PSB(53.79,PSBIENX,.3,PSBI2,0),U,2)_",","INITIAL")
"RTN","PSBCSUTY",15,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,6)=$P(^PSB(53.79,PSBIENX,.3,PSBI2,0),U,3),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTY",16,0)
 D:($G(PSBPRNRE)]"")&($$GET1^DIQ(53.79,PSBIENX_",","PRN EFFECTIVENESS")]"")
"RTN","PSBCSUTY",17,0)
 .S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U)="CMT",$P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,3)=$$GET1^DIQ(53.79,PSBIENX_",","PRN EFFECTIVENESS")
"RTN","PSBCSUTY",18,0)
 .S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,4)=$$GET1^DIQ(53.79,PSBIENX_",","PRN EFFECTIVENESS ENTERED BY","I")
"RTN","PSBCSUTY",19,0)
 .S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,5)=$$GET1^DIQ(53.79,PSBIENX_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBCSUTY",20,0)
 .S $P(^TMP("PSB",$J,"CVRSHT2",PSBI1,PSBCNT2),U,6)=$$GET1^DIQ(53.79,PSBIENX_",","PRN EFFECTIVENESS ENTERED AT","I"),PSBCNT2=PSBCNT2+1
"RTN","PSBCSUTY",21,0)
 Q
"RTN","PSBCSUTY",22,0)
XFERBAGS ;
"RTN","PSBCSUTY",23,0)
 ;  Logic to "move IV bags"
"RTN","PSBCSUTY",24,0)
 ;  Construct Temp arrays PSBADMX,PSBDONE
"RTN","PSBCSUTY",25,0)
 Q:PSBPONX']""
"RTN","PSBCSUTY",26,0)
 K PSBCHKED
"RTN","PSBCSUTY",27,0)
 S PSBNX2=PSBONX,PSBDFN2=PSBDFN,PSBPNX2=PSBPONX,PSBFN2=PSBFON F  Q:PSBFN2]""  D  Q:PSBPONX']""  S PSBPNX2=PSBPONX I $G(PSBCHKED(PSBPONX))=1 K PSBCHKED Q
"RTN","PSBCSUTY",28,0)
 .D CLEAN^PSBVT S PSBPONX=PSBPNX2,PSBCHKED(PSBPONX)=1 D PSJ1^PSBVT(PSBDFN2,PSBPONX)
"RTN","PSBCSUTY",29,0)
 .S (PSBXX,PSBXXX)="" F  S PSBXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX)) Q:PSBXX=""  D
"RTN","PSBCSUTY",30,0)
 ..S PSBXXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX,PSBXXX)) Q:PSBXXX=""  Q:$P(^PSB(53.79,PSBXXX,0),U,9)="C"  S:'$D(PSBDONE(PSBXXX)) (PSBADMX(PSBNX2,PSBXX,PSBXXX),PSBDONE(PSBXXX))=""
"RTN","PSBCSUTY",31,0)
 ; Refresh data
"RTN","PSBCSUTY",32,0)
 D CLEAN^PSBVT,PSJ1^PSBVT(PSBDFN2,PSBNX2)
"RTN","PSBCSUTY",33,0)
 K PSBNX2,PSBDFN2,PSBPNX2,PSBFN2
"RTN","PSBCSUTY",34,0)
 Q
"RTN","PSBCSUTY",35,0)
GETADMX ;
"RTN","PSBCSUTY",36,0)
 S (PSBXX,PSBXXX)="" F  S PSBXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX)) Q:PSBXX=""  D
"RTN","PSBCSUTY",37,0)
 .Q:(PSBXX<PSBMHBCK)&'PSBLVIV
"RTN","PSBCSUTY",38,0)
 .F  S PSBXXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX,PSBXXX)) Q:PSBXXX=""  Q:(PSBFON]"")&($P(^PSB(53.79,PSBXXX,0),U,9)'="C")&(PSBLVIV)  D
"RTN","PSBCSUTY",39,0)
 ..S (PSBADMX(PSBONX,PSBXX,PSBXXX),PSBDONE(PSBXXX))=""
"RTN","PSBCSUTY",40,0)
 ; Check "actions" that DO NOT get filed into AORDX !!
"RTN","PSBCSUTY",41,0)
 S (PSBXX,PSBXXX)="" F  S PSBXX=$O(^PSB(53.79,"AORD",PSBDFN,PSBONX,PSBXX)) Q:PSBXX=""  D
"RTN","PSBCSUTY",42,0)
 .F  S PSBXXX=$O(^PSB(53.79,"AORD",PSBDFN,PSBONX,PSBXX,PSBXXX)) Q:PSBXXX=""  D
"RTN","PSBCSUTY",43,0)
 ..S:('$D(PSBDONE(PSBXXX)))&($P(^PSB(53.79,PSBXXX,0),U,6)'<PSBMHBCK) PSBADMX(PSBONX,PSBXX,PSBXXX)=""
"RTN","PSBCSUTY",44,0)
 K PSBXX,PSBXXX,PSBDONE
"RTN","PSBCSUTY",45,0)
 Q
"RTN","PSBCSUTY",46,0)
LVIV ;
"RTN","PSBCSUTY",47,0)
 ; Set up variables to later extract LVIV data
"RTN","PSBCSUTY",48,0)
 ; Add all LVIVs that have been active with in the window!!
"RTN","PSBCSUTY",49,0)
 I (PSBOSP'<PSBWBEG)&(PSBOSP'>PSBWEND) D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"CVRSHT")
"RTN","PSBCSUTY",50,0)
 S PSBEXPRD=0 I (PSBFON']"")&(PSBOSP<PSBNOW) S PSBEXPRD=1
"RTN","PSBCSUTY",51,0)
 S (PSBXX,PSBXXX)="" F  S PSBXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX)) Q:PSBXX=""  D
"RTN","PSBCSUTY",52,0)
 .S PSBXXX=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXX,PSBXXX)) Q:PSBXXX=""
"RTN","PSBCSUTY",53,0)
 .I "IS"[$P(^PSB(53.79,PSBXXX,0),U,9)&(PSBFON']"") S PSBEXPRD=0
"RTN","PSBCSUTY",54,0)
 .S:'$D(PSBDONE(PSBXXX))&(PSBFON="") (PSBADMX(PSBONX,PSBXX,PSBXXX),PSBDONE(PSBXXX))=""
"RTN","PSBCSUTY",55,0)
 S (PSBXX,PSBXXX)="" F  S PSBXX=$O(PSBADMX(PSBONX,PSBXX)) Q:PSBXX=""  D
"RTN","PSBCSUTY",56,0)
 .S PSBXXX=$O(PSBADMX(PSBONX,PSBXX,PSBXXX)) Q:PSBXXX=""
"RTN","PSBCSUTY",57,0)
 .I "IS"[$P(^PSB(53.79,PSBXXX,0),U,9)&(PSBFON']"") S PSBEXPRD=0
"RTN","PSBCSUTY",58,0)
 .S:'$D(PSBDONE(PSBXXX))&(PSBFON="") (PSBADMX(PSBONX,PSBXX,PSBXXX),PSBDONE(PSBXXX))=""
"RTN","PSBCSUTY",59,0)
 Q
"RTN","PSBCSUTY",60,0)
QUT() ;
"RTN","PSBCSUTY",61,0)
 S QUT=0
"RTN","PSBCSUTY",62,0)
 D NOW^%DTC ;Set % variable, PSB*3*64
"RTN","PSBCSUTY",63,0)
 I PSBOST>($$FMADD^XLFDT($$NOW^XLFDT,,,$$GET^XPAR("DIV","PSB ADMIN BEFORE"))) S QUT=1 Q QUT
"RTN","PSBCSUTY",64,0)
 I '(($F("ED",PSBOSTS)'>1)&(PSBOSP'<%)) S QUT=1 Q QUT
"RTN","PSBCSUTY",65,0)
 Q QUT
"RTN","PSBCSUTY",66,0)
USED() ;
"RTN","PSBCSUTY",67,0)
 S (PSBXIEN,PSBUSD,USED)=0,PSBBAGX=$P(PSBXREC,U,2)
"RTN","PSBCSUTY",68,0)
 I $$QUT() S (PSBUSD,USED)=1 Q PSBUSD
"RTN","PSBCSUTY",69,0)
 S PSBXXX="" F  S PSBXXX=$O(^PSB(53.79,"AUID",PSBDFNX,PSBXXX)) Q:PSBXXX=""  D  Q:PSBUSD
"RTN","PSBCSUTY",70,0)
 .I $D(^PSB(53.79,"AUID",PSBDFNX,PSBXXX,PSBBAGX)) S PSBXIEN=$O(^PSB(53.79,"AUID",PSBDFNX,PSBXXX,PSBBAGX,"")) S:$F("GICSHRM",$P(^PSB(53.79,PSBXIEN,0),U,9))>1 (PSBUSD,USED)=1,PSBOBAG(PSBONMBR)=""
"RTN","PSBCSUTY",71,0)
 Q USED
"RTN","PSBCSUTY",72,0)
ORC ; Ord cmmnts
"RTN","PSBCSUTY",73,0)
 S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORC",$P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,2)=^TMP("PSB",$J,PSBTAB,PSBI1),PSBRECHD="ORF"
"RTN","PSBCSUTY",74,0)
 Q
"RTN","PSBCSUTY",75,0)
ORF ; Ordr flag  "ORF^FLAG^Flg Comment"
"RTN","PSBCSUTY",76,0)
 K ^TMP("PSJ1",$J),PSBNOX
"RTN","PSBCSUTY",77,0)
 D EN^PSJBCMA1(PSBDFN,PSBONMBR,1)
"RTN","PSBCSUTY",78,0)
 ;Set STAT FLAG
"RTN","PSBCSUTY",79,0)
 I $P(^TMP("PSJ1",$J,7),U,1) S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORF^STAT"
"RTN","PSBCSUTY",80,0)
 ;Set IM/CPRS ord flg and cmment
"RTN","PSBCSUTY",81,0)
 I $P(^TMP("PSJ1",$J,7),U,2) D
"RTN","PSBCSUTY",82,0)
 .S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORF^CPRS^"_$P(^TMP("PSJ1",$J,7),U,3)_U_$P(^TMP("PSJ1",$J,7),U,4)
"RTN","PSBCSUTY",83,0)
 .I $P(^TMP("PSJ1",$J,7),U,3)']"" D
"RTN","PSBCSUTY",84,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,2)="CPRS"
"RTN","PSBCSUTY",85,0)
 ..S $P(^TMP("PSB",$J,"CVRSHT2",PSBCNT2),U,3)="*PSJ DATA ERROR* ^ PSJ Order Flag Error"
"RTN","PSBCSUTY",86,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBCSUTY",87,0)
 ;Set No Act Flag
"RTN","PSBCSUTY",88,0)
 I ('$D(^PSB(53.79,"AORDX",PSBDFN,PSBONMBR))) I (PSBLRGIV) I '$D(PSBADMX(PSBONMBR)) I $P(PSBORREC,U,26)>$G(%,PSBNOW) D
"RTN","PSBCSUTY",89,0)
 .S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)="ORF^NOX^No Action Taken On Order"
"RTN","PSBCSUTY",90,0)
 .S PSBNOX(PSBONMBR,PSBCNT2)=""
"RTN","PSBCSUTY",91,0)
 S PSBRECHD="MED"
"RTN","PSBCSUTY",92,0)
 Q
"RTN","PSBCSUTY",93,0)
MED ; Cnstr DD,ADD,SOL,ID
"RTN","PSBCSUTY",94,0)
 F I=PSBI1:1 S PSBXREC=^TMP("PSB",$J,PSBTAB,I) Q:PSBXREC="END"  D
"RTN","PSBCSUTY",95,0)
 .I $P(PSBXREC,U)="ID" S PSBUSED=$$USED()  Q:PSBUSED
"RTN","PSBCSUTY",96,0)
 .S PSBCNT2=PSBCNT2+1,^TMP("PSB",$J,"CVRSHT2",PSBCNT2)=PSBXREC
"RTN","PSBCSUTY",97,0)
 S PSBI1=I-1
"RTN","PSBCSUTY",98,0)
 Q
"RTN","PSBCSUTY",99,0)
FINALPAS ;
"RTN","PSBCSUTY",100,0)
 S PSBI1="^TMP(""PSB"",$J,""CVRSHT"")",PSBCNT1=0
"RTN","PSBCSUTY",101,0)
 F  S PSBI1=$Q(@PSBI1) Q:PSBI1["CVRSHT2"  D
"RTN","PSBCSUTY",102,0)
 .I $QS(PSBI1,4)'>1 S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTY",103,0)
 .K PSBX2 M PSBX2=^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4))
"RTN","PSBCSUTY",104,0)
 .I $QS(PSBI1,5)="" S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTY",105,0)
 .K PSBDONE
"RTN","PSBCSUTY",106,0)
 .I '$D(PSBX2(1)) S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=@PSBI1,PSBCNT1=PSBCNT1+1 Q
"RTN","PSBCSUTY",107,0)
 .F PSBI2=1:1 Q:'$D(PSBX2(PSBI2))  D  ;sort actn/cmmnt rev. chrono
"RTN","PSBCSUTY",108,0)
 ..Q:$D(PSBDONE(PSBI2))
"RTN","PSBCSUTY",109,0)
 ..S PSBXDTTM=(-1*($P(PSBX2(PSBI2),U,6)))_+($E($P(PSBX2(PSBI2),U,4),$L($P(PSBX2(PSBI2),U,4))-6,999)),PSBMCODE=$P(PSBX2(PSBI2),U)
"RTN","PSBCSUTY",110,0)
 ..D:(+PSBXDTTM<0)&(PSBMCODE["ADM")
"RTN","PSBCSUTY",111,0)
 ...S PSBX3(+PSBXDTTM,-999)=PSBX2(PSBI2),PSBDONE(PSBI2)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2)
"RTN","PSBCSUTY",112,0)
 ...F PSBI3=1:1 Q:'$D(PSBX2(PSBI2+PSBI3))  Q:$P(PSBX2(PSBI2+PSBI3),U)'["CMT"  D
"RTN","PSBCSUTY",113,0)
 ....S PSBX3(+PSBXDTTM,-1*PSBI3)=PSBX2(PSBI2+PSBI3),PSBDONE(PSBI2+PSBI3)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2+PSBI3)
"RTN","PSBCSUTY",114,0)
 ..D:(+PSBXDTTM=0)&(PSBMCODE["ADM")
"RTN","PSBCSUTY",115,0)
 ...S PSBX3(PSBI2,0)=PSBX2(PSBI2),PSBDONE(PSBI2)="" K ^TMP("PSB",$J,"CVRSHT",$QS(PSBI1,4),PSBI2)
"RTN","PSBCSUTY",116,0)
 .I $D(PSBX3) D  K PSBX3
"RTN","PSBCSUTY",117,0)
 ..S PSBI2="" F  S PSBI2=$O(PSBX3(PSBI2)) Q:PSBI2=""  S PSBI3="" F  S PSBI3=$O(PSBX3(PSBI2,PSBI3)) Q:PSBI3=""  D
"RTN","PSBCSUTY",118,0)
 ...S ^TMP("PSB",$J,"CVRSHT2",PSBCNT1)=PSBX3(PSBI2,PSBI3),PSBCNT1=PSBCNT1+1
"RTN","PSBCSUTY",119,0)
 S $P(^TMP("PSB",$J,"CVRSHT2",0),U)=PSBCNT1-1
"RTN","PSBCSUTY",120,0)
 Q
"RTN","PSBOMH1")
0^1^B83153329^B83032453
"RTN","PSBOMH1",1,0)
PSBOMH1 ;BIRMINGHAM/EFC-MAH ; 2/16/12 1:00pm
"RTN","PSBOMH1",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,9,11,26,38,45,51,50,57,67,64**;Mar 2004;Build 14
"RTN","PSBOMH1",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBOMH1",4,0)
 ;
"RTN","PSBOMH1",5,0)
 ; Reference/IA
"RTN","PSBOMH1",6,0)
 ; ^DILF/2054
"RTN","PSBOMH1",7,0)
 ; File 200/10060
"RTN","PSBOMH1",8,0)
 ;
"RTN","PSBOMH1",9,0)
EN ;
"RTN","PSBOMH1",10,0)
 ; Load administrations
"RTN","PSBOMH1",11,0)
 N PSBDT,X,Y
"RTN","PSBOMH1",12,0)
 S (PSBORD,PSBIEN,PSBR1,PSBADIEN,PSBABR)="",PSBDT=PSBSTRT
"RTN","PSBOMH1",13,0)
 K PSBTSA
"RTN","PSBOMH1",14,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOMH1",15,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  Q:'$D(^PSB(53.79,PSBIEN))  I $P(^PSB(53.79,PSBIEN,0),U,9)]"" D  ;Remove Lock as file is only read, PSB*3*64
"RTN","PSBOMH1",16,0)
 ..Q:'$P($G(^PSB(53.79,PSBIEN,0)),U,6)  ; Bad IEN -no evnt dt
"RTN","PSBOMH1",17,0)
 ..Q:$P(^PSB(53.79,PSBIEN,0),U,9)="N"  ;NGiven
"RTN","PSBOMH1",18,0)
 ..S PSBORD=$P($G(^PSB(53.79,PSBIEN,.1)),U,1)
"RTN","PSBOMH1",19,0)
 ..;PSB*3*45 Anyone on the audit log should be in the legend
"RTN","PSBOMH1",20,0)
 ..N TMPCT S TMPCT=0 F  S TMPCT=$O(^PSB(53.79,PSBIEN,.9,TMPCT)) Q:'TMPCT  D
"RTN","PSBOMH1",21,0)
 ...S PSBINIT=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN,"USER:INITIAL"),PSBNAME=$$GET1^DIQ(53.799,TMPCT_","_PSBIEN_",","USER")
"RTN","PSBOMH1",22,0)
 ...S:PSBINIT="" PSBINIT=99
"RTN","PSBOMH1",23,0)
 ...S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",24,0)
 ..; Continuous
"RTN","PSBOMH1",25,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="C"
"RTN","PSBOMH1",26,0)
 ...S X=PSBDT D H^%DTC S PSBWEEK=PSBAR(%H) D CLEAN^PSBVT,PSJ1^PSBVT($P(^PSB(53.79,PSBIEN,0),U,1),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",27,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,6)'=PSBDT,'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBIVPSH) D  D CLEAN^PSBVT Q  ;chck IV audit
"RTN","PSBOMH1",28,0)
 ....S PSBSIEN=PSBIEN
"RTN","PSBOMH1",29,0)
 ....I $P(^PSB(53.79,PSBIEN,0),"^",10)]"" D BAGDTL^PSBRPC2(.PSBAUD,$P(^PSB(53.79,PSBIEN,0),U,10),$P(^PSB(53.79,PSBIEN,.1),U,1))
"RTN","PSBOMH1",30,0)
 ....S PSBIEN=PSBSIEN K PSBSIEN
"RTN","PSBOMH1",31,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  I $P(PSBAUD(X),U,3)="" K PSBAUD(X)
"RTN","PSBOMH1",32,0)
 ....S X=0 F  S X=$O(PSBAUD(X)) Q:X=""  Q:$P(PSBAUD(X),U,1)=PSBDT
"RTN","PSBOMH1",33,0)
 ....I X="" K PSBAUD Q
"RTN","PSBOMH1",34,0)
 ....I '$D(PSBAUD(X)) K PSBAUD Q
"RTN","PSBOMH1",35,0)
 ....S PSBS=$P(PSBAUD(X),U,3)
"RTN","PSBOMH1",36,0)
 ....I PSBS="GIVEN",$P($G(PSBAUD(X-1)),U,3)="NOT GIVEN" Q
"RTN","PSBOMH1",37,0)
 ....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",38,0)
 ....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NOACTION")
"RTN","PSBOMH1",39,0)
 ....D PSBSTIV^PSBOMH2
"RTN","PSBOMH1",40,0)
 ....S X=PSBDT_U_$P(PSBAUD(X),U,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",41,0)
 ....S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",42,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",43,0)
 ....S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",44,0)
 ....D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",45,0)
 ....K PSBAUD
"RTN","PSBOMH1",46,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",47,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",48,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",49,0)
 ...;get instrc info - audt log
"RTN","PSBOMH1",50,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",51,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",52,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",53,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",54,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("A")
"RTN","PSBOMH1",55,0)
 ...I $P(^PSB(53.79,PSBIEN,0),U,9)'="G",PSBDT=$P(^PSB(53.79,PSBIEN,0),U,6)  D PSBCK1^PSBOMH2("B")
"RTN","PSBOMH1",56,0)
 ...I PSBDT'=$P(^PSB(53.79,PSBIEN,0),U,6),$P(^PSB(53.79,PSBIEN,0),U,9)="RM" D
"RTN","PSBOMH1",57,0)
 ....D DDAUD
"RTN","PSBOMH1",58,0)
 ....S I="" F  S I=$O(PSBTAR(I),-1) Q:I=""  I $P(PSBTAR(I),U,1)=PSBDT D
"RTN","PSBOMH1",59,0)
 .....S PSBS=$P(PSBTAR(I),U,3)
"RTN","PSBOMH1",60,0)
 .....I PSBS="GIVEN",$P($G(PSBTAR(I-1)),U,3)="NOT GIVEN" Q  ; canceled - not given
"RTN","PSBOMH1",61,0)
 .....I PSBS="NOT GIVEN" Q
"RTN","PSBOMH1",62,0)
 .....S PSBS=$S(PSBS="INFUSING":"I",PSBS="GIVEN":"G",PSBS="COMPLETED":"C",PSBS="HELD":"H",PSBS="REFUSED":"R",PSBS="REMOVED":"RM",PSBS="STOPPED":"S",PSBS["MISSING":"M",1:"NO ACTION")
"RTN","PSBOMH1",63,0)
 .....D PSBCTAR^PSBOMH2
"RTN","PSBOMH1",64,0)
 .....S X=$P(PSBTAR(I),U,1,2)_U_PSBS_U_PSBIEN
"RTN","PSBOMH1",65,0)
 ...Q:'+X  ;Quit if invalid data is returned, PSB*3*67
"RTN","PSBOMH1",66,0)
 ...S Y=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,""),-1)+1
"RTN","PSBOMH1",67,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,Y)=X ;PSB*3*67
"RTN","PSBOMH1",68,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,PSBDT\1,0)=Y
"RTN","PSBOMH1",69,0)
 ...D PSBOUT($P((X),"^",1),$P((X),"^",2))
"RTN","PSBOMH1",70,0)
 ...Q
"RTN","PSBOMH1",71,0)
 ..; 1-Time On Call or PRN
"RTN","PSBOMH1",72,0)
 ..D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="C"
"RTN","PSBOMH1",73,0)
 ...I PSBDT'=$$GET1^DIQ(53.79,PSBIEN_",",.06,"I") Q
"RTN","PSBOMH1",74,0)
 ...S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:INITIAL")
"RTN","PSBOMH1",75,0)
 ...S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY:NAME")
"RTN","PSBOMH1",76,0)
 ...I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",77,0)
 ...S (PSBXA,PSBM)=1,(PSBZ,PSBT,PSBFLG)=""
"RTN","PSBOMH1",78,0)
 ...I $$GET1^DIQ(53.79,PSBIEN_",",.09)="REMOVED"  D
"RTN","PSBOMH1",79,0)
 ....F I=1:1 S PSBXA=$O(^PSB(53.79,PSBIEN,.9,PSBXA)) Q:PSBXA=""  I PSBXA?1.3N  S PSBZ=PSBZ+1,PSBT(PSBZ)=^PSB(53.79,PSBIEN,.9,PSBXA,0)
"RTN","PSBOMH1",80,0)
 ....F S=1:1 Q:PSBM<1  S PSBM=PSBZ-S  I (PSBM>0) I (PSBT(PSBM)["GIVEN")  S PSBFLG="1" S PRELINE1=$P(PSBT(PSBM),"'",2)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.04)_" "_$E($P(PSBT(PSBM),"'",4),1,3) Q
"RTN","PSBOMH1",81,0)
 ...I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",82,0)
 ....D INSTR^PSBOMH
"RTN","PSBOMH1",83,0)
 ....S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",84,0)
 ...I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D PSBOUT(PSBDT,PSBINIT)
"RTN","PSBOMH1",85,0)
 ...S PSBLINE1=$$GET1^DIQ(53.79,PSBIEN_",",.09)_" "_$$GET1^DIQ(53.79,PSBIEN_",",.06)_" "_PSBINIT_"            "_$$GET1^DIQ(53.79,PSBIEN_",",.21),PSBLINE2=""
"RTN","PSBOMH1",86,0)
 ...I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",87,0)
 ...D:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)="P"
"RTN","PSBOMH1",88,0)
 ....I $P($G(^PSB(53.79,PSBIEN,.2)),U,2)="" S PSBLINE2="  Results: <No PRN Results On File>"
"RTN","PSBOMH1",89,0)
 ....E  D
"RTN","PSBOMH1",90,0)
 .....S PSBINIT=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:INITIAL")
"RTN","PSBOMH1",91,0)
 .....S PSBNAME=$$GET1^DIQ(53.79,PSBIEN_",","PRN EFFECTIVENESS ENTERED BY:NAME")
"RTN","PSBOMH1",92,0)
 .....I PSBINIT="" S PSBINIT=99
"RTN","PSBOMH1",93,0)
 .....I $D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."))) D
"RTN","PSBOMH1",94,0)
 ......S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,$P(PSBDT,"."),0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",95,0)
 ......S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)=""
"RTN","PSBOMH1",96,0)
 .....I '$D(^PSB(53.79,PSBIEN,.9,$P(PSBDT,".")))  D
"RTN","PSBOMH1",97,0)
 ......D:$D(^PSB(53.79,PSBIEN,.9,0))
"RTN","PSBOMH1",98,0)
 .......S (PSBXA2,PSBFG)=0,PSBEFFDT=$P(^PSB(53.79,PSBIEN,.2),U,4) F  S PSBXA2=$O(^PSB(53.79,PSBIEN,.9,PSBXA2)) Q:+PSBXA2'>0  D  Q:PSBFG=1
"RTN","PSBOMH1",99,0)
 ........D:($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U)=PSBEFFDT)&($P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)["Instruct")&($P(^PSB(53.79,PSBIEN,.2),U,3)=$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,2))
"RTN","PSBOMH1",100,0)
 .........S PSBINIT=PSBINIT_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA2,0),U,3)_"  "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",101,0)
 .........S ^TMP("PSB",$J,"LEGEND",PSBINIT,PSBNAME)="",PSBFG=1
"RTN","PSBOMH1",102,0)
 .....S PSBLINE2="  Results: "_$$GET1^DIQ(53.79,PSBIEN_",",.22)
"RTN","PSBOMH1",103,0)
 .....S PSBRTXTW="     Entered By "_PSBINIT_" on "_$$GET1^DIQ(53.79,PSBIEN_",",.24)
"RTN","PSBOMH1",104,0)
 .....N PSBEIECMT,PSBCMTCH S PSBEIECMT="",PSBCMTCH=0 F  S PSBCMTCH=$O(^PSB(53.79,PSBIEN,.3,PSBCMTCH)) Q:'PSBCMTCH  D
"RTN","PSBOMH1",105,0)
 ......I $P($G(^PSB(53.79,PSBIEN,.3,PSBCMTCH,0)),U)["**Pain Score of" S PSBEIECMT=" **This Pain Score may have been Entered in Error. See Vitals Package.**"
"RTN","PSBOMH1",106,0)
 .....S PSBLINE2=PSBLINE2_PSBEIECMT
"RTN","PSBOMH1",107,0)
 .....I PSBINIT[99 S PSBINIT=""
"RTN","PSBOMH1",108,0)
 ...S X=PSBDT D H^%DTC F PSBWEEK=PSBAR(%H):-7 Q:$D(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",0))!('$D(PSBAR(PSBWEEK)))
"RTN","PSBOMH1",109,0)
 ...S X=$O(^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",""),-1)+1
"RTN","PSBOMH1",110,0)
 ...I PSBFLG="1" S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X)=PRELINE1
"RTN","PSBOMH1",111,0)
 ...S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+1)=PSBLINE1
"RTN","PSBOMH1",112,0)
 ...I $G(PSBLINE2)]"" D
"RTN","PSBOMH1",113,0)
 ....I $L(PSBLINE2)<=90 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=PSBLINE2 S:$$GET1^DIQ(53.79,PSBIEN_",",.24)'="" ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="      "_PSBRTXTW
"RTN","PSBOMH1",114,0)
 ....I $L(PSBLINE2)>90 D
"RTN","PSBOMH1",115,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+2)=$E(PSBLINE2,1,90)
"RTN","PSBOMH1",116,0)
 .....S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+3)="           "_$E(PSBLINE2,91,169)
"RTN","PSBOMH1",117,0)
 .....I $L(PSBLINE2)'>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="     "_PSBRTXTW
"RTN","PSBOMH1",118,0)
 .....I $L(PSBLINE2)>169 S ^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+4)="           "_$E(PSBLINE2,170,245),^TMP("PSB",$J,PSBWEEK,PSBORD,"AT",X+5)="     "_PSBRTXTW
"RTN","PSBOMH1",119,0)
 D RELINE^PSBOMH3(PSBWEEK) ;Line up administrations with their admin times - PSB*3*67
"RTN","PSBOMH1",120,0)
 Q
"RTN","PSBOMH1",121,0)
 ;
"RTN","PSBOMH1",122,0)
DDAUD ;  audits for dispen drugs
"RTN","PSBOMH1",123,0)
 ;
"RTN","PSBOMH1",124,0)
 M PSBMLA=^PSB(53.79,PSBIEN)
"RTN","PSBOMH1",125,0)
 S PSBGA="" I $D(PSBMLA(.9,0)) D
"RTN","PSBOMH1",126,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D  Q
"RTN","PSBOMH1",127,0)
 ..I $D(PSBMLA(.9,PSBX-2,0)) D DT^DILF("ENPST",$P(PSBMLA(.9,PSBX-2,0),"'",2),.PSBDATE)
"RTN","PSBOMH1",128,0)
 ..I '$D(PSBMLA(.9,PSBX-2,0)) S PSBDATE=$P(^PSB(53.79,PSBIEN,0),U,6)
"RTN","PSBOMH1",129,0)
 ..S PSBTMP(10000000-PSBDATE,"B")=PSBDATE_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,5))_U_$P(PSBMLA(.9,PSBX,0),"'",2)
"RTN","PSBOMH1",130,0)
 ..S PSBGA=1
"RTN","PSBOMH1",131,0)
 .F PSBX=1:1 Q:'$D(PSBMLA(.9,PSBX))  I ((PSBMLA(.9,PSBX,0)["ACTION STATUS")!(PSBMLA(.9,PSBX,0)["ADMINISTRATION STATUS")) D
"RTN","PSBOMH1",132,0)
 ..S PSBTMP(10000000-$P(PSBMLA(.9,PSBX,0),U,1),"B")=$P(PSBMLA(.9,PSBX,0),U,1)_U_$$INITIAL^PSBRPC2($P(PSBMLA(.9,PSBX,0),U,2))_U_$P($P(PSBMLA(.9,PSBX,0),U,3),"'",2)
"RTN","PSBOMH1",133,0)
 ..S PSBGA=1
"RTN","PSBOMH1",134,0)
 ;PSB*3*45 Remove Use of $Q(<>,-1)
"RTN","PSBOMH1",135,0)
 N PSBTMQ
"RTN","PSBOMH1",136,0)
 I PSBGA'=1 S PSBTMP(10000000-$P(PSBMLA(0),U,6),"A")=$P(PSBMLA(0),U,6)_U_$$INITIAL^PSBRPC2($P(PSBMLA(0),U,7))
"RTN","PSBOMH1",137,0)
 S PSBQRY="PSBTMP",PSBCNT=1 F  S PSBTMQ=PSBQRY,PSBQRY=$Q(@PSBQRY) Q:PSBQRY=""  D  ; does comment go with action
"RTN","PSBOMH1",138,0)
 .S PSBPQRY=$G(PSBTMQ)
"RTN","PSBOMH1",139,0)
 .I PSBPQRY="" S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; no prev action
"RTN","PSBOMH1",140,0)
 .I $QS(PSBPQRY,2)="C"  S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1 Q  ; prev line = comment
"RTN","PSBOMH1",141,0)
 .I $QS(PSBQRY,2)="C",$E($P(@PSBTMQ,U,1),1,12)=$E($P(@PSBQRY,U,1),1,12),$P(@PSBTMQ,U,2)=$P(@PSBQRY,U,2) D  Q
"RTN","PSBOMH1",142,0)
 ..S X=$P(@PSBQRY,U,4) S:X[":" X=$P(X,":",2) S $P(PSBTAR(PSBCNT-1),U,4)=X Q
"RTN","PSBOMH1",143,0)
 .S PSBTAR(PSBCNT)=@PSBQRY,PSBCNT=PSBCNT+1
"RTN","PSBOMH1",144,0)
 Q
"RTN","PSBOMH1",145,0)
 ;
"RTN","PSBOMH1",146,0)
PSBOUT(PSBTET,PSBOT1) ;
"RTN","PSBOMH1",147,0)
 I '$D(^PSB(53.79,PSBIEN,.9,0))  D PSBENT^PSBOMH2(PSBOT1)
"RTN","PSBOMH1",148,0)
 S PSBIDA="" I $P(^PSB(53.79,PSBIEN,0),U,6)=PSBTET S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,7),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",149,0)
 S PSBXA1=0
"RTN","PSBOMH1",150,0)
 F  S PSBXA1=$O(^PSB(53.79,PSBIEN,.9,PSBXA1)) Q:+PSBXA1'>0  I PSBXA1'=0  D  Q:$G(PSBOT1)["*"
"RTN","PSBOMH1",151,0)
 .I $L(PSBXA1)<4  D
"RTN","PSBOMH1",152,0)
 ..I $P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1)=PSBTET  D
"RTN","PSBOMH1",153,0)
 ...S:$G(PSBIDA)="" PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",154,0)
 ...I (PSBIDA=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",2)),$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",3)["Instruct"  D
"RTN","PSBOMH1",155,0)
 ....S INSDD=$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),"^",1),Y=INSDD D DD^%DT S INSDD=Y
"RTN","PSBOMH1",156,0)
 ....S PSBOT1=PSBOT1_"*",PSBNAME=PSBNAME_"/"_$P(^PSB(53.79,PSBIEN,.9,PSBXA1,0),U,3)_" "_INSDD
"RTN","PSBOMH1",157,0)
 I $G(PSBIDA)="",$P(^PSB(53.79,PSBIEN,0),U,4)=PSBTET D
"RTN","PSBOMH1",158,0)
 .S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",159,0)
 I $G(PSBNAME)="" D
"RTN","PSBOMH1",160,0)
 . S PSBIDA=$P(^PSB(53.79,PSBIEN,0),U,5),PSBOT1=$P(^VA(200,PSBIDA,0),"^",2),PSBNAME=$P(^VA(200,PSBIDA,0),"^",1)
"RTN","PSBOMH1",161,0)
 S ^TMP("PSB",$J,"LEGEND",$S($G(PSBOT1)="":99,1:PSBOT1),PSBNAME)=""
"RTN","PSBOMH1",162,0)
 Q
"RTN","PSBOMH1",163,0)
 ;
"RTN","PSBVDLU3")
0^3^B91879754^B91754867
"RTN","PSBVDLU3",1,0)
PSBVDLU3 ;BIRMINGHAM/TEJ-BCMA VDL UTILITIES 3 ; 27 Aug 2008  9:06 PM
"RTN","PSBVDLU3",2,0)
 ;;3.0;BAR CODE MED ADMIN;**13,38,28,50,64**;Mar 2004;Build 14
"RTN","PSBVDLU3",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSBVDLU3",4,0)
 ;
"RTN","PSBVDLU3",5,0)
 ;This routine file has been created to serve as a container
"RTN","PSBVDLU3",6,0)
 ;for Extrinsic Variables/Functions
"RTN","PSBVDLU3",7,0)
 ;
"RTN","PSBVDLU3",8,0)
 ; Reference/IA
"RTN","PSBVDLU3",9,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLU3",10,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBVDLU3",11,0)
 ; File 50/221
"RTN","PSBVDLU3",12,0)
 ; File 52.6/436
"RTN","PSBVDLU3",13,0)
 ; File 52.7/437
"RTN","PSBVDLU3",14,0)
 ;
"RTN","PSBVDLU3",15,0)
IVPTAB(PSBORTYP,PSBIVTYP,PSBINTSY,PSBCHMTY,PSBPUSH)  ;
"RTN","PSBVDLU3",16,0)
 ;
"RTN","PSBVDLU3",17,0)
 ; This function will return
"RTN","PSBVDLU3",18,0)
 ; the value 1 (one) if the
"RTN","PSBVDLU3",19,0)
 ; specified order input will cause
"RTN","PSBVDLU3",20,0)
 ; the order to display on the "IVP/IVPB"
"RTN","PSBVDLU3",21,0)
 ; tab of the VDL BCMA Virtual Due List (VDL)
"RTN","PSBVDLU3",22,0)
 ; else return the value 0 (zero).
"RTN","PSBVDLU3",23,0)
 ;
"RTN","PSBVDLU3",24,0)
 ; Input Parameters:
"RTN","PSBVDLU3",25,0)
 ;
"RTN","PSBVDLU3",26,0)
 ;     PSBORTYP - Order type (e.g. "U","V")
"RTN","PSBVDLU3",27,0)
 ;     PSBIVTYP - IV Type (e.g. "P","S","C")
"RTN","PSBVDLU3",28,0)
 ;     PSBINTSY - Intermittent Syringe value
"RTN","PSBVDLU3",29,0)
 ;     PSBCHMTY - Chemo type (e.g. "P","S")
"RTN","PSBVDLU3",30,0)
 ;     PSBPUSH - IV PUSH Flag (e.g. 0 or 1, 1=IV PUSH)
"RTN","PSBVDLU3",31,0)
 ;
"RTN","PSBVDLU3",32,0)
 ; Output:
"RTN","PSBVDLU3",33,0)
 ;     1 - order will display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",34,0)
 ;     0 - order will NOT display on the "IVP/IVPB" Tab of BCMA VDL
"RTN","PSBVDLU3",35,0)
 ;    -1 - error processed
"RTN","PSBVDLU3",36,0)
 ;
"RTN","PSBVDLU3",37,0)
 Q:'$D(PSBORTYP) "-1^Missing Parameter"
"RTN","PSBVDLU3",38,0)
 I PSBORTYP="U"&(PSBPUSH) Q 1
"RTN","PSBVDLU3",39,0)
 I '(PSBORTYP="V") Q 0
"RTN","PSBVDLU3",40,0)
 I $G(PSBIVTYP)="P" Q 1
"RTN","PSBVDLU3",41,0)
 I $G(PSBIVTYP)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",42,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="P" Q 1
"RTN","PSBVDLU3",43,0)
 I $G(PSBIVTYP)="C",$G(PSBCHMTY)="S",$G(PSBINTSY)=1 Q 1
"RTN","PSBVDLU3",44,0)
 Q 0
"RTN","PSBVDLU3",45,0)
 ;
"RTN","PSBVDLU3",46,0)
SHOVDL(DFN,BDATE,OTDATE,PSBTAB) ;
"RTN","PSBVDLU3",47,0)
 ;
"RTN","PSBVDLU3",48,0)
 ; This function will find orders such as discontinued or expired infusing IV bags 
"RTN","PSBVDLU3",49,0)
 ; or discontinued or expired "given" patches.  Recognizing these types of orders
"RTN","PSBVDLU3",50,0)
 ; will allow these orders to be displayed on the VDL and permits the user to take 
"RTN","PSBVDLU3",51,0)
 ; action on them.  This routine determines if such orders exist for patient,
"RTN","PSBVDLU3",52,0)
 ; time, and "BCMA VDL tab."  This routine is an "extention" to the API EN^PSJBCMA.
"RTN","PSBVDLU3",53,0)
 ;
"RTN","PSBVDLU3",54,0)
 ; INPUT Parameters:
"RTN","PSBVDLU3",55,0)
 ;    DFN           (req)   Patient Internal File Number.
"RTN","PSBVDLU3",56,0)
 ;    BDATE         (opt)   Start searching for "order stop" after this date. 
"RTN","PSBVDLU3",57,0)
 ;    OTDATE        (opt)   Include One-Time orders from this date.
"RTN","PSBVDLU3",58,0)
 ;    PSBTAB        (opt)   "UDTAB" or "IVTAB" - expedites process if specific tab
"RTN","PSBVDLU3",59,0)
 ;                            is given.
"RTN","PSBVDLU3",60,0)
 ;
"RTN","PSBVDLU3",61,0)
 ; OUTPUT Values
"RTN","PSBVDLU3",62,0)
 ;    0               absolutely no orders to display on VDL
"RTN","PSBVDLU3",63,0)
 ;    1               displayable orders have been located.
"RTN","PSBVDLU3",64,0)
 ;
"RTN","PSBVDLU3",65,0)
 ;
"RTN","PSBVDLU3",66,0)
 D EN^PSJBCMA(DFN,$G(BDATE),$G(OTDATE))
"RTN","PSBVDLU3",67,0)
 ; any active Patch orders to show on VDL?
"RTN","PSBVDLU3",68,0)
 S PSBFLG=0
"RTN","PSBVDLU3",69,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 D
"RTN","PSBVDLU3",70,0)
 .;  
"RTN","PSBVDLU3",71,0)
 .; Check the indexice for given patches or infusing IVs
"RTN","PSBVDLU3",72,0)
 .;
"RTN","PSBVDLU3",73,0)
 .; Check APATCH
"RTN","PSBVDLU3",74,0)
 .D:($G(PSBTAB)="UDTAB")!($G(PSBTAB)="")  Q:PSBFLG
"RTN","PSBVDLU3",75,0)
 ..S PSBGNODE="^PSB(53.79,"_"""APATCH"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",76,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,5),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="G":1,1:0)
"RTN","PSBVDLU3",77,0)
 .;
"RTN","PSBVDLU3",78,0)
 .; Check AUID
"RTN","PSBVDLU3",79,0)
 .;
"RTN","PSBVDLU3",80,0)
 .D:(($G(PSBTAB)="IVTAB")!($G(PSBTAB)=""))&('PSBFLG)  Q:PSBFLG
"RTN","PSBVDLU3",81,0)
 ..S PSBGNODE="^PSB(53.79,"_"""AUID"""_","_DFN_")" Q:'$D(PSBGNODE)
"RTN","PSBVDLU3",82,0)
 ..F  S PSBGNODE=$Q(@PSBGNODE) Q:PSBGNODE=""  Q:$QS(PSBGNODE,3)'=DFN  Q:PSBFLG  S PSBIEN=$QS(PSBGNODE,6),PSBFLG=$S($P(^PSB(53.79,PSBIEN,0),U,9)="I":1,1:0)
"RTN","PSBVDLU3",83,0)
 .;
"RTN","PSBVDLU3",84,0)
 .;  NOTE: Infusing bags will not display if DCed more than 3 days ago!
"RTN","PSBVDLU3",85,0)
 .;
"RTN","PSBVDLU3",86,0)
 S:$G(^TMP("PSJ",$J,1,0))'=-1 PSBFLG=1
"RTN","PSBVDLU3",87,0)
 ;
"RTN","PSBVDLU3",88,0)
 Q PSBFLG
"RTN","PSBVDLU3",89,0)
 ;
"RTN","PSBVDLU3",90,0)
FNDACTV(RESULTS,PARAMS) ;   Utility to check and order for the latest " ? (parameter #3) " order activities per patient (parameter #1)
"RTN","PSBVDLU3",91,0)
 ; #parameter= # "^"piece
"RTN","PSBVDLU3",92,0)
 ;       #1 DFN - Patient's IEN          e.g. 1234      (required)
"RTN","PSBVDLU3",93,0)
 ;       #2 Order Number_Order Type      e.g. "1V"     "" = all orders
"RTN","PSBVDLU3",94,0)
 ;       #3 Search for Activity          e.g           "" = *unknown* activity
"RTN","PSBVDLU3",95,0)
 ;       #4 Search "back"time(hours)     e.g. 12       "" = search back 3 admins
"RTN","PSBVDLU3",96,0)
 ;          NOTE:  ="FREQ"  This Function will use order's frequency.
"RTN","PSBVDLU3",97,0)
 ;          1. If the order is a PRN, On Call or One-Time
"RTN","PSBVDLU3",98,0)
 ;           the look back a default of 72 hours.
"RTN","PSBVDLU3",99,0)
 ;          2. if the order is a Continuous order key off
"RTN","PSBVDLU3",100,0)
 ;             of the frequency as follows.
"RTN","PSBVDLU3",101,0)
 ;           a.) if the frequency is <24 hours use the
"RTN","PSBVDLU3",102,0)
 ;               default of 72 hours.
"RTN","PSBVDLU3",103,0)
 ;           b.) if the frequency is >= 24 hour, look back
"RTN","PSBVDLU3",104,0)
 ;               3.5 times the frequency
"RTN","PSBVDLU3",105,0)
 ;    NOTE:  ["X#"    This Function will search back # of admins.
"RTN","PSBVDLU3",106,0)
 ;
"RTN","PSBVDLU3",107,0)
 ;  Example call: D FNDACTV^PSBVDLU3(.TEJ,"1234^1U^H^12")
"RTN","PSBVDLU3",108,0)
 ;
"RTN","PSBVDLU3",109,0)
 N PSBNOW,PSBDFN,PSBON,PSBCNT,PSBACT,PSBTMFRM,PSBX,PSBSET,PSBFRQ
"RTN","PSBVDLU3",110,0)
 K RESULTS
"RTN","PSBVDLU3",111,0)
 S PSBDFN=$P(PARAMS,U),PSBON=$P(PARAMS,U,2),PSBACT=$P(PARAMS,U,3),PSBTMFRM=$P(PARAMS,U,4)
"RTN","PSBVDLU3",112,0)
 S RESULTS(0)=1
"RTN","PSBVDLU3",113,0)
 I $G(PSBDFN)']"" S RESULTS(0)=1,RESULTS(1)="-1^ERROR - MISSING PARAMETER (DFN REQ.)" Q
"RTN","PSBVDLU3",114,0)
 I $G(PSBTMFRM)="" S PSBX=3
"RTN","PSBVDLU3",115,0)
 I $G(PSBTMFRM)["X" S PSBX=+($P(PSBTMFRM,"X",2)),PSBTMFRM=""
"RTN","PSBVDLU3",116,0)
 I $G(PSBTMFRM)]"",$G(PSBTMFRM)'["FREQ" D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM),PSBSET=1 S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",117,0)
 I $G(PSBX)="" S PSBX=9999999
"RTN","PSBVDLU3",118,0)
 D:$G(PSBON)'=""
"RTN","PSBVDLU3",119,0)
 .K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",120,0)
 .;Maintain Time Frame and other order information
"RTN","PSBVDLU3",121,0)
 .I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",122,0)
 ..S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",123,0)
 ..I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",124,0)
 ..I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",125,0)
 ..I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",126,0)
 .I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",127,0)
 .S I="",X=0 F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",128,0)
 ..S Z=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S Z=Z+1 Q:Z>PSBX  D  Q:X
"RTN","PSBVDLU3",129,0)
 ...L +^PSB(53.79,J):DILOCKTM
"RTN","PSBVDLU3",130,0)
 ...I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",131,0)
 ...E  Q
"RTN","PSBVDLU3",132,0)
 ...I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",133,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",134,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",135,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",136,0)
 ....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",137,0)
 D:$G(PSBON)=""
"RTN","PSBVDLU3",138,0)
 .S Z="",X=0 F  S Z=$O(^PSB(53.79,"AORDX",PSBDFN,Z),-1)  Q:(Z="")  S PSBON=Z D  Q:X
"RTN","PSBVDLU3",139,0)
 ..;Maintain Time Frame and other order information
"RTN","PSBVDLU3",140,0)
 ..K ^TMP("PSJ",$J) D EN^PSJBCMA1(PSBDFN,PSBON)
"RTN","PSBVDLU3",141,0)
 ..I $G(PSBTMFRM)["FREQ" D
"RTN","PSBVDLU3",142,0)
 ...S PSBFRQ=+$P(^TMP("PSJ",$J,4),"^",11) I PSBFRQ=0 S PSBFRQ=1440
"RTN","PSBVDLU3",143,0)
 ...I "P^OC^O^"[($P(^TMP("PSJ",$J,4),"^")_"^") S PSBTMFRM=72 Q
"RTN","PSBVDLU3",144,0)
 ...I (PSBFRQ/60)<24 S PSBTMFRM=72 Q
"RTN","PSBVDLU3",145,0)
 ...I (PSBFRQ/60)'<24 S PSBTMFRM=(PSBFRQ/60)*3.5
"RTN","PSBVDLU3",146,0)
 ..I '$G(PSBSET) D NOW^%DTC S PSBNOW=% S PSBTMFRM=$$FMADD^XLFDT(PSBNOW,"",-1*PSBTMFRM) S RESULTS(1)="0^ None found after "_PSBTMFRM
"RTN","PSBVDLU3",147,0)
 ..S I="" F  S I=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I),-1)  Q:(I="")!(I<$S(PSBTMFRM]"":PSBTMFRM,1:-1))  D  Q:X
"RTN","PSBVDLU3",148,0)
 ...S ZZ=0,J="",PSBCNT=0 F  S J=$O(^PSB(53.79,"AORDX",PSBDFN,PSBON,I,J),-1)  Q:(J="")  S ZZ=ZZ+1 Q:ZZ>PSBX  D  Q:X
"RTN","PSBVDLU3",149,0)
 ....L +^PSB(53.79,J):DILOCKTM
"RTN","PSBVDLU3",150,0)
 ....I  L -^PSB(53.79,J)
"RTN","PSBVDLU3",151,0)
 ....E  Q
"RTN","PSBVDLU3",152,0)
 ....I ($P(^PSB(53.79,J,0),U,9)=PSBACT) S X=1 D
"RTN","PSBVDLU3",153,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.02)
"RTN","PSBVDLU3",154,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$P(^TMP("PSJ",$J,2),U,2)_"^"_($$GET1^DIQ(53.79,J_",",.11))
"RTN","PSBVDLU3",155,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.06,"I")
"RTN","PSBVDLU3",156,0)
 .....S PSBCNT=PSBCNT+1,RESULTS(PSBCNT)=$$GET1^DIQ(53.79,J_",",.13,"I")
"RTN","PSBVDLU3",157,0)
 I $G(PSBCNT)>0 S RESULTS(0)=PSBCNT
"RTN","PSBVDLU3",158,0)
 K ^TMP("PSJ",$J)
"RTN","PSBVDLU3",159,0)
 Q
"RTN","PSBVDLU3",160,0)
 ;
"RTN","PSBVDLU3",161,0)
SCANFAIL(RESULTS,PSBPARAM) ;  TEJ 05/12/2006  BCMA-Managing Scanning Failures (MSF)
"RTN","PSBVDLU3",162,0)
 ;       Document Unable to Scan Event
"RTN","PSBVDLU3",163,0)
 ;               Parameters:
"RTN","PSBVDLU3",164,0)
 ;               Input (via GUI):
"RTN","PSBVDLU3",165,0)
 ;
"RTN","PSBVDLU3",166,0)
 ;        Per Wristband  (0)      -       Pat IEN ^ ^ Reason Unable to Scan ^ User's Comment ^ "W" ^ 1 (keyed entry) or 2 (scanner)
"RTN","PSBVDLU3",167,0)
 ;        Per Medication (0)      -       Pat IEN ^ Order Number ^ Reason Unable to Scan ^ User's Comment ^ "M" ^ 1 (keyed entry) or 2 (scanner)
"RTN","PSBVDLU3",168,0)
 ;                       (1)      -       tag^ unique identifier
"RTN","PSBVDLU3",169,0)
 ;               Output:
"RTN","PSBVDLU3",170,0)
 ;                 Entry into database ^PSB(53.77)
"RTN","PSBVDLU3",171,0)
 ;                 Electronic Mail - Message Data per Unable to Scan Event
"RTN","PSBVDLU3",172,0)
 ;  PSB1 - Patient IEN
"RTN","PSBVDLU3",173,0)
 ;  PSB2 - Ward Location/Room
"RTN","PSBVDLU3",174,0)
 ;  PSB3 - Reason
"RTN","PSBVDLU3",175,0)
 ;  PSB4 - Type of Scan Issue
"RTN","PSBVDLU3",176,0)
 ;  PSB5 - Event date/item
"RTN","PSBVDLU3",177,0)
 ;  PSB6 - User's Comment
"RTN","PSBVDLU3",178,0)
 ;  PSB7 - User identification
"RTN","PSBVDLU3",179,0)
 ;  PSB8 - Order Number
"RTN","PSBVDLU3",180,0)
 ;                 RESULTS(0)=1
"RTN","PSBVDLU3",181,0)
 ;                 RESULTS(1)= 1 (Success) or -1 (Nonsuccess)
"RTN","PSBVDLU3",182,0)
 ;
"RTN","PSBVDLU3",183,0)
 K RESULTS,PSBSFUID,PSBMEDOI,PSBMEDNM
"RTN","PSBVDLU3",184,0)
 S RESULTS(0)=1,RESULTS(1)="-1^Unable to Scan documentation NOT successful!"
"RTN","PSBVDLU3",185,0)
 N PSBDAT,PSBDAT1,PSBXON,PSBSCHAD,PSBFILE
"RTN","PSBVDLU3",186,0)
 S PSBDAT=PSBPARAM(0) I $D(PSBPARAM(1)) S PSBDAT1=PSBPARAM(1)
"RTN","PSBVDLU3",187,0)
 S PSBXON=$P(PSBDAT,"^",2)
"RTN","PSBVDLU3",188,0)
 S PSB8=$G(PSBXON)
"RTN","PSBVDLU3",189,0)
 S (PSB1,PSBDFN)=$P(PSBDAT,"^")
"RTN","PSBVDLU3",190,0)
 ;
"RTN","PSBVDLU3",191,0)
 ; Changed the ward+room delimiter from / to $.
"RTN","PSBVDLU3",192,0)
 S PSB2=" *UNIDENTIFIABLE PATIENT* " I +$G(PSB1)>0 S PSB2=$$GET1^DIQ(2,PSB1_",",.1)_"$"_$$GET1^DIQ(2,PSB1_",",.101)
"RTN","PSBVDLU3",193,0)
 S PSB3=$P(PSBDAT,"^",3) I PSB3="Manual Medication Entry" S PSBMMEN=1
"RTN","PSBVDLU3",194,0)
 S PSB4=$S($P(PSBDAT,"^",5)="W":"Wristband",$P(PSBDAT,"^",5)="M":"Medication",1:" *UNDEFINED* ")
"RTN","PSBVDLU3",195,0)
 I PSB4="Medication"&($D(PSBDAT1)) D
"RTN","PSBVDLU3",196,0)
 .; Determine DD/ADD/SOL
"RTN","PSBVDLU3",197,0)
 .S PSBMEDOI=$P(PSBDAT1,"^",2)
"RTN","PSBVDLU3",198,0)
 .S PSBFILE=$P(PSBDAT1,"^"),PSBFILE=$S(PSBFILE="DD":50,PSBFILE="ADD":52.6,PSBFILE="SOL":52.7,1:PSBFILE)
"RTN","PSBVDLU3",199,0)
 .I PSBFILE'="ID" S PSBMEDNM=$$GET1^DIQ(PSBFILE,PSBMEDOI_",",.01)
"RTN","PSBVDLU3",200,0)
 .K PSBSFUID I PSBFILE="ID",(PSBMEDOI]"") S PSBSFUID=PSBMEDOI
"RTN","PSBVDLU3",201,0)
 D NOW^%DTC S (Y,PSB5A)=% D DD^%DT S PSB5=Y
"RTN","PSBVDLU3",202,0)
 S PSB6=$P(PSBDAT,"^",4)
"RTN","PSBVDLU3",203,0)
 S PSB7=". *UNDEFINED* " I $G(DUZ)>0 S PSB7=$$GET1^DIQ(200,DUZ_",",.01),PSB7A="`"_DUZ
"RTN","PSBVDLU3",204,0)
 ; Send message.
"RTN","PSBVDLU3",205,0)
 I $G(PSBMMEN)'=1,$P(PSBDAT,U,6)'=1,$P(PSBDAT,U,6)'=2 D MSFMSG^PSBMLU(PSB1,PSB2,PSB3,PSB4,PSB5,PSB6,PSB7,PSB8,.RESULTS)
"RTN","PSBVDLU3",206,0)
 I RESULTS(0)=-1 S RESULTS(0)=1,RESULTS(1)="-1^Unable to Scan MAILGROUP NOT SETUP!" Q
"RTN","PSBVDLU3",207,0)
 ;File data
"RTN","PSBVDLU3",208,0)
 D CLEAN^DILF
"RTN","PSBVDLU3",209,0)
 N PSBNEW1
"RTN","PSBVDLU3",210,0)
 S PSBNEW1="+1"
"RTN","PSBVDLU3",211,0)
 D
"RTN","PSBVDLU3",212,0)
 .I $G(PSBMMEN)=1 S PSBSCTYP="MMME" Q
"RTN","PSBVDLU3",213,0)
 .I $P(PSBDAT,U,6)=2 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WSCN",$P(PSBPARAM(0),"^",5)="M":"MSCN") Q
"RTN","PSBVDLU3",214,0)
 .I $P(PSBDAT,U,6)=1 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WKEY",$P(PSBPARAM(0),"^",5)="M":"MKEY") Q
"RTN","PSBVDLU3",215,0)
 .I $P(PSBDAT,U,6)=0 S PSBSCTYP=$S($P(PSBPARAM(0),"^",5)="W":"WUAS",$P(PSBPARAM(0),"^",5)="M":"MUAS")
"RTN","PSBVDLU3",216,0)
 ;
"RTN","PSBVDLU3",217,0)
FILESF ; File event.
"RTN","PSBVDLU3",218,0)
 D VAL^PSBML(53.77,"+1,",.01,PSB7A)
"RTN","PSBVDLU3",219,0)
 D VAL^PSBML(53.77,"+1,",.02,"`"_PSBDFN)
"RTN","PSBVDLU3",220,0)
 D VAL^PSBML(53.77,"+1,",.03,PSB2)
"RTN","PSBVDLU3",221,0)
 D VAL^PSBML(53.77,"+1,",.04,PSB5A)
"RTN","PSBVDLU3",222,0)
 D VAL^PSBML(53.77,"+1,",.05,PSBSCTYP)
"RTN","PSBVDLU3",223,0)
 D VAL^PSBML(53.77,"+1,",.06,PSB3)
"RTN","PSBVDLU3",224,0)
 D VAL^PSBML(53.77,"+1,",.07,$S($G(XMZ)]"":"`"_XMZ,1:""))
"RTN","PSBVDLU3",225,0)
 D VAL^PSBML(53.77,"+1,",.08,PSBXON)
"RTN","PSBVDLU3",226,0)
 D VAL^PSBML(53.77,"+1,",.09,PSB6)
"RTN","PSBVDLU3",227,0)
 D:$G(PSBFILE)=50
"RTN","PSBVDLU3",228,0)
 .D VAL^PSBML(53.771,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",229,0)
 .D VAL^PSBML(53.771,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",230,0)
 D:$G(PSBFILE)=52.6
"RTN","PSBVDLU3",231,0)
 .D VAL^PSBML(53.7711,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",232,0)
 .D VAL^PSBML(53.7711,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",233,0)
 D:$G(PSBFILE)=52.7
"RTN","PSBVDLU3",234,0)
 .D VAL^PSBML(53.7712,"+2,+1,",.01,"`"_PSBMEDOI)
"RTN","PSBVDLU3",235,0)
 .D VAL^PSBML(53.7712,"+2,+1,",1,PSBMEDNM)
"RTN","PSBVDLU3",236,0)
 I $G(PSBFILE)="ID" D VAL^PSBML(53.77,"+1,",14,PSBOIT),VAL^PSBML(53.77,"+1,",15,PSBOITX)
"RTN","PSBVDLU3",237,0)
 I $D(PSBSFUID) D VAL^PSBML(53.77,"+1,",13,PSBSFUID)
"RTN","PSBVDLU3",238,0)
 I $G(PSBFILE)="ID" D VAL^PSBML(53.77,"+1,",13,$S(PSBMEDOI']"":"WS",1:PSBMEDOI))
"RTN","PSBVDLU3",239,0)
 D UPDATE^DIE("","PSBFDA","PSBNEW1","PSBMSG")
"RTN","PSBVDLU3",240,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=2,RESULTS(1)="-1^MSF Filing ERROR! "_PSBMSG("DIERR","1","TEXT",1) Q
"RTN","PSBVDLU3",241,0)
 S RESULTS(0)=1,RESULTS(1)="1^Unable to Scan documentation successful!"
"RTN","PSBVDLU3",242,0)
 Q
"RTN","PSBVDLU3",243,0)
 ;
"RTN","PSBVDLU3",244,0)
CLEANMSF ;
"RTN","PSBVDLU3",245,0)
 ;  Clean-up
"RTN","PSBVDLU3",246,0)
 K PSBNEW1,PSB1,PSB2,PSB3,PSB4,PSB5,PSB6,PSB7,PSB8,XMZ
"RTN","PSBVDLU3",247,0)
 Q
"RTN","PSBVDLU3",248,0)
 ;
"RTN","PSBVDLU3",249,0)
SCANCNT(PSBTYP) ;
"RTN","PSBVDLU3",250,0)
 ;  Routine to count total scans (NO MAIL)
"RTN","PSBVDLU3",251,0)
 ;  Input: PSBTYP - "WSCN"/"MSCN"/"MMME"/"MKEY"/"WKEY"  
"RTN","PSBVDLU3",252,0)
 D CLEAN^DILF
"RTN","PSBVDLU3",253,0)
 N PSBNEW1
"RTN","PSBVDLU3",254,0)
 S PSBNEW1="+1"
"RTN","PSBVDLU3",255,0)
 D VAL^PSBML(53.77,"+1,",.01,"`"_".5")
"RTN","PSBVDLU3",256,0)
 D VAL^PSBML(53.77,"+1,",.05,PSBTYP)
"RTN","PSBVDLU3",257,0)
 D UPDATE^DIE("","PSBFDA","PSBNEW1","PSBMSG")
"RTN","PSBVDLU3",258,0)
 I $D(PSBNEW1(1)) S DIK="^PSB(53.77,",DA=PSBNEW1(1) D ^DIK
"RTN","PSBVDLU3",259,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=2,RESULTS(1)="-1^MSF Filing ERROR! "_PSBMSG("DIERR","1","TEXT",1) Q
"RTN","PSBVDLU3",260,0)
 S RESULTS(0)=1,RESULTS(1)="1^Unable to Scan documentation successful!"
"RTN","PSBVDLU3",261,0)
 Q
"RTN","PSBVDLU3",262,0)
 ;
"VER")
8.0^22.0
**END**
**END**
