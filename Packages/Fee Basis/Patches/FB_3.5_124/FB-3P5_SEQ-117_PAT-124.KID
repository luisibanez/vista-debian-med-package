Released FB*3.5*124 SEQ #117
Extracted from mail message
**KIDS**:FB*3.5*124^

**INSTALL NAME**
FB*3.5*124
"BLD",8675,0)
FB*3.5*124^FEE BASIS^0^3120511^y
"BLD",8675,1,0)
^^4^4^3120503^^^^
"BLD",8675,1,1,0)
VISTA FINANCIALS ANNUAL ENHANCEMENT 7 - FEE INVOICE DATE CONTROLS
"BLD",8675,1,2,0)
UPDATED TO INCLUDE PATCH 108 BUILD USER$:[THAYERC]FEE3_5P108T0307A.KID
"BLD",8675,1,3,0)
Also add 2 new routines (FBAACO1 and FBCHEP) for INPATIENT invoice  
"BLD",8675,1,4,0)
date validation.
"BLD",8675,4,0)
^9.64PA^^
"BLD",8675,6.3)
20
"BLD",8675,"ABPKG")
n
"BLD",8675,"INID")
n^n^n
"BLD",8675,"KRN",0)
^9.67PA^779.2^20
"BLD",8675,"KRN",.4,0)
.4
"BLD",8675,"KRN",.401,0)
.401
"BLD",8675,"KRN",.402,0)
.402
"BLD",8675,"KRN",.402,"NM",0)
^9.68A^2^2
"BLD",8675,"KRN",.402,"NM",1,0)
FBCH EDIT PAYMENT    FILE #162.5^162.5^0
"BLD",8675,"KRN",.402,"NM",2,0)
FBNH EDIT PAYMENT    FILE #162.5^162.5^0
"BLD",8675,"KRN",.402,"NM","B","FBCH EDIT PAYMENT    FILE #162.5",1)

"BLD",8675,"KRN",.402,"NM","B","FBNH EDIT PAYMENT    FILE #162.5",2)

"BLD",8675,"KRN",.403,0)
.403
"BLD",8675,"KRN",.5,0)
.5
"BLD",8675,"KRN",.84,0)
.84
"BLD",8675,"KRN",3.6,0)
3.6
"BLD",8675,"KRN",3.8,0)
3.8
"BLD",8675,"KRN",9.2,0)
9.2
"BLD",8675,"KRN",9.8,0)
9.8
"BLD",8675,"KRN",9.8,"NM",0)
^9.68A^13^12
"BLD",8675,"KRN",9.8,"NM",1,0)
FBAACO3^^0^B55394363
"BLD",8675,"KRN",9.8,"NM",2,0)
FBAACO5^^0^B6803212
"BLD",8675,"KRN",9.8,"NM",3,0)
FBAAEPI^^0^B20301979
"BLD",8675,"KRN",9.8,"NM",4,0)
FBAAPET^^0^B43544171
"BLD",8675,"KRN",9.8,"NM",5,0)
FBAAPIE^^0^B23308857
"BLD",8675,"KRN",9.8,"NM",6,0)
FBAAPIE1^^0^B16325296
"BLD",8675,"KRN",9.8,"NM",8,0)
FBCHPET^^0^B40446570
"BLD",8675,"KRN",9.8,"NM",9,0)
FBNHEDPA^^0^B15541684
"BLD",8675,"KRN",9.8,"NM",10,0)
FBAACO1^^0^B49387409
"BLD",8675,"KRN",9.8,"NM",11,0)
FBCHEP^^0^B33379064
"BLD",8675,"KRN",9.8,"NM",12,0)
FBCHEP1^^0^B39779983
"BLD",8675,"KRN",9.8,"NM",13,0)
FBAAUTL^^0^B25814851
"BLD",8675,"KRN",9.8,"NM","B","FBAACO1",10)

"BLD",8675,"KRN",9.8,"NM","B","FBAACO3",1)

"BLD",8675,"KRN",9.8,"NM","B","FBAACO5",2)

"BLD",8675,"KRN",9.8,"NM","B","FBAAEPI",3)

"BLD",8675,"KRN",9.8,"NM","B","FBAAPET",4)

"BLD",8675,"KRN",9.8,"NM","B","FBAAPIE",5)

"BLD",8675,"KRN",9.8,"NM","B","FBAAPIE1",6)

"BLD",8675,"KRN",9.8,"NM","B","FBAAUTL",13)

"BLD",8675,"KRN",9.8,"NM","B","FBCHEP",11)

"BLD",8675,"KRN",9.8,"NM","B","FBCHEP1",12)

"BLD",8675,"KRN",9.8,"NM","B","FBCHPET",8)

"BLD",8675,"KRN",9.8,"NM","B","FBNHEDPA",9)

"BLD",8675,"KRN",19,0)
19
"BLD",8675,"KRN",19,"NM",0)
^9.68A^^
"BLD",8675,"KRN",19.1,0)
19.1
"BLD",8675,"KRN",101,0)
101
"BLD",8675,"KRN",409.61,0)
409.61
"BLD",8675,"KRN",771,0)
771
"BLD",8675,"KRN",779.2,0)
779.2
"BLD",8675,"KRN",870,0)
870
"BLD",8675,"KRN",8989.51,0)
8989.51
"BLD",8675,"KRN",8989.52,0)
8989.52
"BLD",8675,"KRN",8994,0)
8994
"BLD",8675,"KRN","B",.4,.4)

"BLD",8675,"KRN","B",.401,.401)

"BLD",8675,"KRN","B",.402,.402)

"BLD",8675,"KRN","B",.403,.403)

"BLD",8675,"KRN","B",.5,.5)

"BLD",8675,"KRN","B",.84,.84)

"BLD",8675,"KRN","B",3.6,3.6)

"BLD",8675,"KRN","B",3.8,3.8)

"BLD",8675,"KRN","B",9.2,9.2)

"BLD",8675,"KRN","B",9.8,9.8)

"BLD",8675,"KRN","B",19,19)

"BLD",8675,"KRN","B",19.1,19.1)

"BLD",8675,"KRN","B",101,101)

"BLD",8675,"KRN","B",409.61,409.61)

"BLD",8675,"KRN","B",771,771)

"BLD",8675,"KRN","B",779.2,779.2)

"BLD",8675,"KRN","B",870,870)

"BLD",8675,"KRN","B",8989.51,8989.51)

"BLD",8675,"KRN","B",8989.52,8989.52)

"BLD",8675,"KRN","B",8994,8994)

"BLD",8675,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8675,"QUES",0)
^9.62^^
"BLD",8675,"REQB",0)
^9.611^2^2
"BLD",8675,"REQB",1,0)
FB*3.5*108^2
"BLD",8675,"REQB",2,0)
FB*3.5*79^2
"BLD",8675,"REQB","B","FB*3.5*108",1)

"BLD",8675,"REQB","B","FB*3.5*79",2)

"KRN",.402,363,-1)
0^1
"KRN",.402,363,0)
FBCH EDIT PAYMENT^3120416.1333^^162.5^^^3120508
"KRN",.402,363,"DIAB",2,0,162.5,4)
24.5;REQ
"KRN",.402,363,"DIAB",2,0,162.5,9)
35.32;REQ
"KRN",.402,363,"DIAB",2,0,162.5,11)
35.62;REQ
"KRN",.402,363,"DIAB",2,0,162.5,13)
35.92;REQ
"KRN",.402,363,"DIAB",2,0,162.5,15)
36.22;REQ
"KRN",.402,363,"DIAB",2,0,162.5,17)
36.52;REQ
"KRN",.402,363,"DIAB",2,0,162.5,19)
36.82;REQ
"KRN",.402,363,"DIAB",3,0,162.5,7)
35.02;REQ
"KRN",.402,363,"DIAB",6,0,162.5,4)
30.02;REQ
"KRN",.402,363,"DIAB",6,0,162.5,5)
32.02;REQ
"KRN",.402,363,"DIAB",7,0,162.5,10)
35.52;REQ
"KRN",.402,363,"DIAB",7,0,162.5,12)
35.82;REQ
"KRN",.402,363,"DIAB",7,0,162.5,14)
36.12;REQ
"KRN",.402,363,"DIAB",7,0,162.5,16)
36.42;REQ
"KRN",.402,363,"DIAB",7,0,162.5,18)
36.72;REQ
"KRN",.402,363,"DIAB",9,0,162.5,8)
35.22;REQ
"KRN",.402,363,"DIAB",10,0,162.5,3)
24;REQ
"KRN",.402,363,"DIAB",10,0,162.5,6)
34.02;REQ
"KRN",.402,363,"DIAB",11,0,162.5,4)
31.02;REQ
"KRN",.402,363,"DIAB",12,0,162.5,9)
35.42;REQ
"KRN",.402,363,"DIAB",12,0,162.5,11)
35.72;REQ
"KRN",.402,363,"DIAB",12,0,162.5,13)
36.02;REQ
"KRN",.402,363,"DIAB",12,0,162.5,15)
36.32;REQ
"KRN",.402,363,"DIAB",12,0,162.5,17)
36.62;REQ
"KRN",.402,363,"DIAB",12,0,162.5,19)
36.92;REQ
"KRN",.402,363,"DIAB",13,0,162.5,7)
35.12;REQ
"KRN",.402,363,"DIAB",16,0,162.5,5)
33.02;REQ
"KRN",.402,363,"DR",1,162.5)
@1;1;I 1;I $$BADDATE^FBCHEP1(X,DA) S Y="@1";46;55;S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="" Y="@10";56///^S X=FBX;S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL,1);S:FBX=-1 Y=0;57///^S X=FBX;S FBFPPSL=X;S Y="@14";@10;56///@;
"KRN",.402,363,"DR",1,162.5,1)
S FBFPPSC="";57///@;S FBFPPSL="";@14;S FBV=$P($G(^FBAAI(DA,0)),U,3);S FBAAMM=$S($G(FBAAPTC)="R":"",$D(FB583):"",1:1);D PPT^FBAACO1($G(FBAAMM1),$G(FBCNTRP));47////@;47///^S X=FBAAMM1;60///@;60////^S X=$G(FBCNTRP);6.5;54;6.6;I 1;6.7;
"KRN",.402,363,"DR",1,162.5,2)
64;65;66;67;68;69;70;71;72;73;80;81;82;83;74;75;S DIE("NO^")="NO QUIT";7;S:$D(FBPRICE) Y="@20";S FBJJ=X;I $G(FBEXMPT)="Y" S Y="@16";26;S FBPAMT=X;@16;W:FB1725 !?2,"**Payment is for emergency treatment under 38 U.S.C. 1725.";
"KRN",.402,363,"DR",1,162.5,3)
W:FB1725&($G(FBPAMT)>0) !?2,"  70% of Pricer Amount = "_$J(.7*FBPAMT,0,2);8;S FBKK=X;K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(FBJJ-FBKK,.FBADJ,1,,.FBADJD,1);K FBADJD;I $G(FBEXMPT)="Y" S Y=30;@18;24R~;
"KRN",.402,363,"DR",1,162.5,4)
I $$INPICD^FBCSV1(X,$G(DA)) S Y="@18";24.5R~;@20;30;S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@20";30.02R~;@22;31;S:X="" Y="@23";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@22";31.02R~;S:$G(LASTDX)<2 LASTDX=2;S Y="@24";@23;31.02///@;
"KRN",.402,363,"DR",1,162.5,5)
S:$G(LASTDX)'>2 Y="@70";@24;32;S:X="" Y="@25";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@24";32.02R~;S:$G(LASTDX)<3 LASTDX=3;S Y="@26";@25;32.02///@;S:$G(LASTDX)'>3 Y="@70";@26;33;S:X="" Y="@27";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@26";33.02R~;
"KRN",.402,363,"DR",1,162.5,6)
S:$G(LASTDX)<4 LASTDX=4;S Y="@28";@27;33.02///@;S:$G(LASTDX)'>4 Y="@70";@28;34;S:X="" Y="@29";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@28";34.02R~;S:$G(LASTDX)<5 LASTDX=5;S Y="@30";@29;34.02///@;S:$G(LASTDX)'>5 Y="@70";@30;35;
"KRN",.402,363,"DR",1,162.5,7)
S:X="" Y="@31";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@30";35.02R~;S:$G(LASTDX)<6 LASTDX=6;S Y="@32";@31;35.02///@;S:$G(LASTDX)'>6 Y="@70";@32;35.1;S:X="" Y="@33";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@32";35.12R~;S:$G(LASTDX)<7 LASTDX=7;
"KRN",.402,363,"DR",1,162.5,8)
S Y="@34";@33;35.12///@;S:$G(LASTDX)'>7 Y="@70";@34;35.2;S:X="" Y="@35";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@34";35.22R~;S:$G(LASTDX)<8 LASTDX=8;S Y="@36";@35;35.22///@;S:$G(LASTDX)'>8 Y="@70";@36;35.3;S:X="" Y="@37";
"KRN",.402,363,"DR",1,162.5,9)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@36";35.32R~;S:$G(LASTDX)<9 LASTDX=9;S Y="@38";@37;35.32///@;S:$G(LASTDX)'>9 Y="@70";@38;35.4;S:X="" Y="@39";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@38";35.42R~;S:$G(LASTDX)<10 LASTDX=10;S Y="@40";@39;
"KRN",.402,363,"DR",1,162.5,10)
35.42///@;S:$G(LASTDX)'>10 Y="@70";@40;35.5;S:X="" Y="@41";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@40";35.52R~;S:$G(LASTDX)<11 LASTDX=11;S Y="@42";@41;35.52///@;S:$G(LASTDX)'>11 Y="@70";@42;35.6;S:X="" Y="@43";
"KRN",.402,363,"DR",1,162.5,11)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@42";35.62R~;S:$G(LASTDX)<12 LASTDX=12;S Y="@44";@43;35.62///@;S:$G(LASTDX)'>12 Y="@70";@44;35.7;S:X="" Y="@45";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@44";35.72R~;S:$G(LASTDX)<13 LASTDX=13;S Y="@46";@45;
"KRN",.402,363,"DR",1,162.5,12)
35.72///@;S:$G(LASTDX)'>13 Y="@70";@46;35.8;S:X="" Y="@47";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@46";35.82R~;S:$G(LASTDX)<14 LASTDX=14;S Y="@48";@47;35.82///@;S:$G(LASTDX)'>14 Y="@70";@48;35.9;S:X="" Y="@49";
"KRN",.402,363,"DR",1,162.5,13)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@48";35.92R~;S:$G(LASTDX)<15 LASTDX=15;S Y="@50";@49;35.92///@;S:$G(LASTDX)'>15 Y="@70";@50;36;S:X="" Y="@51";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@50";36.02R~;S:$G(LASTDX)<16 LASTDX=16;S Y="@52";@51;
"KRN",.402,363,"DR",1,162.5,14)
36.02///@;S:$G(LASTDX)'>16 Y="@70";@52;36.1;S:X="" Y="@53";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@52";36.12R~;S:$G(LASTDX)<17 LASTDX=17;S Y="@54";@53;36.12///@;S:$G(LASTDX)'>17 Y="@70";@54;36.2;S:X="" Y="@55";
"KRN",.402,363,"DR",1,162.5,15)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@54";36.22R~;S:$G(LASTDX)<18 LASTDX=18;S Y="@56";@55;36.22///@;S:$G(LASTDX)'>18 Y="@70";@56;36.3;S:X="" Y="@57";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@56";36.32R~;S:$G(LASTDX)<19 LASTDX=19;S Y="@58";@57;
"KRN",.402,363,"DR",1,162.5,16)
36.32///@;S:$G(LASTDX)'>19 Y="@70";@58;36.4;S:X="" Y="@59";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@58";36.42R~;S:$G(LASTDX)<20 LASTDX=20;S Y="@60";@59;36.42///@;S:$G(LASTDX)'>20 Y="@70";@60;36.5;S:X="" Y="@61";
"KRN",.402,363,"DR",1,162.5,17)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@60";36.52R~;S:$G(LASTDX)<21 LASTDX=21;S Y="@62";@61;36.52///@;S:$G(LASTDX)'>21 Y="@70";@62;36.6;S:X="" Y="@63";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@62";36.62R~;S:$G(LASTDX)<22 LASTDX=22;S Y="@64";@63;
"KRN",.402,363,"DR",1,162.5,18)
36.62///@;S:$G(LASTDX)'>22 Y="@70";@64;36.7;S:X="" Y="@65";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@64";36.72R~;S:$G(LASTDX)<23 LASTDX=23;S Y="@66";@65;36.72///@;S:$G(LASTDX)'>23 Y="@70";@66;36.8;S:X="" Y="@67";
"KRN",.402,363,"DR",1,162.5,19)
S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@66";36.82R~;S:$G(LASTDX)<24 LASTDX=24;S Y="@68";@67;36.82///@;S:$G(LASTDX)'>24 Y="@70";@68;36.9;S:X="" Y="@69";S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@68";36.92R~;S:$G(LASTDX)<25 LASTDX=25;S Y="@70";@69;
"KRN",.402,363,"DR",1,162.5,20)
36.92///@;@70;39;S:$$INPICD9^FBCSV1(X,$G(DA)) Y="@70";@71;40;S:X="" Y=$S($G(LASTPROC)>1:"@72",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@71";S:$G(LASTPROC)<1 LASTPROC=1;@72;41;S:X="" Y=$S($G(LASTPROC)>2:"@73",1:"@99");
"KRN",.402,363,"DR",1,162.5,21)
S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@72";S:$G(LASTPROC)<2 LASTPROC=2;@73;42;S:X="" Y=$S($G(LASTPROC)>3:"@74",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@73";S:$G(LASTPROC)<3 LASTPROC=3;@74;43;S:X="" Y=$S($G(LASTPROC)>4:"@75",1:"@99");
"KRN",.402,363,"DR",1,162.5,22)
S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@74";S:$G(LASTPROC)<4 LASTPROC=4;@75;44;S:X="" Y=$S($G(LASTPROC)>5:"@76",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@75";S:$G(LASTPROC)<5 LASTPROC=5;@76;44.06;S:X="" Y=$S($G(LASTPROC)>6:"@77",1:"@99");
"KRN",.402,363,"DR",1,162.5,23)
S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@76";S:$G(LASTPROC)<6 LASTPROC=6;@77;44.07;S:X="" Y=$S($G(LASTPROC)>7:"@78",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@77";S:$G(LASTPROC)<7 LASTPROC=7;@78;44.08;
"KRN",.402,363,"DR",1,162.5,24)
S:X="" Y=$S($G(LASTPROC)>8:"@79",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@78";S:$G(LASTPROC)<8 LASTPROC=8;@79;44.09;S:X="" Y=$S($G(LASTPROC)>9:"@80",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@79";S:$G(LASTPROC)<9 LASTPROC=9;@80;
"KRN",.402,363,"DR",1,162.5,25)
44.1;S:X="" Y=$S($G(LASTPROC)>10:"@81",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@80";S:$G(LASTPROC)<10 LASTPROC=10;@81;44.11;S:X="" Y=$S($G(LASTPROC)>11:"@82",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@81";
"KRN",.402,363,"DR",1,162.5,26)
S:$G(LASTPROC)<11 LASTPROC=11;@82;44.12;S:X="" Y=$S($G(LASTPROC)>12:"@83",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@82";S:$G(LASTPROC)<12 LASTPROC=12;@83;44.13;S:X="" Y=$S($G(LASTPROC)>13:"@84",1:"@99");
"KRN",.402,363,"DR",1,162.5,27)
S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@83";S:$G(LASTPROC)<13 LASTPROC=13;@84;44.14;S:X="" Y=$S($G(LASTPROC)>14:"@85",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@84";S:$G(LASTPROC)<14 LASTPROC=14;@85;44.15;
"KRN",.402,363,"DR",1,162.5,28)
S:X="" Y=$S($G(LASTPROC)>15:"@86",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@85";S:$G(LASTPROC)<15 LASTPROC=15;@86;44.16;S:X="" Y=$S($G(LASTPROC)>16:"@87",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@86";S:$G(LASTPROC)<16 LASTPROC=16;
"KRN",.402,363,"DR",1,162.5,29)
@87;44.17;S:X="" Y=$S($G(LASTPROC)>17:"@88",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@87";S:$G(LASTPROC)<17 LASTPROC=17;@88;44.18;S:X="" Y=$S($G(LASTPROC)>18:"@89",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@88";
"KRN",.402,363,"DR",1,162.5,30)
S:$G(LASTPROC)<18 LASTPROC=18;@89;44.19;S:X="" Y=$S($G(LASTPROC)>19:"@90",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@89";S:$G(LASTPROC)<19 LASTPROC=19;@90;44.2;S:X="" Y=$S($G(LASTPROC)>20:"@91",1:"@99");
"KRN",.402,363,"DR",1,162.5,31)
S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@90";S:$G(LASTPROC)<20 LASTPROC=20;@91;44.21;S:X="" Y=$S($G(LASTPROC)>21:"@92",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@91";S:$G(LASTPROC)<21 LASTPROC=21;@92;44.22;
"KRN",.402,363,"DR",1,162.5,32)
S:X="" Y=$S($G(LASTPROC)>22:"@93",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@92";S:$G(LASTPROC)<22 LASTPROC=22;@93;44.23;S:X="" Y=$S($G(LASTPROC)>23:"@94",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@93";S:$G(LASTPROC)<23 LASTPROC=23;
"KRN",.402,363,"DR",1,162.5,33)
@94;44.24;S:X="" Y=$S($G(LASTPROC)>24:"@95",1:"@99");S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@94";S:$G(LASTPROC)<24 LASTPROC=24;@95;44.25;S:X="" Y="@99";S:$$INPICD0^FBCSV1(X,$G(DA)) Y="@95";S:$G(LASTPROC)<25 LASTPROC=25;@99;K FBPROVD;
"KRN",.402,363,"DR",1,162.5,34)
M FBPROVD=FBPROV;S FBX=$$RPROV^FBUTL8(.FBPROV,.FBPROVD);K FBPROVD;S:$D(FBPRICE) Y="@992";K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD);K FBRRMKD;@992;K FBJJ,FBKK,DIE("NO^"),FBX;
"KRN",.402,690,-1)
0^2
"KRN",.402,690,0)
FBNH EDIT PAYMENT^3111212.1613^^162.5^^^3120502
"KRN",.402,690,"DIAB",3,0,162.5,0)
1;"(whichever is later)"
"KRN",.402,690,"DIAB",4,0,162.5,4)
20;REQ
"KRN",.402,690,"DIAB",5,0,162.5,4)
21;REQ
"KRN",.402,690,"DIAB",6,0,162.5,4)
22;REQ
"KRN",.402,690,"DIAB",7,0,162.5,4)
23;REQ
"KRN",.402,690,"DR",1,162.5)
@1;W !!,"Enter Date Correct Invoice Received or Last Date of Service";1(whichever is later)~;S INVRDATE=X I $$BADDATE^FBNHEDPA(X,DA) S Y="@1";46;55;S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y="@11";S:FBX="" Y="@10";56///^S X=FBX;
"KRN",.402,690,"DR",1,162.5,1)
S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL,1,1);57///^S X=FBX;S FBFPPSL=X;S Y="@11";@10;56///@;S FBFPPSC="";57///@;S FBFPPSL="";@11;2;3;@5;5;I $$BADTDATE^FBNHEDPA(X,INVRDATE,"FROM") S Y="@5";@6;6;
"KRN",.402,690,"DR",1,162.5,2)
I $P(^FBAAI(DA,0),U,6)>X W !,*7,"To date cannot be before from date.",! S Y=5;I $$BADTDATE^FBNHEDPA(X,INVRDATE,"TO") S Y="@6";54;@12;S FBHAC=$P(^FBAAI(DA,0),U,8);7;S FBAC=X;S FBHAP=$P(^FBAAI(DA,0),U,9);8;S FBAP=X;
"KRN",.402,690,"DR",1,162.5,3)
I FBAP>FBAC S $P(^FBAAI(DA,0),U,9)=FBHAP,$P(^(0),U,8)=FBHAC W !,*7,"Amount Paid cannot be greater than the Amount Claimed" S Y="@12";S FBBAL=FBAC-FBAP;Q;K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(FBAC-FBAP,.FBADJ,1,,.FBADJD,1);
"KRN",.402,690,"DR",1,162.5,4)
K FBADJD;12////^S X="V";S DIE("NO^")="OUTOK";20R~;21R~;22R~;23R~;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD);K FBRRMKD;
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",60,-1)
1^1
"PKG",60,0)
FEE BASIS^FB^Used to pay private vendors
"PKG",60,20,0)
^9.402P^1^1
"PKG",60,20,1,0)
2^^FBPMRG
"PKG",60,20,1,1)

"PKG",60,20,"B",2,1)

"PKG",60,22,0)
^9.49I^1^1
"PKG",60,22,1,0)
3.5^2950130^2950313
"PKG",60,22,1,"PAH",1,0)
124^3120511
"PKG",60,22,1,"PAH",1,1,0)
^^4^4^3120511
"PKG",60,22,1,"PAH",1,1,1,0)
VISTA FINANCIALS ANNUAL ENHANCEMENT 7 - FEE INVOICE DATE CONTROLS
"PKG",60,22,1,"PAH",1,1,2,0)
UPDATED TO INCLUDE PATCH 108 BUILD USER$:[THAYERC]FEE3_5P108T0307A.KID
"PKG",60,22,1,"PAH",1,1,3,0)
Also add 2 new routines (FBAACO1 and FBCHEP) for INPATIENT invoice  
"PKG",60,22,1,"PAH",1,1,4,0)
date validation.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","FBAACO1")
0^10^B49387409^B42250975
"RTN","FBAACO1",1,0)
FBAACO1 ;AISC/GRR - ENTER PAYMENT CONTINUED ;6/25/2009
"RTN","FBAACO1",2,0)
 ;;3.5;FEE BASIS;**4,61,77,108,124**;JAN 30, 1995;Build 20
"RTN","FBAACO1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAACO1",4,0)
SVCPR ;set up service provided multiple
"RTN","FBAACO1",5,0)
 I '$D(^FBAAC(DFN,1,FBV,1,FBSDI,1,0)) S ^FBAAC(DFN,1,FBV,1,FBSDI,1,0)="^162.03A^0^0"
"RTN","FBAACO1",6,0)
 W ! S DLAYGO=162,DIC="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",DIC(0)=$S($G(FBCNP):"QL",1:"EQL"),X=""""_FBX_"""",DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI
"RTN","FBAACO1",7,0)
 D
"RTN","FBAACO1",8,0)
 . N ICPTVDT S ICPTVDT=$G(FBAADT) D ^DIC
"RTN","FBAACO1",9,0)
 K DIC,DLAYGO,DA I Y<0 S FBAAOUT=1 Q
"RTN","FBAACO1",10,0)
 S (FBAACPI,DA)=+Y
"RTN","FBAACO1",11,0)
 ;
"RTN","FBAACO1",12,0)
 ; update zip code and anesthesia time
"RTN","FBAACO1",13,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"
"RTN","FBAACO1",14,0)
 K DA S DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI,DA=FBAACPI
"RTN","FBAACO1",15,0)
 S DR="42////^S X=$G(FBZIP);43////^S X=$G(FBTIME)"
"RTN","FBAACO1",16,0)
 D ^DIE K DIE,DA,DR
"RTN","FBAACO1",17,0)
 ;
"RTN","FBAACO1",18,0)
 ; create CPT MODIFIER entries from data in array FBMODA
"RTN","FBAACO1",19,0)
 D REPMOD^FBAAUTL4(DFN,FBV,FBSDI,FBAACPI)
"RTN","FBAACO1",20,0)
 ;
"RTN","FBAACO1",21,0)
 Q
"RTN","FBAACO1",22,0)
 ;
"RTN","FBAACO1",23,0)
PPT(FBDEF,FBDEFC,FB162) ;establishes prompt pay type and contract for entry
"RTN","FBAACO1",24,0)
 ; input
"RTN","FBAACO1",25,0)
 ;   FBDEF  = (optional) default for DIR prompt: =1 for yes, else no
"RTN","FBAACO1",26,0)
 ;   FBDEFC = (optional) default for the contract prompt
"RTN","FBAACO1",27,0)
 ;   FBAAMM = ppt if 1 ask for each line item; if 0 don't ask
"RTN","FBAACO1",28,0)
 ;   FBV    = vendor (ien) being paid
"RTN","FBAACO1",29,0)
 ;   FBVEN  = vendor (ien) from authorization
"RTN","FBAACO1",30,0)
 ;   FBCNTRA= contract (ien) from authorization
"RTN","FBAACO1",31,0)
 ;   FB583  = (optional) $D(FB583) true if unauthorized claim
"RTN","FBAACO1",32,0)
 ;   FB162  = (optional) = 1 if payment line item in sub-file 162.03 is being edited.  FBDEF and FBDEFC must be current values.
"RTN","FBAACO1",33,0)
 ; output
"RTN","FBAACO1",34,0)
 ;   FBAAMM1 = the ppt for the line item
"RTN","FBAACO1",35,0)
 ;   FBCNTRP = contract ien for the line item
"RTN","FBAACO1",36,0)
 N Y
"RTN","FBAACO1",37,0)
 S (FBAAMM1,FBCNTRP)=""
"RTN","FBAACO1",38,0)
 I FBAAMM="" Q
"RTN","FBAACO1",39,0)
 S:'$D(FBV) FBV=$G(FBVEN)  ;SOMETIMES FBV DOES NOT EXIST BUT FBVEN IS SET EQUAL TO THE VENDOR IN FBCH ENTER PAYMENT
"RTN","FBAACO1",40,0)
 I FBAAMM=1,'$D(FB583),$$UCFA^FBUTL7($G(FBV),$G(FBVEN),$G(FBCNTRA)) D  Q
"RTN","FBAACO1",41,0)
 . W !,"Contract is ",$P($G(^FBAA(161.43,FBCNTRA,0)),U)," from the authorization."
"RTN","FBAACO1",42,0)
 . S FBAAMM1=1
"RTN","FBAACO1",43,0)
 . S FBCNTRP=FBCNTRA
"RTN","FBAACO1",44,0)
 I FBAAMM=1 D
"RTN","FBAACO1",45,0)
 . ;if editing line in file 162 contracted services can't be changed
"RTN","FBAACO1",46,0)
 . I $G(FB162)=1 D
"RTN","FBAACO1",47,0)
 .. W !,"Invoice ",$S(FBDEF=1:"is",1:"is not")," for contracted services."
"RTN","FBAACO1",48,0)
 .. S Y=$S(FBDEF=1:1,1:0)
"RTN","FBAACO1",49,0)
 . ;if not editing line in file 162 contracted services can be changed
"RTN","FBAACO1",50,0)
 . I $G(FB162)'=1 F  D  Q:Y]""
"RTN","FBAACO1",51,0)
 . . S DIR(0)="Y",DIR("A")="Is this line item for a contracted service"
"RTN","FBAACO1",52,0)
 . . S DIR("B")=$S($G(FBDEF)=1:"Yes",1:"No")
"RTN","FBAACO1",53,0)
 . . S DIR("?")="Answering no indicates that interest will not be paid for this line item."
"RTN","FBAACO1",54,0)
 . . D ^DIR K DIR I $D(DIRUT) W !,$C(7),"Required Response!" S Y=""
"RTN","FBAACO1",55,0)
 . S FBAAMM1=$S(Y=1:1,1:"")
"RTN","FBAACO1",56,0)
 . Q:FBAAMM1=""
"RTN","FBAACO1",57,0)
 . ;
"RTN","FBAACO1",58,0)
 . S DIR(0)="PO^161.43:AQEM"
"RTN","FBAACO1",59,0)
 . S DIR("A")="CONTRACT"
"RTN","FBAACO1",60,0)
 . S DIR("?",1)="If the line item is under a contract then select it."
"RTN","FBAACO1",61,0)
 . S DIR("?")="Contract must be active and applicable for the vendor."
"RTN","FBAACO1",62,0)
 . S DIR("S")="I $P($G(^(0)),""^"",2)'=""I"",$$VCNTR^FBUTL7($G(FBV),+Y)"
"RTN","FBAACO1",63,0)
 . S:$G(FBDEFC) DIR("B")=$P($G(^FBAA(161.43,FBDEFC,0)),U)
"RTN","FBAACO1",64,0)
 . D ^DIR K DIR
"RTN","FBAACO1",65,0)
 . ; if time-out or '^' and has default value (i.e. edit payment)
"RTN","FBAACO1",66,0)
 . ;   return default so existing payment is not altered
"RTN","FBAACO1",67,0)
 . I $D(DTOUT)!$D(DUOUT),$G(FBDEFC)>0 S FBCNTRP=FBDEFC Q
"RTN","FBAACO1",68,0)
 . I Y>0 S FBCNTRP=+Y
"RTN","FBAACO1",69,0)
 Q
"RTN","FBAACO1",70,0)
 ;
"RTN","FBAACO1",71,0)
Q K FBAADT,FBX,FBAACP W:FBINTOT>0 !!,"Invoice: "_FBAAIN_"  Totals $ "_$J(FBINTOT,1,2) G Q^FBAACO:$D(FB583),1^FBAACO:'$D(FBCHCO) Q
"RTN","FBAACO1",72,0)
 ;
"RTN","FBAACO1",73,0)
POS ; prompt for place of service
"RTN","FBAACO1",74,0)
 ; output
"RTN","FBAACO1",75,0)
 ;   FBHCFA(30) = place of service (internal)
"RTN","FBAACO1",76,0)
 N Y
"RTN","FBAACO1",77,0)
 S FBHCFA(30)=""
"RTN","FBAACO1",78,0)
 S DIR(0)="P^353.1:EMZ"
"RTN","FBAACO1",79,0)
 D ^DIR K DIR I $D(DIRUT) Q
"RTN","FBAACO1",80,0)
 S FBHCFA(30)=$P(Y,U)
"RTN","FBAACO1",81,0)
 Q
"RTN","FBAACO1",82,0)
 ;
"RTN","FBAACO1",83,0)
GETVEN ;select vendor from vendor file
"RTN","FBAACO1",84,0)
 W !! S DLAYGO=161.2,DIC="^FBAAV(",DIC(0)="AEQLM" D ^DIC K DLAYGO I X="^"!(X="") S FBAAOUT=1 Q
"RTN","FBAACO1",85,0)
 ;if new vendor, call in to new vendor setup routine
"RTN","FBAACO1",86,0)
 G GETVEN:Y<0 S DA=+Y,DIE=DIC D:$P(Y,"^",3)=1 NEW^FBAAVD K DIE,DIC,DR,X,DLAYGO
"RTN","FBAACO1",87,0)
GETVEN1 I $D(FB583) S DA=FBVEN
"RTN","FBAACO1",88,0)
 I $D(^FBAAV(DA,0)),$P($G(^("ADEL")),U)="Y" W !!,$C(7),"Vendor has been flagged for Austin deletion!" G GETVEN:'$D(FB583) S FBAAOUT=1 Q
"RTN","FBAACO1",89,0)
 D:$P(FBSITE(0),"^",11)="Y" EN1^FBAAVD
"RTN","FBAACO1",90,0)
GETVEN2 I $P(FBSITE(0),"^",11)="Y",$D(^XUSEC("FBAA ESTABLISH VENDOR",DUZ)) S DIR(0)="Y",DIR("A")="Want to Edit data",DIR("B")="NO" D ^DIR K DIR S:$D(DIRUT) FBAAOUT=1 Q:$D(DIRUT)  D:Y EDITV^FBAAVD
"RTN","FBAACO1",91,0)
 I $P(FBSITE(0),"^",11)'="Y"!('$D(^XUSEC("FBAA ESTABLISH VENDOR",DUZ))) S DIR(0)="E" D ^DIR K DIR I $D(DIRUT) S FBAAOUT=1 Q
"RTN","FBAACO1",92,0)
 S FBV=DA,FBAR(DA)="" D ^FBAACO4
"RTN","FBAACO1",93,0)
 Q
"RTN","FBAACO1",94,0)
 ;
"RTN","FBAACO1",95,0)
GETINV ;assign invoice number or select existing invoice number
"RTN","FBAACO1",96,0)
 K FBAAOUT S FBINTOT=0 S DIR(0)="Y",DIR("A")="Want a new Invoice number assigned",DIR("B")="YES" D ^DIR K DIR I $D(DIRUT) S FBAAOUT=1 Q
"RTN","FBAACO1",97,0)
 I Y D GETNXI^FBAAUTL W !!,"Invoice # ",FBAAIN," assigned to this Invoice" Q
"RTN","FBAACO1",98,0)
GETINV1 ;selects existing invoice if user does not choose to assign new number
"RTN","FBAACO1",99,0)
 S DIR(0)="N",DIR("A")="Select Invoice number",DIR("?")="Select one of the previously entered Invoice #'s" D ^DIR K DIR I $D(DIRUT)!(X="") G GETINV:'$G(FB583) S FBAAOUT=1 Q
"RTN","FBAACO1",100,0)
 D CHK1^FBAACO4 G GETINV1:'$G(FBAACK1) K FBAACK1
"RTN","FBAACO1",101,0)
 I '$D(^FBAAC("AJ",FBAABE,X)) D  G GETINV1
"RTN","FBAACO1",102,0)
 . W !,$C(7),"Only previously entered invoices in the same batch may be selected!"
"RTN","FBAACO1",103,0)
 S FBAAIN=X D CALC^FBAACO3 W:FBINTOT>0 ?33,"Current Total: $ "_$J(FBINTOT,1,2)
"RTN","FBAACO1",104,0)
 Q
"RTN","FBAACO1",105,0)
 ;
"RTN","FBAACO1",106,0)
GETINDT ;get invoice dates
"RTN","FBAACO1",107,0)
 ;input requires FBAABDT (authorization from date)
"RTN","FBAACO1",108,0)
 K FBAAOUT W !,"Enter Date Correct Invoice Received or Last Date of Service" S %DT("A")="(whichever is later): " S:$G(FBAAID) %DT("B")=$$DATX^FBAAUTL(FBAAID) I $G(FBCNH) S %DT(0)=$G(FBENDDT)
"RTN","FBAACO1",109,0)
 S %DT="AEXP" D ^%DT K %DT I X="^"!(X="") S FBAAOUT=1 Q
"RTN","FBAACO1",110,0)
 S FBAAID=Y I $G(CALLERID)="FBCHEP",FBAAID<FBAAEDT D  K FBAAID G GETINDT
"RTN","FBAACO1",111,0)
 .N SHOWDOS S SHOWDOS=$E(FBAAEDT,4,5)_"/"_$E(FBAAEDT,6,7)_"/"_$E(FBAAEDT,2,3) ;Convert FBAAEDT (Treatment TO Date) into display format for error message
"RTN","FBAACO1",112,0)
 .W *7,!!?5,"*** Invoice Received Date cannot be before the ",!?8," Treatment TO Date ("_SHOWDOS_") !!!"
"RTN","FBAACO1",113,0)
 I '$G(FBCNP) I FBAAID<FBAABDT D  K FBAAID G GETINDT
"RTN","FBAACO1",114,0)
 .N SHOWDOS S SHOWDOS=$E(FBAABDT,4,5)_"/"_$E(FBAABDT,6,7)_"/"_$E(FBAABDT,2,3) ;Convert FBAABDT (Authorization From Date) into display format for error message
"RTN","FBAACO1",115,0)
 .W !!,$C(7),?5,"*** Invoice Received Date cannot be earlier than",!?8," Patient's Authorization Date ("_SHOWDOS_") !!!"
"RTN","FBAACO1",116,0)
GETIND1 W ! S %DT("A")="Enter Vendor Invoice Date: ",%DT="AEXP" S:$G(FBAAVID) %DT("B")=$$DATX^FBAAUTL(FBAAVID) D ^%DT K %DT G GETINDT:X="" I X="^" S FBAAOUT=1 Q
"RTN","FBAACO1",117,0)
 S FBAAVID=Y I FBAAVID>FBAAID W !!,$C(7),"Vendor's invoice date is later than the date you received it!!" K FBAAVID G GETIND1
"RTN","FBAACO1",118,0)
 Q
"RTN","FBAACO1",119,0)
 ;
"RTN","FBAACO1",120,0)
DISPINV ;display invoice totals
"RTN","FBAACO1",121,0)
 ;required inputs FBAADT (auth dt),DFN
"RTN","FBAACO1",122,0)
 S H=$E(FBAADT,1,5)_"00",R=9999999.9999-H,S=$E(FBAADT,1,5)_31,S=9999999.9999-S,G=+$E(FBAADT,4,5)_+$E(FBAADT,2,3) D CKMAX^FBAACO3
"RTN","FBAACO1",123,0)
 S FBTPD=0 I $D(^FBAAC(DFN,3,"AB",FBAADT)) S FBZX=$O(^FBAAC(DFN,3,"AB",FBAADT,0)) I $D(^FBAAC(DFN,3,FBZX,0)) W !!,"$ ",$P(^(0),"^",3)," for travel already entered for this date of service" S FBTPD=1
"RTN","FBAACO1",124,0)
 W:'$D(FBCHCO) !!,"Total already paid on ID Card for month:   $ ",A,"   Maximum allowed: $ ",$P(FBSITE(1),"^",9),!,"Total already paid on All/Other for month: $ ",FBAOT
"RTN","FBAACO1",125,0)
 Q
"RTN","FBAACO3")
0^1^B55394363^B50591838
"RTN","FBAACO3",1,0)
FBAACO3 ;AISC/GRR-ENTER PAYMENT CONTINUED ;7/7/2003
"RTN","FBAACO3",2,0)
 ;;3.5;FEE BASIS;**4,38,55,61,116,122,133,108,124**;JAN 30, 1995;Build 20
"RTN","FBAACO3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO3",4,0)
DOEDIT ;
"RTN","FBAACO3",5,0)
 N FB1725,FBFPPSC
"RTN","FBAACO3",6,0)
 W ! S FBAACP(0)=FBAACP
"RTN","FBAACO3",7,0)
 S DIC="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"
"RTN","FBAACO3",8,0)
 S DIC(0)="EQMZ",DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI
"RTN","FBAACO3",9,0)
 S X=$$CPT^FBAAUTL4(FBAACP)
"RTN","FBAACO3",10,0)
 D ^DIC I Y<0 S FBAAOUT=1 Q
"RTN","FBAACO3",11,0)
 S (DA,FBAACPI)=+Y,K=$P(Y(0),U,3),FBZBN=$P(Y(0),U,8),FBZBS=$S(FBZBN]"":$P($G(^FBAA(161.7,FBZBN,"ST")),U),1:""),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBAACO3",12,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBAACO3",13,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBAACO3",14,0)
 S FBAAMM1=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,2)),U,2)
"RTN","FBAACO3",15,0)
 S FBCNTRP=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,3)),U,8)
"RTN","FBAACO3",16,0)
 S FBFSAMT(0)=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,2)),U,12)
"RTN","FBAACO3",17,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBAACO3",18,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBAACO3",19,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"_FBAACPI_",""M"")")
"RTN","FBAACO3",20,0)
 ; load current adjustment data
"RTN","FBAACO3",21,0)
 D LOADADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAACO3",22,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBAACO3",23,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBAACO3",24,0)
 ; load current remittance remark data
"RTN","FBAACO3",25,0)
 D LOADRR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACO3",26,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBAACO3",27,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBAACO3",28,0)
 ; load FPPS data
"RTN","FBAACO3",29,0)
 S FBFPPSC=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,3)),U)
"RTN","FBAACO3",30,0)
 S FBFPPSL=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,3)),U,2)
"RTN","FBAACO3",31,0)
 I FBZBS=""!(FBZBS="V") D NOGO S FBAAOUT=1 Q
"RTN","FBAACO3",32,0)
 ; first edit CPT code and modifiers
"RTN","FBAACO3",33,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) S FBAAOUT=1 Q
"RTN","FBAACO3",34,0)
 ; if CPT was changed then update file
"RTN","FBAACO3",35,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" S FBAAOUT=1 Q
"RTN","FBAACO3",36,0)
 . N FBIENS,FBFDA
"RTN","FBAACO3",37,0)
 . S FBIENS=FBAACPI_","_FBSDI_","_FBV_","_DFN_","
"RTN","FBAACO3",38,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBAACO3",39,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBAACO3",40,0)
 ; if modifiers changed then update file
"RTN","FBAACO3",41,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(DFN,FBV,FBSDI,FBAACPI)
"RTN","FBAACO3",42,0)
 ; now edit remaining fields
"RTN","FBAACO3",43,0)
 D SETO K DR
"RTN","FBAACO3",44,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBAACO3",45,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only
"RTN","FBAACO3",46,0)
 S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1,FBCNTRP,1);34///@;34////^S X=FBAAMM1;54///@;54////^S X=FBCNTRP;30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAACO3",47,0)
 ;S DR(1,162.03,1)="30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAACO3",48,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBAACO3",49,0)
 ;S DR(1,162.03,3)="3//^S X=$S(J-K:J-K,1:"""");4;S:X'=4 Y=6;22;6////^S X=DUZ;13;33"
"RTN","FBAACO3",50,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBAACO3",51,0)
 S DR(1,162.03,4)="S:FBFPPSC="""" Y=13;W !,""FPPS CLAIM ID: ""_FBFPPSC;S FBX=$$FPPSL^FBUTL5(FBFPPSL,,1);51///^S X=FBX;S FBFPPSL=X;@13;13;I $$BADDATE^FBAACO3(FBAADT,X) S Y=""@13"";33"
"RTN","FBAACO3",52,0)
 S DR(1,162.03,5)="S:$$EXTPV^FBAAUTL5(FBPOV)=""01"" Y=""@1"";S Y=$S('$D(FB7078):28,FB7078]"""":31,1:28);@5;28R;S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@5"";31;32R;S Y=""@7"";@1;28;I X]"""" S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@1"";31"
"RTN","FBAACO3",53,0)
 S DR(1,162.03,6)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBAACO3",54,0)
 S DR(1,162.03,7)="73;74;75;58;59;60;61;62;63;64;65;66;67;76;77;78;79;68;69"
"RTN","FBAACO3",55,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",DIE("NO^")="",FBOT=1
"RTN","FBAACO3",56,0)
 D LOCK^FBUCUTL("^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",FBAACPI) I 'FBLOCK S FBAAOUT=1 Q
"RTN","FBAACO3",57,0)
 D ^DIE
"RTN","FBAACO3",58,0)
 ; if adjustment data changed then file
"RTN","FBAACO3",59,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAACO3",60,0)
 ; if remit remark data changed then file
"RTN","FBAACO3",61,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACO3",62,0)
 L -^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI) K FBOT,DIE,DR,DA
"RTN","FBAACO3",63,0)
 Q:$D(FBDL)
"RTN","FBAACO3",64,0)
 I $G(FBAAIN) S FBINTOT=0 D CALC
"RTN","FBAACO3",65,0)
 Q
"RTN","FBAACO3",66,0)
 ;
"RTN","FBAACO3",67,0)
BADDATE(FBDOS,INVRCVDT) ;Reject entry if InvRcvDt is Prior to the Date of Service on the Invoice
"RTN","FBAACO3",68,0)
 I INVRCVDT<FBDOS D  Q 1 ;Reject entry
"RTN","FBAACO3",69,0)
 .N SHOWDOS  S SHOWDOS=$E(FBDOS,4,5)_"/"_$E(FBDOS,6,7)_"/"_$E(FBDOS,2,3) ;Convert FBDOS into display format for error message
"RTN","FBAACO3",70,0)
 .W *7,!!?5,"*** Invoice Received Date cannot be prior to the",!?8," Date of Service ("_SHOWDOS_") !!!"
"RTN","FBAACO3",71,0)
 Q 0 ;Accept entry
"RTN","FBAACO3",72,0)
 ;
"RTN","FBAACO3",73,0)
SETO S FY=$E(FBAADT,1,3)+1700+$S($E(FBAADT,4,5)>9:1,1:0)
"RTN","FBAACO3",74,0)
 Q
"RTN","FBAACO3",75,0)
OUT ;
"RTN","FBAACO3",76,0)
 ; FB*3.5*116 count line items that have 0.00 amount paid
"RTN","FBAACO3",77,0)
 ;I K>0 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1,FBINTOT=FBINTOT+K
"RTN","FBAACO3",78,0)
 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1,FBINTOT=FBINTOT+K
"RTN","FBAACO3",79,0)
 Q
"RTN","FBAACO3",80,0)
CKMAX S (FBAOT,A)=0,O="" F Z=S-.1:0 S Z=$O(^FBAAC(DFN,"AB",Z)) Q:Z'>0!(Z>R)  F Q=0:0 S Q=$O(^FBAAC(DFN,"AB",Z,Q)) Q:Q'>0  S W=$O(^FBAAC(DFN,"AB",Z,Q,0)) I $D(^FBAAC(DFN,1,Q,1,W,0)) D SMORE
"RTN","FBAACO3",81,0)
 I A>$P(FBSITE(1),"^",9) G NO
"RTN","FBAACO3",82,0)
 Q
"RTN","FBAACO3",83,0)
SMORE N FBA,FBB S FBB=$P($G(^FBAAC(+DFN,1,+Q,1,+W,0)),U,4),E=0
"RTN","FBAACO3",84,0)
 F  S E=$O(^FBAAC(DFN,1,Q,1,W,1,E)) Q:'E  S FBA=$G(^(E,0)) I $P(FBA,"^",9)=2,$P(FBA,"^",18)'=1 D
"RTN","FBAACO3",85,0)
 .I $$IDCHK^FBAAUTL3(DFN,FBB) S A=A+$P(FBA,"^",3) Q
"RTN","FBAACO3",86,0)
 .S FBAOT=FBAOT+$P(FBA,U,3)
"RTN","FBAACO3",87,0)
 Q
"RTN","FBAACO3",88,0)
NO W !!,*7,"Warning Patient already at maximum allowed for month of service",! Q
"RTN","FBAACO3",89,0)
WARN W !!,*7,"You have reached the maximum number of payments for a Batch!",!,"You must select another Batch for entering Payments!"
"RTN","FBAACO3",90,0)
CALC ;Calculate Current Invoice Total
"RTN","FBAACO3",91,0)
 F J=0:0 S J=$O(^FBAAC("C",FBAAIN,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("C",FBAAIN,J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("C",FBAAIN,J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("C",FBAAIN,J,K,L,M)) Q:M'>0  D CALC1
"RTN","FBAACO3",92,0)
 K J,K,L,M,FZNODE Q
"RTN","FBAACO3",93,0)
CALC1 S FZNODE=^FBAAC(J,1,K,1,L,1,M,0),A2=$P(FZNODE,"^",3),FBINTOT=FBINTOT+A2,FBAAID=$P(FZNODE,"^",15),FBAAVID=$P($G(^FBAAC(J,1,K,1,L,1,M,2)),"^")
"RTN","FBAACO3",94,0)
 Q
"RTN","FBAACO3",95,0)
FEEDT ;
"RTN","FBAACO3",96,0)
 ; input FB1725 - true (=1) when edited payment is for a Mill Bill claim
"RTN","FBAACO3",97,0)
 N FBX
"RTN","FBAACO3",98,0)
 D SETO:'$G(FY) S FBFY=FY-1
"RTN","FBAACO3",99,0)
 S (FBFSAMT,FBFSUSD)="",FBAMTPD=$G(FBAMTPD)
"RTN","FBAACO3",100,0)
 S FBX=$$GET^FBAAFS($$CPT^FBAAUTL4(FBAACP),$$MODL^FBAAUTL4("FBMODA","E"),FBAADT,$G(FBZIP),$$FAC^FBAAFS($G(FBHCFA(30))),$G(FBTIME))
"RTN","FBAACO3",101,0)
 I '$G(FBAAMM1) D
"RTN","FBAACO3",102,0)
 . S FBFSAMT=$P(FBX,U),FBFSUSD=$P(FBX,U,2)
"RTN","FBAACO3",103,0)
 E  D
"RTN","FBAACO3",104,0)
 . W !,?2,"Payment is for a contracted service so fee schedule does not apply."
"RTN","FBAACO3",105,0)
 I $P($G(FBX),U)]"" D
"RTN","FBAACO3",106,0)
 . W !?2,$S($G(FBAAMM1):"However, f",1:"F")
"RTN","FBAACO3",107,0)
 . W "ee schedule amount is $",$P(FBX,U)," from the "
"RTN","FBAACO3",108,0)
 . W:$P(FBX,U,3)]"" $P(FBX,U,3)," " ; year if returned
"RTN","FBAACO3",109,0)
 . W:$P(FBX,U,2)]"" $$EXTERNAL^DILFD(162.03,45,"",$P(FBX,U,2))
"RTN","FBAACO3",110,0)
 E  W !?2,"Unable to determine a FEE schedule amount."
"RTN","FBAACO3",111,0)
 ;
"RTN","FBAACO3",112,0)
 I FB1725 D
"RTN","FBAACO3",113,0)
 . W !!?2,"**Payment is for emergency treatment under 38 U.S.C. 1725."
"RTN","FBAACO3",114,0)
 . I FBFSAMT D
"RTN","FBAACO3",115,0)
 . . S FBFSAMT=$J(FBFSAMT*.7,0,2)
"RTN","FBAACO3",116,0)
 . . W !?2,"  Therefore, fee schedule amount reduced to $",FBFSAMT," (70%)."
"RTN","FBAACO3",117,0)
 ;
"RTN","FBAACO3",118,0)
 I $G(FBUNITS)>1 D
"RTN","FBAACO3",119,0)
 . W !!?2,"Units Paid = ",FBUNITS
"RTN","FBAACO3",120,0)
 . Q:FBFSAMT'>0
"RTN","FBAACO3",121,0)
 . N FBFSUNIT
"RTN","FBAACO3",122,0)
 . ; determine if fee schedule can be multipled by units
"RTN","FBAACO3",123,0)
 . S FBFSUNIT=$S(FBFSUSD="R":1,FBFSUSD="F"&(FBAADT>3040930):1,1:0)
"RTN","FBAACO3",124,0)
 . I FBFSUNIT D
"RTN","FBAACO3",125,0)
 . . S FBFSAMT=$J(FBFSAMT*FBUNITS,0,2)
"RTN","FBAACO3",126,0)
 . . W !?2,"  Therefore, fee schedule amount increased to $",FBFSAMT
"RTN","FBAACO3",127,0)
 . E  D
"RTN","FBAACO3",128,0)
 . . W !?2,"  Fee schedule not complied on per unit basis so amount not adjusted by units."
"RTN","FBAACO3",129,0)
 ;
"RTN","FBAACO3",130,0)
 I '$G(FBAAMM1) D
"RTN","FBAACO3",131,0)
 . ; set default amount paid to lesser of amt claimed (J) or fee sched.
"RTN","FBAACO3",132,0)
 . S FBAMTPD=$S(FBFSAMT'>0:J,FBFSAMT>J:J,1:FBFSAMT)
"RTN","FBAACO3",133,0)
 W !
"RTN","FBAACO3",134,0)
 Q
"RTN","FBAACO3",135,0)
CHKIT I X>FBAMTPD&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,"You must be a holder of the 'FBAASUPERVISOR' security key in order to",!,"exceed the Fee Schedule.",! S $P(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,0),"^",3)=K,Y=2 Q
"RTN","FBAACO3",136,0)
 Q
"RTN","FBAACO3",137,0)
NOGO W !!,*7,"This payment CANNOT be edited.  The batch the payment is in",!,"has been Vouchered.  You may void the payment with the Void Payment option.",!
"RTN","FBAACO3",138,0)
 Q
"RTN","FBAACO3",139,0)
 ;
"RTN","FBAACO3",140,0)
SC W *7,!?4,"Suspense code is required!",! S Y="@4" Q
"RTN","FBAACO3",141,0)
 ;
"RTN","FBAACO3",142,0)
DEL ;delete date of service if no service provided entered
"RTN","FBAACO3",143,0)
 I '$O(^FBAAC(DFN,1,FBV,1,FBSDI,1,0)) D
"RTN","FBAACO3",144,0)
 .S DIK="^FBAAC(DFN,1,FBV,1,",DA(2)=DFN,DA(1)=FBV,DA=FBSDI D ^DIK W !!?5,*7,"Incomplete payment entry deleted.",!
"RTN","FBAACO3",145,0)
 K DIK,DA Q
"RTN","FBAACO5")
0^2^B6803212^B6093422
"RTN","FBAACO5",1,0)
FBAACO5 ;AISC/GRR-ENTER PAYMENT CONTINUED ;5/5/93  09:24
"RTN","FBAACO5",2,0)
 ;;3.5;FEE BASIS;**73,79,124**;JAN 30, 1995;Build 20
"RTN","FBAACO5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO5",4,0)
FILEV(DFN,FBV) ;files vendor multiple in outpatient payment file
"RTN","FBAACO5",5,0)
 ;required input variable DFN,FBV (vendor ien)
"RTN","FBAACO5",6,0)
 K FBAAOUT
"RTN","FBAACO5",7,0)
 I '$G(DFN)!('FBV) S FBAAOUT=1 Q
"RTN","FBAACO5",8,0)
 S:'$D(^FBAAC(DFN,1,0)) ^FBAAC(DFN,1,0)="^162.01P^0^0"
"RTN","FBAACO5",9,0)
 S DLAYGO=162,DIC="^FBAAC("_DFN_",1,",DIC(0)="QLNM",DA(1)=DFN,X="`"_FBV D ^DIC K DIC,DLAYGO I Y<0 W !,*7,"Cannot select this Vendor at this time" S FBAAOUT=1 Q
"RTN","FBAACO5",10,0)
 Q
"RTN","FBAACO5",11,0)
GETSVDT(DFN,FBV,FBASSOC,FBA,X) ;set date of service multiple
"RTN","FBAACO5",12,0)
 ;required input DFN,FBV (vendor ien),FBASSOC (auth ptr,0 if not known)
"RTN","FBAACO5",13,0)
 ;required input FBA (1=ask dt,0=do not ask dt)
"RTN","FBAACO5",14,0)
 ;optional/required input X (dt) - X req if FBA=0 (do not ask)
"RTN","FBAACO5",15,0)
 ;output FBSDI=ien of svc date mult,FBAADT=svc date
"RTN","FBAACO5",16,0)
TRYAGAIN ;
"RTN","FBAACO5",17,0)
 K FBAAOUT
"RTN","FBAACO5",18,0)
 I '$G(DFN)!('$G(FBV))!('$D(FBASSOC))!('$D(FBA)) S FBAAOUT=1 Q
"RTN","FBAACO5",19,0)
 I FBA=0,('$G(X)) S FBAAOUT=1 Q
"RTN","FBAACO5",20,0)
 I $G(FBA) S DIC("A")="Date of Service: ",DIC(0)="AEQLM"
"RTN","FBAACO5",21,0)
 I '$G(FBA) S DIC(0)="QLMN"
"RTN","FBAACO5",22,0)
 I '$D(^FBAAC(DFN,1,FBV,1,0)) S ^FBAAC(DFN,1,FBV,1,0)="^162.02DA^0^0"
"RTN","FBAACO5",23,0)
 S DLAYGO=162,DA(2)=DFN,DA(1)=FBV,DIC="^FBAAC("_DFN_",1,"_FBV_",1," D ^DIC K DLAYGO,DIC,DA I X=""!(X="^")!(Y<0) S FBAAOUT=1 Q
"RTN","FBAACO5",24,0)
 ;if date of service input transform called skip checks
"RTN","FBAACO5",25,0)
 I $D(HOLDY),HOLDY=$P(Y,"^",2) GOTO DONASK
"RTN","FBAACO5",26,0)
 I $D(FBAAID),$P(Y,"^",2)>FBAAID D  G TRYAGAIN
"RTN","FBAACO5",27,0)
 .N SHODAT S SHODAT=$E(FBAAID,4,5)_"/"_$E(FBAAID,6,7)_"/"_$E(FBAAID,2,3)
"RTN","FBAACO5",28,0)
 .W !!,*7,?5,"*** Date of Service cannot be later than",!?8," Invoice Received Date ("_SHODAT_") !!!",!
"RTN","FBAACO5",29,0)
 I $D(FBAABDT),$D(FBAAEDT),($P(Y,"^",2)<FBAABDT!($P(Y,"^",2)>FBAAEDT)) D  G TRYAGAIN
"RTN","FBAACO5",30,0)
 .N PRIORLAT,AUTHDAT,SHODAT
"RTN","FBAACO5",31,0)
 .S PRIORLAT=$S($P(Y,"^",2)<FBAABDT:"prior to ",1:"later than ")
"RTN","FBAACO5",32,0)
 .S AUTHDAT=$S($P(Y,"^",2)<FBAABDT:FBAABDT,1:FBAAEDT)
"RTN","FBAACO5",33,0)
 .S SHODAT=$E(AUTHDAT,4,5)_"/"_$E(AUTHDAT,6,7)_"/"_$E(AUTHDAT,2,3)
"RTN","FBAACO5",34,0)
 .W !!,*7,?5,"*** Date of Service cannot be ",PRIORLAT,!?8," Authorization period ("_SHODAT_") !!!",!
"RTN","FBAACO5",35,0)
DONASK ;
"RTN","FBAACO5",36,0)
 S FBSDI=+Y,FBAADT=$P(Y,"^",2) I FBASSOC>0 S DA(2)=DFN,DA(1)=FBV,DA=FBSDI,DIE="^FBAAC("_DFN_",1,"_FBV_",1,",DR="3///^S X=FBASSOC" D ^DIE K DIE,DA,DR
"RTN","FBAACO5",37,0)
 Q
"RTN","FBAAEPI")
0^3^B20301979^B14319298
"RTN","FBAAEPI",1,0)
FBAAEPI ;AISC/GRR-EDIT PREVIOUSLY ENTERED PHARMACY INVOICE ;7/16/2003
"RTN","FBAAEPI",2,0)
 ;;3.5;FEE BASIS;**38,61,124**;JAN 30, 1995;Build 20
"RTN","FBAAEPI",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAEPI",4,0)
RD W ! S DIC="^FBAA(162.1,",DIC(0)="AEQM",DIC("A")="Select Invoice #: ",DIC("S")="I $P(^(0),U,5)'=4!($P(^(0),U,5)=4&$D(^XUSEC(""FBAASUPERVISOR"",DUZ)))" D ^DIC K DIC("S") G END:X=""!(X="^"),RD:Y<0
"RTN","FBAAEPI",5,0)
 S (DA,FBDA)=+Y,DIE=DIC
"RTN","FBAAEPI",6,0)
 ; save FPPS data prior to edit session
"RTN","FBAAEPI",7,0)
 S (FBFPPSC,FBFPPSC(0))=$P($G(^FBAA(162.1,FBDA,0)),U,13)
"RTN","FBAAEPI",8,0)
 D LASTRXDT ;Look up last RX FILL DATE in selected invoice, for use in validating Invoice Received Date if it is edited.
"RTN","FBAAEPI",9,0)
 S DR="@1;1;I $$BADDATE^FBAAEPI(LASTRXDT,X) S Y=""@1"";Q;12;S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="""" Y=""@10"";13///^S X=FBX;S FBFPPSC=X;S Y=""@15"";@10;13///@;S FBFPPSC="""";@15;3;5"
"RTN","FBAAEPI",10,0)
 D ^DIE K DIC
"RTN","FBAAEPI",11,0)
 ; if FPPS CLAIM ID changed, then update Rx's
"RTN","FBAAEPI",12,0)
 I FBFPPSC'=FBFPPSC(0) D CKINVEDI^FBAAEPI1(FBFPPSC(0),FBFPPSC,FBDA)
"RTN","FBAAEPI",13,0)
 S DIC="^FBAA(162.1,DA,""RX"",",DIC(0)="AEQM",DIC("W")="W ?30,""DATE RX FILLED: "",$E($P(^(0),U,3),4,5)_""/""_$E($P(^(0),U,3),6,7)_""/""_$E($P(^(0),U,3),2,3)" D ^DIC G END:X=""!(X="^"),RD:Y<0 W !
"RTN","FBAAEPI",14,0)
 S (FBJ,FBK)=0
"RTN","FBAAEPI",15,0)
 ;check status of batch rx is in.
"RTN","FBAAEPI",16,0)
 S DA=+Y,DA(1)=FBDA S FBSTAT=$P($G(^FBAA(161.7,+$P($G(^FBAA(162.1,+FBDA,"RX",+DA,0)),U,17),"ST")),U) I FBSTAT]"" D
"RTN","FBAAEPI",17,0)
 .I '$D(^XUSEC("FBAASUPERVISOR",DUZ)) D
"RTN","FBAAEPI",18,0)
 .. I $S(FBSTAT="O":0,FBSTAT="C":0,1:1) D
"RTN","FBAAEPI",19,0)
 ... W !,*7,"You cannot edit a payment once released by a supervisor.",! S FBOUT=1 Q
"RTN","FBAAEPI",20,0)
 .I $S(FBSTAT="T":1,FBSTAT="V":1,1:0) D
"RTN","FBAAEPI",21,0)
 .. W !,*7,"You cannot edit an invoice when the batch has a status of transmitted",!,"or vouchered.",! S FBOUT=1
"RTN","FBAAEPI",22,0)
 I $G(FBOUT) D END G FBAAEPI
"RTN","FBAAEPI",23,0)
 S DIE="^FBAA(162.1,FBDA,""RX"","
"RTN","FBAAEPI",24,0)
 ; get current value of FPPS LINE ITEM to use as default
"RTN","FBAAEPI",25,0)
 S FBFPPSL=$P($G(^FBAA(162.1,FBDA,"RX",DA,3)),U)
"RTN","FBAAEPI",26,0)
 ; load current adjustment data
"RTN","FBAAEPI",27,0)
 D LOADADJ^FBRXFA(DA_","_FBDA_",",.FBADJ)
"RTN","FBAAEPI",28,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBAAEPI",29,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBAAEPI",30,0)
 ; load current remittance remark data
"RTN","FBAAEPI",31,0)
 D LOADRR^FBRXFR(DA_","_FBDA_",",.FBRRMK)
"RTN","FBAAEPI",32,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBAAEPI",33,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBAAEPI",34,0)
 S DR=".01;S:FBFPPSC="""" Y=1;S FBX=$$FPPSL^FBUTL5(FBFPPSL);S:FBX=-1 Y=0;36///^S X=FBX;S FBFPPSL=X;1;1.5;1.6;3;S FBJ=X;I $P(^FBAA(162.1,DA(1),""RX"",DA,0),U,9)=1 S Y="""";I 1;5"
"RTN","FBAAEPI",35,0)
 S DR(1,162.11,1)="S FBA=$P($G(^FBAA(162.1,DA(1),""RX"",DA,2)),U,6);S FB1725=$S(FBA[""FB583"":+$P($G(^FB583(+FBA,0)),U,28),1:0);W:FB1725 !?2,""**Payment is for emergency treatment under 38 U.S.C. 1725."""
"RTN","FBAAEPI",36,0)
 S DR(1,162.11,2)="@12;S FBHAP=$P(^FBAA(162.1,DA(1),""RX"",DA,0),U,16);6.5;S FBK=X;S:FBK]"""" Y=""@20"";K FBADJ,FBRRMK;S Y=8"
"RTN","FBAAEPI",37,0)
 S DR(1,162.11,3)="@20;I FBK>FBJ S $P(^FBAA(162.1,DA(1),""RX"",DA,0),U,16)=FBHAP W !,*7,""Amount Paid cannot be greater than the Amount Claimed"" S Y=""@12"""
"RTN","FBAAEPI",38,0)
 ;S DR(1,162.11,4)="S:FBJ=FBK Y=""@5"";6////^S X=FBJ-FBK;Q;6R;7R;S:X'=4 Y=""@6"";20;S Y=""@6"";@5;6///@;7///@;20///@;@6;8"
"RTN","FBAAEPI",39,0)
 S DR(1,162.11,4)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(FBJ-FBK,.FBADJ,2,,.FBADJD,1);K FBADJD"
"RTN","FBAAEPI",40,0)
 S DR(1,162.11,5)="K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD);K FBRRMKD;S:FBX=-1 Y=0;8"
"RTN","FBAAEPI",41,0)
 D ^DIE
"RTN","FBAAEPI",42,0)
 ; if adjustment data changed then file
"RTN","FBAAEPI",43,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBRXFA(DA_","_FBDA_",",.FBADJ)
"RTN","FBAAEPI",44,0)
 ; if remit remark data changed then file
"RTN","FBAAEPI",45,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBRXFR(DA_","_FBDA_",",.FBRRMK)
"RTN","FBAAEPI",46,0)
 ;
"RTN","FBAAEPI",47,0)
LASTRXDT ;Look up last RX FILL DATE in selected invoice, for use in validating Invoice Received Date if it is edited.
"RTN","FBAAEPI",48,0)
 ;DA contains the selected INV#
"RTN","FBAAEPI",49,0)
 N I
"RTN","FBAAEPI",50,0)
 S LASTRXDT=0
"RTN","FBAAEPI",51,0)
 F I=1:1 Q:'$D(^FBAA(162.1,DA,"RX",I))  D
"RTN","FBAAEPI",52,0)
 .N RXDT S RXDT=$P(^FBAA(162.1,DA,"RX",I,0),"^",3)
"RTN","FBAAEPI",53,0)
 .I RXDT>LASTRXDT S LASTRXDT=RXDT,RXNUM=$P(^FBAA(162.1,DA,"RX",I,0),"^",1)
"RTN","FBAAEPI",54,0)
 Q
"RTN","FBAAEPI",55,0)
 ;
"RTN","FBAAEPI",56,0)
BADDATE(LASTRXDT,INVRCVDT) ;Reject entry if InvRcvDt is Prior to the last Rx Fill Date on the Invoice
"RTN","FBAAEPI",57,0)
 I INVRCVDT<LASTRXDT D  Q 1 ;Reject entry
"RTN","FBAAEPI",58,0)
 .N SHOWRXDT  S SHOWRXDT=$E(LASTRXDT,4,5)_"/"_$E(LASTRXDT,6,7)_"/"_$E(LASTRXDT,2,3) ;Convert RXDT into display format for error message
"RTN","FBAAEPI",59,0)
 .W *7,!!?5,"*** Invoice Received Date cannot be prior to the last",!?8," Prescription Filled Date on the Invoice ("_SHOWRXDT_" for RX# "_RXNUM_") !!!"
"RTN","FBAAEPI",60,0)
 Q 0 ;Accept entry
"RTN","FBAAEPI",61,0)
 ;
"RTN","FBAAEPI",62,0)
END K D,DA,DIC,DIE,DR,FBJ,FBK,FBDA,FBOUT,FBSTAT,FBHAP,X,Y,FBA,FB1725
"RTN","FBAAEPI",63,0)
 K FBADJ,FBADJD,FBADJL,FBFPPSC,FBFPPSL,FBRRMK,FBRRMKD,FBRRMKL,LASTRXDT,RXNUM
"RTN","FBAAEPI",64,0)
 Q
"RTN","FBAAPET")
0^4^B43544171^B39436624
"RTN","FBAAPET",1,0)
FBAAPET ;AISC/DMK-EDIT PAYMENT ;7/13/2003
"RTN","FBAAPET",2,0)
 ;;3.5;FEE BASIS;**4,38,55,61,77,116,122,133,108,124**;JAN 30, 1995;Build 20
"RTN","FBAAPET",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAPET",4,0)
 S FBOT=1
"RTN","FBAAPET",5,0)
GETPT I $G(BAT) D
"RTN","FBAAPET",6,0)
 .I '$D(^FBAAC("AC",+BAT)) F I=9,10,11 S $P(^FBAA(161.7,+BAT,0),U,I)=""
"RTN","FBAAPET",7,0)
 .I $D(^FBAAC("AC",+BAT)) D  S $P(^FBAA(161.7,+BAT,0),U,11)=I,$P(^(0),U,9)=$G(FBTOT) K I,FBTOT
"RTN","FBAAPET",8,0)
 ..N J,K,L,M S (I,J,K,L,M,FBTOT)=0
"RTN","FBAAPET",9,0)
 ..F  S J=$O(^FBAAC("AC",+BAT,J)) Q:'J  F  S K=$O(^FBAAC("AC",+BAT,J,K)) Q:'K  F  S L=$O(^FBAAC("AC",+BAT,J,K,L)) Q:'L  F  S M=$O(^FBAAC("AC",+BAT,J,K,L,M)) Q:'M  I $D(^FBAAC(J,1,K,1,L,1,M,0)) S I=I+1,FBTOT=FBTOT+$P(^(0),U,3)
"RTN","FBAAPET",10,0)
 W !! S DIC="^FBAAC(",DIC(0)="AEQM" D ^DIC G END:X="^"!(X=""),GETPT:Y<0 S (DFN,FBDA(3))=+Y
"RTN","FBAAPET",11,0)
 S:'$D(^FBAAC(DFN,1,0)) ^FBAAC(DFN,1,0)="^162.01P^0^0"
"RTN","FBAAPET",12,0)
 S DIC=DIC_DFN_",1,"
"RTN","FBAAPET",13,0)
GETVD W !! S DIC(0)="AEQM" D ^DIC G GETPT:X="^"!(X=""),GETVD:Y<0 S (FBV,FBVD,FBDA(2))=+Y
"RTN","FBAAPET",14,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,0)) ^FBAAC(DFN,1,FBDA(2),1,0)="^162.02DA^0^0"
"RTN","FBAAPET",15,0)
 S DIC=DIC_FBVD_",1,"
"RTN","FBAAPET",16,0)
GETDT S DIC(0)="AEQM",DIC("A")="Date of Service: " D ^DIC K DIC("A") G GETPT:X="^"!(X=""),GETDT:Y<0 S (FBSD,FBSDI,FBDA(1))=+Y,FBAADT=$P(Y,U,2)
"RTN","FBAAPET",17,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)) ^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)="^162.03A^0^0"
"RTN","FBAAPET",18,0)
 S FBZ=DIC_FBSD_",1,"
"RTN","FBAAPET",19,0)
SERV S DA(3)=FBDA(3),DA(2)=FBDA(2),DA(1)=FBDA(1)
"RTN","FBAAPET",20,0)
 S DIC("W")="N FBX S FBX=$$MODL^FBAAUTL4(""^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,+Y,""""M"""")"",""E"") W:FBX]"""" ""    CPT Modifier(s): "",FBX Q"
"RTN","FBAAPET",21,0)
 S DIC=FBZ,DIC(0)="AEQMZ"
"RTN","FBAAPET",22,0)
 D
"RTN","FBAAPET",23,0)
 . N ICPTVDT S ICPTVDT=$G(FBAADT) D ^DIC
"RTN","FBAAPET",24,0)
 G GETPT:X="^"!(X=""),SERV:Y<0 S (FBSV,FBAACPI,FBDA)=+Y,BAT=$P(Y(0),U,8),FBDUZ=$P(Y(0),U,7),(FBAACP,FBAACP(0))=$P(Y,U,2),K=$P(Y(0),U,3),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBAAPET",25,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBAAPET",26,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBAAPET",27,0)
 I FBDUZ'=DUZ&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry,only the clerk who entered the payment ",!," or a supervisor can edit this payment." G GETPT
"RTN","FBAAPET",28,0)
 ;S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBAAPET",29,0)
 S FBFSAMT(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,12)
"RTN","FBAAPET",30,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBAAPET",31,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBAAPET",32,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_FBDA(3)_",1,"_FBDA(2)_",1,"_FBDA(1)_",1,"_FBDA_",""M"")")
"RTN","FBAAPET",33,0)
 ; load current adjustment data
"RTN","FBAAPET",34,0)
 D LOADADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBAAPET",35,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBAAPET",36,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBAAPET",37,0)
 ; load current remittance remark data
"RTN","FBAAPET",38,0)
 D LOADRR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBAAPET",39,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBAAPET",40,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBAAPET",41,0)
 ; save FPPS data prior to edit session
"RTN","FBAAPET",42,0)
 S FBFPPSC(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U)
"RTN","FBAAPET",43,0)
 S FBFPPSC=FBFPPSC(0)
"RTN","FBAAPET",44,0)
 S FBFPPSL(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,2)
"RTN","FBAAPET",45,0)
 S FBFPPSL=FBFPPSL(0)
"RTN","FBAAPET",46,0)
 G:BAT']"" EDIT
"RTN","FBAAPET",47,0)
 I $G(^FBAA(161.7,BAT,"ST"))]"",$P(^FBAA(161.7,BAT,"ST"),"^")="S"!($P(^FBAA(161.7,BAT,"ST"),"^")="T")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry, only the Supervisor can edit a payment once the batch has been released." G GETPT
"RTN","FBAAPET",48,0)
 I $G(^FBAA(161.7,BAT,"ST"))]"",$P(^FBAA(161.7,BAT,"ST"),"^")="V" W !!,*7,"Sorry,you cannot edit a payment once the batch has been Finalized." G GETPT
"RTN","FBAAPET",49,0)
EDIT S DA=FBSV
"RTN","FBAAPET",50,0)
 ;
"RTN","FBAAPET",51,0)
 ; first edit CPT code and modifiers
"RTN","FBAAPET",52,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) G GETPT
"RTN","FBAAPET",53,0)
 ; if CPT was changed then update file
"RTN","FBAAPET",54,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" G GETPT
"RTN","FBAAPET",55,0)
 . N FBIENS,FBFDA
"RTN","FBAAPET",56,0)
 . S FBIENS=FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_","
"RTN","FBAAPET",57,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBAAPET",58,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBAAPET",59,0)
 ; if modifiers changed then update file
"RTN","FBAAPET",60,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(FBDA(3),FBDA(2),FBDA(1),FBDA)
"RTN","FBAAPET",61,0)
 ;
"RTN","FBAAPET",62,0)
 ; now edit remaining fields
"RTN","FBAAPET",63,0)
 S DIE("NO^")=""
"RTN","FBAAPET",64,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBAAPET",65,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only; 
"RTN","FBAAPET",66,0)
 S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1,FBCNTRP,1);54///@;54////^S X=FBCNTRP;30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAAPET",67,0)
 ;S DR(1,162.03,1)="30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAAPET",68,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBAAPET",69,0)
 ;S DR(1,162.03,3)="3////^S X=$S(J-K:J-K,1:"""");I X S Y=""@11"";4////@;S Y=""@5"";@11;3R;4R;S:X'=4 Y=""@5"";22"
"RTN","FBAAPET",70,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBAAPET",71,0)
 S DR(1,162.03,4)="S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="""" Y=""@5"";50///^S X=FBX;S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL);S:FBX=-1 Y=0;51///^S X=FBX;S FBFPPCL=X;S Y=""@55"";@5;50///@;S FBFPPSC="""";51///@;S FBFPPSL="""";@55"
"RTN","FBAAPET",72,0)
 S DR(1,162.03,5)="K DIE(""NO^"");W !,""Exit ('^') allowed now"";26;S PRC(""SITE"")=X;8;@13;13;I $$BADDATE^FBAAPET(FBAADT,X) S Y=""@13"";Q;33;49"
"RTN","FBAAPET",73,0)
 S DR(1,162.03,6)="15;17;16;S:X=1 Y=""@1"";@6;28R;S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@6"";31;32R;S Y=""@7"";@1;28;I X]"""" S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@1"";31"
"RTN","FBAAPET",74,0)
 S DR(1,162.03,7)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBAAPET",75,0)
 S DR(1,162.03,8)="73;74;75;58;59;60;61;62;63;64;65;66;67;76;77;78;79;68;69" ;FB*3.5*122,FB*3.5*133 edit line item provider fields
"RTN","FBAAPET",76,0)
 S DIE=FBZ
"RTN","FBAAPET",77,0)
 D
"RTN","FBAAPET",78,0)
 . N ICPTVDT,ICDVDT,FB583,FBAAMM,FBAAMM1,FBCNTRA,FBCNTRP,FBVEN,FTP
"RTN","FBAAPET",79,0)
 . S (ICPTVDT,ICDVDT)=$G(FBAADT)
"RTN","FBAAPET",80,0)
 . ; set variables for call to PPT^FBAACO1
"RTN","FBAAPET",81,0)
 . S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBAAPET",82,0)
 . S FBCNTRP=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,8)
"RTN","FBAAPET",83,0)
 . S X=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,0)),U,13)
"RTN","FBAAPET",84,0)
 . S:X[";FB583(" FB583=+X
"RTN","FBAAPET",85,0)
 . S FTP=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),0)),U,4)
"RTN","FBAAPET",86,0)
 . S FBVEN=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,4),1:"")
"RTN","FBAAPET",87,0)
 . S FBCNTRA=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,22),1:"")
"RTN","FBAAPET",88,0)
 . D ^DIE
"RTN","FBAAPET",89,0)
 ; if adjustment data changed then file
"RTN","FBAAPET",90,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBAAPET",91,0)
 ; if remit remark data changed then file
"RTN","FBAAPET",92,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBAAPET",93,0)
 ; if FPPS CLAIM ID changed, update other line items on invoice
"RTN","FBAAPET",94,0)
 I FBFPPSC'=FBFPPSC(0) D
"RTN","FBAAPET",95,0)
 . N FBAAIN
"RTN","FBAAPET",96,0)
 . S FBAAIN=$$GET1^DIQ(162.03,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",14)
"RTN","FBAAPET",97,0)
 . D CKINVEDI^FBAAPET1(FBFPPSC(0),FBFPPSC,FBAAIN,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",")
"RTN","FBAAPET",98,0)
 K FBSV W !! G SERV
"RTN","FBAAPET",99,0)
 ;
"RTN","FBAAPET",100,0)
BADDATE(FBDOS,INVRCVDT) ;Reject entry if InvRcvDt is Prior to the Date of Service on the Invoice
"RTN","FBAAPET",101,0)
 I INVRCVDT<FBDOS D  Q 1 ;Reject entry
"RTN","FBAAPET",102,0)
 .N SHOWDOS S SHOWDOS=$E(FBDOS,4,5)_"/"_$E(FBDOS,6,7)_"/"_$E(FBDOS,2,3) ;Convert FBDOS into display format for error message
"RTN","FBAAPET",103,0)
 .W *7,!!?5,"*** Invoice Received Date cannot be prior to the",!?8," Date of Service ("_SHOWDOS_") !!!"
"RTN","FBAAPET",104,0)
 Q 0 ;Accept entry
"RTN","FBAAPET",105,0)
 ;
"RTN","FBAAPET",106,0)
END K DR,DIC,DIE,X,DFN,FBOT,FBVD,FBSD,BAT,FBAADT,FBSV,DA,FBDA,FBZ,FBDUZ,FBAACP,FBFY,FY,FBAMTPD,J,K,Y,ZZ,PRC,FBHOLDX,FBV,FBSDI,FBAACPI
"RTN","FBAAPET",107,0)
 K FBFSAMT,FBFSUSD,FBMODA,FBZIP,FBTIME,FBHCFA(30),FBAAPTC,FB1725,FBADJ,FBADJD,FBADJL(0),FBRRMK,FBRRMKD,FBRRMKL(0),FBX,FBUNITS
"RTN","FBAAPET",108,0)
 Q
"RTN","FBAAPIE")
0^5^B23308857^B21766218
"RTN","FBAAPIE",1,0)
FBAAPIE ;AISC/GRR-ENTER FEE PHARMACY INVOICE ;7/8/2003
"RTN","FBAAPIE",2,0)
 ;;3.5;FEE BASIS;**61,124**;JAN 30, 1995;Build 20
"RTN","FBAAPIE",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAPIE",4,0)
 D SITEP^FBAAUTL W:FBPOP !!,*7,"Fee site parameters must be initialized!!" Q:FBPOP  S FBMDF=$P(FBSITE(0),"^",10),FBAAPTC=$S($D(FBAAPTC):FBAAPTC,1:"V")
"RTN","FBAAPIE",5,0)
RD1 W ! S DIR("A")="Are you sure you want to enter a new invoice",DIR("B")="Yes",DIR(0)="Y" D ^DIR K DIR G Q^FBAAPIE1:$D(DIRUT),RDM^FBAAPIE1:'Y
"RTN","FBAAPIE",6,0)
ENTER S (LCNT,TAC,FBINTOT)=0,STAT(0)="",FBAAOUT=1 K FBTOUT
"RTN","FBAAPIE",7,0)
 D GETNXI^FBAAUTL S X=FBAAIN
"RTN","FBAAPIE",8,0)
 S DLAYGO=162.1,DIC="^FBAA(162.1,",DIC(0)="LQ" D ^DIC K DLAYGO G:Y<0 PROB^FBAAPIE1 W !!,"Invoice # assigned is: ",X S IN=X,DA(1)=IN
"RTN","FBAAPIE",9,0)
RDV I '$D(FB583) W !! S DLAYGO=161.2,(DIE,DIC)="^FBAAV(",DIC(0)="AEQLM" D ^DIC K DLAYGO G CHK:Y<0 S DA=+Y D NEW^FBAAVD:$P(Y,"^",3)=1
"RTN","FBAAPIE",10,0)
 I $D(FB583) S DA=FBVEN
"RTN","FBAAPIE",11,0)
 I $D(^FBAAV(DA,0)),$P($G(^("ADEL")),"^")="Y" W !!,"Vendor is flagged for Austin deletion!" G RDV:'$D(FB583),Q^FBAAPIE1
"RTN","FBAAPIE",12,0)
 D EN1^FBAAVD:$P(FBSITE(0),"^",12)="Y" S VIN=DA
"RTN","FBAAPIE",13,0)
RDV1 I $D(^XUSEC("FBAA ESTABLISH VENDOR",DUZ)) W ! S DIR("A")="Want to edit Vendor data",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR G CHK:$D(DIRUT) D:Y EDITV^FBAAVD S VIN=DA
"RTN","FBAAPIE",14,0)
 S FBAR(DA)="" D ^FBAACO4
"RTN","FBAAPIE",15,0)
 W !! S %DT="AEQXP",%DT(0)=-DT,%DT("A")="Date Correct Invoice Received: " D ^%DT K %DT(0),%DT("A") G CHK:Y<0 S INVDATE=Y
"RTN","FBAAPIE",16,0)
 W !! S %DT="AEQXP",%DT(0)=-INVDATE,%DT("A")="Vendor Invoice Date:  " D ^%DT K %DT(0),%DT("A") G CHK:Y<0 S FBVINVDT=Y
"RTN","FBAAPIE",17,0)
 ; if U/C then get FPPS Claim ID else ask user
"RTN","FBAAPIE",18,0)
 I $D(FB583) S FBFPPSC=$P($G(^FB583(FB583,5)),U) W !,"FPPS CLAIM ID: ",$S(FBFPPSC="":"N/A",1:FBFPPSC)
"RTN","FBAAPIE",19,0)
 E  S FBFPPSC=$$FPPSC^FBUTL5() I FBFPPSC=-1 K FBFPPSC G CHK
"RTN","FBAAPIE",20,0)
 S (DIE,DIC)="^FBAA(162.1,",DA=IN
"RTN","FBAAPIE",21,0)
 S DR="1////^S X=INVDATE;1.5////^S X=DT;2////^S X=DUZ;3////^S X=VIN;5////^S X=1;12////^S X=FBVINVDT;13///^S X=FBFPPSC"
"RTN","FBAAPIE",22,0)
 D ^DIE
"RTN","FBAAPIE",23,0)
 I '$D(^FBAA(162.1,IN,"RX",0)) S ^FBAA(162.1,IN,"RX",0)="^162.11A^^"
"RTN","FBAAPIE",24,0)
RDP S FBPHARM=1 W:FBINTOT>0 !,?15,"Pharmacy Invoice #: "_IN_"  Totals: $ "_$J(FBINTOT,1,2)
"RTN","FBAAPIE",25,0)
 ; if EDI then ask FPPS Line Item
"RTN","FBAAPIE",26,0)
 I FBFPPSC]"" W !!! S FBFPPSL=$$FPPSL^FBUTL5() I FBFPPSL=-1 K FBFPPSL G CHK
"RTN","FBAAPIE",27,0)
 D ^FBAASAP K FBPHARM I 'DFN K DFN G CHK
"RTN","FBAAPIE",28,0)
 I FBTT=1 S FBMST="Y",FBTTYPE="A",FBFDC="",FBD1=FTP D ENT^FBAAAUT
"RTN","FBAAPIE",29,0)
 D HOME^%ZIS,FBPH^FBAAUTL2 I $D(DIRUT),$D(FB583) G CHK
"RTN","FBAAPIE",30,0)
RDD W !! S %DT(0)=-DT,%DT="AEXP",%DT("A")="DATE PRESCRIPTION FILLED: " D ^%DT K %DT G:X["^"!(X="") RDP G RDD:Y<0 S DATEF=Y
"RTN","FBAAPIE",31,0)
 I DATEF<FBAABDT!(DATEF>FBAAEDT) W !!,*7,"Date Prescription Filled is ",$S(DATEF<FBAABDT:" prior to ",1:"later than "),"authorization period!!" G RDD
"RTN","FBAAPIE",32,0)
 I INVDATE]"",DATEF>INVDATE D  G RDD
"RTN","FBAAPIE",33,0)
 .N SHOINVDT S SHOINVDT=$E(INVDATE,4,5)_"/"_$E(INVDATE,6,7)_"/"_$E(INVDATE,2,3)
"RTN","FBAAPIE",34,0)
 .W !!,*7,?5,"*** Date Prescription Filled cannot be later than",!?8," Invoice Received Date (",SHOINVDT,") !!!"
"RTN","FBAAPIE",35,0)
 I '$D(^FBAA(162.1,IN,"RX",0)) S ^FBAA(162.1,IN,"RX",0)="^162.11A^^"
"RTN","FBAAPIE",36,0)
RDRX S DIR(0)="162.11,.01",DIR("A")="Select PRESCRIPTION NUMBER" D ^DIR K DIR G CHK:Y="^"!(Y="") S PSRX=Y,AC=0
"RTN","FBAAPIE",37,0)
 I $D(^FBAA(162.1,IN,"RX","B",PSRX)) G RX2^FBAAPIE1
"RTN","FBAAPIE",38,0)
 D CHK2^FBAAPIE1 I FBJ]"" K FBJ G CHKK^FBAAPIE1
"RTN","FBAAPIE",39,0)
RXADD K DA S DLAYGO=162.1,DA(1)=IN,DIC="^FBAA(162.1,"_IN_",""RX"",",DIC(0)="EQL",X=""""_PSRX_"""" D ^DIC K DLAYGO G:Y<0 RDRX S FBDA=+Y
"RTN","FBAAPIE",40,0)
 S DIE="^FBAA(162.1,",DA=IN,DR="[FB ADD RX]" D ^DIE I $D(DTOUT)!('$G(FBUP)) G DELRX
"RTN","FBAAPIE",41,0)
 S LCNT=LCNT+1,TAC=TAC+AC K FBUP
"RTN","FBAAPIE",42,0)
RDDER W !!,*7,"Prescription referred to Pharmacy Service for determination.",! S X="Y"
"RTN","FBAAPIE",43,0)
 S STAT(1)="" G RDP:'$D(FB583),Q^FBAAPIE1
"RTN","FBAAPIE",44,0)
 S $P(^FBAA(162.1,IN,"RX",DA,2),"^")="P",^FBAA(162.1,"AH","P",IN,DA)="",$P(^FBAA(162.1,IN,0),"^",10)="P"
"RTN","FBAAPIE",45,0)
 S DA(1)=IN,DIE=DIC
"RTN","FBAAPIE",46,0)
HERE S:$D(FBAP) FBINTOT=FBINTOT+FBAP S:$D(DTOUT) FBTOUT="" G OVR:$D(DTOUT),RDD
"RTN","FBAAPIE",47,0)
CHK I LCNT'>0 W !!,"Since you didn't enter any line items",!,"Invoice # ",IN," has been Deleted!!",*7 D KILL G Q^FBAAPIE1:$D(FBTOUT),MORE:'$D(FB583),Q^FBAAPIE1
"RTN","FBAAPIE",48,0)
OVR K DTOUT,DR,DQ,DG
"RTN","FBAAPIE",49,0)
 K STAT(2)
"RTN","FBAAPIE",50,0)
 S (DIE,DIC)="^FBAA(162.1,",DA=IN,STAT=$O(STAT(0)),DR="5////^S X=STAT;6///^S X=TAC;7///^S X=FBINTOT;8///^S X=LCNT" D ^DIE G:$D(FBTOUT) Q^FBAAPIE1 W !!,"Invoice No.: ",IN," Completed!" W:FBINTOT>0 ?45,"Invoice Total: $ ",$J(FBINTOT,1,2)
"RTN","FBAAPIE",51,0)
MORE K STAT,FBHX W ! S DIR("A")="Want to enter another Invoice",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR G Q^FBAAPIE1:$D(DIRUT)!('Y),ENTER
"RTN","FBAAPIE",52,0)
 Q
"RTN","FBAAPIE",53,0)
KILL S DIK="^FBAA(162.1,",DA=IN D ^DIK K DIK Q
"RTN","FBAAPIE",54,0)
DELRX S DIK="^FBAA(162.1,"_DA(1)_",""RX"",",DA=FBDA D ^DIK K DTOUT,DQ,DR,DG S FBTOUT="" W !,"Incomplete prescription entry.  Deleted.",! G CHK
"RTN","FBAAPIE1")
0^6^B16325296^B15539047
"RTN","FBAAPIE1",1,0)
FBAAPIE1 ;AISC/GRR - ENTER FEE PHARMACY INVOICE ;6/5/2009
"RTN","FBAAPIE1",2,0)
 ;;3.5;FEE BASIS;**68,108,124**;JAN 30, 1995;Build 20
"RTN","FBAAPIE1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAAPIE1",4,0)
LISTLI I '$D(^FBAA(162.1,DA,"RX","AB")) W !,"No prescriptions currently in this invoice.",! Q
"RTN","FBAAPIE1",5,0)
 D HOME^%ZIS S FSW=1
"RTN","FBAAPIE1",6,0)
 S FBAAOUT=0 F J=0:0 S J=$O(^FBAA(162.1,DA,"RX",J)) Q:J'>0  I $D(^FBAA(162.1,DA,"RX",J,0)) S Y(0)=^(0) D GETIT Q:FBAAOUT
"RTN","FBAAPIE1",7,0)
 Q
"RTN","FBAAPIE1",8,0)
Q K DIE,DIC,STAT,IN,VIN,DA,LCNT,AC,TAC,DATEF,DR,X,%DT,INVDATE,CNT,DAT,FBAABDT,FBAAEDT,FBAAIN,FBAAOUT,FBAAPN,FBAAPTC,FBBATCH,FBDRUG,FBDX,FBI,FBINTOT,FBINVN,FBMDF,FBPD,FBPOV,FBPT,FBSITE,FBRBC,FBREIM,PSRX,Y,Z,FBFDC,FBMST,FBTTYPE,FBPOP
"RTN","FBAAPIE1",9,0)
 K FBRR,FBT,FBTOV,FBTT,FBTV,FBTYPE,FEEO,FTP,FY,I,J,K,N,NAME,S,SSN,VAL,VAR,VID,VNAM,Z1,Z2,ZZ,D,F,FBAC,FBAP,FBFD,FBPROG,FBRX,FBXX,FSW,PI,POP,PTYPE,T,TA,DFN,D0,FBDEL,FBAUT,FBPSA,A1,A2,CHN,DOB,FBPV,FBQTY,FBSTR,FBSUSP,FID,L,PSA,Q,X1
"RTN","FBAAPIE1",10,0)
 K FB7078,FBASSOC,FBD1,FBLOC,FBVEN,DIRUT,FBAR,FBDA,FBJ,FBID,FBPARCD,FBTOUT,FBVINVDT,FBFPPSC
"RTN","FBAAPIE1",11,0)
 D GETAUTHK^FBAAUTL1
"RTN","FBAAPIE1",12,0)
 Q
"RTN","FBAAPIE1",13,0)
GETIT S FBRX=$P(Y(0),"^"),FBFD=$P(Y(0),"^",3),FBAC=$P(Y(0),"^",4),DFN=+$P(Y(0),"^",5)
"RTN","FBAAPIE1",14,0)
 S SSN=$$SSN^FBAAUTL(DFN),VID=+$P($G(^FBAA(162.1,DA,0)),"^",4),VNAM=$P($G(^FBAAV(VID,0)),"^")
"RTN","FBAAPIE1",15,0)
 I FSW S FSW=0 D HED
"RTN","FBAAPIE1",16,0)
 I $Y+5>IOSL S DIR(0)="E" D ^DIR K DIR S:'Y FBAAOUT=1 Q:FBAAOUT   D HED
"RTN","FBAAPIE1",17,0)
 W !,SSN,?19,$E(FBFD,4,5),"-",$E(FBFD,6,7),"-",$E(FBFD,2,3),?31,FBRX,?44,FBAC
"RTN","FBAAPIE1",18,0)
 Q
"RTN","FBAAPIE1",19,0)
HED W @IOF,"Invoice #: ",DA,?25,"Vendor Name: ",VNAM,!!,"Patient  I.D.",?18,"Fill Date",?30," RX  #",?40,"Amt Claimed",!
"RTN","FBAAPIE1",20,0)
 Q
"RTN","FBAAPIE1",21,0)
CHKK W !!,*7,"There already is a prescription number entered, from this vendor, ",!,"for that fill date. The invoice number is ",$O(^FBAA(162.1,"AL",VIN,PSRX,DATEF,""))_" ."
"RTN","FBAAPIE1",22,0)
 G RDD^FBAAPIE
"RTN","FBAAPIE1",23,0)
CALC ;Calculate Invoice Total
"RTN","FBAAPIE1",24,0)
 S FBINTOT=0 I $D(^FBAA(162.1,IN,"RX")) F I=0:0 S I=$O(^FBAA(162.1,IN,"RX",I)) Q:I'>0  I $D(^(I,0)) S FBINTOT=FBINTOT+$P(^FBAA(162.1,IN,"RX",I,0),"^",16)
"RTN","FBAAPIE1",25,0)
 K I Q
"RTN","FBAAPIE1",26,0)
RDM W ! S DIR("A")="Do you want to continue a previously entered Invoice",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR G Q:$D(DIRUT)!('Y)
"RTN","FBAAPIE1",27,0)
RD2 W !! S DIC="^FBAA(162.1,",DIC(0)="AEQM",DIC("S")="I $P(^(0),U,5)'=4" D ^DIC G Q:X="^"!(X=""),RD2:Y<0 S (DA,DA(1),IN)=+Y,VIN=$P(^(0),"^",4)
"RTN","FBAAPIE1",28,0)
 S INVDATE=$$GET1^DIQ(162.1,DA_",",12,"I") ;Load Inv Rcvd Date for validity check of Rx fill Date in RDD^FBAAPIE
"RTN","FBAAPIE1",29,0)
 D CALC W:FBINTOT>0 !,?30,"Current Total: $ "_$J(FBINTOT,1,2)
"RTN","FBAAPIE1",30,0)
RD3 W ! S DIR("A")="Want to list previously entered line items",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR G Q:$D(DIRUT) D:Y LISTLI
"RTN","FBAAPIE1",31,0)
 S LCNT=+$P(^FBAA(162.1,IN,0),"^",9),TAC=+$P(^(0),"^",6),STAT=+$P(^(0),"^",5),STAT(STAT)="",FBFPPSC=$P(^FBAA(162.1,IN,0),"^",13) G RDP^FBAAPIE
"RTN","FBAAPIE1",32,0)
 Q
"RTN","FBAAPIE1",33,0)
RX2 W !!,*7,"This prescription number already exsists in this invoice.",!
"RTN","FBAAPIE1",34,0)
 W ! S DIR("A")="Do you wish to enter this prescription again",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR G CHK^FBAAPIE:$D(DIRUT),RDRX^FBAAPIE:'Y,RXADD^FBAAPIE
"RTN","FBAAPIE1",35,0)
 Q
"RTN","FBAAPIE1",36,0)
PROB W !!,"You do not have access to the Fee Invoice File, contact your IRM Service.",! G Q
"RTN","FBAAPIE1",37,0)
CHK2 ;Checks for duplicate payments on all linked vendors.
"RTN","FBAAPIE1",38,0)
 S FBJ=0 F  S FBJ=$O(FBAR(FBJ)) Q:$S('FBJ:1,$D(^FBAA(162.1,"AL",FBJ,PSRX,DATEF)):1,1:0)
"RTN","FBAAPIE1",39,0)
 Q
"RTN","FBAAUTL")
0^13^B25814851^B24039594
"RTN","FBAAUTL",1,0)
FBAAUTL ;AISC/GRR,SBW-Fee Basis Utility Routine ; 4/23/10 3:06pm
"RTN","FBAAUTL",2,0)
 ;;3.5;FEE BASIS;**101,114,108,124**;JAN 30, 1995;Build 20
"RTN","FBAAUTL",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAAUTL",4,0)
DATE N FBDT S FBPOP=0 K BEGDATE,ENDDATE K:$G(%DT)'["A" %DT W !!,"**** Date Range Selection ****"
"RTN","FBAAUTL",5,0)
 S FBDT=$S($D(%DT):1,1:0) W ! S %DT=$S(FBDT:%DT,1:"APEX"),%DT("A")="   Beginning DATE : " D ^%DT S:Y<0 FBPOP=1 Q:Y<0  S (%DT(0),BEGDATE)=Y
"RTN","FBAAUTL",6,0)
 W ! S %DT=$S(FBDT:%DT,1:"AEX"),%DT("A")="   Ending    DATE : " D ^%DT K %DT S:Y<0 FBPOP=1 Q:Y<0  W ! S ENDDATE=Y
"RTN","FBAAUTL",7,0)
 Q
"RTN","FBAAUTL",8,0)
 ;
"RTN","FBAAUTL",9,0)
ZIS S ZTRTN=PGM,ZTSAVE="",FBPOP=0 F I=1:1 Q:$P(VAR,"^",I)']""  S ZTSAVE($P(VAR,"^",I))=""
"RTN","FBAAUTL",10,0)
 I '$D(ZTDESC) S ZTDESC=$S($D(PGM):PGM,1:"UNKNOWN OPTION")
"RTN","FBAAUTL",11,0)
 W ! S %ZIS="QMP" D ^%ZIS S:POP FBPOP=1 Q:POP  I $D(IO("Q")) K IO("Q"),ZTIO D ^%ZTLOAD W:$D(ZTSK) !,*7,"REQUEST QUEUED",!,"Task #: ",$G(ZTSK) K I,ZTSK,ZTIO,ZTSAVE,ZTRTN D HOME^%ZIS S FBPOP=1 Q
"RTN","FBAAUTL",12,0)
 Q
"RTN","FBAAUTL",13,0)
 ;
"RTN","FBAAUTL",14,0)
CLOSE I '$D(ZTQUEUED) D ^%ZISC
"RTN","FBAAUTL",15,0)
 K IOP,ZTDESC,ZTRTN,ZTSAVE,ZTDTH,VAR,VAL,PGM,FBPOP,POP Q
"RTN","FBAAUTL",16,0)
 ;
"RTN","FBAAUTL",17,0)
D S Y=$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",$E(Y,4,5))_" "_$S(Y#100:$J(Y#100\1,2)_",",1:"")_(Y\10000+1700)_$S(Y#1:"  "_$E(Y_0,9,10)_":"_$E(Y_"000",11,12),1:"") Q
"RTN","FBAAUTL",18,0)
SITEP ;SET FBSITE(0),FBSITE(1) VARIABLE TO FEE SITE PARAMETERS
"RTN","FBAAUTL",19,0)
 S FBPOP=0,FBSITE(0)=$G(^FBAA(161.4,1,0)) S:FBSITE(0)']"" FBPOP=1
"RTN","FBAAUTL",20,0)
 S FBSITE(1)=$G(^FBAA(161.4,1,1)) S:FBSITE(1)']"" FBPOP=1
"RTN","FBAAUTL",21,0)
 S FBSITE("FBNUM")=$G(^FBAA(161.4,1,"FBNUM")) S:FBSITE("FBNUM")']"" FBPOP=1
"RTN","FBAAUTL",22,0)
 W:FBPOP !,*7,"Fee Basis Site Parameters must be entered to proceed",!
"RTN","FBAAUTL",23,0)
 Q
"RTN","FBAAUTL",24,0)
TM S X=$E($P(X,".",2)_"0000",1,4),%=X>1159 S:X>1259 X=X-1200 S X=X\100_":"_$E(X#100+100,2,3)_" "_$E("AP",%+1)_"M" Q
"RTN","FBAAUTL",25,0)
PDF S:Y Y=$E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3) Q
"RTN","FBAAUTL",26,0)
GETNXB ;GET NEXT AVAILABLE BATCH NUMBER
"RTN","FBAAUTL",27,0)
 L +^FBAA(161.4):$G(DILOCKTM,3) I '$T D  G GETNXB
"RTN","FBAAUTL",28,0)
 .W !,"Another user is opening a batch.  Trying again.",!
"RTN","FBAAUTL",29,0)
 I '$D(^FBAA(161.4,1,"FBNUM")) S ^FBAA(161.4,1,"FBNUM")="1^1"
"RTN","FBAAUTL",30,0)
 I '$P($G(^FBAA(161.4,1,"FBNUM")),"^") S $P(^("FBNUM"),"^")=1
"RTN","FBAAUTL",31,0)
 S FBBN=$P(^FBAA(161.4,1,"FBNUM"),"^")
"RTN","FBAAUTL",32,0)
 ;I FBBN>99899,$S('$D(^FBAA(161.4,1,"PURGE")):1,$P(^FBAA(161.4,1,"PURGE"),"^",1)'>0:1,1:"") D WARNBT
"RTN","FBAAUTL",33,0)
 I $P(^FBAA(161.7,0),U,4)>99899 D WARNBT ;*114
"RTN","FBAAUTL",34,0)
 S $P(^FBAA(161.4,1,"FBNUM"),"^",1)=$S(FBBN+1>99999:1,1:FBBN+1) I '$$CHKBI^FBAAUTL4(FBBN,1) L -^FBAA(161.4) G GETNXB
"RTN","FBAAUTL",35,0)
 L -^FBAA(161.4) Q
"RTN","FBAAUTL",36,0)
WARNBT W !,*7,"There are ",99999-FBBN," batches left before the BATCH PURGE routine",!,"needs to be run. Contact your IRM Service!",!!
"RTN","FBAAUTL",37,0)
 Q
"RTN","FBAAUTL",38,0)
GETNXI ;GET NEXT AVAILABLE INVOICE NUMBER 
"RTN","FBAAUTL",39,0)
 L +^FBAA(161.4):$G(DILOCKTM,3) I '$T D  G GETNXI
"RTN","FBAAUTL",40,0)
 .W !,"Another user is obtaining an invoice number.  Trying again.",!
"RTN","FBAAUTL",41,0)
 I '$D(^FBAA(161.4,1,"FBNUM")) S ^FBAA(161.4,1,"FBNUM")="1^1"
"RTN","FBAAUTL",42,0)
 I '$P($G(^FBAA(161.4,1,"FBNUM")),U,2) S $P(^("FBNUM"),U,2)=1
"RTN","FBAAUTL",43,0)
 S FBAAIN=$P(^FBAA(161.4,1,"FBNUM"),"^",2),$P(^("FBNUM"),"^",2)=$S(FBAAIN+1>9999999:1,1:FBAAIN+1) I '$$CHKBI^FBAAUTL4(FBAAIN) L -^FBAA(161.4) G GETNXI
"RTN","FBAAUTL",44,0)
 L -^FBAA(161.4) Q
"RTN","FBAAUTL",45,0)
PDATE S FBPDT=$P("January^February^March^April^May^June^July^August^September^October^November^December","^",$E(Y,4,5))_" "_$S(Y#100:$J(Y#100\1,2)_", ",1:"")_(Y\10000+1700)_$S(Y#1:"  "_$E(Y_0,9,10)_":"_$E(Y_"000",11,12),1:"") Q
"RTN","FBAAUTL",46,0)
DATCK S HOLDY=Y,HOLDY=$S($P(HOLDY,"^",2):$P(HOLDY,"^",2),1:HOLDY)
"RTN","FBAAUTL",47,0)
 I $D(FBAAID),Y>FBAAID D  K X Q
"RTN","FBAAUTL",48,0)
 .N SHODAT S SHODAT=$E(FBAAID,4,5)_"/"_$E(FBAAID,6,7)_"/"_$E(FBAAID,2,3)
"RTN","FBAAUTL",49,0)
 .W !!,*7,?5,"*** Date of Service cannot be later than",!?8," Invoice Received Date ("_SHODAT_") !!!",!
"RTN","FBAAUTL",50,0)
 I $D(FBAABDT),$D(FBAAEDT),(Y<FBAABDT!(Y>FBAAEDT)) D  K X
"RTN","FBAAUTL",51,0)
 .N PRIORLAT,AUTHDAT,SHODAT
"RTN","FBAAUTL",52,0)
 .S PRIORLAT=$S($P(Y,"^",2)<FBAABDT:"prior to ",1:"later than ")
"RTN","FBAAUTL",53,0)
 .S AUTHDAT=$S($P(Y,"^",2)<FBAABDT:FBAABDT,1:FBAAEDT)
"RTN","FBAAUTL",54,0)
 .S SHODAT=$E(AUTHDAT,4,5)_"/"_$E(AUTHDAT,6,7)_"/"_$E(AUTHDAT,2,3)
"RTN","FBAAUTL",55,0)
 .W !!,*7,?5,"*** Date of Service cannot be ",PRIORLAT
"RTN","FBAAUTL",56,0)
 .W !?8," Authorization period ("_SHODAT_") !!!",!
"RTN","FBAAUTL",57,0)
 S Y=HOLDY Q
"RTN","FBAAUTL",58,0)
 ;
"RTN","FBAAUTL",59,0)
DATX(X) ;external output function for date format
"RTN","FBAAUTL",60,0)
 ;INPUT = FM internal date format (time optional)
"RTN","FBAAUTL",61,0)
 ;OUTPUT = date/time with slashes
"RTN","FBAAUTL",62,0)
 Q $$FMTE^XLFDT(X,2)
"RTN","FBAAUTL",63,0)
 ;
"RTN","FBAAUTL",64,0)
STATION ;GET STATION NUMBER FROM INSTITUTION FILE
"RTN","FBAAUTL",65,0)
 I '$D(FBSITE(1)) D SITEP
"RTN","FBAAUTL",66,0)
 I $S('$D(FBSITE(1)):1,$P(FBSITE(1),"^",3)="":1,'$D(^DIC(4,$P(FBSITE(1),"^",3),0)):1,'$D(^DIC(4,$P(FBSITE(1),"^",3),99)):1,'+$P(^DIC(4,$P(FBSITE(1),"^",3),99),"^"):1,1:0) G NOSTA
"RTN","FBAAUTL",67,0)
 S (FBSN,FBAASN)=$S($D(^DIC(4,$P(FBSITE(1),"^",3),99)):$E(^(99),1,3),1:999)
"RTN","FBAAUTL",68,0)
 Q
"RTN","FBAAUTL",69,0)
NOSTA S FB("ERROR")=1 I '$D(ZTQUEUED) W !!,*7,"Unable to determine Station Number. Check Fee Site Parameters or Station Number in the Institution File.",!!
"RTN","FBAAUTL",70,0)
 Q
"RTN","FBAAUTL",71,0)
 ;
"RTN","FBAAUTL",72,0)
HD ;set transmission header
"RTN","FBAAUTL",73,0)
 I '$D(FBSITE(1)) S FBSITE(1)=$G(^FBAA(161.4,1,1))
"RTN","FBAAUTL",74,0)
 S FBHD=$$HDR^FBAAUTL3() I FBHD']"" S FB("ERROR")=1 W !,"Transmission header must exist in FEE BASIS SITE PARAMETER file",!,"before you can proceed.",*7,!
"RTN","FBAAUTL",75,0)
 Q
"RTN","FBAAUTL",76,0)
 ;
"RTN","FBAAUTL",77,0)
SSN(PID,BID,DOD) ;
"RTN","FBAAUTL",78,0)
 ;PID = DFN of Patient. If this is all that is past,
"RTN","FBAAUTL",79,0)
 ;full Pt.ID (000-00-0000) will be returned.
"RTN","FBAAUTL",80,0)
 ;If BID = 1 the call will return last 4 of Pt.ID only.
"RTN","FBAAUTL",81,0)
 ;If DOD is defined to internal entry # of eligibility the appropriate
"RTN","FBAAUTL",82,0)
 ;Pt.ID will be returned.
"RTN","FBAAUTL",83,0)
 N DFN,FBSSN
"RTN","FBAAUTL",84,0)
 S DFN=PID
"RTN","FBAAUTL",85,0)
 I 'DFN Q "Unknown"
"RTN","FBAAUTL",86,0)
 S:'$D(BID) BID="" S:$D(DOD) VAPTYP=DOD
"RTN","FBAAUTL",87,0)
 D PID^VADPT6 I VAERR K VAERR Q "Unknown"
"RTN","FBAAUTL",88,0)
 S FBSSN=$S(BID:VA("BID"),1:VA("PID"))
"RTN","FBAAUTL",89,0)
 K VA("BID"),VA("PID"),VAERR,VAPTYP
"RTN","FBAAUTL",90,0)
 Q FBSSN
"RTN","FBAAUTL",91,0)
 ;
"RTN","FBAAUTL",92,0)
SSNL4(SSN) ;Convert 1st 5 digits of SSN to X (Only print last 4 digits of SSN)
"RTN","FBAAUTL",93,0)
 ;Input:
"RTN","FBAAUTL",94,0)
 ;   SSN - SSN in 9 digit or ###-##-#### format
"RTN","FBAAUTL",95,0)
 ;     Pseudo SSN is also allowed as input
"RTN","FBAAUTL",96,0)
 ;Output
"RTN","FBAAUTL",97,0)
 ;   SSN - SSN in XXXXX#### or XXX-XX-#### format
"RTN","FBAAUTL",98,0)
 ;     Pseudo SSN will be changed as above with passed "P" at end
"RTN","FBAAUTL",99,0)
 ; X represent actual X and # represent digit
"RTN","FBAAUTL",100,0)
 ;
"RTN","FBAAUTL",101,0)
 S SSN=$G(SSN)
"RTN","FBAAUTL",102,0)
 ;Change SSN ######### to XXXXX####
"RTN","FBAAUTL",103,0)
 S:SSN?9N0.1"P" $E(SSN,1,5)="XXXXX"
"RTN","FBAAUTL",104,0)
 ;Change SSN ###-##-#### to XXX-XX-####
"RTN","FBAAUTL",105,0)
 S:SSN?3N1"-"2N1"-"4N0.1"P" $E(SSN,1,7)="XXX-XX-"
"RTN","FBAAUTL",106,0)
 Q SSN
"RTN","FBCHEP")
0^11^B33379064^B33211512
"RTN","FBCHEP",1,0)
FBCHEP ;AISC/DMK-ENTER PAYMENT FOR CONTRACT HOSPITAL ;8/18/2004
"RTN","FBCHEP",2,0)
 ;;3.5;FEE BASIS;**4,61,77,82,122,108,124**;JAN 30, 1995;Build 20
"RTN","FBCHEP",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBCHEP",4,0)
 S FBAAPTC="V",FBAAOUT=0
"RTN","FBCHEP",5,0)
RD K FBAAID,FBAAVID S FBRESUB="" D GETVET^FBAAUTL1 G:DFN']"" Q
"RTN","FBCHEP",6,0)
 S FBPROG="I $P(^(0),U,3)=6,($P(^(0),U,9)'[""FB583"")" D GETAUTH^FBAAUTL1 G RD:$D(DUOUT),RD:FTP']""
"RTN","FBCHEP",7,0)
 ;W !!,?25,"<  ASSOCIATED 7078  >",!!
"RTN","FBCHEP",8,0)
 ;S DIC="^FB7078(",DA=FB7078,DR="0;1" D EN^DIQ
"RTN","FBCHEP",9,0)
 I FB7078="" W !,*7,"No 7078 on file for this authorization." G RD
"RTN","FBCHEP",10,0)
 S FBI7078=FB7078_";FB7078("
"RTN","FBCHEP",11,0)
 I $D(^FBAAI("E",FBI7078)) S FBAAIN=$O(^FBAAI("E",FBI7078,0)) G OUT
"RTN","FBCHEP",12,0)
SETINV S FBZ(0)=^FB7078(FB7078,0),FBVET=$P(FBZ(0),"^",3),FBVEN=$P(FBZ(0),"^",2),FBVEN=$P(FBVEN,";",1)
"RTN","FBCHEP",13,0)
 ;
"RTN","FBCHEP",14,0)
EN583 ;Entry from 583 enter payment
"RTN","FBCHEP",15,0)
 I FBAAPTC="R" D ^FBAACO0
"RTN","FBCHEP",16,0)
 S DA=FBVEN D EN1^FBAAVD
"RTN","FBCHEP",17,0)
 I $P($G(^FBAAV(FBVEN,"ADEL")),U)="Y" W !!,*7,"Vendor is flagged for Austin deletion!" G Q
"RTN","FBCHEP",18,0)
 D SITEP^FBAAUTL G Q:FBPOP
"RTN","FBCHEP",19,0)
 S FBAAMPI=$P(FBSITE("FBNUM"),U,4)
"RTN","FBCHEP",20,0)
 ;
"RTN","FBCHEP",21,0)
RDV S FBVE="" S:$D(^FBAAV(FBVEN,"AMS")) FBVE=$P(^("AMS"),"^",2) S:$G(FBVE)'="Y" FBVE="N"
"RTN","FBCHEP",22,0)
 I FBVE="Y" W *7,!!,"Vendor is listed as 'exempt from the pricer'." S DIR(0)="Y",DIR("A")="Do you wish to keep this invoice exempt from the pricer",DIR("B")="Yes" D ^DIR K DIR G Q:$D(DIRUT) S FBVE=$S(Y=1:"Y",1:"N")
"RTN","FBCHEP",23,0)
 I $G(FBVE)'="Y",($P($G(^FBAAV(FBVEN,0)),"^",17)']"") W !!,*7,"Medicare ID Number is needed for this Vendor!" S DIE="^FBAAV(",DR=22 D ^DIE K DIE G Q:$D(DTOUT)!('$L(X))
"RTN","FBCHEP",24,0)
 ;
"RTN","FBCHEP",25,0)
BAT S DIC="^FBAA(161.7,",DIC(0)="AEQMZ",DIC("S")="I $P(^(0),U,3)=""B9""&($P(^(0),U,5)=DUZ)&($P(^(0),U,15)=""Y"")&($G(^(""ST""))=""O"")&(FBAAMPI>$P(^(0),U,10))" W ! D ^DIC K DIC
"RTN","FBCHEP",26,0)
 G Q:X="^"!(X=""),BAT:Y<0 S FBAABE=+Y,FBY(0)=Y(0),Z1=$P(FBY(0),"^",11),BO=$P(FBY(0),"^",2),Z2=$P(FBY(0),"^",10),FBSTN=$P(FBY(0),"^",8),FBCHOB=FBSTN_"-"_$P(FBY(0),"^",2),FBEXMPT=$P(FBY(0),"^",18) S FBAAOUT=0 D CHK I FBAAOUT K Y,Y(0),FBAABE G BAT
"RTN","FBCHEP",27,0)
 I FBI7078["FB7078(",BO'=$P($P(FBZ(0),U),".") W !,*7,"Obligation number on batch does not match 1358.",!,"Obligation number on batch must be ",$P($P(FBZ(0),U),"."),".",! G BAT
"RTN","FBCHEP",28,0)
 S FBINC=$S($P(FBY(0),"^",10)="":0,1:$P(FBY(0),"^",10)),FBLN=$S($P(FBY(0),"^",11)="":0,1:$P(FBY(0),"^",11))
"RTN","FBCHEP",29,0)
GETNXI D GETNXI^FBAAUTL
"RTN","FBCHEP",30,0)
 W !!,"Invoice # ",FBAAIN," assigned to this Invoice"
"RTN","FBCHEP",31,0)
RIN S CALLERID="FBCHEP" D GETINDT^FBAACO1 K CALLERID G Q:$G(FBAAOUT)
"RTN","FBCHEP",32,0)
 ; ask patient control number
"RTN","FBCHEP",33,0)
 S FBCSID=$$ASKPCN^FBUTL5() I FBCSID="^" G Q
"RTN","FBCHEP",34,0)
 ; if U/C then get FPPS Claim ID else ask user
"RTN","FBCHEP",35,0)
 I $D(FB583) S FBFPPSC=$P($G(^FB583(FB583,5)),U) W !,"FPPS CLAIM ID: ",$S(FBFPPSC="":"N/A",1:FBFPPSC)
"RTN","FBCHEP",36,0)
 E  S FBFPPSC=$$FPPSC^FBUTL5() I FBFPPSC=-1 G Q
"RTN","FBCHEP",37,0)
 ; if EDI claim then ask FPPS line item
"RTN","FBCHEP",38,0)
 I FBFPPSC]"" S FBFPPSL=$$FPPSL^FBUTL5(,1) I FBFPPSL=-1 G Q
"RTN","FBCHEP",39,0)
 ; compute default Covered Days
"RTN","FBCHEP",40,0)
 S FBCDAYS=$$FMDIFF^XLFDT(FBAAEDT,FBAABDT)
"RTN","FBCHEP",41,0)
 I FBCDAYS=0 S FBCDAYS=1
"RTN","FBCHEP",42,0)
 S FBAAMM=$S(FBAAPTC="R":"",$D(FB583):"",1:1) D PPT^FBAACO1()
"RTN","FBCHEP",43,0)
DIC S DIC="^FBAAI(",DIC(0)="LQ",DLAYGO=162.5,X=FBAAIN D ^DIC G Q:Y<0
"RTN","FBCHEP",44,0)
 S DA=+Y,DIE=DIC,DR="[FBCH ENTER PAYMENT]",DIE("NO^")=""
"RTN","FBCHEP",45,0)
 D
"RTN","FBCHEP",46,0)
 . N ICDVDT S ICDVDT=$G(FBAABDT) D ^DIE
"RTN","FBCHEP",47,0)
 ; file adjustment reasons
"RTN","FBCHEP",48,0)
 D FILEADJ^FBCHFA(DA_",",.FBADJ)
"RTN","FBCHEP",49,0)
 ; file remittance remarks
"RTN","FBCHEP",50,0)
 D FILERR^FBCHFR(DA_",",.FBRRMK)
"RTN","FBCHEP",51,0)
 ; file Line Item Rendering providers
"RTN","FBCHEP",52,0)
 D FILERP^FBUTL8(DA_",",.FBPROV) ;FB*3.5*122
"RTN","FBCHEP",53,0)
 K DIE,DIC,D,DA,DR
"RTN","FBCHEP",54,0)
 S $P(FBY(0),"^",10)=FBINC+1,$P(FBY(0),"^",11)=FBLN+1,$P(FBY(0),"^",18)=FBEXMPT,^FBAA(161.7,FBAABE,0)=FBY(0) ;D:'$D(FBNOPTF) PTF G Q:$D(FB583),RD
"RTN","FBCHEP",55,0)
 D
"RTN","FBCHEP",56,0)
 . N FBX
"RTN","FBCHEP",57,0)
 . S FBX=FBAAMPI-(FBINC+1)
"RTN","FBCHEP",58,0)
 . I FBX<6 W !,$C(7),"Warning, you can only enter ",FBX," more invoices in this batch!",!
"RTN","FBCHEP",59,0)
 D:'$D(FBNOPTF) PTF
"RTN","FBCHEP",60,0)
 G Q:$D(FB583),RD
"RTN","FBCHEP",61,0)
OUT W !!,*7,?3,"Invoice number ",FBAAIN," has already been entered for this authorization.",!,?3,"Use the Contract Hospital 'Invoice Edit' option if needed.",!
"RTN","FBCHEP",62,0)
 ;check if user wants to add a second invoice for this 7078
"RTN","FBCHEP",63,0)
 W ! S DIR("A")="Want to add another invoice for this episode of care",DIR("B")="No",DIR(0)="Y" D ^DIR K DIR I Y S (FBNOPTF,FBRESUB)=1 G SETINV
"RTN","FBCHEP",64,0)
Q K BO,CNT,D,DA,DAT,DIC,DIE,DLAYGO,DR,FB7078,FBAABDT,FBAABE,FBAAEDT,FBAAID,FBAAIN,FBAAOUT,FBAAPTC,FBDX,FBTT,FBTYPE,FBVEN,FBVET,FBXX,FTP,I,J,FBK,PI,FBPOP,PTYPE,S,FBZ,Z1,FBI,FBPROG,FBRR,FBSW,FBPOV,FBPT,FBY,T,Y,Z1,Z2,ZZ,FBPSA,A,FBI7078
"RTN","FBCHEP",65,0)
 K FBCHOB,FBAUT,FBSEQ,X,FBSITE,F,FBSTN,FBASSOC,FBLOC,DUOUT,PSA,FBCOUNTY,DFN,FBNOPTF,DIRUT,FBVE,FBAAOUT,FBEXMPT,FBAAPN,FBAMTC,FBDEL,FBINC,FBLN,FBRESUB
"RTN","FBCHEP",66,0)
 K FBD1,FBFDC,FBMST,FBTTYPE,FB583
"RTN","FBCHEP",67,0)
 K FBCSID,FBFPPSC,FBFPPSL,FBCDAYS,FBAMTP,FBADJ,FBRRMK,FBAAMPI,FBV
"RTN","FBCHEP",68,0)
 D GETAUTHK^FBAAUTL1
"RTN","FBCHEP",69,0)
 Q
"RTN","FBCHEP",70,0)
PTF I $G(FBVET),$G(FBI7078)["FB583" S:'$G(DFN) DFN=FBVET D PTFC^FBUTL6(DFN,$P(FBZ(0),"^",4))
"RTN","FBCHEP",71,0)
 Q
"RTN","FBCHEP",72,0)
PRBT ;Entry point for patient reimbursement option
"RTN","FBCHEP",73,0)
 ;
"RTN","FBCHEP",74,0)
 S FBAAPTC="R"
"RTN","FBCHEP",75,0)
 G RD
"RTN","FBCHEP",76,0)
CHK ;Check for vendor and batch being exempt from pricer
"RTN","FBCHEP",77,0)
 I $G(FBVE)'="Y"&($G(FBVE)'="N") S FBVE="N"
"RTN","FBCHEP",78,0)
 I $G(FBEXMPT)="Y" Q:FBVE="Y"  G OPEN:FBVE="N"
"RTN","FBCHEP",79,0)
 I $G(FBEXMPT)="N" Q:FBVE="N"  G OPEN:FBVE="Y"
"RTN","FBCHEP",80,0)
 I '$G(FBEXMPT)&($G(Z2)'>0) S FBEXMPT=FBVE Q
"RTN","FBCHEP",81,0)
 I '$G(FBEXMPT)&($G(Z2)>0) S $P(^FBAA(161.7,FBAABE,0),"^",18)="N",FBEXMPT="N" G CHK
"RTN","FBCHEP",82,0)
 Q
"RTN","FBCHEP",83,0)
OPEN W *7,!!,"This Invoice may not be added to Batch # ",+FBY(0),".",!,"***You may not add a ",$S(FBVE="Y":"pricer exempt",1:"non-exempt")," invoice to a ",$S(FBVE="Y":"non-exempt",1:"pricer exempt")," batch.***"
"RTN","FBCHEP",84,0)
 S DIR(0)="Y",DIR("A")="Do you want to open a new batch at this time",DIR("B")="Y" D ^DIR K DIR S:$D(DIRUT)!('Y) FBAAOUT=1 Q:FBAAOUT  D RCHOP^FBAAOB S FBEXMPT=FBVE D
"RTN","FBCHEP",85,0)
 .S FBY(0)=$G(^FBAA(161.7,FBAABE,0)),Z1=$P(FBY(0),"^",11),BO=$P(FBY(0),"^",2),Z2=$P(FBY(0),"^",10),FBSTN=$P(FBY(0),"^",8),FBCHOB=FBSTN_"-"_$P(FBY(0),"^",2)
"RTN","FBCHEP",86,0)
 Q
"RTN","FBCHEP",87,0)
IPAC ;
"RTN","FBCHEP1")
0^12^B39779983^B33647893
"RTN","FBCHEP1",1,0)
FBCHEP1 ;AISC/DMK-EDIT PAYMENT FOR CONTRACT HOSPITAL ;7/8/2003
"RTN","FBCHEP1",2,0)
 ;;3.5;FEE BASIS;**38,61,122,133,108,124**;JAN 30, 1995;Build 20
"RTN","FBCHEP1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBCHEP1",4,0)
EDIT ;ENTRY POINT TO EDIT PAYMENT
"RTN","FBCHEP1",5,0)
 N LASTDX,LASTPROC
"RTN","FBCHEP1",6,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBCHEP1",7,0)
BT W ! S DIC="^FBAA(161.7,",DIC(0)="AEQMZ",DIC("S")="I $P(^(0),U,3)=""B9""&($P(^(0),U,15)=""Y"")",DIC("S")=$S($D(^XUSEC("FBAASUPERVISOR",DUZ)):DIC("S"),1:DIC("S")_"&($P(^(0),U,5)=DUZ)") D ^DIC
"RTN","FBCHEP1",8,0)
 G END:X=""!(X="^"),BT:Y<0 S FBN=+Y,FBN(0)=Y(0)
"RTN","FBCHEP1",9,0)
 S FBEXMPT=$P(FBN(0),"^",18)
"RTN","FBCHEP1",10,0)
 S FBSTAT=^FBAA(161.7,FBN,"ST"),FBBAMT=$S($P(FBN(0),"^",9)="":0,1:$P(FBN(0),"^",9))
"RTN","FBCHEP1",11,0)
 I FBSTAT="C"&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,?3,"You must Reopen the batch prior to editting the invoice.",! G END
"RTN","FBCHEP1",12,0)
 I FBSTAT="S"!(FBSTAT="P")!(FBSTAT="R")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,?3,"You must be a holder of the 'FBAASUPERVISOR' security key",!,?3,"to edit this invoice.",! G END
"RTN","FBCHEP1",13,0)
 I FBSTAT="T"!(FBSTAT="V") W !!,?3,"Batch has already been sent to Austin for payment.",! G END
"RTN","FBCHEP1",14,0)
INV W ! S DIC="^FBAAI(",DIC(0)="AEQZ",DIC("S")="I $P(^(0),U,17)=FBN" D ^DIC K DIC("S") G BT:X=""!(X="^"),INV:Y<0 S FBI=+Y
"RTN","FBCHEP1",15,0)
 S FBK=$S($P(^FBAAI(FBI,0),"^",9)="":0,1:$P(^(0),"^",9))
"RTN","FBCHEP1",16,0)
 S FBLISTC="",FBAAI=FBI W @IOF D START^FBCHDI2 S FBI=FBAAI I $P(^FBAAI(FBI,0),"^",9)="" S FBPRICE=""
"RTN","FBCHEP1",17,0)
 ; set FB1725 flag = true if payment for a 38 U.S.C. 1725 claim
"RTN","FBCHEP1",18,0)
 D
"RTN","FBCHEP1",19,0)
 . N FBY
"RTN","FBCHEP1",20,0)
 . S FBY=$G(^FBAAI(FBI,0))
"RTN","FBCHEP1",21,0)
 . S FB1725=$S($P(FBY,U,5)["FB583":+$P($G(^FB583(+$P(FBY,U,5),0)),U,28),1:0)
"RTN","FBCHEP1",22,0)
 ; get values of FPPS Claim ID and Line Item
"RTN","FBCHEP1",23,0)
 S FBFPPSC=$P($G(^FBAAI(FBI,3)),U)
"RTN","FBCHEP1",24,0)
 S FBFPPSL=$P($G(^FBAAI(FBI,3)),U,2)
"RTN","FBCHEP1",25,0)
 ; load current adjustment data
"RTN","FBCHEP1",26,0)
 D LOADADJ^FBCHFA(FBI_",",.FBADJ)
"RTN","FBCHEP1",27,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBCHEP1",28,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBCHEP1",29,0)
 ; load current remittance remark data
"RTN","FBCHEP1",30,0)
 D LOADRR^FBCHFR(FBI_",",.FBRRMK)
"RTN","FBCHEP1",31,0)
 ; load Item level Rendering provider data
"RTN","FBCHEP1",32,0)
 D LOADRP^FBUTL8(FBI_",",.FBPROV) ;FB*3.5*122
"RTN","FBCHEP1",33,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBCHEP1",34,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBCHEP1",35,0)
 S LASTDX=$$LAST(FBI,"DX"),LASTPROC=$$LAST(FBI,"PROC")
"RTN","FBCHEP1",36,0)
 S (DIE,DIC)="^FBAAI(",DIC(0)="AEQM",DA=FBI,DR="[FBCH EDIT PAYMENT]" W !
"RTN","FBCHEP1",37,0)
 D
"RTN","FBCHEP1",38,0)
 . N ICDVDT,DFN,FB583,FBAAMM1,FBAAPTC,FBCNTRA,FBCNTRP,FBV,FBVEN,FTP
"RTN","FBCHEP1",39,0)
 . S ICDVDT=$$FRDTINV^FBCSV1(DA) ;date for files 80 and 80.1 identifier
"RTN","FBCHEP1",40,0)
 . ;get variables for cal to PPT^FBAACO1
"RTN","FBCHEP1",41,0)
 . S FBAAMM1=$P($G(^FBAAI(DA,2)),U,3)
"RTN","FBCHEP1",42,0)
 . S FBCNTRP=$P($G(^FBAAI(DA,5)),U,8)
"RTN","FBCHEP1",43,0)
 . S FBV=$P($G(^FBAAI(DA,0)),U,3)
"RTN","FBCHEP1",44,0)
 . S DFN=$P($G(^FBAAI(DA,0)),U,4)
"RTN","FBCHEP1",45,0)
 . S FBAAPTC=$P($G(^FBAAI(DA,0)),U,13)
"RTN","FBCHEP1",46,0)
 . S X=$P($G(^FBAAI(DA,0)),U,5)
"RTN","FBCHEP1",47,0)
 . S:X[";FB583(" FB583=+X
"RTN","FBCHEP1",48,0)
 . S FTP=$S(X]"":+$O(^FBAAA("AG",X,DFN,0)),1:"")
"RTN","FBCHEP1",49,0)
 . S FBVEN=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,4),1:"")
"RTN","FBCHEP1",50,0)
 . S FBCNTRA=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,22),1:"")
"RTN","FBCHEP1",51,0)
 . D ^DIE
"RTN","FBCHEP1",52,0)
 ; if adjustment data changed then file
"RTN","FBCHEP1",53,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBCHFA(FBI_",",.FBADJ)
"RTN","FBCHEP1",54,0)
 ; if remit remark data changed then file
"RTN","FBCHEP1",55,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBCHFR(FBI_",",.FBRRMK)
"RTN","FBCHEP1",56,0)
 ; remove any gaps in codes
"RTN","FBCHEP1",57,0)
 D RMVGAP(FBI,1)
"RTN","FBCHEP1",58,0)
 ; if line item rendering providers exist then file FB*3.5*133
"RTN","FBCHEP1",59,0)
 I $D(FBPROV) D FILERP^FBUTL8(FBI_",",.FBPROV)
"RTN","FBCHEP1",60,0)
 K FBAAMM,FBAAMM1
"RTN","FBCHEP1",61,0)
 S FBNK=$P(^FBAAI(FBI,0),"^",9)
"RTN","FBCHEP1",62,0)
 I FBNK-FBK S $P(^FBAA(161.7,FBN,0),"^",9)=FBBAMT+(FBNK-FBK)
"RTN","FBCHEP1",63,0)
END K DA,DFN,DIC,DIE,DR,FBAAOUT,FBDX,FBI,FBIN,FBLISTC,FBN,FBPROC,FBSTAT,FBVEN,FBVID,J,K,L,POP,Q,VA,VADM,X,FBIFN,Y,FBPRICE,FBK,FBNK,FB583,FBAAPN,FBASSOC,FBDEL,FBLOC,DAT
"RTN","FBCHEP1",64,0)
 K CNT,D0,FB7078,FBAABDT,FBAAEDT,FBASSOC,FBAUT,FBLOC,FBPROG,FBPSA,FBPT,FBRR,FBTT,FBTYPE,FBXX,FTP,PI,PTYPE,T,Z,ZZ,F,FBPOV,I,TA,VAL,DUOUT,FBVET,FBBAMT,FBAAI,FBEXMPT,FB1725,FBPAMT
"RTN","FBCHEP1",65,0)
 K FBFPPSC,FBFPPSL,FBADJ,FBADJD,FBRRMK,FBRRMKD
"RTN","FBCHEP1",66,0)
 D END^FBCHDI
"RTN","FBCHEP1",67,0)
 Q
"RTN","FBCHEP1",68,0)
 ;
"RTN","FBCHEP1",69,0)
BADDATE(INVRCVDT,TEMPDA) ;Compare edited Invoice Received Date to Treatment Date, reject if before. Called from [FBCH EDIT PAYMENT] template. 
"RTN","FBCHEP1",70,0)
 I INVRCVDT="" Q 0 ;Inv Date not changed, no check necessary
"RTN","FBCHEP1",71,0)
 N TDAT,SHODAT S TDAT=$$GET1^DIQ(162.5,TEMPDA_",",6,"I") I TDAT]"" S SHODAT="TO"
"RTN","FBCHEP1",72,0)
 I TDAT="" S TDAT=$$GET1^DIQ(162.5,TEMPDA_",",5,"I"),SHODAT="FROM"
"RTN","FBCHEP1",73,0)
 I INVRCVDT<TDAT D  Q 1 ;Reject entered date
"RTN","FBCHEP1",74,0)
 .N SHOTDAT S SHOTDAT=$E(TDAT,4,5)_"/"_$E(TDAT,6,7)_"/"_$E(TDAT,2,3) ;Convert TDAT into display format for error message 
"RTN","FBCHEP1",75,0)
 .N MSG1,MSG2 S MSG1="*** Invoice Received Date cannot be before",MSG2=" Treatment "_SHODAT_" Date ("_SHOTDAT_") !!!"
"RTN","FBCHEP1",76,0)
 .W !!?5,*7,MSG1,!?8,MSG2
"RTN","FBCHEP1",77,0)
 Q 0 ;Date entered is OK
"RTN","FBCHEP1",78,0)
 ;
"RTN","FBCHEP1",79,0)
LAST(FBDA,FBNODE) ; Returns number (0-25) of last code in node for invoice
"RTN","FBCHEP1",80,0)
 D RMVGAP(FBDA,0)  ;Insure that gaps were not created outside normal processes
"RTN","FBCHEP1",81,0)
 N FBI,FBRET,FBX
"RTN","FBCHEP1",82,0)
 S FBRET=0
"RTN","FBCHEP1",83,0)
 I FBDA,"^DX^PROC^"[(U_FBNODE_U) D
"RTN","FBCHEP1",84,0)
 . S FBX=$G(^FBAAI(FBDA,FBNODE))
"RTN","FBCHEP1",85,0)
 . F FBI=25:-1:1 I $P(FBX,"^",FBI)'="" S FBRET=FBI Q
"RTN","FBCHEP1",86,0)
 Q FBRET
"RTN","FBCHEP1",87,0)
 ;
"RTN","FBCHEP1",88,0)
RMVGAP(FBDA,FBWRT) ;  Remove gaps in ICD diagnosis and procedure codes
"RTN","FBCHEP1",89,0)
 ; input
"RTN","FBCHEP1",90,0)
 ;   FBDA  IEN of invoice
"RTN","FBCHEP1",91,0)
 ;   FBWRT (optional) =1 if messages can be written to the screen
"RTN","FBCHEP1",92,0)
 ; remove any gaps
"RTN","FBCHEP1",93,0)
 N DXFLD,FBDX,FBFDA,FBI,FBMOVED,FBN,FBPOA,FBPROC,POAFLD,PROCFLD
"RTN","FBCHEP1",94,0)
 D FLDLIST ; get list of field numbers
"RTN","FBCHEP1",95,0)
 ; check diagnosis and POA codes
"RTN","FBCHEP1",96,0)
 S FBDX=$G(^FBAAI(FBDA,"DX"))
"RTN","FBCHEP1",97,0)
 S FBPOA=$G(^FBAAI(FBDA,"POA"))
"RTN","FBCHEP1",98,0)
 S FBMOVED=0
"RTN","FBCHEP1",99,0)
 S FBN=0
"RTN","FBCHEP1",100,0)
 F FBI=1:1:25 D
"RTN","FBCHEP1",101,0)
 . Q:$P(FBDX,U,FBI)=""
"RTN","FBCHEP1",102,0)
 . S FBN=FBN+1 ; increment number of diagnosis codes
"RTN","FBCHEP1",103,0)
 . Q:FBI=FBN  ; no gap
"RTN","FBCHEP1",104,0)
 . ; move diagnosis and POA from slot FBI to slot FBN
"RTN","FBCHEP1",105,0)
 . S FBMOVED=1 ; set flag for message
"RTN","FBCHEP1",106,0)
 . K FBFDA
"RTN","FBCHEP1",107,0)
 . S FBFDA(162.5,FBDA_",",$P(DXFLD,U,FBN))=$P(FBDX,U,FBI)
"RTN","FBCHEP1",108,0)
 . S FBFDA(162.5,FBDA_",",$P(POAFLD,U,FBN))=$P(FBPOA,U,FBI)
"RTN","FBCHEP1",109,0)
 . S FBFDA(162.5,FBDA_",",$P(DXFLD,U,FBI))="@"
"RTN","FBCHEP1",110,0)
 . S FBFDA(162.5,FBDA_",",$P(POAFLD,U,FBI))="@"
"RTN","FBCHEP1",111,0)
 . D FILE^DIE("","FBFDA") D:$G(FBWRT) MSG^DIALOG()
"RTN","FBCHEP1",112,0)
 . S $P(FBDX,U,FBN)=$P(FBDX,U,FBI)
"RTN","FBCHEP1",113,0)
 . S $P(FBPOA,U,FBN)=$P(FBPOA,U,FBI)
"RTN","FBCHEP1",114,0)
 . S $P(FBDX,U,FBI)=""
"RTN","FBCHEP1",115,0)
 . S $P(FBPOA,U,FBI)=""
"RTN","FBCHEP1",116,0)
 I $G(FBWRT),FBMOVED W !,"Diagnosis codes were moved to remove gaps"
"RTN","FBCHEP1",117,0)
 ;
"RTN","FBCHEP1",118,0)
 S FBPROC=$G(^FBAAI(FBDA,"PROC"))
"RTN","FBCHEP1",119,0)
 S FBMOVED=0
"RTN","FBCHEP1",120,0)
 S FBN=0
"RTN","FBCHEP1",121,0)
 F FBI=1:1:25 D
"RTN","FBCHEP1",122,0)
 . Q:$P(FBPROC,U,FBI)=""
"RTN","FBCHEP1",123,0)
 . S FBN=FBN+1 ; increment number of procedure codes
"RTN","FBCHEP1",124,0)
 . Q:FBI=FBN  ; no gap
"RTN","FBCHEP1",125,0)
 . ; move procedure from slot FBI to slot FBN
"RTN","FBCHEP1",126,0)
 . S FBMOVED=1
"RTN","FBCHEP1",127,0)
 . K FBFDA
"RTN","FBCHEP1",128,0)
 . S FBFDA(162.5,FBDA_",",$P(PROCFLD,U,FBN))=$P(FBPROC,U,FBI)
"RTN","FBCHEP1",129,0)
 . S FBFDA(162.5,FBDA_",",$P(PROCFLD,U,FBI))="@"
"RTN","FBCHEP1",130,0)
 . D FILE^DIE("","FBFDA") D:$G(FBWRT) MSG^DIALOG()
"RTN","FBCHEP1",131,0)
 . S $P(FBPROC,U,FBN)=$P(FBPROC,U,FBI)
"RTN","FBCHEP1",132,0)
 . S $P(FBPROC,U,FBI)=""
"RTN","FBCHEP1",133,0)
 I $G(FBWRT),FBMOVED W !,"Procedure codes were moved to remove gaps"
"RTN","FBCHEP1",134,0)
 Q
"RTN","FBCHEP1",135,0)
 ;
"RTN","FBCHEP1",136,0)
FLDLIST ; Provide list of fields for diagnosis, POA, and prodedures
"RTN","FBCHEP1",137,0)
 S DXFLD="30^31^32^33^34^35^35.1^35.2^35.3^35.4^35.5^35.6^35.7^35.8^35.9^36^36.1^36.2^36.3^36.4^36.5^36.6^36.7^36.8^36.9"
"RTN","FBCHEP1",138,0)
 S POAFLD="30.02^31.02^32.02^33.02^34.02^35.02^35.12^35.22^35.32^35.42^35.52^35.62^35.72^35.82^35.92^36.02^36.12^36.22^36.32^36.42^36.52^36.62^36.72^26.82^36.92"
"RTN","FBCHEP1",139,0)
 S PROCFLD="40^41^42^43^44^44.06^44.07^44.08^44.09^44.1^44.11^44.12^44.13^44.14^44.15^44.16^44.17^44.18^44.19^44.2^44.21^44.22^44.23^44.24^44.25"
"RTN","FBCHEP1",140,0)
 Q
"RTN","FBCHPET")
0^8^B40446570^B36398874
"RTN","FBCHPET",1,0)
FBCHPET ;AISC/DMK-EDIT ANCILLARY PAYMENT ;7/13/2003
"RTN","FBCHPET",2,0)
 ;;3.5;FEE BASIS;**4,38,61,77,116,108,124**;JAN 30, 1995;Build 20
"RTN","FBCHPET",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBCHPET",4,0)
 S FY=$E(DT,1,3)+1700+$S($E(4,5)>9:1,1:0)
"RTN","FBCHPET",5,0)
GETPT I $G(BAT) D
"RTN","FBCHPET",6,0)
 .I '$D(^FBAAC("AC",+BAT)) F I=9,10,11 S $P(^FBAA(161.7,+BAT,0),U,I)=""
"RTN","FBCHPET",7,0)
 .I $D(^FBAAC("AC",+BAT)) D  S $P(^FBAA(161.7,+BAT,0),U,11)=I,$P(^(0),U,9)=$G(FBTOT) K I,FBTOT
"RTN","FBCHPET",8,0)
 ..N J,K,L,M S (I,J,K,L,M,FBTOT)=0
"RTN","FBCHPET",9,0)
 ..F  S J=$O(^FBAAC("AC",+BAT,J)) Q:'J  F  S K=$O(^FBAAC("AC",+BAT,J,K)) Q:'K  F  S L=$O(^FBAAC("AC",+BAT,J,K,L)) Q:'L  F  S M=$O(^FBAAC("AC",+BAT,J,K,L,M)) Q:'M  I $D(^FBAAC(J,1,K,1,L,1,M,0)) S I=I+1,FBTOT=FBTOT+$P(^(0),U,3)
"RTN","FBCHPET",10,0)
 W !! S DIC="^FBAAC(",DIC(0)="AEQM" D ^DIC G END:X="^"!(X=""),GETPT:Y<0 S (DFN,FBDA(3))=+Y
"RTN","FBCHPET",11,0)
 S:'$D(^FBAAC(DFN,1,0)) ^FBAAC(DFN,1,0)="^162.01P^0^0"
"RTN","FBCHPET",12,0)
 S DIC=DIC_DFN_",1,"
"RTN","FBCHPET",13,0)
GETVD W !! S DIC(0)="AEQM" D ^DIC G GETPT:X="^"!(X=""),GETVD:Y<0 S (FBV,FBVD,FBDA(2))=+Y
"RTN","FBCHPET",14,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,0)) ^FBAAC(DFN,1,FBDA(2),1,0)="^162.02DA^0^0"
"RTN","FBCHPET",15,0)
 S DIC=DIC_FBVD_",1,"
"RTN","FBCHPET",16,0)
GETDT S DIC(0)="AEQM",DIC("A")="Date of Service: " D ^DIC K DIC("A") G GETPT:X="^"!(X=""),GETDT:Y<0 S (FBSD,FBSDI,FBDA(1))=+Y,FBAADT=$P(Y,U,2) S:'$D(^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)) ^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)="^162.03A^0^0"
"RTN","FBCHPET",17,0)
 S FBZ=DIC_FBSD_",1,"
"RTN","FBCHPET",18,0)
SERV S DA(3)=FBDA(3),DA(2)=FBDA(2),DA(1)=FBDA(1)
"RTN","FBCHPET",19,0)
 S DIC("W")="N FBX S FBX=$$MODL^FBAAUTL4(""^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,+Y,""""M"""")"",""E"") W:FBX]"""" ""    CPT Modifier(s): "",FBX Q"
"RTN","FBCHPET",20,0)
 S DIC=FBZ,DIC(0)="AEQMZ"
"RTN","FBCHPET",21,0)
 D
"RTN","FBCHPET",22,0)
 . N ICPTVDT S ICPTVDT=$G(FBAADT) D ^DIC
"RTN","FBCHPET",23,0)
 G GETPT:X="^"!(X=""),SERV:Y<0 S (FBSV,FBAACPI,FBDA)=+Y,BAT=$P(Y(0),U,8),FBDUZ=$P(Y(0),U,7),(FBAACP,FBAACP(0))=$P(Y,U,2),K=$P(Y(0),U,3),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBCHPET",24,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBCHPET",25,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBCHPET",26,0)
 I FBDUZ'=DUZ&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry,only the clerk who entered the payment ",!," or a supervisor can edit this payment." G GETPT
"RTN","FBCHPET",27,0)
 ;S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBCHPET",28,0)
 S FBFSAMT(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,12)
"RTN","FBCHPET",29,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBCHPET",30,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBCHPET",31,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_FBDA(3)_",1,"_FBDA(2)_",1,"_FBDA(1)_",1,"_FBDA_",""M"")")
"RTN","FBCHPET",32,0)
 ; load current adjustment data
"RTN","FBCHPET",33,0)
 D LOADADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBCHPET",34,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBCHPET",35,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBCHPET",36,0)
 ; load current remittance remark data
"RTN","FBCHPET",37,0)
 D LOADRR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBCHPET",38,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBCHPET",39,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBCHPET",40,0)
 S FBFPPSC(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U)
"RTN","FBCHPET",41,0)
 S FBFPPSC=FBFPPSC(0)
"RTN","FBCHPET",42,0)
 S FBFPPSL(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,2)
"RTN","FBCHPET",43,0)
 S FBFPPSL=FBFPPSL(0)
"RTN","FBCHPET",44,0)
 G:BAT']"" EDIT
"RTN","FBCHPET",45,0)
 I $P($G(^FBAA(161.7,BAT,"ST")),"^",1)="S"!($P($G(^FBAA(161.7,BAT,"ST")),"^",1)="T")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry, only the Supervisor can edit a payment once the batch has been released." G GETPT
"RTN","FBCHPET",46,0)
 I $P($G(^FBAA(161.7,BAT,"ST")),"^",1)="V" W !!,*7,"Sorry,you cannot edit a payment once the batch has been Finalized." G GETPT
"RTN","FBCHPET",47,0)
EDIT S DA=FBSV
"RTN","FBCHPET",48,0)
 ;
"RTN","FBCHPET",49,0)
 ; first edit CPT code and modifiers
"RTN","FBCHPET",50,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) G GETPT
"RTN","FBCHPET",51,0)
 ; if CPT was changed then update file
"RTN","FBCHPET",52,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" G GETPT
"RTN","FBCHPET",53,0)
 . N FBIENS,FBFDA
"RTN","FBCHPET",54,0)
 . S FBIENS=FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_","
"RTN","FBCHPET",55,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBCHPET",56,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBCHPET",57,0)
 ; if modifiers changed then update file
"RTN","FBCHPET",58,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(FBDA(3),FBDA(2),FBDA(1),FBDA)
"RTN","FBCHPET",59,0)
 ;
"RTN","FBCHPET",60,0)
 ; now edit remaining fields
"RTN","FBCHPET",61,0)
 S DIE("NO^")=""
"RTN","FBCHPET",62,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBCHPET",63,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only;
"RTN","FBCHPET",64,0)
 ;S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1);30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBCHPET",65,0)
 S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",$D(FB583):"""",1:1);D PPT^FBAACO1(FBAAMM1,FBCNTRP,1);54///@;54////^S X=$G(FBCNTRP);30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBCHPET",66,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBCHPET",67,0)
 ;S DR(1,162.03,3)="3////^S X=$S(J-K:J-K,1:"""");I X S Y=""@11"";4////@;S Y=""@5"";@11;3R;4R;S:X'=4 Y=""@5"";22;K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBCHPET",68,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBCHPET",69,0)
 S DR(1,162.03,4)="S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="""" Y=""@5"";50///^S X=FBX;S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL);S:FBX=-1 Y=0;51///^S X=FBX;S FBFPPCL=X;S Y=""@55"";@5;50///@;S FBFPPSC="""";51///@;S FBFPPCL="""";@55"
"RTN","FBCHPET",70,0)
 S DR(1,162.03,5)="@5;K DIE(""NO^"");W !,""Exit ('^') allowed now"";26;S PRC(""SITE"")=X;8;@13;13;I $$BADDATE^FBCHPET(FBAADT,X) S Y=""@13"";Q;33;49"
"RTN","FBCHPET",71,0)
 S DR(1,162.03,6)="15;16;17////^S X=1"
"RTN","FBCHPET",72,0)
 S DR(1,162.03,7)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBCHPET",73,0)
 S DIE=FBZ
"RTN","FBCHPET",74,0)
 D
"RTN","FBCHPET",75,0)
 . N ICPTVDT,ICDVDT,FB583,FBAAMM,FBAAMM1,FBCNTRA,FBCNTRP,FBVEN,FTP
"RTN","FBCHPET",76,0)
 . S (ICPTVDT,ICDVDT)=$G(FBAADT)
"RTN","FBCHPET",77,0)
 . ; set variables for call to PPT^FBAACO1
"RTN","FBCHPET",78,0)
 . S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBCHPET",79,0)
 . S FBCNTRP=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,8)
"RTN","FBCHPET",80,0)
 . S X=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,0)),U,13)
"RTN","FBCHPET",81,0)
 . S:X[";FB583(" FB583=+X
"RTN","FBCHPET",82,0)
 . S FTP=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),0)),U,4)
"RTN","FBCHPET",83,0)
 . S FBVEN=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,4),1:"")
"RTN","FBCHPET",84,0)
 . S FBCNTRA=$S(FTP:$P($G(^FBAAA(DFN,1,FTP,0)),U,22),1:"")
"RTN","FBCHPET",85,0)
 . D ^DIE
"RTN","FBCHPET",86,0)
 ; if adjustment data changed then file
"RTN","FBCHPET",87,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBCHPET",88,0)
 ; if remit remark data changed then file
"RTN","FBCHPET",89,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBCHPET",90,0)
 ; if FPPS CLAIM ID changed, update other line items on invoice
"RTN","FBCHPET",91,0)
 I FBFPPSC'=FBFPPSC(0) D
"RTN","FBCHPET",92,0)
 . N FBAAIN
"RTN","FBCHPET",93,0)
 . S FBAAIN=$$GET1^DIQ(162.03,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",14)
"RTN","FBCHPET",94,0)
 . D CKINVEDI^FBAAPET1(FBFPPSC(0),FBFPPSC,FBAAIN,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",")
"RTN","FBCHPET",95,0)
 K FBSV W !! G SERV
"RTN","FBCHPET",96,0)
 ;
"RTN","FBCHPET",97,0)
BADDATE(FBDOS,INVRCVDT) ;Reject entry if InvRcvDt is Prior to the Date of Service on the Invoice
"RTN","FBCHPET",98,0)
 I INVRCVDT<FBDOS D  Q 1 ;Reject entry
"RTN","FBCHPET",99,0)
 .N SHOWDOS S SHOWDOS=$E(FBDOS,4,5)_"/"_$E(FBDOS,6,7)_"/"_$E(FBDOS,2,3) ;Convert FBDOS into display format for error message
"RTN","FBCHPET",100,0)
 .W *7,!!?5,"*** Invoice Received Date cannot be prior to the",!?8," Date of Service ("_SHOWDOS_") !!!"
"RTN","FBCHPET",101,0)
 Q 0 ;Accept entry
"RTN","FBCHPET",102,0)
 ;
"RTN","FBCHPET",103,0)
END K DR,DIC,DIE,X,DFN,FBVD,FBSD,BAT,FBSV,DA,FBDA,FBZ,FBDUZ,FBAACP,FBFY,FY,FBAMTPD,J,K,Y,PRC,FBHOLDX,ZZ,FBAADT,FBV,FBSDI,FBAACPI
"RTN","FBCHPET",104,0)
 K FBAAMM,FBAAMM1,FBFSAMT,FBFSUSD,FBMODA,FBZIP,FBTIME,FBHCFA(30)
"RTN","FBCHPET",105,0)
 K FBAAPTC,FB1725
"RTN","FBCHPET",106,0)
 K FBADJ,FBADJD,FBADJL,FBRRMK,FBRRMKD,FBRRMKL,FBX,FBUNITS
"RTN","FBCHPET",107,0)
 Q
"RTN","FBNHEDPA")
0^9^B15541684^B9054785
"RTN","FBNHEDPA",1,0)
FBNHEDPA ;AISC/GRR-EDIT PAYMENT FOR COMMUNITY NURSING HOME ;7/8/2003
"RTN","FBNHEDPA",2,0)
 ;;3.5;FEE BASIS;**61,124**;JAN 30, 1995;Build 20
"RTN","FBNHEDPA",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBNHEDPA",4,0)
EDIT ;ENTRY POINT TO EDIT PAYMENT
"RTN","FBNHEDPA",5,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBNHEDPA",6,0)
BT S DIC="^FBAA(161.7,",DIC(0)="AEQMZ",DIC("S")="I $P(^(0),U,3)=""B9""",DIC("S")=$S($D(^XUSEC("FBAASUPERVISOR",DUZ)):DIC("S"),1:DIC("S")_"&($P(^(0),U,5)=DUZ)") D ^DIC
"RTN","FBNHEDPA",7,0)
 G END:X=""!(X="^"),BT:Y<0 S FBN=+Y,FBN(0)=Y(0)
"RTN","FBNHEDPA",8,0)
 S FBSTAT=^FBAA(161.7,FBN,"ST")
"RTN","FBNHEDPA",9,0)
 I FBSTAT="C"&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,?3,"You must Reopen the batch prior to editting the invoice.",! G END
"RTN","FBNHEDPA",10,0)
 I FBSTAT="S"!(FBSTAT="P")!(FBSTAT="R")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,?3,"You must be a holder of the 'FBAASUPERVISOR' security key",!,?3,"to edit this invoice.",! G END
"RTN","FBNHEDPA",11,0)
 I FBSTAT="T"!(FBSTAT="V") W !!,?3,"Batch has already been sent to Austin for payment.",! G END
"RTN","FBNHEDPA",12,0)
INV W ! S DIC("A")="Select Invoice Number: ",DIC="^FBAAI(",DIC(0)="AEQMZ",DIC("S")="I $P(^(0),U,17)=FBN" D ^DIC K DIC G BT:X=""!(X="^"),INV:Y<0 S FBI=+Y,FBOLD(0)=Y(0)
"RTN","FBNHEDPA",13,0)
 S FBLISTC="",FBHDI=FBI W @IOF D START^FBCHDI S FBI=FBHDI K FBHDI
"RTN","FBNHEDPA",14,0)
 K FBHAP,FBAP
"RTN","FBNHEDPA",15,0)
 S (DIE,DIC)="^FBAAI(",DIC(0)="AEQM",DA=FBI,DR="[FBNH EDIT PAYMENT]",DIE("NO^")=""
"RTN","FBNHEDPA",16,0)
 W !
"RTN","FBNHEDPA",17,0)
 N FBHAC
"RTN","FBNHEDPA",18,0)
 ; get values of FPPS Claim ID and Line Item
"RTN","FBNHEDPA",19,0)
 S FBFPPSC=$P($G(^FBAAI(FBI,3)),U)
"RTN","FBNHEDPA",20,0)
 S FBFPPSL=$P($G(^FBAAI(FBI,3)),U,2)
"RTN","FBNHEDPA",21,0)
 ; load current adjustment data
"RTN","FBNHEDPA",22,0)
 D LOADADJ^FBCHFA(FBI_",",.FBADJ)
"RTN","FBNHEDPA",23,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBNHEDPA",24,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBNHEDPA",25,0)
 ; load current remittance remark data
"RTN","FBNHEDPA",26,0)
 D LOADRR^FBCHFR(FBI_",",.FBRRMK)
"RTN","FBNHEDPA",27,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBNHEDPA",28,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBNHEDPA",29,0)
 D ^DIE K DIE("NO^")
"RTN","FBNHEDPA",30,0)
 I $D(DTOUT) S DR="5///^S X="_$P(FBOLD(0),U,6)_";6///^S X="_$P(FBOLD(0),U,7) D ^DIE
"RTN","FBNHEDPA",31,0)
 ; if adjustment data changed then file
"RTN","FBNHEDPA",32,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBCHFA(FBI_",",.FBADJ)
"RTN","FBNHEDPA",33,0)
 ; if remit remark data changed then file
"RTN","FBNHEDPA",34,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBCHFR(FBI_",",.FBRRMK)
"RTN","FBNHEDPA",35,0)
 I $D(FBHAP),$D(FBAP),FBAP-FBHAP S FBDIF=FBAP-FBHAP,$P(^FBAA(161.7,FBN,0),"^",9)=$P(^FBAA(161.7,FBN,0),"^",9)+FBDIF
"RTN","FBNHEDPA",36,0)
END K DA,DFN,DIC,DIE,DR,FBAAOUT,FBDX,FBI,FBIN,FBLISTC,FBN,FBPROC,FBSTAT,FBVEN,FBVID,J,K,L,POP,Q,VA,VADM,X,Y,FBAC,FBAP,FBBAL,FBHAP,FBDIF
"RTN","FBNHEDPA",37,0)
 K FBADJ,FBADJL,FBRRMK,FBRRMKL,FBFPPSC,FBFPPSL
"RTN","FBNHEDPA",38,0)
 D KILL^FBPAY K FBOLD,FBINODE,FBPAT,FBPRGNAM
"RTN","FBNHEDPA",39,0)
 Q
"RTN","FBNHEDPA",40,0)
 ;
"RTN","FBNHEDPA",41,0)
BADDATE(INVRCVDT,TEMPDA) ;Compare edited Invoice Received Date to Treatment Date, reject if before 
"RTN","FBNHEDPA",42,0)
 I INVRCVDT="" Q 0 ;Inv Date not changed, no check necessary
"RTN","FBNHEDPA",43,0)
 N TDAT,SHODAT S TDAT=$$GET1^DIQ(162.5,TEMPDA_",",6,"I") I TDAT]"" S SHODAT="TO"
"RTN","FBNHEDPA",44,0)
 I TDAT="" S TDAT=$$GET1^DIQ(162.5,TEMPDA_",",5,"I"),SHODAT="FROM"
"RTN","FBNHEDPA",45,0)
 I INVRCVDT<TDAT D  Q 1 ;Reject entered date
"RTN","FBNHEDPA",46,0)
 .N SHOTDAT S SHOTDAT=$E(TDAT,4,5)_"/"_$E(TDAT,6,7)_"/"_$E(TDAT,2,3) ;Convert TDAT into display format for error message 
"RTN","FBNHEDPA",47,0)
 .N MSG1,MSG2 S MSG1="*** Invoice Received Date cannot be before",MSG2=" Treatment "_SHODAT_" Date ("_SHOTDAT_") !!!"
"RTN","FBNHEDPA",48,0)
 .W !!?5,*7,MSG1,!?8,MSG2
"RTN","FBNHEDPA",49,0)
 Q 0 ;Date entered is OK
"RTN","FBNHEDPA",50,0)
 ;
"RTN","FBNHEDPA",51,0)
BADTDATE(TDAT,INVRCVDT,SHODAT) ;Compare edited Treatment TO or FROM Date to Invoice Received Date, reject if AFTER 
"RTN","FBNHEDPA",52,0)
 I INVRCVDT<TDAT D  Q 1 ;Reject entered date
"RTN","FBNHEDPA",53,0)
 .N SHOIRDAT S SHOIRDAT=$E(INVRCVDT,4,5)_"/"_$E(INVRCVDT,6,7)_"/"_$E(INVRCVDT,2,3) ;Convert INVRCVDT into display format for error message 
"RTN","FBNHEDPA",54,0)
 .N MSG1,MSG2 S MSG1="*** Treatment "_SHODAT_" Date cannot be after",MSG2=" Invoice Received Date ("_SHOIRDAT_") !!!"
"RTN","FBNHEDPA",55,0)
 .W !!?5,*7,MSG1,!?8,MSG2
"RTN","FBNHEDPA",56,0)
 Q 0 ;Date entered is OK
"RTN","FBNHEDPA",57,0)
 ;
"VER")
8.0^22.0
"BLD",8675,6)
^117
**END**
**END**
