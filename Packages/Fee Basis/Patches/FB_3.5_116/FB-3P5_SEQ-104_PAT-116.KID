Released FB*3.5*116 SEQ #104
Extracted from mail message
**KIDS**:FB*3.5*116^

**INSTALL NAME**
FB*3.5*116
"BLD",8136,0)
FB*3.5*116^FEE BASIS^0^3110125^y
"BLD",8136,4,0)
^9.64PA^^
"BLD",8136,6)
2^
"BLD",8136,6.3)
30
"BLD",8136,"INID")
n
"BLD",8136,"KRN",0)
^9.67PA^779.2^20
"BLD",8136,"KRN",.4,0)
.4
"BLD",8136,"KRN",.401,0)
.401
"BLD",8136,"KRN",.402,0)
.402
"BLD",8136,"KRN",.403,0)
.403
"BLD",8136,"KRN",.5,0)
.5
"BLD",8136,"KRN",.84,0)
.84
"BLD",8136,"KRN",3.6,0)
3.6
"BLD",8136,"KRN",3.8,0)
3.8
"BLD",8136,"KRN",9.2,0)
9.2
"BLD",8136,"KRN",9.8,0)
9.8
"BLD",8136,"KRN",9.8,"NM",0)
^9.68A^18^18
"BLD",8136,"KRN",9.8,"NM",1,0)
FBAACCB^^0^B34837713
"BLD",8136,"KRN",9.8,"NM",2,0)
FBAACCB0^^0^B9605771
"BLD",8136,"KRN",9.8,"NM",3,0)
FBAACCB1^^0^B24359201
"BLD",8136,"KRN",9.8,"NM",4,0)
FBAACO^^0^B28424330
"BLD",8136,"KRN",9.8,"NM",5,0)
FBAACO2^^0^B12957977
"BLD",8136,"KRN",9.8,"NM",6,0)
FBAACO3^^0^B48295702
"BLD",8136,"KRN",9.8,"NM",7,0)
FBAACP1^^0^B6699484
"BLD",8136,"KRN",9.8,"NM",8,0)
FBAAMP^^0^B64408896
"BLD",8136,"KRN",9.8,"NM",9,0)
FBAAPET^^0^B33779075
"BLD",8136,"KRN",9.8,"NM",10,0)
FBAAPIP^^0^B14820302
"BLD",8136,"KRN",9.8,"NM",11,0)
FBAASCB^^0^B23609721
"BLD",8136,"KRN",9.8,"NM",12,0)
FBAASCB0^^0^B19526441
"BLD",8136,"KRN",9.8,"NM",13,0)
FBAAV0^^0^B39796273
"BLD",8136,"KRN",9.8,"NM",14,0)
FBAAV2^^0^B11664283
"BLD",8136,"KRN",9.8,"NM",15,0)
FBAAV3^^0^B3282866
"BLD",8136,"KRN",9.8,"NM",16,0)
FBAAV5^^0^B48447360
"BLD",8136,"KRN",9.8,"NM",17,0)
FBCHPET^^0^B31374746
"BLD",8136,"KRN",9.8,"NM",18,0)
FBXIP116^^0^B32794794
"BLD",8136,"KRN",9.8,"NM","B","FBAACCB",1)

"BLD",8136,"KRN",9.8,"NM","B","FBAACCB0",2)

"BLD",8136,"KRN",9.8,"NM","B","FBAACCB1",3)

"BLD",8136,"KRN",9.8,"NM","B","FBAACO",4)

"BLD",8136,"KRN",9.8,"NM","B","FBAACO2",5)

"BLD",8136,"KRN",9.8,"NM","B","FBAACO3",6)

"BLD",8136,"KRN",9.8,"NM","B","FBAACP1",7)

"BLD",8136,"KRN",9.8,"NM","B","FBAAMP",8)

"BLD",8136,"KRN",9.8,"NM","B","FBAAPET",9)

"BLD",8136,"KRN",9.8,"NM","B","FBAAPIP",10)

"BLD",8136,"KRN",9.8,"NM","B","FBAASCB",11)

"BLD",8136,"KRN",9.8,"NM","B","FBAASCB0",12)

"BLD",8136,"KRN",9.8,"NM","B","FBAAV0",13)

"BLD",8136,"KRN",9.8,"NM","B","FBAAV2",14)

"BLD",8136,"KRN",9.8,"NM","B","FBAAV3",15)

"BLD",8136,"KRN",9.8,"NM","B","FBAAV5",16)

"BLD",8136,"KRN",9.8,"NM","B","FBCHPET",17)

"BLD",8136,"KRN",9.8,"NM","B","FBXIP116",18)

"BLD",8136,"KRN",19,0)
19
"BLD",8136,"KRN",19.1,0)
19.1
"BLD",8136,"KRN",101,0)
101
"BLD",8136,"KRN",409.61,0)
409.61
"BLD",8136,"KRN",771,0)
771
"BLD",8136,"KRN",779.2,0)
779.2
"BLD",8136,"KRN",870,0)
870
"BLD",8136,"KRN",8989.51,0)
8989.51
"BLD",8136,"KRN",8989.52,0)
8989.52
"BLD",8136,"KRN",8994,0)
8994
"BLD",8136,"KRN","B",.4,.4)

"BLD",8136,"KRN","B",.401,.401)

"BLD",8136,"KRN","B",.402,.402)

"BLD",8136,"KRN","B",.403,.403)

"BLD",8136,"KRN","B",.5,.5)

"BLD",8136,"KRN","B",.84,.84)

"BLD",8136,"KRN","B",3.6,3.6)

"BLD",8136,"KRN","B",3.8,3.8)

"BLD",8136,"KRN","B",9.2,9.2)

"BLD",8136,"KRN","B",9.8,9.8)

"BLD",8136,"KRN","B",19,19)

"BLD",8136,"KRN","B",19.1,19.1)

"BLD",8136,"KRN","B",101,101)

"BLD",8136,"KRN","B",409.61,409.61)

"BLD",8136,"KRN","B",771,771)

"BLD",8136,"KRN","B",779.2,779.2)

"BLD",8136,"KRN","B",870,870)

"BLD",8136,"KRN","B",8989.51,8989.51)

"BLD",8136,"KRN","B",8989.52,8989.52)

"BLD",8136,"KRN","B",8994,8994)

"BLD",8136,"PRE")
FBXIP116
"BLD",8136,"QUES",0)
^9.62^^
"BLD",8136,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",60,-1)
1^1
"PKG",60,0)
FEE BASIS^FB^Used to pay private vendors
"PKG",60,20,0)
^9.402P^1^1
"PKG",60,20,1,0)
2^^FBPMRG
"PKG",60,20,1,1)

"PKG",60,20,"B",2,1)

"PKG",60,22,0)
^9.49I^1^1
"PKG",60,22,1,0)
3.5^2950130^2950313
"PKG",60,22,1,"PAH",1,0)
116^3110125^100108
"PRE")
FBXIP116
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","FBAACCB")
0^1^B34837713^B28006172
"RTN","FBAACCB",1,0)
FBAACCB ;AISC/GRR-CLERK CLOSE BATCH ; 11/24/10 1:32pm
"RTN","FBAACCB",2,0)
 ;;3.5;FEE BASIS;**4,61,77,116**;JAN 30, 1995;Build 30
"RTN","FBAACCB",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACCB",4,0)
 K QQ D DT^DICRW
"RTN","FBAACCB",5,0)
BT W !! S DIC="^FBAA(161.7,",DIC(0)="AEQ",DIC("S")=$S($D(^XUSEC("FBAASUPERVISOR",DUZ)):"I $G(^(""ST""))=""O""",1:"I $P(^(0),U,5)=DUZ&($G(^(""ST""))=""O"")") D ^DIC K DIC("S")
"RTN","FBAACCB",6,0)
 G Q^FBAACCB0:X="^"!(X=""),BT:Y<0 S B=+Y,FZ=^FBAA(161.7,B,0),FBTYPE=$P(FZ,"^",3)
"RTN","FBAACCB",7,0)
 I FBTYPE="B3",'$D(^FBAAC("AC",B)) W !!,*7,"No payments in Batch yet!",! G BT
"RTN","FBAACCB",8,0)
 I FBTYPE="B2",'$D(^FBAAC("AD",B)) W !!,*7,"No Payments in Batch yet!",! G BT
"RTN","FBAACCB",9,0)
 I FBTYPE="B5",'$D(^FBAA(162.1,"AE",B)) W !!,*7,"No Payments in Batch yet!",! G BT
"RTN","FBAACCB",10,0)
 I FBTYPE="B9",'$D(^FBAAI("AC",B)) W !!,*7,"No Payments in Batch yet!",! G BT
"RTN","FBAACCB",11,0)
RDD S DIR(0)="Y",DIR("A")="Want to review batch",DIR("B")="NO",DIR("?")="If you want a detail list of each payment line, answer ""Yes"" otherwise press Return key" D ^DIR K DIR
"RTN","FBAACCB",12,0)
 G BT:$D(DIRUT) W:Y @IOF D:Y LIST:FBTYPE="B3",LISTP:FBTYPE="B5",LISTT^FBAACCB0:FBTYPE="B2",LISTC^FBAACCB1:FBTYPE="B9"
"RTN","FBAACCB",13,0)
RDD1 S DIR(0)="Y",DIR("A")="Do you still want to close Batch",DIR("B")="YES" D ^DIR K DIR G BT:'Y!$D(DIRUT)
"RTN","FBAACCB",14,0)
 N FBARY,FBOLD,FBINVT
"RTN","FBAACCB",15,0)
 ;
"RTN","FBAACCB",16,0)
 S C=0,T=0 G PHARM^FBAACCB1:FBTYPE="B5",TRAV^FBAACCB1:FBTYPE="B2",CHNH^FBAACCB1:FBTYPE="B9"
"RTN","FBAACCB",17,0)
 F J=0:0 S J=$O(^FBAAC("AC",B,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("AC",B,J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AC",B,J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("AC",B,J,K,L,M)) Q:M'>0  D GOT
"RTN","FBAACCB",18,0)
FIN ; FB*3.5*116 - check and handle $0 invoices
"RTN","FBAACCB",19,0)
 D CHECK(.FBARY)
"RTN","FBAACCB",20,0)
 I $D(FBARY) D  G BT
"RTN","FBAACCB",21,0)
 . ;D EN^DDIOL(.FBARY)
"RTN","FBAACCB",22,0)
 . W *7,!!?2,"Batch cannot be closed. Listed invoices are zero dollar "
"RTN","FBAACCB",23,0)
 . W *7,!?2,"and must be corrected or removed from the batch."
"RTN","FBAACCB",24,0)
 ; end of changes
"RTN","FBAACCB",25,0)
 ;
"RTN","FBAACCB",26,0)
 S $P(FZ,"^",9)=T,$P(FZ,"^",11)=C
"RTN","FBAACCB",27,0)
 S $P(FZ,"^",13)=DT,^FBAA(161.7,B,0)=FZ,^FBAA(161.7,B,"ST")="C",^FBAA(161.7,"AC","C",B)="",DA=B,DR="0;ST" K ^FBAA(161.7,"AC","O",B),^FBAA(161.7,"AB","O",$P(^FBAA(161.7,B,0),"^",5),B) W !! D EN^DIQ W !!,"Batch Closed" G BT
"RTN","FBAACCB",28,0)
 ;
"RTN","FBAACCB",29,0)
GOT S Y(0)=$G(^FBAAC(J,1,K,1,L,1,M,0)),FBIN=$P(Y(0),"^",16)
"RTN","FBAACCB",30,0)
 ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACCB",31,0)
 S T=T+$P(Y(0),"^",3),C=C+1
"RTN","FBAACCB",32,0)
 ; FB*3.5*116 -collect amount paid for each invoice in batch
"RTN","FBAACCB",33,0)
 S FBARY(FBIN)=$G(FBARY(FBIN))+$P(Y(0),"^",3)
"RTN","FBAACCB",34,0)
 Q
"RTN","FBAACCB",35,0)
 ;
"RTN","FBAACCB",36,0)
CHECK(FBINV) ; order thru array and save zero dollar invoices; report any zero dollar invoices
"RTN","FBAACCB",37,0)
 ; FBINV = array of invoices
"RTN","FBAACCB",38,0)
 N FBAAIN
"RTN","FBAACCB",39,0)
 S FBAAIN=0 F  S FBAAIN=$O(FBINV(FBAAIN)) Q:'FBAAIN  D
"RTN","FBAACCB",40,0)
 . I FBINV(FBAAIN)'>0 W !!,"Invoice #: "_FBAAIN_" totals $0.00"
"RTN","FBAACCB",41,0)
 . E  K FBINV(FBAAIN) ; remove array elements that represent non-zero dollar invoices
"RTN","FBAACCB",42,0)
 Q
"RTN","FBAACCB",43,0)
 ;
"RTN","FBAACCB",44,0)
LIST S Q="",$P(Q,"=",80)="="
"RTN","FBAACCB",45,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBAACCB",46,0)
ENM D HED S (FBIN,FBINOLD)="",(FBAAOUT,FBINTOT)=0 F XY=0:0 S FBIN=$O(^FBAAC("AJ",B,FBIN)) Q:FBIN=""!($G(FBAAOUT))  D INTOT^FBAACCB0 F J=0:0 S J=$O(^FBAAC("AJ",B,FBIN,J)) Q:J'>0!($G(FBAAOUT))  D GMORE^FBAACCB0
"RTN","FBAACCB",47,0)
 I '$G(FBAAOUT) S FBIN=0 D INTOT^FBAACCB0
"RTN","FBAACCB",48,0)
 Q
"RTN","FBAACCB",49,0)
SET ;
"RTN","FBAACCB",50,0)
 N FBADJLA,FBADJLR,FBFPPSC,FBFPPSL,FBX,FBY3,TAMT
"RTN","FBAACCB",51,0)
 S N=$S($D(^DPT(J,0)):$P(^DPT(J,0),"^",1),1:""),S=$S(N]"":$P(^DPT(J,0),"^",9),1:""),V=$S($D(^FBAAV(K,0)):$P(^FBAAV(K,0),"^",1),1:""),VID=$S(V]"":$P(^(0),"^",2),1:"")
"RTN","FBAACCB",52,0)
 S D=+$G(^FBAAC(J,1,K,1,L,0)) Q:'D
"RTN","FBAACCB",53,0)
 S Y=$G(^FBAAC(J,1,K,1,L,1,M,0)) Q:Y']""
"RTN","FBAACCB",54,0)
 S FBY3=$G(^FBAAC(J,1,K,1,L,1,M,3))
"RTN","FBAACCB",55,0)
 S FBFPPSC=$P(FBY3,U)
"RTN","FBAACCB",56,0)
 S FBFPPSL=$P(FBY3,U,2)
"RTN","FBAACCB",57,0)
 S FBX=$$ADJLRA^FBAAFA(M_","_L_","_K_","_J_",")
"RTN","FBAACCB",58,0)
 S FBADJLR=$P(FBX,U)
"RTN","FBAACCB",59,0)
 S FBADJLA=$P(FBX,U,2)
"RTN","FBAACCB",60,0)
 S T=$P(Y,"^",5),FBIN=$P(Y,"^",16),ZS=$P(Y,"^",20)
"RTN","FBAACCB",61,0)
 S TAMT=$FN($P(Y,"^",4),"",2)
"RTN","FBAACCB",62,0)
 S FBVP=$S($P(Y,"^",21)="VP":"#",1:"")
"RTN","FBAACCB",63,0)
 S FBAACPT=$$CPT^FBAAUTL4($P(Y,U))
"RTN","FBAACCB",64,0)
 S CPTDESC=$$CPT^FBAAUTL4($P(Y,U),1,D)
"RTN","FBAACCB",65,0)
 S FBVCHDT=$P(Y,"^",6),FBIN(1)=$P(Y,"^",15) D FBCKO^FBAACCB2(J,K,L,M)
"RTN","FBAACCB",66,0)
 S FBMODLE=$$MODL^FBAAUTL4("^FBAAC("_J_",1,"_K_",1,"_L_",1,"_M_",""M"")","E")
"RTN","FBAACCB",67,0)
GO S A1=$P(Y,"^",2)+.0001,A2=$P(Y,"^",3)+.0001,A1=$P(A1,".",1)_"."_$E($P(A1,".",2),1,2),A2=$P(A2,".",1)_"."_$E($P(A2,".",2),1,2),FBINTOT=FBINTOT+A2
"RTN","FBAACCB",68,0)
 D WRT:FBTYPE'="B2",WRTT^FBAACCB0:FBTYPE="B2"
"RTN","FBAACCB",69,0)
 Q
"RTN","FBAACCB",70,0)
WRT I $Y+8>IOSL D ASKH^FBAACCB0:$E(IOST,1,2)["C-" Q:FBAAOUT  W @IOF D HED
"RTN","FBAACCB",71,0)
 S B(1617)=$S(B="":"",$D(^FBAA(161.7,B,0)):$P(^(0),"^"),1:"")
"RTN","FBAACCB",72,0)
 W !!,N,?35,$$SSN^FBAAUTL(J),?58,B(1617),?67,$$DATX^FBAAUTL($G(FBVCHDT)),!,?3,V,?42,VID,?55,FBIN,?67,$$DATX^FBAAUTL(FBIN(1))
"RTN","FBAACCB",73,0)
 W !,$S($D(QQ):QQ_")",1:""),$S(ZS="R":"*",1:""),$S(FBTYPE="B3":FBVP,1:""),$S(FBTYPE="B5":FBPV,1:""),$S($G(FBCAN)]"":"+",1:"")
"RTN","FBAACCB",74,0)
 I FBTYPE="B3" W ?4,$$DATX^FBAAUTL(D),?14,FBAACPT_$S($G(FBMODLE)]"":"-"_$P(FBMODLE,","),1:""),?24,CPTDESC,?54,FBFPPSC,?66,FBFPPSL
"RTN","FBAACCB",75,0)
 I FBTYPE="B5" W ?4,$$DATX^FBAAUTL(D),?14,FBAACPT_$S($G(FBMODLE)]"":"-"_$P(FBMODLE,","),1:""),?24,CPTDESC,?56,FBFPPSC,?68,FBFPPSL
"RTN","FBAACCB",76,0)
 I $P($G(FBMODLE),",",2)]"" D  Q:FBAAOUT
"RTN","FBAACCB",77,0)
 . N FBI,FBMOD
"RTN","FBAACCB",78,0)
 . F FBI=2:1 S FBMOD=$P(FBMODLE,",",FBI) Q:FBMOD=""  D  Q:FBAAOUT
"RTN","FBAACCB",79,0)
 . . I $Y+5>IOSL D  Q:FBAAOUT
"RTN","FBAACCB",80,0)
 . . . I $E(IOST,1,2)="C-" D ASKH^FBAACCB0 Q:FBAAOUT
"RTN","FBAACCB",81,0)
 . . . W @IOF D HED W !,"(continued)"
"RTN","FBAACCB",82,0)
 . . W !,?19,"-",FBMOD
"RTN","FBAACCB",83,0)
 W !?4,$J(A1,6),?17,$J(A2,6)
"RTN","FBAACCB",84,0)
 ; write adjustment reasons, if null then write suspend code
"RTN","FBAACCB",85,0)
 W ?30,$S(FBADJLR]"":FBADJLR,1:T)
"RTN","FBAACCB",86,0)
 ; write adjustment amounts, if null then write amount suspended
"RTN","FBAACCB",87,0)
 W ?41,$S(FBADJLA]"":FBADJLA,1:TAMT)
"RTN","FBAACCB",88,0)
 D PMNT^FBAACCB2 S FBINOLD=FBIN
"RTN","FBAACCB",89,0)
 Q
"RTN","FBAACCB",90,0)
HED W "Patient Name",?20,"('*' Reimbursement to Patient   '+' Cancellation Activity)",!,?13,"('#' Voided Payment)",?58,"Batch #",?67,"Voucher Date"
"RTN","FBAACCB",91,0)
 W !,?3,"Vendor Name",?42,"Vendor ID",?53,"Invoice #",?67,"Date Rec'd."
"RTN","FBAACCB",92,0)
 I FBTYPE="B3" D
"RTN","FBAACCB",93,0)
 . W !,?4,"SVC DATE",?14,"CPT-MOD",?24,"SERVICE PROVIDED",?54,"FPPS CLAIM",?66,"FPPS LINE"
"RTN","FBAACCB",94,0)
 . W !,?4,"CLAIMED",?17,"PAID",?30,"ADJ CODE",?41,"ADJ AMOUNT"
"RTN","FBAACCB",95,0)
 I FBTYPE="B5" D
"RTN","FBAACCB",96,0)
 . W !,?4,"RX  DATE",?14,"RX #",?24,"DRUG NAME",?56,"FPPS CLAIM",?68,"FPPS LINE"
"RTN","FBAACCB",97,0)
 . W !,?4,"CLAIMED",?17,"PAID",?30,"ADJ CODE",?41,"ADJ AMOUNT"
"RTN","FBAACCB",98,0)
 W !,Q,!
"RTN","FBAACCB",99,0)
 Q
"RTN","FBAACCB",100,0)
LISTP S Q="",$P(Q,"=",80)="="
"RTN","FBAACCB",101,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBAACCB",102,0)
ENP D HED S (FBAAOUT,FBINTOT)=0,FBINOLD=""
"RTN","FBAACCB",103,0)
 F A=0:0 S A=$O(^FBAA(162.1,"AE",B,A)) Q:A'>0!($G(FBAAOUT))  S FBIN=A D SETV^FBAACCB0 F B2=0:0 S B2=$O(^FBAA(162.1,"AE",B,A,B2)) Q:B2'>0!($G(FBAAOUT))  D INTOT^FBAACCB0 I $D(^FBAA(162.1,A,"RX",B2,0)) S Z(0)=^(0) D MORE^FBAACCB1
"RTN","FBAACCB",104,0)
 I '$G(FBAAOUT) S FBIN=0 D INTOT^FBAACCB0
"RTN","FBAACCB",105,0)
 Q
"RTN","FBAACCB0")
0^2^B9605771^B9170852
"RTN","FBAACCB0",1,0)
FBAACCB0 ;AISC/GRR-CLERK CLOSE BATCH CONTINUED ;5/12/1999
"RTN","FBAACCB0",2,0)
 ;;3.5;FEE BASIS;**5,4,116**;JAN 30, 1995;Build 30
"RTN","FBAACCB0",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACCB0",4,0)
LISTT S Q="",$P(Q,"=",80)="="
"RTN","FBAACCB0",5,0)
 S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBAACCB0",6,0)
ENT S FBAAOUT=0
"RTN","FBAACCB0",7,0)
 D HEDP F J=0:0 S J=$O(^FBAAC("AD",B,J)) Q:J'>0!($G(FBAAOUT))  F K=0:0 S K=$O(^FBAAC("AD",B,J,K)) Q:K'>0!($G(FBAAOUT))  I $D(^FBAAC(J,3,K,0)) S Y(0)=^(0) D SETT
"RTN","FBAACCB0",8,0)
 K FBCAN,FBCANDT,FBCANR,FBCK,FBCKDT,FBCKINT,FBDIS
"RTN","FBAACCB0",9,0)
 Q
"RTN","FBAACCB0",10,0)
HEDP W ?23,"'+' Represents Cancellation Activity",!?4,"Patient Name",?36,"SSN",?49,"Date",?56,"Travel Amount",!,Q,! Q
"RTN","FBAACCB0",11,0)
WRTT I $Y+7>IOSL D ASKH:$E(IOST,1,2)["C-" Q:FBAAOUT  W @IOF D HEDP
"RTN","FBAACCB0",12,0)
 I A2'=".00" W !,$S($D(QQ):QQ_") ",1:""),$S($G(FBCAN)]"":"+",1:""),?4,N,?32,$E(S,1,3),"-",$E(S,4,5),"-",$E(S,6,10),?47,$E(D,4,5),"/",$E(D,6,7),"/",$E(D,2,3),?59,"$ ",$J(A2,4,2)  D PMNT^FBAACCB2 Q
"RTN","FBAACCB0",13,0)
SETT S N=$S($D(^DPT(J,0)):$P(^(0),"^",1),1:""),S=$S(N]"":$P(^(0),"^",9),1:""),A2=$P(Y(0),"^",3),D=$P(Y(0),"^",1) D FBCKT(J,K),WRTT Q
"RTN","FBAACCB0",14,0)
 Q
"RTN","FBAACCB0",15,0)
SETV S K=$S($D(^FBAA(162.1,A,0)):$P(^(0),"^",4),1:"")
"RTN","FBAACCB0",16,0)
ENV S (V,VID)="" I K]"" S V=$S($D(^FBAAV(K,0)):$P(^(0),"^",1),1:""),VID=$S(V]"":$P(^(0),"^",2),1:"")
"RTN","FBAACCB0",17,0)
 Q
"RTN","FBAACCB0",18,0)
ASKH S DIR(0)="E" D ^DIR K DIR S:'Y FBAAOUT=1 Q
"RTN","FBAACCB0",19,0)
GMORE F K=0:0 S K=$O(^FBAAC("AJ",B,FBIN,J,K)) Q:K'>0!(FBAAOUT)  F L=0:0 S L=$O(^FBAAC("AJ",B,FBIN,J,K,L)) Q:L'>0!(FBAAOUT)  F M=0:0 S M=$O(^FBAAC("AJ",B,FBIN,J,K,L,M)) Q:M'>0!(FBAAOUT)  D SET^FBAACCB
"RTN","FBAACCB0",20,0)
 Q
"RTN","FBAACCB0",21,0)
INTOT ;; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACCB0",22,0)
 ;I FBINOLD'=FBIN&(FBINTOT>0) W !!,?15,"Invoice #: "_FBINOLD_"   Totals: $ "_$J(FBINTOT,1,2) S FBINTOT=0 Q
"RTN","FBAACCB0",23,0)
 I +FBINOLD'=0,FBINOLD'=FBIN&(FBINTOT]"") W !!,?15,"Invoice #: "_FBINOLD_"   Totals: $ "_$J(FBINTOT,1,2) S FBINTOT=0 Q
"RTN","FBAACCB0",24,0)
 Q
"RTN","FBAACCB0",25,0)
Q K C,B,J,K,L,M,T,X,Y,FZ,A,A1,A2,B2,CPTDESC,DO,DA,DIC,DIRUT,DL,DR,DRX,DX,FBAACPT,FBAAOUT,FBIN,FBINOLD,FBINTOT,FBVP,FBTYPE,FBPV,N,Q,S,V,VID,ZIS,XY,ZS,FBMODLE,FBVCHDT
"RTN","FBAACCB0",26,0)
 K FBAC,FBAP,FBDX,FBFD,FBI,FBK,FBLISTC,FBPDT,FBSC,FBTD Q
"RTN","FBAACCB0",27,0)
FBCKT(J,K) ;set travel check variables
"RTN","FBAACCB0",28,0)
 ;j,k required variables j=DA(1),k=DA
"RTN","FBAACCB0",29,0)
 I 'J!('K) S (FBCAN,FBCK,FBCANDT,FBCANR,FBDIS,FBCKDT,FBCKINT)="" Q
"RTN","FBAACCB0",30,0)
 S FBCKIN=$G(^FBAAC(J,3,K,0))
"RTN","FBAACCB0",31,0)
 S FBCAN=$P(FBCKIN,"^",10),FBCK=$P(FBCKIN,"^",7),FBCANDT=$P(FBCKIN,"^",8),FBCANR=$P(FBCKIN,"^",9),FBDIS=$P(FBCKIN,"^",11),FBCKDT=$P(FBCKIN,"^",6),FBCKINT=$P(FBCKIN,"^",12)
"RTN","FBAACCB0",32,0)
 K FBCKIN Q
"RTN","FBAACCB1")
0^3^B24359201^B22926738
"RTN","FBAACCB1",1,0)
FBAACCB1 ;AISC/GRR-CLERK CLOSE BATCH CONTINUED ; 11/24/10 10:27am
"RTN","FBAACCB1",2,0)
 ;;3.5;FEE BASIS;**55,61,116**;JAN 30, 1995;Build 30
"RTN","FBAACCB1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACCB1",4,0)
PHARM ;ENTRY FOR PHARMACY BATCH CALCULATE TOTAL DOLLARS AND LINE COUNT
"RTN","FBAACCB1",5,0)
 ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACCB1",6,0)
 F A=0:0 S A=$O(^FBAA(162.1,"AE",B,A)) Q:A'>0  F B2=0:0 S B2=$O(^FBAA(162.1,"AE",B,A,B2)) Q:B2'>0  I $D(^FBAA(162.1,A,"RX",B2,0)) S Z(0)=^(0) D MOREP
"RTN","FBAACCB1",7,0)
 G FIN^FBAACCB
"RTN","FBAACCB1",8,0)
MOREP S T=T+$P(Z(0),"^",16),C=C+1 Q
"RTN","FBAACCB1",9,0)
 ;
"RTN","FBAACCB1",10,0)
TRAV ;ENTRY FOR TRAVEL BATCH CALCULATE TOTAL DOLLARS AND LINE COUNT
"RTN","FBAACCB1",11,0)
 ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACCB1",12,0)
 F J=0:0 S J=$O(^FBAAC("AD",B,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("AD",B,J,K)) Q:K'>0  I $D(^FBAAC(J,3,K,0)) S Z(0)=^(0) D MORET
"RTN","FBAACCB1",13,0)
 G FIN^FBAACCB
"RTN","FBAACCB1",14,0)
 ;
"RTN","FBAACCB1",15,0)
MORET S T=T+$P(Z(0),"^",3),C=C+1 Q
"RTN","FBAACCB1",16,0)
LISTC S Q="",$P(Q,"=",80)="=",(FBAAOUT,FBLISTC)=0,IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","FBAACCB1",17,0)
PRTC D HEDC
"RTN","FBAACCB1",18,0)
 F I=0:0 S I=$O(^FBAAI("AC",B,I)) Q:I'>0!(FBAAOUT)  I $D(^FBAAI(I,0)) S Z(0)=^(0) D CMORE
"RTN","FBAACCB1",19,0)
 Q
"RTN","FBAACCB1",20,0)
CMORE N FBADJLR,FBFPPSC,FBFPPSL,FBX,FBY3
"RTN","FBAACCB1",21,0)
 S K=$P(Z(0),"^",3),J=$P(Z(0),"^",4) D ENV^FBAACCB0 S N=$$NAME^FBCHREQ2(J),S=$$SSN^FBAAUTL(J),FBIN=I,FBAC=$P(Z(0),"^",8)+.0001,FBAP=$P(Z(0),"^",9)+.0001,FBVP=$P(Z(0),"^",14),ZS=$P(Z(0),"^",13)
"RTN","FBAACCB1",22,0)
 S FBAC=$P(FBAC,".",1)_"."_$E($P(FBAC,".",2),1,2),FBAP=$P(FBAP,".",1)_"."_$E($P(FBAP,".",2),1,2)
"RTN","FBAACCB1",23,0)
 S FBSC=$P(Z(0),"^",11),FBSC=$S(FBSC="":"",$D(^FBAA(161.27,FBSC,0)):$P(^(0),"^",1),1:""),FBFD=$P(Z(0),"^",6),FBTD=$P(Z(0),"^",7) S FBPDT=FBFD D CDAT S FBFD=FBPDT,FBPDT=FBTD D CDAT S FBTD=FBPDT
"RTN","FBAACCB1",24,0)
 S FBY3=$G(^FBAAI(I,3))
"RTN","FBAACCB1",25,0)
 S FBFPPSC=$P(FBY3,U)
"RTN","FBAACCB1",26,0)
 S FBFPPSL=$P(FBY3,U,2)
"RTN","FBAACCB1",27,0)
 S FBX=$$ADJLRA^FBCHFA(I_",")
"RTN","FBAACCB1",28,0)
 S FBADJLR=$P(FBX,U)
"RTN","FBAACCB1",29,0)
 D FBCKI(I)
"RTN","FBAACCB1",30,0)
 S B(1617)=$S(B="":"",$D(^FBAA(161.7,B,0)):$P(^(0),"^"),1:"")
"RTN","FBAACCB1",31,0)
 S FBIN(1)=$P(Z(0),"^",2)
"RTN","FBAACCB1",32,0)
 D WRITC
"RTN","FBAACCB1",33,0)
 Q
"RTN","FBAACCB1",34,0)
WRITC I $Y+7>IOSL D ASKH^FBAACCB0:$E(IOST,1,2)["C-" Q:FBAAOUT  W @IOF D HEDC
"RTN","FBAACCB1",35,0)
 W !!,$S('$D(ZS):"",ZS="R":"*",1:"")
"RTN","FBAACCB1",36,0)
 W N,?35,S,?60,B(1617)
"RTN","FBAACCB1",37,0)
 W !,?3,V,?45,VID,?58,FBIN,?70,$$DATX^FBAAUTL($E(FBIN(1),1,7))
"RTN","FBAACCB1",38,0)
 I FBFPPSC]"" W !,?4,"FPPS Claim ID: ",FBFPPSC,"   FPPS Line: ",FBFPPSL
"RTN","FBAACCB1",39,0)
 W !,$S($D(QQ):QQ_")",1:""),FBVP,$S(FBCAN]"":"+",1:""),?4,FBFD,?13,FBTD,?22,$J(FBAC,6),?32,$J(FBAP,6),?45,$S(FBADJLR]"":FBADJLR,1:FBSC)
"RTN","FBAACCB1",40,0)
 W:$P(Z(0),"^",24) ?56,"Discharge ",$$ICD^FBCSV1(+$P(Z(0),"^",24),$P(Z(0),"^",6)) W ! ;CSV
"RTN","FBAACCB1",41,0)
 I $D(^FBAAI(I,"DX")) S FBDX=^("DX") F FBK=1:1:5 Q:$P(FBDX,"^",FBK)=""  D WRTDX
"RTN","FBAACCB1",42,0)
 I $D(^FBAAI(I,"PROC")) S FBPROC=^("PROC") W ! F FBL=1:1:5 Q:$P(FBPROC,"^",FBL)=""  D WRTPC
"RTN","FBAACCB1",43,0)
 S A2=FBAP D PMNT^FBAACCB2 K A2
"RTN","FBAACCB1",44,0)
 Q
"RTN","FBAACCB1",45,0)
CDAT S FBPDT=$E(FBPDT,4,5)_"/"_$S($E(FBPDT,6,7)="00":$E(FBPDT,2,3),1:$E(FBPDT,6,7)_"/"_$E(FBPDT,2,3))
"RTN","FBAACCB1",46,0)
 Q
"RTN","FBAACCB1",47,0)
HEDC W "Patient Name",?20,"('*' Reimbursement to Veteran   '+' Cancellation Activity)",!,?13,"('#' Voided Payment)",?60,"Batch Number"
"RTN","FBAACCB1",48,0)
 W !,?3,"Vendor Name",?45,"Vendor ID",?57,"Invoice #",?68,"Dt Inv Rec'd",!,?3,"FR DATE",?14,"TO DATE  CLAIMED   PAID",?41,"ADJ CODE",!,Q,!
"RTN","FBAACCB1",49,0)
 Q
"RTN","FBAACCB1",50,0)
CHNH ; FB*3.5*116
"RTN","FBAACCB1",51,0)
 S (J,FZ("CNT"))=0 F  S J=$O(^FBAAI("AC",B,J)) Q:J'>0  I $D(^FBAAI(J,0)) S Z(0)=^(0) D MORECH D:$P(FZ,U,15)'="Y" INVCNT
"RTN","FBAACCB1",52,0)
 S:$G(FZ("CNT")) $P(FZ,U,10)=FZ("CNT") K FZ("CNT")  ; CNH batch
"RTN","FBAACCB1",53,0)
 G FIN^FBAACCB
"RTN","FBAACCB1",54,0)
 ;
"RTN","FBAACCB1",55,0)
MORECH ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACCB1",56,0)
 S T=T+$P(Z(0),"^",9),C=C+1
"RTN","FBAACCB1",57,0)
 ; FB*3.5*116 - build array of invoices
"RTN","FBAACCB1",58,0)
 ;do not build array for CH batches not exempt from the pricer
"RTN","FBAACCB1",59,0)
 Q:($P(FZ,"^",18)'="Y")&($P(FZ,"^",15)="Y") 
"RTN","FBAACCB1",60,0)
 S FBARY($P(Z(0),"^"))=+$P(Z(0),"^",9)
"RTN","FBAACCB1",61,0)
 Q
"RTN","FBAACCB1",62,0)
 ;
"RTN","FBAACCB1",63,0)
WRTDX W ?4,"Dx: ",$$ICD9^FBCSV1($P(FBDX,"^",FBK),$P($G(Z(0)),"^",6)),"  " Q  ;CSV
"RTN","FBAACCB1",64,0)
WRTPC W ?4,"Proc: ",$$ICD0^FBCSV1($P(FBPROC,"^",FBL),$P($G(Z(0)),"^",6)),"  " Q  ;CSV
"RTN","FBAACCB1",65,0)
MORE ;
"RTN","FBAACCB1",66,0)
 N FBADJLA,FBADJLR,FBFPPSC,FBFPPSL,FBX,TAMT
"RTN","FBAACCB1",67,0)
 S J=$P(Z(0),"^",5),D=$P(Z(0),"^",3),FBAACPT=$P(Z(0),"^",1),N=$S($D(^DPT(J,0)):$P(^(0),"^",1),1:""),S=$S(N]"":$P(^DPT(J,0),"^",9),1:""),FBIN=A,CPTDESC=$P(Z(0),"^",2)
"RTN","FBAACCB1",68,0)
 S Y="",$P(Y,"^",2)=$P(Z(0),"^",4),$P(Y,"^",3)=$P(Z(0),"^",16),$P(Y,"^",12)=0,T=$P(Z(0),"^",8),T=$S(T="":"",$D(^FBAA(161.27,T,0)):^(0),1:""),$P(Y,"^",9)=$P(Z(0),"^",1),ZS=$P(Z(0),"^",20),FBPV=""
"RTN","FBAACCB1",69,0)
 ;
"RTN","FBAACCB1",70,0)
 S FBFPPSC=$P($G(^FBAA(162.1,A,0)),U,13)
"RTN","FBAACCB1",71,0)
 S FBFPPSL=$P($G(^FBAA(162.1,A,"RX",B2,3)),U)
"RTN","FBAACCB1",72,0)
 S FBX=$$ADJLRA^FBRXFA(B2_","_A_",")
"RTN","FBAACCB1",73,0)
 S FBADJLR=$P(FBX,U)
"RTN","FBAACCB1",74,0)
 S FBADJLA=$P(FBX,U,2)
"RTN","FBAACCB1",75,0)
 S TAMT=$FN($P(Z(0),"^",7),"",2)
"RTN","FBAACCB1",76,0)
 ;
"RTN","FBAACCB1",77,0)
 D FBCKP(A,B2)
"RTN","FBAACCB1",78,0)
 S FBIN(1)=$P($G(^FBAA(162.1,+A,0)),"^",2)
"RTN","FBAACCB1",79,0)
 G GO^FBAACCB
"RTN","FBAACCB1",80,0)
INVCNT ;set invoice count for cnh batch
"RTN","FBAACCB1",81,0)
 S FZ("CNT")=FZ("CNT")+1
"RTN","FBAACCB1",82,0)
 Q
"RTN","FBAACCB1",83,0)
FBCKI(FBI) ;set inpatient check variables
"RTN","FBAACCB1",84,0)
 ;fbi=DA
"RTN","FBAACCB1",85,0)
 I '$G(FBI) S (FBCKDT,FBCK,FBCANDT,FBCANR,FBCAN,FBDIS,FBCKINT)="" Q
"RTN","FBAACCB1",86,0)
 S FBCKIN=$G(^FBAAI(FBI,2))
"RTN","FBAACCB1",87,0)
 S U="^",FBCKDT=+FBCKIN,FBCK=$P(FBCKIN,U,4),FBCANDT=$P(FBCKIN,U,5),FBCANR=$P(FBCKIN,U,6),FBCAN=$P(FBCKIN,U,7),FBDIS=$P(FBCKIN,U,8),FBCKINT=$P(FBCKIN,U,9) K FBCKIN
"RTN","FBAACCB1",88,0)
 Q
"RTN","FBAACCB1",89,0)
FBCKP(J,K) ;set pharmacy check variables
"RTN","FBAACCB1",90,0)
 ;j,k required input variables to = da(1) and da respectively (162.1)
"RTN","FBAACCB1",91,0)
 I '$G(J)!('$G(K)) Q
"RTN","FBAACCB1",92,0)
 S FBCKIN=$G(^FBAA(162.1,J,"RX",K,2))
"RTN","FBAACCB1",93,0)
 S U="^",FBCKDT=$P(FBCKIN,U,8),FBCK=$P(FBCKIN,U,10),FBCANDT=$P(FBCKIN,U,11),FBCANR=$P(FBCKIN,U,12),FBCAN=$P(FBCKIN,U,13),FBDIS=$P(FBCKIN,U,14),FBCKINT=$P(FBCKIN,U,15) K FBCKIN
"RTN","FBAACCB1",94,0)
 Q
"RTN","FBAACO")
0^4^B28424330^B31870398
"RTN","FBAACO",1,0)
FBAACO ;AISC/GRR-ENTER MEDICAL PAYMENT ;7/13/2003
"RTN","FBAACO",2,0)
 ;;3.5;FEE BASIS;**4,61,79,116**;JAN 30, 1995;Build 30
"RTN","FBAACO",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO",4,0)
EN583 ;driver for opt payments (entry point for uc)
"RTN","FBAACO",5,0)
 K FBAAOUT,FBPOP
"RTN","FBAACO",6,0)
 D SITE G Q:$G(FBPOP) D BT G Q:$G(FBAAOUT)
"RTN","FBAACO",7,0)
1 K FBAAID,FBAAVID,FBAAOUT,FBDL,FBAAMM D SITE G Q:$G(FBPOP) S FBINTOT=0 W !!
"RTN","FBAACO",8,0)
 I '$D(FB583) K FBDL,FBAR D GETVET^FBAAUTL1 G EN583:'DFN K FBAAOUT,FBDMRA D GETAUTH^FBAAUTL1 G 1:FTP']""
"RTN","FBAACO",9,0)
 K FBAAOUT
"RTN","FBAACO",10,0)
 I $G(FBCHCO) S FB7078=$S($G(FB7078):FB7078_";FB7078(",$D(FB583):FB583_";FB583(",1:"")
"RTN","FBAACO",11,0)
 D:FBAAPTC="R" ^FBAACO0
"RTN","FBAACO",12,0)
 D ^FBAAEAR:$P(FBSITE(1),"^",4)="Y"
"RTN","FBAACO",13,0)
 D PAT,GETVEN1^FBAACO1:$D(FB583),GETVEN^FBAACO1:'$D(FB583) I $G(FBAAOUT) G Q:$D(FB583),1
"RTN","FBAACO",14,0)
 W !! D FILEV^FBAACO5(DFN,FBV) I $G(FBAAOUT) G Q:$D(FB583),1
"RTN","FBAACO",15,0)
 ;check for payments against all linked vendors
"RTN","FBAACO",16,0)
 S DA=+Y D CHK^FBAACO4 K FBAACK1,FBAAOUT,DA,X,Y
"RTN","FBAACO",17,0)
 K FBAAID,FBAAVID D GETINV^FBAACO1 I $G(FBAAOUT) Q:$D(FBCHCO)  G Q:$D(FB583),1
"RTN","FBAACO",18,0)
 I '$D(FBAAID)!('$D(FBAAVID)) D GETINDT^FBAACO1 I $G(FBAAOUT) D OUT G Q:$D(FB583),1:'$D(FBCHCO) Q
"RTN","FBAACO",19,0)
 ; ask patient account number
"RTN","FBAACO",20,0)
 S FBCSID=$$ASKPAN^FBUTL5() I FBCSID="^" K FBCSID S FBAAOUT=1 D OUT G Q:$D(FB583),1:'$D(FBCHCO) Q
"RTN","FBAACO",21,0)
 ; if U/C then get FPPS Claim ID else ask user
"RTN","FBAACO",22,0)
 I $D(FB583) S FBFPPSC=$P($G(^FB583(FB583,5)),U) W !,"FPPS CLAIM ID: ",$S(FBFPPSC="":"N/A",1:FBFPPSC)
"RTN","FBAACO",23,0)
 E  S FBFPPSC=$$FPPSC^FBUTL5() I FBFPPSC=-1 K FBFPPSC S FBAAOUT=1 D OUT G Q:$D(FB583),1:'$D(FBCHCO) Q
"RTN","FBAACO",24,0)
 G 1^FBAAMP:$G(FBMP) D MM G Q:$G(FBAAOUT)
"RTN","FBAACO",25,0)
SVDT K FBAAOUT,HOLDY W !! D GETSVDT^FBAACO5(DFN,FBV,FBASSOC,1) I $G(FBAAOUT) K FBAADT,FBX,FBAACP W:FBINTOT>0 !!,"Invoice: "_FBAAIN_" Totals $ "_$J(FBINTOT,1,2) G Q:$D(FB583)!($G(FBCHCO)),1
"RTN","FBAACO",26,0)
 D SETO^FBAACO3,DISPINV^FBAACO1
"RTN","FBAACO",27,0)
 W ! D ASKZIP^FBAAFS($G(FBV),$G(FBAADT))
"RTN","FBAACO",28,0)
 I $G(FBAAOUT)!(FBZIP']"") D DEL^FBAACO3 G SVDT
"RTN","FBAACO",29,0)
CPT K FBAAOUT W !
"RTN","FBAACO",30,0)
 D CPTM^FBAALU($G(FBAADT),$G(DFN)) I 'FBGOT D DEL^FBAACO3 G SVDT
"RTN","FBAACO",31,0)
 D CHK2^FBAACO4 I FBJ']"" G SVPR
"RTN","FBAACO",32,0)
CHKE ;determines what action to take on duplicate services entered
"RTN","FBAACO",33,0)
 K FBAAOUT W !!,*7,"Service selected for that date already in system."
"RTN","FBAACO",34,0)
 S DIR(0)="Y",DIR("A")="Do you want to add another service for the SAME DATE",DIR("B")="No" D ^DIR K DIR G Q:$D(DIRUT),SVPR:Y
"RTN","FBAACO",35,0)
 I FBJ]"",FBJ'=FBV W !!,*7,"You must use the 'EDIT PAYMENT' option to edit the service previously",!,"entered for that date." D DEL^FBAACO3 G SVDT
"RTN","FBAACO",36,0)
 S DIR(0)="Y",DIR("A")="Want to edit it",DIR("B")="No" D ^DIR K DIR G Q:$D(DIRUT) I Y D DOEDIT^FBAACO3 G SVDT:'$D(FBDL)!($G(FBAAOUT)),Q:$D(FB583),1
"RTN","FBAACO",37,0)
 D ^FBAACO2 G CPT:'$G(FBDEN)
"RTN","FBAACO",38,0)
SVPR K FBAAOUT
"RTN","FBAACO",39,0)
 I $$ANES^FBAAFS($$CPT^FBAAUTL4($G(FBAACP))) D ASKTIME^FBAAFS I $G(FBAAOUT)!'$G(FBTIME) G CPT
"RTN","FBAACO",40,0)
 D SVCPR^FBAACO1 G CPT:$G(FBAAOUT)
"RTN","FBAACO",41,0)
 S FBAMTPD=0 D FILE^FBAACO2 I $D(FBAAOUT) G Q:$D(FB583),1:$D(FBDL),Q
"RTN","FBAACO",42,0)
 D OUT^FBAACO3 W:Z1>(FBAAMPI-20) !,*7,"Warning, you can only enter ",(FBAAMPI-Z1)," more line(s)!" G CPT:Z1'>(FBAAMPI-1) D WARN^FBAACO3 G EN583
"RTN","FBAACO",43,0)
 G 1
"RTN","FBAACO",44,0)
 ;
"RTN","FBAACO",45,0)
Q ;exit point for outpatient payment routines
"RTN","FBAACO",46,0)
 K FBAAPTC,DIC,Y,A,I,DFN,BO,DA,DI,DQ,DR,E,FBAABDT,FBAABE,FBFY,FBDL,FBAAID,FBAAIN,FBAAMPI,FBAAOPA,FBAAPN,FBCONT,FBDX,FBGOT,FBPOV,FBPT,DLAYGO,FBPSA,FBASSOC,FBZBN,FBZBS,FBDEN,FBV,FBSDI,FBAACPI,FBAACP,FBX,FBLOCK
"RTN","FBAACO",47,0)
 K FBSP,FBTPD,FBTT,FBTYPE,FTP,FBDEL,FY,FBINTOT,G,H,MAJN,NO,PI,Q,R,SUB,SUBN,TA,TP,UL,W,X1,Z,Z1,ZZ,FBAADT,K,L,J,FBTOV,FBPARCD,FBT,FEEO,Z2,FBSITE,FBAUT,T,FBLOC,FBSSN,FBVEN,FBD1,Z0,FB583
"RTN","FBAACO",48,0)
 K A1,A2,B1,B2,DAT,DIE,FBAACPT,FBAMTPD,FBAAEDT,FBAAOUT,FBAAPD,FBI,FBIN,FBPROG,FBRR,FBXX,PTYPE,S,VAL,X,V,ZS,FB7078,FBFDC,FBCOUNTY,FBMST,FBTTYPE,FBTV,HY,FBDMRA,DIRUT,FBPOP,FBJ,FBAACK1,FBAR,FBDA,FBST
"RTN","FBAACO",49,0)
 K FBMP,FBK,FBAAAS,%DT,FBDT,FBMAX,FBAMFS,FBAASC,FBHCFA,FBSI,FBCNP,FBAAAMT,FBAAVID,FBAAMM,FBAAMM1,VAPA,FBZX,FBTST,HOLDY,FBAOT
"RTN","FBAACO",50,0)
 K FBCSID,FBFPPSC,FBFPPSL,FBADJ,FBADJD,FBADJL,FBRRMK,FBRRMKD,FBRRMKL,FBUNITS
"RTN","FBAACO",51,0)
AUTHQ K DIC,DFN,CNT,FB7078,FBAABDT,FBAAEDT,FBAAOUT,FBASSOC,FBAUT,FBPOV,FBPROG,FBPSA,FBPT,FBTT,FBTYPE,FBVEN,FBTP,PI,TA,FBMOD,FBMODA,FBZIP,FBTIME,FBFSAMT,FBFSUSD
"RTN","FBAACO",52,0)
 Q
"RTN","FBAACO",53,0)
 ;
"RTN","FBAACO",54,0)
SITE ;set up site variables
"RTN","FBAACO",55,0)
 D:'$D(FBSITE(0)) SITEP^FBAAUTL Q:$G(FBPOP)  I '$G(FBPROG) D
"RTN","FBAACO",56,0)
 .I $G(FBCHCO) S FBPROG="I ($P(^(0),""^"",3)=6!($P(^(0),""^"",3)=7))&($P(^(0),U,9)'[""FB583"")" Q
"RTN","FBAACO",57,0)
 .S FBPROG=$S($P(FBSITE(1),"^",6)="":"I $P(^(0),""^"",9)'[""FB583""",1:"I $P(^(0),""^"",3)=2,($P(^(0),""^"",9)'[""FB583"")")
"RTN","FBAACO",58,0)
 S:'$D(FBAAPTC) FBAAPTC="V"
"RTN","FBAACO",59,0)
 S FBAAMPI=$P($G(^FBAA(161.4,1,"FBNUM")),"^",3),FBAAMPI=$S(FBAAMPI]"":FBAAMPI,1:100)
"RTN","FBAACO",60,0)
 Q
"RTN","FBAACO",61,0)
 ;
"RTN","FBAACO",62,0)
BT ;select batch
"RTN","FBAACO",63,0)
 S DIC="^FBAA(161.7,",DIC(0)="AEQM",DIC("S")="I $P(^(0),U,3)=""B3""&($G(^(""ST""))=""O"")&(($P(^(0),U,5)=DUZ)!($D(^XUSEC(""FBAASUPERVISOR"",DUZ))))",DIC("W")="W !,""  Obligation #: "",$P(^(0),U,2)" W !! D ^DIC K DIC I X["^"!(X="") S FBAAOUT=1 Q
"RTN","FBAACO",64,0)
 G BT:Y<0 S (DA,FBAABE)=+Y,Y(0)=^FBAA(161.7,DA,0)
"RTN","FBAACO",65,0)
 I $P(Y(0),"^",11)>(FBAAMPI-1) W !!,"This Batch already has the maximum number of Payments!" G BT
"RTN","FBAACO",66,0)
 S Z1=$P(Y(0),"^",11),FB7078="",BO=$P(^FBAA(161.7,DA,0),"^",2)
"RTN","FBAACO",67,0)
 Q
"RTN","FBAACO",68,0)
PAT ;set up patient in patient file
"RTN","FBAACO",69,0)
 ;required input variable DFN
"RTN","FBAACO",70,0)
 I '$D(^FBAAC(DFN,0)) K DD,DO S (X,DINUM)=DFN,DIC(0)="L",DLAYGO=162,DIC="^FBAAC(" D FILE^DICN K DLAYGO,DIC,DINUM,DD,DO,DA
"RTN","FBAACO",71,0)
 Q
"RTN","FBAACO",72,0)
MM ;check for money management of entire invoice
"RTN","FBAACO",73,0)
 ; fb*3.5*116
"RTN","FBAACO",74,0)
 ;I FBAAPTC="R" S FBAAMM="" Q
"RTN","FBAACO",75,0)
 ;W ! S DIR(0)="Y",DIR("A")="Will any line items in this invoice be for contracted services",DIR("B")="No",DIR("?")="Answering no indicates interest will not be paid for any line items." D ^DIR K DIR I $D(DIRUT) S FBAAOUT=1 Q
"RTN","FBAACO",76,0)
 ;S FBAAMM=$S(Y=1:1,1:"")
"RTN","FBAACO",77,0)
 D MMPPT^FBAACP
"RTN","FBAACO",78,0)
 Q
"RTN","FBAACO",79,0)
OUT K FBAADT,FBX,FBAACP W:FBINTOT>0 !!,"Invoice: "_FBAAIN_" Totals $ "_$J(FBINTOT,1,2) Q
"RTN","FBAACO2")
0^5^B12957977^B12950547
"RTN","FBAACO2",1,0)
FBAACO2 ;AISC/GRR-PAYMENT PROCESS FOR DUPLICATE ;7/13/2003
"RTN","FBAACO2",2,0)
 ;;3.5;FEE BASIS;**4,55,61,77,116**;JAN 30, 1995;Build 30
"RTN","FBAACO2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO2",4,0)
RD S DIR(0)="Y",DIR("A")="Want this payment stored as a Medical Denial",DIR("B")="YES",DIR("?")="Enter 'Yes' to store payment entry as a denial and send a Suspension letter.  Enter 'No' to have nothing happen." D ^DIR K DIR Q:$D(DIRUT)!('Y)
"RTN","FBAACO2",5,0)
 S FBDEN=1 Q
"RTN","FBAACO2",6,0)
FILE ;files sp multiple entry
"RTN","FBAACO2",7,0)
 K DR S TP="" I $G(FBDEN) S FBAMTPD=0
"RTN","FBAACO2",8,0)
 S DR="49///^S X=$G(FBCSID);50///^S X=$G(FBFPPSC);I $G(FBDEN) S Y=1;48;47//1;S FBUNITS=X;S:$G(FBFPPSC)="""" Y=""@11"";S FBX=$$FPPSL^FBUTL5();S:FBX=-1 Y=0;51///^S X=FBX;@11"
"RTN","FBAACO2",9,0)
 ; fb*3.5*116 do not enable different interest indicator values at line item level; interest indicator set at invoice level
"RTN","FBAACO2",10,0)
 ;S DR(1,162.03,1)="D PPT^FBAACO1();34///^S X=$G(FBAAMM1);D POS^FBAACO1;S:'$G(FBHCFA(30)) Y=0;1;S J=X;I $G(FBDEN) S Y=2;D FEE^FBAACO0;44////^S X=FBFSAMT;45///^S X=FBFSUSD;2///^S X=FBAMTPD;S K=X"
"RTN","FBAACO2",11,0)
 S DR(1,162.03,1)="34///^S X=$G(FBAAMM);D POS^FBAACO1;S:'$G(FBHCFA(30)) Y=0;1;S J=X;I $G(FBDEN) S Y=2;D FEE^FBAACO0;44////^S X=FBFSAMT;45///^S X=FBFSUSD;2///^S X=FBAMTPD;S K=X"
"RTN","FBAACO2",12,0)
 ;S DR(1,162.03,2)="S:J-K=0 Y=6;3//^S X=$S(J-K:J-K,1:"""");S:'X Y=6;3.5///^S X=DT;@4;4;I X']"""" D SC^FBAACO3;S:X'=4 Y=6;22;6////^S X=DUZ"
"RTN","FBAACO2",13,0)
 S DR(1,162.03,2)="S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2);S:FBX=0 Y=0;6////^S X=DUZ"
"RTN","FBAACO2",14,0)
 S DR(1,162.03,3)="7////^S X=FBAABE;8////^S X=BO;13///^S X=FBAAID;14///^S X=FBAAIN;33///^S X=FBAAVID;I $G(FBDEN) S FBTST=1"
"RTN","FBAACO2",15,0)
 I '$G(FBDEN) D
"RTN","FBAACO2",16,0)
 .N FBCSVSTR S FBCSVSTR="I X]"""" S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@1"";"
"RTN","FBAACO2",17,0)
 .S DR(1,162.03,4)="S:$$EXTPV^FBAAUTL5(FBPOV)=""01"" Y=""@1"";S:FB7078]""""!($D(FB583)) Y=30;@5;28R;S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@5"";30////^S X=FBHCFA(30);31;32R;S Y=15;@1;28;"_FBCSVSTR_"30////^S X=FBHCFA(30);31"
"RTN","FBAACO2",18,0)
 .S DR(1,162.03,5)="15///^S X=FBPT;S FBX=$$RR^FBUTL4(.FBRRMK,2);S:FBX=0 Y=0"
"RTN","FBAACO2",19,0)
 .S DR(1,162.03,6)="16////^S X=FBPOV;17///^S X=FBTT;18///^S X=FBAAPTC;23////^S X=FBTYPE;26////^S X=FBPSA;S:$D(FBV583) Y=""@2"";27////^S X=FB7078;S Y=""@99"";@2;27////^S X=FBV583;@99;S FBTST=1"
"RTN","FBAACO2",20,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"
"RTN","FBAACO2",21,0)
 S DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI,DA=FBAACPI
"RTN","FBAACO2",22,0)
 D LOCK^FBUCUTL("^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",FBAACPI,1)
"RTN","FBAACO2",23,0)
 D
"RTN","FBAACO2",24,0)
 . N ICDVDT S ICDVDT=$G(FBAADT) D ^DIE
"RTN","FBAACO2",25,0)
 I '$D(DTOUT),$G(FBTST) D
"RTN","FBAACO2",26,0)
 . D FILEADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAACO2",27,0)
 . D FILERR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACO2",28,0)
 L -^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI)
"RTN","FBAACO2",29,0)
 I $D(DTOUT) D KILL Q
"RTN","FBAACO2",30,0)
 I '$G(FBTST),$G(DA) S DIR(0)="YA",DIR("A")="Entering an '^' will delete "_$S($G(FBDEN):"denial",1:"payment")_".  Are you sure you want to delete? ",DIR("B")="No" D ^DIR K DIR G FILE:'$D(DIRUT)&('Y) D KILL Q
"RTN","FBAACO2",31,0)
 K FBTST,FBDEN,FBAAMM1,DIE,DR,DA,FBX
"RTN","FBAACO2",32,0)
 I $D(FBDL) S FBAAOUT=1 Q
"RTN","FBAACO2",33,0)
 Q
"RTN","FBAACO2",34,0)
KILL S DIK=DIE D ^DIK K DIE,DIK I '$G(FBCNP) D Q^FBAACO S FBAAOUT=1
"RTN","FBAACO2",35,0)
 W !,"Deleted" Q
"RTN","FBAACO3")
0^6^B48295702^B47823377
"RTN","FBAACO3",1,0)
FBAACO3 ;AISC/GRR-ENTER PAYMENT CONTINUED ;7/7/2003
"RTN","FBAACO3",2,0)
 ;;3.5;FEE BASIS;**4,38,55,61,116**;JAN 30, 1995;Build 30
"RTN","FBAACO3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACO3",4,0)
DOEDIT ;
"RTN","FBAACO3",5,0)
 N FB1725,FBFPPSC
"RTN","FBAACO3",6,0)
 W ! S FBAACP(0)=FBAACP
"RTN","FBAACO3",7,0)
 S DIC="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"
"RTN","FBAACO3",8,0)
 S DIC(0)="EQMZ",DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI
"RTN","FBAACO3",9,0)
 S X=$$CPT^FBAAUTL4(FBAACP)
"RTN","FBAACO3",10,0)
 D ^DIC I Y<0 S FBAAOUT=1 Q
"RTN","FBAACO3",11,0)
 S (DA,FBAACPI)=+Y,K=$P(Y(0),U,3),FBZBN=$P(Y(0),U,8),FBZBS=$S(FBZBN]"":$P($G(^FBAA(161.7,FBZBN,"ST")),U),1:""),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBAACO3",12,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBAACO3",13,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBAACO3",14,0)
 S FBAAMM1=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,2)),U,2)
"RTN","FBAACO3",15,0)
 S FBFSAMT(0)=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,2)),U,12)
"RTN","FBAACO3",16,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBAACO3",17,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBAACO3",18,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"_FBAACPI_",""M"")")
"RTN","FBAACO3",19,0)
 ; load current adjustment data
"RTN","FBAACO3",20,0)
 D LOADADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAACO3",21,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBAACO3",22,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBAACO3",23,0)
 ; load current remittance remark data
"RTN","FBAACO3",24,0)
 D LOADRR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACO3",25,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBAACO3",26,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBAACO3",27,0)
 ; load FPPS data
"RTN","FBAACO3",28,0)
 S FBFPPSC=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,3)),U)
"RTN","FBAACO3",29,0)
 S FBFPPSL=$P($G(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,3)),U,2)
"RTN","FBAACO3",30,0)
 I FBZBS=""!(FBZBS="V") D NOGO S FBAAOUT=1 Q
"RTN","FBAACO3",31,0)
 ; first edit CPT code and modifiers
"RTN","FBAACO3",32,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) S FBAAOUT=1 Q
"RTN","FBAACO3",33,0)
 ; if CPT was changed then update file
"RTN","FBAACO3",34,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" S FBAAOUT=1 Q
"RTN","FBAACO3",35,0)
 . N FBIENS,FBFDA
"RTN","FBAACO3",36,0)
 . S FBIENS=FBAACPI_","_FBSDI_","_FBV_","_DFN_","
"RTN","FBAACO3",37,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBAACO3",38,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBAACO3",39,0)
 ; if modifiers changed then update file
"RTN","FBAACO3",40,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(DFN,FBV,FBSDI,FBAACPI)
"RTN","FBAACO3",41,0)
 ; now edit remaining fields
"RTN","FBAACO3",42,0)
 D SETO K DR
"RTN","FBAACO3",43,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBAACO3",44,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only
"RTN","FBAACO3",45,0)
 ;S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1);34///@;34////^S X=FBAAMM1;30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAACO3",46,0)
 S DR(1,162.03,1)="30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAACO3",47,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBAACO3",48,0)
 ;S DR(1,162.03,3)="3//^S X=$S(J-K:J-K,1:"""");4;S:X'=4 Y=6;22;6////^S X=DUZ;13;33"
"RTN","FBAACO3",49,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBAACO3",50,0)
 S DR(1,162.03,4)="S:FBFPPSC="""" Y=13;W !,""FPPS CLAIM ID: ""_FBFPPSC;S FBX=$$FPPSL^FBUTL5(FBFPPSL,,1);51///^S X=FBX;S FBFPPSL=X;13;33"
"RTN","FBAACO3",51,0)
 S DR(1,162.03,5)="S:$$EXTPV^FBAAUTL5(FBPOV)=""01"" Y=""@1"";S Y=$S('$D(FB7078):28,FB7078]"""":31,1:28);@5;28R;S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@5"";31;32R;S Y=""@7"";@1;28;I X]"""" S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@1"";31"
"RTN","FBAACO3",52,0)
 S DR(1,162.03,6)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBAACO3",53,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",DIE("NO^")="",FBOT=1
"RTN","FBAACO3",54,0)
 D LOCK^FBUCUTL("^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",FBAACPI) I 'FBLOCK S FBAAOUT=1 Q
"RTN","FBAACO3",55,0)
 D ^DIE
"RTN","FBAACO3",56,0)
 ; if adjustment data changed then file
"RTN","FBAACO3",57,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAACO3",58,0)
 ; if remit remark data changed then file
"RTN","FBAACO3",59,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACO3",60,0)
 L -^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI) K FBOT,DIE,DR,DA
"RTN","FBAACO3",61,0)
 Q:$D(FBDL)
"RTN","FBAACO3",62,0)
 I $G(FBAAIN) S FBINTOT=0 D CALC
"RTN","FBAACO3",63,0)
 Q
"RTN","FBAACO3",64,0)
SETO S FY=$E(FBAADT,1,3)+1700+$S($E(FBAADT,4,5)>9:1,1:0)
"RTN","FBAACO3",65,0)
 Q
"RTN","FBAACO3",66,0)
OUT ;
"RTN","FBAACO3",67,0)
 ; FB*3.5*116 count line items that have 0.00 amount paid
"RTN","FBAACO3",68,0)
 ;I K>0 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1,FBINTOT=FBINTOT+K
"RTN","FBAACO3",69,0)
 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1,FBINTOT=FBINTOT+K
"RTN","FBAACO3",70,0)
 Q
"RTN","FBAACO3",71,0)
CKMAX S (FBAOT,A)=0,O="" F Z=S-.1:0 S Z=$O(^FBAAC(DFN,"AB",Z)) Q:Z'>0!(Z>R)  F Q=0:0 S Q=$O(^FBAAC(DFN,"AB",Z,Q)) Q:Q'>0  S W=$O(^FBAAC(DFN,"AB",Z,Q,0)) I $D(^FBAAC(DFN,1,Q,1,W,0)) D SMORE
"RTN","FBAACO3",72,0)
 I A>$P(FBSITE(1),"^",9) G NO
"RTN","FBAACO3",73,0)
 Q
"RTN","FBAACO3",74,0)
SMORE N FBA,FBB S FBB=$P($G(^FBAAC(+DFN,1,+Q,1,+W,0)),U,4),E=0
"RTN","FBAACO3",75,0)
 F  S E=$O(^FBAAC(DFN,1,Q,1,W,1,E)) Q:'E  S FBA=$G(^(E,0)) I $P(FBA,"^",9)=2,$P(FBA,"^",18)'=1 D
"RTN","FBAACO3",76,0)
 .I $$IDCHK^FBAAUTL3(DFN,FBB) S A=A+$P(FBA,"^",3) Q
"RTN","FBAACO3",77,0)
 .S FBAOT=FBAOT+$P(FBA,U,3)
"RTN","FBAACO3",78,0)
 Q
"RTN","FBAACO3",79,0)
NO W !!,*7,"Warning Patient already at maximum allowed for month of service",! Q
"RTN","FBAACO3",80,0)
WARN W !!,*7,"You have reached the maximum number of payments for a Batch!",!,"You must select another Batch for entering Payments!"
"RTN","FBAACO3",81,0)
CALC ;Calculate Current Invoice Total
"RTN","FBAACO3",82,0)
 F J=0:0 S J=$O(^FBAAC("C",FBAAIN,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("C",FBAAIN,J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("C",FBAAIN,J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("C",FBAAIN,J,K,L,M)) Q:M'>0  D CALC1
"RTN","FBAACO3",83,0)
 K J,K,L,M,FZNODE Q
"RTN","FBAACO3",84,0)
CALC1 S FZNODE=^FBAAC(J,1,K,1,L,1,M,0),A2=$P(FZNODE,"^",3),FBINTOT=FBINTOT+A2,FBAAID=$P(FZNODE,"^",15),FBAAVID=$P($G(^FBAAC(J,1,K,1,L,1,M,2)),"^")
"RTN","FBAACO3",85,0)
 Q
"RTN","FBAACO3",86,0)
FEEDT ;
"RTN","FBAACO3",87,0)
 ; input FB1725 - true (=1) when edited payment is for a Mill Bill claim
"RTN","FBAACO3",88,0)
 N FBX
"RTN","FBAACO3",89,0)
 D SETO:'$G(FY) S FBFY=FY-1
"RTN","FBAACO3",90,0)
 S (FBFSAMT,FBFSUSD)="",FBAMTPD=$G(FBAMTPD)
"RTN","FBAACO3",91,0)
 S FBX=$$GET^FBAAFS($$CPT^FBAAUTL4(FBAACP),$$MODL^FBAAUTL4("FBMODA","E"),FBAADT,$G(FBZIP),$$FAC^FBAAFS($G(FBHCFA(30))),$G(FBTIME))
"RTN","FBAACO3",92,0)
 I '$G(FBAAMM1) D
"RTN","FBAACO3",93,0)
 . S FBFSAMT=$P(FBX,U),FBFSUSD=$P(FBX,U,2)
"RTN","FBAACO3",94,0)
 E  D
"RTN","FBAACO3",95,0)
 . W !,?2,"Payment is for a contracted service so fee schedule does not apply."
"RTN","FBAACO3",96,0)
 I $P($G(FBX),U)]"" D
"RTN","FBAACO3",97,0)
 . W !?2,$S($G(FBAAMM1):"However, f",1:"F")
"RTN","FBAACO3",98,0)
 . W "ee schedule amount is $",$P(FBX,U)," from the "
"RTN","FBAACO3",99,0)
 . W:$P(FBX,U,3)]"" $P(FBX,U,3)," " ; year if returned
"RTN","FBAACO3",100,0)
 . W:$P(FBX,U,2)]"" $$EXTERNAL^DILFD(162.03,45,"",$P(FBX,U,2))
"RTN","FBAACO3",101,0)
 E  W !?2,"Unable to determine a FEE schedule amount."
"RTN","FBAACO3",102,0)
 ;
"RTN","FBAACO3",103,0)
 I FB1725 D
"RTN","FBAACO3",104,0)
 . W !!?2,"**Payment is for emergency treatment under 38 U.S.C. 1725."
"RTN","FBAACO3",105,0)
 . I FBFSAMT D
"RTN","FBAACO3",106,0)
 . . S FBFSAMT=$J(FBFSAMT*.7,0,2)
"RTN","FBAACO3",107,0)
 . . W !?2,"  Therefore, fee schedule amount reduced to $",FBFSAMT," (70%)."
"RTN","FBAACO3",108,0)
 ;
"RTN","FBAACO3",109,0)
 I $G(FBUNITS)>1 D
"RTN","FBAACO3",110,0)
 . W !!?2,"Units Paid = ",FBUNITS
"RTN","FBAACO3",111,0)
 . Q:FBFSAMT'>0
"RTN","FBAACO3",112,0)
 . N FBFSUNIT
"RTN","FBAACO3",113,0)
 . ; determine if fee schedule can be multipled by units
"RTN","FBAACO3",114,0)
 . S FBFSUNIT=$S(FBFSUSD="R":1,FBFSUSD="F"&(FBAADT>3040930):1,1:0)
"RTN","FBAACO3",115,0)
 . I FBFSUNIT D
"RTN","FBAACO3",116,0)
 . . S FBFSAMT=$J(FBFSAMT*FBUNITS,0,2)
"RTN","FBAACO3",117,0)
 . . W !?2,"  Therefore, fee schedule amount increased to $",FBFSAMT
"RTN","FBAACO3",118,0)
 . E  D
"RTN","FBAACO3",119,0)
 . . W !?2,"  Fee schedule not complied on per unit basis so amount not adjusted by units."
"RTN","FBAACO3",120,0)
 ;
"RTN","FBAACO3",121,0)
 I '$G(FBAAMM1) D
"RTN","FBAACO3",122,0)
 . ; set default amount paid to lesser of amt claimed (J) or fee sched.
"RTN","FBAACO3",123,0)
 . S FBAMTPD=$S(FBFSAMT'>0:J,FBFSAMT>J:J,1:FBFSAMT)
"RTN","FBAACO3",124,0)
 W !
"RTN","FBAACO3",125,0)
 Q
"RTN","FBAACO3",126,0)
CHKIT I X>FBAMTPD&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,"You must be a holder of the 'FBAASUPERVISOR' security key in order to",!,"exceed the Fee Schedule.",! S $P(^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI,0),"^",3)=K,Y=2 Q
"RTN","FBAACO3",127,0)
 Q
"RTN","FBAACO3",128,0)
NOGO W !!,*7,"This payment CANNOT be edited.  The batch the payment is in",!,"has been Vouchered.  You may void the payment with the Void Payment option.",!
"RTN","FBAACO3",129,0)
 Q
"RTN","FBAACO3",130,0)
 ;
"RTN","FBAACO3",131,0)
SC W *7,!?4,"Suspense code is required!",! S Y="@4" Q
"RTN","FBAACO3",132,0)
 ;
"RTN","FBAACO3",133,0)
DEL ;delete date of service if no service provided entered
"RTN","FBAACO3",134,0)
 I '$O(^FBAAC(DFN,1,FBV,1,FBSDI,1,0)) D
"RTN","FBAACO3",135,0)
 .S DIK="^FBAAC(DFN,1,FBV,1,",DA(2)=DFN,DA(1)=FBV,DA=FBSDI D ^DIK W !!?5,*7,"Incomplete payment entry deleted.",!
"RTN","FBAACO3",136,0)
 K DIK,DA Q
"RTN","FBAACP1")
0^7^B6699484^B6734409
"RTN","FBAACP1",1,0)
FBAACP1 ;AISC/CMR-C&P PAYMENT DRIVER ;7/17/2003
"RTN","FBAACP1",2,0)
 ;;3.5;FEE BASIS;**4,61,116**;JAN 30, 1995;Build 30
"RTN","FBAACP1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAACP1",4,0)
 ;
"RTN","FBAACP1",5,0)
FILE ;files sp multiple entry
"RTN","FBAACP1",6,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,",DA(3)=DFN,DA(2)=FBV,DA(1)=FBSDI,DA=FBAACPI
"RTN","FBAACP1",7,0)
 S TP="",DR="1///^S X=FBAAAMT;Q;2///^S X="_$S($G(FBDEN):0,1:FBAAAMT)_";I '$G(FBDEN) S Y=6;3//^S X=FBAAAMT;3.5///^S X=DT;@4;4;I X']"""" D SC^FBAACO3;S:X'=4 Y=6;22;6////^S X=DUZ;7////^S X=FBAABE"
"RTN","FBAACP1",8,0)
 S DR=DR_";8////^S X=BO;13///^S X=FBAAID;14///^S X=FBAAIN;15///^S X=FBPT;23////^S X=2;33///^S X=FBAAVID;16////^S X=FBPOV;17///^S X=FBTT;18///^S X=FBAAPTC;26////^S X=FBPSA"
"RTN","FBAACP1",9,0)
 S DR(1,162.03,1)="34///^S X=$G(FBAAMM1);28////^S X=FBHCFA(28);30///^S X=FBHCFA(30);31////^S X=FBHCFA(31);44///^S X=FBFSAMT;45////^S X=FBFSUSD;48///^S X=FBAARC;47///^S X=FBUNITS;S FBTST=1"
"RTN","FBAACP1",10,0)
 D LOCK^FBUCUTL("^FBAAC(",DFN,1)
"RTN","FBAACP1",11,0)
 D ^DIE
"RTN","FBAACP1",12,0)
 I $G(FBTST) D
"RTN","FBAACP1",13,0)
 . D FILERR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAACP1",14,0)
 L -^FBAAC(DFN)
"RTN","FBAACP1",15,0)
 I '$G(FBTST),$G(DA) S DIR(0)="YA",DIR("A")="Entering an '^' will delete "_$S($G(FBDEN):"denial",1:"payment")_".  Are you sure you want to delete? ",DIR("B")="No" D ^DIR K DIR G FILE:'$D(DIRUT)&('Y) D KILL^FBAACO2 Q
"RTN","FBAACP1",16,0)
 S FBINTOT=FBINTOT+FBAAAMT
"RTN","FBAACP1",17,0)
 ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAACP1",18,0)
 ;I FBAAAMT>0 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1
"RTN","FBAACP1",19,0)
 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1
"RTN","FBAACP1",20,0)
 W !,$S($G(FBDEN):"Denial",1:"Payment")," Data Entered for Patient"
"RTN","FBAACP1",21,0)
 K FBDEN,FBAAMM1,FBTST,DIE,DR,DA
"RTN","FBAACP1",22,0)
 Q
"RTN","FBAACP1",23,0)
 ;
"RTN","FBAACP1",24,0)
PAID ;called from fbaacp to reset fee schedule if user opts to edit
"RTN","FBAACP1",25,0)
 ;a service.  If fee schedule of new cpt_modifier=0 tell user
"RTN","FBAACP1",26,0)
 ;not allowed in this option and refer to edit payment option.
"RTN","FBAACP1",27,0)
 ;
"RTN","FBAAMP")
0^8^B64408896^B63835336
"RTN","FBAAMP",1,0)
FBAAMP ;AISC/CMR-MULTIPLE PAYMENT ENTRY ;9/29/2003
"RTN","FBAAMP",2,0)
 ;;3.5;FEE BASIS;**4,21,38,55,61,67,116**;JAN 30, 1995;Build 30
"RTN","FBAAMP",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAMP",4,0)
 S FBMP=1 ;multiple payment flag
"RTN","FBAAMP",5,0)
 G ^FBAACO
"RTN","FBAAMP",6,0)
1 ;return from FBAACO
"RTN","FBAAMP",7,0)
 D MMPPT^FBAACP G:$G(FBAAOUT) Q1
"RTN","FBAAMP",8,0)
 D MPDT I 'FBMPDT G Q1
"RTN","FBAAMP",9,0)
 K FBAAOUT W ! D CPTM^FBAALU(FBMPDT,DFN) I 'FBGOT G Q1
"RTN","FBAAMP",10,0)
 ; prompt revenue code
"RTN","FBAAMP",11,0)
 S FBAARC=$$ASKREVC^FBUTL5() I FBAARC="^" S FBAAOUT=1 G Q1
"RTN","FBAAMP",12,0)
 ; prompt units paid
"RTN","FBAAMP",13,0)
 S FBUNITS=$$ASKUNITS^FBUTL5() I FBUNITS="^" S FBAAOUT=1 G Q1
"RTN","FBAAMP",14,0)
 S FY=$E(DT,1,3)+1700+$S($E(DT,4,5)>9:1,1:0)
"RTN","FBAAMP",15,0)
 D ASKZIP^FBAAFS($G(FBV)) I $G(FBAAOUT)!($G(FBZIP)']"") G Q1
"RTN","FBAAMP",16,0)
 I $$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) D ASKTIME^FBAAFS I $G(FBAAOUT)!('$G(FBTIME)) G Q1
"RTN","FBAAMP",17,0)
 D HCFA^FBAAMP1 G Q1:$G(FBAAOUT)
"RTN","FBAAMP",18,0)
AMTCL S DIR(0)="162.03,1",DIR("A")="Amount Claimed:  $",DIR("?")="Enter the amount being claimed by the vendor" D ^DIR K DIR G Q:$D(DIRUT) S FBJ=+Y
"RTN","FBAAMP",19,0)
 W ! S DIR("A")="Is $"_FBJ_" correct for Amount Claimed",DIR("B")="Yes",DIR(0)="Y" D ^DIR K DIR G Q:$D(DIRUT),AMTCL:'Y
"RTN","FBAAMP",20,0)
RDAP D FEE G Q:$G(FBAAOUT) S FBK=FBAMTPD
"RTN","FBAAMP",21,0)
 W ! S DIR("A")="Is $"_FBK_" correct for Amount Paid",DIR("B")="Yes",DIR(0)="Y" D ^DIR K DIR G Q:$D(DIRUT),RDAP:'Y
"RTN","FBAAMP",22,0)
 S FBAAAS=0 K FBADJ I FBJ-FBK D SUSP^FBAAMP1 I $G(FBAAOUT) G Q:$D(DUOUT),Q1
"RTN","FBAAMP",23,0)
 S FBJ=+FBJ,FBK=+FBK,FBAAAS=+FBAAAS
"RTN","FBAAMP",24,0)
 ; prompt for remittance remarks
"RTN","FBAAMP",25,0)
 I $$RR^FBUTL4(.FBRRMK,2)=0 S FBAAOUT=1 G Q1
"RTN","FBAAMP",26,0)
MULT W:FBINTOT>0 !,"Invoice: "_FBAAIN_" Totals: $ "_FBINTOT
"RTN","FBAAMP",27,0)
 W !! S %DT("A")="Date of Service: ",%DT="AEPX" D ^%DT G Q1:X=""!(X="^")
"RTN","FBAAMP",28,0)
 D DATCK^FBAAUTL G MULT:'$D(X)!(Y<0)
"RTN","FBAAMP",29,0)
 S FBDT=Y
"RTN","FBAAMP",30,0)
 I '$$CHKCPT() W !,$C(7),"Invalid Date of Service." G MULT
"RTN","FBAAMP",31,0)
 I $$CHKICD9^FBCSV1(+$G(FBHCFA(28)),$G(FBDT))="" G MULT
"RTN","FBAAMP",32,0)
 I '$G(FBAAMM1),'$$CHKFS() W !,$C(7),"Invalid Date of Service." G MULT
"RTN","FBAAMP",33,0)
 S DIR(0)="Y",DIR("A")="Is "_($$DATX^FBAAUTL(FBDT))_" correct",DIR("B")="Yes" D ^DIR K DIR G MULT:$D(DIRUT)!('Y)
"RTN","FBAAMP",34,0)
 S FBAADT=FBDT
"RTN","FBAAMP",35,0)
 S FBMODL=$$MODL^FBAAUTL4("FBMODA","I")
"RTN","FBAAMP",36,0)
 I $D(^FBAAC("AE",DFN,FBV,FBAADT,FBAACP_$S($G(FBMODL)]"":"-"_FBMODL,1:""))) S DIR(0)="Y",DIR("A")="Code already exists for that date!  Want to add another service for the SAME DATE",DIR("B")="No" D ^DIR K DIR G MULT:$D(DIRUT)!('Y)
"RTN","FBAAMP",37,0)
 I FBFPPSC]"" S FBFPPSL=$$FPPSL^FBUTL5() I FBFPPSL=-1 G Q1
"RTN","FBAAMP",38,0)
 W !! D GETSVDT^FBAACO5(DFN,FBV,FBASSOC,0,FBAADT) G Q:$G(FBAAOUT)
"RTN","FBAAMP",39,0)
 D SETO^FBAACO3,SVCPR^FBAACO1 G Q:$G(FBAAOUT)
"RTN","FBAAMP",40,0)
FILE S TP="",DR="1///^S X=FBJ;Q;2///^S X=FBK;47///^S X=FBUNITS"
"RTN","FBAAMP",41,0)
 I FBCSID]"" S DR=DR_";49///^S X=FBCSID"
"RTN","FBAAMP",42,0)
 I FBFPPSC]"" S DR=DR_";50///^S X=FBFPPSC;51///^S X=FBFPPSL"
"RTN","FBAAMP",43,0)
 I FBAARC]"" S DR=DR_";48////^S X=FBAARC"
"RTN","FBAAMP",44,0)
 ;S DR=DR_$S(FBJ-FBK:";3///^S X=FBAAAS;3.5////^S X=DT;4////^S X=FBAASC;D DESC^FBAAMP1",1:"")
"RTN","FBAAMP",45,0)
 S DR(1,162.03,1)="6////^S X=DUZ;7////^S X=FBAABE;8////^S X=BO;13///^S X=FBAAID;14///^S X=FBAAIN;15///^S X=FBPT;16////^S X=FBPOV;17///^S X=FBTT;18///^S X=FBAAPTC;23////^S X=2;26////^S X=FBPSA"
"RTN","FBAAMP",46,0)
 S DR(1,162.03,2)="34///^S X=$G(FBAAMM1);28////^S X=FBHCFA(28);30////^S X=FBHCFA(30);31////^S X=FBHCFA(31);32////^S X=FBHCFA(32);33///^S X=FBAAVID;44///^S X=FBFSAMT;45////^S X=FBFSUSD"
"RTN","FBAAMP",47,0)
 S DIE="^FBAAC("_DFN_",1,"_FBV_",1,"_FBSDI_",1,"
"RTN","FBAAMP",48,0)
 S DA=FBAACPI,DA(1)=FBSDI,DA(2)=FBV,DA(3)=DFN
"RTN","FBAAMP",49,0)
 D LOCK^FBUCUTL(DIE,FBAACPI,1)
"RTN","FBAAMP",50,0)
 D ^DIE
"RTN","FBAAMP",51,0)
 D FILEADJ^FBAAFA(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBADJ)
"RTN","FBAAMP",52,0)
 D FILERR^FBAAFR(FBAACPI_","_FBSDI_","_FBV_","_DFN_",",.FBRRMK)
"RTN","FBAAMP",53,0)
 L -^FBAAC(DFN,1,FBV,1,FBSDI,1,FBAACPI)
"RTN","FBAAMP",54,0)
 S FBINTOT=FBINTOT+FBK
"RTN","FBAAMP",55,0)
 W " ....OK, DONE...."
"RTN","FBAAMP",56,0)
 ; HIPAA 5010 - count line items that have 0.00 amount paid
"RTN","FBAAMP",57,0)
 ;I FBK>0 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1
"RTN","FBAAMP",58,0)
 S Z1=$P(^FBAA(161.7,FBAABE,0),"^",11)+1,$P(^(0),"^",11)=Z1
"RTN","FBAAMP",59,0)
 W:Z1>(FBAAMPI-20) !,*7,"Warning, you can only enter ",(FBAAMPI-Z1)," more line items!" I Z1>(FBAAMPI-1) D  S FBMAX=1 G Q1
"RTN","FBAAMP",60,0)
 .W !!,*7,"You have reached the maximum number of payments for a Batch!",!,"You must select another Batch for entering Payments!"
"RTN","FBAAMP",61,0)
 G MULT
"RTN","FBAAMP",62,0)
Q1 K FBADJ,FBAADT,FBX,FBAACP,DIC,DIE,X,Y,DIRUT,DUOUT,DTOUT,FBOUT,FBSI,FBMPDT G ^FBAACO:$D(FBMAX),1^FBAACO
"RTN","FBAAMP",63,0)
 ;
"RTN","FBAAMP",64,0)
Q ;kill variables and exit
"RTN","FBAAMP",65,0)
 D Q^FBAACO
"RTN","FBAAMP",66,0)
 Q
"RTN","FBAAMP",67,0)
 ;
"RTN","FBAAMP",68,0)
MPDT ;
"RTN","FBAAMP",69,0)
 S FBMPDT=""
"RTN","FBAAMP",70,0)
 S DIR(0)="D^::EX"
"RTN","FBAAMP",71,0)
 S DIR("A")="Enter date to use for CPT/ICD checks and fee schedule calc"
"RTN","FBAAMP",72,0)
 S DIR("B")="TODAY"
"RTN","FBAAMP",73,0)
 S DIR("?",1)="Enter a date. This date will be used when checking for"
"RTN","FBAAMP",74,0)
 S DIR("?",2)="an active CPT/Modifier/ICD code. Also, the fee schedule"
"RTN","FBAAMP",75,0)
 S DIR("?",3)="amount will be computed based on this date."
"RTN","FBAAMP",76,0)
 S DIR("?")="Enter '^' to exit."
"RTN","FBAAMP",77,0)
 W !
"RTN","FBAAMP",78,0)
 D ^DIR K DIR S:'$D(DIRUT) FBMPDT=Y
"RTN","FBAAMP",79,0)
 Q
"RTN","FBAAMP",80,0)
 ;
"RTN","FBAAMP",81,0)
FEE N FBX,FB1725
"RTN","FBAAMP",82,0)
 ; set FB1725 flag = true if payment for a 38 U.S.C. 1725 claim
"RTN","FBAAMP",83,0)
 S FB1725=$S($G(FB583):+$P($G(^FB583(+FB583,0)),U,28),1:0)
"RTN","FBAAMP",84,0)
 S FBFY=FY-1
"RTN","FBAAMP",85,0)
 S (FBFSAMT,FBFSUSD,FBAMFS)=""
"RTN","FBAAMP",86,0)
 S FBX=$$GET^FBAAFS($$CPT^FBAAUTL4(FBAACP),$$MODL^FBAAUTL4("FBMODA","E"),FBMPDT,$G(FBZIP),$$FAC^FBAAFS($G(FBHCFA(30))),$G(FBTIME))
"RTN","FBAAMP",87,0)
 ;
"RTN","FBAAMP",88,0)
 I '$G(FBAAMM1) D
"RTN","FBAAMP",89,0)
 . S FBFSAMT=$P(FBX,U),FBFSUSD=$P(FBX,U,2)
"RTN","FBAAMP",90,0)
 E  D
"RTN","FBAAMP",91,0)
 . W !,?2,"Payment is for a contracted service so fee schedule does not apply."
"RTN","FBAAMP",92,0)
 ;
"RTN","FBAAMP",93,0)
 I $P($G(FBX),U)]"" D
"RTN","FBAAMP",94,0)
 . W !?2,$S($G(FBAAMM1):"However, f",1:"F")
"RTN","FBAAMP",95,0)
 . W "ee schedule amount is $",$P(FBX,U)," from the "
"RTN","FBAAMP",96,0)
 . W:$P(FBX,U,3)]"" $P(FBX,U,3)," " ; year if returned
"RTN","FBAAMP",97,0)
 . W:$P(FBX,U,2)]"" $$EXTERNAL^DILFD(162.03,45,"",$P(FBX,U,2))
"RTN","FBAAMP",98,0)
 E  W !?2,"Unable to determine a FEE schedule amount."
"RTN","FBAAMP",99,0)
 ;
"RTN","FBAAMP",100,0)
 I FB1725 D
"RTN","FBAAMP",101,0)
 . W !!?2,"**Payment is for emergency treatment under 38 U.S.C. 1725."
"RTN","FBAAMP",102,0)
 . I FBFSAMT D
"RTN","FBAAMP",103,0)
 . . S FBFSAMT=$J(FBFSAMT*.7,0,2)
"RTN","FBAAMP",104,0)
 . . W !?2,"  Therefore, fee schedule amount reduced to $",FBFSAMT," (70%)."
"RTN","FBAAMP",105,0)
 ;
"RTN","FBAAMP",106,0)
 I $G(FBUNITS)>1 D
"RTN","FBAAMP",107,0)
 . W !!?2,"Units Paid = ",FBUNITS
"RTN","FBAAMP",108,0)
 . Q:FBFSAMT'>0
"RTN","FBAAMP",109,0)
 . N FBFSUNIT
"RTN","FBAAMP",110,0)
 . ; determine if fee schedule can be multipled by units
"RTN","FBAAMP",111,0)
 . S FBFSUNIT=$S(FBFSUSD="R":1,FBFSUSD="F"&(FBMPDT>3040930):1,1:0)
"RTN","FBAAMP",112,0)
 . I FBFSUNIT D
"RTN","FBAAMP",113,0)
 . . S FBFSAMT=$J(FBFSAMT*FBUNITS,0,2)
"RTN","FBAAMP",114,0)
 . . W !?2,"  Therefore, fee schedule amount increased to $",FBFSAMT
"RTN","FBAAMP",115,0)
 . E  D
"RTN","FBAAMP",116,0)
 . . W !?2,"  Fee schedule not complied on per unit basis so amount not adjusted by units."
"RTN","FBAAMP",117,0)
 ;
"RTN","FBAAMP",118,0)
 I '$G(FBAAMM1) D
"RTN","FBAAMP",119,0)
 . ; set default amount paid to lesser of amt claimed (J) or fee sched.
"RTN","FBAAMP",120,0)
 . S FBAMFS=$S(FBFSAMT>$G(FBJ):$G(FBJ),1:FBFSAMT)
"RTN","FBAAMP",121,0)
 ;
"RTN","FBAAMP",122,0)
 W !
"RTN","FBAAMP",123,0)
 ;
"RTN","FBAAMP",124,0)
AMTPD S DIR(0)="162.5,9",DIR("A")="Amount Paid: $",DIR("B")=$G(FBAMFS),DIR("?")="^D HELP1^FBAAMP" K:$G(FBAMFS)="" DIR("B") D ^DIR K DIR I $D(DIRUT) S FBAAOUT=1 Q
"RTN","FBAAMP",125,0)
 I +Y>FBJ W !!,*7,"Amount paid cannot be greater than the amount claimed." G AMTPD
"RTN","FBAAMP",126,0)
 I FBAMFS]"" I +Y>FBAMFS&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"You must be a holder of the 'FBAASUPERVISOR' key in order to",!,"exceed the Fee Schedule.",! G AMTPD
"RTN","FBAAMP",127,0)
 S FBAMTPD=+Y K FBAMFS Q
"RTN","FBAAMP",128,0)
HELP1 W !!,"Enter a dollar amount that does not exceed the amount claimed.",!
"RTN","FBAAMP",129,0)
 I FBAMFS>0 W "Only the holder of the 'FBAASUPERVISOR' key may exceed the",!,"Fee Schedule.",!
"RTN","FBAAMP",130,0)
 Q
"RTN","FBAAMP",131,0)
 ;
"RTN","FBAAMP",132,0)
CHKCPT() ; check if CPT/Modifer active on date of service
"RTN","FBAAMP",133,0)
 N FBCPTX,FBI,FBMOD,FBMODX,FBRET
"RTN","FBAAMP",134,0)
 S FBRET=1
"RTN","FBAAMP",135,0)
 S FBCPTX=$$CPT^ICPTCOD(FBAACP,FBDT,1)
"RTN","FBAAMP",136,0)
 I '$P(FBCPTX,U,7) S FBRET=0 W !,"  CPT Code ",$P(FBCPTX,U,2)," inactive on date of service."
"RTN","FBAAMP",137,0)
 I $O(FBMODA(0)) D
"RTN","FBAAMP",138,0)
 . S FBI=0 F  S FBI=$O(FBMODA(FBI)) Q:'FBI  D
"RTN","FBAAMP",139,0)
 . . S FBMODX=$$MOD^ICPTMOD(FBMODA(FBI),"I",FBDT,1)
"RTN","FBAAMP",140,0)
 . . I '$P(FBMODX,U,7) S FBRET=0 W !,"  CPT Modifier ",$P(FBMODX,U,2)," inactive on date of service."
"RTN","FBAAMP",141,0)
 Q FBRET
"RTN","FBAAMP",142,0)
 ;
"RTN","FBAAMP",143,0)
CHKFS() ; check if fee schedule amount is different on date of service
"RTN","FBAAMP",144,0)
 N FBX,FBRET,FB1725
"RTN","FBAAMP",145,0)
 S FBRET=1 ; return value - true if date of service allowed
"RTN","FBAAMP",146,0)
 ; set FB1725 flag = true if payment for a 38 U.S.C. 1725 claim
"RTN","FBAAMP",147,0)
 S FB1725=$S($G(FB583):+$P($G(^FB583(+FB583,0)),U,28),1:0)
"RTN","FBAAMP",148,0)
 S FBX=$$GET^FBAAFS($$CPT^FBAAUTL4(FBAACP),$$MODL^FBAAUTL4("FBMODA","E"),FBDT,$G(FBZIP),$$FAC^FBAAFS($G(FBHCFA(30))),$G(FBTIME))
"RTN","FBAAMP",149,0)
 ; set FB1725 flag = true if payment for a 38 U.S.C. 1725 claim
"RTN","FBAAMP",150,0)
 S FB1725=$S($G(FB583):+$P($G(^FB583(+FB583,0)),U,28),1:0)
"RTN","FBAAMP",151,0)
 ; adjust amount if mill bill
"RTN","FBAAMP",152,0)
 I FB1725 S $P(FBX,U)=$J($P(FBX,U)*.7,0,2)
"RTN","FBAAMP",153,0)
 ; adjust amount if units > 1
"RTN","FBAAMP",154,0)
 I $G(FBUNITS) D
"RTN","FBAAMP",155,0)
 . N FBFSUNIT
"RTN","FBAAMP",156,0)
 . ; determine if fee schedule can be multipled by units
"RTN","FBAAMP",157,0)
 . S FBFSUNIT=$S($P(FBX,U,2)="R":1,$P(FBX,U,2)="F"&(FBDT>3040930):1,1:0)
"RTN","FBAAMP",158,0)
 . I FBFSUNIT S $P(FBX,U)=$J($P(FBX,U)*FBUNITS,0,2)
"RTN","FBAAMP",159,0)
 ; issue warning if lesser of claim and fee schedule amount different
"RTN","FBAAMP",160,0)
 I +$S($P(FBX,U)>$G(FBJ):$G(FBJ),1:$P(FBX,U))'=+$S(FBFSAMT>$G(FBJ):$G(FBJ),1:FBFSAMT) D
"RTN","FBAAMP",161,0)
 . W !,"  Warning: The fee schedule amount (",$P(FBX,U),") for this date of service "
"RTN","FBAAMP",162,0)
 . W !,"  differs from the initial fee schedule amount (",FBFSAMT,")."
"RTN","FBAAMP",163,0)
 . I $P(FBX,U)>0,FBK>$P(FBX,U) D
"RTN","FBAAMP",164,0)
 . . W !,"  Amount paid (",FBK,") exceeds the fee schedule amount."
"RTN","FBAAMP",165,0)
 . . I '$D(^XUSEC("FBAASUPERVISOR",DUZ)) D
"RTN","FBAAMP",166,0)
 . . . W !,"  You must be a holder of the 'FBAASUPERVISOR' key in order"
"RTN","FBAAMP",167,0)
 . . . W !,"  to exceed the Fee Schedule."
"RTN","FBAAMP",168,0)
 . . . S FBRET=0
"RTN","FBAAMP",169,0)
 . W:FBRET !,"  You may want to separately process this date of service."
"RTN","FBAAMP",170,0)
 Q FBRET
"RTN","FBAAMP",171,0)
 ;
"RTN","FBAAMP",172,0)
ANCIL ;ENTRY POINT FOR mutiple ancillary payment option
"RTN","FBAAMP",173,0)
 S FBCHCO=1 D ^FBAAMP
"RTN","FBAAMP",174,0)
 K FBCHCO Q
"RTN","FBAAPET")
0^9^B33779075^B34367757
"RTN","FBAAPET",1,0)
FBAAPET ;AISC/DMK-EDIT PAYMENT ;7/13/2003
"RTN","FBAAPET",2,0)
 ;;3.5;FEE BASIS;**4,38,55,61,77,116**;JAN 30, 1995;Build 30
"RTN","FBAAPET",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAPET",4,0)
 S FBOT=1
"RTN","FBAAPET",5,0)
GETPT I $G(BAT) D
"RTN","FBAAPET",6,0)
 .I '$D(^FBAAC("AC",+BAT)) F I=9,10,11 S $P(^FBAA(161.7,+BAT,0),U,I)=""
"RTN","FBAAPET",7,0)
 .I $D(^FBAAC("AC",+BAT)) D  S $P(^FBAA(161.7,+BAT,0),U,11)=I,$P(^(0),U,9)=$G(FBTOT) K I,FBTOT
"RTN","FBAAPET",8,0)
 ..N J,K,L,M S (I,J,K,L,M,FBTOT)=0
"RTN","FBAAPET",9,0)
 ..F  S J=$O(^FBAAC("AC",+BAT,J)) Q:'J  F  S K=$O(^FBAAC("AC",+BAT,J,K)) Q:'K  F  S L=$O(^FBAAC("AC",+BAT,J,K,L)) Q:'L  F  S M=$O(^FBAAC("AC",+BAT,J,K,L,M)) Q:'M  I $D(^FBAAC(J,1,K,1,L,1,M,0)) S I=I+1,FBTOT=FBTOT+$P(^(0),U,3)
"RTN","FBAAPET",10,0)
 W !! S DIC="^FBAAC(",DIC(0)="AEQM" D ^DIC G END:X="^"!(X=""),GETPT:Y<0 S (DFN,FBDA(3))=+Y
"RTN","FBAAPET",11,0)
 S:'$D(^FBAAC(DFN,1,0)) ^FBAAC(DFN,1,0)="^162.01P^0^0"
"RTN","FBAAPET",12,0)
 S DIC=DIC_DFN_",1,"
"RTN","FBAAPET",13,0)
GETVD W !! S DIC(0)="AEQM" D ^DIC G GETPT:X="^"!(X=""),GETVD:Y<0 S (FBV,FBVD,FBDA(2))=+Y
"RTN","FBAAPET",14,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,0)) ^FBAAC(DFN,1,FBDA(2),1,0)="^162.02DA^0^0"
"RTN","FBAAPET",15,0)
 S DIC=DIC_FBVD_",1,"
"RTN","FBAAPET",16,0)
GETDT S DIC(0)="AEQM",DIC("A")="Date of Service: " D ^DIC K DIC("A") G GETPT:X="^"!(X=""),GETDT:Y<0 S (FBSD,FBSDI,FBDA(1))=+Y,FBAADT=$P(Y,U,2)
"RTN","FBAAPET",17,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)) ^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)="^162.03A^0^0"
"RTN","FBAAPET",18,0)
 S FBZ=DIC_FBSD_",1,"
"RTN","FBAAPET",19,0)
SERV S DA(3)=FBDA(3),DA(2)=FBDA(2),DA(1)=FBDA(1)
"RTN","FBAAPET",20,0)
 S DIC("W")="N FBX S FBX=$$MODL^FBAAUTL4(""^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,+Y,""""M"""")"",""E"") W:FBX]"""" ""    CPT Modifier(s): "",FBX Q"
"RTN","FBAAPET",21,0)
 S DIC=FBZ,DIC(0)="AEQMZ"
"RTN","FBAAPET",22,0)
 D
"RTN","FBAAPET",23,0)
 . N ICPTVDT S ICPTVDT=$G(FBAADT) D ^DIC
"RTN","FBAAPET",24,0)
 G GETPT:X="^"!(X=""),SERV:Y<0 S (FBSV,FBAACPI,FBDA)=+Y,BAT=$P(Y(0),U,8),FBDUZ=$P(Y(0),U,7),(FBAACP,FBAACP(0))=$P(Y,U,2),K=$P(Y(0),U,3),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBAAPET",25,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBAAPET",26,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBAAPET",27,0)
 I FBDUZ'=DUZ&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry,only the clerk who entered the payment ",!," or a supervisor can edit this payment." G GETPT
"RTN","FBAAPET",28,0)
 S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBAAPET",29,0)
 S FBFSAMT(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,12)
"RTN","FBAAPET",30,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBAAPET",31,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBAAPET",32,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_FBDA(3)_",1,"_FBDA(2)_",1,"_FBDA(1)_",1,"_FBDA_",""M"")")
"RTN","FBAAPET",33,0)
 ; load current adjustment data
"RTN","FBAAPET",34,0)
 D LOADADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBAAPET",35,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBAAPET",36,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBAAPET",37,0)
 ; load current remittance remark data
"RTN","FBAAPET",38,0)
 D LOADRR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBAAPET",39,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBAAPET",40,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBAAPET",41,0)
 ; save FPPS data prior to edit session
"RTN","FBAAPET",42,0)
 S FBFPPSC(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U)
"RTN","FBAAPET",43,0)
 S FBFPPSC=FBFPPSC(0)
"RTN","FBAAPET",44,0)
 S FBFPPSL(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,2)
"RTN","FBAAPET",45,0)
 S FBFPPSL=FBFPPSL(0)
"RTN","FBAAPET",46,0)
 G:BAT']"" EDIT
"RTN","FBAAPET",47,0)
 I $G(^FBAA(161.7,BAT,"ST"))]"",$P(^FBAA(161.7,BAT,"ST"),"^")="S"!($P(^FBAA(161.7,BAT,"ST"),"^")="T")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry, only the Supervisor can edit a payment once the batch has been released." G GETPT
"RTN","FBAAPET",48,0)
 I $G(^FBAA(161.7,BAT,"ST"))]"",$P(^FBAA(161.7,BAT,"ST"),"^")="V" W !!,*7,"Sorry,you cannot edit a payment once the batch has been Finalized." G GETPT
"RTN","FBAAPET",49,0)
EDIT S DA=FBSV
"RTN","FBAAPET",50,0)
 ;
"RTN","FBAAPET",51,0)
 ; first edit CPT code and modifiers
"RTN","FBAAPET",52,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) G GETPT
"RTN","FBAAPET",53,0)
 ; if CPT was changed then update file
"RTN","FBAAPET",54,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" G GETPT
"RTN","FBAAPET",55,0)
 . N FBIENS,FBFDA
"RTN","FBAAPET",56,0)
 . S FBIENS=FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_","
"RTN","FBAAPET",57,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBAAPET",58,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBAAPET",59,0)
 ; if modifiers changed then update file
"RTN","FBAAPET",60,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(FBDA(3),FBDA(2),FBDA(1),FBDA)
"RTN","FBAAPET",61,0)
 ;
"RTN","FBAAPET",62,0)
 ; now edit remaining fields
"RTN","FBAAPET",63,0)
 S DIE("NO^")=""
"RTN","FBAAPET",64,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBAAPET",65,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only; 
"RTN","FBAAPET",66,0)
 ;S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1);34///@;34////^S X=FBAAMM1;30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAAPET",67,0)
 S DR(1,162.03,1)="30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBAAPET",68,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBAAPET",69,0)
 ;S DR(1,162.03,3)="3////^S X=$S(J-K:J-K,1:"""");I X S Y=""@11"";4////@;S Y=""@5"";@11;3R;4R;S:X'=4 Y=""@5"";22"
"RTN","FBAAPET",70,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBAAPET",71,0)
 S DR(1,162.03,4)="S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="""" Y=""@5"";50///^S X=FBX;S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL);S:FBX=-1 Y=0;51///^S X=FBX;S FBFPPCL=X;S Y=""@55"";@5;50///@;S FBFPPSC="""";51///@;S FBFPPSL="""";@55"
"RTN","FBAAPET",72,0)
 S DR(1,162.03,5)="K DIE(""NO^"");W !,""Exit ('^') allowed now"";26;S PRC(""SITE"")=X;8;13;Q;33;49"
"RTN","FBAAPET",73,0)
 S DR(1,162.03,6)="15;17;16;S:X=1 Y=""@1"";@6;28R;S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@6"";31;32R;S Y=""@7"";@1;28;I X]"""" S:$$INPICD9^FBCSV1(X,"""",$G(FBAADT)) Y=""@1"";31"
"RTN","FBAAPET",74,0)
 S DR(1,162.03,7)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBAAPET",75,0)
 S DIE=FBZ
"RTN","FBAAPET",76,0)
 D
"RTN","FBAAPET",77,0)
 . N ICPTVDT,ICDVDT S (ICPTVDT,ICDVDT)=$G(FBAADT) D ^DIE
"RTN","FBAAPET",78,0)
 ; if adjustment data changed then file
"RTN","FBAAPET",79,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBAAPET",80,0)
 ; if remit remark data changed then file
"RTN","FBAAPET",81,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBAAPET",82,0)
 ; if FPPS CLAIM ID changed, update other line items on invoice
"RTN","FBAAPET",83,0)
 I FBFPPSC'=FBFPPSC(0) D
"RTN","FBAAPET",84,0)
 . N FBAAIN
"RTN","FBAAPET",85,0)
 . S FBAAIN=$$GET1^DIQ(162.03,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",14)
"RTN","FBAAPET",86,0)
 . D CKINVEDI^FBAAPET1(FBFPPSC(0),FBFPPSC,FBAAIN,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",")
"RTN","FBAAPET",87,0)
 K FBSV W !! G SERV
"RTN","FBAAPET",88,0)
END K DR,DIC,DIE,X,DFN,FBOT,FBVD,FBSD,BAT,FBAADT,FBSV,DA,FBDA,FBZ,FBDUZ,FBAACP,FBFY,FY,FBAMTPD,J,K,Y,ZZ,PRC,FBHOLDX,FBV,FBSDI,FBAACPI
"RTN","FBAAPET",89,0)
 K FBFSAMT,FBFSUSD,FBMODA,FBZIP,FBTIME,FBHCFA(30),FBAAPTC,FB1725,FBADJ,FBADJD,FBADJL(0),FBRRMK,FBRRMKD,FBRRMKL(0),FBX,FBUNITS
"RTN","FBAAPET",90,0)
 Q
"RTN","FBAAPIP")
0^10^B14820302^B13867541
"RTN","FBAAPIP",1,0)
FBAAPIP ;AISC/GRR-ESTABLISH BATCH FOR INVOICE AND CLOSE-OUT ; 11/22/10 10:28am
"RTN","FBAAPIP",2,0)
 ;;3.5;FEE BASIS;**116**;JAN 30, 1995;Build 30
"RTN","FBAAPIP",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAPIP",4,0)
 D DT^DICRW S FBSW=1
"RTN","FBAAPIP",5,0)
RD1 W !! S DIC="^FBAA(162.1,",DIC(0)="AEQM",DIC("S")="I $P(^(0),U,5)=3" D ^DIC K DIC G Q:X="^"!(X=""),RD1:Y<0 S (DA,IN,FBIN)=+Y,FBINTOT=0 D CALC^FBAAPIE1,WRT,EN1 G RD1
"RTN","FBAAPIP",6,0)
EN1 ;ENTRY FROM THE MAS CLOSE-OUT OPTION (FBAACIE)
"RTN","FBAAPIP",7,0)
 ;FB*3.5*116 - check for $0 invoice and stop close-out
"RTN","FBAAPIP",8,0)
 I +FBINTOT=0 W !!,*7,"Invoice must be greater than 0.00. Invoice cannot be closed out." Q
"RTN","FBAAPIP",9,0)
 ; end of changes
"RTN","FBAAPIP",10,0)
 S FY=$E(DT,1,3)+1700+$S($E(DT,4,5)>9:1,1:0)
"RTN","FBAAPIP",11,0)
 S FBAAMPI=$S($D(^FBAA(161.4,1,"FBNUM")):$P(^("FBNUM"),"^",3),1:100),FBAAMPI=$S(FBAAMPI]"":FBAAMPI,1:100),FBSW=1
"RTN","FBAAPIP",12,0)
 D BT Q:'$D(FBBN)  D WAIT^DICD S (TIC,TAC,TAP,FBSW,FBAATPV)=0 D GO Q
"RTN","FBAAPIP",13,0)
BT W !! S DIC="^FBAA(161.7,",DIC(0)="AEQM",DIC("A")="Select Batch for this Invoice: ",DIC("S")="I $P(^(0),U,3)=""B5""&($G(^(""ST""))=""O"")"
"RTN","FBAAPIP",14,0)
 S DIC("W")="W !,""  Obligation #: "",$P(^(0),U,2)" D ^DIC K DIC G Q:X="^"!(X=""),BT:Y<0 S (DA,FBBN)=+Y
"RTN","FBAAPIP",15,0)
 I $P(Y,"^",3)'=1 G NOTYOU:$P(^FBAA(161.7,DA,0),"^",5)'=DUZ,NOTPH:$P(^(0),"^",3)'="B5",NOTOP:$P(^("ST"),"^",1)'="O"
"RTN","FBAAPIP",16,0)
 S Z(0)=^FBAA(161.7,DA,0),FBAABO=$P(Z(0),"^",2),FBBTA=$P(Z(0),"^",9),FBBIC=$P(Z(0),"^",10)+1,FBBLC=$P(Z(0),"^",11)
"RTN","FBAAPIP",17,0)
 G:FBBLC>(FBAAMPI-1) WARN
"RTN","FBAAPIP",18,0)
 Q
"RTN","FBAAPIP",19,0)
GO ; HIPAA 5010 - count line items that have 0.00 amount paid 
"RTN","FBAAPIP",20,0)
 ;S FBAAVIN=$P(^FBAA(162.1,FBIN,0),"^",4) F FBJ=0:0 S FBJ=$O(^FBAA(162.1,FBIN,"RX",FBJ)) Q:FBJ'>0  S Y(0)=^FBAA(162.1,FBIN,"RX",FBJ,0) D:$P(Y(0),"^",16)>0 GOT
"RTN","FBAAPIP",21,0)
 S FBAAVIN=$P(^FBAA(162.1,FBIN,0),"^",4) F FBJ=0:0 S FBJ=$O(^FBAA(162.1,FBIN,"RX",FBJ)) Q:FBJ'>0  S Y(0)=^FBAA(162.1,FBIN,"RX",FBJ,0) D GOT
"RTN","FBAAPIP",22,0)
 D RSET W !!,"Invoice Closed out!!" S FBSW=1
"RTN","FBAAPIP",23,0)
Q Q:'FBSW  K J,FBAABO,FBBN,FBIN,TAC,TAP,TIC,DIC,D0,DA,DI,DIE,DQ,DR,IN,FBINTOT,FBAAMPI,FBAATPV,FBAAVIN,FBBIC,FBBLC,FBBTA,FBJ,FY,FBZZ,X,Y,Z,FBSTN Q
"RTN","FBAAPIP",24,0)
GOT S TAC=TAC+$P(Y(0),"^",4),TAP=TAP+$P(Y(0),"^",16),TIC=TIC+1,FBBLC=FBBLC+1,FBSW=0 I $P(Y(0),"^",20)'="R" S FBAATPV=FBAATPV+$P(Y(0),"^",16)
"RTN","FBAAPIP",25,0)
 S DIC="^FBAA(162.1,"_FBIN_",""RX"",",DA=FBJ,DA(1)=FBIN,DIE=DIC,DR="13////^S X=FBBN;14////^S X=FBAABO;15////^S X=DT;8////^S X=4"
"RTN","FBAAPIP",26,0)
 D ^DIE
"RTN","FBAAPIP",27,0)
 I FBBLC>(FBAAMPI-1) D FULL
"RTN","FBAAPIP",28,0)
 Q
"RTN","FBAAPIP",29,0)
RSET S DIC="^FBAA(162.1,",DA=FBIN,DIE=DIC,DR="5////^S X=4;6///^S X=TAC;7///^S X=TAP;8///^S X=TIC" D ^DIE
"RTN","FBAAPIP",30,0)
RSET2 S FBBTA=FBBTA+TAP,$P(Z(0),"^",9)=FBBTA,$P(Z(0),"^",10)=FBBIC,$P(Z(0),"^",11)=FBBLC,^FBAA(161.7,FBBN,0)=Z(0)
"RTN","FBAAPIP",31,0)
 Q
"RTN","FBAAPIP",32,0)
NOTYOU W !!,*7,"Batch selected established by another user, choose another." G BT
"RTN","FBAAPIP",33,0)
NOTPH W !!,*7,"Batch selected is NOT a Pharmacy type batch, choose another." G BT
"RTN","FBAAPIP",34,0)
NOTOP W !!,*7,"Batch selected not in Open status, choose another." G BT
"RTN","FBAAPIP",35,0)
FULL D RSET2 W !!,*7,"Batch has reached maximum allowable payment entries!",!,"Now openning another batch for you.",! K FBBN
"RTN","FBAAPIP",36,0)
 D NEWBT G BT:'$D(FBBN)
"RTN","FBAAPIP",37,0)
 Q
"RTN","FBAAPIP",38,0)
WARN W !!,*7,"That Batch already has maximum allowable payment items!" K FBBN G BT
"RTN","FBAAPIP",39,0)
OUT Q
"RTN","FBAAPIP",40,0)
WRT W !,?20,"Invoice Totals: $ "_$J(FBINTOT,1,2) Q
"RTN","FBAAPIP",41,0)
NEWBT ;OPEN NEW BATCH IF NEEDED TO CLOSEOUT INVOICE
"RTN","FBAAPIP",42,0)
 S FBSTN=$P(Z(0),"^",8),FBAAOB=$P(Z(0),"^",2) W ! D GETNXB^FBAAUTL W !!,*7,"New Batch to closeout invoice is: ",FBBN
"RTN","FBAAPIP",43,0)
 S DIC="^FBAA(161.7,",DLAYGO=161.7,X=FBBN,DIC(0)="LQ",DIC("DR")="1////^S X=FBAAOB;2////^S X=""B5"";3////^S X=DT;4////^S X=DUZ;11////^S X=""O"";16////^S X=FBSTN"
"RTN","FBAAPIP",44,0)
 K DD,DO D FILE^DICN K DLAYGO S FBBN=+Y,Z(0)=^FBAA(161.7,FBBN,0)
"RTN","FBAAPIP",45,0)
 S FBAAOB=$P(Z(0),"^",2),FBBTA=$P(Z(0),"^",9),FBBIC=$P(Z(0),"^",10)+1,FBBLC=$P(Z(0),"^",11)
"RTN","FBAAPIP",46,0)
 Q
"RTN","FBAASCB")
0^11^B23609721^B23905595
"RTN","FBAASCB",1,0)
FBAASCB ;AISC/GRR-SUPERVISOR RELEASE ; 11/24/10 11:07am
"RTN","FBAASCB",2,0)
 ;;3.5;FEE BASIS;**38,61,116**;JAN 30, 1995;Build 30
"RTN","FBAASCB",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAASCB",4,0)
 S FBERR=0 D DT^DICRW
"RTN","FBAASCB",5,0)
 I '$D(^FBAA(161.7,"AC","C"))&('$D(^FBAA(161.7,"AC","A"))) W !!,*7,"There are no batches Pending Release!" Q
"RTN","FBAASCB",6,0)
BT W !! S DIC="^FBAA(161.7,",DIC(0)="AEQ",DIC("S")="I ($G(^(""ST""))=""C""!($G(^(""ST""))=""A""))&('$G(^XTMP(""FBAASCB"",+Y)))" D ^DIC K DIC("S") G Q:X="^"!(X=""),BT:Y<0 S FBN=+Y,^XTMP("FBAASCB",FBN)=1
"RTN","FBAASCB",7,0)
 D LOCK^FBUCUTL("^FBAA(161.7,",FBN) I 'FBLOCK W !!,*7,"Try releasing batch at another time." D Q G FBAASCB
"RTN","FBAASCB",8,0)
 S FZ=^FBAA(161.7,FBN,0),FBTYPE=$P(FZ,"^",3),FBAAON=$P(FZ,"^",2),FBAAB=$P(FZ,"^")
"RTN","FBAASCB",9,0)
 I $G(FBTYPE)="B9",$P(FZ,"^",15)="Y",$P(^FBAA(161.7,FBN,"ST"),"^")="C",$P(FZ,"^",18)'="Y" W !!,*7,"Batch needs to be released to Pricer first.",! G Q
"RTN","FBAASCB",10,0)
 I $G(FBTYPE)="B9",$P(FZ,"^",15)="" S FBCNH=1
"RTN","FBAASCB",11,0)
 S FBSTAT=^FBAA(161.7,FBN,"ST"),FBSTAT=$S(FBSTAT="C":"S",FBSTAT="A":"R",1:FBSTAT)
"RTN","FBAASCB",12,0)
 S FBAAOB=$P(FZ,"^",8)_"-"_FBAAON,FBAAMT=$P(FZ,"^",9),FBCOMM="Release of batch "_FBAAB
"RTN","FBAASCB",13,0)
 I '$D(^XUSEC("FBAASUPERVISOR",DUZ)) W !!,*7,"Sorry, only Supervisor can Release batch!" D Q G FBAASCB
"RTN","FBAASCB",14,0)
 S DA=FBN,DR="0;ST" W !! D EN^DIQ
"RTN","FBAASCB",15,0)
RD S B=FBN S DIR(0)="Y",DIR("A")="Want line items listed",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT) W:Y @IOF D:Y LIST^FBAACCB:FBTYPE="B3",LISTP^FBAACCB:FBTYPE="B5",LISTT^FBAACCB0:FBTYPE="B2",LISTC^FBAACCB1:FBTYPE="B9"
"RTN","FBAASCB",16,0)
RDD S DIR(0)="Y",DIR("A")="Do you want to Release Batch as Correct",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT) I 'Y W !!,"Batch has NOT been Released!",*7 D Q G FBAASCB
"RTN","FBAASCB",17,0)
 D WAIT^DICD I FBTYPE="B9" D ^FBAASCB0 G SHORT:$D(FBERR),FIN
"RTN","FBAASCB",18,0)
 D POST I $D(FBERR) G SHORT
"RTN","FBAASCB",19,0)
 G:FBTYPE="B5" FIN
"RTN","FBAASCB",20,0)
 G:FBTYPE="B9" FIN
"RTN","FBAASCB",21,0)
FIN S $P(FZ,"^",6)=DT,$P(FZ,"^",7)=DUZ,^FBAA(161.7,FBN,0)=FZ
"RTN","FBAASCB",22,0)
 S DA=FBN,(DIC,DIE)="^FBAA(161.7,",DIC(0)="LQ",DR="11////"_FBSTAT,DLAYGO=161.7 D ^DIE K DA,DIE,DIC,DR,DLAYGO
"RTN","FBAASCB",23,0)
 D UCAUTOP
"RTN","FBAASCB",24,0)
 S DA=FBN,DR="0;ST",DIC="^FBAA(161.7," W !! D EN^DIQ W !!," Batch has been Released!"
"RTN","FBAASCB",25,0)
 D Q G FBAASCB
"RTN","FBAASCB",26,0)
Q I $G(FBN) K ^XTMP("FBAASCB",FBN) L -^FBAA(161.7,FBN)
"RTN","FBAASCB",27,0)
 K B,J,K,L,M,X,Y,Z,DIC,FBN,A,A1,A2,BE,CPTDESC,D0,DA,DL,DR,DRX,DX,FBAACB,FBAACPT,FBAAON,FBAAOUT,FBVP,FBIN,DK,N,XY,FBINOLD,FBINTOT,FBTYPE,FZ,P3,P4,Q,S,T,V,VID,ZS,FBAAB,FBAAMT,FBAAOB,FBCOMM,FBAUT,FBSITE,I,X,Y,Z,FBERR,DIRUT,FBSTAT,FBLOCK
"RTN","FBAASCB",28,0)
 K FBAC,FBAP,FBCNH,FBFD,FBI,FBLISTC,FBPDT,FBSC,FBTD,PRCSCPAN,DFN,FBINV
"RTN","FBAASCB",29,0)
 Q
"RTN","FBAASCB",30,0)
SHORT ;
"RTN","FBAASCB",31,0)
 I '$D(FBINV) W !!,*7,"This batch CANNOT be released. Check your 1358.",!
"RTN","FBAASCB",32,0)
 L -^FBAA(161.7,FBN) D Q G FBAASCB
"RTN","FBAASCB",33,0)
POST ;FBAAOB=FULL OBLIGATION NUMBER(STA-CXXXXX)
"RTN","FBAASCB",34,0)
 ;FBCOMM=COMMENT FOR 1358
"RTN","FBAASCB",35,0)
 ;FBAAMT=TOTAL AMOUNT OF BATCH
"RTN","FBAASCB",36,0)
 ;FBAAB=BATCH NUMBER
"RTN","FBAASCB",37,0)
 ;IF CALL FAILS FBERR RETURNED=1
"RTN","FBAASCB",38,0)
 ;FBN added as 7th peice of 'X'. It is the interface ID
"RTN","FBAASCB",39,0)
 K FBERR
"RTN","FBAASCB",40,0)
 S PRCS("X")=FBAAOB,PRCS("TYPE")="FB" D EN3^PRCS58 I Y=-1 W !!,*7,?5,"1358 not available for posting!",! S FBERR=1 Q
"RTN","FBAASCB",41,0)
 D NOW^%DTC S X=FBAAOB_"^"_%_"^^"_FBAAMT_"^"_$S($L(FBAAB)<3:$$PADZ^FBAAV01(FBAAB,4),1:FBAAB)_"^"_FBCOMM_"^"_FBN_"^"_1,PRCS("TYPE")="FB" D EN2^PRCS58 I +Y=0 W !!,*7,Y,! S FBERR=1 Q
"RTN","FBAASCB",42,0)
 K PRCS("SITE"),PRCSI Q
"RTN","FBAASCB",43,0)
UCAUTOP ; Unauthorized Claims Autoprint
"RTN","FBAASCB",44,0)
 ; If unauthorized claims autoprint feature is enabled then check items
"RTN","FBAASCB",45,0)
 ; in batch and print an unauthorized claim disposition letter if all
"RTN","FBAASCB",46,0)
 ; payments for a claim have been released
"RTN","FBAASCB",47,0)
 ; input FBN    - batch ien
"RTN","FBAASCB",48,0)
 ;       FBTYPE - batch type
"RTN","FBAASCB",49,0)
 ;       FBCNH  - (opt) equals 1 if batch is for community nursing home
"RTN","FBAASCB",50,0)
 N DA,FBDA,FBORDER,FBUC,FBUCA,FBX
"RTN","FBAASCB",51,0)
 Q:"^B3^B5^B9^"'[(U_FBTYPE_U)  ; not an applicable batch type
"RTN","FBAASCB",52,0)
 Q:$G(FBCNH)=1  ; CNH batch won't have associated unauth claims
"RTN","FBAASCB",53,0)
 S FBUC=$$FBUC^FBUCUTL2(1)
"RTN","FBAASCB",54,0)
 Q:'$$PARAM^FBUCLET(FBUC)  ; autoprint feature not enabled
"RTN","FBAASCB",55,0)
 ;
"RTN","FBAASCB",56,0)
 ; loop thru items in batch to build list of unauthorized claims
"RTN","FBAASCB",57,0)
 K ^TMP("FBUC",$J)
"RTN","FBAASCB",58,0)
 I FBTYPE="B3" D  ; if outpatient/ancillary batch
"RTN","FBAASCB",59,0)
 . S DA(3)=0 F  S DA(3)=$O(^FBAAC("AC",FBN,DA(3))) Q:'DA(3)  D
"RTN","FBAASCB",60,0)
 . . S DA(2)=0 F  S DA(2)=$O(^FBAAC("AC",FBN,DA(3),DA(2))) Q:'DA(2)  D
"RTN","FBAASCB",61,0)
 . . . S DA(1)=0
"RTN","FBAASCB",62,0)
 . . . F  S DA(1)=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1))) Q:'DA(1)  D
"RTN","FBAASCB",63,0)
 . . . . S DA=0
"RTN","FBAASCB",64,0)
 . . . . F  S DA=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1),DA)) Q:'DA  D
"RTN","FBAASCB",65,0)
 . . . . . S FBX=$P($G(^FBAAC(DA(3),1,DA(2),1,DA(1),1,DA,0)),U,13)
"RTN","FBAASCB",66,0)
 . . . . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",67,0)
 I FBTYPE="B5" D  ; if pharmacy batch
"RTN","FBAASCB",68,0)
 . S DA(1)=0 F  S DA(1)=$O(^FBAA(162.1,"AE",FBN,DA(1))) Q:'DA(1)  D
"RTN","FBAASCB",69,0)
 . . S DA=0 F  S DA=$O(^FBAA(162.1,"AE",FBN,DA(1),DA)) Q:'DA  D
"RTN","FBAASCB",70,0)
 . . . S FBX=$P($G(^FBAA(162.1,DA(1),"RX",DA,2)),U,6)
"RTN","FBAASCB",71,0)
 . . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",72,0)
 I FBTYPE="B9" D  ; if inpatient batch
"RTN","FBAASCB",73,0)
 . S DA=0 F  S DA=$O(^FBAAI("AC",FBN,DA)) Q:'DA  D
"RTN","FBAASCB",74,0)
 . . S FBX=$P($G(^FBAAI(DA,0)),U,5)
"RTN","FBAASCB",75,0)
 . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",76,0)
 ;
"RTN","FBAASCB",77,0)
 ; loop thru unauthorized claim list and print letter when appropriate
"RTN","FBAASCB",78,0)
 S FBDA=0 F  S FBDA=$O(^TMP("FBUC",$J,FBDA)) Q:'FBDA  D
"RTN","FBAASCB",79,0)
 . Q:'$$PAYST^FBUCUTL(FBDA)  ; not all payments for claim released yet
"RTN","FBAASCB",80,0)
 . S FBUCA=$G(^FB583(FBDA,0))
"RTN","FBAASCB",81,0)
 . Q:$P(FBUCA,U,16)'=1  ; claim not flagged for printing
"RTN","FBAASCB",82,0)
 . S FBORDER=$$ORDER^FBUCUTL($P(FBUCA,U,24))
"RTN","FBAASCB",83,0)
 . D AUTO^FBUCLET(FBDA,FBORDER,FBUCA,FBUC) ; autoprint letter
"RTN","FBAASCB",84,0)
 ;
"RTN","FBAASCB",85,0)
 K ^TMP("FBUC",$J)
"RTN","FBAASCB",86,0)
 Q
"RTN","FBAASCB",87,0)
 ;
"RTN","FBAASCB0")
0^12^B19526441^B16119152
"RTN","FBAASCB0",1,0)
FBAASCB0 ;AISC/DMK-POST 1358 FOR INPATIENT 7078'S ; 11/24/10 9:59am
"RTN","FBAASCB0",2,0)
 ;;3.5;FEE BASIS;**116**;JAN 30, 1995;Build 30
"RTN","FBAASCB0",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAASCB0",4,0)
 K FBERR,^TMP($J) S FBRJC=0,FBINTOT=$P(FZ,U,10)
"RTN","FBAASCB0",5,0)
 I '$O(^FBAAI("AC",FBN,0)) W !,*7,"No invoices found for this batch. Unable to release.",! S FBERR=1 Q
"RTN","FBAASCB0",6,0)
 ;
"RTN","FBAASCB0",7,0)
 S FBII=0 F  S FBII=$O(^FBAAI("AC",FBN,FBII)) Q:'FBII!($D(FBERR))  S FBII78=$P($G(^FBAAI(FBII,0)),"^",5),FBAAMT=$P($G(^(0)),"^",9),FBMM=$E($P(^(0),U,6),4,5) D GETAP,GET78:FBII78["FB7078(",POST^FBAASCB:FBII78["FB583("
"RTN","FBAASCB0",8,0)
 I $G(FBRJC),FBRJC=FBINTOT S FBERR=1 D KILL Q
"RTN","FBAASCB0",9,0)
 I $G(FBRJC) K FBERR S (FBRJC,FBII)=0 F  S FBII=$O(^TMP($J,FBII)) Q:'FBII  S X=$G(^FBAAI(FBII,0)),FBII78=$P(X,U,5),FBAAMT=$P(X,U,9),FBMM=$E($P(X,U,6),4,5) K X,^TMP($J,FBII) D GET78
"RTN","FBAASCB0",10,0)
 I $G(FBRJC) S (FBAAMT,FBINTOT)=0 D NEWBT S FBII=0 F  S FBII=$O(^TMP($J,FBII)) Q:'FBII  D
"RTN","FBAASCB0",11,0)
 .S DA=FBII,DIE="^FBAAI(",DR="20////^S X=FBBN" D ^DIE K DR,DA,DIE
"RTN","FBAASCB0",12,0)
 .S FBAAMT=FBAAMT+$P(^FBAAI(FBII,0),U,9),FBINTOT=FBINTOT+1
"RTN","FBAASCB0",13,0)
 D:$G(FBRJC) RESETBT
"RTN","FBAASCB0",14,0)
 ; FB*3.5*116  ; report zero dollar invoices
"RTN","FBAASCB0",15,0)
 I $D(FBINV) D
"RTN","FBAASCB0",16,0)
 . S FBII=0 F  S FBII=$O(FBINV(FBII)) Q:'FBII  W !!,"Invoice #: "_FBII_" totals $0.00"
"RTN","FBAASCB0",17,0)
 . W $C(7),!!?2,"Batch cannot be released when zero dollar invoices exist."
"RTN","FBAASCB0",18,0)
 . W !?2,"Invoices must be corrected or removed from the batch."
"RTN","FBAASCB0",19,0)
 . S FBERR=1
"RTN","FBAASCB0",20,0)
 Q
"RTN","FBAASCB0",21,0)
 ;
"RTN","FBAASCB0",22,0)
KILL K FBII,FBII78,FBAAMT,FBI78,FBMM,PRCSX,FBRJC,FBSTN,FBBN,FBINTOT,FBCNH,^TMP($J) Q
"RTN","FBAASCB0",23,0)
 ;
"RTN","FBAASCB0",24,0)
GET78 I '$D(^FB7078(+FBII78,0)) W !,*7,"No associated 7078 for invoice ",FBII,". Unable to release batch.",! S FBERR=1 Q
"RTN","FBAASCB0",25,0)
 S FBI78=$P(^FB7078(+FBII78,0),"^"),DFN=+$P(^(0),"^",3),FBI78=$P(FZ,"^",8)_"-"_$P(FBI78,".")_"-"_$P(FBI78,".",2) D
"RTN","FBAASCB0",26,0)
 . ;
"RTN","FBAASCB0",27,0)
 . ;I $D(FBCNH),'$D(^PRC(424,"E",DFN_";"_+FBII78_";"_FBAAON_";"_FBMM)) D POST^FBAASCB
"RTN","FBAASCB0",28,0)
 .D INPOST:$$INTER()
"RTN","FBAASCB0",29,0)
 .I $D(FBCNH),'$$INTER S FBERR=1 W !!,$$NAME^FBCHREQ2(DFN),"  ",$$SSN^FBAAUTL(DFN),!,*7,"Unable to locate reference number on 1358.  Run Post Commitments for",!,"Obligation option."
"RTN","FBAASCB0",30,0)
 .I $D(FBCNH),$D(FBERR) S ^TMP($J,+FBII)="",FBRJC=FBRJC+1 K FBERR
"RTN","FBAASCB0",31,0)
 Q
"RTN","FBAASCB0",32,0)
 ;
"RTN","FBAASCB0",33,0)
INPOST ;PRCSX=INTERNAL DAILY REF #^INTERNAL DATE/TIME^AMT OF PAYMENT^COMMENTS^COMPLETE FLAG
"RTN","FBAASCB0",34,0)
 ;FBI78=AUTHORIZATION NAME IN 424 (STA-CXXXXX-REF #)
"RTN","FBAASCB0",35,0)
 ;FBERR RETURNED IF IFCAP CALL FAILS
"RTN","FBAASCB0",36,0)
 ;FBCOMM=COMMENT
"RTN","FBAASCB0",37,0)
 ;FBAAMT=ACTUAL AMOUNT OF PAYMENT
"RTN","FBAASCB0",38,0)
 ;INTERFACE ID = DFN_";"_INTERNAL ENTRY NUMBER OF 7078_";"_FBAAON  (OBLIGATION)_";" if CNH _FBMM (month of service)
"RTN","FBAASCB0",39,0)
 ;INTERNAL DAILY REF # = $O(^PRC(424,"B","STA #-OBLIGATION #-REF #",0))
"RTN","FBAASCB0",40,0)
 ;NEW INTERNAL DAILY REF # LOOKUP=$O(^PRC(424,"E",INTERFACE ID,0))
"RTN","FBAASCB0",41,0)
 I '$$INTER() W !,*7,"Unable to locate reference number on 1358.",! S FBERR=1 Q
"RTN","FBAASCB0",42,0)
 S PRCS("X")=FBAAOB,PRCS("TYPE")="FB" D EN3^PRCS58 I Y=-1 W !!,*7,"1358 not available for posting!",! S FBERR=1 Q
"RTN","FBAASCB0",43,0)
 D NOW^%DTC
"RTN","FBAASCB0",44,0)
 S PRCSX=$$INTER()_"^"_%_"^"_FBAAMT_"^"_$S($D(FBCOMM):FBCOMM,1:"")_"^"_1
"RTN","FBAASCB0",45,0)
 D ^PRCS58CC I Y'=1 W !!,$$NAME^FBCHREQ2(DFN),"  (",$$SSN^FBAAUTL(DFN,1),")",!,*7,$P(Y,"^",2),! S FBERR=1 Q
"RTN","FBAASCB0",46,0)
 Q
"RTN","FBAASCB0",47,0)
 ;
"RTN","FBAASCB0",48,0)
INTER() ;get internal entry number from file 424
"RTN","FBAASCB0",49,0)
 ;first check for new INTERFACE ID "E" x-ref in 424
"RTN","FBAASCB0",50,0)
 ;2nd check is to "B" x-ref to stay backward compatible with IFCAP 3.6
"RTN","FBAASCB0",51,0)
 ;
"RTN","FBAASCB0",52,0)
 I '$D(FBCNH),$D(^PRC(424,"E",DFN_";"_+FBII78_";"_FBAAON)) Q $O(^(DFN_";"_+FBII78_";"_FBAAON,0))
"RTN","FBAASCB0",53,0)
 I $D(FBCNH),$D(^PRC(424,"E",DFN_";"_+FBII78_";"_FBAAON_";"_FBMM)) Q $O(^(DFN_";"_+FBII78_";"_FBAAON_";"_FBMM,0))
"RTN","FBAASCB0",54,0)
 I '$D(FBCNH),$D(^PRC(424,"B",FBI78)) Q $O(^(FBI78,0))
"RTN","FBAASCB0",55,0)
 Q 0
"RTN","FBAASCB0",56,0)
 ;
"RTN","FBAASCB0",57,0)
NEWBT ;open new batch for cnh line items unable to post to 1358
"RTN","FBAASCB0",58,0)
 S FBSTN=$P(FZ,U,8) W ! D GETNXB^FBAAUTL
"RTN","FBAASCB0",59,0)
 S DIC="^FBAA(161.7,",DIC(0)="LQ",X=FBBN,DIC("DR")="1////^S X=FBAAON;2////^S X=""B9"";3////^S X=DT;4////^S X=$P(FZ,U,5);11////^S X=""O"";16////^S X=FBSTN",DLAYGO=161.7
"RTN","FBAASCB0",60,0)
 K DD,DO D FILE^DICN S FBBN=+Y K DIC,DLAYGO
"RTN","FBAASCB0",61,0)
 Q
"RTN","FBAASCB0",62,0)
RESETBT ;reset original batch total $ set new batch totals
"RTN","FBAASCB0",63,0)
 S X=$G(^FBAA(161.7,FBBN,0)),$P(X,U,9)=FBAAMT,$P(X,U,10)=FBINTOT,$P(X,U,11)=FBINTOT,^(0)=X K X
"RTN","FBAASCB0",64,0)
 S $P(FZ,U,9)=$P(FZ,U,9)-FBAAMT,$P(FZ,U,10)=$P(FZ,U,10)-FBINTOT,$P(FZ,U,11)=$P(FZ,U,11)-FBINTOT,^FBAA(161.7,FBN,0)=FZ
"RTN","FBAASCB0",65,0)
 W !!,*7,"A new batch, number ",$P(^FBAA(161.7,FBBN,0),U),", was opened for invoices unable to post to 1358.",!,"Adjust 1358 and take action on new batch.",!
"RTN","FBAASCB0",66,0)
 Q
"RTN","FBAASCB0",67,0)
 ;
"RTN","FBAASCB0",68,0)
GETAP ; FB*3.5*116 build array of invoices in batch
"RTN","FBAASCB0",69,0)
 Q:$D(FBCNH)  ; do not build array if CNH batch
"RTN","FBAASCB0",70,0)
 Q:FBAAMT>0  ; do not place invoice reference in array if the amount paid is greater than 0.00
"RTN","FBAASCB0",71,0)
 S FBINV(FBII)=""
"RTN","FBAASCB0",72,0)
 Q
"RTN","FBAAV0")
0^13^B39796273^B39511584
"RTN","FBAAV0",1,0)
FBAAV0 ;AISC/GRR-ELECTRONICALLY TRANSMIT FEE DATA ;11 Apr 2006  2:51 PM
"RTN","FBAAV0",2,0)
 ;;3.5;FEE BASIS;**3,4,55,89,98,116**;JAN 30, 1995;Build 30
"RTN","FBAAV0",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAV0",4,0)
 K ^TMP($J,"FBAABATCH"),^TMP($J,"FBVADAT") D DT^DICRW
"RTN","FBAAV0",5,0)
 I '$D(^FBAA(161.7,"AC","S")),'$D(^FBAA(161.7,"AC","R")),'$D(^FBAA(161.25,"AE")),$S('$D(^FBAA(161.26,"AC","P")):1,$O(^FBAA(161.26,"AC","P",0))'>0:1,1:0) W !,*7,"There are no transactions requiring transmission",*7 Q
"RTN","FBAAV0",6,0)
 W !!,"This option will transmit all Batches and MRA's ready to be transmitted",!,"to Austin"
"RTN","FBAAV0",7,0)
RD W !! S DIR(0)="Y",DIR("A")="Are you sure you want to continue",DIR("B")="No" D ^DIR K DIR G END:'Y
"RTN","FBAAV0",8,0)
 L +^FBAA(161.7,"AC"):0 G:'$T LOCK^FBAAUTL1
"RTN","FBAAV0",9,0)
 W !!,"The following Batches will be transmitted: " F FBSTAT="S","R" F J=0:0 S J=$O(^FBAA(161.7,"AC",FBSTAT,J)) Q:J'>0  S FBATCH=$G(^FBAA(161.7,J,0)) D
"RTN","FBAAV0",10,0)
 .Q:'+FBATCH
"RTN","FBAAV0",11,0)
 .I (FBSTAT="S"&($P(FBATCH,U,15)="Y"))!(+$P(FBATCH,U,9)) S ^TMP($J,"FBAABATCH",J)="" W !,+FBATCH
"RTN","FBAAV0",12,0)
RTRAN ;Entry from Re-transmit MRA routine
"RTN","FBAAV0",13,0)
 D ADDRESS^FBAAV01 G END:VATERR K VAT
"RTN","FBAAV0",14,0)
 D WAIT^DICD,STATION^FBAAUTL,HD^FBAAUTL I $D(FB("ERROR")) G END
"RTN","FBAAV0",15,0)
 S TOTSTR=0,$P(PAD," ",200)=" "
"RTN","FBAAV0",16,0)
 D ^FBAAV1:$D(^FBAA(161.25,"AE"))
"RTN","FBAAV0",17,0)
 D ^FBAAV4:$D(^FBAA(161.26,"AC","P"))
"RTN","FBAAV0",18,0)
 F J=0:0 S J=$O(^TMP($J,"FBAABATCH",J)) Q:J'>0  I $D(^FBAA(161.7,J,0)) S Y(0)=^(0) D SET1,DET:FBAABT="B3",DETP^FBAAV2:FBAABT="B5",DETT^FBAAV3:FBAABT="B2",^FBAAV5:FBAABT="B9"
"RTN","FBAAV0",19,0)
END L -^FBAA(161.7,"AC") D KILL^FBAAV1 Q
"RTN","FBAAV0",20,0)
SET1 ; build the payment batch header string (used by all four formats)
"RTN","FBAAV0",21,0)
 S FBAABN=$P(Y(0),"^",1),FBAABN=$E("00000",$L(FBAABN)+1,5)_FBAABN
"RTN","FBAAV0",22,0)
 S FBAAON=$E($P(Y(0),"^",2),3,6)
"RTN","FBAAV0",23,0)
 S FBAACD=$$AUSDT^FBAAV3(DT)
"RTN","FBAAV0",24,0)
 S FBAACP=$E($P(Y(0),"^",2),1,2)
"RTN","FBAAV0",25,0)
 S FBAABT=$P(Y(0),"^",3)
"RTN","FBAAV0",26,0)
 S FBAAAP=$$AUSAMT^FBAAV3($P(Y(0),"^",9),10)
"RTN","FBAAV0",27,0)
 S FBSTAT=$P(^FBAA(161.7,J,"ST"),"^")
"RTN","FBAAV0",28,0)
 S FBCHB=$P(Y(0),"^",15)
"RTN","FBAAV0",29,0)
 S FBEXMPT=$P(Y(0),"^",18)
"RTN","FBAAV0",30,0)
 S X=$$SUB^FBAAUTL5(+$P(Y(0),U,8)_"-"_$P(Y(0),U,2))
"RTN","FBAAV0",31,0)
 S FBAASN=$$LJ^XLFSTR($S(X]"":X,1:FBAASN),6," ")
"RTN","FBAAV0",32,0)
 I FBSTAT="R"!(FBSTAT="S"&(FBCHB'["Y"))!(FBSTAT="S"&($G(FBEXMPT)="Y")) S FBSTR=FBHD_$S(FBAABT="B2":"BT",1:FBAABT)_FBAACD_FBAASN_FBAABN_"  "_FBAAAP_FBAACP_" $"
"RTN","FBAAV0",33,0)
 Q
"RTN","FBAAV0",34,0)
DET ;entry point to process B3 (outpatient/ancillary) batch
"RTN","FBAAV0",35,0)
 ; input (partial list)
"RTN","FBAAV0",36,0)
 ;   J      - Batch IEN in file 161.7
"RTN","FBAAV0",37,0)
 ;   FBAAON - last 4 of obligation number
"RTN","FBAAV0",38,0)
 ;   FBAASN - station number (formatted)
"RTN","FBAAV0",39,0)
 S FBTXT=0
"RTN","FBAAV0",40,0)
 D CKB3V^FBAAV01 I $G(FBERR) K FBERR Q
"RTN","FBAAV0",41,0)
 ; HIPAA 5010 - line items that have 0.00 amount paid are now required to go to Central Fee
"RTN","FBAAV0",42,0)
 ;F K=0:0 S K=$O(^FBAAC("AC",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AC",J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("AC",J,K,L,M)) Q:M'>0  F N=0:0 S N=$O(^FBAAC("AC",J,K,L,M,N)) Q:N'>0  S Y(0)=$G(^FBAAC(K,1,L,1,M,1,N,0)) I Y(0)]"",+$P(Y(0),U,3) D
"RTN","FBAAV0",43,0)
 F K=0:0 S K=$O(^FBAAC("AC",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AC",J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("AC",J,K,L,M)) Q:M'>0  F N=0:0 S N=$O(^FBAAC("AC",J,K,L,M,N)) Q:N'>0  S Y(0)=$G(^FBAAC(K,1,L,1,M,1,N,0)) I Y(0)]"" D
"RTN","FBAAV0",44,0)
 .N FBDTSR1,FBPICN
"RTN","FBAAV0",45,0)
 .S FBDTSR1=+$G(^FBAAC(K,1,L,1,M,0))
"RTN","FBAAV0",46,0)
 .S FBPICN=K_U_L_U_M_U_N
"RTN","FBAAV0",47,0)
 .S FBY=$G(^FBAAC(K,1,L,1,M,1,N,2))
"RTN","FBAAV0",48,0)
 .I 'FBTXT S FBTXT=1 D NEWMSG^FBAAV01,STORE^FBAAV01,UPD
"RTN","FBAAV0",49,0)
 .D GOT
"RTN","FBAAV0",50,0)
 ;
"RTN","FBAAV0",51,0)
 D:FBTXT XMIT^FBAAV01
"RTN","FBAAV0",52,0)
 Q
"RTN","FBAAV0",53,0)
 ;
"RTN","FBAAV0",54,0)
GOT ; process a B3 line item
"RTN","FBAAV0",55,0)
 ;
"RTN","FBAAV0",56,0)
 N DFN,FBADJ,FBADJA1,FBADJA2,FBADJR1,FBADJR2,FBADMIT,FBAUTHF,FBIENS
"RTN","FBAAV0",57,0)
 N FBMOD1,FBMOD2,FBMOD3,FBMOD4,FBPNAMX,FBUNITS,FBX,FBNPI
"RTN","FBAAV0",58,0)
 ;
"RTN","FBAAV0",59,0)
 S FBIENS=N_","_M_","_L_","_K_","
"RTN","FBAAV0",60,0)
 ;
"RTN","FBAAV0",61,0)
 ; get CPT modifiers
"RTN","FBAAV0",62,0)
 D
"RTN","FBAAV0",63,0)
 . N FBMODA,FBMODL
"RTN","FBAAV0",64,0)
 . D MODDATA^FBAAUTL4(K,L,M,N)
"RTN","FBAAV0",65,0)
 . S FBMODL=$$MODL^FBAAUTL4("FBMODA","E")
"RTN","FBAAV0",66,0)
 . S FBMOD1=$$RJ^XLFSTR($P(FBMODL,",",1),5," ")
"RTN","FBAAV0",67,0)
 . S FBMOD2=$$RJ^XLFSTR($P(FBMODL,",",2),5," ")
"RTN","FBAAV0",68,0)
 . S FBMOD3=$$RJ^XLFSTR($P(FBMODL,",",3),5," ")
"RTN","FBAAV0",69,0)
 . S FBMOD4=$$RJ^XLFSTR($P(FBMODL,",",4),5," ")
"RTN","FBAAV0",70,0)
 ;
"RTN","FBAAV0",71,0)
 S FBPAYT=$P(Y(0),"^",20),FBPAYT=$S(FBPAYT]"":FBPAYT,1:"V")
"RTN","FBAAV0",72,0)
 ;
"RTN","FBAAV0",73,0)
 S FBVID=$P($G(^FBAAV(L,0)),U,2)
"RTN","FBAAV0",74,0)
 S FBVID=FBVID_$E(PAD,$L(FBVID)+1,11)
"RTN","FBAAV0",75,0)
 S:FBPAYT="R" FBVID=$E(PAD,1,11)
"RTN","FBAAV0",76,0)
 S FBNPI=$$EN^FBNPILK(L)  ;SET THE NPI TO BE PASSED TO FBAAV01,FBAAV2,FBAAV5
"RTN","FBAAV0",77,0)
 ;
"RTN","FBAAV0",78,0)
 D POV^FBAAUTL2
"RTN","FBAAV0",79,0)
 S POV=$S(POV']"":"",POV="A":6,POV="B":7,POV="C":8,POV="D":9,POV="E":10,1:POV)
"RTN","FBAAV0",80,0)
 S POV=$S(POV']"":99,$D(^FBAA(161.82,POV,0)):$P(^(0),"^",3),1:99)
"RTN","FBAAV0",81,0)
 S FBPOV=POV
"RTN","FBAAV0",82,0)
 S FBTT=$S(FBTT]"":FBTT,1:1)
"RTN","FBAAV0",83,0)
 S FBCPT=$$CPT^FBAAUTL4($P(Y(0),"^")),FBCPT=$S($L(FBCPT)=5:FBCPT,1:"     ")
"RTN","FBAAV0",84,0)
 S FBPSA=$$PSA^FBAAV5(+$P(Y(0),U,12),+FBAASN) I $L(+FBPSA)'=3 S FBPSA=999
"RTN","FBAAV0",85,0)
 S FBPATT=$P(Y(0),"^",17),FBPATT=$S(FBPATT]"":FBPATT,1:10)
"RTN","FBAAV0",86,0)
 S FBTD=$$AUSDT^FBAAV3(FBDTSR1) ; formatted treatment date
"RTN","FBAAV0",87,0)
 S FBSUSP=$P(Y(0),"^",5),FBSUSP=$S(FBSUSP]"":FBSUSP,1:" ")
"RTN","FBAAV0",88,0)
 S FBSUSP=$S(FBSUSP=" ":" ",$D(^FBAA(161.27,+FBSUSP,0)):$P(^(0),"^"),1:" ")
"RTN","FBAAV0",89,0)
 S FBAP=$$AUSAMT^FBAAV3($P(Y(0),"^",3),8) ; amount paid
"RTN","FBAAV0",90,0)
 S FBPOS=+$P(Y(0),"^",25),FBPOS=$S(FBPOS:$P(^IBE(353.1,FBPOS,0),"^"),1:"  ")
"RTN","FBAAV0",91,0)
 S FBHCFA=+$P(Y(0),"^",26),FBHCFA=$S(FBHCFA:$P(^IBE(353.2,FBHCFA,0),"^"),1:""),FBHCFA=$E(PAD,$L(FBHCFA)+1,2)_FBHCFA
"RTN","FBAAV0",92,0)
 S FBVTOS=+$P(Y(0),"^",24),FBVTOS=$S(FBVTOS:$P(^FBAA(163.85,FBVTOS,0),"^",2),1:"  ")
"RTN","FBAAV0",93,0)
 S FBPD=+$P(Y(0),"^",23),FBPD=$S(FBPD:$$ICD9^FBCSV1(FBPD,$G(FBDTSR1)),1:""),FBPD=$E(PAD,$L(FBPD)+1,7)_FBPD
"RTN","FBAAV0",94,0)
 S FBINVN=$P(Y(0),"^",16)
"RTN","FBAAV0",95,0)
 S FBINVN=$E("000000000",$L(FBINVN)+1,9)_FBINVN
"RTN","FBAAV0",96,0)
 S FBAUTHF=$S($P(Y(0),U,13)["FB583":"U",1:"A") ; auth/unauth flag
"RTN","FBAAV0",97,0)
 S FBDIN=$$AUSDT^FBAAV3($P(Y(0),"^",15)) ; invoice date rec'd
"RTN","FBAAV0",98,0)
 S FBADMIT=$$AUSDT^FBAAV3($$B3ADMIT(FBIENS)) ; formatted admission date
"RTN","FBAAV0",99,0)
 ;
"RTN","FBAAV0",100,0)
 S VAPA("P")=""
"RTN","FBAAV0",101,0)
 S DFN=K
"RTN","FBAAV0",102,0)
 ; Note - before this point Y(0) was the 0 node of subfile #162.03
"RTN","FBAAV0",103,0)
 ;      - after this point Y(0) will be the 0 node of file #2
"RTN","FBAAV0",104,0)
 S Y(0)=$G(^DPT(+K,0)) Q:Y(0)']""
"RTN","FBAAV0",105,0)
 D PAT^FBAAUTL2
"RTN","FBAAV0",106,0)
 ; obtain date of birth, must follow call to PAT^FBAAUTL2 to overwrite 
"RTN","FBAAV0",107,0)
 ; the value returned from it
"RTN","FBAAV0",108,0)
 S FBDOB=$$AUSDT^FBAAV3($P(Y(0),"^",3)) ; date of birth
"RTN","FBAAV0",109,0)
 D ADD^VADPT
"RTN","FBAAV0",110,0)
 S FBPNAMX=$$HL7NAME^FBAAV4(DFN) ; patient name
"RTN","FBAAV0",111,0)
 S FBUNITS=$P(FBY,U,14)
"RTN","FBAAV0",112,0)
 S:FBUNITS<1 FBUNITS=1
"RTN","FBAAV0",113,0)
 S FBUNITS=$$RJ^XLFSTR(FBUNITS,5,0) ; volume indicator (units paid)
"RTN","FBAAV0",114,0)
 ;
"RTN","FBAAV0",115,0)
 ; get and format adjustment reason codes and amounts (if any)
"RTN","FBAAV0",116,0)
 D LOADADJ^FBAAFA(FBIENS,.FBADJ)
"RTN","FBAAV0",117,0)
 S FBX=$$ADJL^FBUTL2(.FBADJ)
"RTN","FBAAV0",118,0)
 S FBADJR1=$$RJ^XLFSTR($P(FBX,U,1),5," ")
"RTN","FBAAV0",119,0)
 S FBADJA1=$$AUSAMT^FBAAV3($P(FBX,U,3),9,1)
"RTN","FBAAV0",120,0)
 S FBADJR2=$$RJ^XLFSTR($P(FBX,U,4),5," ")
"RTN","FBAAV0",121,0)
 S FBADJA2=$$AUSAMT^FBAAV3($P(FBX,U,6),9,1)
"RTN","FBAAV0",122,0)
 K FBADJ,FBX
"RTN","FBAAV0",123,0)
 ;
"RTN","FBAAV0",124,0)
 S FBST=$S($P(VAPA(5),"^")="":"  ",$D(^DIC(5,$P(VAPA(5),"^"),0)):$P(^(0),"^",2),1:"  ")
"RTN","FBAAV0",125,0)
 S:$L(FBST)'=2 FBST=$E(PAD,$L(FBST)+1,2)_FBST
"RTN","FBAAV0",126,0)
 S FBCTY=$S($P(VAPA(7),"^",1)="":"   ",FBST="  ":"   ",$D(^DIC(5,$P(VAPA(5),"^"),1,$P(VAPA(7),"^"),0)):$P(^(0),"^",3),1:"   ")
"RTN","FBAAV0",127,0)
 I $L(FBCTY)'=3 S FBCTY=$E("000",$L(FBCTY)+1,3)_FBCTY
"RTN","FBAAV0",128,0)
 S FBZIP=$S('+$G(VAPA(11)):VAPA(6),+VAPA(11):$P(VAPA(11),U),1:VAPA(6)),FBZIP=$TR(FBZIP,"-","")_$E("000000000",$L(FBZIP)+1,9)
"RTN","FBAAV0",129,0)
 D STRING^FBAAV01
"RTN","FBAAV0",130,0)
 Q
"RTN","FBAAV0",131,0)
 ;
"RTN","FBAAV0",132,0)
UPD ; update the batch file
"RTN","FBAAV0",133,0)
 N Y
"RTN","FBAAV0",134,0)
 S DA=J,(DIC,DIE)="^FBAA(161.7,"
"RTN","FBAAV0",135,0)
 S DR="11////^S X=""T"";12////^S X=DT"
"RTN","FBAAV0",136,0)
 D ^DIE
"RTN","FBAAV0",137,0)
 Q
"RTN","FBAAV0",138,0)
 ;
"RTN","FBAAV0",139,0)
STORE D STORE^FBAAV01 Q
"RTN","FBAAV0",140,0)
 ;
"RTN","FBAAV0",141,0)
B3ADMIT(FBIENS) ; Determine Admission Date for a B3 payment line item
"RTN","FBAAV0",142,0)
 ; input
"RTN","FBAAV0",143,0)
 ;   FBIENS - IENS (FileMan format) for subfile 162.03 entry
"RTN","FBAAV0",144,0)
 ; returns admission date in internal FileMan format or null value
"RTN","FBAAV0",145,0)
 ;
"RTN","FBAAV0",146,0)
 N FB7078,FBRET
"RTN","FBAAV0",147,0)
 S FBRET=""
"RTN","FBAAV0",148,0)
 S FB7078=$$GET1^DIQ(162.03,FBIENS,27,"I") ; associated 7078/583
"RTN","FBAAV0",149,0)
 ; (the unauthorized ancillary claims will have the treatment date
"RTN","FBAAV0",150,0)
 ;  instead of the inpatient admission date so nothing is sent to
"RTN","FBAAV0",151,0)
 ;  Austin for them)
"RTN","FBAAV0",152,0)
 ;
"RTN","FBAAV0",153,0)
 ; if line items points to a 7078 authorization then return a date
"RTN","FBAAV0",154,0)
 I $P(FB7078,";",2)="FB7078(" D
"RTN","FBAAV0",155,0)
 . N FBY
"RTN","FBAAV0",156,0)
 . S FBY=$G(^FB7078(+FB7078,0))
"RTN","FBAAV0",157,0)
 . ; if fee program is civil hospital then return 7078 date of admission
"RTN","FBAAV0",158,0)
 . I $P(FBY,U,11)=6 S FBRET=$P(FBY,U,15)
"RTN","FBAAV0",159,0)
 . ; if fee program is CNH then return 7078 authorized from date
"RTN","FBAAV0",160,0)
 . I $P(FBY,U,11)=7 S FBRET=$P(FBY,U,4)
"RTN","FBAAV0",161,0)
 ;
"RTN","FBAAV0",162,0)
 Q FBRET
"RTN","FBAAV2")
0^14^B11664283^B11520151
"RTN","FBAAV2",1,0)
FBAAV2 ;AISC/GRR-ELECTRONICALLY TRANSMIT PHARMACY PAYMENTS ;11 Apr 2006  2:52 PM
"RTN","FBAAV2",2,0)
 ;;3.5;FEE BASIS;**3,89,98,116**;JAN 30, 1995;Build 30
"RTN","FBAAV2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAV2",4,0)
DETP ; ENTRY FROM FBAAV0
"RTN","FBAAV2",5,0)
 S FBTXT=0
"RTN","FBAAV2",6,0)
 D CKB5V^FBAAV01 I $G(FBERR) K FBERR Q
"RTN","FBAAV2",7,0)
 ; HIPAA 5010 - line items that have 0.00 amount paid are now required to go to Central Fee
"RTN","FBAAV2",8,0)
 ;F K=0:0 S K=$O(^FBAA(162.1,"AE",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAA(162.1,"AE",J,K,L)) Q:L'>0  S Y(0)=$G(^FBAA(162.1,K,"RX",L,0)),Y(2)=$G(^(2)),Y=$G(^FBAA(162.1,K,0)) I Y(0)]"",Y]"",+$P(Y(0),U,16) D
"RTN","FBAAV2",9,0)
 F K=0:0 S K=$O(^FBAA(162.1,"AE",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAA(162.1,"AE",J,K,L)) Q:L'>0  S Y(0)=$G(^FBAA(162.1,K,"RX",L,0)),Y(2)=$G(^(2)),Y=$G(^FBAA(162.1,K,0)) I Y(0)]"",Y]"" D
"RTN","FBAAV2",10,0)
 .N FBPICN,FBY
"RTN","FBAAV2",11,0)
 .S FBPICN=K_U_L
"RTN","FBAAV2",12,0)
 .S FBY=$S($P(Y,U,12):$P(Y,U,12),1:$P(Y,U,2))_U_+$P(Y(2),U,9)
"RTN","FBAAV2",13,0)
 .I 'FBTXT S FBTXT=1 D NEWMSG^FBAAV01,STORE^FBAAV01,UPD^FBAAV0
"RTN","FBAAV2",14,0)
 .D GOTP
"RTN","FBAAV2",15,0)
 D:FBTXT XMIT^FBAAV01
"RTN","FBAAV2",16,0)
 Q
"RTN","FBAAV2",17,0)
 ;
"RTN","FBAAV2",18,0)
GOTP ; process a B5 line item
"RTN","FBAAV2",19,0)
 N DFN,FBADJ,FBADJA1,FBADJA2,FBADJR1,FBADJR2,FBIENS,FBPNAMX,FBVY0,FBX,FBNPI
"RTN","FBAAV2",20,0)
 ;
"RTN","FBAAV2",21,0)
 S FBIENS=$P(FBPICN,U,2)_","_$P(FBPICN,U,1)_","
"RTN","FBAAV2",22,0)
 S FBPAYT=$P(Y(0),"^",20),FBPAYT=$S(FBPAYT]"":FBPAYT,1:"V")
"RTN","FBAAV2",23,0)
 S FBINVN=$P(Y,"^"),FBINVN=$E("000000000",$L(FBINVN)+1,9)_FBINVN
"RTN","FBAAV2",24,0)
 S FBDIN=$$AUSDT^FBAAV3($P(Y,"^",2))
"RTN","FBAAV2",25,0)
 ;
"RTN","FBAAV2",26,0)
 S FBVFN=$P(Y,"^",4)
"RTN","FBAAV2",27,0)
 S FBNPI=$$EN^FBNPILK(FBVFN)
"RTN","FBAAV2",28,0)
 S FBVY0=$G(^FBAAV(FBVFN,0)) ; vendor 0 node
"RTN","FBAAV2",29,0)
 S FBVID=$P(FBVY0,U,2),FBVID=$E(FBVID,1,9)_$E(PAD,$L(FBVID)+1,9)
"RTN","FBAAV2",30,0)
 S FBCSN=$S($P(FBVY0,U,2)]"":$P(FBVY0,U,10),1:"")
"RTN","FBAAV2",31,0)
 S FBCSN=$E("0000",$L(FBCSN)+1,4)_FBCSN
"RTN","FBAAV2",32,0)
 I FBPAYT="R" S FBVID=$E(PAD,1,9),FBCSN=$E(PAD,1,4)
"RTN","FBAAV2",33,0)
 K FBVY0
"RTN","FBAAV2",34,0)
 ;
"RTN","FBAAV2",35,0)
 S FBRX=$P(Y(0),"^",1),FBRX=$E("00000000",$L(FBRX)+1,8)_FBRX
"RTN","FBAAV2",36,0)
 I '$L($G(FBAASN)) D STATION^FBAAUTL
"RTN","FBAAV2",37,0)
 S FBPSA=$$PSA^FBAAV5(+$P(Y(2),U,5),+FBAASN) I $L(+FBPSA)'=3 S FBPSA=999
"RTN","FBAAV2",38,0)
 S FBTD=$$AUSDT^FBAAV3($P(Y(0),"^",3))
"RTN","FBAAV2",39,0)
 S FBSUSP=$P(Y(0),"^",8),FBSUSP=$S(FBSUSP="":" ",$D(^FBAA(161.27,+FBSUSP,0)):$P(^(0),"^"),1:" ")
"RTN","FBAAV2",40,0)
 S FBAC=$$AUSAMT^FBAAV3($P(Y(0),"^",4),8)
"RTN","FBAAV2",41,0)
 S FBAP=$$AUSAMT^FBAAV3($P(Y(0),"^",16),8)
"RTN","FBAAV2",42,0)
 I FBAC=FBAP S FBAP="        "
"RTN","FBAAV2",43,0)
 S DFN=$P(Y(0),"^",5)
"RTN","FBAAV2",44,0)
 Q:'DFN
"RTN","FBAAV2",45,0)
 Q:'$D(^DPT(DFN,0))
"RTN","FBAAV2",46,0)
 ; Note: Prior to the following line Y(0) = the 0 node of subfile 161.11
"RTN","FBAAV2",47,0)
 ;       After the line Y(0) will be the 0 node of file #2
"RTN","FBAAV2",48,0)
 S VAPA("P")="",Y(0)=^DPT(DFN,0) D PAT^FBAAUTL2,ADD^VADPT
"RTN","FBAAV2",49,0)
 S FBPNAMX=$$HL7NAME^FBAAV4(DFN)
"RTN","FBAAV2",50,0)
 S FBST=$S($P(VAPA(5),"^")="":"  ",$D(^DIC(5,$P(VAPA(5),"^"),0)):$P(^(0),"^",2),1:"  ")
"RTN","FBAAV2",51,0)
 S:$L(FBST)'=2 FBST=$E(PAD,$L(FBST)+1,2)_FBST
"RTN","FBAAV2",52,0)
 S FBCTY=$S($P(VAPA(7),"^")="":"   ",FBST="  ":"   ",$D(^DIC(5,$P(VAPA(5),"^"),1,$P(VAPA(7),"^"),0)):$P(^(0),"^",3),1:"   ")
"RTN","FBAAV2",53,0)
 I $L(FBCTY)'=3 S FBCTY=$E("000",$L(FBCTY)+1,3)_FBCTY
"RTN","FBAAV2",54,0)
 S FBZIP=$S('+$G(VAPA(11)):VAPA(6),+VAPA(11):$P(VAPA(11),U),1:VAPA(6)),FBZIP=$TR(FBZIP,"-","")_$E("000000000",$L(FBZIP)+1,9)
"RTN","FBAAV2",55,0)
 ;
"RTN","FBAAV2",56,0)
 ; get and format adjustment reason codes and amounts (if any)
"RTN","FBAAV2",57,0)
 D LOADADJ^FBRXFA(FBIENS,.FBADJ)
"RTN","FBAAV2",58,0)
 S FBX=$$ADJL^FBUTL2(.FBADJ)
"RTN","FBAAV2",59,0)
 S FBADJR1=$$RJ^XLFSTR($P(FBX,U,1),5," ")
"RTN","FBAAV2",60,0)
 S FBADJA1=$$AUSAMT^FBAAV3($P(FBX,U,3),9,1)
"RTN","FBAAV2",61,0)
 S FBADJR2=$$RJ^XLFSTR($P(FBX,U,4),5," ")
"RTN","FBAAV2",62,0)
 S FBADJA2=$$AUSAMT^FBAAV3($P(FBX,U,6),9,1)
"RTN","FBAAV2",63,0)
 K FBADJ,FBX
"RTN","FBAAV2",64,0)
 ;
"RTN","FBAAV2",65,0)
 S FBSTR=5_FBAASN_FBSSN_FBPAYT_FBPNAMX_FBVID_FBCSN_FBAC_FBAP_FBAAON_FBSUSP_FBTD_FBRX_FBDIN_FBINVN_FBST_FBCTY_FBZIP_$E(FBPSA,1,3)
"RTN","FBAAV2",66,0)
 S FBSTR=FBSTR_$P(FBY,U,2)_$E(PAD,1,8)_$$PADZ^FBAAV01(FBPICN,30)_$$AUSDT^FBAAV3(+FBY)
"RTN","FBAAV2",67,0)
 S FBSTR=FBSTR_FBADJR1_FBADJR2_FBADJA1_FBADJA2_FBNPI_"$"
"RTN","FBAAV2",68,0)
 D STORE^FBAAV01
"RTN","FBAAV2",69,0)
 Q
"RTN","FBAAV3")
0^15^B3282866^B3268497
"RTN","FBAAV3",1,0)
FBAAV3 ;AISC/GRR-CREATE & ELECTRONICALLY TRANSMIT TRANSACTIONS FOR TRAVEL PAYMENTS ;2/8/2005
"RTN","FBAAV3",2,0)
 ;;3.5;FEE BASIS;**3,89,116**;JAN 30, 1995;Build 30
"RTN","FBAAV3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAV3",4,0)
DETT ; process a travel batch
"RTN","FBAAV3",5,0)
 S FBTXT=0
"RTN","FBAAV3",6,0)
 ; HIPAA 5010 - line items that have 0.00 amount paid are now required to go to Central Fee
"RTN","FBAAV3",7,0)
 ;F K=0:0 S K=$O(^FBAAC("AD",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AD",J,K,L)) Q:L'>0  S Y(0)=$G(^FBAAC(K,3,L,0)) I Y(0)]"",+$P(Y(0),U,3) D
"RTN","FBAAV3",8,0)
 F K=0:0 S K=$O(^FBAAC("AD",J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AD",J,K,L)) Q:L'>0  S Y(0)=$G(^FBAAC(K,3,L,0)) I Y(0)]"" D
"RTN","FBAAV3",9,0)
 .S FBPICN=K_U_L
"RTN","FBAAV3",10,0)
 .I 'FBTXT S FBTXT=1 D NEWMSG^FBAAV01,STORE^FBAAV01,UPD^FBAAV0
"RTN","FBAAV3",11,0)
 .D GOT
"RTN","FBAAV3",12,0)
 D:FBTXT XMIT^FBAAV01 Q
"RTN","FBAAV3",13,0)
GOT ; process a travel line item
"RTN","FBAAV3",14,0)
 N DFN,FBPNAMX
"RTN","FBAAV3",15,0)
 S FBTD=$$AUSDT($P(Y(0),U))
"RTN","FBAAV3",16,0)
 S FBAP=$$AUSAMT($P(Y(0),"^",3),8)
"RTN","FBAAV3",17,0)
 S DFN=K
"RTN","FBAAV3",18,0)
 Q:'DFN
"RTN","FBAAV3",19,0)
 Q:'$D(^DPT(DFN,0))
"RTN","FBAAV3",20,0)
 ; Note: Prior to the following line Y(0) = 0 node of subfile #162.04
"RTN","FBAAV3",21,0)
 ;       After the line, Y(0) will = 0 node of file #2
"RTN","FBAAV3",22,0)
 S Y(0)=^DPT(DFN,0)
"RTN","FBAAV3",23,0)
 D PAT^FBAAUTL2
"RTN","FBAAV3",24,0)
 S FBPNAMX=$$HL7NAME^FBAAV4(DFN) ; formatted patient name
"RTN","FBAAV3",25,0)
 S FBSTR="T"_FBAASN_FBSSN_"T"_FBPNAMX_FBAP_FBAAON_FBTD_"0"_$E(PAD,1,8)
"RTN","FBAAV3",26,0)
 S FBSTR=FBSTR_$$PADZ^FBAAV01(FBPICN,30)_FBTD_"$"
"RTN","FBAAV3",27,0)
 D STORE^FBAAV01
"RTN","FBAAV3",28,0)
 K FBPICN
"RTN","FBAAV3",29,0)
 Q
"RTN","FBAAV3",30,0)
 ;
"RTN","FBAAV3",31,0)
AUSDT(FBDT) ;called to format date from VA FileMan internal to YYYYMMDD
"RTN","FBAAV3",32,0)
 ; if input date is blank or invalid, eight spaces will be returned
"RTN","FBAAV3",33,0)
 ;
"RTN","FBAAV3",34,0)
 N FBRET
"RTN","FBAAV3",35,0)
 S:FBDT FBRET=$$FMTHL7^XLFDT($P(FBDT,"."))
"RTN","FBAAV3",36,0)
 S:$G(FBRET)=""!($G(FBRET)<0) FBRET="        "
"RTN","FBAAV3",37,0)
 Q FBRET
"RTN","FBAAV3",38,0)
 ;
"RTN","FBAAV3",39,0)
AUSAMT(FBAMT,FBL,FBS) ; called to format signed dollar amount for Austin
"RTN","FBAAV3",40,0)
 ; input
"RTN","FBAAV3",41,0)
 ;   FBAMT - dollar amount
"RTN","FBAAV3",42,0)
 ;   FBL   - (optional) length of return sting 
"RTN","FBAAV3",43,0)
 ;   FBS   - (optional) =true(1) if return value could be negative (-)
"RTN","FBAAV3",44,0)
 ;           default is false (0)
"RTN","FBAAV3",45,0)
 ; result
"RTN","FBAAV3",46,0)
 ;   string value, right justified, 0 padded, decimal point removed,
"RTN","FBAAV3",47,0)
 ;   with rightmost 2 numeric characters the cents
"RTN","FBAAV3",48,0)
 ;   if FBS true then rightmost character indicate the sign (' ' or '-')
"RTN","FBAAV3",49,0)
 ;   example with FBS false: 12.41 with length 8 would return '00001241'
"RTN","FBAAV3",50,0)
 ;   example with FBS true:  12.41 with length 9 would return '00001241 '
"RTN","FBAAV3",51,0)
 ;   example with FBS true: -12.41 with length 9 would return '00001241-'
"RTN","FBAAV3",52,0)
 ;
"RTN","FBAAV3",53,0)
 N FBRET
"RTN","FBAAV3",54,0)
 ;
"RTN","FBAAV3",55,0)
 ; use absolute value
"RTN","FBAAV3",56,0)
 S FBRET=$S(FBAMT<0:-FBAMT,1:FBAMT)
"RTN","FBAAV3",57,0)
 ;
"RTN","FBAAV3",58,0)
 ; format with 2 decimals places
"RTN","FBAAV3",59,0)
 S FBRET=$FN(FBRET,"",2)
"RTN","FBAAV3",60,0)
 ;
"RTN","FBAAV3",61,0)
 ; remove the decimal point
"RTN","FBAAV3",62,0)
 S FBRET=$TR(FBRET,".","")
"RTN","FBAAV3",63,0)
 ;
"RTN","FBAAV3",64,0)
 ; add the suffix denoting the sign when applicable (when FBS true)
"RTN","FBAAV3",65,0)
 S FBRET=FBRET_$S('$G(FBS):"",FBAMT<0:"-",1:" ")
"RTN","FBAAV3",66,0)
 ;
"RTN","FBAAV3",67,0)
 ; right justify and 0 pad
"RTN","FBAAV3",68,0)
 S FBRET=$$RJ^XLFSTR(FBRET,$G(FBL),"0")
"RTN","FBAAV3",69,0)
 ;
"RTN","FBAAV3",70,0)
 ; return result
"RTN","FBAAV3",71,0)
 Q FBRET
"RTN","FBAAV3",72,0)
 ;
"RTN","FBAAV3",73,0)
 ;FBAAV3
"RTN","FBAAV5")
0^16^B48447360^B47766353
"RTN","FBAAV5",1,0)
FBAAV5 ;AISC/GRR-CREATE TRANSACTIONS FOR CH/CNH PAYMENTS ;11 Apr 2006  2:54 PM
"RTN","FBAAV5",2,0)
 ;;3.5;FEE BASIS;**3,55,89,98,116**;JAN 30, 1995;Build 30
"RTN","FBAAV5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBAAV5",4,0)
 D CKB9V^FBAAV01 I $G(FBERR) K FBERR Q
"RTN","FBAAV5",5,0)
 G:FBSTAT="S"&(FBCHB="Y")&($P(Y(0),"^",18)'="Y") ^FBAAV6
"RTN","FBAAV5",6,0)
DETCH S FBTXT=0
"RTN","FBAAV5",7,0)
 ; HIPAA 5010 - line items that have 0.00 amount paid are now required to go to Central Fee
"RTN","FBAAV5",8,0)
 ;F K=0:0 S K=$O(^FBAAI("AC",J,K)) Q:K'>0  S Y(0)=$G(^FBAAI(K,0)),Y(2)=$G(^(2)) I Y(0)]"",+$P(Y(0),U,9) D
"RTN","FBAAV5",9,0)
 F K=0:0 S K=$O(^FBAAI("AC",J,K)) Q:K'>0  S Y(0)=$G(^FBAAI(K,0)),Y(2)=$G(^(2)) I Y(0)]"" D
"RTN","FBAAV5",10,0)
 .N FBPICN,FBY
"RTN","FBAAV5",11,0)
 .S FBPICN=K
"RTN","FBAAV5",12,0)
 .S FBY=$S($P(Y(2),U,2):$P(Y(2),U,2),1:$P(Y(0),U,2))_U_+$P(Y(2),U,3)
"RTN","FBAAV5",13,0)
 .I 'FBTXT S FBTXT=1 D NEWMSG^FBAAV01,STORE^FBAAV01,UPD^FBAAV0
"RTN","FBAAV5",14,0)
 .D GOT
"RTN","FBAAV5",15,0)
 D:FBTXT XMIT^FBAAV01 Q
"RTN","FBAAV5",16,0)
GOT ; process an inpatient invoice
"RTN","FBAAV5",17,0)
 N DFN,FBADJ,FBADJA,FBADJR,FBADMIT,FBAUTHF,FBCDAYS,FBDISDT,FBDISTY,FBNPI
"RTN","FBAAV5",18,0)
 N FBDRG,FBIENS,FBPA,FBPNAMX,FBVMID,FBX
"RTN","FBAAV5",19,0)
 S FBIENS=K_","
"RTN","FBAAV5",20,0)
 I '$L($G(FBAASN)) D STATION^FBAAUTL
"RTN","FBAAV5",21,0)
 S FBPSA=$$PSA(+$P(Y(0),U,20),+$G(FBAASN)) I $L(+FBPSA)'=3 S FBPSA=999
"RTN","FBAAV5",22,0)
 S FBPAYT=$P(Y(0),"^",13),FBPAYT=$S(FBPAYT]"":FBPAYT,1:"V")
"RTN","FBAAV5",23,0)
 S L=$P(Y(0),"^",3)
"RTN","FBAAV5",24,0)
 S FBVID=$S($D(^FBAAV(L,0)):$P(^(0),"^",2),1:"")
"RTN","FBAAV5",25,0)
 S FBNPI=$$EN^FBNPILK(L)
"RTN","FBAAV5",26,0)
 S FBVID=FBVID_$E(PAD,$L(FBVID)+1,11)
"RTN","FBAAV5",27,0)
 S:FBPAYT="R" FBVID=$E(PAD,1,11)
"RTN","FBAAV5",28,0)
 S FBVMID=$S($D(^FBAAV(L,0)):$P(^(0),"^",17),1:"")
"RTN","FBAAV5",29,0)
 S FBVMID=$E(PAD,$L(FBVMID)+1,6)_FBVMID
"RTN","FBAAV5",30,0)
 S POV=$P(Y(0),"^",18)
"RTN","FBAAV5",31,0)
 S POV=$S(POV']"":"",POV="A":6,POV="B":7,POV="C":8,POV="D":9,POV="E":10,1:POV),POV=$S(POV']"":40,$D(^FBAA(161.82,POV,0)):$P(^(0),"^",3),1:40),FBPOV=POV
"RTN","FBAAV5",32,0)
 S FBPATT=$P(Y(0),"^",19),FBPATT=$S(FBPATT]"":FBPATT,1:10)
"RTN","FBAAV5",33,0)
 S FBFTD=$$AUSDT^FBAAV3($P(Y(0),"^",6)) ; from treatment date
"RTN","FBAAV5",34,0)
 S FBTTD=$$AUSDT^FBAAV3($P(Y(0),"^",7)) ; to treatment date
"RTN","FBAAV5",35,0)
 S FBSUSP=$P(Y(0),"^",11),FBSUSP=$S(FBSUSP="":" ",$D(^FBAA(161.27,FBSUSP,0)):$P(^(0),"^",1),1:" ")
"RTN","FBAAV5",36,0)
 S FBINVN=$P(Y(0),"^",1)
"RTN","FBAAV5",37,0)
 S FBINVN=$E("000000000",$L(FBINVN)+1,9)_FBINVN
"RTN","FBAAV5",38,0)
 S FBDIN=$$AUSDT^FBAAV3($P(Y(0),"^",2)) ; invoice date rec'd
"RTN","FBAAV5",39,0)
 S FBAP=$$AUSAMT^FBAAV3($P(Y(0),"^",9),8)
"RTN","FBAAV5",40,0)
 S FBAC=$$AUSAMT^FBAAV3($P(Y(0),"^",8),8)
"RTN","FBAAV5",41,0)
 S FBPA=$$AUSAMT^FBAAV3($P(Y(0),"^",26),8)
"RTN","FBAAV5",42,0)
 S FBDRG=$P(Y(0),"^",24),FBDRG=$E(PAD,$L(FBDRG)+1,4)_FBDRG
"RTN","FBAAV5",43,0)
 S FBAUTHF=$S($P(Y(0),U,5)["FB583":"U",1:"A") ; auth/unauth flag
"RTN","FBAAV5",44,0)
 K FBDX,FBPRC F I=1:1:5 S (FBDX(I),FBPRC(I))="       "
"RTN","FBAAV5",45,0)
 I $D(^FBAAI(K,"DX")) S Y("DX")=^("DX") F M=1:1:5 Q:$P(Y("DX"),"^",M)=""  S FBDX(M)=$$SPACES^FBCSV1($$ICD9^FBCSV1(+$P(Y("DX"),"^",M),$P($G(Y(0)),"^",6)),7) I $L(FBDX(M))<7 S FBDX(M)=$E(PAD,$L(FBDX(M))+1,7)_FBDX(M)
"RTN","FBAAV5",46,0)
 I $D(^FBAAI(K,"PROC")) S Y("PROC")=^("PROC") F M=1:1:5 Q:$P(Y("PROC"),"^",M)=""  S FBPRC(M)=$$SPACES^FBCSV1($$ICD0^FBCSV1($P(Y("PROC"),"^",M),$P($G(Y(0)),"^",6)),7) I $L(FBPRC(M))<7 S FBPRC(M)=$E("       ",$L(FBPRC(M))+1,7)_FBPRC(M)
"RTN","FBAAV5",47,0)
 S DFN=$P(Y(0),"^",4)
"RTN","FBAAV5",48,0)
 ; Note: Prior to the following line Y(0) = the 0 node of file 162.5
"RTN","FBAAV5",49,0)
 ;       After the line Y(0) will equal the 0 node of file #2
"RTN","FBAAV5",50,0)
 S VAPA("P")="",Y(0)=$S($D(^DPT(DFN,0)):^(0),1:"")
"RTN","FBAAV5",51,0)
 D PAT^FBAAUTL2
"RTN","FBAAV5",52,0)
 ; obtain date of birth, must follow call to PAT^FBAAUTL2 to overwrite 
"RTN","FBAAV5",53,0)
 ; the value returned from it
"RTN","FBAAV5",54,0)
 S FBDOB=$$AUSDT^FBAAV3($P(Y(0),"^",3))
"RTN","FBAAV5",55,0)
 D ADD^VADPT
"RTN","FBAAV5",56,0)
 S FBPNAMX=$$HL7NAME^FBAAV4(DFN) ; patient name
"RTN","FBAAV5",57,0)
 S FBST=$S($P(VAPA(5),"^",1)="":"  ",$D(^DIC(5,$P(VAPA(5),"^",1),0)):$P(^(0),"^",2),1:"  ")
"RTN","FBAAV5",58,0)
 S:$L(FBST)'=2 FBST=$E(PAD,$L(FBST)+1,2)_FBST
"RTN","FBAAV5",59,0)
 S FBCTY=$S($P(VAPA(7),"^",1)="":"   ",FBST="  ":"   ",$D(^DIC(5,$P(VAPA(5),"^",1),1,$P(VAPA(7),"^",1),0)):$P(^(0),"^",3),1:"   ")
"RTN","FBAAV5",60,0)
 I $L(FBCTY)'=3 S FBCTY=$E("000",$L(FBCTY)+1,3)_FBCTY
"RTN","FBAAV5",61,0)
 S FBZIP=$S('+$G(VAPA(11)):VAPA(6),+VAPA(11):$P(VAPA(11),U),1:VAPA(6)),FBZIP=$TR(FBZIP,"-","")_$E("000000000",$L(FBZIP)+1,9)
"RTN","FBAAV5",62,0)
 S FBADMIT=$$AUSDT^FBAAV3($P($$B9ADMIT(FBIENS),".")) ; admission date
"RTN","FBAAV5",63,0)
 ; get and format discharge date and type
"RTN","FBAAV5",64,0)
 S FBX=$$B9DISCHG(FBIENS)
"RTN","FBAAV5",65,0)
 S FBDISDT=$$AUSDT^FBAAV3($P($P(FBX,U),".")) ; discharge date
"RTN","FBAAV5",66,0)
 S FBDISTY=$$RJ^XLFSTR($P(FBX,U,2),3,0) ; discharge type
"RTN","FBAAV5",67,0)
 K FBX
"RTN","FBAAV5",68,0)
 ; get volume indicator (covered days)
"RTN","FBAAV5",69,0)
 S FBCDAYS=$$RJ^XLFSTR($$GET1^DIQ(162.5,FBIENS,54),5,"0")
"RTN","FBAAV5",70,0)
 ; obtain and format the adjustment codes and amounts
"RTN","FBAAV5",71,0)
 ; get and format adjustment reason codes and amounts (if any)
"RTN","FBAAV5",72,0)
 D LOADADJ^FBCHFA(FBIENS,.FBADJ)
"RTN","FBAAV5",73,0)
 S FBX=$$ADJL^FBUTL2(.FBADJ)
"RTN","FBAAV5",74,0)
 S FBADJR=$$RJ^XLFSTR($P(FBX,U,1),5," ")
"RTN","FBAAV5",75,0)
 S FBADJA=$$AUSAMT^FBAAV3($P(FBX,U,3),9,1)
"RTN","FBAAV5",76,0)
 K FBADJ,FBX
"RTN","FBAAV5",77,0)
 ;
"RTN","FBAAV5",78,0)
 S FBSTR=9_FBAASN_FBSSN_FBPAYT_FBPNAMX_FBVID_"  "_"  "_FBAP_FBAAON_FBSUSP_FBPOV_FBPATT_FBFTD_FBTTD_FBDIN_FBINVN_FBVMID_FBST_FBCTY_FBZIP_FBPSA_$P(FBY,U,2)_$E(PAD,1,14)
"RTN","FBAAV5",79,0)
 F I=1:1:5 S FBSTR=FBSTR_FBDX(I)
"RTN","FBAAV5",80,0)
 S FBSTR=FBSTR_$$PADZ^FBAAV01(FBPICN,23)_$$AUSDT^FBAAV3(+FBY)_"~"
"RTN","FBAAV5",81,0)
 D STORE^FBAAV01
"RTN","FBAAV5",82,0)
 ;
"RTN","FBAAV5",83,0)
 ; build 2nd line
"RTN","FBAAV5",84,0)
 S FBSTR=""
"RTN","FBAAV5",85,0)
 F I=1:1:5 S FBSTR=FBSTR_FBPRC(I)
"RTN","FBAAV5",86,0)
 S FBSTR=FBSTR_"  "_FBAC_"  "_FBPA_FBDRG_" "_FBADMIT_FBDISDT_FBDOB_FBDISTY_FBCDAYS_FBAUTHF_FBADJR_"  "_FBADJA_FBNPI_"~$"
"RTN","FBAAV5",87,0)
 D STORE^FBAAV01
"RTN","FBAAV5",88,0)
 ;
"RTN","FBAAV5",89,0)
 Q
"RTN","FBAAV5",90,0)
 ;
"RTN","FBAAV5",91,0)
PSA(X,Y) ;call to set default Primary Service Area (PSA)
"RTN","FBAAV5",92,0)
 ;to send to Austin.
"RTN","FBAAV5",93,0)
 ;X = pointer to the institution file
"RTN","FBAAV5",94,0)
 ;Y = default if unable to determine station number in file 4
"RTN","FBAAV5",95,0)
 ;call returns the 3 digit station number only
"RTN","FBAAV5",96,0)
 ;if Y undef return '0'
"RTN","FBAAV5",97,0)
 I '$G(Y) S Y=0
"RTN","FBAAV5",98,0)
 Q $S('X:+Y,$E($P($G(^DIC(4,+X,99)),U),1,3)'?3N:+Y,1:$E($P($G(^(99)),U),1,3))
"RTN","FBAAV5",99,0)
 ;
"RTN","FBAAV5",100,0)
B9ADMIT(FBIENS) ; Determine Admission Date for a B9 payment
"RTN","FBAAV5",101,0)
 ; input
"RTN","FBAAV5",102,0)
 ;   FBIENS
"RTN","FBAAV5",103,0)
 ; returns admission date in internal FileMan format or null value
"RTN","FBAAV5",104,0)
 N FB7078,FBRET
"RTN","FBAAV5",105,0)
 S FBRET=""
"RTN","FBAAV5",106,0)
 ;
"RTN","FBAAV5",107,0)
 S FB7078=$$GET1^DIQ(162.5,FBIENS,4,"I") ; associated 7078/583
"RTN","FBAAV5",108,0)
 ;
"RTN","FBAAV5",109,0)
 ; if invoice points to a 7078 authorization then get date from the 7078
"RTN","FBAAV5",110,0)
 I $P(FB7078,";",2)="FB7078(" D
"RTN","FBAAV5",111,0)
 . N FBY
"RTN","FBAAV5",112,0)
 . S FBY=$G(^FB7078(+FB7078,0))
"RTN","FBAAV5",113,0)
 . ; if fee program is civil hospital then return 7078 date of admission
"RTN","FBAAV5",114,0)
 . I $P(FBY,U,11)=6 S FBRET=$P(FBY,U,15)
"RTN","FBAAV5",115,0)
 . ; if fee program is CNH then return 7078 authorized from date
"RTN","FBAAV5",116,0)
 . I $P(FBY,U,11)=7 S FBRET=$P(FBY,U,4)
"RTN","FBAAV5",117,0)
 ;
"RTN","FBAAV5",118,0)
 ; if invoice points to an unauthorized claim then use the treatment from
"RTN","FBAAV5",119,0)
 ;   date on the unauthorized claim
"RTN","FBAAV5",120,0)
 I $P(FB7078,";",2)="FB583(" D
"RTN","FBAAV5",121,0)
 . N FBY
"RTN","FBAAV5",122,0)
 . S FBY=$G(^FB583(+FB7078,0))
"RTN","FBAAV5",123,0)
 . S FBRET=$P(FBY,U,5)
"RTN","FBAAV5",124,0)
 ;
"RTN","FBAAV5",125,0)
 ; return the result
"RTN","FBAAV5",126,0)
 Q FBRET
"RTN","FBAAV5",127,0)
 ;
"RTN","FBAAV5",128,0)
B9DISCHG(FBIENS) ; Determine Discharge Date and Type for a B9 payment
"RTN","FBAAV5",129,0)
 ; input
"RTN","FBAAV5",130,0)
 ;   FBIENS - Invoice IEN (file 162.5) with trailing comma
"RTN","FBAAV5",131,0)
 ; returns discharge date in internal FileMan format or null value and
"RTN","FBAAV5",132,0)
 ; discharge type or null value
"RTN","FBAAV5",133,0)
 N FB7078,FBDISDT,FBDISTY
"RTN","FBAAV5",134,0)
 S (FBDISDT,FBDISTY)=""
"RTN","FBAAV5",135,0)
 ;
"RTN","FBAAV5",136,0)
 S FB7078=$$GET1^DIQ(162.5,FBIENS,4,"I") ; associated 7078/583
"RTN","FBAAV5",137,0)
 ;
"RTN","FBAAV5",138,0)
 ; if invoice points to an unauthorized claim then use the treatment to
"RTN","FBAAV5",139,0)
 ;   date on the unauthorized claim
"RTN","FBAAV5",140,0)
 I $P(FB7078,";",2)="FB583(" D
"RTN","FBAAV5",141,0)
 . N FBY
"RTN","FBAAV5",142,0)
 . S FBY=$G(^FB583(+FB7078,0))
"RTN","FBAAV5",143,0)
 . S FBDISDT=$P(FBY,U,6)
"RTN","FBAAV5",144,0)
 . S FBDISTY=$$GET1^DIQ(162.5,FBIENS,"6.5:1") ; discharge type
"RTN","FBAAV5",145,0)
 ;
"RTN","FBAAV5",146,0)
 ; if invoice points to a 7078 authorization then get date from the 7078
"RTN","FBAAV5",147,0)
 I $P(FB7078,";",2)="FB7078(" D
"RTN","FBAAV5",148,0)
 . N FBY
"RTN","FBAAV5",149,0)
 . S FBY=$G(^FB7078(+FB7078,0))
"RTN","FBAAV5",150,0)
 . ;
"RTN","FBAAV5",151,0)
 . ; if fee program is civil hospital then return 7078 date of discharge
"RTN","FBAAV5",152,0)
 . I $P(FBY,U,11)=6 D
"RTN","FBAAV5",153,0)
 . . S FBDISDT=$P(FBY,U,16) ; discharge date
"RTN","FBAAV5",154,0)
 . . S FBDISTY=$$GET1^DIQ(162.5,FBIENS,"6.5:1") ; discharge type
"RTN","FBAAV5",155,0)
 . ;
"RTN","FBAAV5",156,0)
 . ; if fee program is CNH then get date & type from CNH activity file
"RTN","FBAAV5",157,0)
 . I $P(FBY,U,11)=7 D
"RTN","FBAAV5",158,0)
 . . N DFN,FBADMIT,FBADMITR,FBACTA,FBAUTHP,FBDA,FBDTR
"RTN","FBAAV5",159,0)
 . . S DFN=$P(FBY,U,3) ; patient IEN
"RTN","FBAAV5",160,0)
 . . S FBADMIT=$P($P(FBY,U,4),".") ; CNH admission date
"RTN","FBAAV5",161,0)
 . . S FBAUTHP=+$O(^FBAAA("AG",FB7078,DFN,0)) ; authorization 'pointer'
"RTN","FBAAV5",162,0)
 . . ;
"RTN","FBAAV5",163,0)
 . . ; find the admission entry in CNH ACTIVITY file          
"RTN","FBAAV5",164,0)
 . . S FBACTA=0 ; init the admission activity ien
"RTN","FBAAV5",165,0)
 . . S FBADMITR=9999999-FBADMIT ; reverse admission date
"RTN","FBAAV5",166,0)
 . . S FBDTR=9999999-$$FMADD^XLFDT(FBADMIT,1) ; start loop
"RTN","FBAAV5",167,0)
 . . F  S FBDTR=$O(^FBAACNH("AF",DFN,FBDTR)) Q:'FBDTR!($P(FBDTR,".")>FBADMITR)  D  Q:FBACTA
"RTN","FBAAV5",168,0)
 . . . S FBDA=0 F  S FBDA=$O(^FBAACNH("AF",DFN,FBDTR,FBDA)) Q:'FBDA  D
"RTN","FBAAV5",169,0)
 . . . . S FBY=$G(^FBAACNH(FBDA,0))
"RTN","FBAAV5",170,0)
 . . . . I $P(FBY,U,3)="A",$P(FBY,U,10)=FBAUTHP S FBACTA=FBDA ; found it
"RTN","FBAAV5",171,0)
 . . Q:'FBACTA  ; could not find the admission activity
"RTN","FBAAV5",172,0)
 . . ;
"RTN","FBAAV5",173,0)
 . . ; get date from associated discharge (if any) in CNH ACTIVITY file
"RTN","FBAAV5",174,0)
 . . S FBDA=" "
"RTN","FBAAV5",175,0)
 . . F  S FBDA=$O(^FBAACNH("AC",FBACTA,FBDA),-1) Q:FBDA'>0  D  Q:FBDISDT
"RTN","FBAAV5",176,0)
 . . . S FBY=$G(^FBAACNH(FBDA,0))
"RTN","FBAAV5",177,0)
 . . . I $P(FBY,U,3)="D" D
"RTN","FBAAV5",178,0)
 . . . . S FBDISDT=$P($P(FBY,U),".")
"RTN","FBAAV5",179,0)
 . . . . S FBDISTY=$P(FBY,U,8)
"RTN","FBAAV5",180,0)
 . . . . I FBDISTY'="" S FBDISTY=FBDISTY+100
"RTN","FBAAV5",181,0)
 ;
"RTN","FBAAV5",182,0)
 ; return the result
"RTN","FBAAV5",183,0)
 Q FBDISDT_"^"_FBDISTY
"RTN","FBAAV5",184,0)
 ;
"RTN","FBAAV5",185,0)
 ;FBAAV5
"RTN","FBCHPET")
0^17^B31374746^B31972937
"RTN","FBCHPET",1,0)
FBCHPET ;AISC/DMK-EDIT ANCILLARY PAYMENT ;7/13/2003
"RTN","FBCHPET",2,0)
 ;;3.5;FEE BASIS;**4,38,61,77,116**;JAN 30, 1995;Build 30
"RTN","FBCHPET",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBCHPET",4,0)
 S FY=$E(DT,1,3)+1700+$S($E(4,5)>9:1,1:0)
"RTN","FBCHPET",5,0)
GETPT I $G(BAT) D
"RTN","FBCHPET",6,0)
 .I '$D(^FBAAC("AC",+BAT)) F I=9,10,11 S $P(^FBAA(161.7,+BAT,0),U,I)=""
"RTN","FBCHPET",7,0)
 .I $D(^FBAAC("AC",+BAT)) D  S $P(^FBAA(161.7,+BAT,0),U,11)=I,$P(^(0),U,9)=$G(FBTOT) K I,FBTOT
"RTN","FBCHPET",8,0)
 ..N J,K,L,M S (I,J,K,L,M,FBTOT)=0
"RTN","FBCHPET",9,0)
 ..F  S J=$O(^FBAAC("AC",+BAT,J)) Q:'J  F  S K=$O(^FBAAC("AC",+BAT,J,K)) Q:'K  F  S L=$O(^FBAAC("AC",+BAT,J,K,L)) Q:'L  F  S M=$O(^FBAAC("AC",+BAT,J,K,L,M)) Q:'M  I $D(^FBAAC(J,1,K,1,L,1,M,0)) S I=I+1,FBTOT=FBTOT+$P(^(0),U,3)
"RTN","FBCHPET",10,0)
 W !! S DIC="^FBAAC(",DIC(0)="AEQM" D ^DIC G END:X="^"!(X=""),GETPT:Y<0 S (DFN,FBDA(3))=+Y
"RTN","FBCHPET",11,0)
 S:'$D(^FBAAC(DFN,1,0)) ^FBAAC(DFN,1,0)="^162.01P^0^0"
"RTN","FBCHPET",12,0)
 S DIC=DIC_DFN_",1,"
"RTN","FBCHPET",13,0)
GETVD W !! S DIC(0)="AEQM" D ^DIC G GETPT:X="^"!(X=""),GETVD:Y<0 S (FBV,FBVD,FBDA(2))=+Y
"RTN","FBCHPET",14,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,0)) ^FBAAC(DFN,1,FBDA(2),1,0)="^162.02DA^0^0"
"RTN","FBCHPET",15,0)
 S DIC=DIC_FBVD_",1,"
"RTN","FBCHPET",16,0)
GETDT S DIC(0)="AEQM",DIC("A")="Date of Service: " D ^DIC K DIC("A") G GETPT:X="^"!(X=""),GETDT:Y<0 S (FBSD,FBSDI,FBDA(1))=+Y,FBAADT=$P(Y,U,2)
"RTN","FBCHPET",17,0)
 S:'$D(^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)) ^FBAAC(DFN,1,FBDA(2),1,FBDA(1),1,0)="^162.03A^0^0"
"RTN","FBCHPET",18,0)
 S FBZ=DIC_FBSD_",1,"
"RTN","FBCHPET",19,0)
SERV S DA(3)=FBDA(3),DA(2)=FBDA(2),DA(1)=FBDA(1)
"RTN","FBCHPET",20,0)
 S DIC("W")="N FBX S FBX=$$MODL^FBAAUTL4(""^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,+Y,""""M"""")"",""E"") W:FBX]"""" ""    CPT Modifier(s): "",FBX Q"
"RTN","FBCHPET",21,0)
 S DIC=FBZ,DIC(0)="AEQMZ"
"RTN","FBCHPET",22,0)
 D
"RTN","FBCHPET",23,0)
 . N ICPTVDT S ICPTVDT=$G(FBAADT) D ^DIC
"RTN","FBCHPET",24,0)
 G GETPT:X="^"!(X=""),SERV:Y<0 S (FBSV,FBAACPI,FBDA)=+Y,BAT=$P(Y(0),U,8),FBDUZ=$P(Y(0),U,7),(FBAACP,FBAACP(0))=$P(Y,U,2),K=$P(Y(0),U,3),FBAAPTC=$P(Y(0),U,20),J(0)=$P(Y(0),U,2)
"RTN","FBCHPET",25,0)
 ; set FB1725 true (1) if payment is for a Mill Bill claim
"RTN","FBCHPET",26,0)
 S FB1725=$S($P(Y(0),U,13)["FB583":+$P($G(^FB583(+$P(Y(0),U,13),0)),U,28),1:0)
"RTN","FBCHPET",27,0)
 I FBDUZ'=DUZ&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry,only the clerk who entered the payment ",!," or a supervisor can edit this payment." G GETPT
"RTN","FBCHPET",28,0)
 S FBAAMM1=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,2)
"RTN","FBCHPET",29,0)
 S FBFSAMT(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,2)),U,12)
"RTN","FBCHPET",30,0)
 ; determine lesser of original fee schedule amount and amount claimed
"RTN","FBCHPET",31,0)
 S FBAMTPD(0)=$S(FBFSAMT(0)="":J(0),FBFSAMT(0)>J(0):J(0),1:FBFSAMT(0))
"RTN","FBCHPET",32,0)
 S FBMODL=$$MODL^FBAAUTL4("^FBAAC("_FBDA(3)_",1,"_FBDA(2)_",1,"_FBDA(1)_",1,"_FBDA_",""M"")")
"RTN","FBCHPET",33,0)
 ; load current adjustment data
"RTN","FBCHPET",34,0)
 D LOADADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBCHPET",35,0)
 ; save adjustment data prior to edit session in sorted list
"RTN","FBCHPET",36,0)
 S FBADJL(0)=$$ADJL^FBUTL2(.FBADJ) ; sorted list of original adjustments
"RTN","FBCHPET",37,0)
 ; load current remittance remark data
"RTN","FBCHPET",38,0)
 D LOADRR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBCHPET",39,0)
 ; save remittance remarks prior to edit session in sorted list
"RTN","FBCHPET",40,0)
 S FBRRMKL(0)=$$RRL^FBUTL4(.FBRRMK)
"RTN","FBCHPET",41,0)
 S FBFPPSC(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U)
"RTN","FBCHPET",42,0)
 S FBFPPSC=FBFPPSC(0)
"RTN","FBCHPET",43,0)
 S FBFPPSL(0)=$P($G(^FBAAC(FBDA(3),1,FBDA(2),1,FBDA(1),1,FBDA,3)),U,2)
"RTN","FBCHPET",44,0)
 S FBFPPSL=FBFPPSL(0)
"RTN","FBCHPET",45,0)
 G:BAT']"" EDIT
"RTN","FBCHPET",46,0)
 I $P($G(^FBAA(161.7,BAT,"ST")),"^",1)="S"!($P($G(^FBAA(161.7,BAT,"ST")),"^",1)="T")&('$D(^XUSEC("FBAASUPERVISOR",DUZ))) W !!,*7,"Sorry, only the Supervisor can edit a payment once the batch has been released." G GETPT
"RTN","FBCHPET",47,0)
 I $P($G(^FBAA(161.7,BAT,"ST")),"^",1)="V" W !!,*7,"Sorry,you cannot edit a payment once the batch has been Finalized." G GETPT
"RTN","FBCHPET",48,0)
EDIT S DA=FBSV
"RTN","FBCHPET",49,0)
 ;
"RTN","FBCHPET",50,0)
 ; first edit CPT code and modifiers
"RTN","FBCHPET",51,0)
 D CPTM^FBAALU(FBAADT,DFN,FBAACP(0),FBMODL) I '$G(FBGOT) G GETPT
"RTN","FBCHPET",52,0)
 ; if CPT was changed then update file
"RTN","FBCHPET",53,0)
 I FBAACP'=FBAACP(0) D  I FBAACP="@" G GETPT
"RTN","FBCHPET",54,0)
 . N FBIENS,FBFDA
"RTN","FBCHPET",55,0)
 . S FBIENS=FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_","
"RTN","FBCHPET",56,0)
 . S FBFDA(162.03,FBIENS,.01)=FBAACP
"RTN","FBCHPET",57,0)
 . D FILE^DIE("","FBFDA") D MSG^DIALOG()
"RTN","FBCHPET",58,0)
 ; if modifiers changed then update file
"RTN","FBCHPET",59,0)
 I FBMODL'=$$MODL^FBAAUTL4("FBMODA") D REPMOD^FBAAUTL4(FBDA(3),FBDA(2),FBDA(1),FBDA)
"RTN","FBCHPET",60,0)
 ;
"RTN","FBCHPET",61,0)
 ; now edit remaining fields
"RTN","FBCHPET",62,0)
 S DIE("NO^")=""
"RTN","FBCHPET",63,0)
 S DR="48;47;S FBUNITS=X;42R;S FBZIP=X;S:$$ANES^FBAAFS($$CPT^FBAAUTL4(FBAACP)) Y=""@2"";43///@;S FBTIME=X;S Y=""@3"";@2;43R;S FBTIME=X;@3"
"RTN","FBCHPET",64,0)
 ; fb*3.5*116 remove edit of interest indicator (162.03,34) to prevent different interest indicator values at line item level; interest indicator set at invoice level only;
"RTN","FBCHPET",65,0)
 ;S DR(1,162.03,1)="S FBAAMM=$S(FBAAPTC=""R"":"""",1:1);D PPT^FBAACO1(FBAAMM1);34///@;34////^S X=FBAAMM1;30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBCHPET",66,0)
 S DR(1,162.03,1)="30R;S FBHCFA(30)=X;1;S J=X;Q"
"RTN","FBCHPET",67,0)
 S DR(1,162.03,2)="D FEEDT^FBAACO3;44///@;44///^S X=FBFSAMT;45///@;45///^S X=FBFSUSD;S:FBAMTPD'>0!(FBAMTPD=FBAMTPD(0)) Y=""@4"";2///^S X=FBAMTPD;@4;2//^S X=FBAMTPD;D CHKIT^FBAACO3;S K=X"
"RTN","FBCHPET",68,0)
 ;S DR(1,162.03,3)="3////^S X=$S(J-K:J-K,1:"""");I X S Y=""@11"";4////@;S Y=""@5"";@11;3R;4R;S:X'=4 Y=""@5"";22"
"RTN","FBCHPET",69,0)
 S DR(1,162.03,3)="K FBADJD;M FBADJD=FBADJ;S FBX=$$ADJ^FBUTL2(J-K,.FBADJ,2,,.FBADJD,1)"
"RTN","FBCHPET",70,0)
 S DR(1,162.03,4)="S FBX=$$FPPSC^FBUTL5(1,FBFPPSC);S:FBX=-1 Y=0;S:FBX="""" Y=""@5"";50///^S X=FBX;S FBFPPSC=X;S FBX=$$FPPSL^FBUTL5(FBFPPSL);S:FBX=-1 Y=0;51///^S X=FBX;S FBFPPCL=X;S Y=""@55"";@5;50///@;S FBFPPSC="""";51///@;S FBFPPCL="""";@55"
"RTN","FBCHPET",71,0)
 S DR(1,162.03,5)="@5;K DIE(""NO^"");W !,""Exit ('^') allowed now"";26;S PRC(""SITE"")=X;8;13;Q;33;49"
"RTN","FBCHPET",72,0)
 S DR(1,162.03,6)="15;16;17////^S X=1"
"RTN","FBCHPET",73,0)
 S DR(1,162.03,7)="@7;K FBRRMKD;M FBRRMKD=FBRRMK;S FBX=$$RR^FBUTL4(.FBRRMK,2,,.FBRRMKD)"
"RTN","FBCHPET",74,0)
 S DIE=FBZ
"RTN","FBCHPET",75,0)
 D
"RTN","FBCHPET",76,0)
 . N ICPTVDT,ICDVDT S (ICPTVDT,ICDVDT)=$G(FBAADT) D ^DIE
"RTN","FBCHPET",77,0)
 ; if adjustment data changed then file
"RTN","FBCHPET",78,0)
 I $$ADJL^FBUTL2(.FBADJ)'=FBADJL(0) D FILEADJ^FBAAFA(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBADJ)
"RTN","FBCHPET",79,0)
 ; if remit remark data changed then file
"RTN","FBCHPET",80,0)
 I $$RRL^FBUTL4(.FBRRMK)'=FBRRMKL(0) D FILERR^FBAAFR(FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",.FBRRMK)
"RTN","FBCHPET",81,0)
 ; if FPPS CLAIM ID changed, update other line items on invoice
"RTN","FBCHPET",82,0)
 I FBFPPSC'=FBFPPSC(0) D
"RTN","FBCHPET",83,0)
 . N FBAAIN
"RTN","FBCHPET",84,0)
 . S FBAAIN=$$GET1^DIQ(162.03,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",",14)
"RTN","FBCHPET",85,0)
 . D CKINVEDI^FBAAPET1(FBFPPSC(0),FBFPPSC,FBAAIN,FBDA_","_FBDA(1)_","_FBDA(2)_","_FBDA(3)_",")
"RTN","FBCHPET",86,0)
 K FBSV W !! G SERV
"RTN","FBCHPET",87,0)
END K DR,DIC,DIE,X,DFN,FBVD,FBSD,BAT,FBSV,DA,FBDA,FBZ,FBDUZ,FBAACP,FBFY,FY,FBAMTPD,J,K,Y,PRC,FBHOLDX,ZZ,FBAADT,FBV,FBSDI,FBAACPI
"RTN","FBCHPET",88,0)
 K FBAAMM,FBAAMM1,FBFSAMT,FBFSUSD,FBMODA,FBZIP,FBTIME,FBHCFA(30)
"RTN","FBCHPET",89,0)
 K FBAAPTC,FB1725
"RTN","FBCHPET",90,0)
 K FBADJ,FBADJD,FBADJL,FBRRMK,FBRRMKD,FBRRMKL,FBX,FBUNITS
"RTN","FBCHPET",91,0)
 Q
"RTN","FBXIP116")
0^18^B32794794^n/a
"RTN","FBXIP116",1,0)
FBXIP116 ;DALOI/KML-PATCH INSTALL ROUTINE ; 11/19/2010
"RTN","FBXIP116",2,0)
 ;;3.5;FEE BASIS;**116**;JAN 30, 1995;Build 30
"RTN","FBXIP116",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBXIP116",4,0)
 ;
"RTN","FBXIP116",5,0)
 Q:'$G(XPDENV)  ; routine is to be called only during install package option
"RTN","FBXIP116",6,0)
 ; check for invoices totaling $0 that exist in batches that are "in-process"
"RTN","FBXIP116",7,0)
 ; batches to examine are those that are in statuses of:
"RTN","FBXIP116",8,0)
 ; "C" = CLERK CLOSED 
"RTN","FBXIP116",9,0)
 ; "R" = REVIEWED AFTER PRICER
"RTN","FBXIP116",10,0)
 ; "S" = SUPERVISOR CLOSED
"RTN","FBXIP116",11,0)
 ; if any zero dollar invoices exist 
"RTN","FBXIP116",12,0)
 ; the invoices will need to be reported and the patch install cannot occur
"RTN","FBXIP116",13,0)
 W !,"Environmental check routine is executing."
"RTN","FBXIP116",14,0)
 N DD,DO,DIE,DR,X,Y
"RTN","FBXIP116",15,0)
 N FBSTAT,FBX,FB0,FBT,FBN,FBBATCH,FBINV
"RTN","FBXIP116",16,0)
 K ^TMP("FBXIP116")
"RTN","FBXIP116",17,0)
 F FBSTAT="C","R","S" D
"RTN","FBXIP116",18,0)
 . S FBN=0
"RTN","FBXIP116",19,0)
 . F  S FBN=$O(^FBAA(161.7,"AC",FBSTAT,FBN)) Q:'FBN  D
"RTN","FBXIP116",20,0)
 . . S FB0=$G(^FBAA(161.7,FBN,0))
"RTN","FBXIP116",21,0)
 . . S FBT=$P(FB0,U,3),FBBATCH=$P(FB0,U)
"RTN","FBXIP116",22,0)
 . . I FBT]"","B3,B5,B9"[FBT D @FBT
"RTN","FBXIP116",23,0)
 I $D(FBINV) D GZERO
"RTN","FBXIP116",24,0)
 I $D(XPDABORT) W !,$C(7),"There are invoices that need further processing before installation of patch can be performed.",!,"Installation of patch has terminated"
"RTN","FBXIP116",25,0)
 Q
"RTN","FBXIP116",26,0)
 ;
"RTN","FBXIP116",27,0)
B3 ; process outpatient/ancillary batch
"RTN","FBXIP116",28,0)
 Q:FBT'="B3"
"RTN","FBXIP116",29,0)
 N DA,FBAAIN,FBAMTPD,FBY0
"RTN","FBXIP116",30,0)
 ; loop thru items in batch and build list of invoices and their $
"RTN","FBXIP116",31,0)
 S DA(3)=0 F  S DA(3)=$O(^FBAAC("AC",FBN,DA(3))) Q:'DA(3)  D
"RTN","FBXIP116",32,0)
 . S DA(2)=0 F  S DA(2)=$O(^FBAAC("AC",FBN,DA(3),DA(2))) Q:'DA(2)  D
"RTN","FBXIP116",33,0)
 . . S DA(1)=0
"RTN","FBXIP116",34,0)
 . . F  S DA(1)=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1))) Q:'DA(1)  D
"RTN","FBXIP116",35,0)
 . . . S DA=0
"RTN","FBXIP116",36,0)
 . . . F  S DA=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1),DA)) Q:'DA  D
"RTN","FBXIP116",37,0)
 . . . . S FBY0=$G(^FBAAC(DA(3),1,DA(2),1,DA(1),1,DA,0))
"RTN","FBXIP116",38,0)
 . . . . S FBAAIN=$P(FBY0,U,16)
"RTN","FBXIP116",39,0)
 . . . . S FBAMTPD=$P(FBY0,U,3)
"RTN","FBXIP116",40,0)
 . . . . I FBAAIN]"" S FBINV(3,FBBATCH,FBAAIN)=$G(FBINV(3,FBBATCH,FBAAIN))+FBAMTPD
"RTN","FBXIP116",41,0)
 Q
"RTN","FBXIP116",42,0)
 ;
"RTN","FBXIP116",43,0)
B5 ; processes pharmacy batch
"RTN","FBXIP116",44,0)
 Q:FBT'="B5"
"RTN","FBXIP116",45,0)
 N DA,FBAAIN,FBAMTPD,FBRXY0,FBY0
"RTN","FBXIP116",46,0)
 ;
"RTN","FBXIP116",47,0)
 ; loop thru items in batch and build list of invoices and their $
"RTN","FBXIP116",48,0)
 S DA(1)=0 F  S DA(1)=$O(^FBAA(162.1,"AE",FBN,DA(1))) Q:'DA(1)  D
"RTN","FBXIP116",49,0)
 . S DA=0 F  S DA=$O(^FBAA(162.1,"AE",FBN,DA(1),DA)) Q:'DA  D
"RTN","FBXIP116",50,0)
 . . S FBY0=$G(^FBAA(162.1,DA(1),0))
"RTN","FBXIP116",51,0)
 . . S FBRXY0=$G(^FBAA(162.1,DA(1),"RX",DA,0))
"RTN","FBXIP116",52,0)
 . . S FBAAIN=$P(FBY0,U)
"RTN","FBXIP116",53,0)
 . . S FBAMTPD=$P(FBRXY0,U,16)
"RTN","FBXIP116",54,0)
 . . I FBAAIN]"" S FBINV(5,FBBATCH,FBAAIN)=$G(FBINV(5,FBBATCH,FBAAIN))+FBAMTPD
"RTN","FBXIP116",55,0)
 Q
"RTN","FBXIP116",56,0)
 ;
"RTN","FBXIP116",57,0)
B9 ; processes inpatient batch
"RTN","FBXIP116",58,0)
 Q:FBT'="B9"
"RTN","FBXIP116",59,0)
 N DA,FBAAIN,FBAMTPD,FBY0
"RTN","FBXIP116",60,0)
 ;
"RTN","FBXIP116",61,0)
 ; loop thru items in batch and save zero dollar invoices
"RTN","FBXIP116",62,0)
 S DA=0 F  S DA=$O(^FBAAI("AC",FBN,DA)) Q:'DA  D
"RTN","FBXIP116",63,0)
 . S FBY0=$G(^FBAAI(DA,0))
"RTN","FBXIP116",64,0)
 . S FBAAIN=$P(FBY0,U)
"RTN","FBXIP116",65,0)
 . S FBAMTPD=$P(FBY0,U,9)
"RTN","FBXIP116",66,0)
 . Q:+FBAMTPD>0
"RTN","FBXIP116",67,0)
 . S FBINV(9,FBBATCH,FBAAIN)=""
"RTN","FBXIP116",68,0)
 Q
"RTN","FBXIP116",69,0)
 ;
"RTN","FBXIP116",70,0)
GZERO ; loop thru invoices and save invoices with 0.00 payment
"RTN","FBXIP116",71,0)
 N FBT,FBAAIN,FBBN
"RTN","FBXIP116",72,0)
 S (FBBN,FBAAIN)=0
"RTN","FBXIP116",73,0)
 F FBT=3,5,9 D
"RTN","FBXIP116",74,0)
 . F  S FBBN=$O(FBINV(FBT,FBBN)) Q:FBBN=""  D
"RTN","FBXIP116",75,0)
 . . F  S FBAAIN=$O(FBINV(FBT,FBBN,FBAAIN)) Q:FBAAIN=""  D
"RTN","FBXIP116",76,0)
 . . . I +FBINV(FBT,FBBN,FBAAIN)'>0 S FBINV(FBT,FBBN,FBAAIN)="" Q
"RTN","FBXIP116",77,0)
 . . . K FBINV(FBT,FBBN,FBAAIN)
"RTN","FBXIP116",78,0)
 I $D(FBINV) S XPDABORT=2 D BULLETIN
"RTN","FBXIP116",79,0)
 Q
"RTN","FBXIP116",80,0)
 ;
"RTN","FBXIP116",81,0)
BULLETIN ;
"RTN","FBXIP116",82,0)
 N FBT,FBI,FBBN,FBL,FBTYP
"RTN","FBXIP116",83,0)
 S ^TMP("FBXIP116",$J,1)="The Fee Basis patch FB*3.5*116 did not get installed because there exist"
"RTN","FBXIP116",84,0)
 S ^TMP("FBXIP116",$J,2)="invoice(s) in Fee Basis payment batches that have a total AMOUNT PAID of "
"RTN","FBXIP116",85,0)
 S ^TMP("FBXIP116",$J,3)="$0.00.  Once patch 116 is installed the system will not allow an invoice"
"RTN","FBXIP116",86,0)
 S ^TMP("FBXIP116",$J,4)="that totals $0.  The patch will also begin the transmission of 0.00"
"RTN","FBXIP116",87,0)
 S ^TMP("FBXIP116",$J,5)="payment lines to Central Fee in Austin; however, $0 invoices are not"
"RTN","FBXIP116",88,0)
 S ^TMP("FBXIP116",$J,6)="accepted by FMS.  There are one or two actions that must be taken before"
"RTN","FBXIP116",89,0)
 S ^TMP("FBXIP116",$J,7)="patch 116 can be installed on your system:"
"RTN","FBXIP116",90,0)
 S ^TMP("FBXIP116",$J,8)="1.  Execute the Queue Data for Transmission option to transmit the"
"RTN","FBXIP116",91,0)
 S ^TMP("FBXIP116",$J,9)="    batches with the $0 invoices since pre-patched software will prevent"
"RTN","FBXIP116",92,0)
 S ^TMP("FBXIP116",$J,10)="    $0 payment lines from being transmitted to Central Fee."
"RTN","FBXIP116",93,0)
 S ^TMP("FBXIP116",$J,11)="2.  If a given batch is in a pre-released state ('CLOSED' or 'REVIEWED"
"RTN","FBXIP116",94,0)
 S ^TMP("FBXIP116",$J,12)="    AFTER PRICER'), the batch can be re-opened and the invoice(s) can be"
"RTN","FBXIP116",95,0)
 S ^TMP("FBXIP116",$J,13)="    edited to have an AMOUNT PAID greater than 0.00 or the invoice(s)"
"RTN","FBXIP116",96,0)
 S ^TMP("FBXIP116",$J,14)="    will need to be removed from the associated batch."
"RTN","FBXIP116",97,0)
 S ^TMP("FBXIP116",$J,15)=""
"RTN","FBXIP116",98,0)
 S ^TMP("FBXIP116",$J,16)="Once the invoices have been reconciled, the Fee Basis patch can be installed."
"RTN","FBXIP116",99,0)
 S ^TMP("FBXIP116",$J,17)=""
"RTN","FBXIP116",100,0)
 S ^TMP("FBXIP116",$J,18)="            Invoice(s) Totaling Zero Dollars"
"RTN","FBXIP116",101,0)
 S ^TMP("FBXIP116",$J,19)="Batch Type          Batch       Invoice"
"RTN","FBXIP116",102,0)
 S ^TMP("FBXIP116",$J,20)="====================================================="
"RTN","FBXIP116",103,0)
 S FBL=20,(FBBN,FBI)=0
"RTN","FBXIP116",104,0)
 F FBT=3,5,9 D
"RTN","FBXIP116",105,0)
 . S FBTYP=$S(FBT=3:"Medical Fee",FBT=5:"Pharmacy",FBT=9:"Civil Hospital",1:"*****")
"RTN","FBXIP116",106,0)
 . I $D(FBINV(FBT)) F  S FBBN=$O(FBINV(FBT,FBBN)) Q:'FBBN  D
"RTN","FBXIP116",107,0)
 . . F  S FBI=$O(FBINV(FBT,FBBN,FBI)) Q:'FBI  D
"RTN","FBXIP116",108,0)
 . . . S FBL=FBL+1,^TMP("FBXIP116",$J,FBL)=FBTYP_"      "_FBBN_"        "_FBI
"RTN","FBXIP116",109,0)
 D SENDMAIL
"RTN","FBXIP116",110,0)
 Q
"RTN","FBXIP116",111,0)
 ;
"RTN","FBXIP116",112,0)
SENDMAIL ;
"RTN","FBXIP116",113,0)
 N DIFROM,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","FBXIP116",114,0)
 S XMSUB="FB*3.5*116 - Zero Dollar Invoices exist."
"RTN","FBXIP116",115,0)
 S XMDUZ=.5
"RTN","FBXIP116",116,0)
 S XMTEXT="^TMP(""FBXIP116"",$J,"
"RTN","FBXIP116",117,0)
 S XMY("G.FEE")="",XMY(DUZ)=""
"RTN","FBXIP116",118,0)
 D ^XMD
"RTN","FBXIP116",119,0)
 Q
"RTN","FBXIP116",120,0)
 ;
"RTN","FBXIP116",121,0)
TEST ; loop thru invoices and save invoices with 0.00 payment
"RTN","FBXIP116",122,0)
 S CNT=0,BN=12300,INV=17900
"RTN","FBXIP116",123,0)
 F FBT=3,5,9 D
"RTN","FBXIP116",124,0)
 . F I=1:1:25 S CNT=CNT+1,BN=BN+CNT,INV=INV+CNT,FBINV(FBT,BN,INV)=""
"RTN","FBXIP116",125,0)
 D BULLETIN
"RTN","FBXIP116",126,0)
 Q
"RTN","FBXIP116",127,0)
 ;
"RTN","FBXIP116",128,0)
 ;FBXIP116
"VER")
8.0^22.0
"BLD",8136,6)
^104
**END**
**END**
