Released FB*3.5*117 SEQ #105
Extracted from mail message
**KIDS**:FB*3.5*117^

**INSTALL NAME**
FB*3.5*117
"BLD",8250,0)
FB*3.5*117^FEE BASIS^0^3110411^y
"BLD",8250,1,0)
^^4^4^3110411^
"BLD",8250,1,1,0)
This patch enhances VistA Fee Basis to enforce segregation of duties when
"BLD",8250,1,2,0)
payments are certified.  This patch also adds the new FB SEG DUTY RPT
"BLD",8250,1,3,0)
option and modifies the batch purge functionality to require the date to
"BLD",8250,1,4,0)
be at least 18 months ago.
"BLD",8250,4,0)
^9.64PA^161.7^1
"BLD",8250,4,161.7,0)
161.7
"BLD",8250,4,161.7,2,0)
^9.641^161.7^1
"BLD",8250,4,161.7,2,161.7,0)
FEE BASIS BATCH  (File-top level)
"BLD",8250,4,161.7,2,161.7,1,0)
^9.6411^5^1
"BLD",8250,4,161.7,2,161.7,1,5,0)
DATE SUPERVISOR CLOSED
"BLD",8250,4,161.7,222)
y^n^p^^^^n^^n
"BLD",8250,4,161.7,224)

"BLD",8250,4,"APDD",161.7,161.7)

"BLD",8250,4,"APDD",161.7,161.7,5)

"BLD",8250,4,"B",161.7,161.7)

"BLD",8250,6)
3^
"BLD",8250,6.3)
9
"BLD",8250,"INIT")
PS^FBXIP117
"BLD",8250,"KRN",0)
^9.67PA^779.2^20
"BLD",8250,"KRN",.4,0)
.4
"BLD",8250,"KRN",.401,0)
.401
"BLD",8250,"KRN",.402,0)
.402
"BLD",8250,"KRN",.403,0)
.403
"BLD",8250,"KRN",.5,0)
.5
"BLD",8250,"KRN",.84,0)
.84
"BLD",8250,"KRN",3.6,0)
3.6
"BLD",8250,"KRN",3.8,0)
3.8
"BLD",8250,"KRN",9.2,0)
9.2
"BLD",8250,"KRN",9.8,0)
9.8
"BLD",8250,"KRN",9.8,"NM",0)
^9.68A^5^4
"BLD",8250,"KRN",9.8,"NM",1,0)
FBAASCB^^0^B26810368
"BLD",8250,"KRN",9.8,"NM",2,0)
FBCHSCB^^0^B7320590
"BLD",8250,"KRN",9.8,"NM",4,0)
FBAASDR^^0^B85549111
"BLD",8250,"KRN",9.8,"NM",5,0)
FBAABPG^^0^B14141003
"BLD",8250,"KRN",9.8,"NM","B","FBAABPG",5)

"BLD",8250,"KRN",9.8,"NM","B","FBAASCB",1)

"BLD",8250,"KRN",9.8,"NM","B","FBAASDR",4)

"BLD",8250,"KRN",9.8,"NM","B","FBCHSCB",2)

"BLD",8250,"KRN",19,0)
19
"BLD",8250,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",8250,"KRN",19,"NM",1,0)
FB SEG DUTY RPT^^0
"BLD",8250,"KRN",19,"NM",2,0)
FBAA SUPERVISOR OPTIONS^^2
"BLD",8250,"KRN",19,"NM","B","FB SEG DUTY RPT",1)

"BLD",8250,"KRN",19,"NM","B","FBAA SUPERVISOR OPTIONS",2)

"BLD",8250,"KRN",19.1,0)
19.1
"BLD",8250,"KRN",101,0)
101
"BLD",8250,"KRN",409.61,0)
409.61
"BLD",8250,"KRN",771,0)
771
"BLD",8250,"KRN",779.2,0)
779.2
"BLD",8250,"KRN",870,0)
870
"BLD",8250,"KRN",8989.51,0)
8989.51
"BLD",8250,"KRN",8989.52,0)
8989.52
"BLD",8250,"KRN",8994,0)
8994
"BLD",8250,"KRN","B",.4,.4)

"BLD",8250,"KRN","B",.401,.401)

"BLD",8250,"KRN","B",.402,.402)

"BLD",8250,"KRN","B",.403,.403)

"BLD",8250,"KRN","B",.5,.5)

"BLD",8250,"KRN","B",.84,.84)

"BLD",8250,"KRN","B",3.6,3.6)

"BLD",8250,"KRN","B",3.8,3.8)

"BLD",8250,"KRN","B",9.2,9.2)

"BLD",8250,"KRN","B",9.8,9.8)

"BLD",8250,"KRN","B",19,19)

"BLD",8250,"KRN","B",19.1,19.1)

"BLD",8250,"KRN","B",101,101)

"BLD",8250,"KRN","B",409.61,409.61)

"BLD",8250,"KRN","B",771,771)

"BLD",8250,"KRN","B",779.2,779.2)

"BLD",8250,"KRN","B",870,870)

"BLD",8250,"KRN","B",8989.51,8989.51)

"BLD",8250,"KRN","B",8989.52,8989.52)

"BLD",8250,"KRN","B",8994,8994)

"BLD",8250,"QDEF")
^^^^^^^^^^YES
"BLD",8250,"QUES",0)
^9.62^^
"BLD",8250,"REQB",0)
^9.611^3^3
"BLD",8250,"REQB",1,0)
PRC*5.1*152^2
"BLD",8250,"REQB",2,0)
FB*3.5*61^2
"BLD",8250,"REQB",3,0)
FB*3.5*116^2
"BLD",8250,"REQB","B","FB*3.5*116",3)

"BLD",8250,"REQB","B","FB*3.5*61",2)

"BLD",8250,"REQB","B","PRC*5.1*152",1)

"FIA",161.7)
FEE BASIS BATCH
"FIA",161.7,0)
^FBAA(161.7,
"FIA",161.7,0,0)
161.7I
"FIA",161.7,0,1)
y^n^p^^^^n^^n
"FIA",161.7,0,10)

"FIA",161.7,0,11)

"FIA",161.7,0,"RLRO")

"FIA",161.7,0,"VR")
3.5^FB
"FIA",161.7,161.7)
1
"FIA",161.7,161.7,5)

"INIT")
PS^FBXIP117
"KRN",19,441,-1)
2^2
"KRN",19,441,0)
FBAA SUPERVISOR OPTIONS^Supervisor Main Menu^^M^.5^FBAASUPERVISOR^^^^^^
"KRN",19,441,10,0)
^19.01IP^29^29
"KRN",19,441,10,29,0)
13364
"KRN",19,441,10,29,"^")
FB SEG DUTY RPT
"KRN",19,441,"U")
SUPERVISOR MAIN MENU
"KRN",19,13364,-1)
0^1
"KRN",19,13364,0)
FB SEG DUTY RPT^Fee Basis 1358 Segregation of Duty Report^^R^^^^^^^^FEE BASIS
"KRN",19,13364,1,0)
^^36^36^3110411^
"KRN",19,13364,1,1,0)
This report reviews fee invoice certification events and determines if 
"KRN",19,13364,1,2,0)
there was a segregation of duty violation.  The certifier of a fee invoice
"KRN",19,13364,1,3,0)
must not be the requestor, approving official, or obligator of the
"KRN",19,13364,1,4,0)
associated 1358 obligation or any increase/decrease adjustments to the
"KRN",19,13364,1,5,0)
1358 that were obligated before the invoice certification took place.
"KRN",19,13364,1,6,0)
 
"KRN",19,13364,1,7,0)
The release of a payment batch by a fee supervisor is the certification 
"KRN",19,13364,1,8,0)
event.  The report examines all payment batches that were released during 
"KRN",19,13364,1,9,0)
a specified period.  Each batch is associated with a single 1358. 
"KRN",19,13364,1,10,0)
 
"KRN",19,13364,1,11,0)
The results are sorted by 1358 and within that by the date and time of an 
"KRN",19,13364,1,12,0)
event.  Three event types may be listed.
"KRN",19,13364,1,13,0)
  Obligate - Initial obligation of the 1358 in IFCAP.
"KRN",19,13364,1,14,0)
  Adjust   - Obligation of an increase/decrease to the 1358 in IFCAP.
"KRN",19,13364,1,15,0)
  Certify  - Release of a fee payment batch associated with the 1358 
"KRN",19,13364,1,16,0)
             by a fee supervisor.  The batch number is shown.
"KRN",19,13364,1,17,0)
 
"KRN",19,13364,1,18,0)
The IFCAP events have three roles (requestor, approver, and obligator).
"KRN",19,13364,1,19,0)
 
"KRN",19,13364,1,20,0)
The specified reporting period is used to select released fee batches.  
"KRN",19,13364,1,21,0)
All prior IFCAP events for the 1358 are relevant to segregation to duty
"KRN",19,13364,1,22,0)
and will be considered even if they precede the reporting period.
"KRN",19,13364,1,23,0)
 
"KRN",19,13364,1,24,0)
If YES is entered at the "Only list 1358s with a violation (Y/N)?" prompt,
"KRN",19,13364,1,25,0)
only 1358s with at least one violation will be displayed.  Additionally,
"KRN",19,13364,1,26,0)
the fee certifications (batch release) that do not violate segregation of
"KRN",19,13364,1,27,0)
duties will not be displayed.  IFCAP and Fee Basis have been enhanced 
"KRN",19,13364,1,28,0)
by patches PRC*5.1*148 and FB*3.5*117 to enforce segregation of duties for
"KRN",19,13364,1,29,0)
a 1358 so no violations are expected after installation of those patches.
"KRN",19,13364,1,30,0)
 
"KRN",19,13364,1,31,0)
The Fee Basis batch data can optionally be purged by a site.  The IFCAP 
"KRN",19,13364,1,32,0)
data is normally retained for at least 7 years, but must be purged prior 
"KRN",19,13364,1,33,0)
to 10 years since the document numbers are recycled. If the source data
"KRN",19,13364,1,34,0)
for this report has been purged, it will not be included in the report.  
"KRN",19,13364,1,35,0)
Selection of a period starting 9 or more years ago may return inaccurate 
"KRN",19,13364,1,36,0)
results due to recycling of 1358 document numbers.
"KRN",19,13364,25)
FBAASDR
"KRN",19,13364,"U")
FEE BASIS 1358 SEGREGATION OF 
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",60,-1)
1^1
"PKG",60,0)
FEE BASIS^FB^Used to pay private vendors
"PKG",60,20,0)
^9.402P^1^1
"PKG",60,20,1,0)
2^^FBPMRG
"PKG",60,20,1,1)

"PKG",60,20,"B",2,1)

"PKG",60,22,0)
^9.49I^1^1
"PKG",60,22,1,0)
3.5^2950130^2950313
"PKG",60,22,1,"PAH",1,0)
117^3110411^12222
"PKG",60,22,1,"PAH",1,1,0)
^^4^4^3110411
"PKG",60,22,1,"PAH",1,1,1,0)
This patch enhances VistA Fee Basis to enforce segregation of duties when
"PKG",60,22,1,"PAH",1,1,2,0)
payments are certified.  This patch also adds the new FB SEG DUTY RPT
"PKG",60,22,1,"PAH",1,1,3,0)
option and modifies the batch purge functionality to require the date to
"PKG",60,22,1,"PAH",1,1,4,0)
be at least 18 months ago.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","FBAABPG")
0^5^B14141003^B14762556
"RTN","FBAABPG",1,0)
FBAABPG ;AISC/DMK - PURGE BATCH FILE ;11/15/2010
"RTN","FBAABPG",2,0)
 ;;3.5;FEE BASIS;**117**;JAN 30, 1995;Build 9
"RTN","FBAABPG",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAABPG",4,0)
 I $S('($D(DUZ)#2):1,'($D(DUZ(0))#2):1,'DUZ:1,1:0) W *7,!!,"DUZ and DUZ(0) must be defined as a valid user to run the batch purge.",!! Q
"RTN","FBAABPG",5,0)
 I DUZ(0)'="@" W *7,!!,"You must have programmer access (DUZ(0)='@') before running the batch purge.",!! Q
"RTN","FBAABPG",6,0)
 D DT^DICRW S Y=DT D PDF^FBAAUTL S FBPGDT=Y
"RTN","FBAABPG",7,0)
 I '$D(^FBAA(161.7,"AF")) W !,*7,?7,"There are no batches finalized !!" Q
"RTN","FBAABPG",8,0)
RD W !,"This option is used to purge Fee Basis batch numbers that were"
"RTN","FBAABPG",9,0)
 W !,"finalized before a specified date (at least 18 months ago)."
"RTN","FBAABPG",10,0)
SETDT W ! S %DT="AEP",%DT(0)=("-"_$$FMADD^XLFDT(DT,-549)) ; IA #10103
"RTN","FBAABPG",11,0)
 S %DT("A")="Purge batch #'s PRIOR to date : "
"RTN","FBAABPG",12,0)
 D ^%DT G:Y<0 END K %DT S PDAT=Y
"RTN","FBAABPG",13,0)
 ;
"RTN","FBAABPG",14,0)
 S DIR(0)="Y",DIR("A")="Do you want to continue",DIR("B")="NO"
"RTN","FBAABPG",15,0)
 S DIR("?")="Answer ""Yes"" if you wish to proceed with Fee Basis batch number purging!"
"RTN","FBAABPG",16,0)
 D ^DIR K DIR I 'Y!$D(DIRUT) G END
"RTN","FBAABPG",17,0)
 ;
"RTN","FBAABPG",18,0)
 S VAR="PDAT^FBPGDT",VAL=PDAT_"^"_FBPGDT,PGM="START^FBAABPG" D ZIS^FBAAUTL G:FBPOP END
"RTN","FBAABPG",19,0)
START U IO W:$E(IOST,1,2)="C-" @IOF W ?15,"*** BEGIN FEE BASIS BATCH NUMBER PURGE ***",!!! S CNT=0
"RTN","FBAABPG",20,0)
 F PD=0:0 S PD=$O(^FBAA(161.7,"AF",PD)) Q:PD'>0!(PD'<PDAT)  F I=0:0 S I=$O(^FBAA(161.7,"AF",PD,I)) Q:I'>0  I $D(^FBAA(161.7,I,0)) D MORE
"RTN","FBAABPG",21,0)
 G PRT
"RTN","FBAABPG",22,0)
MORE S Y(0)=^FBAA(161.7,I,0),B=$P(Y(0),"^",1),FBTYPE=$P(Y(0),"^",3),FBDUZ=$P(Y(0),"^",5) D MEDP:FBTYPE="B3",TRAVP:FBTYPE="B2",RPHP:FBTYPE="B5",CHP:FBTYPE="B9"
"RTN","FBAABPG",23,0)
 Q
"RTN","FBAABPG",24,0)
MEDP F J=0:0 S J=$O(^FBAAC("AC",I,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("AC",I,J,K)) Q:K'>0  F L=0:0 S L=$O(^FBAAC("AC",I,J,K,L)) Q:L'>0  F M=0:0 S M=$O(^FBAAC("AC",I,J,K,L,M)) Q:M'>0  I $D(^FBAAC(J,1,K,1,L,1,M,0)) S $P(^(0),"^",8)=""
"RTN","FBAABPG",25,0)
 K ^FBAAC("AC",I) D GOT Q
"RTN","FBAABPG",26,0)
TRAVP F J=0:0 S J=$O(^FBAAC("AD",I,J)) Q:J'>0  F K=0:0 S K=$O(^FBAAC("AD",I,J,K)) Q:K'>0  I $D(^FBAAC(J,3,K,0)) S $P(^(0),"^",2)=""
"RTN","FBAABPG",27,0)
 K ^FBAAC("AD",I) D GOT Q
"RTN","FBAABPG",28,0)
RPHP F J=0:0 S J=$O(^FBAA(162.1,"AE",I,J)) Q:J'>0  F K=0:0 S K=$O(^FBAA(162.1,"AE",I,J,K)) Q:K'>0  I $D(^FBAA(162.1,J,"RX",K,0)) S $P(^(0),"^",17)=""
"RTN","FBAABPG",29,0)
 K ^FBAA(162.1,"AE",I),^FBAA(162.1,"AJ",I) D GOT Q
"RTN","FBAABPG",30,0)
GOT S CNT=CNT+1 W "." S DIK="^FBAA(161.7,",DA=I D ^DIK Q
"RTN","FBAABPG",31,0)
PRT I CNT=0 W !!,?10,"There are no batch numbers to purge for this time frame !! " G END
"RTN","FBAABPG",32,0)
 W:CNT>0 !!,?10,"This option has purged  ",CNT,"  batch numbers",!!,?16,"finalized prior to  ",$E(PDAT,4,5)_"/"_$E(PDAT,6,7)_"/"_$E(PDAT,2,3)," ."
"RTN","FBAABPG",33,0)
 S ^FBAA(161.4,1,"PURGE")=DT
"RTN","FBAABPG",34,0)
 W !!!!,?15,"***  FEE BASIS BATCH NUMBER PURGE FINISHED ***"
"RTN","FBAABPG",35,0)
 S XMB(1)=$S($D(^VA(200,DUZ,0)):$P(^(0),"^",1),1:"Unknown User"),XMB(2)=FBPGDT,Y=PDAT D PDF^FBAAUTL S XMB(3)=Y,XMB(4)=CNT,XMB="FBAA BATCH PURGE" D ^XMB
"RTN","FBAABPG",36,0)
END K I,J,K,L,M,Y,DA,D0,D1,CNT,DIC,DIRUT,DIW,DIWL,DIWT,DN,X,DIK,PDAT,VAR,VAL,FBPGDT,FBTYPE,B,PD,PGM,FBDUZ,XM1,XMA,XMDT,XMM,XMB D CLOSE^FBAAUTL Q
"RTN","FBAABPG",37,0)
CHP F J=0:0 S J=$O(^FBAAI("AC",I,J)) Q:J'>0  I $D(^FBAAI(J,0)),'$D(^("FBREJ")) S $P(^FBAAI(J,0),"^",17)=""
"RTN","FBAABPG",38,0)
 K ^FBAAI("AC",I),^FBAAI("AE",I) D GOT Q
"RTN","FBAASCB")
0^1^B26810368^B23609721
"RTN","FBAASCB",1,0)
FBAASCB ;AISC/GRR - SUPERVISOR RELEASE ;12/20/2010
"RTN","FBAASCB",2,0)
 ;;3.5;FEE BASIS;**38,61,116,117**;JAN 30, 1995;Build 9
"RTN","FBAASCB",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAASCB",4,0)
 S FBERR=0 D DT^DICRW
"RTN","FBAASCB",5,0)
 I '$D(^FBAA(161.7,"AC","C"))&('$D(^FBAA(161.7,"AC","A"))) W !!,*7,"There are no batches Pending Release!" Q
"RTN","FBAASCB",6,0)
BT W !! S DIC="^FBAA(161.7,",DIC(0)="AEQ",DIC("S")="I ($G(^(""ST""))=""C""!($G(^(""ST""))=""A""))&('$G(^XTMP(""FBAASCB"",+Y)))" D ^DIC K DIC("S") G Q:X="^"!(X=""),BT:Y<0 S FBN=+Y,^XTMP("FBAASCB",FBN)=1
"RTN","FBAASCB",7,0)
 D LOCK^FBUCUTL("^FBAA(161.7,",FBN) I 'FBLOCK W !!,*7,"Try releasing batch at another time." D Q G FBAASCB
"RTN","FBAASCB",8,0)
 S FZ=^FBAA(161.7,FBN,0),FBTYPE=$P(FZ,"^",3),FBAAON=$P(FZ,"^",2),FBAAB=$P(FZ,"^")
"RTN","FBAASCB",9,0)
 I $G(FBTYPE)="B9",$P(FZ,"^",15)="Y",$P(^FBAA(161.7,FBN,"ST"),"^")="C",$P(FZ,"^",18)'="Y" W !!,*7,"Batch needs to be released to Pricer first.",! G Q
"RTN","FBAASCB",10,0)
 I $G(FBTYPE)="B9",$P(FZ,"^",15)="" S FBCNH=1
"RTN","FBAASCB",11,0)
 S FBSTAT=^FBAA(161.7,FBN,"ST"),FBSTAT=$S(FBSTAT="C":"S",FBSTAT="A":"R",1:FBSTAT)
"RTN","FBAASCB",12,0)
 S FBAAOB=$P(FZ,"^",8)_"-"_FBAAON,FBAAMT=$P(FZ,"^",9),FBCOMM="Release of batch "_FBAAB
"RTN","FBAASCB",13,0)
 I '$D(^XUSEC("FBAASUPERVISOR",DUZ)) W !!,*7,"Sorry, only Supervisor can Release batch!" D Q G FBAASCB
"RTN","FBAASCB",14,0)
 ; enforce segregation of duties (FB*3.5*117)
"RTN","FBAASCB",15,0)
 D UOKCERT^PRCEMOA(.FBUOK,FBAAOB,DUZ) ; IA #5573
"RTN","FBAASCB",16,0)
 I 'FBUOK D  D Q G FBAASCB
"RTN","FBAASCB",17,0)
 . W $C(7),!,$P(FBUOK,U,2) ; display text returned by IFCAP API
"RTN","FBAASCB",18,0)
 . I $P(FBUOK,U)="0" W !,"Due to segregation of duties, you cannot also certify an invoice for payment."
"RTN","FBAASCB",19,0)
 . I $P(FBUOK,U)="E" W !,"This 1358 error must be resolved before the batch can be released."
"RTN","FBAASCB",20,0)
 ;
"RTN","FBAASCB",21,0)
 S DA=FBN,DR="0;ST" W !! D EN^DIQ
"RTN","FBAASCB",22,0)
RD S B=FBN S DIR(0)="Y",DIR("A")="Want line items listed",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT) W:Y @IOF D:Y LIST^FBAACCB:FBTYPE="B3",LISTP^FBAACCB:FBTYPE="B5",LISTT^FBAACCB0:FBTYPE="B2",LISTC^FBAACCB1:FBTYPE="B9"
"RTN","FBAASCB",23,0)
RDD S DIR(0)="Y",DIR("A")="Do you want to Release Batch as Correct",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT) I 'Y W !!,"Batch has NOT been Released!",*7 D Q G FBAASCB
"RTN","FBAASCB",24,0)
 D WAIT^DICD I FBTYPE="B9" D ^FBAASCB0 G SHORT:$D(FBERR),FIN
"RTN","FBAASCB",25,0)
 D POST I $D(FBERR) G SHORT
"RTN","FBAASCB",26,0)
 G:FBTYPE="B5" FIN
"RTN","FBAASCB",27,0)
 G:FBTYPE="B9" FIN
"RTN","FBAASCB",28,0)
FIN ;
"RTN","FBAASCB",29,0)
 ; use FileMan to update fields 5 and 6, store date & time (FB*3.5*117)
"RTN","FBAASCB",30,0)
 S DA=FBN,DIE="^FBAA(161.7,"
"RTN","FBAASCB",31,0)
 S DR="11////^S X=FBSTAT;6////^S X=DUZ;5////^S X=$$NOW^XLFDT" D ^DIE
"RTN","FBAASCB",32,0)
 K DA,DIE,DIC,DR
"RTN","FBAASCB",33,0)
 D UCAUTOP
"RTN","FBAASCB",34,0)
 S DA=FBN,DR="0;ST",DIC="^FBAA(161.7," W !! D EN^DIQ W !!," Batch has been Released!"
"RTN","FBAASCB",35,0)
 D Q G FBAASCB
"RTN","FBAASCB",36,0)
Q I $G(FBN) K ^XTMP("FBAASCB",FBN) L -^FBAA(161.7,FBN)
"RTN","FBAASCB",37,0)
 K B,J,K,L,M,X,Y,Z,DIC,FBN,A,A1,A2,BE,CPTDESC,D0,DA,DL,DR,DRX,DX,FBAACB,FBAACPT,FBAAON,FBAAOUT,FBVP,FBIN,DK,N,XY,FBINOLD,FBINTOT,FBTYPE,FZ,P3,P4,Q,S,T,V,VID,ZS,FBAAB,FBAAMT,FBAAOB,FBCOMM,FBAUT,FBSITE,I,X,Y,Z,FBERR,DIRUT,FBSTAT,FBLOCK
"RTN","FBAASCB",38,0)
 K FBAC,FBAP,FBCNH,FBFD,FBI,FBLISTC,FBPDT,FBSC,FBTD,PRCSCPAN,DFN,FBINV
"RTN","FBAASCB",39,0)
 K FBUOK
"RTN","FBAASCB",40,0)
 Q
"RTN","FBAASCB",41,0)
SHORT ;
"RTN","FBAASCB",42,0)
 I '$D(FBINV) W !!,*7,"This batch CANNOT be released. Check your 1358.",!
"RTN","FBAASCB",43,0)
 L -^FBAA(161.7,FBN) D Q G FBAASCB
"RTN","FBAASCB",44,0)
POST ;FBAAOB=FULL OBLIGATION NUMBER(STA-CXXXXX)
"RTN","FBAASCB",45,0)
 ;FBCOMM=COMMENT FOR 1358
"RTN","FBAASCB",46,0)
 ;FBAAMT=TOTAL AMOUNT OF BATCH
"RTN","FBAASCB",47,0)
 ;FBAAB=BATCH NUMBER
"RTN","FBAASCB",48,0)
 ;IF CALL FAILS FBERR RETURNED=1
"RTN","FBAASCB",49,0)
 ;FBN added as 7th peice of 'X'. It is the interface ID
"RTN","FBAASCB",50,0)
 K FBERR
"RTN","FBAASCB",51,0)
 S PRCS("X")=FBAAOB,PRCS("TYPE")="FB" D EN3^PRCS58 I Y=-1 W !!,*7,?5,"1358 not available for posting!",! S FBERR=1 Q
"RTN","FBAASCB",52,0)
 D NOW^%DTC S X=FBAAOB_"^"_%_"^^"_FBAAMT_"^"_$S($L(FBAAB)<3:$$PADZ^FBAAV01(FBAAB,4),1:FBAAB)_"^"_FBCOMM_"^"_FBN_"^"_1,PRCS("TYPE")="FB" D EN2^PRCS58 I +Y=0 W !!,*7,Y,! S FBERR=1 Q
"RTN","FBAASCB",53,0)
 K PRCS("SITE"),PRCSI Q
"RTN","FBAASCB",54,0)
UCAUTOP ; Unauthorized Claims Autoprint
"RTN","FBAASCB",55,0)
 ; If unauthorized claims autoprint feature is enabled then check items
"RTN","FBAASCB",56,0)
 ; in batch and print an unauthorized claim disposition letter if all
"RTN","FBAASCB",57,0)
 ; payments for a claim have been released
"RTN","FBAASCB",58,0)
 ; input FBN    - batch ien
"RTN","FBAASCB",59,0)
 ;       FBTYPE - batch type
"RTN","FBAASCB",60,0)
 ;       FBCNH  - (opt) equals 1 if batch is for community nursing home
"RTN","FBAASCB",61,0)
 N DA,FBDA,FBORDER,FBUC,FBUCA,FBX
"RTN","FBAASCB",62,0)
 Q:"^B3^B5^B9^"'[(U_FBTYPE_U)  ; not an applicable batch type
"RTN","FBAASCB",63,0)
 Q:$G(FBCNH)=1  ; CNH batch won't have associated unauth claims
"RTN","FBAASCB",64,0)
 S FBUC=$$FBUC^FBUCUTL2(1)
"RTN","FBAASCB",65,0)
 Q:'$$PARAM^FBUCLET(FBUC)  ; autoprint feature not enabled
"RTN","FBAASCB",66,0)
 ;
"RTN","FBAASCB",67,0)
 ; loop thru items in batch to build list of unauthorized claims
"RTN","FBAASCB",68,0)
 K ^TMP("FBUC",$J)
"RTN","FBAASCB",69,0)
 I FBTYPE="B3" D  ; if outpatient/ancillary batch
"RTN","FBAASCB",70,0)
 . S DA(3)=0 F  S DA(3)=$O(^FBAAC("AC",FBN,DA(3))) Q:'DA(3)  D
"RTN","FBAASCB",71,0)
 . . S DA(2)=0 F  S DA(2)=$O(^FBAAC("AC",FBN,DA(3),DA(2))) Q:'DA(2)  D
"RTN","FBAASCB",72,0)
 . . . S DA(1)=0
"RTN","FBAASCB",73,0)
 . . . F  S DA(1)=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1))) Q:'DA(1)  D
"RTN","FBAASCB",74,0)
 . . . . S DA=0
"RTN","FBAASCB",75,0)
 . . . . F  S DA=$O(^FBAAC("AC",FBN,DA(3),DA(2),DA(1),DA)) Q:'DA  D
"RTN","FBAASCB",76,0)
 . . . . . S FBX=$P($G(^FBAAC(DA(3),1,DA(2),1,DA(1),1,DA,0)),U,13)
"RTN","FBAASCB",77,0)
 . . . . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",78,0)
 I FBTYPE="B5" D  ; if pharmacy batch
"RTN","FBAASCB",79,0)
 . S DA(1)=0 F  S DA(1)=$O(^FBAA(162.1,"AE",FBN,DA(1))) Q:'DA(1)  D
"RTN","FBAASCB",80,0)
 . . S DA=0 F  S DA=$O(^FBAA(162.1,"AE",FBN,DA(1),DA)) Q:'DA  D
"RTN","FBAASCB",81,0)
 . . . S FBX=$P($G(^FBAA(162.1,DA(1),"RX",DA,2)),U,6)
"RTN","FBAASCB",82,0)
 . . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",83,0)
 I FBTYPE="B9" D  ; if inpatient batch
"RTN","FBAASCB",84,0)
 . S DA=0 F  S DA=$O(^FBAAI("AC",FBN,DA)) Q:'DA  D
"RTN","FBAASCB",85,0)
 . . S FBX=$P($G(^FBAAI(DA,0)),U,5)
"RTN","FBAASCB",86,0)
 . . I FBX["FB583" S ^TMP("FBUC",$J,+FBX)=""
"RTN","FBAASCB",87,0)
 ;
"RTN","FBAASCB",88,0)
 ; loop thru unauthorized claim list and print letter when appropriate
"RTN","FBAASCB",89,0)
 S FBDA=0 F  S FBDA=$O(^TMP("FBUC",$J,FBDA)) Q:'FBDA  D
"RTN","FBAASCB",90,0)
 . Q:'$$PAYST^FBUCUTL(FBDA)  ; not all payments for claim released yet
"RTN","FBAASCB",91,0)
 . S FBUCA=$G(^FB583(FBDA,0))
"RTN","FBAASCB",92,0)
 . Q:$P(FBUCA,U,16)'=1  ; claim not flagged for printing
"RTN","FBAASCB",93,0)
 . S FBORDER=$$ORDER^FBUCUTL($P(FBUCA,U,24))
"RTN","FBAASCB",94,0)
 . D AUTO^FBUCLET(FBDA,FBORDER,FBUCA,FBUC) ; autoprint letter
"RTN","FBAASCB",95,0)
 ;
"RTN","FBAASCB",96,0)
 K ^TMP("FBUC",$J)
"RTN","FBAASCB",97,0)
 Q
"RTN","FBAASCB",98,0)
 ;
"RTN","FBAASDR")
0^4^B85549111^n/a
"RTN","FBAASDR",1,0)
FBAASDR ;WOIFO/SAB - FEE 1358 SEGREGATION OF DUTIES REPORT ;11/18/2010
"RTN","FBAASDR",2,0)
 ;;3.5;FEE BASIS;**117**;JAN 30, 1995;Build 9
"RTN","FBAASDR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBAASDR",4,0)
 ;
"RTN","FBAASDR",5,0)
 ; IAs
"RTN","FBAASDR",6,0)
 ;  #10003  DD^%DT
"RTN","FBAASDR",7,0)
 ;  #10000  NOW^%DTC
"RTN","FBAASDR",8,0)
 ;  #10086  %ZIS, HOME^%ZIS
"RTN","FBAASDR",9,0)
 ;  #10089  %ZISC
"RTN","FBAASDR",10,0)
 ;  #10063  %ZTLOAD, $$S^%ZTLOAD
"RTN","FBAASDR",11,0)
 ;  #2056   $$GET1^DIQ
"RTN","FBAASDR",12,0)
 ;  #10026  DIR
"RTN","FBAASDR",13,0)
 ;  #5574   $$EV1358^PRCEMOA
"RTN","FBAASDR",14,0)
 ;  #10103  $$FMADD^XLFDT, $$FMTE^XLFDT
"RTN","FBAASDR",15,0)
 ;  #5582   ^PRC(411,
"RTN","FBAASDR",16,0)
 ;
"RTN","FBAASDR",17,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,FBALL,FBDT1,FBDT2,%ZIS,POP,X,Y
"RTN","FBAASDR",18,0)
 ;
"RTN","FBAASDR",19,0)
 ; ask from date
"RTN","FBAASDR",20,0)
 S DIR(0)="D^::EX",DIR("A")="From Date"
"RTN","FBAASDR",21,0)
 ;   default from date is first day of previous month
"RTN","FBAASDR",22,0)
 S DIR("B")=$$FMTE^XLFDT($E($$FMADD^XLFDT($E(DT,1,5)_"01",-1),1,5)_"01")
"RTN","FBAASDR",23,0)
 D ^DIR K DIR G:$D(DIRUT) EXIT
"RTN","FBAASDR",24,0)
 S FBDT1=Y
"RTN","FBAASDR",25,0)
 ;
"RTN","FBAASDR",26,0)
 ; ask to date
"RTN","FBAASDR",27,0)
 S DIR(0)="DA^"_FBDT1_"::EX",DIR("A")="To Date: "
"RTN","FBAASDR",28,0)
 ;   default to date is last day of specified month
"RTN","FBAASDR",29,0)
 S X=FBDT1 D DAYS^FBAAUTL1
"RTN","FBAASDR",30,0)
 S DIR("B")=$$FMTE^XLFDT($E(FBDT1,1,5)_X)
"RTN","FBAASDR",31,0)
 D ^DIR K DIR G:$D(DIRUT) EXIT
"RTN","FBAASDR",32,0)
 S FBDT2=Y
"RTN","FBAASDR",33,0)
 ;
"RTN","FBAASDR",34,0)
 ; ask if all stations
"RTN","FBAASDR",35,0)
 S DIR(0)="Y",DIR("A")="For all stations",DIR("B")="YES"
"RTN","FBAASDR",36,0)
 D ^DIR K DIR G:$G(DIRUT) EXIT
"RTN","FBAASDR",37,0)
 S FBSTALL=Y
"RTN","FBAASDR",38,0)
 S FBSTN=""
"RTN","FBAASDR",39,0)
 ; if not all stations ask station
"RTN","FBAASDR",40,0)
 I 'FBSTALL D  G:FBSTN="" EXIT
"RTN","FBAASDR",41,0)
 . S FBSTN=""
"RTN","FBAASDR",42,0)
 . S DIC="^PRC(411,",DIC(0)="AQEM"
"RTN","FBAASDR",43,0)
 . D ^DIC Q:Y<0
"RTN","FBAASDR",44,0)
 . S FBSTN=$P(Y,U,2)
"RTN","FBAASDR",45,0)
 ;
"RTN","FBAASDR",46,0)
 ; ask if violations only
"RTN","FBAASDR",47,0)
 S DIR(0)="Y",DIR("A")="Only list 1358s with a violation (Y/N)"
"RTN","FBAASDR",48,0)
 S DIR("B")="YES"
"RTN","FBAASDR",49,0)
 D ^DIR K DIR G:$D(DIRUT) EXIT
"RTN","FBAASDR",50,0)
 S FBORV=Y
"RTN","FBAASDR",51,0)
 ;
"RTN","FBAASDR",52,0)
 ; ask device
"RTN","FBAASDR",53,0)
 S %ZIS="Q" D ^%ZIS G:POP EXIT
"RTN","FBAASDR",54,0)
 I $D(IO("Q")) D  G EXIT
"RTN","FBAASDR",55,0)
 . N ZTRTN,ZTDESC,ZTDTH,ZTIO,ZTUCI,ZTCPU,ZTPRI,ZTSAVE,ZTKIL,ZTSYNC,ZTSK
"RTN","FBAASDR",56,0)
 . S ZTRTN="QEN^FBAASDR",ZTDESC="Fee 1358 Segregation of Duty Report"
"RTN","FBAASDR",57,0)
 . F FBX="FBDT*","FBORV","FBSTALL","FBSTN" S ZTSAVE(FBX)=""
"RTN","FBAASDR",58,0)
 . D ^%ZTLOAD,HOME^%ZIS
"RTN","FBAASDR",59,0)
 ;
"RTN","FBAASDR",60,0)
QEN ; queued entry
"RTN","FBAASDR",61,0)
 U IO
"RTN","FBAASDR",62,0)
 ;
"RTN","FBAASDR",63,0)
GATHER ; collect and sort data
"RTN","FBAASDR",64,0)
 N %
"RTN","FBAASDR",65,0)
 K ^TMP($J)
"RTN","FBAASDR",66,0)
 ;
"RTN","FBAASDR",67,0)
 S FBC("CER")=0 ; initialize count of certifications
"RTN","FBAASDR",68,0)
 S FBC("OBL")=0 ; initialize count of obligations
"RTN","FBAASDR",69,0)
 S FBC("VIO")=0 ; initialize count of obligations with a violation
"RTN","FBAASDR",70,0)
 ;
"RTN","FBAASDR",71,0)
 ; find fee certification events during specified period
"RTN","FBAASDR",72,0)
 ; loop thru Fee Basis Batch by "ADS" x-ref (DATE SUPERVISOR CLOSED)
"RTN","FBAASDR",73,0)
 S FBDT=FBDT1-.000001
"RTN","FBAASDR",74,0)
 F  S FBDT=$O(^FBAA(161.7,"ADS",FBDT)) Q:FBDT=""!($P(FBDT,".")>FBDT2)  D
"RTN","FBAASDR",75,0)
 . S FBDA=0
"RTN","FBAASDR",76,0)
 . F  S FBDA=$O(^FBAA(161.7,"ADS",FBDT,FBDA)) Q:'FBDA  D
"RTN","FBAASDR",77,0)
 . . N FBSTB
"RTN","FBAASDR",78,0)
 . . S FBY0=$G(^FBAA(161.7,FBDA,0))
"RTN","FBAASDR",79,0)
 . . ;
"RTN","FBAASDR",80,0)
 . . ; skip batch that is only pricer released and not yet certified
"RTN","FBAASDR",81,0)
 . . ;  if TYPE = "B9" and CONTRACT HOSPITAL BATCH = "Y" and
"RTN","FBAASDR",82,0)
 . . ;     BATCH EXEMPT '= "Y" then STATUS must be R, T, or V to proceed
"RTN","FBAASDR",83,0)
 . . I $P(FBY0,U,3)="B9",$P(FBY0,U,15)="Y",$P(FBY0,U,18)'="Y","^R^T^V^"'[(U_$P($G(^FBAA(161.7,FBDA,"ST")),U)_U) Q
"RTN","FBAASDR",84,0)
 . . ;
"RTN","FBAASDR",85,0)
 . . S FBOB=$P(FBY0,U,8)_"-"_$P(FBY0,U,2) ; full 1358 obligation number
"RTN","FBAASDR",86,0)
 . . ;
"RTN","FBAASDR",87,0)
 . . ; if report not for all stations, skip batch from different station
"RTN","FBAASDR",88,0)
 . . I 'FBSTALL D  I FBSTB'=FBSTN Q
"RTN","FBAASDR",89,0)
 . . . S FBSTB=$$SUB^FBAAUTL5(FBOB)
"RTN","FBAASDR",90,0)
 . . . I FBSTB="" S FBSTB=+FBOB
"RTN","FBAASDR",91,0)
 . . ;
"RTN","FBAASDR",92,0)
 . . ; add event to ^TMP($J,1358 #,date/time,batch #)=certifier
"RTN","FBAASDR",93,0)
 . . S ^TMP($J,FBOB,FBDT,$P(FBY0,U))=$P(FBY0,U,7)
"RTN","FBAASDR",94,0)
 . . S FBC("CER")=FBC("CER")+1 ; incr count of certifications
"RTN","FBAASDR",95,0)
 ;
"RTN","FBAASDR",96,0)
 ; loop thru obligations and add IFCAP events and actors to ^TMP
"RTN","FBAASDR",97,0)
 S FBOB="" F  S FBOB=$O(^TMP($J,FBOB)) Q:FBOB=""  D
"RTN","FBAASDR",98,0)
 . S FBC("OBL")=FBC("OBL")+1 ; incr count of 1358s
"RTN","FBAASDR",99,0)
 . N FBARR,FBX
"RTN","FBAASDR",100,0)
 . S FBX=$$EV1358^PRCEMOA(FBOB,"FBARR")
"RTN","FBAASDR",101,0)
 . I FBX'=1 S ^TMP($J,FBOB)=FBX Q  ; error reported by the API
"RTN","FBAASDR",102,0)
 . S FBDT=""
"RTN","FBAASDR",103,0)
 . F  S FBDT=$O(FBARR(FBDT)) Q:FBDT=""!($P(FBDT,".")>FBDT2)  D
"RTN","FBAASDR",104,0)
 . . S FBEV="" F  S FBEV=$O(FBARR(FBDT,FBEV)) Q:FBEV=""  D
"RTN","FBAASDR",105,0)
 . . . S ^TMP($J,FBOB,FBDT,FBEV)=FBARR(FBDT,FBEV)
"RTN","FBAASDR",106,0)
 ;
"RTN","FBAASDR",107,0)
 ; loop thru obligations and add segregation of duty violations to ^TMP
"RTN","FBAASDR",108,0)
 S FBOB="" F  S FBOB=$O(^TMP($J,FBOB)) Q:FBOB=""  D
"RTN","FBAASDR",109,0)
 . Q:$P($G(^TMP($J,FBOB)),U)="E"  ; skip because missing IFCAP events
"RTN","FBAASDR",110,0)
 . ;
"RTN","FBAASDR",111,0)
 . N FBAPP,FBOBL,FBREQ,FBVIO
"RTN","FBAASDR",112,0)
 . S FBVIO=0 ; init violation flag for the 1358
"RTN","FBAASDR",113,0)
 . ; loop thru date/time stamps
"RTN","FBAASDR",114,0)
 . S FBDT="" F  S FBDT=$O(^TMP($J,FBOB,FBDT)) Q:FBDT=""  D
"RTN","FBAASDR",115,0)
 . . ; loop thru events
"RTN","FBAASDR",116,0)
 . . S FBEV="" F  S FBEV=$O(^TMP($J,FBOB,FBDT,FBEV)) Q:FBEV=""  D
"RTN","FBAASDR",117,0)
 . . . N FBX
"RTN","FBAASDR",118,0)
 . . . S FBX=$G(^TMP($J,FBOB,FBDT,FBEV))
"RTN","FBAASDR",119,0)
 . . . ; process fee certification event
"RTN","FBAASDR",120,0)
 . . . I FBEV D
"RTN","FBAASDR",121,0)
 . . . . ; check fo violation
"RTN","FBAASDR",122,0)
 . . . . I FBX,$D(FBREQ(FBX)) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V1")="User previously acted as requestor on a prior 1358 event."
"RTN","FBAASDR",123,0)
 . . . . I FBX,$D(FBAPP(FBX)) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V2")="User previously acted as approver on a prior 1358 event."
"RTN","FBAASDR",124,0)
 . . . . I FBX,$D(FBOBL(FBX)) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V3")="User previously acted as obligator on a prior 1358 event."
"RTN","FBAASDR",125,0)
 . . . ; process an IFCAP event
"RTN","FBAASDR",126,0)
 . . . I "^O^A^"[(U_FBEV_U) D
"RTN","FBAASDR",127,0)
 . . . . ; save IFCAP actors in lists
"RTN","FBAASDR",128,0)
 . . . . I $P(FBX,U,1) S FBREQ($P(FBX,U,1))=""
"RTN","FBAASDR",129,0)
 . . . . I $P(FBX,U,2) S FBAPP($P(FBX,U,2))=""
"RTN","FBAASDR",130,0)
 . . . . I $P(FBX,U,3) S FBOBL($P(FBX,U,3))=""
"RTN","FBAASDR",131,0)
 . . . . ; check for violation on IFCAP event
"RTN","FBAASDR",132,0)
 . . . . I $P(FBX,U,2)=$P(FBX,U,1) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V1")="Approver previously acted as requestor on this transaction."
"RTN","FBAASDR",133,0)
 . . . . I $P(FBX,U,3)=$P(FBX,U,1) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V2")="Obligator previously acted as requester on this transaction."
"RTN","FBAASDR",134,0)
 . . . . I $P(FBX,U,3)=$P(FBX,U,2) S FBVIO=1,^TMP($J,FBOB,FBDT,FBEV,"V3")="Obligator previously acted as approver on this transaction."
"RTN","FBAASDR",135,0)
 . ;
"RTN","FBAASDR",136,0)
 . I FBVIO D  ; violation was found
"RTN","FBAASDR",137,0)
 . . S ^TMP($J,FBOB)="V" ; flag 1358
"RTN","FBAASDR",138,0)
 . . S FBC("VIO")=FBC("VIO")+1 ; incr count of 1358 with violation
"RTN","FBAASDR",139,0)
 ;
"RTN","FBAASDR",140,0)
PRINT ; report data
"RTN","FBAASDR",141,0)
 S (FBQUIT,FBPG)=0 D NOW^%DTC S Y=% D DD^%DT S FBDTR=Y
"RTN","FBAASDR",142,0)
 K FBDL
"RTN","FBAASDR",143,0)
 S FBDL="",$P(FBDL,"-",80)=""
"RTN","FBAASDR",144,0)
 S FBDL("CH")=$E(FBDL,1,10)_" "_$E(FBDL,1,14)_" "_$E(FBDL,1,11)_" "_$E(FBDL,1,9)_"  "_$E(FBDL,1,30)
"RTN","FBAASDR",145,0)
 ;
"RTN","FBAASDR",146,0)
 ; build page header text for selection criteria
"RTN","FBAASDR",147,0)
 K FBHDT
"RTN","FBAASDR",148,0)
 S FBHDT(1)="  Including Certifications from "
"RTN","FBAASDR",149,0)
 S FBHDT(1)=FBHDT(1)_$$FMTE^XLFDT(FBDT1)_" to "_$$FMTE^XLFDT(FBDT2)
"RTN","FBAASDR",150,0)
 S FBHDT(1)=FBHDT(1)_" for "
"RTN","FBAASDR",151,0)
 S FBHDT(1)=FBHDT(1)_$S(FBSTALL:"all stations",1:"Station "_FBSTN)
"RTN","FBAASDR",152,0)
 S:FBORV FBHDT(2)="  Only 1358s with a segregation of duty violation shown."
"RTN","FBAASDR",153,0)
 ;
"RTN","FBAASDR",154,0)
 D HD
"RTN","FBAASDR",155,0)
 ;
"RTN","FBAASDR",156,0)
 ; loop thru obligations
"RTN","FBAASDR",157,0)
 S FBOB="" F  S FBOB=$O(^TMP($J,FBOB)) Q:FBOB=""  D  Q:FBQUIT
"RTN","FBAASDR",158,0)
 . N FBERR,FBEVFP,FBOBX,FBVIO
"RTN","FBAASDR",159,0)
 . S FBOBX=$G(^TMP($J,FBOB))
"RTN","FBAASDR",160,0)
 . S FBERR=$S($P(FBOBX,U)="E":1,1:0) ; set true if error from IFCAP
"RTN","FBAASDR",161,0)
 . S FBVIO=$S($P(FBOBX,U)="V":1,1:0) ; set true if violation was found
"RTN","FBAASDR",162,0)
 . ;
"RTN","FBAASDR",163,0)
 . ; if only reporting violations then skip 1358 when no error/violation
"RTN","FBAASDR",164,0)
 . I FBORV,'FBERR,'FBVIO Q
"RTN","FBAASDR",165,0)
 . ;
"RTN","FBAASDR",166,0)
 . ; check for page break
"RTN","FBAASDR",167,0)
 . I $Y+7>IOSL D HD Q:FBQUIT
"RTN","FBAASDR",168,0)
 . ; 
"RTN","FBAASDR",169,0)
 . W !,FBDL("CH")
"RTN","FBAASDR",170,0)
 . W !,FBOB
"RTN","FBAASDR",171,0)
 . ;
"RTN","FBAASDR",172,0)
 . I FBERR D
"RTN","FBAASDR",173,0)
 . . W !,"IFCAP events for this 1358 missing due to following error:"
"RTN","FBAASDR",174,0)
 . . W !,$P(FBOBX,U,2),!
"RTN","FBAASDR",175,0)
 . ;
"RTN","FBAASDR",176,0)
 . S FBEVFP=1 ; init flag as true (Event - First Printed for 1358)
"RTN","FBAASDR",177,0)
 . ; loop thru date/times
"RTN","FBAASDR",178,0)
 . S FBDT="" F  S FBDT=$O(^TMP($J,FBOB,FBDT)) Q:FBDT=""  D  Q:FBQUIT
"RTN","FBAASDR",179,0)
 . . ; loop thru events
"RTN","FBAASDR",180,0)
 . . S FBEV=""
"RTN","FBAASDR",181,0)
 . . F  S FBEV=$O(^TMP($J,FBOB,FBDT,FBEV)) Q:FBEV=""  D  Q:FBQUIT
"RTN","FBAASDR",182,0)
 . . . N FBX,FBV
"RTN","FBAASDR",183,0)
 . . . ; if only reporting violations, don't print certify event without
"RTN","FBAASDR",184,0)
 . . . I FBORV,FBEV,$O(^TMP($J,FBOB,FBDT,FBEV,"V"))="" Q
"RTN","FBAASDR",185,0)
 . . . I 'FBEVFP,$Y+5>IOSL D HD Q:FBQUIT  D HDEV
"RTN","FBAASDR",186,0)
 . . . I 'FBEVFP W !
"RTN","FBAASDR",187,0)
 . . . I FBEVFP S FBEVFP=0
"RTN","FBAASDR",188,0)
 . . . S FBX=$G(^TMP($J,FBOB,FBDT,FBEV))
"RTN","FBAASDR",189,0)
 . . . W ?11,$$FMTE^XLFDT(FBDT,"2MZ")
"RTN","FBAASDR",190,0)
 . . . W ?26,$S(FBEV="O":"OBLIGATE",FBEV="A":"ADJUST",1:FBEV)
"RTN","FBAASDR",191,0)
 . . . I FBEV W ?38,"CERTIFIER",?49,$$GET1^DIQ(200,FBX,.01)
"RTN","FBAASDR",192,0)
 . . . I FBEV="O"!(FBEV="A") D
"RTN","FBAASDR",193,0)
 . . . . W ?38,"REQUESTOR" W:$P(FBX,U) ?49,$$GET1^DIQ(200,$P(FBX,U),.01)
"RTN","FBAASDR",194,0)
 . . . . W !,?38,"APPROVER" W:$P(FBX,U,2) ?49,$$GET1^DIQ(200,$P(FBX,U,2),.01)
"RTN","FBAASDR",195,0)
 . . . . W !,?38,"OBLIGATOR" W:$P(FBX,U,3) ?49,$$GET1^DIQ(200,$P(FBX,U,3),.01)
"RTN","FBAASDR",196,0)
 . . . ; list any violations found for this event (max is 3)
"RTN","FBAASDR",197,0)
 . . . S FBV="" F  S FBV=$O(^TMP($J,FBOB,FBDT,FBEV,FBV)) Q:FBV=""  D
"RTN","FBAASDR",198,0)
 . . . . N FBXV
"RTN","FBAASDR",199,0)
 . . . . S FBXV=$G(^TMP($J,FBOB,FBDT,FBEV,FBV))
"RTN","FBAASDR",200,0)
 . . . . I FBXV]"" W !,?8,"***",FBXV
"RTN","FBAASDR",201,0)
 ;
"RTN","FBAASDR",202,0)
 I FBQUIT W !!,"REPORT STOPPED AT USER REQUEST"
"RTN","FBAASDR",203,0)
 E  D  ; report footer
"RTN","FBAASDR",204,0)
 . I $Y+5>IOSL D HD Q:FBQUIT
"RTN","FBAASDR",205,0)
 . W !,FBDL("CH")
"RTN","FBAASDR",206,0)
 . W !!,"  ",FBC("CER")," batch certification",$S(FBC("CER")=1:" was",1:"s were")," found during the report period."
"RTN","FBAASDR",207,0)
 . Q:FBC("OBL")=0
"RTN","FBAASDR",208,0)
 . W !,"  ",FBC("OBL")," 1358 Obligation",$S(FBC("OBL")=1:" is",1:"s are")," referenced."
"RTN","FBAASDR",209,0)
 . W !,"  A violation of segregation of duties was detected on ",$S(FBC("VIO")=0:"none",1:FBC("VIO"))," of the 1358s."
"RTN","FBAASDR",210,0)
 I 'FBQUIT,$E(IOST,1,2)="C-" S DIR(0)="E" D ^DIR K DIR
"RTN","FBAASDR",211,0)
 D ^%ZISC
"RTN","FBAASDR",212,0)
 ;
"RTN","FBAASDR",213,0)
EXIT ;
"RTN","FBAASDR",214,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","FBAASDR",215,0)
 K ^TMP($J)
"RTN","FBAASDR",216,0)
 K FBC,FBDA,FBDL,FBDT,FBDT1,FBDT2,FBDTR,FBEV,FBHDT,FBOB,FBORV
"RTN","FBAASDR",217,0)
 K FBPG,FBSTALL,FBSTN,FBQUIT,FBY0
"RTN","FBAASDR",218,0)
 K DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","FBAASDR",219,0)
 Q
"RTN","FBAASDR",220,0)
 ;
"RTN","FBAASDR",221,0)
HD ; page header
"RTN","FBAASDR",222,0)
 N FBI
"RTN","FBAASDR",223,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1,FBQUIT=1 Q
"RTN","FBAASDR",224,0)
 I $E(IOST,1,2)="C-",FBPG S DIR(0)="E" D ^DIR K DIR I 'Y S FBQUIT=1 Q
"RTN","FBAASDR",225,0)
 I $E(IOST,1,2)="C-"!FBPG W @IOF
"RTN","FBAASDR",226,0)
 S FBPG=FBPG+1
"RTN","FBAASDR",227,0)
 W !,"Fee Basis 1358 Segregation of Duties",?49,FBDTR,?72,"page ",FBPG
"RTN","FBAASDR",228,0)
 S FBI=0 F  S FBI=$O(FBHDT(FBI)) Q:'FBI  W !,FBHDT(FBI)
"RTN","FBAASDR",229,0)
 W !!,"1358",?11,"DATE/TIME",?26,"EVENT/BATCH",?38,"ROLE",?49,"NAME"
"RTN","FBAASDR",230,0)
 Q
"RTN","FBAASDR",231,0)
 ;
"RTN","FBAASDR",232,0)
HDEV ; page header for continued event
"RTN","FBAASDR",233,0)
 W !,FBOB," (continued from previous page)"
"RTN","FBAASDR",234,0)
 Q
"RTN","FBAASDR",235,0)
 ;
"RTN","FBAASDR",236,0)
 ;FBAASDR
"RTN","FBCHSCB")
0^2^B7320590^B7463731
"RTN","FBCHSCB",1,0)
FBCHSCB ;AISC/GRR - SUPERVISOR RELEASE ;11/2/2010
"RTN","FBCHSCB",2,0)
 ;;3.5;FEE BASIS;**117**;JAN 30, 1995;Build 9
"RTN","FBCHSCB",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","FBCHSCB",4,0)
 D DT^DICRW
"RTN","FBCHSCB",5,0)
 I '$D(^FBAA(161.7,"AC","C")) W !!,*7,"There are no batches Pending Release!" Q
"RTN","FBCHSCB",6,0)
BT W !! S DIC="^FBAA(161.7,",DIC(0)="AEQZ",DIC("S")="I $P(^(0),U,15)=""Y"",$G(^(""ST""))=""C""" D ^DIC K DIC("S") G Q:X="^"!(X=""),BT:Y<0 S FBN=+Y,FZ=Y(0),FBTYPE=$P(FZ,"^",3),FBAAON=$P(FZ,"^",2),FBAAB=$P(FZ,"^")
"RTN","FBCHSCB",7,0)
 I $P(FZ,"^",18)["Y" W !!,*7,"This Batch is exempt from the Pricer!!!",!,"Please use the 'Release a Batch' option to forward this batch for payment." G Q
"RTN","FBCHSCB",8,0)
 S DA=FBN,DR="0;ST" W !! D EN^DIQ
"RTN","FBCHSCB",9,0)
RD S B=FBN S DIR(0)="Y",DIR("A")="Want line items listed",DIR("B")="NO" D ^DIR K DIR G BT:$D(DIRUT) D:Y LISTC
"RTN","FBCHSCB",10,0)
RDD S DIR(0)="Y",DIR("A")="Do you want to Release Batch as Correct",DIR("B")="NO" D ^DIR K DIR G BT:$D(DIRUT) I 'Y W !!,"Batch has NOT been Released!",*7 G BT
"RTN","FBCHSCB",11,0)
 ; use FileMan to update fields 5 and 6 (PRC*3.5*117)
"RTN","FBCHSCB",12,0)
 S DA=FBN,DIE="^FBAA(161.7,",DR="11////^S X=""S"";6////^S X=DUZ;5////^S X=DT" D ^DIE
"RTN","FBCHSCB",13,0)
 S DA=FBN,DR="0;ST",DIC="^FBAA(161.7," W !! D EN^DIQ W !!," Batch has been Released!" G BT
"RTN","FBCHSCB",14,0)
Q K B,J,K,L,M,X,Y,Z,DIC,FBN,A,A1,A2,BE,CPTDESC,D0,DA,DL,DR,DRX,DX,FBAACB,FBAACPT,FBAAON,FBAAOUT,FBVP,FBIN,DK,N,XY,FBINOLD,FBINTOT,FBTYPE,FZ,P3,P4,Q,S,T,V,VID,ZS,FBAAB,FBAAMT,FBAAOB,FBCOMM,FBAUT,FBSITE,I,X,Y,Z,FBERR,DIRUT,DUOUT,DTOUT
"RTN","FBCHSCB",15,0)
 K FBK,FBL,FBPDT,FBTD,DIE
"RTN","FBCHSCB",16,0)
 K DLAYGO,FBLISTC D END^FBCHDI Q
"RTN","FBCHSCB",17,0)
 ;
"RTN","FBCHSCB",18,0)
LISTC D HOME^%ZIS W @IOF
"RTN","FBCHSCB",19,0)
 D LISTC^FBAACCB1 Q
"RTN","FBXIP117")
0^^B552645^n/a
"RTN","FBXIP117",1,0)
FBXIP117 ;WOIFO/SAB - PATCH INSTALL ROUTINE ;11/2/2010
"RTN","FBXIP117",2,0)
 ;;3.5;FEE BASIS;**117**;JAN 30, 1995;Build 9
"RTN","FBXIP117",3,0)
 Q
"RTN","FBXIP117",4,0)
 ;
"RTN","FBXIP117",5,0)
PS ; post-install entry point
"RTN","FBXIP117",6,0)
 ; create KIDS checkpoints with call backs
"RTN","FBXIP117",7,0)
 N FBX,Y
"RTN","FBXIP117",8,0)
 F FBX="XREF" D
"RTN","FBXIP117",9,0)
 . S Y=$$NEWCP^XPDUTL(FBX,FBX_"^FBXIP117")
"RTN","FBXIP117",10,0)
 . I 'Y D BMES^XPDUTL("ERROR Creating "_FBX_" Checkpoint.")
"RTN","FBXIP117",11,0)
 Q
"RTN","FBXIP117",12,0)
 ;
"RTN","FBXIP117",13,0)
XREF ; Set new x-ref
"RTN","FBXIP117",14,0)
 N DIK
"RTN","FBXIP117",15,0)
 D BMES^XPDUTL("    Setting ADS x-ref...")
"RTN","FBXIP117",16,0)
 ;
"RTN","FBXIP117",17,0)
 S DIK="^FBAA(161.7,"
"RTN","FBXIP117",18,0)
 S DIK(1)="5^ADS"
"RTN","FBXIP117",19,0)
 D ENALL^DIK
"RTN","FBXIP117",20,0)
 ;
"RTN","FBXIP117",21,0)
 D MES^XPDUTL("    Done.")
"RTN","FBXIP117",22,0)
 Q
"RTN","FBXIP117",23,0)
 ;
"RTN","FBXIP117",24,0)
 ;FBXIP117
"VER")
8.0^22.0
"^DD",161.7,161.7,5,0)
DATE SUPERVISOR CLOSED^RDX^^0;6^S %DT="EXTS",%DT(0)="-NOW" D ^%DT S X=Y K:Y<1 X K %DT(0)
"^DD",161.7,161.7,5,1,0)
^.1
"^DD",161.7,161.7,5,1,1,0)
161.7^ADS
"^DD",161.7,161.7,5,1,1,1)
S ^FBAA(161.7,"ADS",$E(X,1,30),DA)=""
"^DD",161.7,161.7,5,1,1,2)
K ^FBAA(161.7,"ADS",$E(X,1,30),DA)
"^DD",161.7,161.7,5,1,1,"%D",0)
^^1^1^3101103^
"^DD",161.7,161.7,5,1,1,"%D",1,0)
Regular cross-reference on DATE SUPERVISOR CLOSED field.
"^DD",161.7,161.7,5,1,1,"DT")
3101103
"^DD",161.7,161.7,5,3)
Enter a date and time.
"^DD",161.7,161.7,5,21,0)
^^2^2^3101026^
"^DD",161.7,161.7,5,21,1,0)
The date and time that the supervisor reviewed and released for payment 
"^DD",161.7,161.7,5,21,2,0)
or the date released to the NVH Pricer.
"^DD",161.7,161.7,5,23,0)
^.001^2^2^3101026^^
"^DD",161.7,161.7,5,23,1,0)
This field will contain a date instead of a date and time for batches that
"^DD",161.7,161.7,5,23,2,0)
were released for payment prior to installation of patch FB*3.5*117.
"^DD",161.7,161.7,5,"DT")
3101103
"BLD",8250,6)
^105
**END**
**END**
