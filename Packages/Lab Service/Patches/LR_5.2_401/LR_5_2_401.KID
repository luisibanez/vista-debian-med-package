KIDS Distribution saved on Jun 10, 2010@14:54:42
LR*5.2*401 6/10/10
**KIDS**:LR*5.2*401^

**INSTALL NAME**
LR*5.2*401
"BLD",7356,0)
LR*5.2*401^LAB SERVICE^0^3100610^y
"BLD",7356,1,0)
^^2^2^3100310^
"BLD",7356,1,1,0)
This patch contains changes to the VBECS Blood Bank package. Refer to the 
"BLD",7356,1,2,0)
patch listed in the Forum patch module for more details.
"BLD",7356,4,0)
^9.64PA^^0
"BLD",7356,6.3)
7
"BLD",7356,"KRN",0)
^9.67PA^779.2^20
"BLD",7356,"KRN",.4,0)
.4
"BLD",7356,"KRN",.401,0)
.401
"BLD",7356,"KRN",.402,0)
.402
"BLD",7356,"KRN",.403,0)
.403
"BLD",7356,"KRN",.5,0)
.5
"BLD",7356,"KRN",.84,0)
.84
"BLD",7356,"KRN",3.6,0)
3.6
"BLD",7356,"KRN",3.8,0)
3.8
"BLD",7356,"KRN",9.2,0)
9.2
"BLD",7356,"KRN",9.8,0)
9.8
"BLD",7356,"KRN",9.8,"NM",0)
^9.68A^3^2
"BLD",7356,"KRN",9.8,"NM",2,0)
LRCAPBV1^^0^B5486069
"BLD",7356,"KRN",9.8,"NM",3,0)
LRCAPBV^^0^B56413322
"BLD",7356,"KRN",9.8,"NM","B","LRCAPBV",3)

"BLD",7356,"KRN",9.8,"NM","B","LRCAPBV1",2)

"BLD",7356,"KRN",19,0)
19
"BLD",7356,"KRN",19.1,0)
19.1
"BLD",7356,"KRN",101,0)
101
"BLD",7356,"KRN",409.61,0)
409.61
"BLD",7356,"KRN",771,0)
771
"BLD",7356,"KRN",779.2,0)
779.2
"BLD",7356,"KRN",870,0)
870
"BLD",7356,"KRN",8989.51,0)
8989.51
"BLD",7356,"KRN",8989.52,0)
8989.52
"BLD",7356,"KRN",8994,0)
8994
"BLD",7356,"KRN","B",.4,.4)

"BLD",7356,"KRN","B",.401,.401)

"BLD",7356,"KRN","B",.402,.402)

"BLD",7356,"KRN","B",.403,.403)

"BLD",7356,"KRN","B",.5,.5)

"BLD",7356,"KRN","B",.84,.84)

"BLD",7356,"KRN","B",3.6,3.6)

"BLD",7356,"KRN","B",3.8,3.8)

"BLD",7356,"KRN","B",9.2,9.2)

"BLD",7356,"KRN","B",9.8,9.8)

"BLD",7356,"KRN","B",19,19)

"BLD",7356,"KRN","B",19.1,19.1)

"BLD",7356,"KRN","B",101,101)

"BLD",7356,"KRN","B",409.61,409.61)

"BLD",7356,"KRN","B",771,771)

"BLD",7356,"KRN","B",779.2,779.2)

"BLD",7356,"KRN","B",870,870)

"BLD",7356,"KRN","B",8989.51,8989.51)

"BLD",7356,"KRN","B",8989.52,8989.52)

"BLD",7356,"KRN","B",8994,8994)

"BLD",7356,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",7356,"QUES",0)
^9.62^^
"BLD",7356,"REQB",0)
^9.611^2^2
"BLD",7356,"REQB",1,0)
LR*5.2*325^2
"BLD",7356,"REQB",2,0)
VBEC*1.0*10^2
"BLD",7356,"REQB","B","LR*5.2*325",1)

"BLD",7356,"REQB","B","VBEC*1.0*10",2)

"MBREQ")
0
"PKG",26,-1)
1^1
"PKG",26,0)
LAB SERVICE^LR^CORE LAB SYSTEM
"PKG",26,20,0)
^9.402P^1^1
"PKG",26,20,1,0)
2^^LRXDRPT
"PKG",26,20,1,1)

"PKG",26,20,"B",2,1)

"PKG",26,22,0)
^9.49I^1^1
"PKG",26,22,1,0)
5.2^2940927^2950304
"PKG",26,22,1,"PAH",1,0)
401^3100610
"PKG",26,22,1,"PAH",1,1,0)
^^2^2^3100610
"PKG",26,22,1,"PAH",1,1,1,0)
This patch contains changes to the VBECS Blood Bank package. Refer to the 
"PKG",26,22,1,"PAH",1,1,2,0)
patch listed in the Forum patch module for more details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","LRCAPBV")
0^3^B56413322
"RTN","LRCAPBV",1,0)
LRCAPBV ;DALOI/FHS - PROCESS VBECS WORKLOAD API ; 4/17/07 3:53am
"RTN","LRCAPBV",2,0)
 ;;5.2;LAB SERVICE;**325,401**;Sep 27, 1994;Build 7
"RTN","LRCAPBV",3,0)
 ;Reference to $$FIND1^DIC supported by IA #2051
"RTN","LRCAPBV",4,0)
 ;Reference to FILE^DID supported by IA #2052
"RTN","LRCAPBV",5,0)
 ;Reference to FILE^DIE supported by IA #2053
"RTN","LRCAPBV",6,0)
 ;Reference to GETS^DIQ supported by IA #2056
"RTN","LRCAPBV",7,0)
 ;Reference to $$GET^XUA4A72 supported by IA #1625
"RTN","LRCAPBV",8,0)
 ;Reference to $$WKLDCAP^VBECA7 supported by IA #4767
"RTN","LRCAPBV",9,0)
 ;Reference to UPDTWKLD^VBECA7 supported by IA #4767
"RTN","LRCAPBV",10,0)
EN ;Will only run if VBECS BUNDLE 1.0 is installed.
"RTN","LRCAPBV",11,0)
 Q:'($D(^VBEC(6002.01,0)))
"RTN","LRCAPBV",12,0)
BBLOOK ;
"RTN","LRCAPBV",13,0)
LOCK ;
"RTN","LRCAPBV",14,0)
 L +^VBEC(6000,1,"WKLD"):10 G:'$T LOCK
"RTN","LRCAPBV",15,0)
 Q:$G(^VBEC(6000,1,"WKLD"))=+$H  S ^VBEC(6000,1,"WKLD")=+$H
"RTN","LRCAPBV",16,0)
 ;L +^XTMP("BVEC WKLD"):10 G:'$T LOCK
"RTN","LRCAPBV",17,0)
 ;Q:$G(^XTMP("BVEC WKLD",0))=+$H  S ^XTMP("BVEC WKLD",0)=+$H
"RTN","LRCAPBV",18,0)
 N ANS,ANX
"RTN","LRCAPBV",19,0)
 N D1,D2,DFN,ERR,FILE,IEN,LRAA,LRACC,LRADT,LRAN,LRACPABV,LRCC
"RTN","LRCAPBV",20,0)
 N LRCDT,LRCNT,LRCTM,LRD65,LRDAA,LRDFN,LRDIV,LRDLOC,LRDPRO,LRDSUF
"RTN","LRCAPBV",21,0)
 N LRE655,LREDT,LRERR,LRESCPT,LRFDA,LRFILE,LRFNUM,LRIDT
"RTN","LRCAPBV",22,0)
 N LRII,LRIN,LRLD,LRLOG,LRLSS,LRMA,LRNLT,LROA,LROAD,LROAD1,LROAD2
"RTN","LRCAPBV",23,0)
 N LROL,LRPKG,LRREC,LRRRL,LRRRL1,LRRRL3,LRRRL4,LRSUF,LRTEC,LRTS
"RTN","LRCAPBV",24,0)
 N LRTST,LRTSTP,LRTYPE,LRUG,LRUID,LRUNIT,LRWA,LRWKLAA,LRZCNT,X,Y
"RTN","LRCAPBV",25,0)
 N LRCAPBV,LRDPF,LRNP,LRUA,LRRRL2,LRSN,LRSPEC,LRSTATUS,LRVSITN
"RTN","LRCAPBV",26,0)
 N LRTSTU,LRTSQA,LRTSTD
"RTN","LRCAPBV",27,0)
GET ;Call VBECS 6002.01 data populating API
"RTN","LRCAPBV",28,0)
 S ANS=$$WKLDCAP^VBECA7
"RTN","LRCAPBV",29,0)
 G:ANS'=1 END
"RTN","LRCAPBV",30,0)
 S LRCAPBV=1,LRESCPT=0
"RTN","LRCAPBV",31,0)
DLOC ;Get default location and provider
"RTN","LRCAPBV",32,0)
 D GETS^DIQ(69.9,"1,",".8;617","I","ANS","ERR")
"RTN","LRCAPBV",33,0)
 S LRDLOC=$G(ANS(69.9,"1,",.8,"I"))
"RTN","LRCAPBV",34,0)
 S LRDPRO=$G(ANS(69.9,"1,",617,"I"))
"RTN","LRCAPBV",35,0)
 I $$GET^XUA4A72(LRDPRO)<1 G END
"RTN","LRCAPBV",36,0)
 S:'$G(LRIEN) LRIEN=0
"RTN","LRCAPBV",37,0)
LK1 ;Set default values
"RTN","LRCAPBV",38,0)
 S LRPKG=$$FIND1^DIC(9.4,"","O","LAB SERVICE","B","","ANS")
"RTN","LRCAPBV",39,0)
 I LRPKG<1 S ERR=9.4
"RTN","LRCAPBV",40,0)
 S LRDAA=$$FIND1^DIC(68,"","O","BLOOD BANK","B","","ANS")
"RTN","LRCAPBV",41,0)
 S:'LRDAA LRDAA=29
"RTN","LRCAPBV",42,0)
 S LRD65=$$FIND1^DIC(65,"","B","VBECS1","B","","ANS")
"RTN","LRCAPBV",43,0)
 S LRDSUF=$$FIND1^DIC(64.2,"","O","GENERIC","B","","ANS")
"RTN","LRCAPBV",44,0)
 I '$G(LRD65) S LRSTATUS="LRD(65 missing",LRERR="Failed lookup" D  G END
"RTN","LRCAPBV",45,0)
 . S ERR=65 D EUPDATE
"RTN","LRCAPBV",46,0)
TST ;Get default tests names
"RTN","LRCAPBV",47,0)
 S LRTSTQA=$$FIND1^DIC(60,,"B","VBEC QA/QC","B",,"ANS")
"RTN","LRCAPBV",48,0)
 S LRTSTU=$$FIND1^DIC(60,,"B","VBEC UNIT PROCESSING","B",,"ANS")
"RTN","LRCAPBV",49,0)
 S LRTSTD=$$FIND1^DIC(60,,"B","VBEC DONOR","B",,"ANS")
"RTN","LRCAPBV",50,0)
 I $S('LRTSTQA:1,'LRTSTU:1,'LRTSTD:1,1:0) D  G END
"RTN","LRCAPBV",51,0)
 . S ERR=$S('LRTSTQA:"VBEC QA/QC ",'LRTSTU:"VBEC UNIT PROCESSING",1:"VBEC DONOR") D EUPDATE
"RTN","LRCAPBV",52,0)
 Q:$G(LRDBUG)
"RTN","LRCAPBV",53,0)
DPROV ;Set default PCE Provider
"RTN","LRCAPBV",54,0)
LOOP ;Find entries with the status of pending.
"RTN","LRCAPBV",55,0)
 F  S LRIEN=$O(^VBEC(6002.01,"AC","P",LRIEN)) Q:LRIEN<1  D BBDIQ
"RTN","LRCAPBV",56,0)
 Q:$G(LRDBUG)
"RTN","LRCAPBV",57,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","LRCAPBV",58,0)
END ;
"RTN","LRCAPBV",59,0)
 L -^XTMP("BVEC WKLD")
"RTN","LRCAPBV",60,0)
 ;Call VBECS update API
"RTN","LRCAPBV",61,0)
 D UPDTWKLD^VBECA7
"RTN","LRCAPBV",62,0)
 K LRIEN
"RTN","LRCAPBV",63,0)
 Q
"RTN","LRCAPBV",64,0)
BBDIQ ;Gather entry info
"RTN","LRCAPBV",65,0)
 I $G(LRDBUG) W !,LRIEN
"RTN","LRCAPBV",66,0)
 K ANS,ANX,ERR,FILE,LRFDA
"RTN","LRCAPBV",67,0)
 K ^VBEC(6002.01,LRIEN,"ERR")
"RTN","LRCAPBV",68,0)
 S FILE=6002.01,IEN=LRIEN_","
"RTN","LRCAPBV",69,0)
 D GETS^DIQ(FILE,IEN,"**","IN","ANS","ERR")
"RTN","LRCAPBV",70,0)
 D ERR Q:$G(ERR)
"RTN","LRCAPBV",71,0)
 S LRFDA(6002.01,LRIEN_",",5)="I"
"RTN","LRCAPBV",72,0)
 D FILE^DIE("S","LRFDA","ERR")
"RTN","LRCAPBV",73,0)
 D LRAA
"RTN","LRCAPBV",74,0)
 Q:$G(ERR)
"RTN","LRCAPBV",75,0)
 S:$G(LRWKLAA) (LRMA,LRWA,LRLSS)=LRWKLAA
"RTN","LRCAPBV",76,0)
 S LRCDT=$P(ANS(6002.01,LRIEN_",",3,"I"),".")
"RTN","LRCAPBV",77,0)
 S LRCTM=$P(ANS(6002.01,LRIEN_",",3,"I"),".",2)
"RTN","LRCAPBV",78,0)
 D ^LRCAPV3
"RTN","LRCAPBV",79,0)
 K LRFDA S LRFDA(6002.01,LRIEN_",",5)="S"
"RTN","LRCAPBV",80,0)
 S LRFDA(6002.01,LRIEN_",",4)=$$NOW^XLFDT
"RTN","LRCAPBV",81,0)
 D FILE^DIE("S","LRFDA","ERR")
"RTN","LRCAPBV",82,0)
PCEFILE ;File PCE if outpatient location
"RTN","LRCAPBV",83,0)
 Q:$S(LRRRL4="W":0,LRRRL4="O":0,1:1)
"RTN","LRCAPBV",84,0)
 I $G(DFN) D
"RTN","LRCAPBV",85,0)
 . D EN^LRCAPBV1(LRADT,LRTEC,LRTST,LRDSSLOC,LRDSSID,LRIN,DFN,LRPRO,LRCNT)
"RTN","LRCAPBV",86,0)
 Q
"RTN","LRCAPBV",87,0)
ERR ;Check entry for critical data
"RTN","LRCAPBV",88,0)
 I $G(ERR) S LRERR="Failed lookup",LRSTATUS="E" D EUPDATE Q
"RTN","LRCAPBV",89,0)
 D INIT^LRCAPBB S LRLD="CP"
"RTN","LRCAPBV",90,0)
 S ERR=0
"RTN","LRCAPBV",91,0)
TYPE S LRTYPE=$G(ANS(6002.01,IEN,1,"I")) D  Q:$G(ERR)
"RTN","LRCAPBV",92,0)
 . I '$L(LRTYPE) S ERR=1 D EUPDATE
"RTN","LRCAPBV",93,0)
DIV S LRDIV=$G(ANS(6002.01,IEN,2,"I")) D  Q:$G(ERR)  ;RLM 120809
"RTN","LRCAPBV",94,0)
 . I '$D(^DIC(4,+LRDIV,0)) S ERR=2 D EUPDATE
"RTN","LRCAPBV",95,0)
 . S LRIN=LRDIV
"RTN","LRCAPBV",96,0)
ADT S (LRADT,LREDT)=$G(ANS(6002.01,IEN,3,"I")) D  Q:$G(ERR)
"RTN","LRCAPBV",97,0)
 . I LRADT'?7N1"."1N.E S ERR=3 D EUPDATE
"RTN","LRCAPBV",98,0)
 . S LRCDT=$P(LRADT,"."),LRCTM=$P(LRADT,".",2)
"RTN","LRCAPBV",99,0)
NLT S LRNLT=$G(ANS(6002.01,IEN,6,"I")) D
"RTN","LRCAPBV",100,0)
 . D GETS^DIQ(64,LRNLT,1,"IN","ANX","ERX")
"RTN","LRCAPBV",101,0)
 . S LRNLT1=$g(ANX("64",LRNLT_",",1,"I")) ;RLM 6-4-10
"RTN","LRCAPBV",102,0)
SUF S LRSUF1=$G(ANS(6002.01,IEN,7,"I")) D  Q:$G(ERR)
"RTN","LRCAPBV",103,0)
 . S:'LRSUF1 LRSUF1=LRDSUF
"RTN","LRCAPBV",104,0)
 . D GETS^DIQ(64.2,LRSUF1,1,"IN","ANX","ERX") S LRSUF=$g(ANX("64.2",LRSUF1_",",1,"I")) ;RLM 6-4-10
"RTN","LRCAPBV",105,0)
 . I LRNLT1?1.N1"."1.N S LRCC=$O(^LAM("E",LRNLT1,0)) ;RLM 6-4-10
"RTN","LRCAPBV",106,0)
 . I LRNLT1'["." S LRCC=$O(^LAM("E",LRNLT1_LRSUF,0)) ;RLM 6-4-10
"RTN","LRCAPBV",107,0)
 . I LRCC="" S LRCC=$$NLT^LRCAPBV1(LRNLT,LRSUF) ;Lookup or create NLT code ;RLM 6-3-10 ADDED - I LRCC=""
"RTN","LRCAPBV",108,0)
 . D GETS^DIQ(64.2,LRSUF_",",1,"I","ANS","ERR")
"RTN","LRCAPBV",109,0)
 . S LRSUF=$P($G(ANX(64.2,LRSUF1_",",1,"I")),".",2)
"RTN","LRCAPBV",110,0)
 S LRCNT=$G(ANS(6002.01,IEN,8,"I")) I 'LRCNT S LRCNT=1
"RTN","LRCAPBV",111,0)
DFN S DFN=$G(ANS(6002.01,IEN,9,"I")) D  I $G(ERR) D EUPDATE Q
"RTN","LRCAPBV",112,0)
 . S LRDFN=""
"RTN","LRCAPBV",113,0)
 . Q:LRTYPE'="P"
"RTN","LRCAPBV",114,0)
 . S LRDFN=$G(^DPT(+DFN,"LR"))
"RTN","LRCAPBV",115,0)
 . ;I 'LRDFN S ERR=9 ;RLM 6/12/08 This isn't always an error and the data is evaluated in VBECS prior to transmission
"RTN","LRCAPBV",116,0)
FILE I LRTYPE="U"!(LRTYPE="M") S LRFILE=LRD65_";LRD(65,"
"RTN","LRCAPBV",117,0)
 I LRTYPE="D" S LRFILE=LRE655_";LRE("
"RTN","LRCAPBV",118,0)
 I LRTYPE="P" S LRFILE=DFN_";DPT("
"RTN","LRCAPBV",119,0)
TEC S LRTEC=$G(ANS(6002.01,IEN,10,"I")) D  Q:$G(ERR)
"RTN","LRCAPBV",120,0)
 . I 'LRTEC S ERR=10 D EUPDATE S LRTEC=.5 ;RLM 6/1/2010
"RTN","LRCAPBV",121,0)
 . I LRTEC,'$D(^VA(200,LRTEC,0)) S ERR=10 D EUPDATE ;RLM 12 03 09
"RTN","LRCAPBV",122,0)
 S LRAA=$S($G(LRDAA):LRDAA,1:29),LRAN=""
"RTN","LRCAPBV",123,0)
UID S LRUID=$G(ANS(6002.01,IEN,11,"I")) D  Q:$G(ERR)
"RTN","LRCAPBV",124,0)
 . I '$L(LRUID) Q
"RTN","LRCAPBV",125,0)
 . S LRAA=+$O(^LRO(68,"C",LRUID,0)) Q:LRAA<1
"RTN","LRCAPBV",126,0)
 . S LRCDT=$O(^LRO(68,"C",LRUID,LRAA,0))
"RTN","LRCAPBV",127,0)
 . S LRAN=$O(^LRO(68,"C",LRUID,LRAA,LRCDT,0))
"RTN","LRCAPBV",128,0)
 . S ERR=$S('LRAA:11,'LRAA:11,'LRAN:11,'$D(^LRO(68,LRAA,1,LRCDT,1,LRAN,0)):11,1:0)
"RTN","LRCAPBV",129,0)
 . I ERR D EUPDATE
"RTN","LRCAPBV",130,0)
TS K LRTS,LRTST,LRTSTP S LRTS=0
"RTN","LRCAPBV",131,0)
 I $G(ANS(6002.01,IEN,12,"I")) S (LRTS,LRTST,LRTSTP)=+$G(ANS(6002.01,IEN,12,"I"))
"RTN","LRCAPBV",132,0)
 I 'LRTS D
"RTN","LRCAPBV",133,0)
 . I LRTYPE="U" S (LRTS,LRTST,LRTSTP)=LRTSTU
"RTN","LRCAPBV",134,0)
 . I LRTYPE="M" S (LRTS,LRTST,LRTSTP)=LRTSTQA
"RTN","LRCAPBV",135,0)
 . I LRTYPE="D" S (LRTS,LRTST,LRTSTP)=LRTSTD
"RTN","LRCAPBV",136,0)
 ; I 'LRTS,$G(LRAA),$G(LRCDT),$G(LRAN) S (LRTS,LRTST,LRTSTP)=$O(^LRO(68,LRAA,1,LRCDT,1,LRAN,4,0))
"RTN","LRCAPBV",137,0)
 D  Q:$G(ERR)
"RTN","LRCAPBV",138,0)
 . S ERR=0
"RTN","LRCAPBV",139,0)
 . ;I '$D(^LAB(60,LRTS,0)) S ERR=12 D EUPDATE ;;RLM 6/12/08 This isn't always an error and the data is evaluated in VBECS prior to transmission
"RTN","LRCAPBV",140,0)
UNIT S LRUNIT=$G(ANS(6002.01,IEN,13,"I")) D  Q:ERR
"RTN","LRCAPBV",141,0)
 . I LRTYPE="U" S LRFILE=LRD65_";LRD(65," I '$L(LRUNIT) S ERR=13 D EUPDATE
"RTN","LRCAPBV",142,0)
LRDAA S LRWKLAA=$G(ANS(6002.01,IEN,14,"I"))
"RTN","LRCAPBV",143,0)
 Q
"RTN","LRCAPBV",144,0)
EUPDATE ;Set error codes into entry
"RTN","LRCAPBV",145,0)
 I $D(LRDBUG) W !,ERR
"RTN","LRCAPBV",146,0)
 K LRFDA(1)
"RTN","LRCAPBV",147,0)
 S:'$G(LRIEN) LRIEN=$O(^VBEC(6002.01,0))
"RTN","LRCAPBV",148,0)
 S LRFDA(1,6002.01,LRIEN_",",5)="E"
"RTN","LRCAPBV",149,0)
 I $G(ERR) S LRFDA(1,6002.01,LRIEN_",",20)="Field "_ERR_" has an error"
"RTN","LRCAPBV",150,0)
 I '$G(ERR) S LRFDA(1,6002.01,LRIEN_",",20)=ERR_" Error"
"RTN","LRCAPBV",151,0)
 D FILE^DIE("S","LRFDA(1)","ERRX")
"RTN","LRCAPBV",152,0)
 Q
"RTN","LRCAPBV",153,0)
LRAA ;Get accession data
"RTN","LRCAPBV",154,0)
 S LRAA=$G(ANS(6002.01,LRIEN_",",14,"I"))
"RTN","LRCAPBV",155,0)
 S LRAA=$S($G(LRAA):LRAA,1:LRDAA)
"RTN","LRCAPBV",156,0)
 K ANX,ERX
"RTN","LRCAPBV",157,0)
 D GETS^DIQ(68,LRAA_",",.19,"I","ANX","ERR")
"RTN","LRCAPBV",158,0)
 S LRLD=$G(ANX(68,LRAA_",",.19,"I"))
"RTN","LRCAPBV",159,0)
AA ;Accession Area Information
"RTN","LRCAPBV",160,0)
 S (LRMA,LRWA,LRLSS)=LRAA,LRUG=9
"RTN","LRCAPBV",161,0)
 I $G(LRAN),$G(LRCDT),$G(LRAA) D
"RTN","LRCAPBV",162,0)
 . Q:'$D(^LRO(68,LRAA,1,LRCDT,1,LRAN,0))
"RTN","LRCAPBV",163,0)
 . S IEN=LRAN_","_LRCDT_","_LRAA_","
"RTN","LRCAPBV",164,0)
 . D GETS^DIQ(68,LRAA_",",.8,"I","ANX","ERX")
"RTN","LRCAPBV",165,0)
 . S LRDSSLOC=$G(ANX(68,LRAA_",",.8,"I"))
"RTN","LRCAPBV",166,0)
 . S:'LRDSSLOC LRDSSLOC=LRDLOC
"RTN","LRCAPBV",167,0)
 . D GETS^DIQ(44,LRDSSLOC_",",8,"I","ANX","ERX")
"RTN","LRCAPBV",168,0)
 . S LRDSSID=$G(ANX(44,LRDSSLOC_",",8,"I"))
"RTN","LRCAPBV",169,0)
 . S FLD=".01;.02;2;3;4;6;6.5;6.6;6.7;13.5;15;92;94"
"RTN","LRCAPBV",170,0)
 . D GETS^DIQ(68.02,IEN,FLD,"IN","ANX","ERX")
"RTN","LRCAPBV",171,0)
 . D GETS^DIQ(68.05,1_","_IEN,.01,"IN","ANX","ERX")
"RTN","LRCAPBV",172,0)
 . D GETS^DIQ(68.04,LRTS_","_IEN,1,"IN","ANX","ERX")
"RTN","LRCAPBV",173,0)
LRAA1 . ;Parse variables
"RTN","LRCAPBV",174,0)
 . S LRFILE=$P($G(^LRO(68,LRAA,1,LRCDT,1,LRAN,0)),U,2)
"RTN","LRCAPBV",175,0)
 . S LRDFN=$G(ANX(68.02,IEN,.01,"I"))
"RTN","LRCAPBV",176,0)
 . D GETS^DIQ(63,LRDFN_",",".02;.03","I","ANX","ERX")
"RTN","LRCAPBV",177,0)
DPF . S LRDPF=$G(ANX(63,LRDFN_",",.02,"I"))
"RTN","LRCAPBV",178,0)
 . S DFN=$G(ANX(63,LRDFN_",",.03,"I"))
"RTN","LRCAPBV",179,0)
 . D FILE^DID(LRFILE,"","GLOBAL NAME","ANX","ERX")
"RTN","LRCAPBV",180,0)
 . I $G(LRDFN),$G(DFN) S LRFILE=DFN_";"_$P(ANX("GLOBAL NAME"),U,2)
"RTN","LRCAPBV",181,0)
ACCES . S LROAD=$G(ANX(68.02,IEN,2,"I"))
"RTN","LRCAPBV",182,0)
 . S LROAD1=$G(ANX(68.02,IEN,3,"I"))
"RTN","LRCAPBV",183,0)
 . S (LRSN,LROAD2)=$G(ANX(68.02,IEN,4,"I"))
"RTN","LRCAPBV",184,0)
 . S LRSPEC=$G(ANX(68.05,1_","_IEN,.01,"I"))
"RTN","LRCAPBV",185,0)
 . S LRRRL=$G(ANX(68.02,IEN,6,"I"))
"RTN","LRCAPBV",186,0)
 . S (LRPRO,LRRRL1)=$G(ANX(68.02,IEN,6.5,"I"))
"RTN","LRCAPBV",187,0)
 . S LRRRL3=$G(ANX(68.02,IEN,6.7,"I"))
"RTN","LRCAPBV",188,0)
 . S LRACC=$G(ANX(68.02,IEN,15,"I"))
"RTN","LRCAPBV",189,0)
 . S LROL=$G(ANX(68.02,IEN,94,"I"))
"RTN","LRCAPBV",190,0)
 . D GETS^DIQ(44,LROL_",","2;9.5","IN","ANX","ERX")
"RTN","LRCAPBV",191,0)
 . S LRRRL2=$G(ANX(44,LROL_",",9.5,"I"))
"RTN","LRCAPBV",192,0)
 . S LRRRL4=$G(ANX(44,LROL_",",2,"I"))
"RTN","LRCAPBV",193,0)
 . S LRIDT=$G(ANX(68.02,IEN,13.5,"I"))
"RTN","LRCAPBV",194,0)
URG . S LRUG=$G(ANX(68.04,LRTS_","_IEN,1,"I"))
"RTN","LRCAPBV",195,0)
 Q
"RTN","LRCAPBV1")
0^2^B5486069
"RTN","LRCAPBV1",1,0)
LRCAPBV1 ;DALOI/FHS - PROCESS VBEC PCE WORKLOAD API ; 4/3/07 3:31am
"RTN","LRCAPBV1",2,0)
 ;;5.2;LAB SERVICE;**325,401**;Sep 27,1994;Build 7
"RTN","LRCAPBV1",3,0)
 ;Reference to $$FIND1^DIC supported by IA #2051
"RTN","LRCAPBV1",4,0)
 ;Reference to FILE^DID supported by IA #2052
"RTN","LRCAPBV1",5,0)
 ;Reference to FILE^DIE supported by IA #2053
"RTN","LRCAPBV1",6,0)
 ;Reference to UPDATE^DIE supported by IA #2053
"RTN","LRCAPBV1",7,0)
 ;Reference to GETS^DIQ supported by IA #2056
"RTN","LRCAPBV1",8,0)
 ;Reference to $$GET^XUA4A72 supported by IA #1625
"RTN","LRCAPBV1",9,0)
 Q
"RTN","LRCAPBV1",10,0)
EN(LREDT,LRDUZ,LRTSTP,LRDSSLOC,LRDSSID,LRNINS,DFN,LRPRO,LRCNT) ;Call LRCAPPH1 to send PCE workload
"RTN","LRCAPBV1",11,0)
 ;LREDT = Encounter Date
"RTN","LRCAPBV1",12,0)
 ;LRDUZ = User
"RTN","LRCAPBV1",13,0)
 ;LRTSTP = ^LAB(60 IEN
"RTN","LRCAPBV1",14,0)
 ;LRDSSLOC = DSS LOCATION
"RTN","LRCAPBV1",15,0)
 ;LRDSSID = DSS ID
"RTN","LRCAPBV1",16,0)
 ;LRNINIS = Instution
"RTN","LRCAPBV1",17,0)
 ;DFN = Patient
"RTN","LRCAPBV1",18,0)
 ;LRPRO = Provider
"RTN","LRCAPBV1",19,0)
 ;LRCNT = set negative if the test is cancelled.
"RTN","LRCAPBV1",20,0)
 I LRCNT<1 S LRNP=1
"RTN","LRCAPBV1",21,0)
 K ^TMP("LRPXAPI",$J),LROK,LRXTST
"RTN","LRCAPBV1",22,0)
 K LRICPT,CPT,LRCEX,LRREL,LRINA,LRNOP,EDATE
"RTN","LRCAPBV1",23,0)
 S (LROA,LRCEX)=0,ERR=699,EDATE=$P(LREDT,".")
"RTN","LRCAPBV1",24,0)
 S LRESCPT=0,LRTST=LRTSTP
"RTN","LRCAPBV1",25,0)
 I $$GET^XUA4A72(LRPRO)<1 D
"RTN","LRCAPBV1",26,0)
 . S LRPRO=LRDPRO
"RTN","LRCAPBV1",27,0)
EN6 D EN6^LRCAPPH1
"RTN","LRCAPBV1",28,0)
 I $G(LRNOP) D  Q
"RTN","LRCAPBV1",29,0)
 . S ERR="PCE+"_LRNOP D EUPDATE^LRCAPBV
"RTN","LRCAPBV1",30,0)
 S ERR=0
"RTN","LRCAPBV1",31,0)
 I $D(^LRO(69,LRCDT,1,LRSN,0)) S ^("PCE")=""
"RTN","LRCAPBV1",32,0)
 I $D(^TMP("LRPXAPI",$J,"PROCEDURE")) D SEND^LRCAPPH1
"RTN","LRCAPBV1",33,0)
 K LRFDA(3)
"RTN","LRCAPBV1",34,0)
 I $G(LROK)>0 D  Q
"RTN","LRCAPBV1",35,0)
 . S LRFDA(3,6002.01,LRIEN_",",99)=LRVSITN
"RTN","LRCAPBV1",36,0)
 . D FILE
"RTN","LRCAPBV1",37,0)
PCEERR ;PCE error logging
"RTN","LRCAPBV1",38,0)
 Q:'$G(LROK)
"RTN","LRCAPBV1",39,0)
 S LRFDA(3,6002.01,LRIEN_",",21)="PCE "_LROK_" Error"
"RTN","LRCAPBV1",40,0)
 S LRFDA(3,6002.01,LRIEN_",",5)="E"
"RTN","LRCAPBV1",41,0)
FILE ;
"RTN","LRCAPBV1",42,0)
 D FILE^DIE("S","LRFDA(3)","ERR")
"RTN","LRCAPBV1",43,0)
 Q
"RTN","LRCAPBV1",44,0)
NLT(LRP,LRSUF) ;Lookup or create new NLT code
"RTN","LRCAPBV1",45,0)
 N ANS,FDA,LRFDA,FLD,ERR,LRPN,LRLRT,LRLRTN
"RTN","LRCAPBV1",46,0)
 I '$D(^LAM(+$G(LRP),0))#2 S ERR="No NLT Code" Q 0
"RTN","LRCAPBV1",47,0)
 I '$G(LRSUF) Q +$G(LRP)
"RTN","LRCAPBV1",48,0)
 D GETS^DIQ(64,LRP_",",".01:16","IEN","ANS","ERR")
"RTN","LRCAPBV1",49,0)
 S LRSUF=$$FIND1^DIC(64.2,"","O","."_LRSUF_" ","C","","ERR") ;RLM 11-20-09
"RTN","LRCAPBV1",50,0)
 D GETS^DIQ(64.2,LRSUF_",",".01;1","IEN","ANS","ERR")
"RTN","LRCAPBV1",51,0)
 S LRLRT=$G(ANS(64,LRP_",",.01,"I"))_"~"_$G(ANS(64.2,LRSUF_",",.01,"I"))
"RTN","LRCAPBV1",52,0)
 S LRLRTN=$P($G(ANS(64,LRP_",",1,"I")),".")_$G(ANS(64.2,LRSUF_",",1,"I"))
"RTN","LRCAPBV1",53,0)
NLT1 ;Lookup
"RTN","LRCAPBV1",54,0)
 S LRPN=$$FIND1^DIC(64,"","O",LRLRTN_" ","C","","ERR")
"RTN","LRCAPBV1",55,0)
 I LRPN>0 Q LRPN
"RTN","LRCAPBV1",56,0)
 S FLD="" F  S FLD=$O(ANS(64,LRP_",",FLD)) Q:FLD=""  D
"RTN","LRCAPBV1",57,0)
 . S LRFDA(1,64,"+1,",FLD)=$G(ANS(64,LRP_",",FLD,"I"))
"RTN","LRCAPBV1",58,0)
 S LRFDA(1,64,"+1,",.01)=LRLRT
"RTN","LRCAPBV1",59,0)
 S LRFDA(1,64,"+1,",1)=LRLRTN
"RTN","LRCAPBV1",60,0)
 D UPDATE^DIE("S","LRFDA(1)","FDA","ERR")
"RTN","LRCAPBV1",61,0)
 S LRPN=FDA(1)
"RTN","LRCAPBV1",62,0)
 Q LRPN
"RTN","LRCAPBV1",63,0)
 Q
"VER")
8.0^22.0
**END**
**END**
